<!doctype html>
<html data-protected="all"><head>
        <title>DashSpace</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <script type="text/json+bootconfig">{
    "creator": "WPMPackageManager",
    "created": 1650368097912,
    "require": [
        {
            "repositories": {
                "codestrates-repos": "https://raw.githubusercontent.com/Webstrates/Codestrates-v2/master/codestrates.html",
                "webstrate-components-repos": "https://raw.githubusercontent.com/Webstrates/WebstrateComponents/master/components.html",
                "cauldron-repos": "https://raw.githubusercontent.com/Webstrates/Cauldron/master/cauldron.html",
                "wpm_js_libs": "https://raw.githubusercontent.com/Webstrates/WebstrateLibraryRepository/master/libraries.html",
                "varv-repos": "https://raw.githubusercontent.com/Webstrates/Varv/master/varv.html",
                "wpm-repos": "https://raw.githubusercontent.com/Webstrates/WPM/master/build.html"
            },
            "dependencies": [
                {
                    "package": "CauldronURLLauncher",
                    "repository": "cauldron-repos"
                },
                {
                    "package": "CauldronButtonLauncher",
                    "repository": "cauldron-repos"
                },
                {
                    "package": "fragment_js",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "fragment_html",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "fragment_json",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "fragment_wpm-descriptor",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "fragment_css",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "fragment_scss",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "varv",
                    "repository": "varv-repos"
                },
                {
                    "package": "varv-react",
                    "repository": "varv-repos"
                },
                {
                    "package": "varv-signaling",
                    "repository": "varv-repos"
                },
                {
                    "package": "fragment_js_babel",
                    "repository": "codestrates-repos"
                },
                {
                    "package": "varv-location",
                    "repository": "varv-repos"
                },
                {
                    "package": "FragmentFilesystemSync",
                    "repository": "codestrates-repos"
                }
            ],
            "options": {}
        }
    ],
    "updated": 1729672099601,
    "knownRepositories": [
        "varv-repos"
    ]
}</script>
        </head>

        <body style="z-index: 10001;">
            <CODE-FOLDER name="Embedded Packages">
                <WPM-PACKAGE data-repository="https://cdn.jsdelivr.net/gh/Webstrates/WPM@master/build.html" id="WPM-loading-skin-simple" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "A simple loading skin for the bootloader to avoid seeing improperly rendered HTML while loading",
                        "dependencies": [
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "0.4",
                        "forceEmbedding": true
                    }

                    </SCRIPT><STYLE id="loading-style">
                    html:not([transient-wpm2-bootloader="loaded"]) > * {
                      opacity: 0 !important; }

                    @keyframes wpm-bootloader-spin {
                      from {
                        transform: translate(-50%, -50%) rotate(0); }
                      to {
                        transform: translate(-50%, -50%) rotate(360deg); } }

                    @keyframes wpm-bootloader-done {
                      0% {
                        transform: translate(-50%, -50%);
                        filter: blur(0.01em); }
                      99% {
                        transform: translate(-50%, -50%) scale(1.5);
                        opacity: 0;
                        filter: blur(2em); }
                      100% {
                        visibility: hidden;
                        transform: translate(-50%, -50%) scale(1.5);
                        opacity: 0;
                        filter: blur(2em); } }

                    html[transient-wpm2-bootloader="waiting"]:before, html[transient-wpm2-bootloader="loading"]:before, html[transient-wpm2-bootloader="initializing"]:before, html[transient-wpm2-bootloader="loaded"]:before {
                      animation: wpm-bootloader-spin 1s infinite linear both;
                      content: "";
                      position: fixed;
                      left: 50%;
                      top: 50%;
                      width: 3em;
                      height: 3em;
                      background: #f6fbff;
                      border-radius: 2em;
                      border: 4px solid white;
                      border-top-color: rgba(0, 102, 255, 0.589);
                      border-bottom-color: rgba(11, 90, 21, 0.466);
                      box-shadow: 0 0 2em rgba(49, 60, 162, 0.446);
                      pointer-events: none;
                      z-index: 9999; }

                    html[transient-wpm2-bootloader="waiting"][transient-wpm2-bootloader="loaded"]:before, html[transient-wpm2-bootloader="loading"][transient-wpm2-bootloader="loaded"]:before, html[transient-wpm2-bootloader="initializing"][transient-wpm2-bootloader="loaded"]:before, html[transient-wpm2-bootloader="loaded"][transient-wpm2-bootloader="loaded"]:before {
                      animation: wpm-bootloader-done 1s ease-out both; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="cQuery" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "cQuery - Lightweight jQuery alternative",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.0",
                        "changelog": {
                            "1.0": "Initial version",
                            "1.1": "Fixed liveQuery to work on elements where attributes change, and attribute was part of the live query"
                        },
                        "documentationLink": "",
                        "license": "Apache 2.0"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/cQuery/1.1/caviQuery.min.js");
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/cQuery/1.1/caviQueryPlugins.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="CaviDraggableHTML5" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "CaviDraggableHTML5 makes HTML5 dnd api easy to use",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.0",
                        "changelog": {
                        },
                        "license": "Apache 2.0",
                        "documentationLink": ""
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/CaviDraggableHTML5/1.0/draggable.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="CaviTouch" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "CaviTouch is a library to seemlesly handle touch, mouse, pointers and gestures",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.4",
                        "changelog": {
                            "1.0": "Initial version",
                            "1.1": "Added upgrade workaround",
                            "1.2": "Fixed bug during upgrade",
                            "1.3": "Fixed another bug during upgrade",
                            "1.4": "Moved to CDN and minified"
                        },
                        "documentationLink": "",
                        "license": "Apache 2.0"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/CaviTouch/1.4/CaviTouch.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="babel" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Babel transpiler",
                        "dependencies": [
                        ],
                        "assets": [],
                        "version": "7.23.10",
                        "license": "MIT",
                        "documentationLink": "https://github.com/babel/babel"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://unpkg.com/@babel/standalone@7.23.10/babel.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="diffHTML" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "A JavaScript diffing algorithm for DOM elements",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.0.0-beta.27",
                        "license": "MIT",
                        "documentationLink": "https://github.com/tbranyen/diffhtml/"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://unpkg.com/diffhtml@1.0.0-beta.27/dist/diffhtml.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="Observer" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Webstrate iframe observer, can wait for transclude, and changes to have propagated to server",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.0",
                        "license": "Apache 2.0",
                        "documentationLink": ""
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/Observer/1.0/Observer.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="requirejs" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Require.js",
                        "dependencies": [],
                        "assets": [],
                        "version": "2.3.6",
                        "license": "MIT",
                        "documentationLink": "https://requirejs.org/docs/api.html"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/require/require.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="material-design-components" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="components-descriptor-script" type="descriptor">
                    {
                        "description": "Material Design UI (full minified CDN version)",
                        "dependencies": [],
                        "assets": [],
                        "license": "MIT",
                        "version": "14.0.0"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://cdnjs.cloudflare.com/ajax/libs/material-components-web/14.0.0/material-components-web.min.js");
                                    </SCRIPT><LINK href="https://cdnjs.cloudflare.com/ajax/libs/material-components-web/7.0.0/material-components-web.min.css" rel="stylesheet" type="text/css"/></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="material-design-icons" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="icons-descriptor-script" type="descriptor">
                    {
                        "description": "Material Design Icons (full minified CDN version)",
                        "dependencies": [],
                        "assets": [],
                        "license": "Apache 2.0",
                        "version": "0.1",
                        "documentationLink": "https://github.com/google/material-design-icons"
                    }

                    </SCRIPT><LINK href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet" type="text/css"/></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="rxjs" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "RxJS is a library for composing asynchronous and event-based programs by using observable sequences.",
                        "dependencies": [
                        ],
                        "assets": [],
                        "version": "6.1.0",
                        "changelog": {},
                        "license": "Apache 2.0",
                        "documentationLink": "https://rxjs-dev.firebaseapp.com/api"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        //Get RXJS library used for Subject and Observable and more...
                                        await wpm.requireExternal("https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.1.0/rxjs.umd.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="izitoast" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Elegant, responsive, flexible and lightweight notification plugin with no dependencies.",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.4.0",
                        "license": "Apache 2.0",
                        "documentationLink": "https://izitoast.marcelodolza.com/"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js");
                                        await wpm.requireExternal("https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="mathjs" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Math.js library",
                        "dependencies": [],
                        "assets": [],
                        "version": "9.4.3",
                        "license": "Apache 2.0",
                        "documentationLink": "https://mathjs.org/docs/index.html"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://unpkg.com/mathjs@9.4.3/lib/browser/math.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="js-yaml" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "This is an implementation of YAML, a human-friendly data serialization language. Started as PyYAML port, it was completely rewritten from scratch. Now it's very fast, and supports 1.2 spec.",
                        "dependencies": [],
                        "assets": [],
                        "version": "4.1.0",
                        "license": "MIT",
                        "documentationLink": "https://github.com/nodeca/js-yaml"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="UUIDGenerator" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "An UUID generator",
                        "dependencies": [],
                        "assets": [],
                        "version": "1.0",
                        "license": "Apache 2.0",
                        "changelog": {
                            "1.0": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="generator-script" type="disabled">
                    /**
                     *  UUIDGenerator
                     *  Provides unqiue IDs
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    window.UUIDGenerator = class UUIDGenerator {
                        /**
                         * Generates a probably unique id
                         * @param {string} prefix a prefix for the id
                         * @param {number} length the length of the id
                         * @returns {String} the generated id
                         */
                        static generateUUID(prefix = "", length = 20) {
                            function dec2hex(dec) {
                                return ('0' + dec.toString(16)).substr(-2);
                            }

                            let arr = new Uint8Array((length || 40) / 2);
                            window.crypto.getRandomValues(arr);
                            return prefix + Array.from(arr, dec2hex).join('');
                        }
                    };

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="monaco_editor" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Monaco Editor",
                        "dependencies": [
                            "#requirejs"
                        ],
                        "assets": [],
                        "version": "0.33.0",
                        "license": "MIT",
                        "documentationLink": "https://microsoft.github.io/monaco-editor/api/index.html"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        window.MonacoLibraryPath = "https://libraries.projects.cavi.au.dk/javascript/monaco/0.33/vs";

                                        {
                                            //Configure monaco in require loader
                                            requirejs.config({
                                                paths: {
                                                    vs: MonacoLibraryPath
                                                }
                                            });

                                            window.MonacoEnvironment = {
                                                getWorkerUrl: function(workerId, label) {
                                                  return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
                                                    self.MonacoEnvironment = {
                                                      baseUrl: 'https://libraries.projects.cavi.au.dk/javascript/monaco/0.33/'
                                                    };
                                                    importScripts('https://libraries.projects.cavi.au.dk/javascript/monaco/0.33/vs/base/worker/workerMain.js');`
                                                  )}`;
                                                }
                                              };
                                        }
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="sass_js" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "SCSS compiler for JS",
                        "dependencies": [
                            "#requirejs"
                        ],
                        "assets": [],
                        "version": "0.11.1",
                        "license": "MIT",
                        "documentationLink": "https://github.com/medialize/sass.js"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        window.SassJsLibraryPath = "https://libraries.projects.cavi.au.dk/javascript/sass.js/0.11.1";
                                        {
                                            requirejs.config({
                                                paths: {
                                                    sass: SassJsLibraryPath
                                                }
                                            });
                                        }

                                        window.fetchSassWorkerBlob = async ()=> {
                                            let response = await fetch("https://libraries.projects.cavi.au.dk/javascript/sass.js/0.11.1/sass.worker.min.js");
                                            let worker = await response.text();
                                            let blob = new Blob([worker], {type: 'application/javascript'});

                                            return blob;
                                        }
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="fastdiff" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Fast Diff",
                        "dependencies": [
                            "#requirejs"
                        ],
                        "assets": [],
                        "version": "2019",
                        "license": "Apache 2.0",
                        "documentationLink": "https://github.com/google/diff-match-patch"
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/fastdiff/2019/fastdiff.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="LiveElement" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "A small javascript library to work with 'Live' elements, as they enter the dom",
                        "dependencies": [
                            "rxjs"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "changelog": {
                            "0.1": "Initial version"
                        },
                        "license": "Apache 2.0",
                        "documentationLink": ""
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/LiveElement/1.0/LiveElement.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="Uploader" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                      "description": "An upload helper",
                      "dependencies": [
                        "#cQuery"
                      ],
                      "assets": [],
                      "version": "1.0",
                      "changelog": {
                        "1.0": "Initial version"
                      },
                      "license": "Apache 2.0",
                      "documentationLink": ""
                    }

                    </SCRIPT><SCRIPT type="disabled">
                                        await wpm.requireExternal("https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js");
                                        await wpm.requireExternal("https://libraries.projects.cavi.au.dk/javascript/Uploader/1.0/Uploader.min.js");
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="golden-layout" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Golden Layout",
                        "dependencies": [
                            "#requirejs",
                            "#cQuery"
                        ],
                        "assets": [],
                        "version": "1.0",
                        "changelog": {
                            "1.0": "Initial version"
                        },
                        "documentationLink": "https://golden-layout.com/",
                        "license": "MIT"
                    }

                    </SCRIPT><SCRIPT type="disabled">

                                        window.GoldenLayoutPath = "https://libraries.projects.cavi.au.dk/javascript/golden-layout";

                                        let goldenLayoutLoadPromise = null;

                                        window.loadGoldenLayout = async (bodyElement) => {
                                            if(goldenLayoutLoadPromise != null) {
                                                console.trace();
                                                await goldenLayoutLoadPromise;
                                                return;
                                            }

                                            goldenLayoutLoadPromise = new Promise(async (resolve)=>{

                                                console.log("Loading GoldenLayout with body replacement:", bodyElement);

                                                //Find top component after html
                                                let topLevelParent = bodyElement;
                                                while(topLevelParent.parentNode != null && !topLevelParent.parentNode.matches("html")) {
                                                    topLevelParent = topLevelParent.parentNode;
                                                }

                                                await wpm.requireExternal("https://code.jquery.com/jquery-3.4.1.slim.min.js");

                                                let origJQueryOffset = jQuery.fn.offset;

                                                jQuery.fn.offset = function() {
                                                    let el = this[0];
                                                    var rect = el.getBoundingClientRect();

                                                    let bounds = topLevelParent.getBoundingClientRect();

                                                    return {
                                                      top: rect.top - bounds.y  + topLevelParent.scrollTop,
                                                      left: rect.left - bounds.x + topLevelParent.scrollLeft
                                                    };
                                                };

                                                let origJqueryCss = jQuery.fn.css;

                                                jQuery.fn.css = function(...args) {
                                                    if(this.is("body") || this.is("html")) {
                                                        console.log("Skipping css on html and body");
                                                        return;
                                                    }

                                                    return origJqueryCss.bind(this)(...args);
                                                };

                                                //Setup override event listener
                                                var origAddEventListener = EventTarget.prototype.addEventListener;
                                                EventTarget.prototype.addEventListener = function(type, fn, capture) {
                                                    if(type === "mousedown" && this.matches != null && (this.matches(".lm_tab") || this.matches(".lm_splitter"))) {
                                                        origAddEventListener.bind(this)(type, (evt)=>{
                                                            let bounds = topLevelParent.getBoundingClientRect();

                                                            let evtOverrides = new Map();

                                                            evtOverrides.set("pageX", evt.pageX - bounds.x);
                                                            evtOverrides.set("pageY", evt.pageY - bounds.y);

                                                            let evtProxy = new Proxy(evt, {
                                                                get: (obj, prop)=>{
                                                                    if(evtOverrides.has(prop)) {
                                                                        let override = evtOverrides.get(prop);
                                                                        return typeof override === "function" ? override.bind(obj) : override;
                                                                    } else {
                                                                        return typeof obj[prop] === "function" ? obj[prop].bind(obj) : obj[prop];
                                                                    }
                                                                }
                                                            });

                                                            fn(evtProxy);

                                                        }, capture);
                                                    } else {
                                                        origAddEventListener.bind(this)(type, fn, capture);
                                                    }
                                                }

                                                await wpm.requireExternal(GoldenLayoutPath+"/goldenlayout-base.css");
                                                await wpm.requireExternal(GoldenLayoutPath+"/goldenlayout-light-theme.css");

                                                let documentOverrides = new Map();

                                                documentOverrides.set("body", bodyElement);

                                                documentOverrides.set("addEventListener", (eventName, callback, options)=>{
                                                    if(options != null) {
                                                        console.log("OPTIONS!!!", options);
                                                    }

                                                    cQuery(document).on(eventName, (evt)=>{
                                                        let bounds = topLevelParent.getBoundingClientRect();

                                                        let evtOverrides = new Map();

                                                        evtOverrides.set("pageX", evt.pageX - bounds.x);
                                                        evtOverrides.set("pageY", evt.pageY - bounds.y);

                                                        let evtProxy = new Proxy(evt, {
                                                            get: (obj, prop)=>{
                                                                if(evtOverrides.has(prop)) {
                                                                    let override = evtOverrides.get(prop);
                                                                    return typeof override === "function" ? override.bind(obj) : override;
                                                                } else {
                                                                    return typeof obj[prop] === "function" ? obj[prop].bind(obj) : obj[prop];
                                                                }
                                                            }
                                                        });

                                                        callback(evtProxy);
                                                    }, options);
                                                });

                                                documentOverrides.set("removeEventListener", (eventName, callback, options)=>{
                                                    cQuery(document).off(eventName);
                                                });

                                                documentOverrides.set("querySelector", (selector)=>{
                                                    console.log("querySelector", selector);
                                                    return document.querySelector(selector);
                                                });

                                                documentOverrides.set("querySelectorAll", (selector)=>{
                                                    console.log("querySelectorAll", selector);
                                                    return document.querySelectorAll(selector);
                                                });

                                                let documentProxy = new Proxy(document, {
                                                    get: (obj, prop)=>{
                                                        if(documentOverrides.has(prop)) {
                                                            let override = documentOverrides.get(prop);
                                                            return typeof override === "function" ? override.bind(obj) : override;
                                                        } else {
                                                            return typeof obj[prop] === "function" ? obj[prop].bind(obj) : obj[prop];
                                                        }
                                                    }
                                                });

                                                async function internalLoad(document) {

                                                    let response = await fetch(GoldenLayoutPath+"/goldenlayout.min.js", {credentials: 'same-origin'});
                                                    let scriptContent = await response.text();

                                                    let origDefine = window.define;
                                                    if (window.define != null) {
                                                        window.define = null;
                                                    }

                                                    eval(scriptContent);

                                                    //Restore previous define, if this script did not set define
                                                    if (window.define === null && origDefine != null) {
                                                        window.define = origDefine;
                                                    }
                                                }

                                                await internalLoad(documentProxy);

                                                resolve();
                                            });

                                            await goldenLayoutLoadPromise;
                                        };
                                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="wpm_js_libs" id="golden-layout_material-design-theme" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Material Design Theme bindings for Golden Layout",
                        "dependencies": [
                            "#golden-layout"
                        ],
                        "assets": [],
                        "version": "1.0",
                        "changelog": {
                            "1.0": "Initial version"
                        },
                        "license": "Apache 2.0"
                    }

                    </SCRIPT><STYLE id="gl-mdc-binding-style">
                    .lm_goldenlayout .lm_content {
                      background: var(--mdc-theme-background); }

                    .lm_maximised .lm_header {
                      background-color: var(--mdc-theme-surface); }

                    .lm_goldenlayout .lm_header .lm_tab {
                      background: var(--mdc-theme-surface);
                      border: 0;
                      user-select: none; }
                      .lm_goldenlayout .lm_header .lm_tab .lm_title {
                        color: var(--mdc-theme-on-surface); }
                      .lm_goldenlayout .lm_header .lm_tab.lm_active {
                        border-bottom: 2px solid var(--mdc-theme-primary);
                        box-shadow: none;
                        padding-bottom: 4px; }
                        .lm_goldenlayout .lm_header .lm_tab.lm_active:before {
                          position: absolute;
                          top: 0;
                          left: 0;
                          background: var(--mdc-theme-primary);
                          opacity: 0.04;
                          content: "";
                          width: 100%;
                          height: 100%; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="wsc-icon-registry" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Icon registry",
                        "description": "Icon providers can register icons for everyone and everything",
                        "dependencies": [],
                        "assets": [
                        ],
                        "version": "0.1",
                        "license": "Apache 2.0 + CC-BY",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="IconRegistry-script" type="disabled">
                    /**
                     *  IconRegistry
                     *  Register icons and use them on the page
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Registers icons and uses them on the page
                     */
                    window.IconRegistry = class IconRegistry {
                        static registerProvider(iconProvider){
                            IconRegistry.iconProviders.push(iconProvider);

                            // TODO: update all icons
                        }

                        static createIcon(iconIdentifier){
                            let icon = null;
                            let searchPath = null;

                            if (Array.isArray(iconIdentifier)){
                                searchPath = iconIdentifier;
                            } else {
                                searchPath = [iconIdentifier];
                            }

                            // Query each icon or fallback in order
                            search: for (const attempt of searchPath){
                                for (const provider of IconRegistry.iconProviders){
                                    if (provider.provides(attempt)){
                                        icon = provider.createIcon(attempt);
                                        break search;
                                    }
                                }
                            }


                            // Ultimate fallback is invisible
                            if (icon===null){
                                icon = document.createElement("span");
                            }
                            icon.classList.add("wsc-registry-icon");
                            icon.wscIconIdentifier = iconIdentifier;

                            return icon;
                        }
                    };
                    window.IconRegistry.iconProviders = [];

                    </SCRIPT><STYLE id="icons-style">
                    .wsc-registry-icon {
                        width: 100%;
                        height: 100%;
                        object-fit: contain;
                    }

                    /* Fix Chrome SVG render bug for gradients/filters etc */
                    head {
                        display: block;
                        position: absolute;
                        z-index: -10;
                        opacity: 0;
                        pointer-events: none;
                    }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="WebstrateComponents_Tools" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "WebstrateComponents Tools",
                        "description": "Various tools that are nice to reuse",
                        "dependencies": [],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="Tools-script" type="disabled">
                    /**
                     * WebstrateComponents Tools
                     *
                     * Ease-of-use tools to help manage WPM package info and templates
                     *
                     * Copyright 2019, 2020, 2021 Rolf Bagge, Janus Bager Kristensen,
                     * CAVI - Center for Advanced Visualisation and Interaction,
                     * Aarhus University
                     *
                     * Licensed under the Apache License, Version 2.0 (the "License");
                     * you may not use this file except in compliance with the License.
                     * You may obtain a copy of the License at
                     *
                     * http://www.apache.org/licenses/LICENSE-2.0
                     *
                     * Unless required by applicable law or agreed to in writing, software
                     * distributed under the License is distributed on an "AS IS" BASIS,
                     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     * See the License for the specific language governing permissions and
                     * limitations under the License.
                     **/

                    /**
                     * @namespace WebstrateComponents
                     */
                    window.WebstrateComponents = {};

                    /**
                     * A collection of tools
                     * @type {WebstrateComponents.Tools}
                     * @hideconstructor
                     */
                    WebstrateComponents.Tools = class Tools {
                        /**
                         * Tries to extract the entry with the given key from the given config. If key does not exist, returns defaultValue instead.
                         * @param {Object} config - The configuration to extract the entry from
                         * @param {String} key - The key of the entry to extract
                         * @param {*} [defaultValue=null] - The default value to return if the key does not exist.
                         */
                        static fromConfig(config, key, defaultValue = null) {
                            if(config != null && config[key] != null) {
                                return config[key];
                            }

                            return defaultValue;
                        }

                        /**
                         * Loads a template from the document and returns it
                         * @param {String} id - The identifier of the template to load
                         * @returns {Element} - The loaded template
                         */
                        static loadTemplate(id) {
                            if(!id.startsWith("#")) {
                                id = "#" + id;
                            }

                            let fragment = document.importNode(document.querySelector(id).content, true);

                            if(fragment.children.length > 1) {
                                console.warn("Template had more than 1 direct child:", id, fragment);
                            }

                            return fragment.children[0];
                        }

                        /**
                         * Tests if the given testElement is inside the given elm
                         * @param {Element} elm
                         * @param {Element} testElement
                         */
                        static isInsideElement(elm, testElement) {
                            let parent = testElement;

                            while(parent != null) {
                                if(parent === elm) {
                                    return true;
                                }

                                parent = parent.parentNode;
                            }

                            return false;
                        }
                    };

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="ButtonSystem" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Buttons",
                        "description": "Buttons for all",
                        "dependencies": [],
                        "assets": [
                        ],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="buttons-script" type="disabled">
                    /**
                     *  Button System
                     *  Provides easily usable buttons
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * @namespace ButtonSystem
                     */
                    window.ButtonSystem = {};

                    /**
                     * @typedef {Object} ButtonSystem~ButtonConfig
                     * @property {ButtonSystem.ButtonBuilder} [builder] - The builder to use when creating the button, if not specified, the DefaultBuilder will be used.
                     * @property {'text'|'outlined'|'raised'|'unelevated'} [style='text'] - The style of the button
                     * @property {Element} [icon] - An icon to add to the button
                     * @property {boolean} [iconTrailing=true] - Wether the icon should be trailing the button text
                     * @property {Function} [onAction] - The callback to run when the button has its action triggered
                     */

                    /**
                     * ButtonFactory can create buttons
                     */
                    ButtonSystem.ButtonFactory = class ButtonFactory {
                        /**
                         * Create a new button
                         *
                         * @example
                         * ButtonFactory.createButton("MyButton", {
                         *     style: "outlined",
                         *     onAction: ()=>{
                         *         //Someone pressed my button
                         *     }
                         * });
                         *
                         * @param {String} text - The text of the button
                         * @param {ButtonSystem~ButtonConfig} options
                         * @returns {ButtonSystem.Button}
                         */
                        static createButton(text, options) {
                            if(options.builder == null) {
                                if(ButtonFactory.defaultBuilder == null) {
                                    throw "Attempt to create Button with defaultBuilder but no default builder is set!";
                                }

                                options.builder = ButtonFactory.defaultBuilder;
                            }

                            if(options.style == null) {
                                options.style = "text";
                            }

                            return new ButtonSystem.Button(text, options);
                        }

                        /**
                         * Sets the defailt button builder
                         * @param {ButtonBuilder} builder
                         */
                        static setDefaultBuilder(builder) {
                            ButtonFactory.defaultBuilder = builder;
                        }
                    }

                    ButtonSystem.ButtonFactory.defaultBuilder = null;

                    ButtonSystem.ButtonBuilder = class ButtonBuilder {
                        /**
                         * Build the DOM for the given button
                         * @param button
                         */
                        static buildButton(button) {
                            //Override in subclass
                        }
                    }

                    /**
                     * Button represents a Button
                     * @type {ButtonSystem.Button}
                     */
                    ButtonSystem.Button = class Button {
                        /**
                         * @param {String} text - The text of the button
                         * @param {ButtonSystem~ButtonConfig} options
                         */
                        constructor(text, options) {
                            let self = this;

                            this.text = text;
                            this.options = options;

                            /** @member {Element} - The DOM element of this button */
                            this.html = this.options.builder.buildButton(this);

                            this.html.addEventListener("click", ()=>{
                                if(self.options.onAction != null) {
                                    self.options.onAction();
                                }
                            });
                        }
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="FragmentLogoIcons" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Fragment Logo Icon Set",
                        "description": "Provides Icons for Fragments based on their logos",
                        "dependencies": [
                            "#wsc-icon-registry"
                        ],
                        "assets": [
                        ],
                        "version": "0.1",
                        "license": "Apache 2.0 + Various",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="FragmentLogoIconProvider-script" type="disabled">
                    /**
                     *  FragmentLogoIconProvider
                     *  A provider for Codestrate fragment type icons
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A provider for Codestrate fragment type icons
                     */
                    window.FragmentLogoIconProvider = class FragmentLogoIconProvider {
                        provides(iconIdentifier){
                            return iconIdentifier.startsWith("code-fragment:");
                        }

                        /**
                         * Create an icon
                         */
                        createIcon(iconIdentifier) {
                            let mimeType = iconIdentifier.slice(14);
                            /*
                              "wpm/descriptor": (
                                base: #000080,
                                text: #A0A0FF,
                                name: 'WPM Package Descriptor',
                                type: 'wpm'
                              ),
                            */
                            let supportedTypes = [
                                "text/html",
                                "text/javascript",
                                "text/javascript+babel",
                                "text/css",
                                "text/x-typescript",
                                "text/markdown",
                                "text/x-latex",
                                "image/svg+xml",
                                "application/json",
                                "text/p5js",
                                "text/ruby",
                                "application/x-lua",
                                "model/vnd.usda",
                                "text/x-scss",
                                "text/python"
                            ];
                            if (mimeType==="text/javascript+babel") mimeType = "text/javascript";
                            if (supportedTypes.includes(mimeType)){
                                let icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                let link = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                                link.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#'+mimeType.replace(/(\/|\+)/g, "-"));
                                icon.appendChild(link);
                                return icon;
                            }

                            if (mimeType==="wpm/descriptor"){
                                return IconRegistry.createIcon("mdc:list_alt");
                            } else if (mimeType==="text/mirrorverse-audio-router"){
                                return IconRegistry.createIcon("mdc:route");
                            } else if (mimeType==="text/varv"){
                                return IconRegistry.createIcon("webstrates:varv");
                            }

                            return null;
                        }
                    }


                    /**
                     * Icons for fragments
                     * @type {FragmentIcons.IconProvider}
                     * @hideconstructor
                     */
                    IconRegistry.registerProvider(new FragmentLogoIconProvider());

                    </SCRIPT><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 595.3 841.9">
                        <symbol id="text-html" viewBox="0 0 512 512">
                            <!-- License: Creative Commons Attribution 3.0: W3C -->
                            <path d="M108.4 0h23v22.8h21.2V0h23v69h-23V46h-21v23h-23.2M206 23h-20.3V0h63.7v23H229v46h-23M259.5 0h24.1l14.8 24.3L313.2 0h24.1v69h-23V34.8l-16.1 24.8l-16.1-24.8v34.2h-22.6M348.7 0h23v46.2h32.6V69h-55.6"></path>
                            <path fill="#e44d26" d="M107.6 471l-33-370.4h362.8l-33 370.2L255.7 512"></path>
                            <path fill="#f16529" d="M256 480.5V131H404.3L376 447"></path>
                            <path fill="#ebebeb" d="M142 176.3h114v45.4h-64.2l4.2 46.5h60v45.3H154.4M156.4 336.3H202l3.2 36.3 50.8 13.6v47.4l-93.2-26"></path>
                            <path fill="#fff" d="M369.6 176.3H255.8v45.4h109.6M361.3 268.2H255.8v45.4h56l-5.3 59-50.7 13.6v47.2l93-25.8"></path>
                        </symbol>
                        <symbol id="text-css" viewBox="0 0 362.73 512">
                            <!-- License: Creative Commons Attribution 3.0: Rudloff -->
                            <g transform="translate(-193.63 -276.36)">
                                <g transform="translate(119 276.36)">
                                    <polygon points="437.37 100.62 404.32 470.82 255.78 512 107.64 470.88 74.633 100.62" fill="#264de4"></polygon>
                                    <polygon points="376.03 447.25 404.27 130.89 256 130.89 256 480.52" fill="#2965f1"></polygon>
                                    <g fill="#ebebeb">
                                        <polygon points="150.31 268.22 154.38 313.63 256 313.63 256 268.22"></polygon>
                                        <polygon points="256 176.3 255.84 176.3 142.13 176.3 146.26 221.72 256 221.72"></polygon>
                                        <polygon points="256 433.4 256 386.15 255.8 386.21 205.23 372.55 201.99 336.33 177.42 336.33 156.41 336.33 162.77 407.63 255.79 433.46"></polygon>
                                    </g>
                                    <path d="m160 0h55v23h-32v23h32v23h-55z"></path>
                                    <path d="m226 0h55v20h-32v4h32v46h-55v-21h32v-4h-32z"></path>
                                    <path d="m292 0h55v20h-32v4h32v46h-55v-21h32v-4h-32z"></path>
                                    <polygon points="311.76 313.63 306.49 372.52 255.84 386.19 255.84 433.44 348.94 407.63 349.62 399.96 360.29 280.41 361.4 268.22 369.6 176.3 255.84 176.3 255.84 221.72 319.83 221.72 315.7 268.22 255.84 268.22 255.84 313.63" fill="#fff"></polygon>
                                </g>
                            </g>
                        </symbol>
                        <symbol id="text-javascript" viewBox="0 0 630 630">
                            <!-- License: MIT: Copyright (c) 2011 Christopher Williams -->
                            <rect width="630" height="630" fill="#f7df1e"></rect>
                            <path d="m423.2 492.19c12.69 20.72 29.2 35.95 58.4 35.95 24.53 0 40.2-12.26 40.2-29.2 0-20.3-16.1-27.49-43.1-39.3l-14.8-6.35c-42.72-18.2-71.1-41-71.1-89.2 0-44.4 33.83-78.2 86.7-78.2 37.64 0 64.7 13.1 84.2 47.4l-46.1 29.6c-10.15-18.2-21.1-25.37-38.1-25.37-17.34 0-28.33 11-28.33 25.37 0 17.76 11 24.95 36.4 35.95l14.8 6.34c50.3 21.57 78.7 43.56 78.7 93 0 53.3-41.87 82.5-98.1 82.5-54.98 0-90.5-26.2-107.88-60.54zm-209.13 5.13c9.3 16.5 17.76 30.45 38.1 30.45 19.45 0 31.72-7.61 31.72-37.2v-201.3h59.2v202.1c0 61.3-35.94 89.2-88.4 89.2-47.4 0-74.85-24.53-88.81-54.075z"></path>
                        </symbol>
                        <symbol id="text-x-latex" viewBox="0 0 1200 500">
                            <path d="M285.7 238h-11.25c-4.5 45.9-10.8 101.7-90 101.7H148c-21.15 0-22.05-3.15-22.05-18V82.75c0-15.3 0-21.6 42.3-21.6h14.85v-13.5C166.9 49 126.4 49 107.95 49 90.4 49 55.3 49 40 47.65v13.5h10.35C85 61.15 85.9 66.1 85.9 82.3v236.25c0 16.2-.9 21.15-35.55 21.15H40v13.95h233.55L285.7 238z"></path>
                            <path d="M278.05 47.2c-1.8-5.4-2.7-7.2-8.55-7.2-5.85 0-7.2 1.8-9 7.2l-72.45 183.6c-3.15 7.65-8.55 21.6-36.45 21.6v11.25h69.75V252.4c-13.95 0-22.5-6.3-22.5-15.3 0-2.25.45-3.15 1.35-6.3l15.3-38.7h89.1l18 45.9c.9 1.8 1.8 4.05 1.8 5.4 0 9-17.1 9-25.65 9v11.25h88.65V252.4h-6.3c-21.15 0-23.4-3.15-26.55-12.15L278.05 47.2zm-18 31.95l40.05 101.7H220l40.05-101.7z"></path>
                            <path d="M638.5 50.35H364.45l-8.1 100.8h10.8c6.3-72.45 13.05-87.3 81-87.3 8.1 0 19.8 0 24.3.9 9.45 1.8 9.45 6.75 9.45 17.1V318.1c0 15.3 0 21.6-47.25 21.6h-18v13.95c18.45-1.35 63.9-1.35 84.6-1.35 20.7 0 67.05 0 85.5 1.35V339.7h-18c-47.25 0-47.25-6.3-47.25-21.6V81.85c0-9 0-15.3 8.1-17.1 4.95-.9 17.1-.9 25.65-.9 67.5 0 74.25 14.85 80.55 87.3h11.25l-8.55-100.8z"></path>
                            <path d="M879.7 339.25h-11.25c-11.25 68.85-21.6 101.7-98.55 101.7h-59.4c-21.15 0-22.05-3.15-22.05-18v-119.7h40.05c43.65 0 48.6 14.4 48.6 52.65h11.25V237.1H777.1c0 38.25-4.95 52.2-48.6 52.2h-40.05V181.75c0-14.85.9-18 22.05-18h57.6c68.85 0 80.55 24.75 87.75 87.3h11.25l-12.6-100.8h-252v13.5h10.35c34.65 0 35.55 4.95 35.55 21.15v234.9c0 16.2-.9 21.15-35.55 21.15H602.5v13.95h258.3l18.9-115.65z"></path>
                            <path d="M1015.15 180.4l61.65-90c9.45-14.4 24.75-28.8 64.8-29.25v-13.5h-107.1v13.5c18 .45 27.9 10.35 27.9 20.7 0 4.5-.9 5.4-4.05 10.35l-51.3 75.6-57.6-86.4c-.9-1.35-3.15-4.95-3.15-6.75 0-5.4 9.9-13.05 28.8-13.5v-13.5C959.8 49 926.95 49 909.85 49c-13.95 0-41.85-.45-58.5-1.35v13.5h8.55c24.75 0 33.3 3.15 41.85 15.75l82.35 124.65L910.75 310c-6.3 9-19.8 29.7-64.8 29.7v13.95h107.1V339.7c-20.7-.45-28.35-12.6-28.35-20.7 0-4.05 1.35-5.85 4.5-10.8l63.45-94.05 71.1 107.1c.9 1.8 2.25 3.6 2.25 4.95 0 5.4-9.9 13.05-29.25 13.5v13.95c15.75-1.35 48.6-1.35 65.25-1.35 18.9 0 39.6.45 58.5 1.35V339.7h-8.55c-23.4 0-32.85-2.25-42.3-16.2l-94.5-143.1z"></path>
                        </symbol>
                        <symbol id="text-x-typescript" viewBox="0 0 400 400">
                            <path fill="#007acc" d="M0 200V0h400v400H0"></path>
                            <path d="M87.7 200.7V217h52v148h36.9V217h52v-16c0-9 0-16.3-.4-16.5 0-.3-31.7-.4-70.2-.4l-70 .3v16.4l-.3-.1zM321.4 184c10.2 2.4 18 7 25 14.3 3.7 4 9.2 11 9.6 12.8 0 .6-17.3 12.3-27.8 18.8-.4.3-2-1.4-3.6-4-5.2-7.4-10.5-10.6-18.8-11.2-12-.8-20 5.5-20 16 0 3.2.6 5 1.8 7.6 2.7 5.5 7.7 8.8 23.2 15.6 28.6 12.3 41 20.4 48.5 32 8.5 13 10.4 33.4 4.7 48.7-6.4 16.7-22 28-44.3 31.7-7 1.2-23 1-30.5-.3-16-3-31.3-11-40.7-21.3-3.7-4-10.8-14.7-10.4-15.4l3.8-2.4 15-8.7 11.3-6.6 2.6 3.5c3.3 5.2 10.7 12.2 15 14.6 13 6.7 30.4 5.8 39-2 3.7-3.4 5.3-7 5.3-12 0-4.6-.7-6.7-3-10.2-3.2-4.4-9.6-8-27.6-16-20.7-8.8-29.5-14.4-37.7-23-4.7-5.2-9-13.3-11-20-1.5-5.8-2-20-.6-25.7 4.3-20 19.4-34 41-38 7-1.4 23.5-.8 30.4 1l-.2.2z"></path>
                        </symbol>
                        <symbol id="text-markdown" viewBox="0 0 208 128">
                            <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication -->
                            <rect width="198" height="118" x="5" y="5" ry="10" stroke="currentColor" stroke-width="10" fill="none"></rect>
                            <path d="M30 98V30h20l20 25 20-25h20v68H90V59L70 84 50 59v39zm125 0l-30-33h20V30h20v35h20z"></path>
                        </symbol>

                        <symbol id="text-x-scss" viewBox="0 0 548 548">
                            <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbll Petersen -->
                            <g fill="#D465A7">
                                <path d="M199 370c-31 0-55 15-51 35 5 21 41 36 84 36 17 0 34-1 48-4 6-35-23-67-81-67zm125-206c-8 12-14 26-15 42-2 20 7 34 19 34 9 0 15-9 17-20s4-35-21-56z"></path>
                                <path d="M274 0a274 274 0 1 0 0 548 274 274 0 0 0 0-548zm143 109c-3 11-12 17-21 17-16 0-32 6-47 16a82 82 0 0 1 22 78c-4 24-24 46-47 46-25 0-45-23-43-60 1-17 7-37 16-52l-24-3c-71 0-101 45-97 82 4 38 36 52 86 70 49 17 106 37 92 91-6 23-27 42-60 51a69 69 0 0 1-47 38c-5 0-8-2-8-5 0-2 1-4 5-5 11-3 23-11 30-23a308 308 0 0 1-42 3c-50 0-96-18-103-48-7-28 22-52 68-52 63 0 105 36 101 78 19-7 33-21 36-37 8-37-26-53-80-71-47-15-96-31-105-90-8-54 32-118 126-118 18 0 33 4 46 8 23-21 52-35 84-35 9 0 15 9 12 21z"></path>
                            </g>
                        </symbol>
                        <symbol id="text-p5js" viewBox="0 0 202 202">
                            <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbll Petersen -->
                            <g fill="#E83B71">
                                <path d="M0 0v202h202V0H0zm66 157c-9 5-26 6-35-6v38H16V98h14v9l1-1c16-17 42-11 49 11 4 16-1 33-14 40zm62 2c-14 5-31 2-39-10l-2-2 11-10c3 7 8 11 16 12 12 0 20-9 18-21-2-9-8-14-17-15l-12 1-12 4 1-48h51v13h-36l-1 18c7 1 14 0 20 2 13 3 20 12 21 25 1 14-6 26-19 31zm56-66-5 4-6-8-6 7-5-4 6-7-9-3 2-7 9 3v-9h6v9l9-2 2 6-8 3 5 8z"></path>
                                <path d="M45 109c-10 2-17 13-14 24 2 10 10 16 20 15 9-1 15-9 15-20 0-12-9-21-21-19z"></path>
                            </g>
                        </symbol>
                        <symbol id="image-svg-xml" viewBox="0 0 966 966">
                            <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbll Petersen -->
                            <path fill="#000100" d="M825 0H141C63 0 0 63 0 141v684c0 78 63 141 141 141h684c78 0 141-63 141-141V141C966 63 903 0 825 0z"></path>
                            <path fill="#FAAE3C" d="M659 217a34 34 0 0 0-48 0h-70l49-49a34 34 0 1 0-34-34l-49 49v-69a34 34 0 1 0-48 0v69l-49-49a34 34 0 1 0-34 34l49 49h-70a34 34 0 1 0 0 49h70l-49 49a34 34 0 1 0 34 34l49-49v69a34 34 0 1 0 48 0v-69l49 49a34 34 0 1 0 34-34l-49-49h70a34 34 0 1 0 48-49z"></path>
                            <path fill="#FFF" d="M144 687a125 125 0 0 1 89-213c69 0 125 56 125 125h-74a52 52 0 1 0-88 36c9 10 17 13 37 16 34 3 65 14 88 36a125 125 0 0 1-88 214c-69 0-126-56-126-125h74a52 52 0 1 0 88-37c-9-9-23-12-36-15-34-5-66-14-89-37zm464-213-88 427h-74l-88-427h73l52 250 52-250h73zm125 177h126v125a125 125 0 0 1-251 0V599a125 125 0 0 1 251 0h-74a52 52 0 0 0-103 0v177a52 52 0 0 0 103 0v-52h-52v-73z"></path>
                        </symbol>
                        <symbol id="text-ruby" viewBox="0 0 384.9 369">
                            <!-- License: Creative Commons CC0 1.0 Universal Public Domain Dedication, (c) Jonas Oxenbll Petersen -->
                            <path fill="#D5181D" d="M274 223 106 331l254 35-86-143zM384 63l-23 34-77 116c-1 3-3 4-1 8l74 123 13 19 15-299-1-1zM44 191c1 2 4 2 6 2l71-36c8-5 13-12 20-18l65-60 4-4 23-46-28-10c-1-1-3 0-4 1l-63 36c-10 6-18 15-27 24a3253 3253 0 0 0-53 52l-30 43 16 16zm88-19L96 323l168-108-132-43zm94-84 49 118 94-142-143 24zm-92 74 130 42-49-117-81 75zm-88 59L1 329l86-2-41-106zm42 81 1-1 32-131-69 36 36 96zM352 57l-42-11-59-16c-3-1-5-1-6 2l-21 43-1 2 129-19v-1zm-80-33 112 31-18-53-94 21v1zm34 344-93-13-115-15c-14-2-28-1-43 0a2033 2033 0 0 0-38 2l288 27 1-1zM3 296l37-86c1-3 1-5-2-7l-15-17L0 300h1l2-3zM247 17l63-15 4-1V0l-91 12c9 4 15 7 24 5z"></path>
                        </symbol>
                        <symbol id="model-vnd.usda" viewBox="0 0 20 22.72">
                          <g>
                            <path d="m13.88,22.72V7.31L0,2.54v15.43l13.88,4.75Zm-11.34-6.69V6.36l8.69,2.96v9.67l-8.69-2.96Z" fill="#208ecd" stroke-width="0"></path>
                            <path d="m3.55,15.19l6.63,2.27v-7.31l-6.63-2.27v7.31Z" fill="#7dd1f6" stroke-width="0"></path>
                            <path d="m17.85,11.19l2.15.75V2.72L12.09,0v2.33l5.76,2v6.87Z" fill="#7dd1f6" stroke-width="0"></path>
                            <path d="m5.97,1.19v2.33l8.78,3.04v9.94l2.15.72V4.96L5.97,1.19Z" fill="#35c3f1" stroke-width="0"></path>
                          </g>
                        </symbol>

                        <symbol id="application-x-lua" viewBox="0 0 946.5 946.5">
                            <!-- License:
                                Copyright  1998 Lua.org. Graphic design by Alexandre Nakonechnyj.

                                Permission is hereby granted, without written agreement and without license or royalty fees, to use, copy, and distribute this logo for any purpose, including commercial applications, subject to the following conditions:

                                The origin of this logo must not be misrepresented; you must not claim that you drew the original logo.
                                The only modification you can make is to adapt the orbiting text to your product name.
                                The logo can be used in any scale as long as the relative proportions of its elements are maintained.
                            -->
                            <path fill="navy" d="M835 473a362 362 0 1 0-724 1 362 362 0 0 0 724-1"></path>
                            <path fill="#fff" d="M729 323a106 106 0 1 0-212 0 106 106 0 0 0 212 0"></path>
                            <path fill="navy" d="M941 111a106 106 0 1 0-212 0 106 106 0 0 0 212 0"></path>
                            <path fill="#fff" d="M258 628h117v26H228V417h30zm257 26v-24c-16 23-32 32-57 32-33 0-54-18-54-47V484h27v120c0 21 14 34 35 34 28 0 47-23 47-58v-96h27v170zm223 5-18 3c-18 0-27-8-28-25a81 81 0 0 1-58 25c-35 0-56-20-56-51 0-22 10-37 30-45 10-5 16-6 54-11 22-2 29-7 29-19v-7c0-16-14-25-39-25s-37 9-40 30h-27c1-17 4-27 12-35 11-13 32-20 56-20 42 0 65 16 65 46v101c0 8 5 13 14 13l6-1zm-47-89c-10 4-15 5-44 9s-41 14-41 32c0 17 12 27 33 27 16 0 30-5 41-15 8-8 11-13 11-23z"></path>
                            <path fill="none" stroke="gray" stroke-dasharray="40.8" stroke-miterlimit="10" stroke-width="10.9" d="M890 261A468 468 0 1 1 709 69"></path>
                        </symbol>

                        <defs>
                            <linearGradient id="application-json-linearGradient8385">
                                <stop offset="0"></stop>
                                <stop stop-color="#fff" offset="1"></stop>
                            </linearGradient>
                            <linearGradient id="application-json-linearGradient3002" x1="-553.27" x2="-666.12" y1="525.91" y2="413.05" gradientTransform="matrix(.99884 0 0 .9987 689.01 -388.84)" gradientUnits="userSpaceOnUse" xlink:href="#application-json-linearGradient8385"></linearGradient>
                            <linearGradient id="application-json-linearGradient3005" x1="-666.12" x2="-553.27" y1="413.04" y2="525.91" gradientTransform="matrix(.99884 0 0 .9987 689.01 -388.84)" gradientUnits="userSpaceOnUse" xlink:href="#application-json-linearGradient8385"></linearGradient>
                        </defs>
                        <symbol id="application-json" viewBox="0 0 160 160">
                            <!-- License:
                                Douglas Crockford
                                This logo image consists only of simple geometric shapes or text. It does not meet the threshold of originality needed for copyright protection, and is therefore in the public domain. Although it is free of copyright restrictions, this image may still be subject to other restrictions - Wikimedia Commons
                            -->
                            <path d="m79.865 119.1c35.398 48.255 70.04-13.469 69.989-50.587-0.0602-43.886-44.541-68.414-70.018-68.414-40.892 0-79.836 33.796-79.836 80.036 0 51.396 44.64 79.865 79.836 79.865-7.9645-1.1468-34.506-6.834-34.863-67.967-0.23987-41.347 13.488-57.866 34.805-50.599 0.47743 0.17707 23.514 9.2645 23.514 38.951 0 29.56-23.427 38.715-23.427 38.715z" color="#000000" fill="url(#application-json-linearGradient3005)" fill-rule="evenodd"></path>
                            <path d="m79.823 41.401c-23.39-8.0619-52.043 11.216-52.043 49.829 0 63.048 46.721 68.77 52.384 68.77 40.892 0 79.836-33.796 79.836-80.036 0-51.396-44.64-79.865-79.836-79.865 9.7481-1.35 52.541 10.55 52.541 69.037 0 38.141-31.953 58.905-52.735 50.033-0.47743-0.17707-23.514-9.2645-23.514-38.951 0-29.56 23.367-38.818 23.367-38.818z" color="#000000" fill="url(#application-json-linearGradient3002)" fill-rule="evenodd"></path>
                        </symbol>

                        <defs>
                            <linearGradient id="text-python-b" x1="89.1" x2="147.8" y1="111.9" y2="168.1" gradientUnits="userSpaceOnUse">
                                <stop offset="0" stop-color="#ffe052"></stop>
                                <stop offset="1" stop-color="#ffc331"></stop>
                            </linearGradient>
                            <linearGradient id="text-python-a" x1="55.5" x2="110.2" y1="77.1" y2="131.8" gradientUnits="userSpaceOnUse">
                                <stop offset="0" stop-color="#387eb8"></stop>
                                <stop offset="1" stop-color="#366994"></stop>
                            </linearGradient>
                        </defs>
                        <symbol id="text-python" viewBox="0 0 110.4 109.8">
                            <!-- License:
                                https://www.python.org/psf/trademarks/
                                Use of Python Two-Snakes trademarked logo (version 1.5.0):

                                [...] stating accurately that software is written in the Python programming language,
                            that it is compatible with the Python programming language, or that it contains the Python
                            programming language, is always allowed. In those cases, you may use the word "Python"
                            or the unaltered logos to indicate this, without our prior approval. This is true
                            both for non-commercial and commercial uses.

                            This clause overrides other clauses of this policy

                                [...]-->

                            <g color="#000">
                                <path fill="url(#text-python-a)" d="M100 67c-28 0-27 13-27 13l1 12h26v4H63s-18-2-18 26c0 29 16 28 16 28h9v-14s-1-15 15-15h27s15 0 15-15V82s2-15-27-15zm-15 9a5 5 0 1 1 0 10 5 5 0 0 1 0-10z" transform="translate(-45 -67)"></path>
                                <path fill="url(#text-python-b)" d="M101 177c28 0 26-12 26-12v-12h-27v-4h37s18 2 18-26c0-29-15-28-15-28h-10v13s1 16-15 16H88s-14 0-14 14v25s-3 14 27 14zm14-8a5 5 0 1 1 0-10 5 5 0 0 1 0 10z" transform="translate(-45 -67)"></path>
                            </g>
                    </symbol></svg></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="WebstrateIcons" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Webstrates Default Icon Set",
                        "description": "Provides Icons for Webstrate features",
                        "dependencies": [
                            "#wsc-icon-registry"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0 + CC-BY",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="WSIconProvider-script" type="disabled">
                    /**
                     *  WSIconProvider
                     *  A provider for webstrates icons
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A provider for webstrates icons
                     */
                    window.WSIconProvider = class WSIconProvider {
                        constructor(){
                            this.supportedTypes = [
                                "webstrates:logo",
                                "webstrates:wpm-package-open",
                                "webstrates:wpm-package-closed",
                                "webstrates:cauldron",
                                "webstrates:codestrates",
                                "webstrates:components",
                                "webstrates:varv"
                            ];
                        }

                        provides(iconIdentifier){
                            return this.supportedTypes.includes(iconIdentifier);
                        }

                        createIcon(iconIdentifier) {
                                let icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                let link = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                                link.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#'+iconIdentifier.replace(/webstrates:/g, '')+"-icon");
                                icon.appendChild(link);
                                return icon;
                        }
                    };

                    IconRegistry.registerProvider(new WSIconProvider());

                    </SCRIPT><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 595.3 841.9" enable-background="new 0 0 595.3 841.9" xml:space="preserve">
                        <symbol id="logo-icon" viewBox="0 0 265.000000 265.000000" preserveAspectRatio="xMidYMid meet">
                            <!-- License:
                                Copyright (c) 2020, 2021 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                        <g transform="translate(0.000000,265.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
                        <path d="M407 2300 c-119 -42 -177 -101 -177 -180 0 -45 0 -46 120 -153 41
                        -38 42 -40 36 -87 -10 -75 -69 -251 -186 -555 -173 -449 -173 -450 -178 -593
                        -5 -145 8 -190 70 -258 53 -57 108 -77 196 -72 126 7 265 94 471 293 63 60
                        147 150 187 198 l74 88 0 -83 c1 -157 49 -304 129 -390 129 -140 376 -156 607
                        -40 336 170 658 570 798 992 58 174 68 246 64 442 -3 165 -4 176 -31 233 -62
                        132 -123 176 -252 183 -130 7 -231 -31 -282 -107 -29 -43 -31 -108 -4 -142 57
                        -73 87 -169 101 -318 16 -172 -18 -337 -110 -528 -94 -197 -228 -355 -354
                        -414 -152 -72 -228 -10 -228 186 0 179 53 341 234 719 95 196 111 237 115 290
                        4 52 2 66 -19 95 -12 19 -40 43 -60 53 -48 25 -166 34 -240 19 -100 -21 -111
                        -34 -233 -269 -137 -264 -256 -458 -399 -649 -104 -139 -338 -395 -350 -382
                        -8 8 69 222 182 505 218 547 249 723 145 843 -18 22 -59 52 -91 67 -49 24 -72
                        28 -167 31 -92 3 -120 0 -168 -17z m317 -60 c27 -14 63 -42 80 -64 31 -37 31
                        -40 30 -144 -1 -136 -23 -208 -186 -622 -140 -354 -201 -530 -196 -568 2 -22
                        9 -28 35 -30 27 -3 43 8 128 90 250 239 482 577 732 1068 70 138 87 151 204
                        158 96 6 162 -11 190 -47 39 -49 25 -102 -98 -357 -182 -377 -228 -523 -228
                        -724 0 -115 2 -130 26 -175 14 -28 41 -61 60 -73 29 -21 43 -23 95 -19 232 18
                        509 376 588 761 22 103 20 269 -3 381 -17 84 -67 205 -91 220 -5 3 -10 21 -10
                        40 0 45 37 87 101 115 44 18 66 21 140 18 78 -3 92 -6 131 -33 53 -38 103
                        -126 117 -211 89 -510 -334 -1265 -852 -1520 -110 -53 -176 -67 -291 -62 -145
                        8 -239 64 -295 177 -43 86 -52 120 -64 268 l-12 138 -30 3 c-27 2 -38 -7 -99
                        -83 -86 -105 -288 -304 -381 -374 -192 -145 -329 -163 -422 -57 -80 90 -83
                        228 -9 441 24 72 81 225 126 340 101 258 165 446 185 542 21 102 10 129 -81
                        203 -53 42 -64 56 -64 81 0 42 15 65 59 93 71 45 118 56 231 53 90 -2 113 -6
                        154 -27z"></path>
                        </g>
                        </symbol>
                        <symbol id="wpm-package-open-icon" viewBox="0 0 195 195" enable-background="new 0 0 195 195" xml:space="preserve">
                            <!-- License:
                                Copyright (c) 2020, 2021 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->

                                <g>
                                    <polygon fill="#8C6239" points="35.9,45.1 83.6,72.2 86.5,163.7 42,121.1 	"></polygon>
                                    <polygon fill="#C69C6D" points="163.2,51.3 155.1,132.7 86.5,163.7 83.6,72.2 	"></polygon>
                                    <g id="izg6T3.tif_6_">
                                            <g>
                                                    <path fill="#298158" d="M129.2,125.9c-1.2,0.2-2.5,0.6-3.7,0.6c-2.5,0.1-4-1.4-5-3.6c-0.7-1.6-1.1-3.5-1.7-5.5
                                                            c-0.8,1.8-1.6,3.5-2.4,5.2c-2.3,4.8-4.8,9.4-8.1,13.6c-3.5,4.2-7.4,5.2-9.6,2.2c-1-1.4-1.7-3.5-1.7-5.6c0.2-5.4,1-11,1.5-16.8
                                                            c0.4-4.2,0.6-8.6,0.8-13c0.1-1.7-0.7-2.5-2.1-2.8c-0.3-0.1-0.6-0.2-1-0.3c-3.3-0.8-3.8-2.7-1.7-6.4c2.9-5,11.6-8.8,14.8-5.1
                                                            c1.8,2,2,4.9,1.7,7.6c-0.7,7.4-1.8,14.6-2.6,21.5c-0.4,2.9-0.6,5.7-1,8.5c0.2,0,0.4,0,0.5,0c0.9-1.7,1.9-3.3,2.7-5.1
                                                            c4.6-9.8,7.8-20.1,10.2-31.2c0.3-1.2,0.4-2.6,0.9-3.7c0.6-1.3,1.3-3,2.2-3.7c1.8-1.3,3.9-2.6,5.8-2.9c2.6-0.5,3.6,1.7,2.8,5
                                                            c-1,4.5-2.2,9-3.1,13.3c-1.2,5.5-2.2,10.9-1.2,15.5c0.2,0.8,0.6,1.5,1,2c0.7,1,1.7,0.8,2.9-0.3c2.6-2.3,4.2-5.3,5.6-8.5
                                                            c2.7-6.6,4.2-13.3,3.5-19.9c-0.3-3.3-1-6.5-3-8.8c-1.5-1.7-0.3-5.7,2.4-7.9c4.9-4.1,8-3.2,9.7,2.4c1.3,5.6,0.4,10.2,0.4,10.7
                                                            c-0.7,6.9-2.5,13.5-5.2,20c-2.5,6-5.3,11.6-9.4,16.4c-1.6,1.9-3.4,3.5-5.2,5.3C130.6,125.1,129.9,125.5,129.2,125.9z M150.5,76.9
                                                            c-0.2-1-0.4-2.7-0.9-4.4c-1.2-4.6-5.2-5.1-8.8-1.1c-1.9,2.2-2.3,4.3-1,5.9c1.7,2.1,2.3,4.9,2.7,7.9c0.6,4.5,0.1,9.1-1.1,13.8
                                                            c-1.4,5.5-3.3,10.8-7,15.2c-2.5,3-4.7,3.7-6.1,0.9c-0.5-1-0.8-2.2-0.9-3.5c-0.2-4.3,0.4-9,1.5-13.7c0.9-4.4,2.1-8.8,3.2-13.4
                                                            c0.6-2.7,0-4.2-2-4c-1.5,0.2-3.1,1.1-4.6,2c-1.4,0.9-2.1,2.6-2.5,4.4c-1.6,6.2-3.1,12.3-5,18.2c-1.5,4.7-3.3,9.3-5.1,13.8
                                                            c-1.1,2.6-2.5,5.1-3.9,7.5c-0.3,0.5-1,0.8-1.5,1.2c-0.1-0.5-0.5-0.9-0.4-1.5c0.8-6.7,1.7-13.7,2.4-20.9c0.4-4.2,0.6-8.5,0.7-12.8
                                                            c0-2.1-1-3.7-2.9-4.1c-3.5-0.8-6.8,0.9-9.9,3.7c-1.3,1.2-2.5,2.7-2.3,4.6c0.1,1.9,1.9,2,3.2,2.3c1.9,0.4,2.7,1.7,2.7,3.8
                                                            c0,1.8,0,3.6-0.2,5.3c-0.6,6.1-1.3,12-2,17.7c-0.4,3.9-0.8,7.7,0.5,10.9c1,2.5,4.6,3.2,7.2,0.6c3.8-3.8,6-8.4,8.5-13
                                                            c1.2-2.3,2.1-4.7,3.2-7.1c0.2-0.5,0.8-1.1,1.2-1.2c0.3-0.1,0.7,0.5,0.8,0.9c0.4,1.3,0.6,2.7,1,4c1.9,5.9,6,6,11.3,1.8
                                                            c3.4-2.6,5.9-6.4,8.2-10.4c2.8-4.8,5-9.9,6.8-15.3C149.3,90.8,150.5,84.3,150.5,76.9z"></path>
                                                    <path fill="#31A36E" d="M150.5,76.9c0.1,7.4-1.2,13.8-3.2,20.2c-1.7,5.4-4,10.5-6.8,15.3c-2.3,4-4.9,7.8-8.2,10.4
                                                            c-5.3,4.1-9.4,4-11.3-1.8c-0.4-1.3-0.6-2.7-1-4c-0.1-0.4-0.5-0.9-0.8-0.9c-0.4,0.1-0.9,0.7-1.2,1.2c-1.1,2.4-2,4.8-3.2,7.1
                                                            c-2.5,4.6-4.7,9.2-8.5,13c-2.6,2.6-6.2,1.9-7.2-0.6c-1.2-3.2-0.9-7-0.5-10.9c0.6-5.7,1.3-11.6,2-17.7c0.2-1.8,0.2-3.6,0.2-5.3
                                                            c0-2-0.8-3.4-2.7-3.8c-1.3-0.3-3-0.3-3.2-2.3c-0.1-1.8,1-3.4,2.3-4.6c3.1-2.8,6.4-4.5,9.9-3.7c1.9,0.4,3,2,2.9,4.1
                                                            c0,4.3-0.3,8.6-0.7,12.8c-0.7,7.2-1.7,14.2-2.4,20.9c-0.1,0.5,0.3,1,0.4,1.5c0.5-0.4,1.2-0.7,1.5-1.2c1.4-2.5,2.9-4.9,3.9-7.5
                                                            c1.9-4.5,3.7-9.1,5.1-13.8c1.8-5.9,3.3-11.9,5-18.2c0.5-1.8,1.1-3.6,2.5-4.4c1.5-0.9,3.1-1.9,4.6-2c2.1-0.3,2.7,1.3,2,4
                                                            c-1.1,4.6-2.2,9-3.2,13.4c-1,4.8-1.7,9.4-1.5,13.7c0.1,1.3,0.4,2.5,0.9,3.5c1.5,2.8,3.6,2.1,6.1-0.9c3.8-4.4,5.6-9.7,7-15.2
                                                            c1.2-4.7,1.7-9.3,1.1-13.8c-0.4-3-1-5.8-2.7-7.9c-1.3-1.6-0.9-3.8,1-5.9c3.6-4,7.6-3.5,8.8,1.1C150,74.2,150.3,76,150.5,76.9z"></path>
                                            </g>
                                    </g>
                                    <polygon fill="#754C24" points="105.9,31.3 107.3,66 83.6,72.2 35.9,45.1 	"></polygon>
                                    <polygon fill="#603813" points="163.2,51.3 107.3,66 105.9,31.3 	"></polygon>
                                    <polygon fill="#A67C52" points="35.9,45.1 83.6,72.2 42.3,103.8 0.9,67.4 	"></polygon>
                                    <polygon fill="#A67C52" points="105.9,31.3 35.9,45.1 17.2,25.2 86.5,16.5 	"></polygon>
                                    <polygon fill="#A67C52" points="163.2,51.3 105.9,31.3 130.3,8.9 190.1,21.8 	"></polygon>
                                    <polygon fill="#A67C52" points="83.6,72.2 163.2,51.3 193.2,81.2 111.8,112.5 	"></polygon>
                                </g>
                        </symbol>
                        <symbol id="wpm-package-closed-icon" viewBox="0 0 195 195" enable-background="new 0 0 195 195" xml:space="preserve">
                            <!-- License:
                                Copyright (c) 2020, 2021 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                            <g>
                                    <polygon fill="#8C6239" points="35.8,45.1 83.5,72.2 86.5,163.7 41.9,121.1 	"></polygon>
                                    <polygon fill="#C69C6D" points="163.2,51.3 155,132.7 86.5,163.7 83.5,72.2 	"></polygon>
                                    <polygon fill="#A67C52" points="104.9,31.3 163.2,51.3 83.5,72.2 35.8,45.1 	"></polygon>
                                    <g id="izg6T3.tif_3_">
                                            <g>
                                                    <path fill="#298158" d="M129.1,125.9c-1.2,0.2-2.5,0.6-3.7,0.6c-2.5,0.1-4-1.4-5-3.6c-0.7-1.6-1.1-3.5-1.7-5.5
                                                            c-0.8,1.8-1.6,3.5-2.4,5.2c-2.3,4.8-4.8,9.4-8.1,13.6c-3.5,4.2-7.4,5.2-9.6,2.2c-1-1.4-1.7-3.5-1.7-5.6c0.2-5.4,1-11,1.5-16.8
                                                            c0.4-4.2,0.6-8.6,0.8-13c0.1-1.7-0.7-2.5-2.1-2.8c-0.3-0.1-0.6-0.2-1-0.3c-3.3-0.8-3.8-2.7-1.7-6.4c2.9-5,11.6-8.8,14.8-5.1
                                                            c1.8,2,2,4.9,1.7,7.6c-0.7,7.4-1.8,14.6-2.6,21.5c-0.4,2.9-0.6,5.7-1,8.5c0.2,0,0.4,0,0.5,0c0.9-1.7,1.9-3.3,2.7-5.1
                                                            c4.6-9.8,7.8-20.1,10.2-31.2c0.3-1.2,0.4-2.6,0.9-3.7c0.6-1.3,1.3-3,2.2-3.7c1.8-1.3,3.9-2.6,5.8-2.9c2.6-0.5,3.6,1.7,2.8,5
                                                            c-1,4.5-2.2,9-3.1,13.3c-1.2,5.5-2.2,10.9-1.2,15.5c0.2,0.8,0.6,1.5,1,2c0.7,1,1.7,0.8,2.9-0.3c2.6-2.3,4.2-5.3,5.6-8.5
                                                            c2.7-6.6,4.2-13.3,3.5-19.9c-0.3-3.3-1-6.5-3-8.8c-1.5-1.7-0.3-5.7,2.4-7.9c4.9-4.1,8-3.2,9.7,2.4c1.3,5.6,0.4,10.2,0.4,10.7
                                                            c-0.7,6.9-2.5,13.5-5.2,20c-2.5,6-5.3,11.6-9.4,16.4c-1.6,1.9-3.4,3.5-5.2,5.3C130.5,125.1,129.8,125.5,129.1,125.9z M150.4,76.9
                                                            c-0.2-1-0.4-2.7-0.9-4.4c-1.2-4.6-5.2-5.1-8.8-1.1c-1.9,2.2-2.3,4.3-1,5.9c1.7,2.1,2.3,4.9,2.7,7.9c0.6,4.5,0.1,9.1-1.1,13.8
                                                            c-1.4,5.5-3.3,10.8-7,15.2c-2.5,3-4.7,3.7-6.1,0.9c-0.5-1-0.8-2.2-0.9-3.5c-0.2-4.3,0.4-9,1.5-13.7c0.9-4.4,2.1-8.8,3.2-13.4
                                                            c0.6-2.7,0-4.2-2-4c-1.5,0.2-3.1,1.1-4.6,2c-1.4,0.9-2.1,2.6-2.5,4.4c-1.6,6.2-3.1,12.3-5,18.2c-1.5,4.7-3.3,9.3-5.1,13.8
                                                            c-1.1,2.6-2.5,5.1-3.9,7.5c-0.3,0.5-1,0.8-1.5,1.2c-0.1-0.5-0.5-0.9-0.4-1.5c0.8-6.7,1.7-13.7,2.4-20.9c0.4-4.2,0.6-8.5,0.7-12.8
                                                            c0-2.1-1-3.7-2.9-4.1c-3.5-0.8-6.8,0.9-9.9,3.7c-1.3,1.2-2.5,2.7-2.3,4.6c0.1,1.9,1.9,2,3.2,2.3c1.9,0.4,2.7,1.7,2.7,3.8
                                                            c0,1.8,0,3.6-0.2,5.3c-0.6,6.1-1.3,12-2,17.7c-0.4,3.9-0.8,7.7,0.5,10.9c1,2.5,4.6,3.2,7.2,0.6c3.8-3.8,6-8.4,8.5-13
                                                            c1.2-2.3,2.1-4.7,3.2-7.1c0.2-0.5,0.8-1.1,1.2-1.2c0.3-0.1,0.7,0.5,0.8,0.9c0.4,1.3,0.6,2.7,1,4c1.9,5.9,6,6,11.3,1.8
                                                            c3.4-2.6,5.9-6.4,8.2-10.4c2.8-4.8,5-9.9,6.8-15.3C149.2,90.8,150.4,84.3,150.4,76.9z"></path>
                                                    <path fill="#31A36E" d="M150.4,76.9c0.1,7.4-1.2,13.8-3.2,20.2c-1.7,5.4-4,10.5-6.8,15.3c-2.3,4-4.9,7.8-8.2,10.4
                                                            c-5.3,4.1-9.4,4-11.3-1.8c-0.4-1.3-0.6-2.7-1-4c-0.1-0.4-0.5-0.9-0.8-0.9c-0.4,0.1-0.9,0.7-1.2,1.2c-1.1,2.4-2,4.8-3.2,7.1
                                                            c-2.5,4.6-4.7,9.2-8.5,13c-2.6,2.6-6.2,1.9-7.2-0.6c-1.2-3.2-0.9-7-0.5-10.9c0.6-5.7,1.3-11.6,2-17.7c0.2-1.8,0.2-3.6,0.2-5.3
                                                            c0-2-0.8-3.4-2.7-3.8c-1.3-0.3-3-0.3-3.2-2.3c-0.1-1.8,1-3.4,2.3-4.6c3.1-2.8,6.4-4.5,9.9-3.7c1.9,0.4,3,2,2.9,4.1
                                                            c0,4.3-0.3,8.6-0.7,12.8c-0.7,7.2-1.7,14.2-2.4,20.9c-0.1,0.5,0.3,1,0.4,1.5c0.5-0.4,1.2-0.7,1.5-1.2c1.4-2.5,2.9-4.9,3.9-7.5
                                                            c1.9-4.5,3.7-9.1,5.1-13.8c1.8-5.9,3.3-11.9,5-18.2c0.5-1.8,1.1-3.6,2.5-4.4c1.5-0.9,3.1-1.9,4.6-2c2.1-0.3,2.7,1.3,2,4
                                                            c-1.1,4.6-2.2,9-3.2,13.4c-1,4.8-1.7,9.4-1.5,13.7c0.1,1.3,0.4,2.5,0.9,3.5c1.5,2.8,3.6,2.1,6.1-0.9c3.8-4.4,5.6-9.7,7-15.2
                                                            c1.2-4.7,1.7-9.3,1.1-13.8c-0.4-3-1-5.8-2.7-7.9c-1.3-1.6-0.9-3.8,1-5.9c3.6-4,7.6-3.5,8.8,1.1C149.9,74.2,150.2,76,150.4,76.9z"></path>
                                            </g>
                                    </g>
                            </g>
                        </symbol>
                        <symbol id="cauldron-icon" viewBox="0 0 121.1 121.1" enable-background="new 0 0 121.1 121.1" xml:space="preserve">
                            <!-- License:
                                Copyright (c) 2020, 2021 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                            <path fill="none" stroke="currentColor" stroke-width="12" stroke-miterlimit="10" d="M102.4,36.5v60.9c0,9.7-9.1,17.6-20.3,17.6H39.8
                                    c-11.2,0-20.3-7.9-20.3-17.6V36.5"></path>
                            <path d="M83.6,29.9c-2.2,4.4-5.1,7.5-8.6,10.1c-3,2.2-6.2,4-9.8,5.1c-2.9,1-6,1.6-9,0.9c-4.7-1.2-6.9-4.2-5.4-9.2
                                    c0.3-1,0.8-2.1,1.1-3.1c0.1-0.3,0.1-0.9-0.1-1c-0.2-0.2-0.8-0.2-1.1-0.1c-1.5,0.7-3,1.6-4.6,2.1c-3.2,1.1-6.4,2.4-9.9,2.2
                                    c-2.4-0.2-3.8-3-3-5.1c0.9-2.6,2.8-4.5,4.7-6.4c2.7-2.7,5.4-5.3,8.1-8c0.8-0.8,1.5-1.6,2.1-2.5c0.8-1,0.9-2,0.2-3.2
                                    c-0.5-0.8-1.2-1.7-0.6-2.6c0.6-0.9,1.7-1,2.7-0.9c2.4,0.2,4.5,1.1,5.8,3.2c0.7,1.2,0.7,2.4,0,3.4c-1.6,2.1-3.2,4.1-5,6
                                    c-3.2,3.4-6.5,6.6-9.7,9.9c-0.3,0.3-0.3,0.7-0.5,1.1c0.4,0.1,0.9,0.4,1.2,0.3c1.7-0.5,3.5-1,5.1-1.8c2.8-1.4,5.5-2.9,8.1-4.6
                                    c3.1-2.1,6.1-4.4,9.1-6.7c0.9-0.7,1.8-1.2,2.8-0.8c1.1,0.4,2.3,0.8,3.1,1.5c1.2,1,1.1,2.2-0.2,3.2c-2.1,1.8-4.3,3.5-6.4,5.4
                                    c-2.3,2.1-4.4,4.4-6,7.1c-0.5,0.8-0.8,1.8-0.9,2.8c-0.3,2.8,1.2,3.9,3.8,3.7c3.9-0.2,7-2.3,9.9-4.7c2.4-2,4.2-4.5,5.3-7.5
                                    c0.7-1.9,1.3-3.9,0.9-6c-0.3-1.6,0.6-2.5,2.4-2.6c3.3-0.1,5.5,2.5,5,5.8C84.1,28.1,83.8,29.2,83.6,29.9z"></path>
                            <path d="M53.1,64.3c0.4,1.5,0.3,2.9,0.1,4.2c-0.3,1.2-0.7,2.3-1.3,3.3c-0.5,0.9-1.1,1.7-2,2.1c-1.4,0.7-2.6,0.4-3.3-1.1
                                    c-0.1-0.3-0.2-0.7-0.4-1c0-0.1-0.2-0.2-0.2-0.2c-0.1,0-0.2,0.1-0.3,0.2c-0.2,0.5-0.4,1-0.7,1.5c-0.5,0.9-1,1.9-1.9,2.6
                                    c-0.6,0.5-1.5,0.1-1.8-0.6c-0.3-0.8-0.3-1.7-0.2-2.5c0.1-1.2,0.2-2.4,0.3-3.7c0-0.3,0-0.7,0-1.1c0-0.4-0.2-0.7-0.6-0.8
                                    c-0.3-0.1-0.6-0.1-0.7-0.5c0-0.3,0.2-0.6,0.5-0.8c0.6-0.4,1.3-0.7,2.1-0.4c0.4,0.1,0.7,0.4,0.7,0.8c0.1,0.8,0.1,1.7,0,2.5
                                    c-0.1,1.5-0.2,3-0.2,4.4c0,0.1,0.1,0.2,0.1,0.4c0.1-0.1,0.3-0.1,0.4-0.2c0.3-0.5,0.6-1,0.8-1.5c0.4-0.9,0.7-1.9,1-2.8
                                    c0.3-1.2,0.5-2.3,0.8-3.5c0.1-0.3,0.2-0.7,0.5-0.8c0.3-0.1,0.7-0.3,1.1-0.3c0.5,0,0.7,0.3,0.6,0.8c-0.1,0.9-0.3,1.8-0.4,2.6
                                    c-0.1,1-0.1,2,0,3c0.1,0.3,0.2,0.6,0.4,0.9c0.5,0.7,1.1,0.7,1.7,0.1c0.9-0.9,1.2-2,1.4-3.2c0.1-1,0.1-2-0.3-2.9
                                    c-0.2-0.6-0.5-1.2-1-1.6c-0.4-0.3-0.4-0.7,0-1.1c0.8-0.7,1.9-0.6,2.4,0.3C52.9,63.8,53,64.1,53.1,64.3z"></path>
                            <path d="M46.9,88.1c0.1,1.6-0.1,2.9-0.6,4.2c-0.4,1.1-1,2.1-1.8,3.1c-0.6,0.8-1.4,1.5-2.3,1.8c-1.5,0.5-2.6,0-3.1-1.6
                                    c-0.1-0.3-0.1-0.7-0.2-1c0-0.1-0.1-0.3-0.2-0.3c-0.1,0-0.2,0.1-0.3,0.2c-0.3,0.4-0.5,0.9-0.9,1.4c-0.7,0.9-1.3,1.7-2.3,2.3
                                    c-0.7,0.4-1.5-0.2-1.7-0.9c-0.2-0.9,0-1.7,0.2-2.5c0.3-1.2,0.6-2.4,0.8-3.6c0.1-0.3,0.1-0.7,0.1-1c0-0.4-0.1-0.7-0.5-0.9
                                    c-0.3-0.1-0.6-0.2-0.6-0.6c0-0.3,0.3-0.6,0.6-0.7c0.7-0.3,1.4-0.5,2.1-0.1c0.4,0.2,0.6,0.5,0.6,0.9c-0.1,0.8-0.2,1.7-0.3,2.5
                                    c-0.3,1.5-0.6,2.9-0.9,4.3c0,0.1,0,0.3,0.1,0.4c0.1,0,0.3,0,0.4-0.1c0.4-0.4,0.8-0.9,1.1-1.4c0.5-0.8,1-1.7,1.4-2.6
                                    c0.5-1.1,0.9-2.2,1.3-3.4c0.1-0.3,0.3-0.6,0.6-0.7c0.4-0.1,0.7-0.2,1.1-0.1c0.5,0.1,0.7,0.4,0.5,0.9c-0.3,0.9-0.6,1.7-0.8,2.6
                                    C41,92,40.8,93,40.9,94c0,0.3,0.1,0.6,0.2,0.9c0.4,0.8,1,0.8,1.7,0.4c1-0.7,1.5-1.8,1.9-3c0.3-1,0.4-1.9,0.2-2.9
                                    c-0.1-0.6-0.3-1.3-0.8-1.8c-0.4-0.4-0.3-0.8,0.2-1.1c0.9-0.6,1.9-0.3,2.3,0.7C46.7,87.6,46.8,87.9,46.9,88.1z"></path>
                            <path d="M67.2,84.2c-0.2,1.6-0.7,2.8-1.4,4c-0.6,1-1.4,1.9-2.4,2.6c-0.8,0.6-1.6,1.2-2.6,1.3c-1.6,0.2-2.6-0.5-2.7-2.2
                                    c0-0.4,0-0.7,0-1.1c0-0.1-0.1-0.3-0.1-0.3c-0.1,0-0.3,0-0.3,0.1c-0.4,0.4-0.7,0.8-1.1,1.2c-0.8,0.7-1.6,1.4-2.7,1.8
                                    c-0.7,0.2-1.5-0.5-1.5-1.2c0-0.9,0.3-1.7,0.7-2.4c0.5-1.1,1-2.2,1.5-3.3c0.1-0.3,0.3-0.7,0.4-1c0.1-0.4,0-0.7-0.3-1
                                    c-0.2-0.2-0.6-0.4-0.5-0.7c0.1-0.3,0.4-0.5,0.7-0.6c0.7-0.2,1.5-0.2,2.1,0.3c0.4,0.3,0.5,0.6,0.4,1c-0.2,0.8-0.5,1.6-0.8,2.4
                                    c-0.6,1.4-1.2,2.7-1.8,4.1c0,0.1,0,0.3,0,0.4c0.1,0,0.3,0,0.4-0.1c0.5-0.4,0.9-0.7,1.3-1.1c0.7-0.7,1.3-1.5,1.9-2.3c0.7-1,1.3-2,2-3
                                    c0.2-0.3,0.4-0.6,0.7-0.6c0.4,0,0.8,0,1.1,0.1c0.5,0.2,0.6,0.5,0.3,1c-0.4,0.8-0.9,1.5-1.3,2.3c-0.5,0.9-0.8,1.8-1,2.8
                                    c0,0.3,0,0.6,0,0.9c0.2,0.9,0.8,1,1.6,0.7c1.2-0.5,1.8-1.5,2.4-2.5c0.5-0.9,0.8-1.8,0.8-2.8c0-0.7-0.1-1.3-0.4-1.9
                                    c-0.3-0.5-0.1-0.8,0.4-1c1-0.4,2,0.1,2.1,1.2C67.2,83.6,67.2,84,67.2,84.2z"></path>
                            <path d="M84.3,82.9c0.8,1.3,1.2,2.6,1.4,4c0.1,1.2,0.1,2.4-0.2,3.5c-0.2,1-0.5,1.9-1.3,2.6c-1.1,1.1-2.3,1.2-3.4,0
                                    c-0.2-0.3-0.4-0.6-0.7-0.8c-0.1-0.1-0.2-0.2-0.3-0.2c-0.1,0-0.2,0.2-0.2,0.3c-0.1,0.5-0.1,1.1-0.2,1.6c-0.2,1.1-0.4,2.2-1,3.1
                                    c-0.4,0.6-1.4,0.5-1.9,0c-0.6-0.7-0.8-1.5-1-2.3c-0.3-1.2-0.6-2.4-0.9-3.6c-0.1-0.3-0.2-0.7-0.3-1c-0.1-0.4-0.4-0.6-0.8-0.6
                                    c-0.3,0-0.7,0.1-0.8-0.3c-0.1-0.3,0-0.6,0.2-0.9c0.5-0.6,1-1,1.8-1.1c0.4,0,0.8,0.2,0.9,0.6c0.3,0.8,0.6,1.6,0.8,2.4
                                    c0.4,1.4,0.8,2.9,1.1,4.3c0,0.1,0.2,0.2,0.2,0.3c0.1-0.1,0.3-0.2,0.3-0.3c0.1-0.6,0.3-1.1,0.3-1.7c0.1-1,0.1-2,0.1-3
                                    c-0.1-1.2-0.2-2.4-0.3-3.6c0-0.3,0-0.7,0.2-0.9c0.3-0.2,0.6-0.5,0.9-0.6c0.5-0.2,0.8,0.1,0.9,0.6c0.1,0.9,0.3,1.8,0.4,2.6
                                    c0.2,1,0.5,1.9,1,2.8c0.1,0.3,0.4,0.5,0.6,0.7c0.7,0.5,1.3,0.3,1.7-0.4c0.6-1.1,0.5-2.3,0.3-3.5c-0.2-1-0.5-1.9-1.2-2.7
                                    c-0.4-0.5-0.8-1-1.5-1.2c-0.5-0.2-0.6-0.6-0.3-1.1c0.5-0.9,1.6-1.1,2.4-0.4C83.9,82.5,84.2,82.7,84.3,82.9z"></path>
                            <path d="M80.8,69.5c-0.4,1.5-1.2,2.7-2.1,3.7c-0.8,0.9-1.7,1.6-2.8,2.2c-0.9,0.5-1.8,0.9-2.8,0.8c-1.6-0.1-2.4-0.9-2.3-2.6
                                    c0-0.3,0.1-0.7,0.2-1c0-0.1,0-0.3-0.1-0.3c-0.1,0-0.3,0-0.3,0c-0.4,0.3-0.9,0.7-1.3,0.9c-0.9,0.5-1.9,1.1-3,1.3
                                    c-0.8,0.1-1.4-0.7-1.3-1.4c0.1-0.9,0.6-1.6,1.1-2.3c0.7-1,1.4-2,2.1-3c0.2-0.3,0.4-0.6,0.5-0.9c0.2-0.4,0.2-0.7-0.1-1
                                    c-0.2-0.2-0.5-0.4-0.3-0.8c0.1-0.3,0.5-0.4,0.8-0.4c0.8-0.1,1.5,0.1,2,0.7c0.3,0.3,0.4,0.7,0.2,1.1c-0.4,0.7-0.8,1.5-1.2,2.2
                                    c-0.8,1.2-1.6,2.5-2.5,3.7c-0.1,0.1-0.1,0.2-0.1,0.4c0.1,0,0.3,0.1,0.4,0c0.5-0.3,1-0.5,1.5-0.9c0.8-0.6,1.6-1.2,2.3-1.9
                                    c0.9-0.8,1.7-1.8,2.5-2.6c0.2-0.3,0.5-0.5,0.8-0.4c0.4,0,0.8,0.1,1.1,0.3c0.4,0.3,0.5,0.6,0.1,1c-0.6,0.7-1.1,1.4-1.7,2.1
                                    c-0.6,0.8-1.1,1.6-1.5,2.6c-0.1,0.3-0.1,0.6-0.1,0.9c0.1,0.9,0.6,1.1,1.4,0.9c1.2-0.3,2.1-1.1,2.8-2.1c0.6-0.8,1.1-1.7,1.2-2.7
                                    c0.1-0.6,0.2-1.3-0.1-1.9c-0.2-0.5,0-0.8,0.6-0.9c1-0.2,1.9,0.5,1.9,1.5C80.8,68.9,80.8,69.3,80.8,69.5z"></path>
                            <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M24,55.9c0,0,9.5-4,16-4s12.7,4,20.9,4
                                    S75.5,52,82.1,52s16,3.9,16,3.9"></path>
                            <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M32.2,25.1C24,15.3,12.7,14.7,12.7,14.7"></path>
                            <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M36.2,19.1C24.5,7.8,12.7,7.8,12.7,7.8"></path>
                            <path fill="none" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" d="M40.2,13.1C28.8,1,12.7,1,12.7,1"></path>
                        </symbol>
                        <symbol id="varv-icon" viewBox="0 0 567 567">
                            <!-- License:
                                Copyright (c) 2022 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                            <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="50" d="M39 56h503M6 147h503M95 238h472M26 329h416M1 420h503M39 511h485"></path>
                        </symbol>
                        <symbol id="codestrates-icon" viewBox="0 0 567 567">
                            <!-- License:
                                Copyright (c) 2022 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                            <ellipse cx="283.5" cy="250.8" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" rx="270.1" ry="86.3"></ellipse><ellipse cx="283.5" cy="316.2" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" rx="270.1" ry="86.3"></ellipse><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 251v65M554 251v65"></path><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="9" d="m262 308-25-25 25-25M305 258l26 25-26 25M291 249l-15 69"></path>
                        </symbol>
                        <symbol id="components-icon" viewBox="0 0 567 567">
                            <!-- License:
                                Copyright (c) 2022 Jonas Oxenbll Petersen, CAVI - Center for Advanced Visualization and Interaction, Aarhus University
                                Distributed under Creative Commons Attribution 4.0 (CC-BY-4.0)
                            -->
                            <path fill="currentColor" d="M335 410c-1 13-4 23-9 33-5 8-11 16-18 23-6 5-12 10-20 11-13 3-21-2-23-16l-1-8-1-3-3 1-8 10c-6 6-13 13-21 16-6 2-12-3-13-9 0-7 2-13 4-20l11-27 2-9c1-3 0-5-3-7-2-2-4-3-4-6 1-3 3-4 6-5 5-2 11-2 17 2 3 2 4 5 3 8l-5 19-12 34v3l3-1 10-9 14-20 14-25c2-3 3-5 6-5h9c4 1 5 4 3 8l-9 19c-3 8-6 15-7 23l1 8c2 7 7 8 13 5 9-5 14-13 18-22 4-8 5-15 5-23-1-6-1-11-4-16-3-3-2-6 3-8 7-4 15 0 17 8l2 8z"></path><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 364h541v144H13zM80 326h100v38H80zM385 326h100v38H385z"></path><path fill="currentColor" d="M335 144c-1 13-4 24-9 33s-11 16-18 23c-6 5-12 10-20 12-13 2-21-3-23-16l-1-9-1-2c-1-1-2 0-3 1l-8 9c-6 7-13 13-21 16-6 3-12-3-13-8 0-8 2-14 4-21l11-27 2-8c1-3 0-6-3-8-2-1-4-3-4-6 1-2 3-4 6-5 5-2 11-2 17 2 3 2 4 5 3 8l-5 20-12 33v3h3l10-10 14-19 14-26c2-2 3-5 6-5h9c4 1 5 4 3 8l-9 20c-3 7-6 15-7 23l1 7c2 7 7 8 13 5 9-5 14-13 18-22 4-7 5-15 5-23-1-6-1-11-4-15s-2-7 3-9c7-4 15 0 17 8l2 8z"></path><path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="20" d="M13 98h541v144H13zM80 60h100v38H80zM385 60h100v38H385z"></path>
                        </symbol>
                    </svg></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="MaterialDesignOutlinedIcons" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Icons based on the outlined Material Design icon set",
                        "description": "Various icons from Material Design",
                        "dependencies": [
                            "#wsc-icon-registry",
                            "wpm_js_libs #material-design-icons"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "changelog": {
                            "0.1": "Initial version"
                        },
                        "license": "Apache 2.0"
                    }

                    </SCRIPT><SCRIPT id="material-design-outlined-icon-provider-script" type="disabled">
                    /**
                     *  MaterialDesignOutlinedIconProvider
                     *  A provider for registering material icons
                     *
                     *  Copyright 2020, 2021, 2024 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A provider for registering material icons in the outlined variation
                     */
                    window.MaterialDesignOutlinedIconProvider = class MaterialDesignOutlinedIconProvider {
                        provides(iconIdentifier){
                            return iconIdentifier.startsWith("mdc:");
                        }

                        /**
                         * Create a MaterialDesign icon
                         * @param {String} iconIdentifier - The id of the icon
                         * @returns {HTMLSpanElement} - The created icon
                         */
                        createIcon(iconIdentifier) {
                            let iconName = iconIdentifier.slice(4);

                            let icon = document.createElement("span");
                            icon.classList.add("material-icons-outlined");
                            icon.textContent = iconName;
                            return icon;
                        }
                    };

                    IconRegistry.registerProvider(new MaterialDesignOutlinedIconProvider());

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="MenuSystem" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "MenuSystem",
                        "description": "A system to dynamically register into a menu structure and present it visually",
                        "dependencies": [
                            "WebstrateComponents_Tools"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="MenuSystem-script" type="disabled">
                    /**
                     *  MenuSystem
                     *  A system to dynamically register into a menu structure and present it visually
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * @namespace MenuSystem
                     */
                    window.MenuSystem = {};

                    /**
                     * @typedef {Object} MenuSystem~Point
                     * @property {Number} x
                     * @property {Number} y
                     */

                    /**
                     * @typedef {Object} MenuSystem.Menu~menuConfig
                     * @property {MenuSystem.MenuBuilder} [builder=null] - The MenuBuilder to use when instanciating the Menu, if null the DefaultBuilder will be used instead.
                     * @property {*} [context=null] - The context of this Menu
                     * @property {Boolean} [keepOpen=false] - Should the Menu stay open when clicked
                     * @property {Boolean} [groupDividers=false] - Should group dividers be visible
                     * @property {function} [onOpen] - Called when the Menu is opened
                     * @property {function} [onClose] - Called when the Menu is closed
                     */

                    /**
                     * @typedef {Object} MenuSystem.MenuItem~menuItemConfig
                     * @property {String} [label] - The label of this MenuItem
                     * @property {*} [icon] - The icon of this MenuItem
                     * @property {Number} [order=99999] - The order of this MenuItem
                     * @property {function} [onAction] - The callback to call when this MenuItem has its action triggered
                     * @property {function} [onOpen] - Called when the Menu this MenuItem belongs to is about to open. If false is returned, this MenuItem will not be shown.
                     * @property {MenuSystem.Menu} [submenu=null] - A submenu to open when clicking this MenuItem
                     * @property {boolean} [submenuOnHover=true] - Determines if this MenuItem's submenu should open on hover
                     * @property {String} [group] - The group this MenuItem should belong too
                     * @property {Number} [groupOrder=99999] - If this MenuItem is part of a group, this is the order the group should have. (The lowest order of all members is choosen)
                     */

                    /**
                     * MenuManager is used to interact with menus in MenuSystem
                     * @hideconstructor
                     * @memberof MenuSystem
                     */
                    MenuSystem.MenuManager = class MenuManager {
                        /**
                         * Registers a new MenuItem for the given named menu. MenuItem's can be registered both before and after the menu is created.
                         * @param {String} menuName - The name of the menu to register this MenuItem for
                         * @param {MenuSystem.MenuItem~menuItemConfig} menuItemConfig - The configuration for this MenuItem
                         *
                         * @returns {Object} - Delete object, with a single method delete(), that removes this menuItemConfig and all menuitems associated with it
                         *
                         * @example
                         * MenuSystem.MenuManager.registerMenuItem("MyMenu", {
                         *     label: "MyMenuItem",
                         *     order: 10.
                         *     onAction: ()=>{console.log("MyMenuItem clicked!");}
                         *     onOpen: ()=>{return true;}
                         * });
                         */
                        static registerMenuItem(menuName, menuItemConfig) {
                            menuItemConfig._allMenuItems = new Set();

                            //Register this MenuItem in the set
                            let menuItemSet = MenuSystem.MenuManager.menuItemMap.get(menuName);
                            if(menuItemSet == null) {
                                menuItemSet = new Set();
                                MenuSystem.MenuManager.menuItemMap.set(menuName, menuItemSet);
                            }
                            menuItemSet.add(menuItemConfig);

                            //Add MenuItem to all menus already created
                            let menuArray = MenuSystem.MenuManager.menuMap.get(menuName);
                            if(menuArray != null) {
                                menuArray.forEach((menu)=>{
                                    menuItemConfig._allMenuItems.add(menu.addItem(menuItemConfig));
                                });
                            }

                            return {
                                delete: ()=>{
                                    menuItemSet.delete(menuItemConfig);

                                    menuItemConfig._allMenuItems.forEach((menuItem)=>{
                                        menuItem.menu.removeItem(menuItem);
                                    });
                                }
                            }
                        }

                        /**
                         * Create a new menu
                         * @param {String} menuName - The name of the Menu
                         * @param {MenuSystem.Menu~menuConfig} [menuConfig] - The configuration of the Menu
                         * @return {MenuSystem.Menu} - The created menu
                         *
                         * @example
                         * MenuSystem.MenuManager.createMenu("MyMenu", {
                         *     context: myContext,
                         *     builder: MenuSystem.MyLovelyMenuBuilder
                         *     keepOpen: false,
                         *     onOpen: ()=>{console.log("MyMenu was opened!")},
                         *     onClose: ()=>{console.log("MyMenu was closed!")},
                         * });
                         */
                        static createMenu(menuName, menuConfig = {}) {

                            if(menuConfig.builder == null) {
                                if(MenuSystem.MenuManager.defaultBuilder == null) {
                                    throw "Attempt to create Menu with defaultBuilder but no default builder is set!";
                                }

                                menuConfig.builder = MenuSystem.MenuManager.defaultBuilder;
                            }

                            //Build Menu
                            let menu = new MenuSystem.Menu(menuConfig);

                            //Add it to our map of named menus
                            let menuArray = MenuSystem.MenuManager.menuMap.get(menuName);
                            if(menuArray == null) {
                                menuArray = [];
                                MenuSystem.MenuManager.menuMap.set(menuName, menuArray);
                            }
                            menuArray.push(menu);

                            //Add all registered menuItems
                            let menuItemSet = MenuSystem.MenuManager.menuItemMap.get(menuName);
                            if(menuItemSet != null) {
                                menuItemSet.forEach((itemConfig)=>{
                                    itemConfig._allMenuItems.add(menu.addItem(itemConfig));
                                });
                            }

                            return menu;
                        }

                        static setDefaultBuilder(builder) {
                            MenuSystem.MenuManager.defaultBuilder = builder;
                        }
                    };
                    MenuSystem.MenuManager.menuItemMap = new Map();
                    MenuSystem.MenuManager.menuItemDeleterMap = new Map();
                    MenuSystem.MenuManager.menuMap = new Map();
                    MenuSystem.MenuManager.defaultBuilder = null;

                    /**
                     * MenuBuilder is used to build concrete instances of Menu's
                     */
                    MenuSystem.MenuBuilder = class MenuBuilder {
                        /**
                         * Construct the HTML code for the given Menu
                         * @param {MenuSystem.Menu} menu
                         */
                        static buildMenuHtml(menu) {
                            //Override in subclass
                            throw "Remember to override buildMenuHtml()";
                        }

                        /**
                         * Construct the HTML code for the given MenuItem
                         * @param {MenuSystem.MenuItem} menuItem
                         */
                        static buildMenuItemHtml(menuItem) {
                            //Override in subclass
                            throw "Remember to override buildMenuItemHtml()";
                        }

                        /**
                         * Clear all MenuItem's from the given Menu
                         * @param {MenuSystem.Menu} menu
                         */
                        static clearMenuItems(menu) {
                            //Override in subclass
                            throw "Remember to override clearMenuItems()";
                        }

                        /**
                         * Attach the given MenuItem's to the given Menu
                         * @param {MenuSystem.Menu} menu
                         * @param {MenuSystem.MenuItem[][]} groups - Array of MenuItem arrays, where each outer array is a grouping of MenuItems
                         */
                        static attachMenuItems(menu, menuItems) {
                            //Override in subclass
                            throw "Remember to override attachMenuItems()";
                        }

                        /**
                         * Opens the given Menu
                         *
                         * The source parameter tells where the open event originated from, which can be a Element, or a 2D point
                         * @param {MenuSystem.Menu} menu - The Menu to open
                         * @param {Element|MenuSystem~Point} source - The source of the open event
                         */
                        static open(menu, source) {
                            //Override in subclass
                            throw "Remember to override open()";
                        }

                        /**
                         * Closes the given Menu
                         * @param {MenuSystem.Menu} menu
                         */
                        static close(menu) {
                            //Override in subclass
                            throw "Remember to override close()";
                        }

                        /**
                         * Destroy the given Menu
                         * @param {MenuSystem.Menu} menu
                         */
                        static destroyMenu(menu) {
                            //Override in subclass
                            throw "Remember to override destroyMenu()";
                        }

                        /**
                         * Destroy the given MenuItem
                         * @param {MenuSystem.MenuItem} menuItem
                         */
                        static destroyMenuItem(menuItem) {
                            //Override in subclass
                            throw "Remember to override destroyMenuItem()";
                        }

                        /**
                         * Create an icon that represents a submenu
                         */
                        static createSubmenuIcon() {
                            //Override in subclass
                            throw "Remember to override createSubmenuIcon()";
                        }
                    };

                    /**
                     * Represents a Menu in the MenuSystem
                     */
                    MenuSystem.Menu = class Menu {
                        /**
                         * Construct a new Menu
                         * @param {MenuSystem.Menu~menuConfig} [options] - The options to use for this menu
                         */
                        constructor(options) {
                            this.options = options;

                            this.context = WebstrateComponents.Tools.fromConfig(options, "context", null);
                            this.builder = WebstrateComponents.Tools.fromConfig(options, "builder", null);

                            this.keepOpen = WebstrateComponents.Tools.fromConfig(options, "keepOpen", false);

                            this.groupDividers = WebstrateComponents.Tools.fromConfig(options, "groupDividers", false);

                            this.growDirection = WebstrateComponents.Tools.fromConfig(options, "growDirection", MenuSystem.Menu.GrowDirection.RIGHT);
                            this.layoutDirection = WebstrateComponents.Tools.fromConfig(options, "layoutDirection", MenuSystem.Menu.LayoutDirection.VERTICAL);
                            this.layoutWrapping = WebstrateComponents.Tools.fromConfig(options, "layoutWrapping", true);
                            this.layoutCompact = WebstrateComponents.Tools.fromConfig(options, "layoutCompact", false);
                            this.defaultFocus = WebstrateComponents.Tools.fromConfig(options, "defaultFocus", true);

                            this.onOpen = new Set();
                            let openCallback = WebstrateComponents.Tools.fromConfig(options, "onOpen");
                            if(openCallback != null) {
                                this.onOpen.add(openCallback);
                            }

                            this.onClose = new Set();
                            let closeCallback = WebstrateComponents.Tools.fromConfig(options, "onClose");
                            if(closeCallback != null) {
                                this.onClose.add(closeCallback);
                            }

                            this.menuItems = [];

                            this.isOpen = false;
                            this.currentSubmenu = null;

                            /** @member {Element} - The DOM Element of this Menu */
                            this.html = this.builder.buildMenuHtml(this);
                            this.html.menu = this;
                            this.html.classList.add("menusystem-menu");

                            let self = this;

                            this.html.addEventListener("contextmenu", (evt)=>{
                                evt.preventDefault();
                            });

                            this.bodyClickHandler = function(evt) {
                                self.handleBodyClick(evt);
                            }

                            if(this.keepOpen) {
                                this.open();
                            }
                        }

                        /**
                         * Register a callback to be called when this Menu opens
                         * @param {Function} callback
                         */
                        registerOnOpenCallback(callback) {
                            this.onOpen.add(callback);
                        }

                        /**
                         * Deregister a callback to be called when this Menu opens
                         * @param {Function} callback
                         */
                        deregisterOnOpenCallback(callback) {
                            this.onOpen.delete(callback);
                        }

                        /**
                         * Register a callback to be called when this Menu closes
                         * @param {Function} callback
                         */
                        registerOnCloseCallback(callback) {
                            this.onClose.add(callback);
                        }

                        /**
                         * Deregister a callback to be called when this Menu closes
                         * @param {Function} callback
                         */
                        deregisterOnCloseCallback(callback) {
                            this.onClose.delete(callback);
                        }

                        /**
                         * Add a MenuItem to this Menu
                         * @param {MenuSystem.MenuItem~menuItemConfig} itemConfig
                         * @return {MenuSystem.MenuItem} - The added item
                         */
                        addItem(itemConfig) {
                            let menuItem = new MenuSystem.MenuItem(this.builder, this, itemConfig);
                            this.menuItems.push(menuItem);

                            this.checkUpdate();

                            return menuItem;
                        }

                        /**
                         * Remove a MenuItem from this Menu
                         * @param {MenuSystem.MenuItem} menuItem - The menu item to remove
                         */
                        removeItem(menuItem) {
                            this.menuItems.splice(this.menuItems.indexOf(menuItem), 1);

                            this.checkUpdate();
                        }

                        /**
                         * Opens this Menu
                         * @param {Element|MenuSystem~Point} [source] - Some notion of the source that openend the Menu, could be a Element or a Point
                         */
                        open(source = null) {
                            let self = this;

                            if(this.closeTimeoutId != null) {
                                clearTimeout(this.closeTimeoutId);
                                this.closeTimeoutId = null;
                            }

                            let numItems = this.update();

                            if(numItems === 0 && !this.keepOpen) {
                                return;
                            }

                            this.builder.open(this, source);

                            this.isOpen = true;

                            setTimeout(()=>{
                                window.addEventListener("mouseup", self.bodyClickHandler, {
                                    capture: true
                                });
                            }, 0);

                            this.triggerOnOpen();
                        }

                        checkUpdate() {
                            if(this.isOpen) {
                                let numItems = this.update();

                                if(numItems === 0 && !this.keepOpen) {
                                    this.close();
                                }
                            }
                        }

                        /**
                         * Updates the MenuItems in this menu.
                         * @returns {number} - The number of items in the menu
                         */
                        update() {
                            let self = this;

                            this.builder.clearMenuItems(this);

                            let groupMap = new Map();

                            //Filter menu items
                            let filteredMenuItems = this.menuItems.filter((item)=>{
                                try {
                                    return item.onOpen(self, item);
                                } catch (ex){
                                    console.warn("MenuSystem: Menu entry caused an exception while evaluating visibility, dropping: ", item, ex);
                                    return false;
                                }
                            });

                            //Group items
                            filteredMenuItems.forEach((item)=>{
                                let group = groupMap.get(item.group);
                                if(group == null) {
                                    group = [];
                                    groupMap.set(item.group, group);
                                }

                                group.push(item);
                            });

                            let groupArrays = Array.from(groupMap.values());

                            //Sort Groups
                            groupArrays.sort((g1, g2)=>{
                                let g1MinGroupOrder = 99999999999;
                                let g2MinGroupOrder = 99999999999;

                                g1.forEach((item)=>{
                                    g1MinGroupOrder = Math.min(g1MinGroupOrder, item.groupOrder);
                                });
                                g2.forEach((item)=>{
                                    g2MinGroupOrder = Math.min(g2MinGroupOrder, item.groupOrder);
                                });

                                return g1MinGroupOrder - g2MinGroupOrder;
                            });

                            //Sort items in each group
                            groupArrays.forEach((group)=>{
                                group.sort((i1, i2) => {
                                    return i1.order - i2.order;
                                });
                            });

                            this.builder.attachMenuItems(this, groupArrays);

                            return filteredMenuItems.length;
                        }

                        /**
                         * Close this Menu
                         */
                        close() {
                            if(!this.isOpen) {
                                return;
                            }

                            this.builder.close(this);

                            this.isOpen = false;

                            window.removeEventListener("mouseup", this.bodyClickHandler, {
                                capture: true
                            });

                            this.triggerOnClose();
                        }

                        /**
                         * Destroy this menu
                         */
                        destroy() {
                            this.menuItems.forEach((item)=>{
                                item.destroy();
                            });

                            this.builder.destroyMenu(this);
                        }

                        /**
                         * Trigger the onOpen callback attached to this Menu
                         * @private
                         */
                        triggerOnOpen() {
                            let self = this;
                            this.onOpen.forEach((callback)=>{
                                if(typeof callback === "function") {
                                    try {
                                        callback(self);
                                    } catch(e) {
                                        console.error("Error inside onOpen:", e);
                                    }
                                }
                            });
                        }

                        /**
                         * Trigger the onClose callback attached to this Menu
                         * @private
                         */
                        triggerOnClose() {
                            let self = this;
                            this.onClose.forEach((callback)=>{
                                if(typeof callback === "function") {
                                    try {
                                        callback(self);
                                    } catch(e) {
                                        console.error("Error inside onClose:", e);
                                    }
                                }
                            });
                        }

                        /**
                         * Closes all submenus except on the given MenuItem
                         * @param {MenuSystem.MenuItem} menuItem
                         */
                        closeAllOtherSubmenus(menuItem) {
                            this.menuItems.forEach((item)=>{
                                if(item != menuItem && item.submenu != null && item.submenu.isOpen) {
                                    item.toggleSubmenu();
                                }
                            });
                        }

                        /**
                         * Signals to this Menu that the given MenuItem has been triggered
                         * @private
                         * @param {MenuSystem.MenuItem} menuItem
                         */
                        handleItemAction(menuItem) {
                            menuItem.triggerOnAction();

                            if(!this.keepOpen && menuItem.submenu == null) {
                                this.close();
                            }
                        }

                        /**
                         * Handles clicks to the document, to check if we should close if clicked outside
                         * @private
                         * @param {MouseEvent} evt
                         */
                        handleBodyClick(evt) {
                            let self = this;

                            if(!WebstrateComponents.Tools.isInsideElement(this.html, evt.target)) {
                                this.closeTimeoutId = setTimeout(()=>{
                                    this.closeTimeoutId = null;

                                    let shouldClose = !self.keepOpen && self.currentSubmenu == null;

                                    if(shouldClose) {
                                        self.close();
                                    }
                                }, 0);
                            }
                        }
                    };

                    MenuSystem.Menu.GrowDirection = {
                        RIGHT: "right",
                        DOWN: "down"
                    };
                    MenuSystem.Menu.LayoutDirection = {
                        HORIZONTAL: "horizontal",
                        VERTICAL: "vertical"
                    };

                    /**
                     * Represents a MenuItem in the MenuSystem
                     */
                    MenuSystem.MenuItem = class MenuItem {
                        /**
                         * Construct a new MenuItem
                         * @param {MenuSystem.MenuBuilder} builder
                         * @param {MenuSystem.Menu} menu
                         * @param {MenuSystem.MenuItem~menuItemConfig} config
                         */
                        constructor(builder, menu, config) {
                            let self = this;

                            this.builder = builder;
                            this.config = config;
                            this.menu = menu;

                            this.order = WebstrateComponents.Tools.fromConfig(config, "order", 99999);
                            this.icon = WebstrateComponents.Tools.fromConfig(config, "icon", null);
                            this.metaIcon = WebstrateComponents.Tools.fromConfig(config, "metaIcon", null);
                            this.label = WebstrateComponents.Tools.fromConfig(config, "label", null);
                            this.tooltip = WebstrateComponents.Tools.fromConfig(config, "tooltip", null);
                            this.onAction = WebstrateComponents.Tools.fromConfig(config, "onAction", ()=>{});
                            this.onOpen = WebstrateComponents.Tools.fromConfig(config, "onOpen", ()=>{return true;});
                            this.submenuOnHover = WebstrateComponents.Tools.fromConfig(config, "submenuOnHover", true);
                            this.group = WebstrateComponents.Tools.fromConfig(config, "group", null);
                            this.groupOrder = WebstrateComponents.Tools.fromConfig(config, "groupOrder", 99999);
                            this.class = WebstrateComponents.Tools.fromConfig(config, "class", null);
                            this.checked = WebstrateComponents.Tools.fromConfig(config, "checked", null);

                            this.submenu = WebstrateComponents.Tools.fromConfig(config, "submenu", null);

                            if(this.submenu != null && this.metaIcon == null) {
                                this.metaIcon = this.builder.createSubmenuIcon();
                            }

                            /** @member {Element} - The DOM Element of this MenuItem */
                            this.html = builder.buildMenuItemHtml(this);

                            if(this.class != null) {
                                this.html.classList.add(this.class.split(" "));
                            }

                            this.submenuCloseHandler = () => {
                                if(self.menu.currentSubmenu === self.submenu) {
                                    if(!self.menu.keepOpen) {
                                        self.menu.close();
                                    }
                                    self.menu.currentSubmenu = null;
                                }
                            }

                            this.menuCloseHandler = () => {
                                if(self.menu.currentSubmenu === self.submenu) {
                                    self.menu.currentSubmenu = null;
                                    self.submenu.close();
                                }
                            }

                            this.setupSubmenuHover();
                        }

                        get active() {
                            return this.html.classList.contains("MenuSystem_MenuItem_Active");
                        }

                        set active(active) {
                            this.builder.setItemActive(this, active);
                        }

                        /**
                         * Trigger the onAction callback of this MenuItem
                         * @private
                         */
                        triggerOnAction() {
                            let self = this;

                            if(typeof this.onAction === "function") {
                                this.onAction(this);
                            }

                            if(this.submenu != null) {
                                this.toggleSubmenu();
                            }
                        }

                        /**
                         * Toggles the submenu of this MenuItem, undefined behaviour if this MenuItem is not currently showing in a menu
                         * @private
                         */
                        toggleSubmenu() {
                            if(this.submenu == null) {
                                throw "Tried to toggle submenu on a menuitem that has no submenu!";
                            }

                            //Find top component after html
                            let parent = this.html;
                            while(parent.parentNode != null && !parent.parentNode.matches("html")) {
                                parent = parent.parentNode;
                            }

                            parent.appendChild(this.submenu.html);

                            if(this.submenu.isOpen) {
                                this.menu.deregisterOnCloseCallback(this.menuCloseHandler);
                                this.submenu.deregisterOnCloseCallback(this.submenuCloseHandler);
                                this.submenu.close();
                                this.submenu.superMenu = null;
                                this.menu.currentSubmenu = null;
                            } else {
                                this.submenu.open(this.html);
                                this.submenu.superMenu = this.menu;
                                this.menu.currentSubmenu = this.submenu;
                                this.submenu.registerOnCloseCallback(this.submenuCloseHandler);
                                this.menu.registerOnCloseCallback(this.menuCloseHandler);
                            }
                        }

                        /**
                         * Destroys this MenuItem
                         */
                        destroy() {
                            this.builder.destroyMenuItem(this);
                        }

                        /**
                         * @private
                         */
                        setupSubmenuHover() {
                            let self = this;

                            let submenuHoverTimerId = null;

                            this.html.addEventListener("mouseenter", (evt)=>{
                                //Close all other submenus from our Menu
                                self.menu.closeAllOtherSubmenus(self);

                                if(this.submenuOnHover && this.submenu != null && !this.submenu.isOpen) {
                                    self.toggleSubmenu();
                                }
                            });

                            this.html.addEventListener("mouseleave", (evt)=>{
                                let newTarget = document.elementFromPoint(evt.pageX, evt.pageY);

                                let menuItemRect = self.html.getBoundingClientRect();
                                let submenuRect = null;

                                if(this.submenu?.html != null) {
                                    submenuRect = self.submenu.html.getBoundingClientRect();

                                    let boxBetween = {
                                        xMin: menuItemRect.x+menuItemRect.width - 5,
                                        xMax: submenuRect.x + 5,
                                        yMin: Math.min(submenuRect.y-5, menuItemRect.y - 5),
                                        yMax: Math.max(submenuRect.y+submenuRect.height + 5, menuItemRect.y+menuItemRect.height + 5)
                                    }

                                    if(evt.pageX > boxBetween.xMin && evt.pageX < boxBetween.xMax && evt.pageY < boxBetween.yMax && evt.pageY > boxBetween.yMin) {
                                        return;
                                    }
                                }

                                if(self.submenuOnHover && self.submenu != null && self.submenu.isOpen && !WebstrateComponents.Tools.isInsideElement(self.submenu.html, newTarget)) {
                                    self.toggleSubmenu();
                                }
                            });
                        }
                    };

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="PermissionManager" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Permission Manager",
                        "description": "Manage permissions on a webstrate",
                        "dependencies": [
                            "wpm_js_libs #material-design-components",
                            "wpm_js_libs #material-design-icons",
                            "WebstrateComponents_Tools"
                        ],
                        "assets": [],
                        "version": "1.0",
                        "license": "Apache 2.0",
                        "changelog": {
                            "1.0": "Initial version"
                        }
                    }

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  Permission Manager Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .webstrate-components-permission-ui .wcp-permission-column {
                      white-space: normal;
                      width: 1em;
                      text-align: center; }

                    .webstrate-components-permission-ui .wcp-user-column {
                      width: 15em; }

                    .webstrate-components-permission-ui .mdc-data-table__cell:last-child {
                      text-align: right; }
                    </STYLE><SCRIPT id="webstrate-permission-manager-script" type="disabled">
                    /**
                     *  Permission Manager
                     *  Low-level interface to control permissions on a Webstrate
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Handles managing permissions
                     */
                    class PermissionManager {
                        constructor() {
                            this.permissions = [];

                            this.loadPermissions();

                            this.observer = new MutationObserver((mutations)=>{
                                this.loadPermissions();
                            });

                            this.startObserver();
                        }

                        async executeObserverless(executor) {
                            let mutations = this.observer.takeRecords();
                            if(mutations.length > 0) {
                                this.loadPermissions();
                            }
                            this.observer.disconnect();

                            await executor();

                            this.startObserver();
                        }

                        startObserver() {
                            this.observer.observe(document.querySelector("html"), {
                                attributes: true,
                                attributeFilter: ["data-auth"]
                            });
                        }

                        loadPermissions() {
                            let self = this;

                            let permissionJson = JSON.parse(document.querySelector("html").getAttribute("data-auth"));

                            self.permissions = [];

                            if(permissionJson != null) {
                                permissionJson.forEach((perm)=>{
                                    if(perm.webstrateId != null) {
                                        //Inherit permissions
                                        console.warn("This webstrate is inheriting permissions (Unsupported) from: ", perm.webstrateId);
                                    } else {
                                        self.permissions.push(new Permission(perm.username, perm.provider, perm.permissions));
                                    }
                                });
                            }

                            this.checkAnonymousUser();

                            EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
                                permissions: this.permissions
                            });
                        }

                        checkAnonymousUser() {
                            //Remove anonymous if last user
                            if(this.permissions.length === 1 && this.permissions[0].username === "anonymous" && this.permissions[0].provider === "") {
                                this.permissions.pop();
                            }

                            //Only add anonymous if another user is present
                            if(this.permissions.length > 0 && this.permissions.find((perm)=>{
                                return perm.username === "anonymous" && perm.provider === "";
                            }) == null) {
                                //no anonymous permission, adding with no rights
                                this.permissions.push(new Permission("anonymous", "", ""));
                            }
                        }

                        setPermission(permission) {
                            console.log("Setting permission: ", permission);

                            let oldPermission = this.permissions.find((perm)=>{
                                return permission.username === perm.username && permission.provider === perm.provider;
                            });

                            if(oldPermission != null) {
                                oldPermission.permissions = permission.permissions;
                            } else {
                                this.permissions.push(permission);
                            }

                            this.checkAnonymousUser();

                            EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
                                permissions: this.permissions
                            });
                        }

                        removePermission(permission) {
                            this.permissions = this.permissions.filter((perm)=>{
                                return permission.username !== perm.username || permission.provider !== perm.provider;
                            });

                            this.checkAnonymousUser();

                            EventSystem.triggerEvent("PermissionManager.Permissions.Changed", {
                                permissions: this.permissions
                            });
                        }

                        save() {
                            if(this.permissions.length === 0 || (this.permissions.length === 1 && this.permissions[0].username === "anonymous")) {
                                //Empty permissions, remove auth property, everyone can do anything!
                                if(confirm("After saving everyone has full access to this webstrate.\nContinue?")) {
                                    document.querySelector("html").removeAttribute("data-auth");
                                    return true;
                                } else {
                                    return false;
                                }
                            } else {
                                //Checks for the current user not locking himself out
                                let ourPermissions = this.permissions.find((perm)=>{
                                    return perm.username === webstrate.user.username && perm.provider === webstrate.user.provider;
                                });

                                let anonPermissions = this.permissions.find((perm)=>{
                                    return perm.username === "anonymous" && perm.provider === "";
                                });

                                let anyAdmin = this.permissions.find((perm)=>{
                                    return perm.hasPermission("a");
                                }) != null;

                                if(ourPermissions == null) {
                                    //If our user does not exist, we are anon
                                    ourPermissions = anonPermissions;
                                }

                                let canRead = ourPermissions!=null?ourPermissions.hasPermission("r"):false;
                                let canWrite = ourPermissions!=null?ourPermissions.hasPermission("w"):false;
                                let canAdmin = ourPermissions!=null?((anyAdmin)?ourPermissions.hasPermission("a"):canWrite):false;

                                let permissionsJson = JSON.stringify(this.permissions.map((perm)=>{
                                    return perm.toJson();
                                }));

                                if(!canAdmin) {
                                    if(confirm("After saving permissions, you will no longer be able to change permissions.\nContinue?")) {
                                        document.querySelector("html").setAttribute("data-auth", permissionsJson, {approved: true});
                                        return true;
                                    } else {
                                        return false;
                                    }
                                } else {
                                    document.querySelector("html").setAttribute("data-auth", permissionsJson, {approved: true});
                                    return true;
                                }
                            }
                        }
                    }

                    window.WebstrateComponents.PermissionManager = PermissionManager;

                    class Permission {
                        constructor(username, provider, permissionString) {
                            this.username = username;
                            this.provider = provider;
                            this.permissions = new Set();

                            this.loadPermissions(permissionString);
                        }

                        loadPermissions(permissionString) {
                            this.permissions.clear();

                            for(let i = 0; i<permissionString.length; i++) {
                                let p = permissionString.charAt(i);

                                switch(p) {
                                    case "a":
                                        this.permissions.add("a");
                                    case "w":
                                        this.permissions.add("w");
                                    case "r":
                                        this.permissions.add("r");
                                        break;

                                    default:
                                        console.warn("Unknown permission: ", p);
                                }
                            }
                        }

                        setPermission(perm) {
                            this.permissions.clear();

                            switch(perm) {
                                case "a":
                                    this.permissions.add("a");
                                case "w":
                                    this.permissions.add("w");
                                case "r":
                                    this.permissions.add("r");
                                default:
                                    console.warn("Unknown permission: ", perm);
                            }
                        }

                        hasPermission(perm) {
                            return this.permissions.has(perm);
                        }

                        toJson() {
                            return {
                                username: this.username,
                                provider: this.provider,
                                permissions: Array.from(this.permissions).join("")
                            };
                        }
                    }

                    window.WebstrateComponents.Permission = Permission;

                    //Load right away
                    WebstrateComponents.PermissionManager.singleton = new PermissionManager();

                    </SCRIPT><SCRIPT id="webstrate-permission-manager-ui-script" type="disabled">
                    /**
                     *  Permission Manager UI
                     *  UI code for controlling permissions on a Webstrate
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * UI code for controlling permissions on a Webstrate
                     */
                    class PermissionManagerUI {
                        constructor() {
                            let self = this;

                            this.topLevelComponent = document.body;

                            this.html = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-ui-tpl");

                            this.html.querySelectorAll(".mdc-button").forEach((button)=>{
                                new mdc.ripple.MDCRipple(button);
                            });

                            EventSystem.registerEventCallback("PermissionManager.Permissions.Changed", ({detail:{permissions: permissions}})=>{
                                self.reload(permissions);
                            });

                            this.reload(WebstrateComponents.PermissionManager.singleton.permissions);

                            this.html.querySelector("button.addPermission").addEventListener("click", ()=>{
                                self.showAddDialog();
                            });

                            this.html.querySelector("button.savePermissions").addEventListener("click", ()=>{
                                if(WebstrateComponents.PermissionManager.singleton.save()) {
                                    EventSystem.triggerEvent("PermissionManagerUI.Saved", this);
                                }
                            });
                        }

                        setTopLevelComponent(component){
                            this.topLevelComponent = component;
                        }

                        async showAddDialog() {
                            let dialogTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-add-permission-dialog-tpl");

                            let dialog = new WebstrateComponents.ModalDialog(dialogTpl);
                            let transient = document.createElement("transient");
                            transient.appendChild(dialog.html);
                            this.topLevelComponent.appendChild(transient);

                            let permissionTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-adduser-tpl");
                            dialogTpl.querySelector("tbody").appendChild(permissionTpl);

                            new mdc.textField.MDCTextField(permissionTpl.querySelector('.mdc-text-field'));

                            dialog.open();

                            EventSystem.registerEventCallback('ModalDialog.Closed', function(evt) {
                                //Remove template after use
                                transient.remove();

                                if(evt.detail.dialog===dialog && evt.detail.action === "add") {
                                    let usernameProvider = dialogTpl.querySelector(".username input").value.split(":");
                                    let permissionString = dialogTpl.querySelector("input[type='radio']:checked").value;

                                    if(usernameProvider.length === 2 && usernameProvider[0].trim() !== "" && usernameProvider[1].trim() !== "") {
                                        let permission = new WebstrateComponents.Permission(usernameProvider[0], usernameProvider[1], permissionString);

                                        WebstrateComponents.PermissionManager.singleton.setPermission(permission);
                                    } else {
                                        alert("You mistyped something, must be 'username:provider'");
                                    }
                                }
                            });
                        }

                        reload(permissions) {
                            let tbody = this.html.querySelector("tbody");

                            //Empty tbody
                            while(tbody.firstChild) tbody.firstChild.remove();

                            permissions.forEach((perm)=>{
                                let permissionTpl = WebstrateComponents.Tools.loadTemplate("#webstrate-components-permission-user-tpl");

                                let prefix = perm.username+"_"+perm.provider+"_";

                                //Rename all input id and name attributes
                                permissionTpl.querySelectorAll("input").forEach((input)=>{
                                    input.id = prefix + input.id;
                                    input.name = prefix + input.name;

                                    input.addEventListener("input", ()=>{
                                        perm.setPermission(input.value);
                                    });
                                })

                                //Rename all label for attributes
                                permissionTpl.querySelectorAll("label").forEach((label)=>{
                                    label.setAttribute("for", prefix + label.getAttribute("for"));
                                });

                                permissionTpl.querySelectorAll('.mdc-radio').forEach((radio)=>{
                                    new mdc.radio.MDCRadio(radio);
                                });

                                permissionTpl.querySelectorAll('.mdc-form-field').forEach((formField)=>{
                                    new mdc.formField.MDCFormField(formField);
                                });

                                let checkedSelector = "";

                                if(perm.hasPermission("a")) {
                                    checkedSelector = prefix+"admin";
                                } else if(perm.hasPermission("w")) {
                                    checkedSelector = prefix+"write";
                                } else if(perm.hasPermission("r")) {
                                    checkedSelector = prefix+"read";
                                } else {
                                    checkedSelector = prefix+"none";
                                }

                                permissionTpl.querySelector("#"+checkedSelector).checked = true;

                                permissionTpl.querySelector(".username").textContent = perm.username+(perm.provider.trim()===""?"":":"+perm.provider);

                                if(perm.username === "anonymous" && perm.provider === "") {
                                    permissionTpl.querySelector(".deletePermission").remove();
                                } else {
                                    permissionTpl.querySelector(".deletePermission").addEventListener("click", ()=>{
                                        WebstrateComponents.PermissionManager.singleton.removePermission(perm);
                                    });
                                }

                                tbody.appendChild(permissionTpl);
                            });
                        }
                    }

                    window.WebstrateComponents.PermissionManagerUI = PermissionManagerUI;

                    </SCRIPT><TEMPLATE id="webstrate-components-permission-ui-tpl">
                        <DIV class="webstrate-components-permission-ui">
                            <TABLE class="mdc-data-table__table" aria-label="User permissions">
                                <THEAD>
                                    <TR class="mdc-data-table__header-row">
                                        <TH></TH>
                                        <TH colspan="4" class role="columnheader" scope="col">Permissions</TH>
                                        <TH class="mdc-data-table__header-cell" role="columnheader" scope="col"></TH>
                                    </TR>
                                    <TR>
                                        <TH rowspan="2" class="mdc-data-table__header-cell wcp-user-column" role="columnheader" scope="col">User</TH>
                                        <TH class="mdc-data-table__header-cell wcp-permission-column">Admin</TH>
                                        <TH class="mdc-data-table__header-cell wcp-permission-column">Write& Read</TH>
                                        <TH class="mdc-data-table__header-cell wcp-permission-column">Read Only</TH>
                                        <TH class="mdc-data-table__header-cell wcp-permission-column">No Access</TH>
                                    </TR>
                                </THEAD>
                                <TBODY class="mdc-data-table__content">
                                </TBODY>
                                <TFOOT>
                                    <TR class="mdc-data-table__row mdc-data-table__footer-row">
                                        <TD colspan="6">
                                            <BUTTON class="mdc-button mdc-button--touch addPermission">
                                                <DIV class="mdc-button__ripple"></DIV>
                                                <I class="material-icons mdc-button__icon" aria-hidden="true">person_add</I>
                                                <SPAN class="mdc-button__label">Add User</SPAN>
                                                <DIV class="mdc-button__touch"></DIV>
                                            </BUTTON>
                                        </TD>
                                    </TR>
                                </TFOOT>
                            </TABLE>
                            <DIV class="mdc-dialog__actions">
                                <BUTTON class="mdc-button mdc-button--touch mdc-button--raised savePermissions" tabindex="1">
                                    <DIV class="mdc-button__ripple"></DIV>
                                    <SPAN class="mdc-button__label">Save</SPAN>
                                    <DIV class="mdc-button__touch"></DIV>
                                </BUTTON>
                            </DIV>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="webstrate-components-permission-user-tpl">
                        <TR class="mdc-data-table__row">
                            <TD class="mdc-data-table__cell username"></TD>
                            <TD class="mdc-data-table__cell">
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="admin" value="a" name="permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                </DIV>
                            </TD><TD class="mdc-data-table__cell">
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="write" value="w" name="permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                </DIV>
                            </TD><TD class="mdc-data-table__cell">
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="read" value="r" name="permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                </DIV>
                            </TD><TD class="mdc-data-table__cell">
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="none" value name="permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                </DIV>
                            </TD>
                            <TD class="mdc-data-table__cell">
                                <BUTTON class="mdc-button mdc-button--touch deletePermission">
                                    <DIV class="mdc-button__ripple"></DIV>
                                    <SPAN class="mdc-button__label">Delete</SPAN>
                                    <DIV class="mdc-button__touch"></DIV>
                                </BUTTON>
                            </TD>
                        </TR>
                    </TEMPLATE><TEMPLATE id="webstrate-components-permission-adduser-tpl">
                        <TR class="mdc-data-table__row">
                            <TD class="mdc-data-table__cell username">
                                <LABEL class="mdc-text-field mdc-text-field--filled">
                                  <SPAN class="mdc-text-field__ripple"></SPAN>
                                  <INPUT placeholder="F.x. 'bob:au'" class="mdc-text-field__input" type="text" aria-labelledby="webstrate-components-permission-adduser-username"/>
                                  <SPAN class="mdc-floating-label" id="id=" webstrate-components-permission-adduser-username__>username:provider</SPAN>
                                  <SPAN class="mdc-line-ripple"></SPAN>
                                </LABEL>
                            </TD>
                            <TD class="mdc-data-table__cell">
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-admin" value="a" name="webstrate-components-permission-adduser-permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                    <LABEL for="webstrate-components-permission-adduser-admin">Admin, Write and Read</LABEL>
                                </DIV><BR/>
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-write" value="w" name="webstrate-components-permission-adduser-permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                    <LABEL for="webstrate-components-permission-adduser-write">Write and Read</LABEL>
                                </DIV><BR/>
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-read" value="r" name="webstrate-components-permission-adduser-permissions"/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                    <LABEL for="webstrate-components-permission-adduser-read">Read Only</LABEL>
                                </DIV><BR/>
                                <DIV class="mdc-form-field">
                                    <DIV class="mdc-radio">
                                        <INPUT class="mdc-radio__native-control" type="radio" id="webstrate-components-permission-adduser-none" value name="webstrate-components-permission-adduser-permissions" checked/>
                                        <DIV class="mdc-radio__background">
                                            <DIV class="mdc-radio__outer-circle"></DIV>
                                            <DIV class="mdc-radio__inner-circle"></DIV>
                                        </DIV>
                                        <DIV class="mdc-radio__ripple"></DIV>
                                    </DIV>
                                    <LABEL for="webstrate-components-permission-adduser-none">None</LABEL>
                                </DIV>
                            </TD>
                        </TR>
                    </TEMPLATE><TEMPLATE id="webstrate-components-permission-add-permission-dialog-tpl">
                        <DIV>
                            <TABLE class="mdc-data-table__table" aria-label="User permissions">
                                <THEAD>
                                <TR class="mdc-data-table__header-row">
                                    <TH class="mdc-data-table__header-cell" role="columnheader" scope="col">User</TH>
                                    <TH class="mdc-data-table__header-cell" role="columnheader" scope="col">Permissions</TH>
                                </TR>
                                </THEAD>
                                <TBODY class="mdc-data-table__content">
                                </TBODY>
                            </TABLE>
                            <DIV class="mdc-dialog__actions">
                                <BUTTON type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="cancel">
                                    <DIV class="mdc-button__ripple"></DIV>
                                    <SPAN class="mdc-button__label">Cancel</SPAN>
                                </BUTTON>
                                <BUTTON type="button" class="mdc-button mdc-dialog__button mdc-button--raised" data-mdc-dialog-action="add">
                                    <DIV class="mdc-button__ripple"></DIV>
                                    <SPAN class="mdc-button__label">Add</SPAN>
                                </BUTTON>
                            </DIV>
                        </DIV>
                    </TEMPLATE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="EdgeDocker" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Edge Docking Area",
                        "description": "Creates a dockable area and reflows the rest of the parent around it like regular built-in developer tools",
                        "dependencies": [
                            "wpm_js_libs #CaviTouch",
                            "WebstrateComponents_Tools"
                        ],
                        "assets": [],
                        "version": "0.9",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.8": "Initial checkin based on linear editor docking system",
                            "0.9": "Support for moving around rest of document when docking"
                        }
                    }

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  EdgeDocker Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    html {
                      height: 100vh; }
                      html[transient-data-docking-area-component-mode~="minimized"] .docking-area-resizer {
                        display: none; }
                      html[transient-data-docking-area-component-mode~="minimized"] .docking-area-component {
                        display: none; }
                      html[transient-data-docking-area-component-mode~="embedded"] .docking-area-resizer {
                        display: none; }
                      html[transient-data-docking-area-component-mode~="embedded"] .docking-area-component {
                        width: 100%;
                        height: 100%; }
                      html[transient-data-docking-area-component-mode~="maximized"] > *:not(.docking-area-component):not(.docking-area--ignore) {
                        /* Hide other items without breaking Monaco */
                        opacity: 0;
                        overflow: hidden;
                        width: 1em;
                        height: 1em; }
                      html[transient-data-docking-area-component-mode~="maximized"] .docking-area-resizer {
                        display: none; }
                      html[transient-data-docking-area-component-mode~="maximized"] .docking-area-component {
                        position: fixed !important;
                        display: block;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: 0 !important; }
                      html[transient-data-docking-area-component-mode~="floating"] .docking-area-resizer {
                        display: none; }
                      html[transient-data-docking-area-component-mode~="floating"] .docking-area-component {
                        position: fixed;
                        display: block;
                        top: 0;
                        left: 0;
                        width: 35em;
                        height: 22em;
                        overflow: auto;
                        resize: both;
                        box-sizing: border-box;
                        border: 1px outset #ababab;
                        box-shadow: 0.1em 0.1em 0.5em rgba(0, 0, 0, 0.15); }
                      html[transient-data-docking-area-component-mode~="edge"] {
                        overflow: hidden;
                        display: flex; }
                        html[transient-data-docking-area-component-mode~="edge"] > *:not(.docking-area--ignore) {
                          flex: 1 1 auto;
                          overflow: auto;
                          contain: paint; }
                        html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer {
                          flex: 0 0 auto;
                          min-height: 1px;
                          min-width: 1px;
                          cursor: ew-resize;
                          position: relative;
                          margin: -2px;
                          border: 2px solid transparent;
                          contain: none;
                          overflow: visible;
                          z-index: 5; }
                          html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:before {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(128, 128, 128, 0.5);
                            content: ""; }
                          html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:hover {
                            margin: -0.5em;
                            border: 0.5em solid transparent; }
                            html[transient-data-docking-area-component-mode~="edge"] > .docking-area-resizer:hover:before {
                              margin: -1px;
                              border: 1px solid rgba(128, 128, 128, 0.1); }
                        html[transient-data-docking-area-component-mode~="edge"] > .docking-area-component {
                          contain: none;
                          position: relative;
                          flex: 0 0 auto;
                          min-width: 20vw;
                          min-height: 20vh; }
                        html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="left"] > .docking-area-resizer {
                          order: -1; }
                        html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="left"] > .docking-area-component {
                          order: -2;
                          height: auto; }
                        html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="right"] > .docking-area-resizer {
                          order: 1; }
                        html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="right"] > .docking-area-component {
                          order: 2;
                          height: auto; }
                        html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] {
                          flex-direction: column; }
                          html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] > .docking-area-resizer {
                            order: 1;
                            cursor: ns-resize; }
                          html[transient-data-docking-area-component-mode~="edge"][transient-data-docking-area-component-mode~="bottom"] > .docking-area-component {
                            order: 2; }
                      html .docking-area-component {
                        z-index: 1000000; }
                      html .docking-area-visualizer {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        width: 15em;
                        height: 10em;
                        background: rgba(10, 10, 255, 0.25);
                        border: 1px solid rgba(0, 0, 255, 0.3);
                        box-sizing: border-box;
                        transition: all 0.1s;
                        opacity: 0;
                        display: block;
                        pointer-events: none;
                        z-index: 1000000; }
                      html[transient-data-docking-area-component-drag~="dragging"] {
                        overflow: hidden; }
                        html[transient-data-docking-area-component-drag~="dragging"] .docking-area-visualizer {
                          opacity: 1; }
                        html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="float"] .docking-area-visualizer {
                          opacity: 0;
                          transition: none; }
                        html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="left"] .docking-area-visualizer {
                          left: 0 !important;
                          top: 0 !important;
                          right: 90% !important;
                          bottom: 0 !important;
                          width: auto;
                          height: auto; }
                        html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="right"] .docking-area-visualizer {
                          left: 90% !important;
                          right: 0 !important;
                          top: 0 !important;
                          bottom: 0 !important;
                          width: auto;
                          height: auto; }
                        html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="bottom"] .docking-area-visualizer {
                          left: 0 !important;
                          right: 0 !important;
                          top: 90% !important;
                          bottom: 0 !important;
                          width: auto;
                          height: auto; }
                        html[transient-data-docking-area-component-drag~="dragging"][transient-data-docking-area-component-drag~="maximized"] .docking-area-visualizer {
                          left: 0 !important;
                          top: 0 !important;
                          right: 0 !important;
                          bottom: 0 !important;
                          width: auto;
                          height: auto; }
                    </STYLE><SCRIPT id="edgedocker-component-script" type="disabled">
                    /**
                     *  EdgeDocker
                     *  Provides Developer-Console-like behaviour in browsers
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * @typedef {object} EdgeDocker~config
                     * @property {Element} [parent=html] - The parent to attach the docker too.
                     * @property {EdgeDocker.MODE} [mode=RIGHT] - The edge to attach too.
                     */

                    /**
                     * EdgeDocker can dock its container along the edges of the browser, just like Dev console does.
                     */
                    class EdgeDocker {
                        /**
                         * Create a new EdgeDocker
                         * @param {EdgeDocker~config} options
                         */
                        constructor(options) {
                            let self = this;

                            this.parent = WebstrateComponents.Tools.fromConfig(options, "parent", document.querySelector("html"));

                            // Add the resizer and content areas
                            this.resizeHandle = document.createElement("transient");
                            this.resizeHandle.classList.add("docking-area-resizer");
                            this.parent.appendChild(this.resizeHandle);
                            this.outerComponentArea = document.createElement("component-area");
                            this.outerComponentArea.classList.add("docking-area-component");
                            this.outerComponentArea.setAttribute("transient-element",true);
                            this.parent.appendChild(this.outerComponentArea);
                            this.visualizerHandle = document.createElement("transient");
                            this.visualizerHandle.classList.add("docking-area-visualizer");
                            this.parent.appendChild(this.visualizerHandle);

                            // Create shadowDOM for content in component area and simulate a fake toplevel HTML element on it
                            if (options.shadowRoot){
                                this.componentShadow = this.outerComponentArea.attachShadow({mode:"open"});//this.outerComponentArea;
                                this.innerComponentArea = document.createElement("component-area-content");
                                this.componentShadow.appendChild(this.innerComponentArea);
                                this.componentShadow.matches = (query)=>{
                                    if (query==="html") return true;
                                }

                                // For components that do not supply their own stylesheets we can pass thru the main page's
                                if (options.shadowCompatibility){
                                    this.shadowCompatibilityNode = document.createElement("compatibility-pasthru");
                                    this.shadowCompatibilityNode.style.display="none";
                                    this.componentShadow.appendChild(this.shadowCompatibilityNode);

                                    let updateCompatibilityPasthru = function updateCompatibilityPasthru(){
                                        self.shadowCompatibilityNode.innerHTML="";
                                        document.querySelectorAll("head link, head style, head wpm-package svg").forEach((style)=>{
                                            self.shadowCompatibilityNode.appendChild(style.cloneNode(true));
                                        });
                                    }
                                    let observer = new MutationObserver(updateCompatibilityPasthru);
                                    observer.observe(document.head, {
                                        childList: true,
                                        subtree: true
                                    });
                                    updateCompatibilityPasthru();

                                }
                            } else {
                                this.innerComponentArea = this.outerComponentArea;
                            }

                            // Do not let events bubble through the component area to the document below
                            let stopEvent = (evt)=>{
                                evt.stopPropagation();
                            };
                            ["click"].forEach((event)=>{
                                this.outerComponentArea.addEventListener(event, stopEvent);
                            });

                            this.dragging = false;

                            // init resize
                            this.setupResizeHandle(this.resizeHandle);
                            this.setMode(WebstrateComponents.Tools.fromConfig(options, "mode", EdgeDocker.MODE.RIGHT));

                            this.positionAnimationFrame = null;
                            this.boundsAnimationFrame = null;

                            let oldStyleWidth = null;
                            let oldStyleHeight = null;

                            //Crude observer to check for docker resizeing
                            let observer = new MutationObserver(()=>{
                                let doEvent = false;


                                if(self.boundsAnimationFrame != null) {
                                    cancelAnimationFrame(this.boundsAnimationFrame);
                                    self.boundsAnimationFrame = null;
                                }

                                self.boundsAnimationFrame = requestAnimationFrame(()=>{
                                    if(this.outerComponentArea.style.width != oldStyleWidth) {
                                        doEvent = true;
                                        oldStyleWidth = parseInt(this.outerComponentArea.style.width);
                                    }

                                    if(this.outerComponentArea.style.height != oldStyleHeight) {
                                        doEvent = true;
                                        oldStyleHeight = parseInt(this.outerComponentArea.style.height);
                                    }

                                    if(doEvent) {
                                        self.setBounds(parseInt(this.outerComponentArea.style.left), parseInt(this.outerComponentArea.style.top), oldStyleWidth, oldStyleHeight);
                                        window.dispatchEvent(new Event('resize'));
                                    }
                                });
                            });

                            observer.observe(this.outerComponentArea, {
                                attributes: true,
                                attributeFilter: ["style"]
                            });
                        }

                        setupResizeHandle() {
                            let self = this;

                            this.resizeAnimFrame = null;

                            let preventEvents = ["move"];
                            if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){
                                preventEvents.push("down");
                            }

                            this.deltaWidth = 0;
                            this.deltaHeight = 0;

                            new CaviTouch(this.resizeHandle, {
                                minDragDistance: 0
                            });

                            this.resizeHandle.addEventListener("caviDrag", (evt)=>{
                                switch(self.currentMode) {
                                    case EdgeDocker.MODE.MAXIMIZED:
                                        break;
                                    case EdgeDocker.MODE.BOTTOM:
                                        self.deltaHeight -= evt.detail.caviEvent.deltaPosition.y;
                                        break;
                                    case EdgeDocker.MODE.LEFT:
                                        self.deltaWidth += evt.detail.caviEvent.deltaPosition.x;
                                        break;
                                    case EdgeDocker.MODE.RIGHT:
                                        self.deltaWidth -= evt.detail.caviEvent.deltaPosition.x;
                                        break;
                                    case EdgeDocker.MODE.FLOAT:
                                        self.deltaWidth += evt.detail.caviEvent.deltaPosition.x;
                                        self.deltaHeight += evt.detail.caviEvent.deltaPosition.y;
                                        break;
                                }

                                if(self.resizeAnimFrame === null) {
                                    cancelAnimationFrame(self.resizeAnimFrame);
                                }
                                self.resizeAnimFrame = requestAnimationFrame(()=>{
                                    self.resizeAnimFrame = null;
                                    let width = this.outerComponentArea.offsetWidth + self.deltaWidth;
                                    let height = this.outerComponentArea.offsetHeight + self.deltaHeight;

                                    self.deltaWidth = 0;
                                    self.deltaHeight = 0;

                                    this.setBounds(parseInt(this.outerComponentArea.style.left), parseInt(this.outerComponentArea.style.top), width, height);
                                    /*
                                    this.outerComponentArea.style.width = width+"px";
                                    this.outerComponentArea.style.height = height+"px";
                                    */
                                });
                            });
                        }

                        setupDragHandle(element) {
                            let self = this;

                            new CaviTouch(element, {
                                preventDefaultEvents: []
                            });

                            let currentSelectedMode = null;
                            let oldSelectedMode = null;

                            let currentX = 0;
                            let currentY = 0;

                            element.addEventListener("caviDoubleTap", ()=>{
                                if(self.currentMode !== EdgeDocker.MODE.MAXIMIZED){
                                    self.setMode(EdgeDocker.MODE.MAXIMIZED);
                                } else {
                                    self.setMode(EdgeDocker.MODE.FLOAT);
                                }
                            });

                            element.addEventListener("caviDragStart", (evt)=>{
                                self.dragging = true;

                                oldSelectedMode = self.currentMode;

                                if(self.currentMode !== EdgeDocker.MODE.FLOAT) {
                                    self.setMode(EdgeDocker.MODE.FLOAT);

                                    let bounds = element.getBoundingClientRect();

                                    self.setPosition(evt.detail.caviEvent.position.x-bounds.width / 2.0, evt.detail.caviEvent.position.y-bounds.height / 2.0, true);
                                }

                                self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging");

                                let bounds = this.outerComponentArea.getBoundingClientRect();
                                currentX = bounds.x;
                                currentY = bounds.y;
                            });

                            element.addEventListener(("caviDrag"), (evt)=>{
                                let percentWidth = self.parent.offsetWidth * 0.1;
                                let percentHeight = self.parent.offsetHeight * 0.1;

                                currentX += evt.detail.caviEvent.deltaPosition.x;
                                currentY += evt.detail.caviEvent.deltaPosition.y;

                                if(evt.detail.caviEvent.position.x < percentWidth) {
                                    self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging left");
                                    currentSelectedMode = EdgeDocker.MODE.LEFT;
                                } else if(self.parent.offsetWidth - evt.detail.caviEvent.position.x < percentWidth) {
                                    self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging right");
                                    currentSelectedMode = EdgeDocker.MODE.RIGHT;
                                } else if(evt.detail.caviEvent.position.y - self.parent.scrollTop < percentHeight) {
                                    self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging maximized");
                                    currentSelectedMode = EdgeDocker.MODE.MAXIMIZED;
                                } else if(self.parent.offsetHeight - (evt.detail.caviEvent.position.y - self.parent.scrollTop) < percentHeight) {
                                    self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging bottom");
                                    currentSelectedMode = EdgeDocker.MODE.BOTTOM;
                                } else {
                                    self.parent.setAttribute("transient-data-docking-area-component-drag", "dragging float");
                                    currentSelectedMode = EdgeDocker.MODE.FLOAT;
                                }

                                self.setPosition(currentX, currentY);
                            });

                            element.addEventListener("caviDragStop", (evt)=>{

                                self.setMode(currentSelectedMode, false);

                                if(oldSelectedMode !== currentSelectedMode) {
                                    self.saveMode();
                                }

                                if(currentSelectedMode === EdgeDocker.MODE.FLOAT) {
                                    self.saveBounds(currentSelectedMode, true);
                                }

                                self.parent.setAttribute("transient-data-docking-area-component-drag", "");

                                if(currentSelectedMode === EdgeDocker.MODE.FLOAT) {
                                    self.setPosition(currentX, currentY, true);
                                }

                                setTimeout(()=>{
                                    self.dragging = false;
                                });
                            });

                            element.style.cursor = "move";
                        }

                        /**
                         * Sets the position of this EdgeDocker, Ignored if not in FLOAT mode
                         * @param {Number} x
                         * @param {Number} y
                         */
                        setPosition(x, y, immediately=false) {
                            if(this.currentMode === EdgeDocker.MODE.FLOAT) {
                                let self = this;

                                if(this.positionAnimationFrame != null) {
                                    cancelAnimationFrame(this.positionAnimationFrame);
                                    this.positionAnimationFrame = null;
                                }

                                if(immediately) {
                                    this.outerComponentArea.style.left = x + "px";
                                    this.outerComponentArea.style.top = y + "px";
                                    self.visualizerHandle.style.left = x + "px";
                                    self.visualizerHandle.style.top = y + "px";
                                } else {
                                    this.positionAnimationFrame = requestAnimationFrame(()=>{
                                        if(self.currentMode === EdgeDocker.MODE.FLOAT) {
                                            this.outerComponentArea.style.left = x + "px";
                                            this.outerComponentArea.style.top = y + "px";
                                            self.visualizerHandle.style.left = x + "px";
                                            self.visualizerHandle.style.top = y + "px";
                                        }
                                    });
                                }
                            }
                        }

                        /**
                         * Sets the bounds of this EdgeDocker
                         * @param {Number} x
                         * @param {Number} y
                         * @param {Number} width
                         * @param {Number} height
                         * @param {boolean} [doSave=true] - Determines if the bounds should be saved or not
                         */
                        setBounds(x, y, width, height, doSave = true) {
                            this.setPosition(x, y, true);

                            let maxWidth = this.parent.offsetWidth * 0.8;
                            let maxHeight = this.parent.offsetHeight * 0.8;

                            width = Math.min(width, maxWidth);
                            height = Math.min(height, maxHeight);

                            switch(this.currentMode) {
                                case EdgeDocker.MODE.LEFT:
                                case EdgeDocker.MODE.RIGHT:
                                    //Only Set Width
                                    this.outerComponentArea.style.width = width + "px";
                                    break;

                                case EdgeDocker.MODE.BOTTOM:
                                    //Only Set height
                                    this.outerComponentArea.style.height = height + "px";
                                    break;

                                case EdgeDocker.MODE.FLOAT:
                                    //Set Width and Height
                                    this.outerComponentArea.style.width = width + "px";
                                    this.outerComponentArea.style.height = height + "px";
                                    break;
                            }

                            if(doSave) {
                                this.saveBounds(this.currentMode);
                            }
                        }

                        /**
                         * Sets the current dock mode of this EdgeDocker
                         * @param {EdgeDocker.MODE} mode
                         * @param {boolean} [doLoad=true] - Determines if this setMode should load bounds from storage or not.
                         */
                        setMode(mode, doLoad = true){
                            let oldWidth = parseInt(this.outerComponentArea.style.height);
                            let oldHeight = parseInt(this.outerComponentArea.style.width);
                            let oldMode = this.currentMode;

                            this.parent.setAttribute("transient-data-docking-area-component-mode", mode);
                            this.currentMode = mode;

                            if(this.currentMode === EdgeDocker.MODE.MAXIMIZED || this.currentMode === EdgeDocker.MODE.EMBEDDED) {
                                this.outerComponentArea.style.width = "";
                                this.outerComponentArea.style.height = "";
                            } else if(this.currentMode === EdgeDocker.MODE.LEFT || this.currentMode === EdgeDocker.MODE.RIGHT) {
                                this.outerComponentArea.style.height = "";
                                this.outerComponentArea.style.width = (this.parent.offsetWidth*0.5)+"px"; //Overidden if any saved mode exists
                            } else if(this.currentMode === EdgeDocker.MODE.BOTTOM) {
                                this.outerComponentArea.style.width = "";
                                this.outerComponentArea.style.height = (this.parent.offsetHeight*0.33)+"px"; //Overidden if any saved mode exists
                            } else if(this.currentMode === EdgeDocker.MODE.FLOAT && oldMode !== EdgeDocker.MODE.FLOAT) {
                                this.outerComponentArea.style.width = "";
                                this.outerComponentArea.style.height = "";
                            }

                            if (this.currentMode !== EdgeDocker.MODE.FLOAT){
                                this.outerComponentArea.style.top = null;
                                this.outerComponentArea.style.left = null;
                            }

                            if(doLoad) {
                                this.loadBounds(this.currentMode);
                            }

                            window.dispatchEvent(new Event('resize'));
                        }

                        dockInto(parentElement){
                            if (parentElement){
                                // Move into the element if one is given
                                parentElement.appendChild(this.outerComponentArea);
                            } else {
                                // Default to being shown before the visualizer
                                this.visualizerHandle.parentElement.insertBefore(this.outerComponentArea, this.visualizerHandle);
                            }
                        }

                        loadBounds(mode) {
                            let key = location.pathname + "_" + mode;

                            let bounds = localStorage.getItem(key);

                            if(bounds != null) {
                                try {
                                    bounds = JSON.parse(bounds);
                                    this.setBounds(bounds.x, bounds.y, bounds.width, bounds.height);
                                } catch(e) {
                                    console.error(e);
                                }
                            }
                        }

                        saveBounds(mode, forceSave = false) {
                            if(this.dragging && !forceSave) {
                                return;
                            }

                            let key = location.pathname + "_" + mode;

                            let bounds = this.outerComponentArea.getBoundingClientRect();

                            localStorage.setItem(key, JSON.stringify(bounds));
                        }

                        /**
                         * Save the current mode
                         */
                        saveMode() {
                            let key = location.pathname + "_Mode";
                            localStorage.setItem(key, this.currentMode);
                        }

                        /**
                         * Load the saved mode, or use fallback if no saved mode
                         * @param {EdgeDocker.MODE} fallback - The mode to use if none is saved.
                         */
                        loadMode(fallback) {
                            let key = location.pathname + "_Mode";
                            let mode = localStorage.getItem(key);
                            if(mode != null) {
                                this.setMode(mode);
                            } else {
                                this.setMode(fallback);
                            }
                        }

                        /**
                         * Fetch the component area where DOM elements can be added to this EdgeDocker
                         * @returns {HTMLElement}
                         */
                        getComponentArea(){
                            return this.innerComponentArea;
                        }
                    }

                    /**
                     * The supported modes of EdgeDocker
                     * @readonly
                     * @enum
                     */
                    EdgeDocker.MODE = {
                        MAXIMIZED: "maximized",
                        MINIMIZED: "minimized",
                        LEFT: "left edge",
                        RIGHT: "right edge",
                        BOTTOM: "bottom edge",
                        FLOAT: "floating",
                        EMBEDDED: "embedded"
                    };

                    window.EdgeDocker = EdgeDocker;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="TreeBrowser" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Tree Browser",
                        "description": "Generic component for rendering tree-like navigation structures",
                        "dependencies": [
                            "wpm_js_libs #material-design-components",
                            "wpm_js_libs #material-design-icons",
                            "wpm_js_libs #CaviDraggableHTML5",
                            "wpm_js_libs #CaviTouch",
                            "wpm_js_libs #UUIDGenerator",
                            "#WebstrateComponents_Tools",
                            "#wsc-icon-registry",
                            "codestrates-repos #EventSystem"
                        ],
                        "assets": [],
                        "version": "1.0",
                        "license": "Apache 2.0",
                        "changelog": {
                            "1.0": "Initial version"
                        }
                    }

                    </SCRIPT><STYLE id="mdc-treebrowser-style">
                    /**
                     *  TreeBrowser Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    @keyframes tree-browser-children-appear {
                      from {
                        opacity: 0;
                        transform: translateX(-1em); }
                      to {
                        opacity: 1;
                        transform: translateX(0); } }

                    @keyframes tree-browser-hoveractions-appear {
                      from {
                        opacity: 0; }
                      to {
                        opacity: 1; } }

                    ul.tree-browser {
                      padding: 0;
                      user-select: none; }
                      ul.tree-browser .tree-browser-children {
                        display: none;
                        padding-left: 0.75em;
                        padding-bottom: 0.1em; }

                    .tree-browser-node {
                      height: 1.5em;
                      align-items: center;
                      padding: 0;
                      contain: paint;
                      overflow: hidden; }
                      .tree-browser-node .rippley {
                        width: 100%;
                        position: absolute;
                        left: 0;
                        height: 100%;
                        top: 0;
                        overflow: hidden;
                        pointer-events: none; }
                      .tree-browser-node .mdc-list-item__graphic {
                        margin-right: 0em; }
                        .tree-browser-node .mdc-list-item__graphic .tree-browser-custom-icon {
                          max-width: 24px;
                          max-height: 80%; }
                          .tree-browser-node .mdc-list-item__graphic .tree-browser-custom-icon .wsc-registry-icon {
                            height: auto; }
                      .tree-browser-node .tree-browser-navigator {
                        transition: transform 0.1s ease-out; }
                      .tree-browser-node .mdc-list-item__text {
                        font-size: 0.8em;
                        margin-left: 0.4em; }
                      .tree-browser-node .tree-browser-hoveractions {
                        display: none;
                        width: initial;
                        animation: 0.1s tree-browser-hoveractions-appear ease-out; }
                      .tree-browser-node:hover > .tree-browser-hoveractions, .tree-browser-node:focus > .tree-browser-hoveractions {
                        display: block; }
                      .tree-browser-node .tree-browser-icons {
                        display: flex;
                        position: relative; }
                      .tree-browser-node .tree-browser-icon {
                        display: flex;
                        margin: 0.1em; }
                        .tree-browser-node .tree-browser-icon .tree-browser-icon-unfolded {
                          display: none; }
                      .tree-browser-node.tree-browser-unfolded > .tree-browser-navigator {
                        transform: rotate(90deg); }
                      .tree-browser-node.tree-browser-unfolded + li.tree-browser-children {
                        display: block; }
                      .tree-browser-node.tree-browser-unfolded .tree-browser-icon .tree-browser-icon-unfolded {
                        display: initial; }
                      .tree-browser-node.tree-browser-unfolded .tree-browser-icon .tree-browser-icon-closed {
                        display: none; }
                      .tree-browser-node.tree-browser-node-hidden {
                        display: none; }
                        .tree-browser-node.tree-browser-node-hidden + li.tree-browser-children {
                          padding-left: 0; }

                    .tree-browser-modifier {
                      position: absolute;
                      top: 0;
                      left: 0;
                      filter: drop-shadow(1px 1px 2px white); }
                      .tree-browser-modifier.tree-browser-modifier-a {
                        transform: translate(45%, -30%) scale(0.4); }
                      .tree-browser-modifier.tree-browser-modifier-b {
                        transform: translate(-50%, -30%) scale(0.4); }

                    /* Playground */
                    .mdc-list-item::before {
                      pointer-events: none; }
                    </STYLE><SCRIPT id="TreeBrowser-script" type="disabled">
                    /**
                     *  TreeBrowser
                     *  A navigation tool for presenting data as tree structures
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global mdc */

                    /**
                     * Called when a TreeNode is selected in a TreeBrowser
                     *
                     * @event TreeBrowser#EventSystem:"TreeBrowser.Selection"
                     * @type {CustomEvent}
                     * @property {TreeNode} selection - The selected TreeNode
                     */

                    /**
                     * Called when a TreeNode's action is triggered. (Ie. double click it)
                     *
                     * @event TreeNode#EventSystem:"TreeBrowser.TreeNode.Action"
                     * @type {CustomEvent}
                     * @property {TreeNode} node - The node which had its action triggered
                     */

                    /**
                     * TreeBrowser can take a TreeNode and construct a browsable tree
                     */
                    class TreeBrowser {
                        /**
                         * Create a TreeBrowser with the given TreeNode as root
                         *
                         * @param {TreeNode} rootNode
                         * @param {TreeBrowser~options} options
                         */
                        constructor(rootNode) {
                            let self = this;

                            /** @member {TreeNode} - The root node used to build the tree */
                            this.rootNode = rootNode;

                            /** @member {Element} - The DOM Element of this Tree */
                            this.html = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Main");

                            /** @member {MDCList} - The MDCList object from Material Design */
                            this.mdcList = new mdc.list.MDCList(this.html);
                            this.mdcList.singleSelection = true;

                            this.html.mdcList = this.mdcList;

                            this.mdcList.listen("MDCList:action", (evt)=>{
                                let listItem = self.mdcList.listElements[evt.detail.index];

                                EventSystem.triggerEvent("TreeBrowser.Selection", {
                                    selection: listItem.treeNode
                                });
                            });

                            this.rootNode.insertIntoDom(this.html, null);

                            this.rootNode.treeBrowser = this;

                            this.html.treeBrowser = this;

                            this.html.addEventListener("keyup", (evt)=>{
                                let selectedItem = self.mdcList.listElements[self.mdcList.selectedIndex];

                                if(selectedItem == null) {
                                    return;
                                }

                                EventSystem.triggerEvent("TreeBrowser.Keyup", {
                                    evt: evt,
                                    treeNode: selectedItem.treeNode
                                });

                                if(evt.key === "Enter") {
                                    selectedItem.treeNode.triggerAction();
                                } else if(evt.key === "ArrowRight") {
                                    selectedItem.treeNode.unfold();
                                } else if(evt.key === "ArrowLeft") {
                                    selectedItem.treeNode.fold();
                                } else if(evt.key === "ArrowDown") {
                                    let focusedItem = self.mdcList.listElements[self.mdcList["foundation"].adapter.getFocusedElementIndex()];
                                    if(focusedItem != null) {
                                        self.setSelected(focusedItem.treeNode);
                                    }
                                } else if(evt.key === "ArrowUp") {
                                    let focusedItem = self.mdcList.listElements[self.mdcList["foundation"].adapter.getFocusedElementIndex()];
                                    if(focusedItem != null) {
                                        self.setSelected(focusedItem.treeNode);
                                    }
                                }
                            });

                            this.html.addEventListener("keydown", (evt)=>{
                                let selectedItem = self.mdcList.listElements[self.mdcList.selectedIndex];

                                if(selectedItem == null) {
                                    return;
                                }

                                EventSystem.triggerEvent("TreeBrowser.Keydown", {
                                    evt: evt,
                                    treeNode: selectedItem.treeNode
                                });
                            });
                        }

                        /**
                         * Sets the given TreeNode as the current selection
                         * @param {TreeNode} treeNode
                         */
                        setSelected(treeNode) {
                            let index = -1;

                            let i = 0;
                            this.html.mdcList.listElements.forEach((elm)=>{
                                if(elm === treeNode.html) {
                                    index = i;
                                }

                                i++;
                            });

                            if(index !== -1) {
                                this.mdcList.selectedIndex = index;
                                this.mdcList.foundation.adapter.focusItemAtIndex(index);
                                EventSystem.triggerEvent("TreeBrowser.Selection", {
                                    selection: treeNode
                                });
                            }
                        }

                        /**
                         * Finds all TreeNode's that has the given context
                         * @param context
                         * @returns {TreeNode[]}
                         */
                        findTreeNodeForContext(context) {
                            function lookupContext(node) {
                                let foundNodes = [];

                                if(node.context === context) {
                                    foundNodes.push(node);
                                }

                                for(let child of node.childNodes) {
                                    foundNodes.push(...lookupContext(child));
                                }

                                return foundNodes;
                            }

                            return lookupContext(this.rootNode);
                        }

                        /**
                         * Finds all TreeNodes that have the given lookupKey
                         * @param key
                         * @returns {TreeNode[]}
                         */
                        findTreeNode(lookupKey) {
                            function lookupTheLookupKey(node) {
                                let foundNodes = [];

                                if(node.lookupKey === lookupKey) {
                                    foundNodes.push(node);
                                }

                                for(let child of node.childNodes) {
                                    foundNodes.push(...lookupTheLookupKey(child));
                                }

                                return foundNodes;
                            }

                            return lookupTheLookupKey(this.rootNode);
                        }

                        /**
                         * Find all TreeBrowsers currently in the DOM
                         * @returns {TreeBrowser[]}
                         */
                        static findAllTreeBrowsers() {
                            return Array.from(document.querySelectorAll(".tree-browser-root")).map((dom)=>{
                                return dom.treeBrowser;
                            });
                        }
                    }

                    window.TreeBrowser = TreeBrowser;

                    /**
                     * @typedef {Object} TreeNode~config
                     * @property {string} type - The type of this TreeNode, ex. "DomTreeNode", "AssetNode", "AssetRootNode"
                     * @property {*} context - The context of this TreeNode
                     * @property {boolean} [alwaysOpen=false] - If this TreeNode should stay unfolded
                     * @property {*} [lookupKey=context] - The lookupkey to use when TreeGenerator saves this TreeNode for later lookup
                     * @property {boolean} [startOpen=false] - If this TreeNode should start unfolded
                     * @property {boolean} [hideSelf=false] - If this TreeNode should be hidden.
                     */

                    /**
                     * Represents a tree node
                     */
                    class TreeNode {
                        /**
                         * Create a new TreeNode with the given configuration
                         * @param {TreeNode~config} config - The configuration for this TreeNode
                         */
                        constructor(config) {
                            let self = this;

                            this.config = config;

                            /** @memeber {string} - The type of this TreeNode */
                            this.type = this.getProperty("type");
                            /** @memeber {*} - The context of this TreeNode */
                            this.context = this.getProperty("context");

                            /** @memeber {boolean} - If this TreeNode should always stay unfolded */
                            this.alwaysOpen = this.getProperty("alwaysOpen", false);

                            this.startOpen = this.getProperty("startOpen", false);

                            this.lookupKey = this.getProperty("lookupKey", this.context);

                            /** @member {TreeNode[]} - The children of this TreeNode */
                            this.childNodes = [];

                            /** @member {Element} - The DOM Element of this TreeNode */
                            this.html = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Leaf");
                            this.html.treeNode = this;

                            this.hideSelf = this.getProperty("hideSelf", false);

                            this.childrenHtml = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Children");
                            this.childrenUl = this.childrenHtml.querySelector("ul.tree-browser");

                            /** @member {TreeNode} - The parent node of this TreeNode */
                            this.parentNode = null;

                            /** @member {Element[]} - Meta icons of this TreeNode */
                            this.metaIcons = [];

                            this.html.addEventListener("mouseup", (evt)=>{
                                if(evt.button === 2) {
                                    self.select();
                                }
                            });

                            this.onDecoratedCallbacks = new Set();

                            self.html.querySelector(".tree-browser-navigator").addEventListener("click", ()=>{
                                if(!self.isLeaf()) {
                                    if(self.alwaysOpen) {
                                        self.unfold();
                                    } else {
                                        self.toggleFold();
                                    }
                                }
                            });

                            if(this.startOpen) {
                                this.unfold();
                                console.log("Opening up!");
                            } else {
                                this.fold();
                            }

                            this.setupContextMenu();

                            this.setupMetaMenu();

                            this.setupDragging();

                            this.render();

                            this.setupClickListeners();
                        }

                        get hideSelf() {
                            return this.html.classList.contains("tree-browser-node-hidden");
                        }

                        set hideSelf(hide) {
                            if(hide) {
                                this.html.classList.add("tree-browser-node-hidden");
                            } else {
                                this.html.classList.remove("tree-browser-node-hidden");
                            }
                        }

                        /**
                         * Return the TreeBrowser at the top of the tree this TreeNode is in, if any
                         * @returns {null|TreeBrowser}
                         */
                        getTreeBrowser() {
                            if(this.treeBrowser != null) {
                                return this.treeBrowser;
                            } else if(this.parentNode != null) {
                                return this.parentNode.getTreeBrowser();
                            }

                            return null;
                        }

                        /**
                         * @private
                         * @param parent
                         */
                        insertIntoDom(parent) {
                            parent.appendChild(this.html);
                            parent.insertBefore(this.childrenHtml, this.html.nextElementSibling);
                        }

                        /**
                         * @private
                         */
                        removeFromDom() {
                            this.html.remove();
                            this.childrenHtml.remove();
                            if(this.nextAnimFrame != null) {
                                cancelAnimationFrame(this.nextAnimFrame);
                                this.nextAnimFrame = null;
                            }
                        }

                        /**
                         * Retrieve the value of the given property
                         * @param {String} propertyName
                         * @param {*} [defaultValue] - The default value if the property does not exist
                         * @returns {*}
                         */
                        getProperty(propertyName, defaultValue = null) {
                            return WebstrateComponents.Tools.fromConfig(this.config, propertyName, defaultValue);
                        }

                        /**
                         * Sets the value of the given property
                         * @param {String} propertyName
                         * @param {*} value
                         */
                        setProperty(propertyName, value) {
                            this.config[propertyName] = value;
                        }

                        /**
                         * Add a meta icon to this TreeNode
                         * @param {*} icon
                         */
                        addMetaIcon(icon) {
                            this.metaIcons.push(icon);
                            this.render();
                        }

                        /**
                         * Remove a meta icon from this TreeNode
                         * @param {*} icon
                         */
                        removeMetaIcon(icon) {
                            this.metaIcons.splice(this.metaIcons.indexOf(icon),1);
                            this.render();
                        }

                        /**
                         * Add a child node to this node at a given index
                         * @param {Number} index
                         * @param {TreeNode} node
                         */
                        addNode(node, index = -1) {
                            node.parentNode = this;

                            if(this.isFolded()) {
                                node.html.classList.remove("mdc-list-item");
                            } else {
                                node.html.classList.add("mdc-list-item");
                            }

                            if(index === -1) {
                                this.childNodes.push(node);
                            } else {
                                this.childNodes.splice(index, 0, node);
                            }

                            this.updateChildren();
                        }

                        /**
                         * Remove a child node from this node
                         * @param {TreeNode} node
                         */
                        removeNode(node) {
                            if(this.childNodes.indexOf(node) !== -1) {
                                this.childNodes.splice(this.childNodes.indexOf(node), 1);
                                node.removeFromDom();
                            }
                        }

                        /**
                         * Removes all child nodes from this TreeNode
                         */
                        clearNodes() {
                            let self = this;
                            let childNodeClone = this.childNodes.slice();
                            childNodeClone.forEach((child)=>{
                                self.removeNode(child);
                            });
                        }

                        /**
                         * Checks if this TreeNode has any children
                         * @returns {boolean} True/False depending on if this TreeNode has any children
                         */
                        isLeaf() {
                            let visibleChildNodes = this.childNodes.filter((child)=>{
                                return !child.hideSelf;
                            });

                            return visibleChildNodes.length === 0;
                        }

                        /**
                         * Unfold this TreeNode
                         */
                        unfold() {
                            if(!this.isLeaf()) {
                                this.html.classList.add("tree-browser-unfolded");

                                this.childNodes.forEach((child)=>{
                                    child.html.classList.add("mdc-list-item");
                                });
                            }
                        }

                        /**
                         * Fold this TreeNode
                         */
                        fold() {
                            if(this.alwaysOpen) {
                                return;
                            }

                            this.html.classList.remove("tree-browser-unfolded");

                            this.childNodes.forEach((child)=>{
                                child.html.classList.remove("mdc-list-item");
                            });
                        }

                        /**
                         * Toggle fold state of this TreeNode
                         */
                        toggleFold() {
                            if(this.html.classList.contains("tree-browser-unfolded")) {
                                this.fold();
                            } else {
                                this.unfold();
                            }
                        }

                        /**
                         * Check wether this TreeNode is folded or unfolded
                         * @returns {boolean} - True of this TreeNode is folded, false if unfolded
                         */
                        isFolded() {
                            return !this.html.classList.contains("tree-browser-unfolded");
                        }

                        /**
                         * Make this TreeNode the selected node in the tree
                         */
                        select() {
                            let self = this;

                            let treeBrowser = this.getTreeBrowser();

                            if(treeBrowser != null) {
                                treeBrowser.setSelected(this);
                                EventSystem.triggerEvent("TreeBrowser.Selection", {
                                    selection: self
                                });
                            }
                        }

                        /**
                         * Make this TreeNode and all parent TreeNode's unfold,
                         */
                        reveal() {
                            this.unfold();

                            if(this.parentNode != null) {
                                this.parentNode.reveal();
                            }
                        }

                        /**
                         * Called when we are removed from the tree
                         */
                        onRemoved() {
                            this.removeFromDom();
                        }

                        /**
                         * Called when this TreeNode has been decorated
                         */
                        onDecorated() {
                            let self = this;

                            this.render();

                            this.onDecoratedCallbacks.forEach((callback)=>{
                                callback(self);
                            });
                        }

                        /**
                         * @private
                         */
                        setupContextMenu() {
                            let self = this;

                            if(window.MenuSystem != null) {
                                this.html.addEventListener("contextmenu", (evt)=>{
                                    evt.preventDefault();
                                });

                                let contextMenu = null;

                                this.html.addEventListener("mouseup", (evt)=>{
                                    if(evt.button !== 2) {
                                        return;
                                    }
                                    self.select();

                                    //Find top component after html
                                    let parent = self.html;
                                    while(parent.parentNode != null && !parent.parentNode.matches("html")) {
                                        parent = parent.parentNode;
                                    }

                                    //Setup context menus
                                    if(contextMenu == null) {
                                        contextMenu = MenuSystem.MenuManager.createMenu("TreeBrowser.TreeNode.ContextMenu", {
                                            context: self,
                                            groupDividers: true
                                        });

                                        contextMenu.registerOnCloseCallback(() => {
                                            if (contextMenu.html.parentNode != null) {
                                                contextMenu.html.parentNode.removeChild(contextMenu.html);
                                            }
                                        });
                                    }

                                    parent.appendChild(contextMenu.html);
                                    contextMenu.open({
                                        x: evt.pageX,
                                        y: evt.pageY
                                    });
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });
                            }
                        }

                        /**
                         * @private
                         */
                        updateChildren() {
                            let self = this;

                            this.render();

                            if(this.updateChildrenAnimFrame != null) {
                                return;
                            }

                            this.updateChildrenAnimFrame = requestAnimationFrame(()=>{
                                //Reinsert all nodes?
                                self.childNodes.forEach((child)=>{
                                    child.insertIntoDom(self.childrenUl);
                                });

                                self.updateChildrenAnimFrame = null;
                            });
                        }

                        /**
                         * @private
                         */
                        render() {
                            let self = this;

                            if(this.nextAnimFrame != null) {
                                //We are already scheduled to render
                                return;
                            }

                            this.nextAnimFrame = requestAnimationFrame(()=>{
                                let content = self.getProperty("content");

                                let contentContainer = self.html.querySelector(":scope > .tree-browser-content");
                                while(contentContainer.lastChild) contentContainer.lastChild.remove();

                                if(content != null) {
                                    if (typeof content === "string") {
                                        contentContainer.textContent = content;
                                    } else if (content instanceof Element) {
                                        contentContainer.appendChild(content);
                                    } else {
                                        contentContainer.textContent = "Unknown 'content' [" + (typeof content) + "]:[" + JSON.stringify(content) + "]";
                                    }
                                }

                                // Tooltips
                                let tooltip = self.getProperty("tooltip");
                                if (tooltip != null){
                                    self.html.setAttribute("title", tooltip);
                                }

                                let icon = self.getProperty("icon");

                                let iconContainer = self.html.querySelector(":scope > .tree-browser-icons");

                                let oldIcon = iconContainer.querySelector(".tree-browser-icon");
                                if(oldIcon != null) {
                                    oldIcon.remove();
                                }

                                if(icon != null) {
                                    if(typeof icon === "string") {
                                        //Probabely wrong!
                                        let textSpan = document.createElement("span");
                                        textSpan.textContent = icon;
                                        icon = textSpan;
                                    }

                                    icon.classList.add("tree-browser-icon");
                                    iconContainer.append(icon);
                                }

                                ["a", "b", "c", "d"].forEach((modifierType)=>{
                                    //Remove old modifier
                                    let oldModifier = iconContainer.querySelector(".tree-browser-modifier-"+modifierType);

                                    if(oldModifier != null) {
                                        oldModifier.remove();
                                    }

                                    let modifier = self.getProperty("modifier-"+modifierType);

                                    if(modifier != null) {
                                        let tpl = WebstrateComponents.Tools.loadTemplate("TreeBrowser_Modifier");
                                        tpl.classList.add("tree-browser-modifier-"+modifierType);

                                        if(typeof modifier === "string") {
                                            let textSpan = document.createElement("span");
                                            textSpan.textContent = modifier;
                                            modifier = textSpan;
                                        }

                                        tpl.appendChild(modifier);

                                        iconContainer.appendChild(tpl);
                                    }
                                });

                                let metaIconContainer = self.html.querySelector(":scope > .mdc-list-item__meta");
                                while(metaIconContainer.lastChild) metaIconContainer.lastChild.remove();

                                self.metaIcons.forEach((icon)=>{
                                    metaIconContainer.appendChild(icon);
                                });

                                if(self.isLeaf()) {
                                    if(!self.html.classList.contains("tree-browser-leaf")) {
                                        self.html.querySelector(".tree-browser-navigator").innerHTML = "";
                                        self.html.classList.add("tree-browser-leaf");
                                    }

                                    this.fold();
                                } else {
                                    if(self.html.classList.contains("tree-browser-leaf")) {
                                        let icon = (IconRegistry.createIcon("mdc:chevron_right"));
                                        self.html.querySelector(".tree-browser-navigator").appendChild(icon);
                                        self.html.classList.remove("tree-browser-leaf");
                                    }

                                    if(self.alwaysOpen) {
                                        self.unfold();
                                    }
                                }

                                self.nextAnimFrame = null;
                            });
                        }

                        /**
                         * @private
                         */
                        setupDragging() {
                            let self = this;

                            let uuid = UUIDGenerator.generateUUID();

                            this.html.setAttribute("transient-drag-id", uuid);

                            let hoverStartTime = -1;

                            new CaviDraggableHTML5(this.html, {
                                onDragStart: (evt)=>{
                                    evt.dataTransfer.setData("treenode/href", location.href);
                                    evt.dataTransfer.setData("treenode/uuid", uuid);
                                    evt.dataTransfer.setData("treenodedata/uuid|"+uuid, "");
                                    TreeGenerator.decorateDataTransfers(self, evt.dataTransfer);
                                },
                                onDragComplete: (evt)=>{
                                    if(evt.dataTransfer.dropEffect !== "none") {
                                        EventSystem.triggerEvent("TreeBrowser.TreeNode.DragEnd", {
                                            draggedNode: self,
                                            dropEffect: evt.dataTransfer.dropEffect,
                                            dragEvent: evt
                                        });
                                    }
                                }
                            });

                            new CaviDroppableHTML5(this.html, {
                                onDragLeave: (evt)=>{
                                    hoverStartTime = -1;
                                    EventSystem.triggerEvent("TreeBrowser.TreeNode.DragLeave", {
                                        node: self,
                                        dragEvent: evt
                                    });
                                },
                                onDragOver: (evt)=>{
                                    evt.dataTransfer.dropEffect = "none";

                                    if(hoverStartTime === -1) {
                                        hoverStartTime = Date.now();
                                    }

                                    let hoverTime = Date.now() - hoverStartTime;

                                    if(hoverTime > 1000) {
                                        self.unfold();
                                    }

                                    EventSystem.triggerEvent("TreeBrowser.TreeNode.DragOver", {
                                        node: self,
                                        dragEvent: evt
                                    });
                                },
                                onDrop: (evt, dropEffect)=>{
                                    let otherWebstrate = null;

                                    if(evt.dataTransfer.types.includes("treenode/href")) {
                                        otherWebstrate = evt.dataTransfer.getData("treenode/href");
                                    }

                                    if(evt.dataTransfer.types.includes("treenode/uuid")) {
                                        try {
                                            let dragUUID = evt.dataTransfer.getData("treenode/uuid");
                                            let dragged = document.querySelector("[transient-drag-id='" + dragUUID + "']");
                                            if (dragged != null && dragged.treeNode != null) {
                                                EventSystem.triggerEvent("TreeBrowser.TreeNode.Dropped", {
                                                    draggedNode: dragged.treeNode,
                                                    droppedNode: self,
                                                    dropEffect: dropEffect,
                                                    otherWebstrate: otherWebstrate,
                                                    dragEvent: evt
                                                });
                                                return;
                                            }
                                        } catch(e) {
                                            console.log("Error accepting drop as treenode/uuid", );
                                        }
                                    }

                                    if(evt.dataTransfer.types.includes("Files")) {
                                        try {
                                            EventSystem.triggerEvent("TreeBrowser.Files.Dropped", {
                                                files: evt.dataTransfer.files,
                                                droppedNode: self,
                                                otherWebstrate: otherWebstrate,
                                                dragEvent: evt
                                            });

                                            return;
                                        } catch(e) {
                                            console.log("Error accepting drop as Files", e);
                                        }
                                    }

                                    if(evt.dataTransfer.types.includes("treenode/asset")) {
                                        try {
                                            let assetUrl = evt.dataTransfer.getData("treenode/asset");
                                            EventSystem.triggerEvent("TreeBrowser.Asset.Dropped", {
                                                assetUrl: assetUrl,
                                                droppedNode: self,
                                                otherWebstrate: otherWebstrate,
                                                dragEvent: evt
                                            });

                                            return;
                                        } catch(e) {
                                            console.log("Error accepting drop as Asset", e);
                                        }
                                    }

                                    if(evt.dataTransfer.types.includes("text/plain")) {
                                        try {
                                            let text = evt.dataTransfer.getData("text/plain");

                                            let tpl = document.createElement("template");
                                            tpl.innerHTML = text;

                                            WPMv2.stripProtection(tpl.content);

                                            EventSystem.triggerEvent("TreeBrowser.DomFragment.Dropped", {
                                                fragment: tpl.content,
                                                droppedNode: self,
                                                otherWebstrate: otherWebstrate,
                                                dragEvent: evt
                                            });

                                            return;
                                        } catch(e) {
                                            console.log("Error accepting drop as text/plain", e);
                                        }
                                    }

                                    console.log("No supported data transfers:", evt.dataTransfer.types.slice());

                                    evt.dataTransfer.types.forEach((type)=>{
                                        console.log(type, evt.dataTransfer.getData(type));
                                    });
                                }
                            });
                        }

                        /**
                         * @private
                         */
                        setupClickListeners() {
                            let self = this;
                            this.html.addEventListener("dblclick", ()=>{
                                self.triggerAction();
                            });
                        }

                        /**
                         * Trigger the action listeners of this TreeNode
                         */
                        triggerAction() {
                            let preventDefault = EventSystem.triggerEvent("TreeBrowser.TreeNode.Action", {
                                node: this,
                                treeBrowser: this.getTreeBrowser()
                            });

                            if(!preventDefault && !this.alwaysOpen) {
                                this.toggleFold();
                            }
                        }

                        registerOnDecoratedCallback(callback) {
                            this.onDecoratedCallbacks.add(callback);
                        }

                        deregisterOnDecoratedCallback(callback) {
                            this.onDecoratedCallbacks.delete(callback);
                        }

                        setupMetaMenu() {
                            this.metaMenu = MenuSystem.MenuManager.createMenu("TreeBrowser.TreeNode.MetaMenu", {
                                context: this.context,
                                keepOpen: true,
                                layoutDirection: MenuSystem.Menu.LayoutDirection.HORIZONTAL,
                                layoutWrapping: false,
                                layoutCompact: true,
                                defaultFocusState: mdc.menu.DefaultFocusState.NONE
                            });

                            this.addMetaIcon(this.metaMenu.html);
                        }
                    }

                    window.TreeNode = TreeNode;

                    </SCRIPT><SCRIPT id="TreeGenerator-script" type="disabled">
                    /**
                     *  TreeGenerator
                     *  Superclass for generators of trees
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A generator that builds trees from some context
                     * @abstract
                     */
                    class TreeGenerator {
                        /**
                         * Create a new TreeGenerator
                         */
                        constructor() {
                            this.treeNodeLookup = new Map();
                        }

                        /**
                         * Lookup the TreeNode associated with lookupKey
                         * @param {*} lookupKey
                         * @returns {TreeNode} The found TreeNode or null if no TreeNode could be found
                         * @protected
                         */
                        lookupTreeNode(lookupKey) {
                            return this.treeNodeLookup.get(lookupKey);
                        }

                        /**
                         * Save the reference from lookupKey to TreeNode
                         * @param {TreeNode} node - The TreeNode to save
                         * @protected
                         */
                        saveTreeNode(node) {
                            this.treeNodeLookup.set(node.lookupKey, node);
                        }

                        /**
                         * Remove the reference from lookupKey to TreeNode
                         * @param {TreeNode} node
                         * @protected
                         */
                        deleteTreeNode(node) {
                            let self = this;

                            this.treeNodeLookup.delete(node.lookupKey);

                            node.childNodes.forEach((child)=>{
                                self.deleteTreeNode((child));
                            });
                        }

                        /**
                         * Runs through all registered decorators and tries to decorate the given node, the first decorator to do something wins.
                         * @param {TreeNode} node - The TreeNode to decorate
                         * @protected
                         */
                        static decorateNode(node) {
                            for(let decorator of TreeGenerator.decorators) {
                                if(typeof decorator.decorator.decorate === "function" && decorator.decorator.decorate(node)) {
                                    //First decorator that decorates our node, wins!
                                    node.onDecorated();
                                    break;
                                }
                            }
                        }

                        /**
                         * Runs through all registered decorators and gives them a chance to add DataFlavors to the given dnd DataTransfer
                         * @param {TreeNode} node
                         * @param {DataTransfer} dataTransfer
                         */
                        static decorateDataTransfers(node, dataTransfer) {
                            for(let decorator of TreeGenerator.decorators) {
                                if(typeof decorator.decorator.decorateDataTransfer === "function" && decorator.decorator.decorateDataTransfer(node, dataTransfer)) {
                                    break;
                                }
                            }
                        }

                        /**
                         * Register a decorator
                         * @param decorator
                         * @param {Number} priority
                         */
                        static registerDecorator(decorator, priority) {
                            TreeGenerator.decorators.push({
                                decorator: decorator,
                                priority: priority
                            });

                            //Sort decorators according to priority
                            TreeGenerator.decorators.sort((i1, i2)=>{
                                return i2.priority - i1.priority;
                            });
                        }
                    }

                    window.TreeGenerator = TreeGenerator;

                    TreeGenerator.decorators = [];

                    </SCRIPT><SCRIPT id="DomTreeGenerator-script" type="disabled">
                    /**
                     *  DOM Tree Generator
                     *  Generates trees based on DOM nodes
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate */

                    /**
                     * @typedef {Object} DomTreeGenerator~config
                     * @property {String[]} [includeRules] - An array of CSS selectors that represents what should be included even if excluded or transient. If empty, everything that is not excluded will be included.
                     * @property {String[]} [excludeRules] - An array of CSS selectors that represents what should be excluded.
                     * @property {boolean} [includeWebstrateTransients=false] - Should webstrate transient elements be included true/false
                     * @property {boolean} [live=true] - Is the Tree live, ie. does changes to the dom reflect in the tree.
                     */

                    /**
                     * DomTreeGenerator can traverse DOM and generate TreeNode trees from the visited DOM Nodes
                     */
                    class DomTreeGenerator extends TreeGenerator {
                        /**
                         * Create a new DomTreeGenerator with the given configuration
                         * @param {DomTreeGenerator~config}config
                         */
                        constructor(config) {
                            super();

                            this.excludeRules = WebstrateComponents.Tools.fromConfig(config, "excludeRules", []);
                            this.includeRules = WebstrateComponents.Tools.fromConfig(config, "includeRules", []);

                            //Hardcode that .tree-browser is not observed, could lead to nasty infinite loops if not?
                            if(this.excludeRules.indexOf(".tree-browser") === -1) {
                                this.excludeRules.push(".tree-browser");
                            }

                            this.includeWebstrateTransients = WebstrateComponents.Tools.fromConfig(config, "includeWebstrateTransients", false);

                            this.live = WebstrateComponents.Tools.fromConfig(config, "live", true);

                            if(this.live) {
                                this.setupObserver();
                            }
                        }

                        /**
                         * Start generation of a tree
                         * @param {Element} root - The element to use as the root for this tree
                         * @returns {TreeNode}
                         */
                        generateTree(root) {
                            let self = this;

                            let node = new TreeNode({
                                type: "DomTreeNode",
                                context: root
                            });

                            this.saveTreeNode(node);

                            TreeGenerator.decorateNode(node);

                            Array.from(root.children).forEach((child)=>{
                                if(self.shouldInclude(child)) {
                                    let childNode = self.generateTree(child);
                                    node.addNode(childNode, self.findChildIndex(child));
                                }
                            });

                            return node;
                        }

                        /**
                         * Checks if the given HTML element should be included in the tree
                         * @param {Element} node
                         * @returns {boolean}
                         * @private
                         */
                        shouldInclude(node) {
                            for(let includeRule of this.includeRules) {
                                if(node.matches(includeRule)) {
                                    return true;
                                }
                            }

                            for(let excludeRule of this.excludeRules) {
                                if(node.matches(excludeRule)) {
                                    return false;
                                }
                            }

                            if((typeof webstrate !== "undefined") && !this.includeWebstrateTransients) {
                                if(webstrate.config.isTransientElement(node)) {
                                    return false;
                                }
                            }

                            if(this.includeRules.length === 0) {
                                return true;
                            } else {
                                return false;
                            }
                        }

                        /**
                         * Returns the child index the given node has in its parents children NodeList
                         * @param {Element} node
                         * @returns {number}
                         * @private
                         */
                        findChildIndex(node) {
                            let parent = node.parentNode;

                            if(parent != null) {
                                let i = 0;
                                for(let child of parent.children) {
                                    if(this.shouldInclude(child)) {
                                        if(child === node) {
                                            return i;
                                        }

                                        i++;
                                    }
                                }
                            }

                            return -1;
                        }

                        /**
                         * Setup the Live observer
                         * @private
                         */
                        setupObserver() {
                            let self = this;

                            let observer = new MutationObserver((mutations) => {
                                mutations.forEach((mutation) => {
                                    let targetTreeNode = self.lookupTreeNode(mutation.target);

                                    mutation.removedNodes.forEach((removedNode) => {
                                        if(removedNode instanceof Element) {
                                            //Removed node
                                            let removedTreeNode = self.lookupTreeNode(removedNode);
                                            if (removedTreeNode != null) {
                                                self.deleteTreeNode(removedTreeNode);
                                                removedTreeNode.onRemoved();
                                                if (targetTreeNode != null) {
                                                    targetTreeNode.removeNode(removedTreeNode);
                                                }
                                            }
                                        }
                                    });
                                    mutation.addedNodes.forEach((addedNode) => {
                                        if(addedNode instanceof Element) {
                                            if (targetTreeNode != null) {
                                                if (self.shouldInclude(addedNode)) {
                                                    //Check if node is already added to the tree
                                                    if(self.lookupTreeNode(addedNode) == null) {
                                                        //Added children to a treeNode
                                                        let addedTreeNode = self.generateTree(addedNode);
                                                        targetTreeNode.addNode(addedTreeNode, self.findChildIndex(addedNode));
                                                    }
                                                }
                                            }
                                        }
                                    });

                                    if(targetTreeNode != null) {
                                        TreeGenerator.decorateNode(targetTreeNode);
                                    }
                                });
                            });

                            observer.observe(document, {
                                childList: true,
                                attributes: true,
                                subtree: true,
                                characterData: true
                            });
                        }
                    }

                    window.DomTreeGenerator = DomTreeGenerator;

                    </SCRIPT><SCRIPT id="AssetTreeGenerator-script" type="disabled">
                    /**
                     *  Asset Tree Generator
                     *  Generates trees based on assets uploaded to a Webstrate
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    class AssetTreeGenerator extends TreeGenerator {
                        constructor(config) {
                            super();

                            this.live = WebstrateComponents.Tools.fromConfig(config, "live", true);

                            if(this.live) {
                                this.setupObserver();
                            }

                            this.rootNode = null;
                        }

                        generateTree() {
                            let self = this;

                            this.rootNode = new TreeNode({
                                type: "AssetRootNode",
                                context: null
                            });
                            if(webstrate != null && webstrate.assets && webstrate.assets.forEach!=null) {

                                let filteredAssets = new Map();

                                webstrate.assets.forEach((asset)=>{
                                    if(filteredAssets.has(asset.fileName)) {
                                        let oldAsset = filteredAssets.get(asset.fileName);

                                        if(asset.v > oldAsset.v) {
                                            filteredAssets.set(asset.fileName, asset);
                                        }
                                    } else {
                                        filteredAssets.set(asset.fileName, asset);
                                    }
                                });

                                let sortedArray = Array.from(filteredAssets.values()).sort((a1, a2)=>{
                                    return a1.fileName.localeCompare(a2.fileName);
                                });

                                sortedArray.forEach((asset)=>{
                                    if(asset.deletedAt != null) {
                                        //Deleted asset, skip
                                        return;
                                    }

                                    let treeNode = AssetTreeGenerator.createNodeFromAsset(asset);

                                    self.rootNode.addNode(treeNode, self.findAssetIndex(asset));

                                    self.saveTreeNode(treeNode);
                                });
                            }

                            TreeGenerator.decorateNode(this.rootNode);

                            return this.rootNode;
                        }

                        /**
                         * Create a TreeNode from an asset json
                         * @param {JSON} asset
                         * @returns {TreeNode}
                         * @private
                         */
                        static createNodeFromAsset(asset) {
                            let assetNode = null;
                            if (asset.fileName.endsWith(".zip")){
                                assetNode = new TreeNode({
                                    lookupKey: asset.fileName,
                                    context: asset,
                                    type: "AssetContainer"
                                });

                                // Explore the first zip level
                                AssetTreeGenerator.exploreZipLevel(assetNode);
                            } else {
                                assetNode = new TreeNode({
                                    lookupKey: asset.fileName,
                                    context: asset,
                                    type: "AssetNode"
                                });
                            }

                            TreeGenerator.decorateNode(assetNode);

                            return assetNode;
                        }

                        /**
                         * Finds an asset with the given name
                         * @param {string} assetName
                         * @returns {JSON} - The found asset
                         */
                        static findAssetFromName(assetName) {
                            let filteredAssets = new Map();
                            if (webstrate && webstrate.assets && webstrate.assets.forEach){
                                webstrate.assets.forEach((asset)=>{
                                    if(filteredAssets.has(asset.fileName)) {
                                        let oldAsset = filteredAssets.get(asset.fileName);

                                        if(asset.v > oldAsset.v) {
                                            filteredAssets.set(asset.fileName, asset);
                                        }
                                    } else {
                                        filteredAssets.set(asset.fileName, asset);
                                    }
                                });
                                return filteredAssets.get(assetName);
                            } else {
                                return null;
                            }

                        }

                        /**
                         * Returns the index of this asset
                         * @param {JSON} asset
                         * @returns {number}
                         * @private
                         */
                        findAssetIndex(asset) {
                            let filteredAssets = new Map();

                            webstrate.assets.forEach((asset)=>{
                                if(filteredAssets.has(asset.fileName)) {
                                    let oldAsset = filteredAssets.get(asset.fileName);

                                    if(asset.v > oldAsset.v) {
                                        filteredAssets.set(asset.fileName, asset);
                                    }
                                } else {
                                    filteredAssets.set(asset.fileName, asset);
                                }
                            });

                            let sortedArray = Array.from(filteredAssets.keys()).sort((a1, a2)=>{
                                return a1.localeCompare(a2);
                            });

                            return sortedArray.indexOf(asset.fileName);
                        }

                        setupObserver() {
                            let self = this;

                            if(webstrate != null) {
                                webstrate.on("asset", (asset)=>{
                                    console.log("Asset event:", asset);

                                    let oldTreeNode = self.lookupTreeNode(asset.fileName);

                                    if(oldTreeNode == null) {
                                        //New asset, just add
                                        self.rootNode.addNode(AssetTreeGenerator.createNodeFromAsset(asset), self.findAssetIndex(asset));
                                    } else {
                                        //Already existed, update context and redocorate
                                        oldTreeNode.context = asset;
                                        TreeGenerator.decorateNode(oldTreeNode);
                                    }
                                });
                            }
                        }

                        static exploreZipLevel(assetNode){
                            // TODO: For now it explores the entire zip

                            var xhr = new XMLHttpRequest();
                            xhr.open('GET', assetNode.context.fileName+"/?dir", true);
                            xhr.responseType = 'json';
                            xhr.onload = function() {
                                var status = xhr.status;
                                if (status === 200) {
                                    xhr.response.forEach((entry)=>{
                                        if (!entry.endsWith("/")){
                                            let node = new TreeNode({
                                                lookupKey: assetNode.context.fileName,
                                                context: {
                                                    fileName: assetNode.context.fileName+"/"+entry,
                                                    v: 0
                                                },
                                                type: "AssetNode"
                                            });
                                            TreeGenerator.decorateNode(node);
                                            assetNode.addNode(node);
                                        }
                                    });
                                } else {
                                    console.log("Couldn't unzip zip");
                                }
                            };
                            xhr.send();
                        }
                    }

                    window.AssetTreeGenerator = AssetTreeGenerator;

                    </SCRIPT><SCRIPT id="TreeBrowserHtmlDecorator-script" type="disabled">
                    /**
                     *  HTML Decorator
                     *  Decorates HTML nodes in a tree
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Decorator that decorates HTML elements
                     */
                    class TreeBrowserHtmlDecorator {
                        /**
                         * Attempts to decorate the given TreeNode
                         * @param {TreeNode} node - The node to decorate
                         * @returns {boolean} True/False depending on if the node was decorated
                         */
                        static decorate(node) {
                            if(node.type === "DomTreeNode") {

                                let id = (node.context.id!=null && node.context.id.trim().length > 0)?" #"+node.context.id:"";
                                let name = (node.context.getAttribute("name")!=null && node.context.getAttribute("name").trim().length > 0)?" "+node.context.getAttribute("name"):"";

                                node.setProperty("content", node.context.tagName.toLowerCase()+id+name);
                                node.setProperty("tooltip", "HTML DOM Element");
                                let icon = null;
                                switch (node.context.tagName.toLowerCase()){
                                    case "body":
                                        icon = IconRegistry.createIcon("mdc:accessibility_new");
                                        break;
                                    case "script":
                                        icon = IconRegistry.createIcon("mdc:code");
                                        break;
                                    case "style":
                                        icon = IconRegistry.createIcon("mdc:brush");
                                        break;
                                    case "ol":
                                    case "ul":
                                        icon = IconRegistry.createIcon("mdc:list");
                                        break;
                                    default:
                                        icon = IconRegistry.createIcon("mdc:html");
                                        break;

                                }
                                node.setProperty("icon", icon);
                                return true;
                            }

                            return false;
                        }

                        /**
                         * Attempts to decorate the given DataTransfer based on the given TreeNode
                         * @param {TreeNode} node
                         * @param {DataTransfer} dataTransfer
                         * @returns {boolean} True/False depending on if the DataTransfer was decorated
                         */
                        static decorateDataTransfer(node, dataTransfer) {
                            if(node.type === "DomTreeNode") {
                                dataTransfer.setData("text/plain", node.context.outerHTML);

                                return true;
                            }

                            return false;
                        }
                    }

                    window.TreeBrowserHtmlDecorator = TreeBrowserHtmlDecorator;

                    TreeGenerator.registerDecorator(TreeBrowserHtmlDecorator, 0);

                    </SCRIPT><SCRIPT id="TreeBrowserFragmentDecorator-script" type="disabled">
                    /**
                     *  Fragment Decorator
                     *  Decorates Codestrate Fragments in a tree
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Decorator that decorates Codestrate fragments
                     */
                    class TreeBrowserFragmentDecorator {
                        /**
                         * Attempts to decorate the given TreeNode
                         * @param {TreeNode} node - The node to decorate
                         * @returns {boolean} True/False depending on if the node was decorated
                         */
                        static decorate(node) {
                            if(node.type === "DomTreeNode") {
                                if(node.context.matches("code-folder")){
                                    // Set open/closed icons in the default case
                                    let iconNode = document.createElement("span");
                                    let closedNode = IconRegistry.createIcon("mdc:folder");
                                    closedNode.classList.add("tree-browser-icon-closed");
                                    iconNode.appendChild(closedNode);
                                    let unfoldedNode = IconRegistry.createIcon("mdc:folder_open");
                                    unfoldedNode.classList.add("tree-browser-icon-unfolded");
                                    iconNode.appendChild(unfoldedNode);
                                    node.setProperty("icon", iconNode);
                                    let content = "Unnamed Folder";
                                    let name = node.context.getAttribute("name");
                                    if (name != null && name != ""){
                                        content = name+" ";
                                    }
                                    if(node.context.id != null && node.context.id!="") {
                                        content += "#"+node.context.id;
                                    }
                                    node.setProperty("content", content);
                                    node.setProperty("tooltip", "Folder");
                                    return true;
                                }
                                if(node.context.matches("code-fragment")) {
                                    let content = "";
                                    let name = node.context.getAttribute("name");
                                    if (name != null && name != ""){
                                        content = name+" ";
                                    }
                                    if(node.context.id != null && node.context.id!="") {
                                        content += "#"+node.context.id;
                                    }
                                    if (!content){
                                        content = node.context.tagName.toLowerCase();

                                        if(typeof cQuery !== "undefined") {
                                            let fragment = cQuery(node.context).data("Fragment");

                                            if(fragment != null) {
                                                content = fragment.constructor.name;
                                            }
                                        }
                                    }
                                    let type = node.context.getAttribute("data-type");

                                    // Find a proper icon either from an icon provider or a default one
                                    node.setProperty("icon", IconRegistry.createIcon(["code-fragment:"+type, "mdc:insert_drive_file"]));
                                    node.setProperty("content", content);
                                    node.setProperty("tooltip", node.context.tagName.toLowerCase()+" ("+type+")");

                                    if(node.context.getAttribute("auto") != null) {
                                        node.setProperty("modifier-a", IconRegistry.createIcon(["A", "mdc:play_circle_outline"]));
                                    } else {
                                        node.setProperty("modifier-a", null);
                                    }

                                    return true;
                                }
                            }

                            return false;
                        }
                    }

                    window.TreeBrowserFragmentDecorator = TreeBrowserFragmentDecorator;

                    TreeGenerator.registerDecorator(TreeBrowserFragmentDecorator, 10);

                    </SCRIPT><SCRIPT id="TreeBrowserAssetDecorator-script" type="disabled">
                    /**
                     *  Asset Decorator
                     *  Decorates Asset nodes in a tree
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Decorator that decorates Assets
                     */
                    class TreeBrowserAssetDecorator {
                        /**
                         * Attempts to decorate the given TreeNode
                         * @param {TreeNode} node - The node to decorate
                         * @returns {boolean} True/False depending on if the node was decorated
                         */
                        static decorate(node) {
                            if(node.type === "AssetNode") {
                                let version = " v"+node.context.v;
                                node.setProperty("content", node.context.fileName+version);
                                node.setProperty("icon", IconRegistry.createIcon("mdc:attachment"));
                                return true;
                            } else if(node.type === "AssetContainer") {
                                let version = " v"+node.context.v;
                                let iconNode = document.createElement("div");
                                iconNode.classList.add("tree-browser-custom-icon");
                                let icon = IconRegistry.createIcon("mdc:work_outline");
                                icon.classList.add("tree-browser-icon-closed");
                                iconNode.appendChild(icon);
                                icon = IconRegistry.createIcon("mdc:work");
                                icon.classList.add("tree-browser-icon-unfolded");
                                iconNode.appendChild(icon);
                                node.setProperty("content", node.context.fileName+version);
                                node.setProperty("icon", iconNode);
                                return true;
                            } else if(node.type === "AssetRootNode") {
                                node.setProperty("content", "Assets");
                                node.setProperty("icon", IconRegistry.createIcon("mdc:cloud"));
                                return true;
                            }

                            return false;
                        }

                        /**
                         * Attempts to decorate the given DataTransfer based on the given TreeNode
                         * @param {TreeNode} node
                         * @param {DataTransfer} dataTransfer
                         * @returns {boolean} True/False depending on if the DataTransfer was decorated
                         */
                        static decorateDataTransfer(node, dataTransfer) {
                            if(node.type === "AssetNode") {
                                let uri = location.href + node.context.fileName;
                                dataTransfer.setData("treenode/asset", uri);
                                dataTransfer.setData("text/uri-list", uri);
                                dataTransfer.setData("text/plain", uri);
                                return true;
                            }

                            return false;
                        }
                    }

                    window.TreeBrowserAssetDecorator = TreeBrowserAssetDecorator;

                    TreeGenerator.registerDecorator(TreeBrowserAssetDecorator, 10);

                    </SCRIPT><SCRIPT id="TreeBrowserWPMDecorator-script" type="disabled">
                    /**
                     *  WPM Decorator
                     *  Handles decoration of WPM package nodes in a tree
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Decorator that decorates HTML elements
                     */
                    class TreeBrowserWPMDecorator {
                        /**
                         * Attempts to decorate the given TreeNode
                         * @param {TreeNode} node - The node to decorate
                         * @returns {boolean} True/False depending on if the node was decorated
                         */
                        static decorate(node) {
                            if(node.type === "DomTreeNode" && node.context.matches("wpm-package")) {
                                let id = (node.context.id!=null && node.context.id.trim().length > 0)?" #"+node.context.id:"";
                                node.setProperty("content", node.context.tagName.toLowerCase() + id);

                                // TODO: add disabled/live state to classes

                                let assetRootNode = node.assetRootNode;

                                node.childNodes.forEach((child)=>{
                                    if(child.type === "AssetRootNode") {
                                        assetRootNode = child;
                                    }
                                });

                                let descriptor = node.context.querySelector("code-fragment[data-type='wpm/descriptor']");

                                if(descriptor != null && typeof cQuery !== "undefined") {
                                    let descFrag = cQuery(descriptor).data("Fragment");

                                    if(descFrag != null) {

                                        if(assetRootNode == null) {
                                            assetRootNode = new TreeNode({
                                                type: "AssetRootNode"
                                            });
                                            TreeGenerator.decorateNode(assetRootNode);

                                            node.assetRootNode = assetRootNode;

                                            //Setup event to look for asset updates

                                            let self = this;

                                            if(webstrate != null) {
                                                webstrate.on("asset", (asset)=>{
                                                    updateAssets();
                                                });
                                            }

                                            function updateAssets() {
                                                if(assetRootNode != null && descFrag != null) {
                                                    assetRootNode.clearNodes();

                                                    descFrag.require().then((descJson) => {
                                                        descJson.assets.forEach((assetJson) => {
                                                            if (typeof assetJson === "string") {
                                                                let asset = AssetTreeGenerator.findAssetFromName(assetJson);
                                                                if (asset != null) {
                                                                    let assetNode = AssetTreeGenerator.createNodeFromAsset(asset);
                                                                    assetRootNode.addNode(assetNode);
                                                                }
                                                            }
                                                        });

                                                        if (assetRootNode.isLeaf()) {
                                                            node.removeNode(assetRootNode);
                                                        } else {
                                                            node.addNode(assetRootNode, 9999);
                                                            assetRootNode.render();
                                                        }
                                                    });
                                                }
                                            }

                                            descFrag.registerOnFragmentChangedHandler(()=>{
                                                updateAssets();
                                            });

                                            updateAssets();
                                        }
                                    }
                                } else {
                                    if(assetRootNode != null) {
                                        node.removeNode(assetRootNode);
                                        node.assetRootNode = null;
                                        assetRootNode = null;
                                    }
                                }

                                // Set open/closed icons in the default case
                                let iconNode = document.createElement("span");
                                iconNode.classList.add("tree-browser-custom-icon");

                                let icon = IconRegistry.createIcon(["webstrates:wpm-package-closed", "mdc:insert_drive_file"]);
                                icon.classList.add("tree-browser-icon-closed");
                                iconNode.appendChild(icon);
                                icon = IconRegistry.createIcon(["webstrates:wpm-package-open", "mdc:insert_drive_file"]);
                                icon.classList.add("tree-browser-icon-unfolded");
                                iconNode.appendChild(icon);

                                node.setProperty("icon", iconNode);
                                return true;
                            }

                            //Hide wpm-descriptor inside descriptor code-fragment
                            if(node.type === "DomTreeNode" && node.context.matches("wpm-descriptor")) {
                                if(node.context.parentNode != null && node.context.parentNode.matches("code-fragment[data-type='wpm/descriptor']")) {
                                    node.hideSelf = true;
                                }
                            }

                            return false;
                        }
                    }

                    window.TreeBrowserWPMDecorator = TreeBrowserWPMDecorator;

                    TreeGenerator.registerDecorator(TreeBrowserWPMDecorator, 10);

                    </SCRIPT><TEMPLATE id="TreeBrowser_Main">
                        <UL class="mdc-list tree-browser tree-browser-root" role="list">
                        </UL>
                    </TEMPLATE><TEMPLATE id="TreeBrowser_Leaf">
                        <LI tabindex="-1" class="mdc-list-item tree-browser-leaf tree-browser-node">
                            <DIV class="rippley"><SPAN class="mdc-list-item__ripple"></SPAN></DIV>
                            <SPAN class="mdc-list-item__graphic tree-browser-navigator" aria-hidden="true"></SPAN>
                            <SPAN class="mdc-list-item__graphic tree-browser-icons" aria-hidden="true"></SPAN>
                            <SPAN class="mdc-list-item__text tree-browser-content"></SPAN>
                            <SPAN aria-hidden="true" class="mdc-list-item__meta"></SPAN>
                        </LI>
                    </TEMPLATE><TEMPLATE id="TreeBrowser_Children">
                        <LI class="tree-browser-children">
                            <UL class="mdc-list tree-browser" role="list">
                            </UL>
                        </LI>
                    </TEMPLATE><TEMPLATE id="TreeBrowser_Modifier">
                        <SPAN class="tree-browser-modifier" aria-hidden="true"></SPAN>
                    </TEMPLATE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="ModalDialog" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Modal Dialog",
                        "description": "Generic Modal Dialog",
                        "dependencies": [
                            "wpm_js_libs #material-design-components",
                            "wpm_js_libs #material-design-icons",
                            "wpm_js_libs #UUIDGenerator",
                            "#WebstrateComponents_Tools",
                            "codestrates-repos #EventSystem"
                        ],
                        "assets": [
                        ],
                        "version": "1.0",
                        "license": "Apache 2.0",
                        "changelog": {
                            "1.0": "Initial version"
                        }
                    }

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  Modal styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .wc-modal-dialog {
                      z-index: 9000; }
                      .wc-modal-dialog .mdc-dialog__surface {
                        max-width: 95%; }
                      .wc-modal-dialog .mdc-dialog__content.flexcontent {
                        display: flex;
                        padding: 0; }
                      .wc-modal-dialog.wc-modal-maximized .mdc-dialog__container {
                        min-width: 85%; }
                        .wc-modal-dialog.wc-modal-maximized .mdc-dialog__container .mdc-dialog__surface {
                          min-width: 100%;
                          height: 100%; }
                    </STYLE><SCRIPT id="ModalDialog-script" type="disabled">
                    /**
                     *  Modal
                     *  Provides a way to open modal dialogs
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global mdc */

                    /**
                     * @typedef {Object} ModalDialog~ModalDialogOptions
                     * @property {string} [title=""] - The dialog title
                     * @property {boolean} [closeOnOutsideClick=true] - Automatically close the dialog when clicking outside the dialog
                     * @property {boolean} [closeOnEscape=true] - Automatically close the dialog when ESCAPE is pressed
                     * @property {boolean} [autoStackButtons=true] - Automatically stack buttons if they do not fit horizontally
                     */

                    /**
                     * Modal component using MDCDialog as a framework
                     */
                    class ModalDialog {

                        /**
                         * Creates a new ModalDialog
                         * @param {Node} content - The content to place inside the Dialog
                         * @param {ModalDialog~ModalDialogOptions} [options]
                         */
                        constructor(content, options = {}) {
                            const self = this;

                            const defaultOptions = {
                                title: "",
                                classes: [],
                                closeOnOutsideClick: true,
                                closeOnEscape: true,
                                autoStackButtons: true,
                                maximize: false,
                                flexContent: false,
                                actions: {}
                            };

                            this.uuid = UUIDGenerator.generateUUID("dialog-");

                            this.options = Object.assign({}, defaultOptions, options);

                            this.html = WebstrateComponents.Tools.loadTemplate("#webstrate-components-modal-dialog-tpl");

                            this.title = this.html.querySelector(".mdc-dialog__title");
                            this.content = this.html.querySelector(".mdc-dialog__content");
                            this.actions = this.html.querySelector(".mdc-dialog__actions");

                            this.title.id = this.uuid + "-title";
                            this.content.id = this.uuid + "-content";

                            this.html.querySelector(".mdc-dialog__surface").setAttribute("aria-labelledby", this.title.id);
                            this.html.querySelector(".mdc-dialog__surface").setAttribute("aria-describedby", this.content.id);

                            // Action buttons
                            if (this.options.actions === null || Object.keys(this.options.actions).length===0){
                                    this.actions.remove();
                            } else {
                                    for (const [action, actionOptions] of Object.entries(this.options.actions)) {
                                            let actionButton = document.createElement("button");
                                            actionButton.classList.add("mdc-button");
                                            actionButton.classList.add("mdc-dialog__button");
                                            if (actionOptions.primary){
                                                    actionButton.classList.add("mdc-button--raised");
                                            }
                                            actionButton.setAttribute("data-mdc-dialog-action", action);

                                            if (actionOptions.mdcIcon){
                                                    let icon = document.createElement("i");
                                                    icon.classList.add("material-icons");
                                                    icon.classList.add("mdc-button__icon");
                                                    icon.innerText = actionOptions.mdcIcon;
                                                    actionButton.appendChild(icon);
                                            }

                                            let ripple = document.createElement("div");
                                            ripple.classList.add("mdc-button__ripple");
                                            actionButton.appendChild(ripple);

                                            let label = document.createElement("span");
                                            label.classList.add("mdc-button__label");
                                            if (actionOptions.label){
                                                    label.innerText = actionOptions.label;
                                            } else {
                                                    label.innerText = action;
                                            }
                                            actionButton.append(label);

                                            this.actions.appendChild(actionButton);
                                    }
                            }

                            if (this.options.flexContent){
                                this.content.classList.add("flexcontent");
                            }
                            this.content.appendChild(content);
                            if(this.options.title != null && this.options.title.trim() !== "") {
                                this.title.textContent = this.options.title.trim();
                            } else {
                                this.title.remove();
                            }

                            if(this.options.classes != null) {
                                let classes = this.options.classes;
                                if(!Array.isArray(classes)) {
                                    classes = [classes];
                                }

                                classes.forEach((c)=>{
                                    this.html.classList.add(c);
                                });
                            }

                            if (this.options.maximize){
                                this.html.classList.add("wc-modal-maximized");
                            }

                            this.dialog = new mdc.dialog.MDCDialog(this.html);

                            //Dont add anything to body!
                            this.dialog.foundation.adapter.addBodyClass = ()=>{};

                            this.dialog.autoStackButtons = this.options.autoStackButtons;

                            if(!this.options.closeOnEscape) {
                                this.dialog.escapeKeyAction = "";
                            }

                            if(!this.options.closeOnOutsideClick) {
                                this.dialog.scrimClickAction = "";
                            }

                            this.dialog.listen("MDCDialog:opening", (evt)=>{
                                EventSystem.triggerEvent("ModalDialog.Opening", {
                                    dialog: self
                                });
                            });

                            this.dialog.listen("MDCDialog:opened", (evt)=>{
                                EventSystem.triggerEvent("ModalDialog.Opened", {
                                    dialog: self
                                });
                            });

                            this.dialog.listen("MDCDialog:closing", (evt)=>{
                                EventSystem.triggerEvent("ModalDialog.Closing", {
                                    dialog: self,
                                    action: evt.detail.action
                                });
                            });

                            this.dialog.listen("MDCDialog:closed", (evt)=>{
                                EventSystem.triggerEvent("ModalDialog.Closed", {
                                    dialog: self,
                                    action: evt.detail.action
                                });
                            });

                            mdc.autoInit(this.html);
                        }

                        open() {
                            this.dialog.open();
                        }

                        close(action = null) {
                            this.dialog.close(action);
                        }
                    }

                    window.WebstrateComponents.ModalDialog = ModalDialog;

                    </SCRIPT><TEMPLATE id="webstrate-components-modal-dialog-tpl">
                        <DIV class="wc-modal-dialog mdc-dialog">
                            <DIV class="mdc-dialog__container">
                                <DIV class="mdc-dialog__surface" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title" aria-describedby="my-dialog-content">
                                    <H2 class="mdc-dialog__title" id="my-dialog-title"></H2>
                                    <DIV class="mdc-dialog__content" id="my-dialog-content"></DIV>
                                    <DIV class="mdc-dialog__actions"></DIV>
                                </DIV>
                            </DIV>
                            <DIV class="mdc-dialog__scrim"></DIV>
                        </DIV>
                    </TEMPLATE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="ButtonSystem_MaterialDesign" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Buttons",
                        "description": "Buttons for all",
                        "dependencies": [
                            "#WebstrateComponents_Tools",
                            "#ButtonSystem"
                        ],
                        "assets": [
                        ],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="buttons-material-script" type="disabled">
                    /**
                     *  Material Buttons
                     *  Provides MDC buttons
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Provides MDC buttons
                     */
                    ButtonSystem.MaterialBuilder = class MaterialBuilder {
                        static buildButton(button) {
                            let buttonHtml = WebstrateComponents.Tools.loadTemplate("ButtonSystem_MaterialDesign_Button");

                            buttonHtml.querySelector(".mdc-button__label").textContent = button.text;

                            let buttonType = WebstrateComponents.Tools.fromConfig(button.options, "style", "text");

                            switch(buttonType) {
                                case "text":
                                    break;
                                case "outlined":
                                case "raised":
                                case "unelevated":
                                    buttonHtml.classList.add("mdc-button--"+buttonType);
                                    break;
                            }

                            let icon = WebstrateComponents.Tools.fromConfig(button.options, "icon", null);

                            if(icon != null) {
                                let filteredClasses = Array.from(icon.classList.values()).filter((c)=>{
                                    return c.startsWith("material-icons");
                                });
                                if(filteredClasses.length > 0) {
                                    icon.classList.add("mdc-button__icon");
                                }

                                if(WebstrateComponents.Tools.fromConfig(button.options, "iconTrailing", false)) {
                                    buttonHtml.appendChild(icon);
                                } else {
                                    buttonHtml.insertBefore(icon, buttonHtml.firstChild);
                                }
                            }

                            mdc.ripple.MDCRipple.attachTo(buttonHtml);

                            return buttonHtml;
                        }
                    }

                    ButtonSystem.ButtonFactory.setDefaultBuilder(ButtonSystem.MaterialBuilder);

                    </SCRIPT><TEMPLATE id="ButtonSystem_MaterialDesign_Button">
                        <BUTTON class="mdc-button"><SPAN class="mdc-button__ripple"></SPAN><SPAN class="mdc-button__label"></SPAN></BUTTON>
                    </TEMPLATE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="MaterialMenu" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "MaterialMenu",
                        "description": "MDC bindings for MenuSystem visualization",
                        "dependencies": [
                            "wpm_js_libs #material-design-components",
                            "wpm_js_libs #material-design-icons",
                            "#wsc-icon-registry",
                            "#MenuSystem"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="MaterialMenu-script" type="disabled">
                    /**
                     *  MaterialMenuBuilder
                     *  MDC binding for visual presentation of menus
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /*global mdc*/

                    window.MenuSystem.MaterialMenuBuilder = class MaterialMenuBuilder extends MenuSystem.MenuBuilder {
                        static buildMenuHtml(menu) {
                            let tpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_Menu");

                            //Setup MDC menu
                            tpl.mdcMenu =  new mdc.menu.MDCMenu(tpl);

                            if(menu.options.defaultFocusState != null) {
                                tpl.mdcMenu.setDefaultFocusState(menu.options.defaultFocusState);
                            }

                            //Hook mdc-menu-surface close
                            let origClose = tpl.mdcMenu.menuSurface.foundation.close;
                            tpl.mdcMenu.realClose = function () {
                                origClose.call(tpl.mdcMenu.menuSurface.foundation);
                            };
                            tpl.mdcMenu.menuSurface.foundation.close = function() {
                                //Empty on purpose
                            };

                            //Setup listeners
                            tpl.mdcMenu.listen("MDCMenu:selected", (evt)=>{
                                menu.handleItemAction(evt.detail.item.menuItem);
                            });

                            return tpl;
                        }

                        static buildMenuItemHtml(menuItem) {
                            let tpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem");

                            tpl.querySelector(".mdc-list-item__text").textContent = menuItem.label;
                            tpl.menuItem = menuItem;

                            if(menuItem.icon != null) {
                                let iconTpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem_Icon");
                                tpl.insertBefore(iconTpl, tpl.firstChild);
                                if(typeof menuItem.icon === "string") {
                                    iconTpl.textContent = menuItem.icon;
                                } else if(menuItem.icon instanceof HTMLElement || menuItem.icon instanceof SVGElement) {
                                    iconTpl.appendChild(menuItem.icon.cloneNode(true));
                                }
                            }

                            if(menuItem.metaIcon != null) {
                                let metaIconTpl = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_MenuItem_MetaIcon");
                                tpl.insertBefore(metaIconTpl, tpl.lastChild.nextSibling);
                                if(typeof menuItem.metaIcon === "string") {
                                    metaIconTpl.textContent = menuItem.metaIcon;
                                } else if(menuItem.metaIcon instanceof HTMLElement) {
                                    metaIconTpl.appendChild(menuItem.metaIcon.cloneNode(true));
                                }
                            }

                            if (menuItem.tooltip != null){
                                tpl.setAttribute("title", menuItem.tooltip);
                            }

                            mdc.ripple.MDCRipple.attachTo(tpl);

                            if (menuItem.checked != null){
                                // This is a toggle-able item, upgrade it with additional UI elements and update the state
                                let checkmarkTemplate = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_Checkmark");
                                tpl.insertBefore(checkmarkTemplate, tpl.lastChild.nextSibling);
                                tpl.classList.add("mdc-menu__selection-group");

                                let wrapper = document.createElement("div");
                                wrapper.classList.add("mdc-menu__selection-group");
                                wrapper.appendChild(tpl);
                                tpl = wrapper;
                            }
                            return tpl;
                        }

                        static clearMenuItems(menu) {
                            let menuItemInsertLocation = menu.html.querySelector(".mdc-list");
                            while(menuItemInsertLocation.lastChild) {
                                menuItemInsertLocation.removeChild(menuItemInsertLocation.lastChild);
                            }
                        }

                        static attachMenuItems(menu, groups) {
                            let menuItemInsertLocation = menu.html.querySelector(".mdc-list");

                            let first = true;

                            groups.forEach((group)=>{
                                if(first) {
                                    first = false;
                                } else {
                                    if(menu.groupDividers) {
                                        let groupDivider = WebstrateComponents.Tools.loadTemplate("MenuSystem_MaterialMenu_GroupDivider");
                                        menuItemInsertLocation.appendChild(groupDivider);
                                    }
                                }

                                group.forEach((item)=>{
                                    menuItemInsertLocation.appendChild(item.html);

                                    // Update checked status
                                    if (item.checked!==null){
                                        try {
                                            if (item.checked()){
                                                item.html.querySelector(".mdc-list-item").classList.add("mdc-menu-item--selected");
                                            } else {
                                                item.html.querySelector(".mdc-list-item").classList.remove("mdc-menu-item--selected");
                                            }
                                        } catch (ex){
                                            console.warn("MenuItem caused exception in .checked ",item,ex);
                                        }
                                    }
                                });
                            });
                        }

                        static open(menu, source) {
                            if(source != null) {
                                if(source.x != null && source.y != null) {
                                    menu.html.mdcMenu.setFixedPosition(true);
                                    menu.html.mdcMenu.setAbsolutePosition(source.x, source.y);
                                } else if(source instanceof HTMLElement) {
                                    //Try fixed always if using anchor source?
                                    menu.html.mdcMenu.setFixedPosition(true);

                                    menu.html.mdcMenu.setAnchorElement(source);

                                    switch(menu.growDirection) {
                                        case MenuSystem.Menu.GrowDirection.DOWN:
                                            menu.html.mdcMenu.setAnchorCorner(mdc.menuSurface.Corner.BOTTOM_LEFT);
                                            break;
                                        case MenuSystem.Menu.GrowDirection.RIGHT:
                                        default:
                                            menu.html.mdcMenu.setAnchorCorner(mdc.menuSurface.Corner.TOP_RIGHT);
                                            menu.html.mdcMenu.setAnchorMargin({
                                                top: -10
                                            });
                                    }
                                }
                                menu.html.style.zIndex = 9000;
                            }

                            if (menu.layoutDirection==MenuSystem.Menu.LayoutDirection.HORIZONTAL){
                                menu.html.classList.add("mdc-tweaks-horizontal-menu");
                            }
                            if (menu.layoutWrapping===false){
                                menu.html.classList.add("mdc-tweaks-nonwrapping-menu");
                            }
                            if (menu.layoutCompact===true){
                                menu.html.classList.add("mdc-tweaks-compact-menu");
                            }

                            if(!menu.defaultFocus) {
                                menu.html.mdcMenu.setDefaultFocusState(0);
                            }

                            menu.html.mdcMenu.open = true;
                        }

                        static close(menu) {
                            menu.html.mdcMenu.realClose();
                        }

                        static destroyMenu(menu) {
                            menu.html.mdcMenu.destroy();
                            delete menu.html["mdcMenu"];
                        }

                        static destroyMenuItem(item) {
                        }

                        static setItemActive(item, active){
                            if(active) {
                                item.html.classList.add("mdc-list-item--activated");
                            } else {
                                item.html.classList.remove("mdc-list-item--activated");
                            }
                        }

                        static createSubmenuIcon() {
                            return IconRegistry.createIcon("mdc:chevron_right");
                        }
                    };

                    MenuSystem.MenuManager.createMaterialMenu = (menuName, menuConfig = {}) => {
                        menuConfig.builder = MenuSystem.MaterialMenuBuilder;
                        return MenuSystem.MenuManager.createMenu(menuName, menuConfig);
                    };

                    MenuSystem.MenuManager.setDefaultBuilder(MenuSystem.MaterialMenuBuilder);

                    </SCRIPT><TEMPLATE id="MenuSystem_MaterialMenu_Menu">
                        <DIV class="mdc-menu mdc-menu-surface">
                            <UL class="mdc-list" role="menu" aria-orientation="vertical" tabindex="-1">
                            </UL>
                          </DIV>
                    </TEMPLATE><TEMPLATE id="MenuSystem_MaterialMenu_MenuItem">
                        <LI class="mdc-list-item" role="menuitem">
                            <SPAN class="mdc-list-item__ripple"></SPAN>
                            <SPAN class="mdc-list-item__text"></SPAN>
                        </LI>
                    </TEMPLATE><TEMPLATE id="MenuSystem_MaterialMenu_MenuItem_Icon">
                        <SPAN class="mdc-list-item__graphic"></SPAN>
                    </TEMPLATE><TEMPLATE id="MenuSystem_MaterialMenu_MenuItem_MetaIcon">
                        <SPAN class="mdc-list-item__meta"></SPAN>
                    </TEMPLATE><TEMPLATE id="MenuSystem_MaterialMenu_GroupDivider">
                        <LI class="mdc-list-divider" role="separator"></LI>
                    </TEMPLATE><TEMPLATE id="MenuSystem_MaterialMenu_Checkmark">
                        <SPAN class="mdc-list-item__graphic mdc-menu__selection-group-icon material-icons">check</SPAN>
                    </TEMPLATE><STYLE id="main-style">
                    /**
                     *  MaterialMenuBuilder Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .menusystem-menu.mdc-menu {
                      /* Horizontally layouted menus require emulation */ }
                      .menusystem-menu.mdc-menu .mdc-list-item.MenuSystem_MenuItem_Active {
                        background: red;
                        /* deprecated, remove? */ }
                      .menusystem-menu.mdc-menu .mdc-list-item__meta {
                        display: flex; }
                      .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu {
                        position: relative;
                        max-width: none;
                        max-height: none;
                        overflow: initial;
                        box-shadow: none;
                        background: transparent;
                        min-width: auto; }
                        .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list {
                          display: flex;
                          flex-wrap: wrap;
                          padding: 0; }
                          .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list > .mdc-list-item {
                            height: 1.75em;
                            font-size: 0.8em; }
                            .menusystem-menu.mdc-menu.mdc-tweaks-horizontal-menu > .mdc-list > .mdc-list-item > .mdc-list-item__meta {
                              display: none; }
                      .menusystem-menu.mdc-menu.mdc-tweaks-nonwrapping-menu > .mdc-list {
                        flex-wrap: nowrap; }
                      .menusystem-menu.mdc-menu.mdc-tweaks-compact-menu > .mdc-list > .mdc-list-item {
                        padding: 0; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="webstrate-components-repos" id="WPMPackageBrowser" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Manage WPMv2 packages in your webstrate",
                        "description": "Easily install, update or remove packages in your webstrate with a visual UI",
                        "dependencies": [
                            "#WebstrateComponents_Tools"
                        ],
                        "optionalDependencies": [
                            "wpm_js_libs #material-design-components",
                            "wpm_js_libs #material-design-icons",
                            "#MaterialDesignOutlinedIcons",
                            "#ModalDialog",
                            "#MenuSystem",
                            "#MaterialMenu"
                        ],
                        "assets": [],
                        "version": "2.0",
                        "license": "Apache 2.0",
                        "changelog": {
                            "1.0": "Initial version",
                            "2.0": "No longer initial version"
                        }
                    }

                    </SCRIPT><STYLE id="mdc-package-browser-style">
                    /**
                     *  Package Browser Styles
                     *
                     *  Copyright 2021 Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .package-browser-base {
                      display: flex;
                      flex-direction: column;
                      position: relative; }
                      .package-browser-base #packageBrowserMain {
                        border-top: 1px solid lightgray;
                        display: flex;
                        height: 100%;
                        width: 100%;
                        min-height: 0; }
                        .package-browser-base #packageBrowserMain .tabcontent {
                          display: flex;
                          flex-direction: column;
                          width: 100%;
                          min-height: 0; }
                          .package-browser-base #packageBrowserMain .tabcontent.padded {
                            padding: 1em; }
                        .package-browser-base #packageBrowserMain .split {
                          display: flex;
                          flex: 1 1 auto;
                          min-height: 0; }
                          .package-browser-base #packageBrowserMain .split > .mdc-list {
                            flex: 0 0 auto;
                            width: 20em;
                            max-width: 25vw;
                            min-height: 0;
                            overflow-y: auto;
                            background: rgba(100, 100, 100, 0.2);
                            padding: 0; }
                            .package-browser-base #packageBrowserMain .split > .mdc-list .mdc-list-item {
                              padding-right: 0; }
                            .package-browser-base #packageBrowserMain .split > .mdc-list .repository-name {
                              text-transform: capitalize; }
                          .package-browser-base #packageBrowserMain .split > .scroller {
                            flex: 1 1 auto;
                            min-height: 0;
                            overflow-y: auto; }
                        .package-browser-base #packageBrowserMain .install-options-icon {
                          position: absolute;
                          line-height: 1.5em;
                          margin-left: 0.3em;
                          color: var(--mdc-theme-text-icon-on-light);
                          user-select: none; }
                        .package-browser-base #packageBrowserMain .mdc-data-table__row.missing {
                          background: rgba(255, 0, 0, 0.6); }
                        .package-browser-base #packageBrowserMain .mdc-data-table {
                          border: none;
                          display: block; }
                        .package-browser-base #packageBrowserMain .mdc-data-table__table-container {
                          overflow-x: hidden; }
                        .package-browser-base #packageBrowserMain .mdc-data-table__table {
                          width: 100%;
                          border-spacing: 0;
                          border-collapse: initial; }
                          .package-browser-base #packageBrowserMain .mdc-data-table__table .mdc-data-table__header-cell {
                            background: rgba(0, 0, 255, 0.1); }
                          .package-browser-base #packageBrowserMain .mdc-data-table__table .mdc-data-table__cell {
                            height: 43px;
                            border-top: 1px dotted var(--mdc-theme-text-secondary-on-background); }
                          .package-browser-base #packageBrowserMain .mdc-data-table__table tbody tr:first-child .mdc-data-table__cell {
                            border-top: 1px solid var(--mdc-theme-text-secondary-on-background); }
                        .package-browser-base #packageBrowserMain .package-required[data-indirect-requirement] .mdc-checkbox__background:after {
                          content: "";
                          position: absolute;
                          top: 0;
                          left: 0;
                          right: 0;
                          bottom: 0;
                          background: rgba(0, 100, 255, 0.22); }
                        .package-browser-base #packageBrowserMain .package-required, .package-browser-base #packageBrowserMain .package-embedded {
                          width: 3.5rem; }
                        .package-browser-base #packageBrowserMain .package-name {
                          width: 12rem; }
                        .package-browser-base #packageBrowserMain .package-version {
                          width: 6rem; }
                        .package-browser-base #packageBrowserMain .package-license {
                          width: 9rem; }
                        .package-browser-base #packageBrowserMain .package-options {
                          width: 1rem; }
                        .package-browser-base #packageBrowserMain .package-description {
                          width: 100%;
                          overflow: hidden; }
                    </STYLE><SCRIPT id="webstrate-package-browser-script" type="disabled">
                    /**
                     *  Package Browser
                     *  Visual browser for installing WPM packages into a Webstrate
                     *
                     *  Copyright 2021 Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interacion, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Visual browser for installing WPM packages into a Webstrate
                     */
                    window.WPMPackageBrowser = class WPMPackageBrowser {
                        constructor(autoOpen=true) {
                            let self = this;
                            self.topLevelComponent = document.documentElement;

                            self.itemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItem");
                            self.html = WebstrateComponents.Tools.loadTemplate("#packageBrowserBase");
                            self.mainView = self.html.querySelector("#packageBrowserMain");

                            wpm.require(["material-design-components", "material-design-icons","ModalDialog","MenuSystem","MaterialMenu","MaterialDesignOutlinedIcons"]).then(()=>{
                                mdc.autoInit(self.html);
                                let tabs = self.html.querySelector(".mdc-tab-bar").MDCTabBar;

                                tabs.listen("MDCTabBar:activated", (evt)=> {
                                    // Switch tabs
                                    switch (evt.detail.index){
                                        case 0:
                                            self.showRepositories();
                                            break;
                                        default:
                                            self.showSystem();
                                    }
                                });

                                try {
                                    tabs.activateTab(0); //self.showRepositories();
                                } catch (ex){
                                    tabs.activateTab(1); //self.showSystem();
                                }

                                self.repositoryURLDialog = this.getURLDialog();
                                self.repositoryDevURLDialog = this.getDevURLDialog();
                            });

                            if (autoOpen) this.openInBody();
                        }

                        openInBody(){
                            let parent = document.createElement("transient");
                            parent.appendChild(this.html);
                            document.body.appendChild(parent);
                        }

                        setTopLevelComponent(component){
                            this.topLevelComponent = component;
                        }

                        getURLDialog(){
                            let self = this;
                            let repoAddTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryURL");
                            let repositoryURLDialog = new WebstrateComponents.ModalDialog(
                                    repoAddTemplate,
                                    {
                                        "title":"Repository URL",
                                        "actions": {
                                                "cancel":{},
                                                "set": {primary: true, mdcIcon: "add_link"}
                                        }
                                    }
                            );
                            this.topLevelComponent.appendChild(repositoryURLDialog.html);

                            repositoryURLDialog.setTarget = (target)=>{
                                repositoryURLDialog.target = target;

                                let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(false);
                                if (stepRepositoryRegistrations[target]){
                                    repoAddTemplate.querySelector("#repourl").value = stepRepositoryRegistrations[target];
                                }
                            };

                            EventSystem.registerEventCallback('ModalDialog.Closing', function(evt) {
                                if(evt.detail.dialog===repositoryURLDialog && evt.detail.action === "set") {
                                    let bootConfig = self.getBootConfig();

                                    if (bootConfig.require && Array.isArray(bootConfig.require)){
                                        let repo = {};
                                        repo[repositoryURLDialog.target] = repoAddTemplate.querySelector("#repourl").value;
                                        if (bootConfig.require.length===0){
                                            bootConfig.require = {
                                                repositories: repo,
                                                dependencies: []
                                            };
                                        } else {
                                            let oldRepos = bootConfig.require[0].repositories;
                                            if (!oldRepos){
                                                bootConfig.require[0].repositories = repo;
                                            } else {
                                                bootConfig.require[0].repositories = {...bootConfig.require[0].repositories, ...repo};
                                            }
                                        }

                                        // Effectuate immediately too
                                        WPMv2.registerRepository(repositoryURLDialog.target, repo[repositoryURLDialog.target]);
                                    }

                                    self.setBootConfig(bootConfig);
                                    self.showRepositories();
                                }
                            });

                            return repositoryURLDialog;
                        }

                        getDevURLDialog(){
                            let self = this;
                            let repoDevTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryDevURL");
                            let repositoryDevURLDialog = new WebstrateComponents.ModalDialog(
                                    repoDevTemplate,
                                    {
                                        "title":"Repository Dev Override",
                                        "actions": {
                                                "cancel":{},
                                                "remove":{},
                                                "set": {primary: true, mdcIcon: "add_link"}
                                        }
                                    }
                            );
                            this.topLevelComponent.appendChild(repositoryDevURLDialog.html);

                            repositoryDevURLDialog.setTarget = (target)=>{
                                repositoryDevURLDialog.target = target;

                                let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(true);
                                if (stepRepositoryRegistrations[target]){
                                    repoDevTemplate.querySelector("#repodevurl").value = stepRepositoryRegistrations[target];
                                }
                            };

                            EventSystem.registerEventCallback('ModalDialog.Closing', function(evt) {
                                if(evt.detail.dialog===repositoryDevURLDialog){
                                    let value = repoDevTemplate.querySelector("#repodevurl").value;
                                    if (evt.detail.action === "remove" || (evt.detail.action === "set" && value.trim().length===0)){
                                        WPMv2.unregisterRepository(repositoryDevURLDialog.target, true);
                                    } else if (evt.detail.action === "set"){
                                        WPMv2.registerRepository(repositoryDevURLDialog.target, value, true);
                                    }
                                }
                                self.showRepositories();
                            });

                            return repositoryDevURLDialog;
                        }


                        async renderRepository(repositoryName, repositoryView){
                            let self = this;
                            let repositoryPackages = await WPMv2.getPackagesFromRepository(repositoryName);
                            let bootConfig = this.getBootConfig();

                            let repositoryRepositoryTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryItem_repository");
                            let repositoryBodyTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryItem_body");
                            let repoListDiv = repositoryView.querySelector(".repository-list");
                            repoListDiv.innerHTML = "";
                            repoListDiv.appendChild(repositoryRepositoryTemplate);
                            repoListDiv.appendChild(repositoryBodyTemplate);

                            let renderBody = ()=>{
                                let installedFromRepository = WPMv2.getCurrentlyInstalledPackages().filter(pkg=>pkg.repository&&pkg.repository==repositoryName);
                                // TODO: Handle packages that are in the bootConfig requirestep for this repo but aren't in the repo
                                let repositoryIsThisPage = WPMv2.getLocalRepositoryURL && (repositoryName == WPMv2.getLocalRepositoryURL());

                                for (let packageInfo of repositoryPackages){
                                    if (packageInfo.repository && packageInfo.repository!=repositoryName) continue; // This package is not actually from here but somewhere else
                                    repositoryBodyTemplate.appendChild(self.renderPackageItem(packageInfo, bootConfig, {repositoryIsThisPage:repositoryIsThisPage}));
                                    installedFromRepository = installedFromRepository.filter(pkg=>pkg.name!=packageInfo.name);
                                }

                                // Render packages that claim to be in this repository, but aren't
                                installedFromRepository.forEach((packageInfo)=>{
                                    repositoryBodyTemplate.appendChild(self.renderPackageItem(packageInfo, bootConfig, {missingInRepository:true}));
                                });
                            };
                            await renderBody();

                            // Repository-wide override buttons
                            repositoryRepositoryTemplate.querySelector(".repository-require input").checked = self.isConfigDirectlyRequiringRepository(bootConfig, repositoryName);
                            repositoryRepositoryTemplate.querySelector(".repository-require input").addEventListener("click", async (evt)=>{
                                // Enabled repository-wide require option, remove any per-package settings from bootConfig
                                for (let packageInfo of repositoryPackages){
                                    await self.removePackageRequire(packageInfo);
                                }

                                if (evt.target.checked){
                                    await self.addRepositoryRequire(repositoryName);
                                } else {
                                    await self.removeRepositoryRequire(repositoryName);
                                }

                                bootConfig = self.getBootConfig();
                                repositoryBodyTemplate.innerHTML = "";
                                await renderBody();
                            });

                            repositoryRepositoryTemplate.querySelector(".repository-embed").addEventListener("click", async (evt)=>{
                                let embedMenu = MenuSystem.MenuManager.createMenu("PackageBrowser.RepositoryEmbed", {
                                    growDirection: MenuSystem.Menu.GrowDirection.DOWN
                                });
                                embedMenu.addItem({
                                    label: "Embed In-Use",
                                    order: 100,
                                    group: "Fetching",
                                    groupOrder: 200,
                                    icon: IconRegistry.createIcon("mdc:downloading"),
                                    onAction: async ()=>{
                                        let packagesToEmbed = [];
                                        for (let packageInfo of repositoryPackages){
                                            let inUse = self.getLocalPackageElement(packageInfo.name);
                                            if (inUse && (self.isTransientPackageElement(inUse))){
                                                packagesToEmbed.push(packageInfo);
                                            }
                                        }
                                        console.log(packagesToEmbed);
                                        await self.embedPackages(packagesToEmbed);
                                        self.renderRepository(repositoryName, repositoryView);
                                    }
                                });
                                embedMenu.addItem({
                                    label: "Embed All",
                                    icon: IconRegistry.createIcon("mdc:download_for_offline"),
                                    group: "Fetching",
                                    groupOrder: 200,
                                    order: 200,
                                    onAction: async ()=>{
                                        if (confirm("This will bloat the page, the repository may not be designed to have ALL packages embedded and newly added packages will not be included")){
                                            let packagesToEmbed = []
                                            for (let packageInfo of repositoryPackages){
                                                let localPackageElement = self.getLocalPackageElement(packageInfo.name);

                                                if ((!localPackageElement)||self.isTransientPackageElement(localPackageElement)){
                                                    packagesToEmbed.push(packageInfo);
                                                }
                                            }
                                            await self.embedPackages(packagesToEmbed);
                                            self.renderRepository(repositoryName, repositoryView);
                                        }
                                    }
                                });
                                embedMenu.addItem({
                                    label: "Remove All Embedded",
                                    icon: IconRegistry.createIcon("mdc:delete"),
                                    group: "Destruction",
                                    groupOrder: 999,
                                    order: 999,
                                    onAction: async ()=>{
                                        let packagesOnlyOnThisPage = 0;
                                        let packagesToUnembed = [];
                                        for (let packageInfo of repositoryPackages){
                                            let localPackageElement = self.getLocalPackageElement(packageInfo.name);
                                            if (localPackageElement && !self.isTransientPackageElement(localPackageElement)){
                                                if (packageInfo.repository && WPMv2.getLocalRepositoryURL && packageInfo.repository==WPMv2.getLocalRepositoryURL()){
                                                    packagesOnlyOnThisPage++;
                                                }
                                                packagesToUnembed.push(packageInfo);
                                            }
                                        }

                                        if ((!packagesOnlyOnThisPage) || confirm("This will permanently delete "+packagesOnlyOnThisPage+" packages that ONLY exist in this page"))
                                        for (let pkg of packagesToUnembed){
                                            await self.unembedPackage(pkg);
                                        }

                                        self.renderRepository(repositoryName, repositoryView);
                                    }
                                });

                                embedMenu.registerOnCloseCallback(() => {
                                    if (embedMenu.html.parentNode !== null) {
                                        embedMenu.html.parentNode.removeChild(embedMenu.html);
                                    }
                                });

                                self.html.appendChild(embedMenu.html);

                                embedMenu.open({
                                    x: evt.clientX,
                                    y: evt.clientY
                                });
                                evt.stopPropagation();
                                evt.preventDefault();
                            });
                        };

                        showRepositories() {
                            let self = this;
                            this.mainView.innerHTML="";

                            let repositoryView = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryList");

                            // General actions for repositories
                            let repoAddTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryAdder");
                            let addRepositoryDialog = new WebstrateComponents.ModalDialog(
                                    repoAddTemplate,
                                    {
                                        "title":"Add Repository",
                                        "actions": {
                                                "cancel":{},
                                                "next": {primary: true, mdcIcon: "add_link"}
                                        }
                                    }
                            );
                            self.topLevelComponent.appendChild(addRepositoryDialog.html);
                            EventSystem.registerEventCallback('ModalDialog.Closing', function(evt) {
                                if(evt.detail.dialog===addRepositoryDialog && evt.detail.action === "next") {
                                    let bootConfig = self.getBootConfig();
                                    let value = repoAddTemplate.querySelector("#repoid").value.trim();
                                    if (value.length>0){
                                        if ((!bootConfig.knownRepositories) || !Array.isArray(bootConfig.knownRepositories)){
                                            bootConfig.knownRepositories = []; // Destructive conformity
                                        }
                                        bootConfig.knownRepositories.push(repoAddTemplate.querySelector("#repoid").value);
                                        self.setBootConfig(bootConfig);
                                        self.showRepositories();

                                        // TODO: .scrollIntoView() ?
                                    }
                                }
                            });

                            // Gather a list of used repositories, both site-wide from WPM and previously added from this browser
                            let knownRepositories = [];
                            let installedPackages = WPMv2.getCurrentlyInstalledPackages();
                            for (let packageInfo of installedPackages){
                                if (packageInfo.repository && !knownRepositories.includes(packageInfo.repository)){
                                    knownRepositories.push(packageInfo.repository);
                                }
                            }
                            let bootConfig = this.getBootConfig();
                            if (bootConfig.knownRepositories && Array.isArray(bootConfig.knownRepositories)){
                                for (let repoName of bootConfig.knownRepositories){
                                    if (!knownRepositories.includes(repoName)){
                                        knownRepositories.push(repoName);
                                    }
                                }
                            }

                            // Sort it and show it
                            let sortedRepositories = knownRepositories.sort();
                            let overviewAddItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserAddListItem");
                            for (let repositoryName of sortedRepositories){
                                let overviewListItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserRepositoryListItem");
                                if (WPMv2.getLocalRepositoryURL && repositoryName == WPMv2.getLocalRepositoryURL()){
                                    overviewListItemTemplate.querySelector(".repository-name").innerHTML = " This Page";
                                    overviewListItemTemplate.querySelector(".repository-url").innerText = repositoryName;
                                } else {
                                    overviewListItemTemplate.querySelector(".repository-name").title = repositoryName;
                                    overviewListItemTemplate.querySelector(".repository-name").innerText = repositoryName.replace("-repos","").replaceAll("_"," ").replaceAll("-", " ");
                                }

                                // Check if this is mapped somewhere with the bootloader
                                // STUB: Currently this uses WPMv2 instead of the bootstep to resolve it
                                let stepRepositoryRegistrations = WPMv2.getRegisteredRepositories(false);
                                if (stepRepositoryRegistrations[repositoryName]){
                                    overviewListItemTemplate.querySelector(".repository-url").innerText = stepRepositoryRegistrations[repositoryName];
                                    overviewListItemTemplate.querySelector(".repository-url").title = stepRepositoryRegistrations[repositoryName];
                                }

                                // Check if this is mapped somewhere with any overrides
                                // STUB: Currently this uses WPMv2 instead of the bootstep to resolve it
                                let overrideRepositoryRegistrations = WPMv2.getRegisteredRepositories(true);
                                if (overrideRepositoryRegistrations[repositoryName]){
                                    overviewListItemTemplate.querySelector(".repository-url").title = overviewListItemTemplate.querySelector(".repository-url").innerText+ " overridden by site-wide developer setting in this browser";
                                    overviewListItemTemplate.querySelector(".repository-url").innerText = overrideRepositoryRegistrations[repositoryName];
                                    overviewListItemTemplate.querySelector(".repository-url").style.color="red";
                                }

                                overviewListItemTemplate.querySelector(".repository-more").addEventListener("click", (evt)=>{
                                    let moreMenu = MenuSystem.MenuManager.createMenu("PackageBrowser.RepositoryMore", {
                                        growDirection: MenuSystem.Menu.GrowDirection.DOWN
                                    });
                                    moreMenu.addItem({
                                        label: "Remove",
                                        order: 10,
                                        icon: IconRegistry.createIcon("mdc:delete_outline"),
                                        onAction: ()=>{
                                            let bootConfig = self.getBootConfig();
                                            if ((!bootConfig.knownRepositories) || !Array.isArray(bootConfig.knownRepositories)){
                                                console.log("Couldn't understand bootConfig.knownRepositories", bootConfig.knownRepositories);
                                                return;
                                            } else {
                                                bootConfig.knownRepositories = bootConfig.knownRepositories.filter(e => e !== repositoryName);
                                                self.setBootConfig(bootConfig);
                                                self.showRepositories();
                                            }
                                        }
                                    });
                                    moreMenu.addItem({
                                        label: "Source URL...",
                                        icon: IconRegistry.createIcon("mdc:link"),
                                        order: 900,
                                        onAction: ()=>{
                                            self.repositoryURLDialog.setTarget(repositoryName);
                                            self.repositoryURLDialog.open();
                                        }
                                    });
                                    moreMenu.addItem({
                                        label: "Dev Override...",
                                        icon: IconRegistry.createIcon("mdc:assistant_direction"),
                                        order: 999,
                                        onAction: ()=>{
                                            self.repositoryDevURLDialog.setTarget(repositoryName);
                                            self.repositoryDevURLDialog.open();
                                        }
                                    });

                                    moreMenu.registerOnCloseCallback(() => {
                                        if (moreMenu.html.parentNode !== null) {
                                            moreMenu.html.parentNode.removeChild(moreMenu.html);
                                        }
                                    });

                                    self.html.appendChild(moreMenu.html);
                                    moreMenu.open({
                                        x: evt.clientX,
                                        y: evt.clientY
                                    });
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });

                                // Insert into overview of repositories
                                repositoryView.querySelector(".repository-overview").appendChild(overviewListItemTemplate);
                            }
                            repositoryView.querySelector(".repository-overview").appendChild(overviewAddItemTemplate);
                            repositoryView.querySelector(".add-repository").addEventListener("click", ()=>{
                                addRepositoryDialog.html.querySelector("#repoid").value = "";
                                addRepositoryDialog.open();
                            });

                            mdc.autoInit(repositoryView);
                            let list = repositoryView.querySelector(".repository-overview").MDCList;
                            list.singleSelection = true;
                            list.listen("MDCList:action", async (evt)=>{
                                if (evt.detail.index > sortedRepositories.length) return;
                                let repositoryName = sortedRepositories[evt.detail.index];
                                self.renderRepository(repositoryName, repositoryView);
                            });
                            list.selectedIndex = 0;
                            if (sortedRepositories.length>0) self.renderRepository(sortedRepositories[0], repositoryView);

                            this.mainView.appendChild(repositoryView);
                        }

                        showSystem(){
                            let self = this;
                            this.mainView.innerHTML="";

                            let systemView = WebstrateComponents.Tools.loadTemplate("#packageBrowserSystem");
                            this.mainView.appendChild(systemView);
                            let wpmInfo = systemView.querySelector("#wpm-info");
                            let bootLoaderInfo = systemView.querySelector("#bootloader-info");
                            let bootLoaderConfig = systemView.querySelector("#bootloader-config");

                            // Package Manager
                            if (WPMv2){
                                wpmInfo.querySelector(".name").innerText = "WPMv2";
                                if (WPMv2.version){
                                    wpmInfo.querySelector(".version").innerText = WPMv2.version;
                                    wpmInfo.querySelector(".wpm-version-warning").remove();
                                }
                                if (WPMv2.revision){
                                    wpmInfo.querySelector(".revision").innerText = WPMv2.revision;
                                }
                            }

                            // Config

                        }


                        getBootConfig(){
                            try {
                                let element = document.querySelector("script[type='text/json+bootconfig']");
                                if (!element) throw Error("No bootconfig defined");

                                let j = JSON.parse(element.textContent);
                                return j;
                            } catch (ex){
                                console.log("PackageBrowser error", ex);
                            }

                            // We assume that we may create a new empty boot config if it doesn't exist
                            let bootConfig = {
                                creator: "WPMPackageManager",
                                created: Date.now(),
                                require: []
                            };

                            return bootConfig;
                        }

                        setBootConfig(config){
                            let element = document.querySelector("script[type='text/json+bootconfig']");
                            if (!element) {
                                element = document.createElement("script");
                                element.setAttribute("type", "text/json+bootconfig");
                                WPMv2.stripProtection(element);
                                document.head.appendChild(element);
                                console.warn("Installing new boot config");
                            }

                            config["updated"] = Date.now();
                            element.textContent = JSON.stringify(config, null, 4);
                        }

                        isLive(packageElement){
                            return packageElement.getAttribute("transient-wpm-live")!==null;
                        }

                        isConfigDirectlyRequiringPackage(config, name){
                            if (!config) throw new Error("Boot config is undefined");
                            if (!config.require) throw new Error("Boot config does not contain require");
                            if (!Array.isArray(config.require)) throw new Error("Boot config require is not an array");

                            for (let requireStep of config.require){
                                if (!requireStep.dependencies) continue;
                                if (!Array.isArray(requireStep.dependencies)) continue;
                                for (let dependency of requireStep.dependencies){
                                    if (dependency.package && dependency.package===name){
                                        return true;
                                    }
                                }
                            }
                            return false;
                        }

                        isConfigDirectlyRequiringRepository(config, name){
                            if (!config) throw new Error("Boot config is undefined");
                            if (!config.require) throw new Error("Boot config does not contain require");
                            if (!Array.isArray(config.require)) throw new Error("Boot config require is not an array");

                            for (let requireStep of config.require){
                                if (!requireStep.dependencies) continue;
                                if (!Array.isArray(requireStep.dependencies)) continue;
                                for (let dependency of requireStep.dependencies){
                                    if (dependency.repository && dependency.repository===name && !dependency.package){
                                        return true;
                                    }
                                }
                            }
                            return false;
                        }



                        getLocalPackageElement(packageName){
                            return document.querySelector(".packages .package#" + packageName + ", wpm-package#" + packageName);
                        }

                        isTransientPackageElement(packageElement){
                            if (typeof webstrate !== "undefined"){
                                // In webstrate mode webstrates defines what is transient
                                if (webstrate.config.isTransientElement(packageElement)) return true;
                            } else {
                                // Otherwise we assume a transient-element tag is used to mark it
                                console.log("Trying to match ", packageElement.tagName);
                                if (packageElement.closest("[transient-wpmid]")){
                                    return true;
                                } else {
                                    return false;
                                }
                            }

                            let parent = packageElement.parentElement;
                            if (parent){
                                return this.isTransientPackageElement(parent);
                            } else {
                                return false;
                            }
                        }

                        isForcedEmbeddedPackage(packageInfo){
                            if (packageInfo.descriptor){
                                if (packageInfo.descriptor.forceEmbedding) {
                                    return true;
                                }
                            }
                            return false;
                        }

                        /**
                         * Adds a package to the boot config and installs it
                         *
                         * @param {type} packageInfo
                         * @param {type} step
                         * @returns {undefined}
                         */
                        async addPackageRequire(packageInfo, step=-1){
                            let config = this.getBootConfig();

                            if (step===-1 || step > config.require.length){
                                step = config.require.length-1;
                            }
                            if (step===-1){
                                config.require.push({dependencies:[], options:{}});
                                step = 0;
                            }

                            // Add it and load it
                            let packageRequire = {package:packageInfo.name, repository:packageInfo.repository};
                            await WPMv2.require(packageRequire); // also install it right away
                            config.require[step].dependencies.push(packageRequire);
                            this.setBootConfig(config);
                        }

                        async removePackageRequire(packageInfo){
                            let config = this.getBootConfig();

                            let removedIt = false;
                            for (let requireStep of config.require){
                                if (!requireStep.dependencies) continue;
                                if (!Array.isArray(requireStep.dependencies)) continue;

                                let newDependencies = [];
                                for (let dependency of requireStep.dependencies){
                                    if (dependency.package && dependency.package===packageInfo.name){
                                        removedIt = true;
                                    } else {
                                        newDependencies.push(dependency);
                                    }
                                }
                                requireStep.dependencies = newDependencies;
                            }

                            if (removedIt){
                                let localPackageElement = this.getLocalPackageElement(packageInfo.name);
                                if (this.isTransientPackageElement(localPackageElement)){
                                    localPackageElement.remove();
                                    document.querySelector("[transient-wpmid='"+packageInfo.name+"']")?.remove();
                                }
                            }

                            this.setBootConfig(config);
                        }

                        async removeRepositoryRequire(repositoryURL){
                            let config = this.getBootConfig();

                            let removedIt = false;
                            for (let requireStep of config.require){
                                if (!requireStep.dependencies) continue;
                                if (!Array.isArray(requireStep.dependencies)) continue;

                                let newDependencies = [];
                                for (let dependency of requireStep.dependencies){
                                    if (dependency.repository && dependency.repository===repositoryURL && !dependency.package){
                                        removedIt = true;
                                    } else {
                                        newDependencies.push(dependency);
                                    }
                                }
                                requireStep.dependencies = newDependencies;
                            }

                            if (removedIt){
                                // TODO: Figure out if something else also depends on it
                                // If not, remove it from runtime too
                            }

                            this.setBootConfig(config);
                        }

                        /**
                         * Adds a package to the boot config and installs it
                         *
                         * @param {type} repositoryURL
                         * @param {type} step
                         * @returns {undefined}
                         */
                        async addRepositoryRequire(repositoryURL, step=-1){
                            let config = this.getBootConfig();

                            if (step===-1 || step > config.require.length){
                                step = config.require.length-1;
                            }
                            if (step===-1){
                                config.require.push({dependencies:[], options:{}});
                                step = 0;
                            }

                            // Add it and load it
                            let repositoryRequire = {repository:repositoryURL};
                            await WPMv2.require(repositoryRequire); // also install it right away
                            config.require[step].dependencies.push(repositoryRequire);
                            this.setBootConfig(config);
                        }

                        async embedPackages(wpmPackages){
                            // Prepare for this package to be embedded
                            let requiredPackages = [];
                            wpmPackages.forEach((wpmPackage)=>{
                                let localPackageElement = this.getLocalPackageElement(wpmPackage.name);
                                if (localPackageElement && this.isTransientPackageElement(localPackageElement)){
                                    // Already installed transiently, remove first
                                    localPackageElement.remove();
                                    //Also remove wpm transient element if found
                                    document.querySelector("[transient-wpmid='"+wpmPackage.name+"']")?.remove();
                                };
                                requiredPackages.push({package:wpmPackage.name, repository:wpmPackage.repository, appendTarget:"head"});
                            });

                            await WPMv2.require(requiredPackages, {"bootstrap":"false"}); // install it right away
                        }

                        async unembedPackage(wpmPackage){
                            let localPackageElement = this.getLocalPackageElement(wpmPackage.name); // update the package element
                            localPackageElement.remove();

                            if (this.isConfigDirectlyRequiringPackage(this.getBootConfig(), wpmPackage.name)){
                                // Re-install transiently if required
                                await WPMv2.require(wpmPackage);
                            };
                        }

                        renderPackageItem(wpmPackage, bootConfig, displayOptions={}){
                            let self = this;

                            let packageItemTemplate = WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItem");
                            if (displayOptions.missingInRepository){
                                packageItemTemplate.classList.add("missing");
                                packageItemTemplate.title="This package could not be found in the repository";
                            };

                            if (!wpmPackage.name){
                                return WebstrateComponents.Tools.loadTemplate("#packageBrowserPackageItemError");
                            }
                            packageItemTemplate.querySelector(".package-name").innerText = wpmPackage.name;
                            packageItemTemplate.querySelector(".package-name").title = wpmPackage.name;

                            ["version", "description", "license"].forEach((packageProperty)=>{
                                if (wpmPackage[packageProperty]){
                                    packageItemTemplate.querySelector(".package-"+packageProperty).innerText = wpmPackage[packageProperty];
                                    packageItemTemplate.querySelector(".package-"+packageProperty).title = wpmPackage[packageProperty];
                                }
                            });

                            let localPackageElement = this.getLocalPackageElement(wpmPackage.name);
                            if (localPackageElement) {
                                // Check if required directly or because of dependency/system
                                if (this.isConfigDirectlyRequiringPackage(bootConfig, wpmPackage.name)){
                                    packageItemTemplate.querySelector(".package-required input").checked = true;
                                } else {
                                    if (this.isLive(localPackageElement)){
                                        packageItemTemplate.querySelector(".package-required").setAttribute("data-indirect-requirement","true");
                                        packageItemTemplate.querySelector(".package-required .mdc-checkbox").setAttribute("title", "Indirectly required by another package at runtime");

                                        try {
                                            // Add which package pulled this in
                                            let pulledInBy = [];
                                            WPMv2.getCurrentlyInstalledPackages().forEach(function(pkg){
                                                pkg.dependencies.forEach(function(dep){
                                                    if (typeof dep === "string" && dep.indexOf("#"+wpmPackage.name)!=-1){
                                                        pulledInBy.push(pkg);
                                                    }
                                                });
                                            });
                                            if (pulledInBy.length > 0){
                                                packageItemTemplate.querySelector(".package-required .mdc-checkbox").setAttribute("title", "Indirectly required by "+pulledInBy);
                                            }
                                        } catch (ex){
                                            console.warn(ex);
                                        }
                                    }
                                }

                                // Embedding status
                                packageItemTemplate.querySelector(".package-embedded input").checked = !this.isTransientPackageElement(localPackageElement);
                                if (this.isForcedEmbeddedPackage(wpmPackage)){
                                    packageItemTemplate.querySelector(".package-embedded input").setAttribute("title", "This package wants to be embedded when installed");
                                }
                            }


                            // Click handlers
                            packageItemTemplate.querySelector(".package-required input").addEventListener("click", async (box)=>{
                                if (box.target.checked){
                                    // Require a package
                                    if (self.isForcedEmbeddedPackage(wpmPackage) && !packageItemTemplate.querySelector(".package-embedded input").checked){
                                        await self.embedPackages([wpmPackage]);
                                        packageItemTemplate.querySelector(".package-embedded input").checked = true;

                                    }
                                    await self.addPackageRequire(wpmPackage);
                                } else {
                                    if (self.isForcedEmbeddedPackage(wpmPackage) && packageItemTemplate.querySelector(".package-embedded input").checked){
                                        await self.unembedPackage(wpmPackage);
                                        packageItemTemplate.querySelector(".package-embedded input").checked = false;
                                    }

                                    // Remove require for a package
                                    await self.removePackageRequire(wpmPackage);
                                }
                                localPackageElement = self.getLocalPackageElement(wpmPackage.name); // update the package element
                            });

                            packageItemTemplate.querySelector(".package-embedded input").addEventListener("click",async (box)=>{
                                if (box.target.checked){
                                    await self.embedPackages([wpmPackage]);
                                    packageItemTemplate.querySelector(".package-embedded input").checked = true;
                                } else {
                                    if (((!displayOptions.missingInRepository) || confirm("This package is missing in the repository, removing it will permanently delete it"))
                                            &&
                                           ((!displayOptions.repositoryIsThisPage) || confirm("The package only exists in this page, removing it will permanently delete it"))) {
                                        await self.unembedPackage(wpmPackage);
                                        packageItemTemplate.querySelector(".package-embedded input").checked = false;
                                        if (self.isForcedEmbeddedPackage(wpmPackage) && packageItemTemplate.querySelector(".package-required input").checked){
                                            await self.removePackageRequire(wpmPackage);
                                            packageItemTemplate.querySelector(".package-required input").checked = false;
                                        }
                                    } else {
                                        packageItemTemplate.querySelector(".package-embedded input").checked = true;
                                    }
                                }
                                localPackageElement = self.getLocalPackageElement(wpmPackage.name); // update the package element
                            });


                            // Check repository includes
                            if (wpmPackage.repository && self.isConfigDirectlyRequiringRepository(bootConfig, wpmPackage.repository)){
                                packageItemTemplate.querySelector(".package-required input").disabled = true;
                                packageItemTemplate.querySelector(".package-required input").checked = true;
                                packageItemTemplate.querySelector(".package-embedded input").disabled = true;
                            }

                            return packageItemTemplate;
                        }
                    };

                    </SCRIPT><TEMPLATE id="packageBrowserBase">
                        <DIV class="package-browser-base">
                            <DIV class="mdc-tab-bar package-browser-tabs" role="tablist" data-mdc-auto-init="MDCTabBar">
                                <DIV class="mdc-tab-scroller">
                                    <DIV class="mdc-tab-scroller__scroll-area">
                                        <DIV class="mdc-tab-scroller__scroll-content">
                                            <BUTTON class="mdc-tab" role="tab">
                                                <SPAN class="mdc-tab__content">
                                                    <SPAN class="mdc-tab__icon material-icons" aria-hidden="true">inventory</SPAN>
                                                    <SPAN class="mdc-tab__text-label">Browse Repositories</SPAN>
                                                </SPAN>
                                                <SPAN class="mdc-tab-indicator">
                                                    <SPAN class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></SPAN>
                                                </SPAN>
                                                <SPAN class="mdc-tab__ripple"></SPAN>
                                            </BUTTON>
                                            <BUTTON class="mdc-tab" role="tab">
                                                <SPAN class="mdc-tab__content">
                                                    <SPAN class="mdc-tab__icon material-icons" aria-hidden="true">settings</SPAN>
                                                    <SPAN class="mdc-tab__text-label">System Setup</SPAN>
                                                </SPAN>
                                                <SPAN class="mdc-tab-indicator">
                                                    <SPAN class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></SPAN>
                                                </SPAN>
                                                <SPAN class="mdc-tab__ripple"></SPAN>
                                            </BUTTON>
                                        </DIV>
                                    </DIV>
                                </DIV>
                            </DIV>

                            <DIV id="packageBrowserMain"></DIV>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserSystem">
                        <DIV class="tabcontent padded">
                            <DIV id="wpm-info">
                                <H2>Webstrate Package Manager</H2>
                                <TABLE>

                                    <TBODY><TR><TH>Name</TH><TD class="name">Unknown Platform</TD></TR>
                                    <TR><TH>API</TH><TD class="version">Legacy</TD></TR>
                                    <TR><TH>Specific Revision</TH><TD class="revision">?</TD></TR>
                                </TBODY></TABLE>
                                <DIV class="wpm-version-warning">
                                    <H2>Warning!</H2>
                                    <P>
                                        The version of WPM you are running may not be compatible with this package manager or the required bootloader script.<BR/>
                                        Please consider upgrading before continuing!
                                    </P>
                                </DIV>
                            </DIV>

                            <DIV id="bootloader-config">
                                <H2>Boot Config</H2>
                                <P>
                                    You may manually edit the boot configuration JSON here if you like.<BR/>
                                    <B>Be careful, you were warned!</B>
                                </P>

                                <DIV class="editor">
                                </DIV>
                            </DIV>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserBootloaderSyntaxError">
                        <DIV class="bootconfig-missing-warning">
                            <H2>Syntax Error!</H2>
                            <P class="error"></P>
                            <P>
                                The boot configuration contains a syntax error and is guaranteed to crash the page!<BR/>
                                Please correct the errors before saving.
                            </P>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserPackageItemError">
                        <TR class="mdc-data-table__row">
                            <TD>
                               ?
                            </TD>
                        </TR>
                    </TEMPLATE><TEMPLATE id="packageBrowserPackageItem">
                        <TR class="mdc-data-table__row">
                            <TD class="mdc-data-table__cell mdc-data-table__cell--checkbox package-required">
                                <DIV class="mdc-checkbox mdc-data-table__row-checkbox" data-mdc-auto-init="MDCCheckbox">
                                    <INPUT type="checkbox" class="mdc-checkbox__native-control" value="on"/>
                                    <DIV class="mdc-checkbox__background">
                                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                        </svg>
                                        <DIV class="mdc-checkbox__mixedmark"></DIV>
                                    </DIV>
                                    <DIV class="mdc-checkbox__ripple"></DIV>
                                </DIV>
                            </TD>
                            <TD class="mdc-data-table__cell mdc-data-table__cell--checkbox package-embedded">
                                <DIV class="mdc-checkbox mdc-data-table__row-checkbox" data-mdc-auto-init="MDCCheckbox">
                                    <INPUT type="checkbox" class="mdc-checkbox__native-control" value="on"/>
                                    <DIV class="mdc-checkbox__background">
                                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                        </svg>
                                        <DIV class="mdc-checkbox__mixedmark"></DIV>
                                    </DIV>
                                    <DIV class="mdc-checkbox__ripple"></DIV>
                                </DIV>
                            </TD>
                            <TH class="mdc-data-table__cell package-name" scope="row">[unnamed]</TH>
                            <TD class="mdc-data-table__cell package-version">[version-less]</TD>
                            <TD class="mdc-data-table__cell package-license"></TD>
                            <TD class="mdc-data-table__cell package-description"></TD>
                            <TD class="mdc-data-table__cell package-options"></TD>
                        </TR>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryItem_repository">
                        <THEAD>
                            <TR>
                                <TH class="package-required mdc-data-table__header-cell mdc-data-table__header-cell--checkbox repository-require" role="columnheader" scope="col" title="Require entire repository at boot">
                                    <DIV class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected" title="Automatically require at boot">
                                        <I class="material-icons install-options-icon">play_arrow</I>
                                        <INPUT type="checkbox" class="mdc-checkbox__native-control" value="on"/>
                                        <DIV class="mdc-checkbox__background">
                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                            <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                            </svg>
                                            <DIV class="mdc-checkbox__mixedmark"></DIV>
                                        </DIV>
                                        <DIV class="mdc-checkbox__ripple"></DIV>
                                    </DIV>
                                </TH>
                                <TH class="package-embedded mdc-data-table__header-cell mdc-data-table__header-cell--checkbox repository-embed" role="columnheader" scope="col">
                                    <DIV class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--selected" title="Embed locally into webstrate">
                                        <I class="material-icons install-options-icon">archive</I>
                                        <INPUT type="checkbox" class="mdc-checkbox__native-control" disabled value="on"/>
                                        <DIV class="mdc-checkbox__background">
                                            <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                            <path class="mdc-checkbox__checkmark-path" fill="none" d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                            </svg>
                                            <DIV class="mdc-checkbox__mixedmark"></DIV>
                                        </DIV>
                                        <DIV class="mdc-checkbox__ripple"></DIV>
                                    </DIV>
                                </TH>
                                <TH class="package-name mdc-data-table__header-cell" role="columnheader" scope="col">Package</TH>
                                <TH class="mdc-data-table__header-cell package-version" role="columnheader" scope="col">Version</TH>
                                <TH class="mdc-data-table__header-cell package-license" role="columnheader" scope="col">License</TH>
                                <TH class="mdc-data-table__header-cell package-description" role="columnheader" scope="col">Description</TH>
                                <TH class="mdc-data-table__header-cell package-options" role="columnheader" scope="col">
                                </TH>
                            </TR>
                        </THEAD>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryItem_body">
                        <TBODY class="mdc-data-table__content package-browser-package-rows">
                        </TBODY>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryList">
                        <DIV class="tabcontent">
                            <DIV class="split">
                                <UL class="mdc-list mdc-list--two-line repository-overview" data-mdc-auto-init="MDCList">
                                </UL>
                                <DIV class="scroller">
                                    <DIV class="mdc-data-table">
                                        <DIV class="mdc-data-table__table-container">
                                            <TABLE class="mdc-data-table__table repository-list">
                                            </TABLE>
                                        </DIV>
                                    </DIV>
                                </DIV>
                            </DIV>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryAdder">
                        <DIV>
                            <LABEL class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
                              <SPAN class="mdc-text-field__ripple"></SPAN>
                              <SPAN class="mdc-floating-label" id="repo-label-id">Repository Identifier</SPAN>
                              <INPUT class="mdc-text-field__input" type="text" aria-labelledby="repo-label-id" aria-controls="repo-helper-text" aria-describedby="repo-helper-text" id="repoid"/>
                              <SPAN class="mdc-line-ripple"></SPAN>
                            </LABEL>
                            <DIV class="mdc-text-field-helper-line">
                              <DIV id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
                                Identification token - e.g. 'cauldron-repos'
                              </DIV>
                            </DIV>
                            WPM will search for the repository in:
                            <UL style="margin: 0px;">
                                <LI>/[identifier]/?raw - using Webstrates</LI>
                                <LI>./[identifier]/index.html - on filesystem</LI>
                            </UL>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryURL">
                        <DIV>
                            Specify the URL to use load this repository
                            <LABEL class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
                              <SPAN class="mdc-text-field__ripple"></SPAN>
                              <SPAN class="mdc-floating-label" id="repo-label-id">Repository Source</SPAN>
                              <INPUT class="mdc-text-field__input" type="text" aria-labelledby="repo-label-id" aria-controls="repo-helper-text" aria-describedby="repo-helper-text" id="repourl"/>
                              <SPAN class="mdc-line-ripple"></SPAN>
                            </LABEL>
                            <DIV class="mdc-text-field-helper-line">
                              <DIV id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
                                Repository URL - e.g. 'https://mydomain.com/awesome-repos'
                              </DIV>
                            </DIV>
                            <UL style="margin: 0px;">
                                <LI>Absolute https://mydomain.com/awesome-repos</LI>
                                <LI>Relative ./something/index.html</LI>
                                <LI>Server-relative: /something/?raw</LI>
                            </UL>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryDevURL">
                        <DIV>
                            Specify the Dev Override URL to use locally for this repository
                            <LABEL class="mdc-text-field mdc-text-field--filled" data-mdc-auto-init="MDCTextField">
                              <SPAN class="mdc-text-field__ripple"></SPAN>
                              <SPAN class="mdc-floating-label" id="repo-label-id">Repository Override</SPAN>
                              <INPUT class="mdc-text-field__input" type="text" aria-labelledby="repo-label-id" aria-controls="repo-helper-text" aria-describedby="repo-helper-text" id="repodevurl"/>
                              <SPAN class="mdc-line-ripple"></SPAN>
                            </LABEL>
                            <DIV class="mdc-text-field-helper-line">
                              <DIV id="repo-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
                                Repository Override - e.g. '/something/?raw'
                              </DIV>
                            </DIV>
                            <UL style="margin: 0px;">
                                <LI>Absolute https://mydomain.com/awesome-repos</LI>
                                <LI>Relative ./something/index.html</LI>
                                <LI>Server-relative: /something/?raw</LI>
                            </UL>
                        </DIV>
                    </TEMPLATE><TEMPLATE id="packageBrowserRepositoryListItem">
                        <LI class="mdc-list-item" data-mdc-auto-init="MDCRipple" tabindex="0">
                            <SPAN class="mdc-list-item__ripple"></SPAN>
                            <SPAN class="mdc-list-item__text">
                                <SPAN class="mdc-list-item__primary-text repository-name">Two-line item
                                </SPAN>
                                <SPAN class="mdc-list-item__secondary-text repository-url">Automatic Repository URL</SPAN>
                            </SPAN>
                            <BUTTON data-mdc-ripple-is-unbounded class="mdc-list-item__meta mdc-icon-button material-icons repository-more">
                            more_vert
                        </BUTTON>
                        </LI>
                    </TEMPLATE><TEMPLATE id="packageBrowserAddListItem">
                        <LI class="mdc-list-item add-repository" data-mdc-auto-init="MDCRipple" tabindex="0">
                            <SPAN class="mdc-list-item__ripple"></SPAN>
                            <I class="material-icons" aria-hidden="true">add</I>
                            <SPAN>
                                Add Repository
                            </SPAN>
                        </LI>
                    </TEMPLATE></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-engine" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv engine",
                        "description": "The core of the Varv system",
                        "dependencies": [
                            "wpm_js_libs #UUIDGenerator",
                            "wpm_js_libs #js-yaml",
                            "wpm_js_libs #LiveElement",
                            "wpm_js_libs #izitoast",
                            "wpm_js_libs #Observer",
                            "codestrates-repos #EventSystem"
                        ],
                        "license": "MIT",
                        "assets": [],
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="VarvPerformance-script" type="disabled">
                    class VarvPerformance {
                        static makeId(length) {
                            let result = '';
                            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                            const charactersLength = characters.length;
                            for ( let i = 0; i < length; i++ ) {
                                result += characters.charAt(Math.floor(Math.random() *
                                    charactersLength));
                            }
                            return result;
                        }

                        static start() {
                            if(!VarvPerformance.enabled) {
                                return;
                            }

                            let mark = this.makeId(32);

                            performance.mark(mark);

                            return mark;
                        }

                        static stop(name, mark, details) {
                            if(!VarvPerformance.enabled) {
                                return;
                            }

                            let endMark = mark+"end";

                            performance.mark(endMark);

                            if(VarvPerformance.prefix.length > 0) {
                                name = VarvPerformance.prefix+"."+name;
                            }

                            try {
                                performance.measure(name, {
                                    start: mark,
                                    end: endMark,
                                    detail: JSON.stringify(details, (key, value) => {
                                        if (typeof value === "object" && value?.hasOwnProperty("constructOptions")) {
                                            return value.constructOptions;
                                        }

                                        return value;
                                    })
                                });
                            } catch(e) {
                                performance.measure(name, mark, endMark);
                            }
                        }

                        static showInternal(options, callback) {
                            let defaultOptions = {
                                regex: null,
                                minInvocations: 0
                            };

                            options = Object.assign({}, defaultOptions, options);

                            let measureMap = new Map();

                            performance.getEntriesByType("measure").forEach((measure)=>{
                                let list = measureMap.get(measure.name);
                                if(list == null) {
                                    list = [];
                                    measureMap.set(measure.name, list);
                                }

                                list.push(measure);
                            });

                            let entryArray = Array.from(measureMap.entries());

                            entryArray.sort((e1, e2)=>{
                                let v1 = e1[1];
                                let v2 = e2[1];

                                return v2.length - v1.length;
                            });

                            entryArray.forEach((entry)=>{
                                let measures = entry[1];
                                let key = entry[0];

                                if(measures.length < options.minInvocations) {
                                    return;
                                }

                                if(options.regex != null) {
                                    if(key.match(options.regex) == null) {
                                        return;
                                    }
                                }

                                measures.sort((m1, m2)=>{
                                    return m2.duration - m1.duration;
                                });

                                callback(measures, key);
                            });
                        }

                        static showDetails(options) {
                            this.showInternal(options, (measures, key)=>{

                                console.groupCollapsed(key+" x"+measures.length);

                                measures.forEach((measure)=>{
                                    if(measure.detail != null) {
                                        console.log(measure.duration.toFixed(3) + " ms - ", JSON.parse(measure.detail));
                                    } else {
                                        console.log(measure.duration.toFixed(3) + " ms");
                                    }
                                });

                                console.groupEnd();
                            });
                        }

                        static showStats(options) {
                            let data = [];

                            this.showInternal(options, (measures, key)=> {
                                let measureDurations = measures.map((m)=>{
                                    return m.duration;
                                });

                                let min = 99999;
                                let max = 0;
                                let mean = 0;
                                let median = -1;
                                let sum = 0;

                                measureDurations.forEach((d)=>{
                                    min = Math.min(min, d);
                                    max = Math.max(max, d);
                                    sum += d;
                                });

                                mean = sum / measureDurations.length;

                                let middleIndex = Math.floor(measureDurations.length / 2);

                                if(measureDurations.length % 2 === 1) {
                                    //Odd
                                    median = measureDurations[middleIndex];
                                } else {
                                    //Even
                                    median = measureDurations[middleIndex-1]/2.0 + measureDurations[middleIndex] / 2.0;
                                }

                                data.push({
                                    "name": key,
                                    "invocations": measureDurations.length,
                                    "mean": +mean.toFixed(3),
                                    "min": +min.toFixed(3),
                                    "max": +max.toFixed(3),
                                    "median": +median.toFixed(3),
                                    "sum": +sum.toFixed(3)
                                })
                            });

                            console.table(data);
                        }

                        static reset() {
                            performance.clearMarks();
                            performance.clearMeasures();
                        }
                    }

                    VarvPerformance.enabled = false;
                    VarvPerformance.prefix = "";
                    window.VarvPerformance = VarvPerformance;

                    </SCRIPT><SCRIPT id="YAMLJSONConverter-script" type="disabled">
                    /**
                     *  YAMLJSONConverter - Convert between JSON and YAML program code
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class YAMLJSONConverter {
                        /**
                         * True/False depending on if the string code can be parsed as YAML
                         * @param {string} code
                         */
                        static isYAML(code) {
                            try {
                                jsyaml.load(code);
                                return true;
                            } catch(e) {
                                //Ignore
                            }

                            return false;
                        }

                        /**
                         * True/False depending on if the string code can be parsed as JSON
                         * @param {string} code
                         */
                        static isJSON(code) {
                            try {
                                JSON.parse(code);
                                return true;
                            } catch(e) {
                                //Ignore
                            }

                            return false;
                        }

                        /**
                         * Parses the given code string into an object, using either YAML or JSON
                         * @param {string} code
                         */
                        static loadFromString(code) {
                            let obj = null;
                            let loader = null;

                            try {
                                obj = JSON.parse(code);
                                loader = "JSON";
                            } catch(jsonEx) {
                                try {
                                    obj = jsyaml.load(code);
                                    loader = "YAML";
                                } catch(yamlEx) {
                                    throw new Error("Unable to Parse string as YAML ("+yamlEx+") or JSON ("+jsonEx+")");
                                }
                            }

                            return {
                                loader,
                                obj
                            };
                        }

                        /**
                         * Converts the given code to YAML / JSON, to opposite of what the input was.
                         * @param code
                         */
                        static convert(code) {
                            let result = YAMLJSONConverter.loadFromString(code);

                            switch(result.loader) {
                                case "JSON":
                                    return jsyaml.dump(result.obj);
                                    break;
                                case "YAML":
                                    return JSON.stringify(result.obj, null, 2);
                                    break;
                                default:
                                    console.warn("Unknown obj loader...");
                                    return code;
                            }
                        }
                    }
                    window.YAMLJSONConverter = YAMLJSONConverter;

                    </SCRIPT><SCRIPT id="Concept-script" type="disabled">
                    /**
                     *  Concept - The central part of the Varv language
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class Concept {
                        constructor(name) {
                            this.name = name;
                            this.properties = new Map();
                            this.actions = new Map();
                            this.behaviours = new Map();
                            this.triggers = new Map();
                            this.mappings = new Map();

                            this.otherConcepts = new Set();
                            this.appearedCallbacks = [];
                            this.disappearedCallbacks = [];
                        }

                        addTrigger(trigger, removeOld=false) {
                            if(removeOld) {
                                let oldTrigger = this.triggers.get(trigger.name);

                                if (oldTrigger != null) {
                                    if (Concept.DEBUG) {
                                        console.log("Overwriting trigger:", oldTrigger, trigger);
                                    }

                                    this.removeTrigger(oldTrigger);
                                }
                            }

                            this.triggers.set(trigger.name, trigger);
                        }

                        removeTrigger(trigger) {
                            this.triggers.delete(trigger.name);
                            trigger.disable(this);
                        }

                        getTrigger(name) {
                            return this.triggers.get(name);
                        }

                        addBehaviour(behaviour, removeOld=false) {
                            if(removeOld) {
                                let oldBehaviour = this.behaviours.get(behaviour.name);

                                if (oldBehaviour != null) {
                                    if (Concept.DEBUG) {
                                        console.log("Overwriting behaviour:", oldBehaviour, behaviour);
                                    }

                                    this.removeBehaviour(oldBehaviour);
                                }
                            }

                            this.behaviours.set(behaviour.name, behaviour);

                            if(behaviour.callableAction) {
                                this.addAction(behaviour.actionChain);
                            }
                        }

                        removeBehaviour(behaviour) {
                            this.removeAction(behaviour.actionChain);
                            this.behaviours.delete(behaviour.name);
                            behaviour.destroy();
                        }

                        getBehaviour(name) {
                            return this.behaviours.get(name);
                        }

                        addAction(action, removeOld=false) {
                            if(removeOld) {
                                let oldAction = this.actions.get(action.name);

                                if (oldAction != null) {
                                    if (Concept.DEBUG) {
                                        console.log("Overwriting action:", oldAction, action);
                                    }

                                    this.removeAction(oldAction);
                                }
                            }

                            this.actions.set(action.name, action);
                        }

                        removeAction(action) {
                            this.actions.delete(action.name);
                        }

                        getAction(name) {
                            return this.actions.get(name);
                        }

                        addProperty(property, removeOld=false) {
                            if(removeOld) {
                                let oldProperty = this.properties.get(property.name);

                                if (oldProperty != null) {
                                    if (Concept.DEBUG) {
                                        console.log("Overwriting property:", oldProperty, property);
                                    }

                                    this.removeProperty(oldProperty);
                                }
                            }

                            this.properties.set(property.name, property);
                        }

                        removeProperty(property) {
                            this.unmapProperty(property);
                            this.properties.delete(property.name);
                        }

                        getProperty(name) {
                            const self = this;

                            let markStart = VarvPerformance.start();

                            let property = null;

                            if(name === "uuid") {
                                property = {
                                    name: "uuid",
                                    type: "string",
                                    addUpdatedCallback: () => {},
                                    removeUpdatedCallback: () => {},
                                    isConceptType: () => false,
                                    isConceptArrayType: () => false,
                                    getValue: (uuid) => {
                                        return uuid;
                                    }
                                };
                            } else if(name === "concept::uuid") {
                                property = {
                                    name: "uuid",
                                    type: "string",
                                    addUpdatedCallback: ()=>{},
                                    removeUpdatedCallback: ()=>{},
                                    isConceptType: () => false,
                                    isConceptArrayType: () => false,
                                    getValue: (uuid) => {
                                        return uuid;
                                    }
                                };
                            } else if(name === "concept::name") {
                                property = {
                                    name: "name",
                                    type: "string",
                                    addUpdatedCallback: ()=>{},
                                    removeUpdatedCallback: ()=>{},
                                    isConceptType: () => false,
                                    isConceptArrayType: () => false,
                                    getValue: (uuid) => {
                                        return self.name;
                                    }
                                };
                            } else {
                                property = this.properties.get(name);
                            }

                            if(property != null) {
                                VarvPerformance.stop("Concept.getProperty", markStart);
                                return property;
                            } else {
                                VarvPerformance.stop("Concept.getProperty.error", markStart);
                                throw new Error("No property ["+name+"] on ["+this.name+"]");
                            }
                        }

                        async setPropertyValue(uuid, name, value, skipStateChangeTrigger=false) {
                            await this.getProperty(name).setValue(uuid, value, skipStateChangeTrigger);
                        }

                        getPropertyValue(uuid, name) {
                            return this.getProperty(name).getValue(uuid);
                        }

                        setupTriggers(debug) {
                            const self = this;

                            if(debug) {
                                console.groupCollapsed("Setting up triggers on concept [" + this.name + "]");
                            }

                            for(let trigger of this.triggers.values()) {
                                if(debug) {
                                    console.log("Enabling trigger:", trigger);
                                }
                                trigger.enable(this);
                            }

                            //We should listen for deleted concepts, and update our property when any we have are deleted...
                            this.deletedTriggerDeleter = Trigger.registerTriggerEvent("deleted", async (contexts)=>{
                                for(let context of contexts) {
                                    if(context.target != null) {
                                        let concept = await VarvEngine.getConceptFromUUID(context.target);
                                        if(concept != null) {
                                            //A concept was deleted, check if we have any properties with the given concept
                                            for(let property of self.properties.values()) {
                                                if(property.holdsConceptOfType(concept)) {
                                                    await property.removeAllReferences(self.name, context.target);
                                                }
                                            }
                                        }
                                    }
                                }
                            });

                            if(debug) {
                                console.groupEnd();
                            }
                        }

                        destroyTriggers() {
                            for(let trigger of this.triggers.values()) {
                                if(Concept.DEBUG) {
                                    console.log("Disabling trigger:", trigger);
                                }
                                trigger.disable(this);
                            }

                            this.deletedTriggerDeleter.delete();
                        }

                        async create(wantedUUID=null, properties=null){
                            let mark = VarvPerformance.start();
                            if(wantedUUID == null) {
                                let uuidMark = VarvPerformance.start();
                                wantedUUID = UUIDGenerator.generateUUID("concept");
                                VarvPerformance.stop("Concept.create.generateUUID", uuidMark);
                            } else {

                                // TODO is this correct?

                                let oldConcept = await VarvEngine.getConceptFromUUID(wantedUUID);

                                //If already present, just return as if it has been created?
                                if(oldConcept != null) {
                                    if(oldConcept !== this) {
                                        throw new Error("Trying to create ["+wantedUUID+"] as ["+this.name+"] but it is already registered as a ["+oldConcept.name+"]");
                                    }

                                    throw new Error("Trying to create ["+wantedUUID+"] that already existed, as the same concept type..");
                                }
                            }

                            await VarvEngine.registerConceptFromUUID(wantedUUID, this);
                            await this.appeared(wantedUUID, true);

                            if (properties != null) {
                                for (let key of Object.keys(properties)) {
                                    let value = properties[key];

                                    await this.setPropertyValue(wantedUUID, key, value, false);
                                }
                            } else {
                                //Now trigger stateChanged for all properties
                                for(let [key, prop] of this.properties) {
                                    let value = prop.getDefaultValue();
                                    await prop.stateChanged(wantedUUID, value);
                                }
                            }

                            await this.created(wantedUUID);

                            for (let callback of this.appearedCallbacks) {
                                await callback(wantedUUID, this);
                            }

                            VarvPerformance.stop("Concept.create", mark);

                            return wantedUUID;
                        }

                        /**
                         * Clones the given UUID into a new one
                         * @param {type} sourceUUID
                         * @returns {@var;wantedUUID}
                         */
                        async clone(sourceUUID, deep=false, alreadyClonedReferences={}){
                            let clonedProperties = {};
                            for (const [propertyName, property] of this.properties){
                                clonedProperties[propertyName] = await property.getValue(sourceUUID);

                                if (deep){
                                    async function cloneUUID(propertyConcept, uuid){
                                        let propertyActualConcept = await VarvEngine.getConceptFromUUID(uuid);
                                        if (!propertyActualConcept) {
                                            console.warn("Invalid reference to UUID '"+uuid+"' while deep-cloning property "+propertyName+" on "+propertyConcept.name+", the property was left as is (invalid)");
                                            return uuid;
                                        }
                                        if (uuid===sourceUUID) throw new Error("Currently no support for deep cloning of concept instances with properties that contain direct self-references");
                                        // TODO: cycles too

                                        // Check if we already cloned it, if not do so
                                        if (alreadyClonedReferences[uuid]){
                                            return alreadyClonedReferences[uuid];
                                        } else {
                                            let theClone = await propertyConcept.clone(uuid, true);
                                            alreadyClonedReferences[uuid] = theClone;
                                            return theClone;
                                        }
                                    }

                                    // Referenced Concepts and Concept reference lists should also be cloned
                                    if (property.isConceptType()){
                                        let propertyConcept = await VarvEngine.getConceptFromType(property.getType());
                                        clonedProperties[propertyName] = await cloneUUID(propertyConcept, clonedProperties[propertyName]);
                                    }
                                    if (property.isConceptArrayType()){
                                        let propertyConcept = await VarvEngine.getConceptFromType(property.getArrayType());
                                        let newPropertyValue = [];
                                        for(let i = 0; i < clonedProperties[propertyName].length; i++) {
                                            newPropertyValue.push(await cloneUUID(propertyConcept, clonedProperties[propertyName][i]));
                                        }
                                        clonedProperties[propertyName] = newPropertyValue;
                                    }
                                };
                            }

                            return this.create(null, clonedProperties);
                        }

                        finishSetup(debug) {
                            if(debug) {
                                console.groupCollapsed("Finishing concept:", this.name);
                            }
                            //this.finishProperties(debug);
                            this.finishBehaviours(debug);
                            this.setupTriggers(debug);
                            if(debug) {
                                console.groupEnd();
                            }
                        }

                        doAfterSpecLoadSetup(debug) {
                            let mark = VarvPerformance.start();
                            this.finishProperties(debug);
                            VarvPerformance.stop("Concept.doAfterSpecLoadSetup", mark, this.name);
                        }

                        finishProperties(debug) {
                            let self = this;

                            if(debug) {
                                console.group("Properties:");
                            }

                            this.properties.forEach((property)=>{
                                if(debug) {
                                    console.log(property)
                                }
                                property.finishSetup(self);
                            });

                            if(debug) {
                                console.groupEnd();
                            }
                        }


                        finishBehaviours(debug) {
                            if(debug) {
                                console.group("Behaviours:");
                            }
                            this.behaviours.forEach((behaviour, key)=>{
                                if(debug) {
                                    console.log(behaviour);
                                }
                                behaviour.setupEvents();
                            });
                            if(debug) {
                                console.groupEnd();
                            }
                        }

                        omit(omitConfig) {
                            let self = this;

                            if(omitConfig.schema != null) {
                                if(!Array.isArray(omitConfig.schema)) {
                                    omitConfig.schema = [omitConfig.schema];
                                }
                                omitConfig.schema.forEach((propertyName)=>{
                                    let property = self.getProperty(propertyName);
                                    if(property != null) {
                                        self.removeProperty(property);
                                    }
                                });
                            }

                            if(omitConfig.actions != null) {
                                if(!Array.isArray(omitConfig.actions)) {
                                    omitConfig.actions = [omitConfig.actions];
                                }

                                omitConfig.actions.forEach((actionName)=>{
                                    let behaviour = self.getBehaviour(actionName);
                                    if(behaviour != null) {
                                        self.removeBehaviour(behaviour);
                                    }

                                    let action = self.getAction(actionName);
                                    if(action != null) {
                                        self.removeAction(action);
                                    }
                                });
                            }
                        }

                        /**
                         * Import the otherConcept into this one. This concept will be the combination of both concepts but retains its name.
                         * In case of clashes the otherConcept will override existing entries in this concept.
                         *
                         * @param {Concept} otherConcept Other concept to import into this one
                         */
                        join(otherConcept){
                            if(this === otherConcept) {
                                console.warn("Attempting to join concept to itself!");
                                return;
                            }

                            if(Concept.DEBUG) {
                                console.group("Joining:", otherConcept.name, " into ", this.name);
                            }

                            const self = this;

                            otherConcept.properties.forEach((property)=>{
                                self.addProperty(property.cloneFresh(self), true);
                            });

                            for (let [propertyName, mappings] of otherConcept.mappings){
                                this.mapProperty(this.getProperty(propertyName), mappings);
                            }

                            otherConcept.behaviours.forEach((behaviour)=>{
                                self.addBehaviour(behaviour.cloneFresh(self), true);
                            });

                            this.otherConcepts.add(otherConcept.name);
                            otherConcept.otherConcepts.forEach((otherConceptType)=>{
                                self.otherConcepts.add(otherConceptType);
                            })

                            if(Concept.DEBUG) {
                                console.groupEnd();
                            }
                        }

                        unmapProperty(property) {
                            this.mappings.get(property.name).forEach((datastoreName)=>{
                                let datastore = Datastore.getDatastoreFromName(datastoreName);
                                if(datastore != null) {
                                    datastore.removeBackingStore(this, property);
                                } else {
                                    // TODO: Throw an error here?, We might just be unmapping from a join before datastores are even a thing...
                                }
                            });
                            this.mappings.delete(property.name);
                        }

                        mapProperty(property, propertyMappings){
                            this.mappings.set(property.name, propertyMappings);
                        }

                        enableMappings(debug = false) {
                            const self = this;
                            this.mappings.forEach((propertyMappings, propertyName)=>{
                                let property = self.getProperty(propertyName);

                                if(debug) {
                                    console.log(propertyName, propertyMappings);
                                }

                                let sharedDataStores = [];

                                propertyMappings.forEach((datastoreName)=>{
                                    let datastore = Datastore.getDatastoreFromName(datastoreName);

                                    if(datastore != null) {
                                        if(datastore.isShared()) {
                                            sharedDataStores.push(datastoreName);
                                        }

                                        datastore.createBackingStore(this, property);
                                    } else {
                                        if (!Datastore.optionalDatastores.includes(datastoreName)) console.warn("["+self.name+"] is attempting to map ["+propertyName+"] to a non existing datastore ["+datastoreName+"]");
                                    }
                                });

                                if(sharedDataStores.length > 1) {
                                    console.log("%c Property "+self.name+"."+propertyName+" is mapped to multiple shared datastores ["+sharedDataStores+"], this can create race conditions in multi user use cases.", "background: yellow; color: red;");
                                }
                            });
                        }

                        async delete(uuid){
                            // Trigger deleted() trigger with target set to uuid
                            await this.deleted(uuid);

                            await this.disappeared(uuid);
                        }

                        addAppearedCallback(callback) {
                            this.appearedCallbacks.push(callback);
                        }

                        addDisappearedCallback(callback) {
                            this.disappearedCallbacks.push(callback);
                        }

                        async deleted(uuid) {
                            let mark = VarvPerformance.start();
                            await Trigger.trigger("deleted", {
                                target: uuid
                            });
                            VarvPerformance.stop("Concept.Event.deleted", mark);
                        }

                        async created(uuid) {
                            let mark = VarvPerformance.start();
                            await Trigger.trigger("created", {
                                target: uuid
                            });
                            VarvPerformance.stop("Concept.Event.created", mark);
                        }

                        async appeared(uuid, skipCallback=false) {
                            let mark = VarvPerformance.start();
                            // This instance just appeared in at least one datastore
                            await VarvEngine.sendEvent("appeared", {
                                target: uuid,
                                concept: this
                            });

                            if(!skipCallback) {
                                for (let callback of this.appearedCallbacks) {
                                    await callback(uuid, this);
                                }
                            }

                            VarvPerformance.stop("Concept.Event.appeared", mark);
                        }
                        async disappeared(uuid) {
                            let mark = VarvPerformance.start();

                            // This instance just disappeared in at least one datastore
                            await VarvEngine.sendEvent("disappeared", {
                                target: uuid,
                                concept: this
                            });

                            //Unregister the UUID
                            VarvEngine.deregisterConceptFromUUID(uuid, this);

                            for(let callback of this.disappearedCallbacks) {
                                await callback(uuid, this);
                            }

                            VarvPerformance.stop("Concept.Event.disappeared", mark);
                        }

                        async destroy() {
                            const self = this;

                            if(Concept.DEBUG) {
                                console.log("Destroying:", this);
                            }

                            //Destroy triggers
                            this.destroyTriggers();

                            //Destroy properties
                            for(let property of this.properties.values()) {
                                if(Concept.DEBUG) {
                                    console.log("Derigestering property:", property);
                                }
                                //Brute force trying to remove from any datastore known to mankind...
                                Datastore.datastores.forEach((datastore)=>{
                                    try {
                                        datastore.removeBackingStore(self, property);
                                    } catch(e) {
                                        //Ignore
                                    }
                                })
                            }

                            //Destroy behaviours
                            for(let behaviour of this.behaviours.values()) {
                                behaviour.destroy();
                            }

                            //Destroy actions
                            this.actions = null;

                            this.triggers = null;
                            this.properties = null;
                            this.behaviours = null;

                            if(Concept.DEBUG) {
                                console.log("Deregistering from VarvEngine...");
                            }
                            VarvEngine.deregisterConceptFromType(this.name);
                        }

                        isA(conceptType) {
                            if(conceptType instanceof Concept) {
                                conceptType = conceptType.name;
                            }

                            return this.name === conceptType || this.otherConcepts.has(conceptType);
                        }
                    }
                    Concept.DEBUG = false;
                    window.Concept = Concept;

                    </SCRIPT><SCRIPT id="Property-script" type="disabled">
                    /**
                     *  Property - A Property on a Concept
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Defaults:
                     *
                     * String: "",
                     * Boolean: false,
                     * Number: 0,
                     * Array: [],
                     * Concept: null
                     */

                    /**
                     * Property options:
                     *
                     * number - default, min, max
                     * boolean - default
                     * string - default, enum, matches
                     * array - max
                     */

                    class Property {
                        constructor(name, options={}) {
                            const self = this;

                            this.derivedOldValues = new Map();

                            this.cloneData = {
                                name: name,
                                options: options!=null?JSON.parse(JSON.stringify(options)):null
                            }

                            //Shorthand
                            if(typeof options === "string") {
                                let type = options;
                                options = {};
                                options[type] = {};
                            }

                            if(Object.keys(options).length > 1 && options.type != null) {
                                if(Property.DEBUG) {
                                    console.group("This property was defined with key 'type':", options);
                                }

                                let temp = options;

                                options = {};

                                options[temp.type] = temp;

                                delete options[temp.type].type;

                                if(Property.DEBUG) {
                                    console.log(options);
                                    console.groupEnd();
                                }
                            }

                            this.name = name;
                            this.type = Object.keys(options)[0];
                            this.options = options[this.type];

                            if(this.type === "array" && typeof this.options === "string") {
                                this.options = {
                                    items: this.options
                                }
                            }

                            this.setCallbacks = [];
                            this.getCallbacks = [];
                            this.updatedCallbacks = [];

                            if(this.options.derive != null) {
                                this.derived = {};

                                if(this.options.derive.transform == null) {
                                    throw new Error("Missing transform option for derive from:"+name);
                                }

                                if(this.options.derive.properties) {
                                    this.derived.properties = this.options.derive.properties;
                                    if(!Array.isArray(this.derived.properties)) {
                                        this.derived.properties = [this.derived.properties];
                                    }
                                }

                                if(this.options.derive.concepts) {
                                    this.derived.concepts = this.options.derive.concepts;
                                    if(!Array.isArray(this.derived.concepts)) {
                                        this.derived.concepts = [this.derived.concepts];
                                    }
                                }

                                this.derived.transform = this.options.derive.transform;
                            }
                        }

                        cloneFresh() {
                            return new Property(this.cloneData.name, this.cloneData.options);
                        }

                        /**
                         * @param {Concept} concept
                         */
                        finishSetup(concept) {
                            const self = this;

                            if(this.derived != null) {
                                let mark = VarvPerformance.start();
                                async function updateFunction(uuid) {
                                    try {
                                        await self.getValue(uuid, true);
                                    } catch(e) {
                                        console.warn("Error while updating derived value for ["+self.name+"]:", e, self);
                                    }
                                }

                                async function resetFunction() {
                                    let uuids = await VarvEngine.getAllUUIDsFromType(concept.name, true);

                                    for(let uuid of uuids) {
                                        try {
                                            await self.getValue(uuid, true);
                                        } catch(e) {
                                            console.warn("Error while updating derived value for ["+self.name+"]:", e, self);
                                        }
                                    }
                                }

                                if(this.derived.properties != null) {
                                    try {
                                        this.derived.properties.forEach((propertyName) => {
                                            VarvEngine.lookupProperty(null, concept, propertyName).then((lookupResult) => {
                                                if(lookupResult.property != null) {
                                                    if(concept.name === lookupResult.concept.name) {
                                                        lookupResult.property.addUpdatedCallback(updateFunction);
                                                    } else {
                                                        lookupResult.property.addUpdatedCallback(resetFunction);
                                                    }
                                                }
                                            }).catch((e)=>{
                                                console.groupCollapsed("Error in derived property ["+this.name+"]");
                                                console.log("Unable to setup property update callback for property:", propertyName);
                                                console.log("Error:", e);
                                                console.log("Derived property:", this);
                                                console.log("Concept:", concept);
                                                console.groupEnd();
                                            });
                                        });
                                    } catch(e) {
                                        console.warn(e);
                                    }
                                }

                                if(this.derived.concepts != null) {
                                    try {
                                        this.derived.concepts.forEach((conceptName) => {
                                            let concept = VarvEngine.getConceptFromType(conceptName);
                                            concept.addAppearedCallback(resetFunction);
                                            concept.addDisappearedCallback(resetFunction);
                                        });
                                    } catch(e) {
                                        console.warn(e);
                                    }
                                }

                                VarvPerformance.stop("Property.finishSetup.derived", mark);
                            }
                        }

                        getFullTypeString() {
                            let type = this.getType();

                            if(typeof type === "string") {
                                let possibleConcept = VarvEngine.getConceptFromType(type);
                                if(possibleConcept != null) {
                                    type = ["concept", type];
                                }
                            }

                            if(type === "array") {
                                let arrayType = this.getArrayType();
                                type = arrayType+"[]";

                                if(typeof arrayType === "string") {
                                    let possibleConcept = VarvEngine.getConceptFromType(arrayType);
                                    if (possibleConcept != null) {
                                        type = ["concept[]", arrayType+"[]"];
                                    }
                                }
                            }

                            return type;
                        }

                        getType() {
                            return this.type;
                        }

                        getArrayType() {
                            return this.options.items;
                        }

                        isConceptType() {
                            if(typeof this.type === "string") {
                                return VarvEngine.getConceptFromType(this.type) != null;
                            }

                            return false;
                        }

                        isConceptArrayType() {
                            if(this.type === "array" && typeof this.options.items === "string") {
                                let concept = VarvEngine.getConceptFromType(this.options.items);

                                return concept != null;
                            }

                            return false;
                        }

                        isDerived(){
                            return this.derived != null;
                        }

                        async removeAllReferences(propertyConceptType, removeUuid) {
                            //Dont remove from derived
                            if(this.isDerived()) {
                                return;
                            }

                            if(Property.DEBUG) {
                                console.group("["+propertyConceptType+" - "+this.name+"] Removing references to ["+removeUuid+"]");
                            }

                            for(let propertyConceptUUID of await VarvEngine.getAllUUIDsFromType(propertyConceptType)) {
                                let value = await this.getValue(propertyConceptUUID);

                                if(this.type === "array") {
                                    //Concept array property

                                    let beforeLength = value.length;

                                    value = value.filter((arrayElm) => {
                                        return arrayElm !== removeUuid;
                                    });

                                    if(value.length !== beforeLength) {
                                        if(Property.DEBUG) {
                                            console.log("Found reference in array!");
                                        }

                                        //We removed something, setValue
                                        await this.setValue(propertyConceptUUID, value);
                                    }
                                } else {
                                    //Concept property
                                    if(value === removeUuid) {
                                        if(Property.DEBUG) {
                                            console.log("Found reference!")
                                        }
                                        await this.setValue(propertyConceptUUID, null);
                                    }
                                }
                            }

                            if(Property.DEBUG) {
                                console.groupEnd();
                            }
                        }

                        holdsConceptOfType(concept) {
                            //If not a concept property or array, just skip.
                            if(!this.isConceptType() && !this.isConceptArrayType()) {
                                return false;
                            }

                            let types = [concept.name];
                            concept.otherConcepts.forEach((otherConcept)=>{
                                types.push(otherConcept);
                            });

                            let handlesType = false;

                            for(let type of types) {
                                handlesType = handlesType || this.type === type || (this.type === "array" && this.options.items === type);
                            }

                            return handlesType;
                        }

                        addUpdatedCallback(callback) {
                            this.updatedCallbacks.push(callback);
                        }

                        removeUpdatedCallback(callback) {
                            let index = this.updatedCallbacks.indexOf(callback);
                            if (index==-1){
                                console.warn("Cannot remove updatedcallback that isn't part of "+this.name+" list of callbacks: "+callback+" list is "+this.updatedCallbacks);
                                return;
                            }
                            this.updatedCallbacks.splice(index, 1);
                        }

                        addSetCallback(callback) {
                            this.setCallbacks.push(callback);
                        }

                        removeSetCallback(callback) {
                            let index = this.setCallbacks.indexOf(callback);
                            if (index==-1){
                                console.warn("Cannot remove setcallback that isn't part of "+this.name+" list of callbacks: "+callback+" list is "+this.setCallbacks);
                                return;
                            }
                            this.setCallbacks.splice(index, 1);
                        }

                        addGetCallback(callback) {
                            this.getCallbacks.push(callback);
                        }

                        removeGetCallback(callback) {
                            let index = this.getCallbacks.indexOf(callback);
                            if (index==-1){
                                console.warn("Cannot remove getcallback that isn't part of "+this.name+" list of callbacks: "+callback+" list is "+this.getCallbacks);
                                return;
                            }
                            this.getCallbacks.splice(index, 1);
                        }

                        async validateInternal(value, type, options) {
                            const self = this;

                            let validType = false;

                            if(value === null) {
                                return true;
                            }

                            switch(type) {
                                case "number": {
                                    validType = typeof value === "number";
                                    break;
                                }
                                case "string": {
                                    validType = typeof value === "string";
                                    break;
                                }
                                case "boolean": {
                                    validType = typeof value === "boolean";
                                    break;
                                }
                                case "array": {
                                    validType = Array.isArray(value);
                                    break;
                                }

                                default:
                                    let typeConcept = VarvEngine.getConceptFromType(type);
                                    if( typeConcept != null) {
                                        if(typeof value === "string") {
                                            let valueConcept = await VarvEngine.getConceptFromUUID(value);

                                            //If valueconcept is null, we dont know what type it is, pretend its of the correct type.
                                            //To fix this, all datastores need to report their known UUID's before they load values

                                            validType = valueConcept != null ? (valueConcept.isA(typeConcept.name)) : true;
                                        } else {
                                            validType = false;
                                        }
                                    } else {
                                        console.warn("Unknown type to validate:", type);
                                    }
                            }

                            let validValue = true;
                            if(type === "array" && options.items != null) {
                                for(let arrayValue of value) {
                                    validValue = validValue && await self.validateInternal(arrayValue, options.items, null);
                                }
                            }

                            // TODO validate value according to options
                            let validOptions = true;
                            //Validate options
                            if(options != null) {
                                if (type === "string") {
                                    if (options.enum != null) {
                                        validOptions = options.enum.includes(value);
                                    }
                                    if (options.matches != null) {
                                        const regexp = new RegExp(options.matches);
                                        validOptions = value.match(regexp);
                                    }
                                }

                                if (type === "number") {
                                    if (options.max != null) {
                                        validOptions = validOptions && value <= options.max;
                                    }
                                    if (options.min != null) {
                                        validOptions = validOptions && value >= options.min;
                                    }
                                }

                                if (type === "array") {
                                    if (options.max != null) {
                                        validOptions = value.length <= this.options.max;
                                    }
                                }
                            }

                            return validType && validValue && validOptions;
                        }

                        async validate(value) {
                            return await this.validateInternal(value, this.type, this.options);
                        }

                        typeCast(inputValue, overrideType = null) {
                            let mark = VarvPerformance.start();
                            if(inputValue == null) {
                                return null;
                            }

                            try {
                                const self = this;

                                let castedValue = inputValue;

                                let type = this.type;

                                if (overrideType !== null) {
                                    type = overrideType;
                                }

                                switch (type) {
                                    case "string": {
                                        if(typeof inputValue === "string") {
                                            return inputValue;
                                        }

                                        castedValue = "" + inputValue;
                                        break;
                                    }

                                    case "number": {
                                        if(typeof inputValue === "number") {
                                            return inputValue;
                                        }

                                        castedValue = Number(inputValue);
                                        if (isNaN(castedValue)) {
                                            throw new Error("Unable to typecast [" + inputValue + "] to [number]");
                                        }
                                        break;
                                    }

                                    case "boolean": {
                                        if(typeof inputValue === "boolean") {
                                            return inputValue;
                                        }

                                        if(typeof inputValue === "string") {
                                            const inputValueLower = inputValue.toLowerCase();
                                            if(inputValue !== "0" && inputValue !== "1" && inputValue !== "true" && inputValue !== "false"){
                                                throw new Error("Unable to typecast [" + inputValue + "] to [boolean]");
                                            }

                                            castedValue = (inputValue === "true" || inputValue === "1");
                                        }

                                        if(typeof inputValue === "number") {
                                            if(inputValue !== 0 && inputValue !== 1){
                                                throw new Error("Unable to typecast [" + inputValue + "] to [boolean]");
                                            }
                                            castedValue = inputValue === 1;
                                        }

                                        break;
                                    }

                                    case "array": {
                                        if (Array.isArray(inputValue)) {
                                            castedValue = inputValue.map((value) => {
                                                return self.typeCast(value, this.options.items);
                                            });
                                        } else {
                                            let parsedArray = JSON.parse(inputValue);

                                            if (Array.isArray(parsedArray)) {
                                                castedValue = parsedArray.map((value) => {
                                                    return self.typeCast(value, this.options.items);
                                                });
                                            } else {
                                                throw new Error("Attempted to typecast to an array type, but input value was not an array and could not be parsed as an array: " + inputValue);
                                            }
                                        }
                                        break;
                                    }

                                    default:
                                        let typeConcept = VarvEngine.getConceptFromType(type);
                                        if(typeConcept != null) {
                                            return "" + inputValue;
                                        }

                                        throw new Error("Unknown how to type cast to type: " + type);
                                }

                                VarvPerformance.stop("Property.typeCast", mark);

                                return castedValue;
                            } catch(e) {
                                throw e;
                            }
                        }

                        async setValue(uuid, value, skipStateChangeTrigger=false) {
                            let totalMark = VarvPerformance.start();

                            if(this.isDerived()) {
                                console.warn("setValue called on a derived property (Might be a left over property in DOMStore from when it was not derived?):", this.name, uuid, value);
                                return;
                            }

                            if(!await this.validate(value)) {
                                let type = typeof value;
                                if(Array.isArray(value)){
                                    type = "array";
                                }
                                throw new Error("Value ["+value+":"+(type)+"] does not validate on property ["+this.name+":"+this.type+"]");
                            }

                            if(this.setCallbacks.length === 0) {
                                throw new Error("No setCallbacks available for property ["+this.name+"]");
                            }

                            let mark = VarvPerformance.start();

                            let promises = [];

                            for(let setCallback of this.setCallbacks) {
                                let result = setCallback(uuid, value);
                                if(result instanceof Promise) {
                                    promises.push(result);
                                }
                            }

                            if(promises.length > 0) {
                                await Promise.all(promises);
                            }

                            PropertyCache.setCachedProperty(uuid+"."+this.name, value);

                            VarvPerformance.stop("Property.setValue.callbacks", mark);

                            let markUpdated = VarvPerformance.start();
                            await this.updated(uuid, value, skipStateChangeTrigger);
                            VarvPerformance.stop("Property.setValue.updated", markUpdated);
                            VarvPerformance.stop("Property.setValue", totalMark);
                        }

                        async updated(uuid, value, skipStateChangeTrigger=false) {
                            let mark = VarvPerformance.start();
                            let promises = [];
                            for(let updateCallback of this.updatedCallbacks.slice()) {
                                let result = await updateCallback(uuid, value);

                                if(result instanceof Promise) {
                                    promises.push(result);
                                }
                            }
                            if(promises.length > 0) {
                                await Promise.all(promises);
                            }
                            VarvPerformance.stop("Property.updated.callbacks", mark);

                            let stateChangeMark = VarvPerformance.start();
                            if(!skipStateChangeTrigger) {
                                await this.stateChanged(uuid, value);
                            }
                            VarvPerformance.stop("Property.updated.stateChanged", stateChangeMark);
                            VarvPerformance.stop("Property.updated", mark);
                        }

                        async deriveValue(uuid) {
                            let mark = VarvPerformance.start();
                            if(Property.DEBUG) {
                                console.group("Deriving property ["+this.name+"] from ["+JSON.stringify(this.derived)+"]");
                                console.groupCollapsed("Trace");
                                console.trace();
                                console.groupEnd();
                            }

                            //Try to derive property
                            let currentFakeContext = [{
                                target: uuid
                            }];

                            let lastTransformOutputVariable = null;

                            try {
                                for (let transform of this.derived.transform) {

                                    let transformActionName = null;

                                    if (Property.DEBUG) {
                                        console.log("Applying transform:", transform);
                                    }

                                    let transformActionOptions = {};

                                    if (typeof transform === "string") {
                                        transformActionName = transform;
                                    } else {
                                        transformActionName = Object.keys(transform)[0];
                                        transformActionOptions = Object.values(transform)[0];
                                    }

                                    let transformAction = Action.getPrimitiveAction(transformActionName, transformActionOptions);

                                    await ActionTrigger.before(transformAction, currentFakeContext);
                                    let mark = VarvPerformance.start();
                                    currentFakeContext = await transformAction.apply(currentFakeContext);
                                    if(transformAction.isPrimitive) {
                                        VarvPerformance.stop("PrimitiveAction-"+transformAction.name, mark);
                                    } else {
                                        VarvPerformance.stop("CustomAction-"+transformAction.name, mark);
                                    }
                                    await ActionTrigger.after(transformAction, currentFakeContext);

                                    if(Property.DEBUG) {
                                        console.log("CurentContext:", currentFakeContext);
                                    }

                                    if(transformActionOptions.as != null) {
                                        lastTransformOutputVariable = transformActionOptions.as;
                                    } else {
                                        lastTransformOutputVariable = Action.defaultVariableName(transformAction);
                                    }
                                }
                            } catch(e) {
                                if(e instanceof StopError) {
                                    console.log("Transform stopped: "+e.message);
                                } else {
                                    throw e;
                                }
                            }

                            if(lastTransformOutputVariable == null) {
                                throw new Error("Unable to extract a variable after transform has run, lastTransformOutputVariable was null!");
                            }

                            let result = null;

                            try {
                                result = Action.getVariable(currentFakeContext[0], lastTransformOutputVariable);
                            } catch(e) {
                                console.debug(e);

                                switch(this.type) {
                                    case "array":
                                        result = [];
                                }
                            }

                            if(!await this.validate(result)) {
                                throw new Error("Derived value ["+result+"] does not validate against type ["+this.type+"]");
                            }

                            if(Property.DEBUG) {
                                console.log("Resulting value:", result);
                                console.groupEnd();
                            }

                            VarvPerformance.stop("Property.deriveValue", mark);

                            return result;
                        }

                        purgeCache(uuid) {
                            PropertyCache.removeCachedProperty(uuid+"."+this.name);
                        }

                        getValue(uuid, forceDerivedReload) {
                            const self = this;

                            let mark = VarvPerformance.start();

                            if(this.derived != null) {
                                return new Promise(async (resolve, reject)=>{
                                    const derivedOldValue = self.derivedOldValues.get(uuid);

                                    if(typeof derivedOldValue !== "undefined" && !forceDerivedReload) {
                                        resolve(derivedOldValue);
                                    }

                                    try {
                                        const derivedValue = await self.deriveValue(uuid);
                                        self.derivedOldValues.set(uuid, derivedValue);


                                        if (typeof derivedOldValue === "undefined" || !self.isSame(derivedValue, derivedOldValue)) {
                                            await self.updated(uuid, derivedValue, false);
                                        }

                                        VarvPerformance.stop("Property.getValue.derived", mark);

                                        return resolve(derivedValue);
                                    } catch(e) {
                                        VarvPerformance.stop("Property.getValue.derived", mark);
                                        return reject(e);
                                    }
                                });
                            }

                            if(this.getCallbacks.length === 0) {
                                VarvPerformance.stop("Property.getValue.error", mark);
                                throw new Error("No getCallbacks available for property ["+this.name+"]");
                            }

                            let cachedProperty = PropertyCache.getCachedProperty(uuid+"."+this.name);
                            if(cachedProperty != null) {
                                VarvPerformance.stop("Property.getValue.cached", mark);
                                return cachedProperty;
                            }

                            return new Promise(async (resolve, reject)=>{

                                for(let getCallback of this.getCallbacks) {
                                    try {
                                        let value = null;

                                        let callbackReturn = getCallback(uuid);

                                        if(callbackReturn instanceof Promise) {
                                            callbackReturn = await callbackReturn
                                        }

                                        value = this.typeCast(callbackReturn);

                                        PropertyCache.setCachedProperty(uuid+"."+this.name, value);

                                        VarvPerformance.stop("Property.getValue.nonCached", mark);

                                        resolve(value);

                                        return;
                                    } catch(e) {
                                        //console.warn("Something went wrong (Using Default):", e);

                                        // Return default value, if no callback returns a value
                                    }
                                }

                                VarvPerformance.stop("Property.getValue.defaultValue", mark);

                                resolve(this.getDefaultValue());
                            });
                        }

                        getDefaultValue() {
                            if(this.options.default != null) {
                                return this.options.default;
                            }

                            switch(this.type) {
                                case "string":
                                    return "";
                                case "number":
                                    return 0;
                                case "boolean":
                                    return false;
                                case "array":
                                    return [];
                                default:
                                    if(VarvEngine.getConceptFromType(this.type) != null) {
                                        return null;
                                    }

                                    console.warn("Unknown type for default value:", this.type);
                            }
                        }

                        async stateChanged(uuid, value) {
                            let mark = VarvPerformance.start();
                            await Trigger.trigger("stateChanged", {
                                target: uuid,
                                property: this.name,
                                variables: {
                                    "currentValue": value,
                                    "property": this.name
                                }
                            });
                            VarvPerformance.stop("Property.event.stateChanged", mark);
                        }

                        isSame(value1, value2) {
                            switch(this.type) {
                                case "number":
                                case "string":
                                case "boolean":
                                    return value1 === value2;

                                case "array": {
                                    if(value1 == null) {
                                        return value2 == null;
                                    }

                                    if(value2 == null) {
                                        return value1 == null;
                                    }

                                    //Check if values are no match
                                    if(value1.length !== value2.length) {
                                        return false;
                                    }

                                    //Check each entry
                                    for(let i = 0; i<value1.length; i++) {
                                        if(value1[i] !== value2[i]) {
                                            return false;
                                        }
                                    }

                                    return true;
                                }

                                default: {
                                    if(this.isConceptType()) {
                                        return value1 === value2;
                                    }

                                    throw new Error("["+this.name+": "+this.type+"] Unable to check isSame of ["+value1+"] and ["+value2+"]");
                                }
                            }
                        }
                    }
                    Property.DEBUG = false;
                    window.Property = Property;

                    </SCRIPT><SCRIPT id="PropertyCache-script" type="disabled">


                    class PropertyCache {
                        static getCachedProperty(lookupKey) {
                            if(PropertyCache.cacheEnabled) {
                                let value = PropertyCache.cacheMap.get(lookupKey);

                                if(PropertyCache.DEBUG) {
                                    console.groupCollapsed("PropertyCache getting: ", lookupKey, value);
                                    console.trace();
                                    console.groupEnd();
                                }

                                return value;
                            } else {
                                return null;
                            }
                        }

                        static removeCachedProperty(lookupKey) {
                            if(PropertyCache.DEBUG) {
                                console.log("PropertyCache deleting: ", lookupKey);
                            }
                            PropertyCache.cacheMap.delete(lookupKey);
                        }

                        static setCachedProperty(lookupKey, value) {
                            if(PropertyCache.DEBUG) {
                                console.log("PropertyCache setting: ", lookupKey, value);
                            }
                            PropertyCache.cacheMap.set(lookupKey, value);
                        }

                        static reset() {
                            PropertyCache.cacheMap.clear();
                        }
                    }
                    PropertyCache.DEBUG = false;
                    PropertyCache.cacheEnabled = true;
                    PropertyCache.cacheMap = new Map();
                    window.PropertyCache = PropertyCache;

                    </SCRIPT><SCRIPT id="Datastore-script" type="disabled">
                    /**
                     *  DataStore - Superclass for all backing stores
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Datastores
                     * @namespace Datastores
                     */

                    // superclass for all datastores (mostly empty for potential later introspection code)
                    class Datastore {
                        constructor(name, options){
                            this.name = name;
                            this.options = options;
                            this.mappedConcepts = new Map();
                        }

                        isConceptMapped(concept){
                            return this.isConceptTypeMapped(concept.name);
                        }
                        isConceptTypeMapped(conceptTypeName){
                            return this.mappedConcepts.has(conceptTypeName);
                        }
                        isPropertyMapped(concept, property){
                            if (!this.isConceptMapped(concept)) return false;
                            return this.mappedConcepts.get(concept.name).has(property.name);
                        }
                        isPropertyNameMapped(conceptName, propertyName){
                            if (!this.isConceptTypeMapped(conceptName)) return false;
                            return this.mappedConcepts.get(conceptName).has(propertyName);
                        }
                        internalAddConceptMapping(concept){
                            if (!this.isConceptMapped(concept))
                                this.mappedConcepts.set(concept.name, new Map());
                        }
                        internalAddPropertyMapping(concept, property, trackingData={}){
                            if (this.isPropertyMapped(concept, property)){
                                throw new Error('Already has internal mapping for '+concept+"."+property);
                            }
                            this.internalAddConceptMapping(concept);
                            let propertyMap = this.mappedConcepts.get(concept.name);
                            propertyMap.set(property.name, trackingData);
                        }
                        internalRemovePropertyMapping(concept, property){
                            if (!this.isConceptMapped(concept)) throw new Error("Concept not mapped when trying to remove "+concept+"."+property);
                            let propertyMap = this.mappedConcepts.get(concept.name);
                            propertyMap.delete(property.name);
                        }

                        internalPropertyTrackingData(concept, property){
                            return this.mappedConcepts.get(concept.name).get(property.name);
                        }

                        createBackingStore(concept, property) {
                            throw new Error("createBackingStore, should always be overridden in Datastore subclass - "+this.constructor.name);
                        }

                        removeBackingStore(concept, property) {
                            throw new Error("removeBackingStore, should always be overridden in Datastore subclass - "+this.constructor.name);
                        }

                        isShared() {
                            return true;
                        }

                        async init() {
                            throw new Error("init, should always be overridden in Datastore subclass - "+this.constructor.name);
                        }

                        destroy() {
                            throw new Error("destroy, should always be overridden in Datastore subclass - "+this.constructor.name);
                        }

                        /**
                         *
                         * @param {String[]} typeNames
                         * @param {Filter} query
                         * @param {VarvContext} context
                         * @param {number} limit
                         * @param {Concept} localConcept
                         * @returns {Promise<String[]>}
                         */
                        async lookupInstances(typeNames, query, context, limit = 0, localConcept = null) {
                            throw new Error("Implement [lookupInstances] me in sub datastores! - "+this.constructor.name);
                        }

                        /**
                         * @param {String[]} typeNames
                         * @param {Filter} query
                         * @param {VarvContext} context
                         * @param {Concept} localConcept
                         * @returns {Promise<number>}
                         */
                        async countInstances(typeNames, query, context, localConcept) {
                            throw new Error("Implement [countInstances] me in sub datastores! - "+this.constructor.name);
                        }

                        /**
                         * @param {String[]} typeNames
                         * @param {Filter} query
                         * @param {VarvContext} context
                         * @param {Concept} localConcept
                         * @returns {Promise<boolean>}
                         */
                        async existsInstance(typeNames, query, context, localConcept) {
                            throw new Error("Implement [existsInstance] me in sub datastores! - "+this.constructor.name);
                        }

                        /**
                         *
                         * @param {String} uuid
                         * @returns {Promise<Concept>}
                         */
                        async lookupConcept(uuid) {
                            throw new Error("Implement [lookupConcept] me in sub datastores! - "+this.constructor.name);
                        }

                        static getDatastoreFromName(name) {
                            return Datastore.datastores.get(name);
                        }

                        static registerDatastoreType(name, datastoreType) {
                            Datastore.datastoreTypes.set(name, datastoreType);
                        }

                        static getDatastoreType(name) {
                            return Datastore.datastoreTypes.get(name);
                        }

                        static getAllDatastores() {
                            return Array.from(Datastore.datastores.values());
                        }
                    }
                    Datastore.DEBUG = false;
                    Datastore.datastores = new Map();
                    Datastore.optionalDatastores = ["cauldron"]; // A list of datastores for which there is no warning emitted if not found
                    Datastore.datastoreTypes = new Map();

                    window.Datastore = Datastore;

                    </SCRIPT><SCRIPT id="DirectDatastore-script" type="disabled">
                    class DirectDatastore extends Datastore {
                        constructor(name, options) {
                            super(name, options);

                            this.conceptUUIDMap = new Map();
                            this.conceptTypeUUIDMap = new Map();
                        }

                        registerConceptFromUUID(uuid, concept) {
                            if(this.isConceptMapped(concept)) {
                                this.conceptUUIDMap.set(uuid, concept);

                                let uuidSet = this.conceptTypeUUIDMap.get(concept.name);
                                if (uuidSet == null) {
                                    uuidSet = new Set();
                                    this.conceptTypeUUIDMap.set(concept.name, uuidSet);
                                }

                                uuidSet.add(uuid);
                            }
                        }

                        deregisterConceptFromType(type) {
                            const self = this;

                            this.getAllUUIDsFromType(type).forEach((uuid)=>{
                                self.deregisterConceptFromUUID(uuid);
                            });
                        }

                        deregisterConceptFromUUID(uuid) {
                            let concept = this.getConceptFromUUID(uuid);
                            this.conceptUUIDMap.delete(uuid);
                            if(concept != null) {
                                let uuidSet = this.conceptTypeUUIDMap.get(concept.name);
                                if (uuidSet != null) {
                                    uuidSet.delete(uuid);
                                }
                            }
                        }

                        getConceptFromUUID(uuid) {
                            return this.conceptUUIDMap.get(uuid);
                        }

                        getAllUUIDsFromType(type, includeOtherConcepts = false) {
                            const self = this;

                            let uuidSet = null;
                            if(!includeOtherConcepts) {
                                uuidSet = this.conceptTypeUUIDMap.get(type);
                            } else {
                                uuidSet = new Set();
                                VarvEngine.getAllImplementingConcepts(type).forEach((concept)=>{
                                    self.getAllUUIDsFromType(concept.name, false).forEach((uuid)=>{
                                        uuidSet.add(uuid);
                                    });
                                });
                            }
                            if (uuidSet == null) {
                                return [];
                            }
                            return Array.from(uuidSet);
                        }

                        async countInstances(typeNames, query, context, localConcept) {
                            let uuids = await this.lookupInstances(typeNames, query, context, 0, localConcept);
                            return uuids.length;
                        }

                        async existsInstance(typeNames, query, context, localConcept) {
                            let uuids = await this.lookupInstances(typeNames, query, context, 1, localConcept);
                            return uuids.length > 0;
                        }

                        async lookupInstances(typeNames, query, context, limit, localConcept) {
                            const self = this;

                            let uuidSet = new Set();

                            let markStart = VarvPerformance.start();

                            typeNames.forEach((type)=>{
                                self.getAllUUIDsFromType(type, false).forEach((uuid)=>{
                                    uuidSet.add(uuid);
                                });
                            });

                            VarvPerformance.stop("DirectDatastore.lookupInstances.getAll", markStart);

                            let result = [];

                            if(query != null) {
                                let markFilter = VarvPerformance.start();
                                let allPromises = [];
                                for(let uuid of uuidSet) {
                                    allPromises.push(query.filter({target: uuid}, localConcept));
                                }

                                let filterResult = await Promise.all(allPromises);

                                let index = 0;
                                for(let uuid of uuidSet) {
                                    if (filterResult[index]) {
                                        result.push(uuid);
                                    }
                                    index++;
                                }

                                VarvPerformance.stop("DirectDatastore.lookupInstances.filter", markFilter);
                            } else {
                                result.push(...uuidSet);
                            }

                            if(limit > 0 && result.length > limit) {
                                result.splice(limit, result.length-limit);
                            }

                            VarvPerformance.stop("DirectDatastore.lookupInstances", markStart);

                            return result;
                        }

                        async lookupConcept(uuid) {
                            let result = this.getConceptFromUUID(uuid);

                            if(result == null) {
                                throw Error("Unable to find concept from uuid: "+uuid);
                            }

                            return result;
                        }
                    }
                    window.DirectDatastore = DirectDatastore;

                    </SCRIPT><SCRIPT id="Trigger-script" type="disabled">
                    /**
                     *  Trigger - Superclass for all triggers
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Triggers are used to do something when something happens
                     * @namespace Triggers
                     */

                    const VarvEventPrefix = "VarvEvent.";
                    let triggeringEnabled = true;

                    class Trigger {
                        /**
                         * Create a new trigger
                         * @param {string} name - The name of this trigger
                         * @param {object|string} options - The options of this trigger
                         * @param {Concept} concept - The owning concept of this trigger
                         */
                        constructor(name, options, concept) {
                            this.options = options;
                            this.name = name;
                            this.concept = concept;
                        }

                        /**
                         * Destroy this trigger
                         * @param {Concept} concept - The concept this trigger is registered on
                         */
                        destroy() {
                            //Default implementation just disabled the trigger
                            this.disable();
                        }

                        /**
                         * Enable this trigger
                         */
                        enable() {
                            console.warn("Always override Trigger.enable in subclass!");
                        }

                        /**
                         * Disable this trigger
                         */
                        disable() {
                            console.warn("Always override Trigger.disable in subclass!");
                        }

                        /**
                         * Register a new type of trigger
                         * @param {string} type - The type of trigger to register
                         * @param {Trigger} trigger - The trigger to register
                         */
                        static registerTrigger(type, trigger) {
                            Trigger.triggers.set(type, trigger);
                        }

                        /**
                         * Checks if the given type corresponds to a trigger type
                         * @param {tring} type the type to check
                         * @returns {boolean} true/false depending on if type was a trigger type
                         */
                        static isTriggerType(type) {
                            return Trigger.triggers.has(type);
                        }

                        /**
                         * Create a new named instance of the given trigger type, using the given options
                         * @param {string} type - The type of trigger to create
                         * @param {string} name - The name to give the trigger
                         * @param {object} options - The options to pass along to the trigger
                         * @returns {Trigger} - The newly created trigger
                         */
                        static getTrigger(type, name, options, concept) {
                            let triggerClass = Trigger.triggers.get(type);

                            if (triggerClass == null) {
                                throw new Error("Unknown trigger [" + type + "]");
                            }

                            return new triggerClass(name, options, concept);
                        }

                        static registerTriggerEvent(triggerName, callback) {
                            return EventSystem.registerEventCallback(VarvEventPrefix+triggerName, async (evt)=>{
                                let contexts = Action.clone(evt.detail);

                                let callbackReturn = callback(contexts);

                                if(callbackReturn instanceof Promise) {
                                    await callbackReturn;
                                }
                            });
                        }

                        static async trigger(triggerName, context) {
                            const mark = VarvPerformance.start();
                            if(!triggeringEnabled) {
                                if(Trigger.DEBUG) {
                                    console.log("Skipping (Triggering Disabled):", triggerName, context);
                                }
                                return;
                            }

                            if(!Array.isArray(context)) {
                                context = [context];
                            }

                            if(Trigger.DEBUG) {
                                console.group("Triggering:", triggerName, Action.clone(context));
                            }

                            try {
                                await EventSystem.triggerEventAsync(VarvEventPrefix + triggerName, context);
                                VarvPerformance.stop("Trigger-"+triggerName, mark);
                            } catch(e) {
                                VarvPerformance.stop("Trigger-"+triggerName, mark);
                                throw e;
                            }

                            if(Trigger.DEBUG) {
                                console.groupEnd();
                            }
                        }

                        static async runWithoutTriggers(method) {
                            triggeringEnabled = false;
                            await method();
                            triggeringEnabled = true;
                        }
                    }
                    Trigger.DEBUG = false;
                    Trigger.triggers = new Map();
                    window.Trigger = Trigger;

                    </SCRIPT><SCRIPT id="Filter-script" type="disabled">
                    /**
                     *  Filter - Filtering functionality
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    window.FilterOps = Object.freeze({
                        "equals": "equals",
                        "unequals": "unequals",
                        "greaterThan": "greaterThan",
                        "lessThan": "lessThan",
                        "greaterOrEquals": "greaterOrEquals",
                        "lessOrEquals": "lessOrEquals",
                        "startsWith": "startsWith",
                        "endsWith": "endsWith",
                        "includes": "includes",
                        "includesAny": "includesAny",
                        "includesAll": "includesAll",
                        "matches": "matches",
                        "hasProperty": "hasProperty",
                        "propertyType": "propertyType"
                    });

                    class Filter {
                        /**
                         * @param {VarvContext} context - The context to filter
                         * @param {Concept} localConcept - The local concept
                         * @returns {Promise<boolean>} - Returns true if the given context should be kept, false if it should be discarded
                         */
                        async filter(context, localConcept, assert=false) {
                            console.warn("Should override 'filter' in subclass");
                            return false;
                        }

                        /**
                         * Filter based on the given values and operator
                         * @param {any} value
                         * @param {any} compareValue
                         * @param {FilterOps} op
                         * @returns {boolean}
                         */
                        static filterValue(value, compareValue, op, assert = false) {
                            let pass = false;

                            let markStart = VarvPerformance.start();

                            if(value == null) {
                                switch(op) {
                                    case FilterOps.equals: {
                                        pass = value === compareValue;
                                        break;
                                    }
                                    case FilterOps.unequals: {
                                        pass = value !== compareValue;
                                        break;
                                    }

                                    default: {
                                        console.warn("Filtering with "+op+" on null, is not possible, resulting in false");
                                        pass = false;
                                    }
                                }
                            } else {
                                switch (op) {
                                    case FilterOps.equals: {
                                        if(Array.isArray(value) && Array.isArray(compareValue)) {
                                            pass = JSON.stringify(value) === JSON.stringify(compareValue);
                                        } else {
                                            pass = value === compareValue;
                                        }
                                        break;
                                    }
                                    case FilterOps.unequals: {
                                        if(Array.isArray(value) && Array.isArray(compareValue)) {
                                            pass = JSON.stringify(value) !== JSON.stringify(compareValue);
                                        } else {
                                            pass = value !== compareValue;
                                        }
                                        break;
                                    }
                                    case FilterOps.matches: {
                                        let regexp = new RegExp(compareValue);
                                        pass = value.match(regexp) !== null;
                                        break;
                                    }
                                    case FilterOps.greaterThan: {
                                        pass = value > compareValue;
                                        break;
                                    }
                                    case FilterOps.lessThan: {
                                        pass = value < compareValue;
                                        break;
                                    }
                                    case FilterOps.greaterOrEquals: {
                                        pass = value >= compareValue;
                                        break;
                                    }
                                    case FilterOps.lessOrEquals: {
                                        pass = value <= compareValue;
                                        break;
                                    }
                                    case FilterOps.startsWith: {
                                        pass = value.startsWith(compareValue);
                                        break;
                                    }
                                    case FilterOps.endsWith: {
                                        pass = value.endsWith(compareValue);
                                        break;
                                    }
                                    case FilterOps.includes: {
                                        pass = value.indexOf(compareValue) !== -1;
                                        break;
                                    }
                                    case FilterOps.includesAny: {
                                        if (Array.isArray(compareValue)) {
                                            pass = false;
                                            for (let arrayValue of compareValue) {
                                                if (value.indexOf(arrayValue) !== -1) {
                                                    pass = true;
                                                    break;
                                                }
                                            }
                                        } else {
                                            pass = value.indexOf(compareValue) !== -1;
                                        }
                                        break;
                                    }
                                    case FilterOps.includesAll: {
                                        if (Array.isArray(compareValue)) {
                                            pass = true;
                                            for (let arrayValue of compareValue) {
                                                pass = pass && value.indexOf(arrayValue) !== -1;
                                            }
                                        } else {
                                            pass = value.indexOf(compareValue) !== -1;
                                        }
                                        break;
                                    }

                                    default:
                                        VarvPerformance.stop("Filter.filterValue.Error", markStart);
                                        throw new Error("Unknown op: " + op);
                                }
                            }

                            if(assert === true || assert > 1) {
                                if(assert > 1 && assert % 2 == 0) {
                                    console.assert(!pass, "NOT: Value: ",value," should not be ",op.toString(),compareValue);
                                } else {
                                    console.assert(pass, "Value: ",value," should be ",op.toString(),compareValue);
                                }
                            }

                            VarvPerformance.stop("Filter.filterValue", markStart);

                            return pass;
                        }
                    }

                    /**
                     * Filter based on a property
                     *
                     * @example
                     * //Filter based on property "myProperty" being equal to "someValue"
                     * {
                     *     "property": "myProperty",
                     *     "equals": "someValue"
                     * }
                     * @example
                     * //Filter based on string property "myProperty" starting with "someValue"
                     * {
                     *     "property": "myProperty",
                     *     "startsWith": "someValue"
                     * }
                     */
                    class FilterProperty extends Filter {
                        /**
                         *
                         * @param {string} property The property to filter on
                         * @param {FilterOps} op The operator to use
                         * @param {any} value The value to compare to
                         */
                        constructor(property, op, value) {
                            super();

                            this.property = property;
                            this.op = op;
                            this.value = value;
                        }

                        /**
                         *
                         * @param {FilterOps} filterOp - The filter op to get allowed types from
                         * @returns {string[]} - An array of allowed types
                         */
                        allowedTypes() {
                            switch(this.op) {
                                case FilterOps.equals: {
                                    return ["boolean", "number", "string", "concept", "array"];
                                }
                                case FilterOps.matches: {
                                    return ["string"];
                                }
                                case FilterOps.unequals: {
                                    return ["boolean", "number", "string", "concept", "array"];
                                }
                                case FilterOps.greaterThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.greaterOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.startsWith: {
                                    return ["string"];
                                }
                                case FilterOps.endsWith: {
                                    return ["string"];
                                }
                                case FilterOps.includes: {
                                    return ["string", "array"];
                                }
                                case FilterOps.includesAny: {
                                    return ["array"];
                                }
                                case FilterOps.includesAll: {
                                    return ["array"];
                                }
                            }
                        }

                        prepare(lookup){
                            if(lookup === null) {
                                throw new Error("No property ["+this.property+"] found!");
                            }

                            let property = lookup.property;
                            let type = property.type;
                            if(property.isConceptType()) {
                                type = "concept";
                            }

                            if(!this.allowedTypes().includes(type)) {
                                throw new Error("Op ["+this.op+"] does not work on property type ["+property.type+"] from property ["+property.name+"]");
                            }

                            return {concept:lookup.concept, property:property, target:lookup.target, type:type};
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let lookupProperty = await VarvEngine.lookupProperty(context.target, localConcept, this.property)

                            let lookup = this.prepare(lookupProperty);
                            let value = await lookup.property.getValue(lookup.target);

                            let typeCastedValue = this.value;
                            try {
                                //TODO: Not sure if we should typecast here?
                                typeCastedValue = lookup.property.typeCast(this.value);
                            } catch(e) {
                                //Ignore
                            }

                            let result = Filter.filterValue(value, typeCastedValue, this.op, assert);

                            VarvPerformance.stop("FilterProperty.filter", markStart);

                            return result;
                        }
                    }
                    window.FilterProperty = FilterProperty;

                    /**
                     * Filter based on a variable
                     *
                     * @example
                     * //Filter based on variable "myVariable" being equal to "someValue"
                     * {
                     *     "variable": "myVariable",
                     *     "equals": "someValue"
                     * }
                     * @example
                     * //Filter based on string variable "myVariable" starting with "someValue"
                     * {
                     *     "variable": "myVariable",
                     *     "startsWith": "someValue"
                     * }
                     */
                    class FilterVariable extends Filter {
                        /**
                         *
                         * @param {string} variable The variable to filter on
                         * @param {FilterOps} op The operator to use
                         * @param {any} value The value to compare to
                         */
                        constructor(variable, op, value) {
                            super();

                            this.variable = variable;
                            this.op = op;
                            this.value = value;
                        }

                        /**
                         * @returns {string[]} - An array of allowed types
                         */
                        allowedTypes() {
                            switch(this.op) {
                                case FilterOps.equals: {
                                    return ["boolean", "number", "string", "array"];
                                }
                                case FilterOps.matches: {
                                    return ["string"];
                                }
                                case FilterOps.unequals: {
                                    return ["boolean", "number", "string", "array"];
                                }
                                case FilterOps.greaterThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.greaterOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.startsWith: {
                                    return ["string"];
                                }
                                case FilterOps.endsWith: {
                                    return ["string"];
                                }
                                case FilterOps.includes: {
                                    return ["string", "array"];
                                }
                                case FilterOps.includesAny: {
                                    return ["array"];
                                }
                                case FilterOps.includesAll: {
                                    return ["array"];
                                }
                            }
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let variableValue = Action.getVariable(context, this.variable);

                            let type = typeof variableValue;

                            if(Array.isArray(variableValue)) {
                                type = "array";
                            }

                            if(!this.allowedTypes().includes(type)) {
                                VarvPerformance.stop("FilterVariable.filter.Error", markStart);
                                throw new Error("Op ["+this.op+"] does not work on variable with value type ["+type+"] from variable ["+this.variable+"]");
                            }

                            let result = Filter.filterValue(variableValue, this.value, this.op, assert);

                            VarvPerformance.stop("FilterVariable.filter", markStart);

                            return result;
                        }
                    }
                    window.FilterVariable = FilterVariable;

                    class FilterValue extends Filter {
                        /**
                         *
                         * @param {FilterOps} op
                         * @param {any} value
                         */
                        constructor(op, value) {
                            super();

                            this.op = op;
                            this.value = value;
                        }

                        /**
                         * @returns {string[]} - An array of allowed types
                         */
                        allowedTypes() {
                            switch(this.op) {
                                case FilterOps.equals: {
                                    return ["boolean", "number", "string", "array"];
                                }
                                case FilterOps.matches: {
                                    return ["string"];
                                }
                                case FilterOps.unequals: {
                                    return ["boolean", "number", "string", "array"];
                                }
                                case FilterOps.greaterThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessThan: {
                                    return ["number", "string"];
                                }
                                case FilterOps.greaterOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.lessOrEquals: {
                                    return ["number", "string"];
                                }
                                case FilterOps.startsWith: {
                                    return ["string"];
                                }
                                case FilterOps.endsWith: {
                                    return ["string"];
                                }
                                case FilterOps.includes: {
                                    return ["string", "array"];
                                }
                                case FilterOps.includesAny: {
                                    return ["array"];
                                }
                                case FilterOps.includesAll: {
                                    return ["array"];
                                }
                            }
                        }

                        async filter(value, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let type = typeof value;

                            if(Array.isArray(value)) {
                                type = "array";
                            }

                            if(!this.allowedTypes().includes(type)) {
                                VarvPerformance.stop("FilterValue.filter.Error", markStart);
                                throw new Error("This operator ["+this.op+"] does not allow value type ["+type+"]");
                            }

                            let result = Filter.filterValue(value, this.value, this.op, assert);

                            VarvPerformance.stop("FilterValue.filter", markStart);

                            return result;
                        }
                    }
                    window.FilterValue = FilterValue;

                    /**
                     * Filters based on concept
                     *
                     * @example
                     * //Filter concepts that are not of type "myConceptType", including inherited concepts
                     * {
                     *     "concept": "myConceptType",
                     *     "includeOthers": true
                     * }
                     *
                     * //Filter concepts that are not of type "myConceptType", excluding inherited concepts
                     * {
                     *     "concept": "myConceptType",
                     *     "includeOthers": false
                     * }
                     */
                    class FilterConcept extends Filter {
                        constructor(conceptName, includeOthers=true) {
                            super();

                            this.includeOthers = includeOthers;
                            this.conceptName = conceptName;
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let concept = await VarvEngine.getConceptFromUUID(context.target);

                            if(concept == null) {
                                return false;
                            }

                            let pass = false;

                            if (this.includeOthers){
                                // Check if concept.name or any otherConcept is correct
                                pass = concept.isA(this.conceptName);
                            } else {
                                pass = concept.name === this.conceptName;
                            }

                            if(assert === true || assert > 1) {
                                if(assert > 1 && assert % 2 == 0) {
                                    //Negated assert?
                                    console.assert(!pass, "NOT: Concept: "+concept.name+" is a "+this.conceptName+" when it should not be!");
                                } else {
                                    //Normal assert
                                    console.assert(pass, "Concept: "+concept.name+" is not a "+this.conceptName+" when it should have been!");
                                }
                            }

                            VarvPerformance.stop("FilterConcept.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterConcept = FilterConcept;

                    /**
                     * Filter based on multiple other filters, if any filter passes, this passes
                     *
                     * @example
                     * {
                     *     "or": [
                     *         {"property": "myProperty", "equals": "someValue"},
                     *         {"property": "myProperty", "equals": "someOtherValue"},
                     *     ]
                     * }
                     */
                    class FilterOr extends Filter {
                        constructor(filters) {
                            super();

                            this.filters = filters;
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let pass = false;

                            let promises = [];

                            for(let filter of this.filters) {
                                promises.push(filter.filter(context, localConcept, assert));
                            }

                            let filterResult = await Promise.all(promises);
                            for(let result of filterResult) {
                                pass = pass || result;
                            }

                            VarvPerformance.stop("FilterOr.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterOr = FilterOr;

                    /**
                     * Filter based on multiple other filters, if all filter passes, this passes
                     *
                     * @example
                     * {
                     *     "and": [
                     *         {"property": "myProperty", "equals": "someValue"},
                     *         {"property": "myProperty", "equals": "someOtherValue"},
                     *     ]
                     * }
                     */
                    class FilterAnd extends Filter {
                        constructor(filters) {
                            super();

                            this.filters = filters;
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let pass = true;

                            let promises = [];

                            for(let filter of this.filters) {
                                promises.push(filter.filter(context, localConcept, assert));
                            }

                            let filterResult = await Promise.all(promises);
                            for(let result of filterResult) {
                                pass = pass && result;
                            }

                            VarvPerformance.stop("FilterAnd.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterAnd = FilterAnd;

                    /**
                     * Filter based on other filter, if the other filter passes, this does not, and vice versa
                     *
                     * @example
                     * {
                     *     "not": {"property": "myProperty", "equals": "someValue"}
                     * }
                     */
                    class FilterNot extends Filter {
                        constructor(filter) {
                            super();

                            this.notFilter = filter;
                        }

                        async filter(context, localConcept, assert) {

                            let markStart = VarvPerformance.start();

                            if(assert === true) {
                                assert = 1;
                            }

                            let pass = ! (await this.notFilter.filter(context, localConcept, assert?(assert+1):false));

                            VarvPerformance.stop("FilterNot.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterNot = FilterNot;

                    /**
                     * Filter based on some calculation
                     *
                     * @example
                     * {
                     *     "calculation": "10 + $someVariable$ + $someProperty$",
                     *     "equals": 1010
                     * }
                     */
                    class FilterCalc extends Filter {
                        constructor(calculation, operator, value) {
                            super();

                            this.valueFilter = new FilterValue(operator, value);
                            this.calculation = calculation;
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let result = math.evaluate(this.calculation);

                            let pass = await this.valueFilter.filter(result, localConcept, assert);

                            VarvPerformance.stop("FilterCalc.filter", markStart);

                            return pass;
                        }
                    }

                    window.FilterCalc = FilterCalc;

                    /**
                     * Filters based on if concept has a property or not
                     *
                     * @example
                     * {
                     *     "hasProperty": "somePropertyName"
                     * }
                     */
                    class FilterPropertyExists extends Filter {
                        constructor(property) {
                            super();

                            this.property = property;
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let pass = true;

                            try {
                                let concept = await VarvEngine.getConceptFromUUID(context.target);
                                concept.getProperty(this.property);
                            } catch(e) {
                                //Silent fail, but mark that we saw no property
                                pass = false;
                            }

                            VarvPerformance.stop("FilterPropertyExists.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterPropertyExists = FilterPropertyExists;

                    /**
                     * Filters based on property type
                     *
                     * @example
                     * //Filter all where property "myProperty" is not of type "string" or "number"
                     * {
                     *     "property": "myProperty",
                     *     "propertyType": ["number", "string"]
                     * }
                     *
                     * @example
                     * //Filter all where property "myProperty" is not of type "concept" or "concept[]"
                     * {
                     *     "property": "myProperty",
                     *     "propertyType": ["array[concept]", "concept"]
                     * }
                     */

                    class FilterPropertyType extends Filter {
                        constructor(property, types) {
                            super();

                            this.property = property;
                            this.types = types;

                            if(!Array.isArray(this.types)) {
                                this.types = [this.types];
                            }
                        }

                        async filter(context, localConcept, assert) {
                            let markStart = VarvPerformance.start();

                            let pass = false;

                            try {
                                let concept = await VarvEngine.getConceptFromUUID(context.target);
                                let property = concept.getProperty(this.property);

                                let type = property.getFullTypeString();

                                if(Array.isArray(type)) {
                                    for(let t of type) {
                                        if(this.types.includes(t)) {
                                            pass = true;
                                            break;
                                        }
                                    }
                                } else {
                                    pass = this.types.includes(type);
                                }
                            } catch(e) {
                                //Silent ignore
                            }

                            VarvPerformance.stop("FilterPropertyType.filter", markStart);

                            return pass;
                        }
                    }
                    window.FilterPropertyType = FilterPropertyType;

                    </SCRIPT><SCRIPT id="Action-script" type="disabled">
                    /**
                     *  Action - The super class for all Actions
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A context in Varv
                     * @typedef {object} VarvContext
                     * @property {string} [target] - The UUID of the target this context refers to
                     * @property {object} [variables] - The variables currently set to any value
                     */

                    /**
                     * Base class for all actions
                     */
                    class Action {
                        /**
                         * Crate a new Action
                         * @param {string} name - The name of the action
                         * @param {object} options - The options of the action
                         * @param {Concept} concept - The owning concept
                         */
                        constructor(name, options, concept) {
                            this.name = name;
                            this.options = options;
                            this.concept = concept;

                            if(this.options == null) {
                                this.options = {};
                            }
                        }

                        /**
                         * Applies this Action to the given contexts, returning some resulting contexts
                         * @param {VarvContext[]} contexts
                         * @param {object} arguments
                         * @returns {Promise<VarvContext[]>}
                         */
                        async apply(contexts, actionArguments = {}) {
                            console.warn("Always override Action.apply in subclass!");
                            return contexts;
                        }

                        /**
                         * @callback forEachCallback
                         * @param {VarvContext} context - The context currently being looked at
                         * @param {object} options - The current options with variables and arguments substituted
                         * @param {number} index - The index of the current context in the context array
                         * @returns {VarvContext|VarvContext[]}
                         */

                        /**
                         * Loops through the given contexts, and calls the given callback for each, complete with substituted options and the index of the context
                         * @param {VarvContext[]} contexts - The contexts to handle
                         * @param {object} actionArguments - The arguments to use for this action
                         * @param {forEachCallback} callback - The callback to call for each context
                         * @returns {Promise<VarvContext[]>}
                         */
                        async forEachContext(contexts, actionArguments={}, callback) {
                            if(arguments.length < 2) {
                                throw new Error("forEachContext can be called either as (contexts, actionArguments, callback) or (contexts, callback)");
                            }

                            //If called with 2 arguments options is the callback
                            if(arguments.length === 2) {
                                if(typeof actionArguments !== "function") {
                                    throw new Error("forEachContext can be called either as (contexts, actionArguments, callback) or (contexts, callback)");
                                }

                                // noinspection JSValidateTypes
                                callback = actionArguments;
                                actionArguments = {};
                            }

                            let results = [];

                            let index = 0;

                            let options = await Action.lookupArguments(this.options, actionArguments);

                            for (let context of contexts) {
                                //Make sure to clone context, since we change it directly, thus variables might be a shared object if not.
                                let clonedContext = Action.cloneContext(context);

                                let optionsWithVariables = await Action.lookupVariables(options, clonedContext);

                                let result = await callback(clonedContext, optionsWithVariables, index);

                                if (result != null) {
                                    if (Array.isArray(result)) {
                                        result.forEach((entry) => {
                                            results.push(entry);
                                        });
                                    } else {
                                        results.push(result);
                                    }
                                }

                                index++;
                            }

                            return results;
                        }

                        /**
                         * Get the default variable name, for when no variable name is supplied
                         * @param {Action} - The action asking, the name of the action is used.
                         * @returns {string} - The default variable name
                         */
                        static defaultVariableName(action) {
                            if(action == null) {
                                return "result";
                            }

                            return action.name;
                        }

                        /**
                         * Sets the given variable to the given value, in the given context
                         * @param {VarvContext} context - The context to set the variable inside
                         * @param {string} name - The name of the variable to set
                         * @param {any} value - The value to set
                         */
                        static setVariable(context, name, value) {
                            if(context.variables == null) {
                                context.variables = {}
                            }

                            if(name === "target") {
                                console.warn("Unable to set variable target!");
                                return;
                            }

                            context.variables[name] = value;
                        }

                        /**
                         * Retrieve the value of the given variable from the given context
                         * @param {VarvContext} context
                         * @param {string} name
                         * @returns {any}
                         */
                        static getVariable(context, name) {
                            if(name === "target" && context.target != null) {
                                //If context.target exists use that, if not, check variables as getCommonVariables might have saved a common target
                                return context.target;
                            }

                            if(name === "lastTarget" && context.lastTarget != null) {
                                //If context.lastTarget exists use that
                                return context.lastTarget;
                            }

                            if(context.variables == null) {
                                context.variables = {}
                            }

                            if(!context.variables.hasOwnProperty(name)) {
                                if(name === "target") {
                                    throw new Error("Context did not contain target, and no variable target existed either!");
                                }

                                throw new Error("No named variable ["+name+"]");
                            }

                            return context.variables[name];
                        }

                        /**
                         * Extract all the variables that have the same value across all contexts
                         * @param contexts
                         * @returns {{}}
                         */
                        static getCommonVariables(contexts) {
                            let common = {};

                            let mark = VarvPerformance.start();

                            if(contexts.length > 0) {
                                let testContext = contexts[0];

                                if(testContext.variables != null) {
                                    Object.keys(testContext.variables).forEach((variableName)=>{
                                        let variableValue = testContext.variables[variableName];
                                        let keep = true;

                                        for(let otherContext of contexts) {
                                            if(otherContext.variables != null) {
                                                let otherValue = otherContext.variables[variableName];

                                                if(otherValue != null && otherValue === variableValue) {
                                                    continue;
                                                }

                                                if(Array.isArray(otherValue) && Array.isArray(variableValue)) {
                                                    if(otherValue.length === variableValue.length) {
                                                        let arrayEqual = true;
                                                        for(let i = 0; i<otherValue.length; i++) {
                                                            arrayEqual = arrayEqual && otherValue[i] === variableValue[i];
                                                        }

                                                        if(arrayEqual) {
                                                            continue;
                                                        }
                                                    }
                                                }
                                            }

                                            keep = false;
                                            break;
                                        }

                                        if(keep) {
                                            common[variableName] = variableValue;
                                        }
                                    });
                                }

                                if(testContext.target != null) {
                                    let keep = true;
                                    for(let otherContext of contexts) {
                                        if (otherContext.target != testContext.target) {
                                            keep = false;
                                            break;
                                        }
                                    }

                                    if(keep) {
                                        common["target"] = testContext.target;
                                    }
                                }
                            } else {
                                if(contexts.savedVariables) {
                                    return contexts.savedVariables;
                                }
                            }

                            VarvPerformance.stop("Action.getCommonVariables", mark, "#contexts "+contexts.length);

                            return common;
                        }

                        static getCommonTarget(contexts) {
                            let commonTarget = -1;
                            contexts.forEach((context)=>{
                                if(commonTarget === -1) {
                                    commonTarget = context.target;
                                } else {
                                    if(commonTarget !== context.target) {
                                        commonTarget = null;
                                    }
                                }
                            });
                            return commonTarget;
                        }

                        /**
                         * Looks up any options that are set to an argument replacement value "@myArgumentName" and replaces it with that arguments value
                         * @param {object} options - The options to do the replacement on
                         * @param {object} actionArguments - The arguments to replace into the options
                         * @returns {object} A clone of the options argument, with all replacement values replaced
                         */
                        static async lookupArguments(options, actionArguments) {
                            let mark = VarvPerformance.start();

                            const optionsClone = Action.clone(options);

                            let regex = /@(\S+?)(?:@|\s|$)/gm;

                            for(let parameter in optionsClone) {
                                if(!Object.hasOwn(optionsClone, parameter)) {
                                    continue;
                                }

                                let value = optionsClone[parameter];

                                optionsClone[parameter] = await Action.subParam(value, (value)=>{
                                    if(!value.includes("@")) {
                                        return value;
                                    }

                                    //Substitute any @argumentName with the value of the argument
                                    for(let match of value.matchAll(regex)) {
                                        let search = match[0].trim();
                                        let variableName = match[1];

                                        let variableValue = actionArguments[variableName];

                                        if(Action.DEBUG) {
                                            console.log("Replaced argument:", search, variableValue, actionArguments, variableName);
                                        }

                                        if(value === search) {
                                            //Single value, set it directly
                                            value = variableValue;
                                        } else {
                                            //Replace into value
                                            value = value.replace(search, variableValue);
                                        }
                                    }

                                    return value;
                                });

                            }

                            VarvPerformance.stop("Action.lookupArguments", mark, {options});

                            return optionsClone;
                        }

                        static async subParam(value, lookupCallback) {
                            if (Array.isArray(value)) {
                                for (let i = 0; i < value.length; i++) {
                                    value[i] = await Action.subParam(value[i], lookupCallback);
                                }
                                return value;
                            } else if (typeof value === "object" && value != null && Object.getPrototypeOf(value) === Object.prototype) {
                                for(let key in value) {
                                    if(Object.hasOwn(value, key)) {
                                        value[key] = await Action.subParam(value[key], lookupCallback);
                                    }
                                }
                                return value;
                            } else if (typeof value === "string") {
                                return lookupCallback(value);
                            } else {
                                return value;
                            }
                        }

                        static clone(obj) {
                            if(Array.isArray(obj)) {
                                return obj.map((arrayValue)=>{
                                    return Action.clone(arrayValue);
                                });
                            } else if(typeof obj === "object" && obj != null && Object.getPrototypeOf(obj) === Object.prototype) {

                                let clone = {};

                                for (let key in obj) {
                                    if (!Object.hasOwn(obj, key)) {
                                        continue;
                                    }

                                    clone[key] = Action.clone(obj[key]);
                                }

                                return clone;
                            }

                            return obj;
                        }


                        /**
                         * Look up any options that have a variable replacement value "$myVariable" and replaces it with the value of that variable.
                         * @param {object} options
                         * @param {VarvContext} context
                         * @returns {object} - Returns a clone of the given options, with all replacement values replaced.
                         */
                        static async lookupVariables(options, context) {
                            if(Action.DEBUG) {
                                console.group("Looking up variables from context:", options, context);
                            }

                            let mark = VarvPerformance.start();

                            const optionsClone = Action.clone(options);

                            async function doLookup(context, variableName) {
                                let variableValue = null;

                                if(variableName.indexOf(".") !== -1) {
                                    let split = variableName.split(".");

                                    //concept.property lookup, not really variable
                                    let conceptName = split[0];
                                    let propertyName = split[1];

                                    let result = null;

                                    if(conceptName === "lastTarget") {
                                        result = await VarvEngine.lookupProperty(context.lastTarget, null, propertyName);
                                    } else if(conceptName === "target") {
                                        result = await VarvEngine.lookupProperty(context.target, null, propertyName);
                                    } else {
                                        result = await VarvEngine.lookupProperty(context.target, null, variableName);
                                    }

                                    if (result != null && result.target != null) {
                                        variableValue = await result.property.getValue(result.target);
                                    }
                                } else {
                                    variableValue = Action.getVariable(context, variableName);
                                }

                                return variableValue;
                            }

                            let regex = /\$(\S+?)(?:\$|\s|$)/gm;

                            for(let key of Object.keys(optionsClone)) {
                                optionsClone[key] = await Action.subParam(optionsClone[key], async (value)=>{
                                    if(!value.includes("$")) {
                                        return value;
                                    }

                                    //Substitute any $VariableName with the value of the variable
                                    for(let match of value.matchAll(regex)) {
                                        let search = match[0].trim();
                                        let variableName = match[1];

                                        let variableValue = await doLookup(context, variableName);

                                        if(Action.DEBUG) {
                                            console.log("Replaced variable:", search, variableValue);
                                        }

                                        if(value === search) {
                                            //Single value, set it directly
                                            value = variableValue;
                                        } else {
                                            //Replace into value
                                            value = value.replace(search, variableValue);
                                        }
                                    }

                                    return value;
                                });
                            }

                            if(Action.DEBUG) {
                                console.groupEnd();
                            }

                            VarvPerformance.stop("Action.lookupVariables", mark, {context, options});

                            //Handle special stuff here
                            Action.substituteEvery(optionsClone, "calculate", (value)=>{
                                return CalculateAction.evaluate(value);
                            });

                            return optionsClone;
                        }

                        static substituteEvery(input, nameToSubstitute, callback) {
                            if(Array.isArray(input)) {
                                for(let i = 0; i< input.length; i++) {
                                    input[i] = Action.substituteEvery(input[i], nameToSubstitute, callback);
                                }
                            } else if(typeof input === "object") {
                                for(let key in input) {
                                    if(input.hasOwnProperty(key)) {
                                        if(key === nameToSubstitute) {
                                            if(Object.keys(input).length > 1) {
                                                console.warn("Substituting on something with more than 1 entry (Stuff will be lost):", input, nameToSubstitute);
                                            }

                                            let origValue = input[key];
                                            return callback(origValue);
                                        } else {
                                            input[key] = Action.substituteEvery(input[key], nameToSubstitute, callback);
                                        }
                                    }
                                }
                            }

                            return input;
                        }

                        /**
                         * Registers the given action as a primitive action with the given name
                         * @param {string} name
                         * @param {Action} action
                         */
                        static registerPrimitiveAction(name, action) {
                            if(Action.DEBUG) {
                                console.log("Registering primitive action:", name, action);
                            }

                            if (Action.primitiveActions.has(name)) {
                                console.warn("Overriding primitive action: ", name);
                            }

                            Action.primitiveActions.set(name, action);
                        }

                        /**
                         * Gets an instance of the primitive action with the given name, using the given options
                         * @param {string} name
                         * @param {object} options
                         * @returns {Action}
                         */
                        static getPrimitiveAction(name, options, concept) {
                            let actionClass = Action.primitiveActions.get(name);

                            if (actionClass == null) {
                                throw new Error("Unknown primitive action [" + name + "]");
                            }

                            let action = new actionClass(name, options, concept);

                            action.isPrimitive = true;

                            return action;
                        }

                        /**
                         * Checks if a primitive action with the given name exists
                         * @param {string} name
                         * @returns {boolean}
                         */
                        static hasPrimitiveAction(name) {
                            return Action.primitiveActions.has(name);
                        }

                        /**
                         * Clones the given context. (Any non JSON serializable values in the context, will be lost)
                         * @param {VarvContext} context
                         * @returns {VarvContext} - The cloned context
                         */
                        static cloneContext(context) {
                            let mark = VarvPerformance.start();

                            let result = null;
                            if(Array.isArray(context)) {
                                result = context.map(Action.cloneContextInternal);
                            } else {
                                result = Action.cloneContextInternal(context);
                            }

                            VarvPerformance.stop("Action.cloneContext", mark);

                            return result;
                        }

                        static cloneContextInternal(context) {
                            //Move over allowed properties
                            let preCloneObject = {};
                            preCloneObject.variables = context.variables;
                            preCloneObject.target = context.target;

                            if(Action.DEBUG) {
                                console.log("Cloning context:", context, preCloneObject);
                            }
                            return Action.clone(preCloneObject);
                        }
                    }
                    Action.DEBUG = false;
                    Action.primitiveActions = new Map();
                    window.Action = Action;

                    class ActionChain extends Action {
                        constructor(name, options, concept) {
                            super(name, options, concept);

                            this.actions = [];
                        }

                        addAction(action) {
                            const self = this;

                            if(Array.isArray(action)) {
                                action.forEach((actionElm)=>{
                                    self.actions.push(actionElm);
                                })
                            } else {
                                this.actions.push(action);
                            }
                        }

                        async apply(contexts, actionArguments = {}) {
                            let currentContexts = contexts;

                            for (let action of this.actions) {
                                let commonVariablesBefore = Action.getCommonVariables(currentContexts);

                                await ActionTrigger.before(action, currentContexts);
                                let mark = VarvPerformance.start();
                                currentContexts = await action.apply(currentContexts, actionArguments);
                                if(action.isPrimitive) {
                                    VarvPerformance.stop("PrimitiveAction-"+action.name, mark);
                                } else {
                                    VarvPerformance.stop("CustomAction-"+action.name, mark);
                                }
                                await ActionTrigger.after(action, currentContexts);

                                if(currentContexts == null) {
                                    currentContexts = [];
                                }

                                if(currentContexts.length === 0) {
                                    currentContexts.savedVariables = commonVariablesBefore;
                                }
                            }

                            return currentContexts;
                        }
                    }

                    window.ActionChain = ActionChain;

                    class LookupActionAction extends Action {
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            const self = this;

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            if(optionsWithArguments.lookupActionName == null) {
                                throw new Error("[LookupActionAction] Missing option 'lookupActionName'");
                            }

                            //TODO: We assume that all concepts are of the same type, when/if polymorphism is introduced this breaks
                            let contextConcept = null;
                            if(contexts.length > 0) {
                                contextConcept = await VarvEngine.getConceptFromUUID(contexts[0].target);
                            }

                            let action = VarvEngine.lookupAction(optionsWithArguments.lookupActionName, [contextConcept, self.concept], optionsWithArguments.lookupActionArguments);

                            if(action != null) {
                                await ActionTrigger.before(action, contexts);
                                let mark = VarvPerformance.start();
                                let lookupActionResult = await action.apply(contexts, action.isPrimitive?{}:optionsWithArguments.lookupActionArguments);
                                if(action.isPrimitive) {
                                    VarvPerformance.stop("PrimitiveAction-"+action.name, mark);
                                } else {
                                    VarvPerformance.stop("CustomAction-"+action.name, mark);
                                }
                                await ActionTrigger.after(action, lookupActionResult);
                                return lookupActionResult;
                            }

                            return null;
                        }
                    }

                    window.LookupActionAction = LookupActionAction;

                    class StopError extends Error {
                        constructor(msg) {
                            super(msg);
                        }
                    }
                    window.StopError = StopError;

                    </SCRIPT><SCRIPT id="Behaviour-script" type="disabled">
                    /**
                     *  Behaviour - Concept behaviours
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class Behaviour {
                        constructor(name, triggers, actions, concept, overrideActionName=null) {
                            const self = this;

                            this.concept = concept;

                            if(triggers == null) {
                                triggers = [];
                            }

                            if(actions == null) {
                                actions = [];
                            }

                            if(!Array.isArray(triggers)) {
                                triggers = [triggers];
                            }

                            if(!Array.isArray(actions)) {
                                actions = [actions];
                            }

                            this.cloneData = {
                                name: name,
                                triggers: triggers!=null?JSON.parse(JSON.stringify(triggers)):null,
                                actions: actions!=null?JSON.parse(JSON.stringify(actions)):null,
                                overrideActionName: overrideActionName
                            }

                            this.name = name;

                            this.triggers = triggers.map((triggerJson)=>{
                                if(typeof triggerJson === "string") {
                                    if(!Trigger.isTriggerType(triggerJson)) {
                                        console.log("Unknown trigger, guessing it is an action trigger:", triggerJson);
                                        triggerJson = {"action": triggerJson};
                                    }
                                }

                                let originalStringTrigger = null;

                                if(typeof triggerJson === "string") {
                                    originalStringTrigger = triggerJson;

                                    triggerJson = {};
                                    triggerJson[originalStringTrigger] = {};
                                }

                                if(typeof triggerJson !== "string") {

                                    let triggerName = UUIDGenerator.generateUUID("trigger-");
                                    let trigger = ConceptLoader.parseTrigger(triggerName, triggerJson, concept);

                                    if(trigger != null) {
                                        self.concept.addTrigger(trigger);

                                        return triggerName;
                                    } else {
                                        if(originalStringTrigger == null) {
                                            console.warn("Unable to parse anonymous trigger:", triggerJson);
                                        } else {
                                            return originalStringTrigger;
                                        }
                                    }

                                    return null;
                                }

                                return triggerJson;
                            }).filter((trigger)=>{
                                return typeof trigger === "string";
                            });

                            this.deleteCallbacks = [];

                            let actionName = name+".actions";

                            if(overrideActionName != null) {
                                actionName = overrideActionName;
                                this.callableAction = true;
                            }

                            this.actionChain = new ActionChain(actionName, {}, this.concept);

                            actions.forEach((actionJson)=>{
                                if(typeof actionJson !== "string") {
                                    let actionName = UUIDGenerator.generateUUID("action-");

                                    if(!Array.isArray(actionJson)) {
                                        actionJson = [actionJson];
                                    }

                                    let action = ConceptLoader.parseAction(actionName, actionJson, self.concept);

                                    if(action != null) {
                                        self.actionChain.addAction(action);
                                    } else {
                                        console.warn("Unable to parse anonymous action:", actionJson);
                                    }
                                } else {
                                    let action = null;

                                    //Check for primitive action first.
                                    if(Action.hasPrimitiveAction(actionJson)) {
                                        action = Action.getPrimitiveAction(actionJson, {}, concept);
                                    } else {
                                        action = new LookupActionAction("", {
                                            lookupActionName: actionJson
                                        }, concept);
                                    }

                                    self.actionChain.addAction(action);
                                }
                            });
                        }

                        cloneFresh(concept) {
                            return new Behaviour(this.cloneData.name, this.cloneData.triggers, this.cloneData.actions, concept,  this.cloneData.overrideActionName);
                        }

                        setupEvents() {
                            const self = this;

                            this.triggers.forEach((trigger)=>{
                                self.deleteCallbacks.push(Trigger.registerTriggerEvent(trigger, async (context) => {
                                    try {
                                        await self.onTrigger(trigger, context);
                                    } catch(e) {
                                        console.error(e);
                                    }
                                }));
                            });
                        }

                        async onTrigger(triggerName, context) {
                            try {
                                await ActionTrigger.before(this.actionChain, context);
                                let mark = VarvPerformance.start();
                                let resultContext = await this.actionChain.apply(context);
                                if(this.actionChain.isPrimitive) {
                                    VarvPerformance.stop("PrimitiveAction-"+this.actionChain.name, mark);
                                } else {
                                    VarvPerformance.stop("CustomAction-"+this.actionChain.name, mark);
                                }
                                await ActionTrigger.after(this.actionChain, resultContext);
                            } catch(e) {
                                if(e instanceof StopError) {
                                    //console.log("We stopped the chain: "+e.message);
                                } else {
                                    throw e;
                                }
                            }
                        }

                        destroy() {
                            const self = this;


                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            });
                            this.triggers.forEach((triggerName)=>{
                                let trigger = self.concept.getTrigger(triggerName);
                                if(trigger != null) {
                                    self.concept.removeTrigger(trigger);
                                }
                            });
                            this.deleteCallbacks = null;
                            this.triggers = null;
                            this.actionChain = null;
                        }
                    }

                    window.Behaviour = Behaviour;

                    </SCRIPT><SCRIPT id="ConceptLoader-script" type="disabled">
                    /**
                     *  Concept Loader - Convert JSON to program structure
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /*
                     * Loads all concepts from the given json spec.
                     *
                     * ConceptLoader.SystemDefaultMappings can be set to an array of datastores, that will be used for any property that does not define a datastore mapping.
                     * It defaults to ["dom", "cauldron"]
                     */

                    class ConceptLoader {
                        static get SystemDefaultMappings() {
                            let defaultMappings = ["dom"];

                            if(Datastore.getDatastoreType("cauldron") != null) {
                                defaultMappings.push("cauldron");
                            }

                            return this.hasOwnProperty('_SystemDefaultMappings') ? this._SystemDefaultMappings : defaultMappings;
                        }
                        static set SystemDefaultMappings(mappings) {
                            this._SystemDefaultMappings = mappings;
                        }

                        static parseSpec(json) {
                            let mark = VarvPerformance.start();

                            let parsedSpec = {
                                "concepts":[],
                                "dataStores": []
                            }

                            function getConceptFromName(name) {
                                return parsedSpec.concepts.find((concept)=>{
                                    return concept.name === name;
                                });
                            }

                            //Start parse group
                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Parsing: ", json);
                            }

                            //Start datastore group
                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Parsing dataStores...");
                            }

                            const dataStores = {
                                "dom": {
                                    "type": "dom",
                                    "options": {default: true}
                                },
                                "memory": {
                                    "type": "memory",
                                    "options": {default: true}
                                },
                                "localStorage": {
                                    "type": "localStorage",
                                    "options": {default: true}
                                }
                            };

                            if(Datastore.getDatastoreType("cauldron") != null) {
                                dataStores.cauldron = {
                                    "type": "cauldron",
                                    "options": {default: true}
                                };
                            }

                            if(ConceptLoader.DEBUG) {
                                console.log("Default dataStores:", Object.assign({},dataStores));
                            }

                            if(json.dataStores != null) {
                                Object.keys(json.dataStores).forEach((dataStoreKey)=>{
                                    let dataStoreConfig = json.dataStores[dataStoreKey];
                                    dataStores[dataStoreKey] = dataStoreConfig;
                                });
                            }

                            for(let dataStoreKey of Object.keys(dataStores)) {
                                const dataStoreConfig = dataStores[dataStoreKey];
                                if(ConceptLoader.DEBUG) {
                                    console.log("Creating dataStore instance:", dataStoreKey, dataStoreConfig);
                                }
                                let dataStoreClass = Datastore.getDatastoreType(dataStoreConfig.type);

                                let dataStoreInstance = new dataStoreClass(dataStoreKey, dataStoreConfig.options);
                                parsedSpec.dataStores.push(dataStoreInstance);
                            }

                            //End datastore group
                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(json.defaultMappings != null) {
                                ConceptLoader.SystemDefaultMappings = json.defaultMappings;
                            }

                            if(json.concepts != null) {
                                // Go through every concept in this JSON
                                Object.keys(json.concepts).forEach((conceptName) => {
                                    let conceptJson = json.concepts[conceptName];

                                    if (ConceptLoader.DEBUG) {
                                        console.groupCollapsed("Concept:", conceptName);
                                    }

                                    let concept = new Concept(conceptName);
                                    //VarvEngine.registerConceptFromType(conceptName, concept);

                                    let structure = conceptJson.structure || conceptJson.schema;

                                    // Find the properties of this Concept
                                    if (structure != null) {
                                        Object.keys(structure).forEach((propertyName) => {
                                            let propertyJson = structure[propertyName];

                                            let property = new Property(propertyName, propertyJson);

                                            if (ConceptLoader.DEBUG) {
                                                console.log("Property:", property);
                                            }

                                            concept.addProperty(property);
                                        });
                                    }

                                    // Find the mappings
                                    concept.properties.forEach((property) => {
                                        //Dont map derived properties
                                        if(property.isDerived()) {
                                            return;
                                        }

                                        let propertyName = property.name;

                                        let propertyMappings = ConceptLoader.getMappingsForProperty(conceptJson, propertyName);

                                        if (ConceptLoader.DEBUG) {
                                            console.log("Mapping:", propertyName, propertyMappings);
                                        }

                                        concept.mapProperty(property, propertyMappings);
                                    });

                                    // Find the actions
                                    if (conceptJson.actions != null) {
                                        Object.keys(conceptJson.actions).forEach((actionName) => {
                                            let actionSetup = conceptJson.actions[actionName];

                                            if (Array.isArray(actionSetup)) {
                                                //This is a behaviour action, with only then part
                                                let behaviour = new Behaviour(actionName, [], actionSetup, concept, actionName);

                                                if (ConceptLoader.DEBUG) {
                                                    console.log("Behaviour:", behaviour);
                                                }

                                                concept.addBehaviour(behaviour);
                                            } else {
                                                //This is a behaviour action, with either then or when or both...
                                                let behaviour = new Behaviour(actionName, actionSetup.when, actionSetup.then, concept, actionName);

                                                if (ConceptLoader.DEBUG) {
                                                    console.log("Behaviour:", behaviour);
                                                }

                                                concept.addBehaviour(behaviour);
                                            }
                                        });
                                    }

                                    if(conceptJson.extensions != null) {
                                        if(json.extensions == null) {
                                            json.extensions = [];
                                        }

                                        let sugarExtensions = [];

                                        if (ConceptLoader.DEBUG) {
                                            console.log("Sugar extensions...");
                                        }
                                        Object.keys(conceptJson.extensions).forEach((extensionType) => {
                                            let extensionSetup = conceptJson.extensions[extensionType];

                                            if(!Array.isArray(extensionSetup)) {
                                                extensionSetup = [extensionSetup];
                                            }

                                            switch(extensionType) {
                                                case "inject": {
                                                    if (ConceptLoader.DEBUG) {
                                                        console.log("Inject:", extensionSetup);
                                                    }
                                                    let extension = {
                                                        "concept": concept.name,
                                                        "inject": extensionSetup
                                                    }
                                                    sugarExtensions.unshift(extension);
                                                    break;
                                                }

                                                case "pick": {
                                                    if (ConceptLoader.DEBUG) {
                                                        console.log("Pick:", extensionSetup);
                                                    }

                                                    extensionSetup.forEach((extensionSetupElm)=>{
                                                        let extension = {
                                                            "concept": extensionSetupElm.concept,
                                                            "into": concept.name,
                                                            "pick": {}
                                                        }

                                                        if(extensionSetupElm.schema != null) {
                                                            extension.pick.schema = extensionSetupElm.schema;
                                                        }
                                                        if(extensionSetupElm.actions != null) {
                                                            extension.pick.actions = extensionSetupElm.actions;
                                                        }
                                                        sugarExtensions.unshift(extension);
                                                    });

                                                    break;
                                                }

                                                case "omit": {
                                                    if (ConceptLoader.DEBUG) {
                                                        console.log("Omit:", extensionSetup);
                                                    }

                                                    extensionSetup.forEach((extensionSetupElm)=>{
                                                        let extension = {
                                                            "concept": concept.name,
                                                            "omit": {}
                                                        }

                                                        if(extensionSetupElm.schema != null) {
                                                            extension.omit.schema = extensionSetupElm.schema;
                                                        }
                                                        if(extensionSetupElm.actions != null) {
                                                            extension.omit.actions = extensionSetupElm.actions;
                                                        }
                                                        sugarExtensions.unshift(extension);
                                                    });

                                                    break;
                                                }

                                                default:
                                                    console.log("Unknown extension type:", extensionType, extensionSetup);
                                            }
                                        });

                                        sugarExtensions.forEach((extension)=>{
                                            json.extensions.unshift(extension);
                                        })
                                    }

                                    if (ConceptLoader.DEBUG) {
                                        console.groupEnd();
                                    }

                                    parsedSpec.concepts.push(concept);
                                });
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Extensions");
                            }

                            // Now modify the environment with the concept extensions (join, inject ...) in order of definition
                            if (json.extensions){
                                json.extensions.forEach((extension)=>{
                                    try {
                                        if (extension.inject != null) {
                                            // Join two or more concepts together into a new concept
                                            if (!extension.concept) throw new Error("Inject extension without target 'concept' name: " + JSON.stringify(extension));

                                            let target = getConceptFromName(extension.concept);
                                            if (!target) throw new Error("Inject extension with target 'concept' set to '" + extension.concept + "' that does not exist: " + JSON.stringify(extension));

                                            if (ConceptLoader.DEBUG) {
                                                console.log("Injecting into " + extension.concept + ":");
                                            }

                                            if (!Array.isArray(extension.inject)) extension.inject = [extension.inject];
                                            for (let joinee of extension.inject) {
                                                let otherConcept = getConceptFromName(joinee);
                                                if (!otherConcept) throw new Error("Inject extension with unknown concept '" + joinee + "' in 'inject' list: " + JSON.stringify(extension));
                                                target.join(otherConcept);
                                            }
                                        } else if (extension.join != null) {
                                            // Join two or more concepts together into a new concept
                                            if (!extension.as) throw new Error("Join extension without 'as' target concept name: " + JSON.stringify(extension));

                                            let potentialClash = getConceptFromName(extension.as);
                                            if (potentialClash) throw new Error("Join extension with 'as' target concept name '" + extension.as + "' that already exists: " + JSON.stringify(extension));

                                            let concept = new Concept(extension.as);
                                            parsedSpec.concepts.push(concept);

                                            if (ConceptLoader.DEBUG) {
                                                console.groupCollapsed("Joining into " + extension.as + ":");
                                            }
                                            for (let joinee of extension.join) {
                                                let otherConcept = getConceptFromName(joinee);
                                                if (!otherConcept) throw new Error("Join extension with unknown concept '" + joinee + "' in 'join' list: " + JSON.stringify(extension));
                                                if (ConceptLoader.DEBUG) {
                                                    console.log(otherConcept.name);
                                                }
                                                concept.join(otherConcept);
                                            }
                                            if (ConceptLoader.DEBUG) {
                                                console.groupEnd();
                                            }
                                        } else if (extension.omit != null) {
                                            if(!extension.concept) throw new Error("Omit extension without 'concept' option: "+JSON.stringify(extension));

                                            let concept = getConceptFromName(extension.concept);

                                            if(concept != null) {
                                                if (ConceptLoader.DEBUG) {
                                                    console.log("Omitting from " + extension.concept + ":", extension.omit);
                                                }

                                                concept.omit(extension.omit);
                                            }
                                        } else if (extension.pick != null) {
                                            if(!extension.concept) throw new Error("Pick extension without 'concept' option: "+JSON.stringify(extension));
                                            if(!extension.as && !extension.into) throw new Error("Pick extension without 'as' or 'into' option: "+JSON.stringify(extension));

                                            let toConcept = null;

                                            let fromConcept = getConceptFromName(extension.concept);

                                            if(fromConcept == null) {
                                                throw new Error("Pick extension with unknown concept '"+extension.concept+"': "+JSON.stringify(extension));
                                            }

                                            if(extension.as != null) {
                                                if(getConceptFromName(extension.as) != null) {
                                                    throw new Error("Pick extension option 'as' another concept with that name already exists: "+JSON.stringify(extension));
                                                }
                                                toConcept = new Concept(extension.as);
                                                parsedSpec.concepts.push(toConcept);
                                            } else if(extension.into != null) {
                                                toConcept = getConceptFromName(extension.into);
                                            }

                                            if (ConceptLoader.DEBUG) {
                                                console.log("Picking from " + extension.concept + " as "+extension.as+":", extension.pick);
                                            }

                                            if(extension.pick.schema != null) {
                                                if(!Array.isArray(extension.pick.schema)) {
                                                    extension.pick.schema = [extension.pick.schema];
                                                }

                                                extension.pick.schema.forEach((propertyName)=>{
                                                    let property = fromConcept.getProperty(propertyName);
                                                    toConcept.addProperty(property.cloneFresh(toConcept), true);

                                                    let mappings = fromConcept.mappings.get(propertyName);
                                                    toConcept.mapProperty(toConcept.getProperty(propertyName), mappings);
                                                });
                                            }

                                            if(extension.pick.actions != null) {
                                                if (!Array.isArray(extension.pick.actions)) {
                                                    extension.pick.actions = [extension.pick.actions];
                                                }

                                                extension.pick.actions.forEach((behaviourName)=>{
                                                    let behaviour = fromConcept.getBehaviour(behaviourName);
                                                    toConcept.addBehaviour(behaviour.cloneFresh(toConcept), true);
                                                });
                                            }
                                        } else {
                                            throw new Error("Unsupported extension: " + JSON.stringify(extension));
                                        }
                                    } catch(e) {
                                        console.warn(e);
                                    }
                                });
                            }
                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            //End Parse group
                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            VarvPerformance.stop("ConceptLoader.parseSpec", mark);

                            return parsedSpec;
                        }

                        /**
                         *
                         * @param {object} json
                         * @returns {Promise<any[]>}
                         */
                        static async loadSpec(spec) {
                            let mark = VarvPerformance.start();

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Loading: ", spec);
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Mapping concepts...");
                            }

                            spec.concepts.forEach((concept)=>{
                                if(ConceptLoader.DEBUG) {
                                    console.log(concept);
                                }
                                VarvEngine.registerConceptFromType(concept.name, concept);
                            });

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Loading dataStores...");
                            }

                            for(let dataStore of spec.dataStores) {
                                if(ConceptLoader.DEBUG) {
                                    console.log("Initializing datastore:", dataStore);
                                }
                                await dataStore.init();

                                Datastore.datastores.set(dataStore.name, dataStore);
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Enabling mappings");
                            }

                            spec.concepts.forEach((concept)=>{
                                concept.enableMappings(ConceptLoader.DEBUG);
                            });

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Loading backing store...");
                            }

                            // Run all datastore load methods
                            for(let datastore of Array.from(Datastore.datastores.values())) {
                                await Trigger.runWithoutTriggers(async ()=>{
                                    await datastore.loadBackingStore();
                                });
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupCollapsed("Finishing concepts");
                            }

                            spec.concepts.forEach((concept)=>{
                                concept.finishSetup(ConceptLoader.DEBUG);
                            });

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            if(ConceptLoader.DEBUG) {
                                console.groupEnd();
                            }

                            VarvPerformance.stop("ConceptLoader.loadSpec", mark);

                            return spec.concepts;
                        }

                        static getMappingsForProperty(conceptJson, propertyName){
                            // System-level default
                            let propertyMappings = ConceptLoader.SystemDefaultMappings;

                            // If concept has defaultMappings, use those
                            if(conceptJson.defaultMappings != null) {
                                if(!Array.isArray(conceptJson.defaultMappings)) {
                                    console.warn("concept defaultMappings must be an array");
                                } else {
                                    propertyMappings = conceptJson.defaultMappings;
                                }
                            }

                            // If property has mappings use those
                            if (conceptJson.mappings && conceptJson.mappings[propertyName]) {
                                propertyMappings = conceptJson.mappings[propertyName];
                            }

                            return propertyMappings;
                        }


                        static parseTrigger(triggerName, triggerJson, concept) {
                            let mark = VarvPerformance.start();

                            let trigger = null;

                            if(ConceptLoader.DEBUG) {
                                console.log("Parsing trigger:", triggerName, triggerJson);
                            }

                            let triggerType = Object.keys(triggerJson)[0];
                            let triggerOptions = triggerJson[triggerType];

                            try {
                                trigger = Trigger.getTrigger(triggerType, triggerName, triggerOptions, concept);
                            } catch (e) {
                                console.warn(e);
                            }

                            VarvPerformance.stop("ConceptLoader.parseTrigger", mark);

                            return trigger;
                        }

                        static parseAction(actionName, actionSetup, concept) {
                            let mark = VarvPerformance.start();

                            let chain = new ActionChain(actionName, {}, concept);

                            actionSetup.forEach((actionPart) => {
                                if(typeof actionPart === "string") {
                                    if(Action.hasPrimitiveAction(actionPart)) {
                                        chain.addAction(Action.getPrimitiveAction(actionPart, {}, concept));
                                    } else {
                                        let lookupAction = new LookupActionAction("", {
                                            "lookupActionName": actionPart
                                        }, concept);

                                        chain.addAction(lookupAction);
                                    }
                                } else {
                                    let keys = Object.keys(actionPart);

                                    if(keys.length > 1) {
                                        console.warn("You have an action with more than one key as action name: ", actionPart);
                                    }

                                    let actionName = keys[0];
                                    let actionOptions = actionPart[actionName];

                                    let action = null;

                                    try {
                                        // Check for primitive action
                                        action = Action.getPrimitiveAction(actionName, actionOptions, concept);
                                    } catch(e) {
                                        // No primitive action, reference with arguments?
                                        action = new LookupActionAction("", {
                                            "lookupActionName": actionName,
                                            "lookupActionArguments": actionOptions
                                        }, concept);
                                    }

                                    chain.addAction(action);
                                }
                            });

                            VarvPerformance.stop("ConceptLoader.parseAction", mark);

                            return chain;
                        }
                    }

                    ConceptLoader.DEBUG = false;
                    window.ConceptLoader = ConceptLoader;

                    </SCRIPT><SCRIPT id="VarvEngine-script" type="disabled">
                    /**
                     *  VarvEngine - The core of the Varv system
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     */

                    /**
                     * @private
                     */

                    const RELOAD_TIMEOUT = 1000;

                    class VarvEngine {
                        static getConceptFromUUID(uuid) {
                            let mark = VarvPerformance.start();

                            let cachedConcept = VarvEngine.conceptUUIDCache.get(uuid);
                            if(cachedConcept != null) {
                                VarvPerformance.stop("VarvEngine.getConceptFromUUID.cached", mark);
                                return cachedConcept;
                            }

                            return new Promise(async (resolve, reject)=>{
                                let promises = [];

                                try {
                                    for(let ds of Datastore.getAllDatastores()) {
                                        promises.push(ds.lookupConcept(uuid));
                                    }

                                    let result = await Promise.any(promises);

                                    if(result != null) {
                                        VarvEngine.conceptUUIDCache.set(uuid, result);
                                    }

                                    VarvPerformance.stop("VarvEngine.getConceptFromUUID.nonCached", mark);

                                    resolve(result);
                                } catch(e) {
                                    VarvPerformance.stop("VarvEngine.getConceptFromUUID.nonCached.error", mark);

                                    resolve(null);
                                }
                            });
                        }

                        static async switchConceptType(uuid, newConcept, oldConcept) {
                            console.groupCollapsed("%c EXPERIMENTAL: Switching "+uuid+" from "+oldConcept.name+" to "+newConcept.name, "background: red; color: yellow");

                            //Find and save all properties of the concept
                            let oldProperties = {};

                            for(let property of oldConcept.properties) {
                                property = property[1];
                                oldProperties[property.name] = {
                                    "type": property.type,
                                    "value": await property.getValue(uuid)
                                }

                                property.purgeCache(uuid);
                            }

                            console.log("Old properties:", oldProperties);

                            //Dissapear the instance
                            await oldConcept.disappeared(uuid);

                            console.log("Creating instance as new concept!");
                            VarvEngine.registerConceptFromUUID(uuid, newConcept);

                            //Appear new instance
                            await newConcept.appeared(uuid);

                            //Set all properties that match
                            for(let property of newConcept.properties) {
                                property = property[1];

                                if(oldProperties[property.name] != null) {
                                    let oldProperty = oldProperties[property.name];
                                    console.log("Matching property name:", oldProperty);
                                    try {
                                        await property.setValue(uuid, oldProperty.value);
                                    } catch(e) {
                                        console.warn("Unable to set property on new concept type:", e);
                                    }
                                }
                            }

                            console.log("Cleaning references:");

                            //Clean all references that no longer match
                            for(let concept of VarvEngine.concepts) {
                                for(let [key, property] of concept.properties) {
                                    //If property could hold old concept type, but not new, remove if our reference exists
                                    if(property.holdsConceptOfType(oldConcept) && !property.holdsConceptOfType(newConcept)) {
                                        console.log("Found property that can no longer hold our reference:", property.name);
                                        await property.removeAllReferences(concept.name, uuid);
                                    }
                                }
                            }

                            console.groupEnd();
                        }


                        static getConceptFromType(type) {
                            return VarvEngine.conceptTypeMap.get(type);
                        }

                        static async countInstances(typeNames, query, context, localConcept) {
                            //TODO: What is correct here?

                            let maxCount = 0;

                            for(let datastore of Datastore.getAllDatastores()) {
                                let count = await datastore.countInstances(typeNames, query, context, localConcept);
                                maxCount = Math.max(count, maxCount);
                            }

                            return maxCount;
                        }

                        static async existsInstance(typeNames, query, context, localConcept) {
                            //TODO: What is correct here?

                            let exists = false;
                            for(let datastore of Datastore.getAllDatastores()) {
                                let result = await datastore.existsInstance(typeNames, query, context, localConcept);
                                if(result) {
                                    exists = true;
                                    break;
                                }
                            }

                            return exists;
                        }

                        /**
                         *
                         * @param {String|String[]}typeNames
                         * @param {Filter} query
                         * @param {VarvContext} context
                         * @param {number}limit
                         * @param {Concept} localConcept
                         * @returns {Promise<any[]>}
                         */
                        static async lookupInstances(typeNames, query, context, limit = 0, localConcept = null) {
                            if(!Array.isArray(typeNames)) {
                                typeNames = [typeNames];
                            }

                            const mark = VarvPerformance.start();

                            let result = new Set();
                            let promises = [];
                            for(let ds of Datastore.getAllDatastores()) {
                                promises.push(ds.lookupInstances(typeNames, query, context, limit, localConcept));
                            }

                            let promiseResults = await Promise.all(promises);

                            promiseResults.forEach((uuids)=>{
                                if(uuids != null) {
                                    uuids.forEach((uuid)=>{
                                        result.add(uuid);
                                    });
                                }
                            });
                            VarvPerformance.stop("VarvEngine.lookupInstances", mark, {typeNames, query, limit});

                            return Array.from(result);
                        }

                        static async getAllUUIDsFromType(type, includeOtherConcepts=false) {
                            if(VarvEngine.getAllUUIDsFromTypeWarningShowed !== true) {
                                console.groupCollapsed("%c DEPRECATED: [getAllUUIDsFromType] - consider rewriting ", "background: yellow; color: red;");
                                console.trace();
                                console.groupEnd();
                                VarvEngine.getAllUUIDsFromTypeWarningShowed = true;
                            }

                            const mark = VarvPerformance.start()

                            let uuidSet = new Set();

                            let lookupTypes = [type];

                            if(includeOtherConcepts) {
                                lookupTypes = VarvEngine.getAllImplementingConceptNames(type);
                            }

                            for(let ds of Datastore.getAllDatastores()) {
                                if(lookupTypes.find((type)=>{
                                    return ds.isConceptTypeMapped(type);
                                }) != null) {
                                    if(! (ds instanceof DirectDatastore)) {
                                        console.warn("getAllUUIDsFromType called on concept stored inside non DirectDatastore, potentially risky!");
                                    }

                                    //Pretend filtering is not a thing atm
                                    let uuids = await ds.lookupInstances(lookupTypes, null, null, 0, null);
                                    uuids.forEach((uuid) => {
                                        uuidSet.add(uuid);
                                    });
                                }
                            }

                            VarvPerformance.stop("VarvEngine.getAllUUIDsFromType", mark, {conceptType: type});

                            return Array.from(uuidSet);
                        }

                        static getAllImplementingConceptNames(primaryType) {
                            return VarvEngine.getAllImplementingConcepts(primaryType).map((concept)=>{
                                return concept.name;
                            });
                        }

                        /**
                         * Returns an array of Concept that implement the given type, starting with
                         * the primary type itself
                         * @param {type} primaryTypeName
                         * @returns {Array}
                         */
                        static getAllImplementingConcepts(primaryTypeName){

                            // Find all concepts with type, including other concepts
                            let primaryConcept = null;
                            let otherConcepts = VarvEngine.concepts.filter((concept)=>{
                                if(concept.name === primaryTypeName) {
                                    primaryConcept = concept;
                                    return false; // This is prepended later
                                }

                                if(concept.otherConcepts.has(primaryTypeName)) {
                                    return true;
                                }

                                return false;
                            });

                            if(primaryConcept != null) {
                                otherConcepts.unshift(primaryConcept);
                            }

                            return otherConcepts;
                        }

                        static lookupAction(actionName, lookupConcepts = [], primitiveOptions = {}) {
                            let mark = VarvPerformance.start();

                            //Filter null and undefined
                            lookupConcepts = lookupConcepts.filter((concept)=>{
                                return concept != null;
                            });

                            //Make unique
                            lookupConcepts = new Set(lookupConcepts);

                            //Add other concepts
                            for(let concept of VarvEngine.conceptTypeMap.values()) {
                                lookupConcepts.add(concept);
                            }

                            if(VarvEngine.DEBUG) {
                                console.groupCollapsed("Looking up:", actionName, [...lookupConcepts].map((concept)=>{return concept.name}));
                            }

                            let action = VarvEngine.lookupActionInternal(actionName, lookupConcepts, primitiveOptions);

                            if(VarvEngine.DEBUG) {
                                if(action != null) {
                                    console.log("Found action:", action);
                                }
                                console.groupEnd();
                            }

                            VarvPerformance.stop("VarvEngine.lookupAction", mark, {actionName});

                            return action;
                        }

                        /**
                         * @private
                         * @param {string} actionName
                         * @param {Set<Concept>} lookupConcepts
                         * @returns {Action|null}
                         */
                        static lookupActionInternal(actionName, lookupConcepts, primitiveOptions = {}) {

                            let conceptName = null;

                            let split = actionName.split(".");

                            if(split.length === 1) {
                                actionName = split[0];
                            } else if(split.length === 2) {
                                conceptName = split[0];
                                actionName = split[1];
                            } else {
                                throw new Error("Only able to lookup actions of the form 'actionname' or 'concept.actionname'");
                            }

                            if(VarvEngine.DEBUG) {
                                console.log("Checking if lookup was on the form 'concept.actionname'");
                            }

                            if(conceptName != null) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Lookup was 'concept.actionname', forcing lookup to specific concept: ", conceptName);
                                }

                                let concept = this.conceptTypeMap.get(conceptName);

                                if (concept != null) {
                                    if(VarvEngine.DEBUG) {
                                        console.log("Trying to lookup action [" + actionName + "] on concept [" + concept.name + "]");
                                    }
                                    return concept.getAction(actionName);
                                } else {
                                    throw new Error("Attempted lookup on form 'concept.actionname' where concept did not exist!");
                                }
                            }

                            //Lookup action directly from name, trying default concept first
                            if(lookupConcepts!=null && lookupConcepts.size > 0) {
                                if(VarvEngine.DEBUG) {
                                    console.group("Trying to lookup on lookupConcepts in order");
                                }
                                for(let lookupConcept of lookupConcepts) {
                                    if(VarvEngine.DEBUG) {
                                        console.log("Trying lookup on concept:", lookupConcept.name);
                                    }

                                    let action = lookupConcept.getAction(actionName);

                                    if(action != null) {
                                        if(VarvEngine.DEBUG) {
                                            console.groupEnd();
                                        }
                                        return action;
                                    }
                                }
                                if(VarvEngine.DEBUG) {
                                    console.groupEnd();
                                }
                            }

                            if(VarvEngine.DEBUG) {
                                console.log("Trying lookup on primitive actions...")
                            }

                            //Try primitive actions?
                            try {
                                if (Action.hasPrimitiveAction(actionName)) {
                                    return Action.getPrimitiveAction(actionName, primitiveOptions, null);
                                }
                            } catch(e) {}

                            if(VarvEngine.DEBUG) {
                                console.log("Action not found!");
                            }

                            return null;
                        }

                        static isKnownConceptType(type) {
                            return VarvEngine.conceptTypeMap.has(type);
                        }

                        static registerConceptFromUUID(uuid, concept) {
                            let mark = VarvPerformance.start();
                            //Legacy register of all direct datastores
                            for(let ds of Datastore.getAllDatastores()) {
                                if(ds instanceof DirectDatastore) {
                                    ds.registerConceptFromUUID(uuid, concept);
                                }
                            }

                            //Precache ourselves aswell
                            VarvEngine.conceptUUIDCache.set(uuid, concept);

                            VarvPerformance.stop("VarvEngine.registerConceptFromUUID", mark);
                        }

                        static deregisterConceptFromUUID(uuid, concept) {
                            this.conceptUUIDCache.delete(uuid);

                            //Also clear lookupTarget cache for this concept, if the concept was the target
                            let possibleCache = VarvEngine.lookupTargetCache.get(concept.name);
                            if(possibleCache?.data === uuid) {
                                VarvEngine.lookupTargetCache.delete(concept.name);
                            }

                            //Legacy register of all direct datastores
                            for(let ds of Datastore.getAllDatastores()) {
                                if(ds instanceof DirectDatastore) {
                                    ds.deregisterConceptFromUUID(uuid);
                                }
                            }
                        }

                        static registerConceptFromType(type, concept) {
                            let oldConcept = this.conceptTypeMap.get(type);

                            if(oldConcept != null && oldConcept != concept) {
                                console.warn("Registering ["+type+"] already registered", oldConcept, concept);
                            }

                            VarvEngine.conceptTypeMap.set(type, concept);
                        }

                        static deregisterConceptFromType(type) {
                            for(let ds of Datastore.getAllDatastores()) {
                                if(ds instanceof DirectDatastore) {
                                    ds.deregisterConceptFromType(type);
                                }
                            }

                            VarvEngine.conceptTypeMap.delete(type);
                        }

                        /**
                         * Legacy start, no longer used, Varv starts by itself
                         */
                        static async start() {
                            console.log("await VarvEngine.start() legacy function no longer does anything, Varv is always started - you can remove this call from your code");
                        }

                        static async init(){
                            let reloading = false;
                            let reloadQueueId = null;

                            let foundDefinitionFragments = [];

                            const live = new LiveElement("code-fragment[data-type='text/varv'],code-fragment[data-type='text/varvscript']");

                            let firstRun = true;

                            let fragmentChangedHandler = (fragment)=>{
                                if(fragment.fragment != null) {
                                    fragment = fragment.fragment;
                                }
                                if(fragment.auto) {
                                    queueReload();
                                }
                            }

                            let fragmentAutoChangedHandler = ()=>{
                                queueReload();
                            }

                            live.forEach((elm)=>{
                                let fragment = Fragment.one(elm);
                                elm.fragmentLink = fragment;

                                foundDefinitionFragments.push(fragment);

                                fragment.registerOnFragmentChangedHandler(fragmentChangedHandler);
                                fragment.registerOnAutoChangedHandler(fragmentAutoChangedHandler);

                                if(!firstRun) {
                                    if(fragment.auto) {
                                        queueReload();
                                    }
                                }
                            });

                            live.removed((elm)=>{
                                let fragment = elm.fragmentLink;
                                foundDefinitionFragments.splice(foundDefinitionFragments.indexOf(fragment), 1);
                                fragment.unRegisterOnFragmentChangedHandler(fragmentChangedHandler);
                                fragment.unRegisterOnAutoChangedHandler(fragmentAutoChangedHandler);
                                if(elm.hasAttribute("auto")) {
                                    queueReload();
                                }
                            });

                            firstRun = false;
                            await queueReload(true);

                            async function reload() {
                                let mark = VarvPerformance.start();
                                reloading = true;
                                if (VarvEngine.DEBUG) {
                                    console.group("Reloading VarvEngine....");
                                }

                                if (VarvEngine.DEBUG) {
                                    console.log("Destroying old engine...");
                                }
                                for (let concept of VarvEngine.concepts) {
                                    await concept.destroy();
                                }

                                VarvEngine.concepts = [];

                                for (let datastore of Datastore.datastores.values()) {
                                    if (VarvEngine.DEBUG) {
                                        console.log("Destroying datastore:", datastore);
                                    }
                                    datastore.destroy();
                                }
                                Datastore.datastores.clear();

                                VarvEngine.conceptUUIDCache.clear();
                                VarvEngine.conceptTypeMap.clear();
                                VarvEngine.lookupPropertyCache.clear();
                                VarvEngine.lookupTargetCache.clear();
                                PropertyCache.reset();

                                if (VarvEngine.DEBUG) {
                                    console.log("Merging definition fragments...");
                                }

                                let combinedObj = {};

                                for (let fragment of foundDefinitionFragments) {
                                    if (fragment.auto) {
                                        let varvJson = await fragment.require();

                                        combinedObj = VarvEngine.merge(combinedObj, varvJson);

                                        //Attempt to merge conflicts we know how to handle:
                                        VarvEngine.resolveMergeConflicts(combinedObj);
                                    } else {
                                        if (VarvEngine.DEBUG) {
                                            console.log("Skipping disabled fragment:", fragment);
                                        }
                                    }
                                }

                                if (VarvEngine.DEBUG) {
                                    console.log("Combined Spec:", combinedObj);
                                }

                                if (VarvEngine.DEBUG) {
                                    console.log("Loading new engine...");
                                }

                                let spec = ConceptLoader.parseSpec(combinedObj);

                                VarvEngine.concepts = await ConceptLoader.loadSpec(spec);

                                VarvEngine.concepts.forEach((concept)=>{
                                    concept.doAfterSpecLoadSetup(ConceptLoader.DEBUG);
                                });

                                await VarvEngine.sendEvent("engineReloaded", VarvEngine.concepts);

                                if (VarvEngine.DEBUG) {
                                    console.log("Reload complete...", VarvEngine.concepts);
                                    console.groupEnd();
                                }
                                reloading = false;
                                VarvPerformance.stop("VarvEngine.reload", mark);
                            }

                            function queueReload(initial=false) {
                                return new Promise((resolve)=>{
                                    if(VarvEngine.DEBUG) {
                                        console.log("Queuing reload...");
                                    }

                                    if(reloadQueueId != null) {
                                        window.clearTimeout(reloadQueueId);
                                    }

                                    reloadQueueId = setTimeout(()=>{
                                        reloadQueueId = null;
                                        if(!reloading) {
                                            reloading = true;
                                            reload().then(()=>{
                                                if (!initial){
                                                    iziToast.success({
                                                        title: '',
                                                        message: 'Successfully loaded Varv!',
                                                        transitionIn: "fadeIn",
                                                        transitionOut: 'fadeOut',
                                                        position: "topCenter",
                                                        timeout: 2000,
                                                        close: false,
                                                        closeOnClick: true
                                                    });
                                                }
                                                reloading = false;
                                                resolve();
                                            }).catch((e)=>{
                                                iziToast.error({
                                                    title: '',
                                                    message: 'Error reloading Varv: '+e.message,
                                                    transitionIn: "fadeIn",
                                                    transitionOut: 'fadeOut',
                                                    position: "topCenter",
                                                    timeout: 2000,
                                                    close: false,
                                                    closeOnClick: true
                                                });
                                                console.groupEnd();
                                                console.error(e);
                                                reloading = false;
                                                resolve();
                                            });
                                        } else {
                                            queueReload().then(()=>{
                                                resolve();
                                            });
                                        }
                                    }, initial?0:RELOAD_TIMEOUT);
                                });
                            }

                            EventSystem.registerEventCallback("Varv.Restart", ()=>{
                                queueReload();
                            });
                        }

                        static async lookupTarget(concept, useOtherConcepts=true) {
                            let target = null;

                            let mark = VarvPerformance.start();

                            let cache = VarvEngine.lookupTargetCache.get(concept.name);
                            if(cache != null) {
                                VarvPerformance.stop("VarvEngine.lookupTarget.cached", mark);
                                cache.hit++;
                                return cache.data;
                            }

                            let instanceTypes = [];
                            instanceTypes.push(concept.name);

                            if(useOtherConcepts) {
                                instanceTypes.push(...VarvEngine.getAllImplementingConceptNames(concept.name));
                            }

                            let uuids = await VarvEngine.lookupInstances(instanceTypes, null, null,2, null);
                            if(uuids.length > 0) {
                                target = uuids[0];
                                if(uuids.length > 1) {
                                    console.warn("[lookupTarget] Multiple uuid's exist for concept ["+concept.name+"]", uuids);
                                }

                                VarvPerformance.stop("VarvEngine.lookupTarget", mark);

                                VarvEngine.lookupTargetCache.set(concept.name, {
                                    data: target,
                                    hit: 0
                                });

                                return target;
                            }

                            throw new Error("No instance of concept found: "+concept.name);
                        }

                        /**
                         * The object returned from lookupProperty
                         * @typedef {object} lookupPropertyObject
                         * @property {Concept} concept The concept the property was found on
                         * @property {Property} property The property itself
                         * @property {string} target The target to look up the property on
                         */

                        /**
                         *
                         * @param {string|Concept} contextTarget
                         * @param {Concept} localConcept
                         * @param {string} propertyName
                         * @returns {null|lookupPropertyObject}
                         */
                        static async lookupProperty(contextTarget, localConcept, propertyName) {
                            const DEBUG_LOOKUP_PROPERTY = false;

                            const mark = VarvPerformance.start();

                            const lookupPropertyCacheKey = "CTX:"+(contextTarget?.target!=null?contextTarget.target:"NULL")+"CPT:"+(localConcept!=null?localConcept.name:"NULL")+"PN:"+propertyName;

                            let cache = VarvEngine.lookupPropertyCache.get(lookupPropertyCacheKey);

                            if(cache != null) {
                                if(cache.isValid()) {
                                    cache.hit++;
                                    VarvPerformance.stop("VarvEngine.lookupProperty.cached", mark);
                                    return cache.data;
                                } else {
                                    VarvEngine.lookupPropertyCache.delete(lookupPropertyCacheKey);
                                }
                            }

                            if(VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                console.groupCollapsed("Looking up property:", propertyName, contextTarget, localConcept);
                                console.trace();
                            }

                            //Lookup of form concept.property, overrides all the other lookup types
                            let conceptName = null;

                            let split = propertyName.split(".");

                            if(split.length === 1) {
                                propertyName = split[0];
                            } else if(split.length === 2) {
                                conceptName = split[0];
                                propertyName = split[1];
                            } else {
                                throw new Error("Only able to lookup actions of the form 'actionname' or 'concept.actionname'");
                            }

                            if (conceptName != null) {
                                if (VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                    console.log("Lookup of form concept.property...", conceptName, propertyName);
                                }

                                let lookupConcept = VarvEngine.getConceptFromType(conceptName);

                                if (conceptName === "lastTarget") {
                                    console.warn("Should never see this (conceptName === 'lastTarget') ?????");
                                }

                                if (lookupConcept != null) {
                                    let lookupProperty = lookupConcept.getProperty(propertyName);

                                    if (lookupProperty != null) {

                                        let lookupTarget = null;

                                        try {
                                            if (contextTarget != null && (await VarvEngine.getConceptFromUUID(contextTarget)).isA(conceptName)) {
                                                //The current target was of this concept, lets assume that is the wanted target?
                                                lookupTarget = contextTarget;
                                            } else {
                                                lookupTarget = await VarvEngine.lookupTarget(lookupConcept);
                                            }
                                        } catch(e) {
                                            //Ignore for now?
                                        }

                                        if (VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                            console.log("Found concept.property, ", lookupProperty, lookupConcept, lookupTarget);
                                            console.groupEnd();
                                        }

                                        VarvPerformance.stop("VarvEngine.lookupProperty.concept.property", mark);

                                        let result = {
                                            property: lookupProperty,
                                            concept: lookupConcept,
                                            target: lookupTarget,
                                            type: "specificConcept"
                                        }

                                        VarvEngine.lookupPropertyCache.set(lookupPropertyCacheKey, {
                                            isValid: () => {
                                                return VarvEngine.lookupTargetCache.get(lookupConcept.name) != null;
                                            },
                                            hit: 0,
                                            data: result
                                        });

                                        return result;
                                    } else {
                                        throw new Error("Lookup property on [" + split.join(".") + "], property does not exist: " + propertyName);
                                    }
                                } else {
                                    throw new Error("Lookup property on [" + split.join(".") + "], concept does not exist: " + conceptName);
                                }
                            }

                            //Lookup on contextConcept
                            try {
                                let contextConcept = null;

                                if(contextTarget instanceof Concept) {
                                    contextConcept = contextTarget;
                                    contextTarget = null;
                                } else {
                                    let promiseOrValue = VarvEngine.getConceptFromUUID(contextTarget);
                                    if(promiseOrValue instanceof Promise) {
                                        promiseOrValue = await promiseOrValue;
                                    }
                                    contextConcept = promiseOrValue;
                                }

                                let property = contextConcept.getProperty(propertyName);

                                if (VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                    console.log("Found on contextConcept", contextConcept.name);
                                    console.groupEnd();
                                }

                                VarvPerformance.stop("VarvEngine.lookupProperty.contextConcept", mark);

                                return {
                                    property: property,
                                    concept: contextConcept,
                                    target: contextTarget,
                                    type: "contextConcept"
                                }
                            } catch(e) {
                                //Ignore
                            }

                            //Lookup on localConcept
                            try {
                                let property = localConcept.getProperty(propertyName);

                                if(VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                    console.log("Found on localConcept", localConcept.name);
                                    console.groupEnd();
                                }

                                VarvPerformance.stop("VarvEngine.lookupProperty.localConcept", mark);

                                let target = null;
                                try {
                                    target = await VarvEngine.lookupTarget(localConcept)
                                } catch(e) {
                                    //Ignore
                                }

                                return {
                                    property: property,
                                    concept: localConcept,
                                    target: target,
                                    type: "localConcept"
                                }
                            } catch(e) {
                                //Ignore
                            }

                            //Lookup on globalConcept
                            for(let globalConcept of VarvEngine.concepts) {
                                try {
                                    let property = globalConcept.getProperty(propertyName);

                                    if(VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                        console.log("Found on globalConcept", globalConcept.name);
                                        console.groupEnd();
                                    }

                                    VarvPerformance.stop("VarvEngine.lookupProperty.globalConcept", mark);

                                    let target = null;
                                    try {
                                        target = await VarvEngine.lookupTarget(globalConcept)
                                    } catch(e) {
                                        //Ignore
                                    }

                                    return {
                                        property: property,
                                        concept: globalConcept,
                                        target: target,
                                        type: "globalConcept"
                                    }
                                } catch(e) {
                                    //Ignore
                                }
                            }

                            VarvPerformance.stop("VarvEngine.lookupProperty.notFound", mark);

                            if(VarvEngine.DEBUG || DEBUG_LOOKUP_PROPERTY) {
                                console.log("Not found...");
                                console.groupEnd();
                            }

                            return null;
                        }

                        /**
                         * Lookup an unknown reference
                         * @param {string} reference - The reference to lookup
                         * @param {Concept} localConcept=null - The concept to lookup properties on first, before trying globally
                         * @param {boolean} executeAtOnce - If true, the value of the function is returned, and not the function.
                         * @returns {function|object|string} - An object containing the type of reference if known, or just the reference if still unknown
                         */
                        static lookupReference(reference, lookupConcepts = []) {
                            const mark = VarvPerformance.start();

                            let allConcepts = new Set();
                            if(lookupConcepts != null) {
                                if(!Array.isArray(lookupConcepts)) {
                                    lookupConcepts = [lookupConcepts];
                                }

                                lookupConcepts.forEach((concept)=>{
                                    allConcepts.add(concept);
                                });
                            }

                            VarvEngine.concepts.forEach((concept)=>{
                                allConcepts.add(concept);
                            });

                            let lookup = VarvEngine.lookupReferenceInternal(reference, allConcepts);

                            VarvPerformance.stop("VarvEngine.lookupReference", mark, {reference});

                            return lookup;
                        }

                        static lookupReferenceInternal(reference, lookupConcepts) {
                            if(VarvEngine.DEBUG) {
                                console.groupCollapsed("Looking up unknown reference:", reference);
                            }

                            //Check for concept type
                            if (VarvEngine.getConceptFromType(reference) != null) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Was concept!");
                                    console.groupEnd();
                                }
                                return {
                                    "concept": reference
                                }
                            }

                            //Check for view
                            if (DOMView?.singleton.existsAsViewElement(reference)) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Was view!");
                                    console.groupEnd();
                                }
                                return {
                                    "view": reference
                                }
                            }

                            //Check for global property
                            for(let concept of lookupConcepts) {
                                try {
                                    concept.getProperty(reference);

                                    if(VarvEngine.DEBUG) {
                                        console.log("Was property on concept: [" + concept.name + "]");
                                        console.groupEnd();
                                    }

                                    return {
                                        "concept": concept.name,
                                        "property": reference
                                    }
                                } catch(e) {
                                    //Ignore, just means we had no property of given name
                                }
                            }

                            if(VarvEngine.DEBUG) {
                                console.log("Was unknown!");
                                console.groupEnd();
                            }

                            return {
                                "unknown": reference
                            };
                        }

                        static resolveMergeConflicts(spec) {
                            const DEBUG_MERGE = VarvEngine.DEBUG || false;

                            function replaceInSpec(prefix, newValue) {
                                if(prefix.startsWith("spec.")) {
                                    prefix = prefix.substring(5);
                                }

                                let currentPath = spec;
                                let lastPath = null;
                                let lastPrefixPart = null;
                                prefix.split(".").forEach((prefixPart)=>{
                                    lastPath = currentPath;
                                    lastPrefixPart = prefixPart;

                                    if(prefixPart.indexOf("[") !== -1) {
                                        let key = prefixPart.substring(0, prefixPart.indexOf("["));
                                        let index = prefixPart.substring(prefixPart.indexOf("[")+1, prefixPart.indexOf("]"));
                                        //Array entry
                                        currentPath = currentPath[key][index];
                                    } else {
                                        //Object entry
                                        currentPath = currentPath[prefixPart];
                                    }
                                });

                                if(lastPath != null) {
                                    if(lastPrefixPart.indexOf("[") !== -1) {
                                        let key = lastPrefixPart.substring(0, lastPrefixPart.indexOf("["));
                                        let index = lastPrefixPart.substring(lastPrefixPart.indexOf("[")+1, lastPrefixPart.indexOf("]"));
                                        //Array entry
                                        lastPath[key][index] = newValue;
                                    } else {
                                        //Object entry
                                        lastPath[lastPrefixPart] = newValue;
                                    }

                                    return true;
                                }

                                return false;
                            }

                            function handleMergeConflict(prefix, json) {
                                let merged = false;
                                if(DEBUG_MERGE) {
                                    console.group("Attempting to merge: ", prefix, json.mergeConflict);
                                }

                                if(json.mergeConflict.type === "arrayMerge") {
                                    if(DEBUG_MERGE) {
                                        console.log("ArrayMerge");
                                    }

                                    if(prefix.endsWith(".enum")) {
                                        if(DEBUG_MERGE) {
                                            console.log("Enum merge!")
                                        }

                                        merged = replaceInSpec(prefix, json.mergeConflict.part2);
                                    } else if(prefix.endsWith(".then")) {
                                        if(DEBUG_MERGE) {
                                            console.log("Action then merge!");
                                        }

                                        merged = replaceInSpec(prefix, json.mergeConflict.part2);
                                    } else if(prefix.endsWith(".when")) {
                                        if(DEBUG_MERGE) {
                                            console.log("Action when merge!");
                                        }

                                        merged = replaceInSpec(prefix, json.mergeConflict.part2);
                                    } else if(prefix.match(/actions\.\S+$/)) {
                                        if(DEBUG_MERGE) {
                                            console.log("Action array merge!");
                                        }

                                        merged = replaceInSpec(prefix, {"then": json.mergeConflict.part2});
                                    } else if(prefix.endsWith(".extensions")) {
                                        let result = [];
                                        json.mergeConflict.part1.forEach((ext)=>{
                                            result.push(ext);
                                        });
                                        json.mergeConflict.part2.forEach((ext)=>{
                                            result.push(ext);
                                        });

                                        merged = replaceInSpec(prefix, result);
                                    }
                                } else if(json.mergeConflict.type == null) {
                                    if(DEBUG_MERGE) {
                                        console.log("Unknown merge type!");
                                    }

                                    if(prefix.match(/actions\.\S+$/)) {
                                        let then = null;
                                        let when = null;

                                        if(Array.isArray(json.mergeConflict.part1)) {
                                            then = json.mergeConflict.part1;
                                            when = json.mergeConflict.part2.when;
                                        } else if(Array.isArray(json.mergeConflict.part2)) {
                                            then = json.mergeConflict.part2;
                                            when = json.mergeConflict.part1.when;
                                        } else {
                                            //Unknown action merge
                                        }

                                        merged = replaceInSpec(prefix, {then, when});
                                    }
                                }

                                if(DEBUG_MERGE) {
                                    console.groupEnd();
                                }
                                return merged;
                            }

                            //Check for any mergeconflicts left...
                            function findMergeConflict(json, prefix="") {
                                if(typeof json === "object") {
                                    if(Array.isArray(json)) {
                                        json.forEach((elm, index)=>{
                                            findMergeConflict(elm, prefix+"["+index+"]");
                                        });
                                    } else if(json != null) {
                                        if(json.mergeConflict != null) {
                                            let handled = handleMergeConflict(prefix, json);
                                            if(!handled) {
                                                console.warn("Found unhandled mergeConflict:", prefix, json);
                                            }
                                        }

                                        Object.keys(json).forEach((objKey)=>{
                                            let objValue = json[objKey];
                                            findMergeConflict(objValue, prefix+"."+objKey);
                                        });
                                    }
                                }
                            }

                            findMergeConflict(spec, "spec");
                        }

                        static merge(json1, json2) {
                            if(VarvEngine.DEBUG) {
                                console.groupCollapsed("Merging:", json1, json2);
                            }

                            if(json1 == null && json2 != null) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Shortcut json2:", json2);
                                    console.groupEnd();
                                }
                                return json2;
                            } else if(json2 == null && json1 != null) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Shortcut json1:", json1);
                                    console.groupEnd();
                                }
                                return json1;
                            }

                            if(json1 == null && json2 == null) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Null shortcut...");
                                    console.groupEnd();
                                }
                                return null;
                            }

                            //Neither json is null, as that would have resulted in a shortcut...

                            let type1 = typeof json1;
                            let type2 = typeof json2;

                            if(type1 !== type2) {
                                //Types were different, but none of the json was null, this should be an error of some sort?
                                if(VarvEngine.DEBUG) {
                                    console.warn("Unable to merge different types:", json1, json2);
                                    console.groupEnd();
                                }
                                return {
                                    "mergeConflict": {
                                        "part1": json1,
                                        "part2": json2
                                    }
                                };
                            }

                            let isArray1 = Array.isArray(json1);
                            let isArray2 = Array.isArray(json2);

                            if(isArray1 != isArray2) {
                                if(VarvEngine.DEBUG) {
                                    console.warn("One was array, other was not!");
                                    console.groupEnd();
                                }
                                return {
                                    "mergeConflict": {
                                        "part1": json1,
                                        "part2": json2
                                    }
                                };
                            }

                            if(isArray1) {
                                if(VarvEngine.DEBUG) {
                                    console.log("Array merge...");
                                }

                                if(VarvEngine.DEBUG) {
                                    console.groupEnd();
                                }

                                return {
                                    "mergeConflict": {
                                        "type": "arrayMerge",
                                        "part1": json1,
                                        "part2": json2
                                    }
                                };
                            } else if(type1 === "object") {
                                if(VarvEngine.DEBUG) {
                                    console.log("Object merge...");
                                }

                                let result = {};

                                for(let key of Object.keys(json1)) {
                                    result[key] = VarvEngine.merge(json1[key], json2[key]);
                                }

                                for(let key of Object.keys(json2)) {
                                    if(!result.hasOwnProperty(key)) {
                                        //This was not handled already from json1 keys
                                        result[key] = VarvEngine.merge(json1[key], json2[key]);
                                    }
                                }

                                if(VarvEngine.DEBUG) {
                                    console.groupEnd();
                                }
                                return result;
                            } else {
                                if(VarvEngine.DEBUG) {
                                    console.log("Value merge...");
                                }
                                if(json1 !== json2) {
                                    if(VarvEngine.DEBUG) {
                                        console.warn("Non equal values! (Overriding from json2)");
                                    }
                                }

                                if(VarvEngine.DEBUG) {
                                    console.groupEnd();
                                }
                                return json2;
                            }
                        }

                        static async sendEvent(eventName, detail) {
                            if(Datastore.DEBUG) {
                                console.group("Sending varv engine event:", eventName, detail);
                            }
                            let mark = VarvPerformance.start();
                            await EventSystem.triggerEventAsync(VarvEngine.VarvEngineEventPrefix+eventName, detail);
                            VarvPerformance.stop("VarvEngine.sendEvent."+eventName, mark, detail);
                            if(Datastore.DEBUG) {
                                console.groupEnd();
                            }
                        }

                        static registerEventCallback(eventName, callback) {
                            return EventSystem.registerEventCallback(VarvEngine.VarvEngineEventPrefix+eventName, async (evt)=>{
                                await callback(evt.detail);
                            });
                        }

                        static handlePossibleAsync(possiblePromise, callback) {
                            if(possiblePromise instanceof Promise) {
                                //Was promise, so wait for actual value
                                possiblePromise.then((actualValue)=>{
                                    callback(actualValue);
                                });
                            } else {
                                //No promise, so was actual value
                                callback(possiblePromise);
                            }
                        }
                    }

                    VarvEngine.concepts = [];
                    VarvEngine.DEBUG = false;
                    VarvEngine.VarvEngineEventPrefix = "VarvEngineEvent.";
                    VarvEngine.conceptTypeMap = new Map();
                    VarvEngine.conceptUUIDCache = new Map();
                    VarvEngine.lookupPropertyCache = new Map();
                    VarvEngine.lookupTargetCache = new Map();

                    window.VarvEngine = VarvEngine;

                    const urlParams = new URLSearchParams(location.search);
                    window.VarvEngine.disabled = (urlParams.get("varv") === "false");

                    if(!window.VarvEngine.disabled) {
                        wpm.onAllInstalled(async ()=>{
                            if(typeof Fragment !== "undefined") {
                                Fragment.addAllFragmentsLoadedCallback(async ()=>{
                                    console.log("Starting VarvEngine with Codestrates");
                                    await VarvEngine.init();
                                });
                            } else {
                                console.log("Starting VarvEngine");
                                await VarvEngine.init();
                            };
                        });
                    } else {
                        console.log("Varv disabled!");
                    }


                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-codestrates-extensions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv codestrates extension",
                        "description": "Extend Codestrates with Varv fragments",
                        "dependencies": [
                            "codestrates-repos #fragment_core",
                            "codestrates-repos #js-eval-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="ConceptDefinitionFragment-script" type="disabled">
                    /**
                     *  ConceptDefinitionFragment - A Codestrate Fragment type for Concept Definitions
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    wpm.onRemoved(()=>{
                        Fragment.unRegisterFragmentType(ConceptDefinitionFragment);
                    });
                    /**
                     * A fragment that contains Varv code
                     *
                     * Supports auto - executes require() on load
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class ConceptDefinitionFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        async require(options = {}) {
                            return YAMLJSONConverter.loadFromString(this.raw).obj;
                        }

                        supportsAuto() {
                            return true;
                        }

                        static type() {
                            return "text/varv";
                        }
                    };
                    window.ConceptDefinitionFragment = ConceptDefinitionFragment;
                    Fragment.registerFragmentType(ConceptDefinitionFragment);

                    function detectYAMLJSON(editor) {
                        let code = editor.getModel().getValue().trim();
                        let numCurlyBrackets = (code.match(/{/g)||[]).length;

                        let YAML = 0;
                        let JSON = 0

                        if(code.length === 0) {
                            //If fragment is empty, set it up as JSON
                            JSON += 4;
                        }

                        if(numCurlyBrackets > 10) {
                            //Many curly brackets, probably JSON
                            JSON++;
                        } else {
                            YAML++;
                        }

                        if(code.startsWith("{")) {
                            //Code starts with a curly bracket, probably JSON
                            JSON++;
                        } else {
                            YAML++;
                        }

                        if(code.endsWith("}")) {
                            //Code ends with a curly bracket, probably JSON
                            JSON++;
                        } else {
                            YAML++;
                        }

                        if(YAML > JSON) {
                            monaco.editor.setModelLanguage(editor.getModel(), "yaml");
                        } else {
                            monaco.editor.setModelLanguage(editor.getModel(), "json");
                        }
                    }

                    EventSystem.registerEventCallback("Codestrates.Editor.Opened", (evt)=>{
                        let editor = evt.detail.editor;

                        if(editor.fragment instanceof ConceptDefinitionFragment) {
                            editor.fragment.registerOnFragmentChangedHandler(() => {
                                detectYAMLJSON(editor.editor);
                            });
                            detectYAMLJSON(editor.editor);
                        }
                    });

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-inspector" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><STYLE id="inspector-style">
                    .mdc-menu .varv-inspector-preview {
                        background: rgba(100,100,100,0.2);
                        max-width: 30rem;
                        width: 100%;
                        overflow: auto;
                        max-height: 20rem;
                        padding: 0;
                        margin: 0;
                        font-size: 0.8em;
                    }
                    </STYLE><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv engine inspector",
                        "description": "Inspect DOMView rendering elements using ctrl+rclick",
                        "dependencies": [

                        ],
                        "optionalDependencies": [
                            "webstrate-components-repos #MaterialDesignOutlinedIcons",
                            "webstrate-components-repos #MaterialMenu"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="Inspector-script" type="disabled">
                    /**
                     *  Inspector - Allow inspection of rendered DOMView elements
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class Inspector {
                        constructor() {
                            const self = this;

                            document.addEventListener("contextmenu", (evt)=>{
                                if(evt.ctrlKey) {
                                    evt.preventDefault();
                                }
                            });

                            document.addEventListener("mouseup", async (evt)=>{
                                if(evt.button !== 2 || !evt.ctrlKey) {
                                    return;
                                }
                                await wpm.require(["MaterialDesignOutlinedIcons", "MaterialMenu"]);
                                self.handleContextMenu(evt);
                            });
                        }

                        async handleContextMenu(evt) {
                            let conceptBindings = DOMView.singleton.getConceptPath(evt.target);
                            let properties = DOMView.singleton.getPropertyPath(evt.target);
                            let templates = DOMView.singleton.getTemplatePath(evt.target);

                            //console.group("Inspecting:", evt.target);

                            if(window.MenuSystem != null) {
                                console.log("Adding menu ");

                                //Setup context menus
                                let contextMenu = MenuSystem.MenuManager.createMenu("Varv.Inspector.ContextMenu", {
                                    context: evt.target,
                                    groupDividers: true
                                });
                                document.body.appendChild(contextMenu.html);

                                contextMenu.registerOnCloseCallback(()=>{
                                    document.body.removeChild(contextMenu.html);
                                });

                                // Concept path
                                for(let conceptBinding of conceptBindings.reverse()) {
                                    let concept = conceptBinding.concept;
                                    let conceptMenu = MenuSystem.MenuManager.createMenu("ConceptInspectMenu");

                                    if (typeof TreeBrowser !== "undefined"){
                                        let treeBrowsers = TreeBrowser.findAllTreeBrowsers();
                                        if (treeBrowsers){
                                            conceptMenu.addItem({
                                                label: "Inspect in Cauldron",
                                                icon: IconRegistry.createIcon("mdc:gps_fixed"),
                                                onAction: (menuItem) => {
                                                    for (let browser of treeBrowsers){
                                                        let treeNodes = browser.findTreeNode(conceptBinding.uuid);
                                                        if(treeNodes.length > 0) {
                                                            let treeNode = treeNodes[0];
                                                            treeNode.reveal();
                                                            treeNode.select();
                                                        }
                                                    }
                                                }
                                            });
                                        }
                                        contextMenu.addItem({
                                            label: concept.name,
                                            group: "Concepts",
                                            groupOrder: 0,
                                            icon: IconRegistry.createIcon("mdc:api"),
                                            submenu: conceptMenu
                                        });
                                    } else {
                                        contextMenu.addItem({
                                            label: concept.name,
                                            group: "Concepts",
                                            groupOrder: 0,
                                            icon: IconRegistry.createIcon("mdc:api")
                                        });
                                    }
                                };

                                // Template path
                                let currentTemplateTop = null;
                                for (let templateNode of templates.reverse()){
                                    let templateMenu = MenuSystem.MenuManager.createMenu("TemplateInspectMenu");
                                    let fragment = null;

                                    let parentAutoDom = cQuery(templateNode).closest(".autoDom")[0];
                                    if (parentAutoDom){
                                        let id = parentAutoDom.getAttribute("id");
                                        if (id){
                                            fragment = Fragment.one("[transient-fragment-uuid='"+id+"']");
                                        }
                                    }

                                    // Filter som levels
                                    let parentTemplate = cQuery(templateNode).closest("varv-template")[0];
                                    if (!parentTemplate){
                                        parentTemplate = parentAutoDom; // Not a template, use main fragment as top
                                    }
                                    if (currentTemplateTop === parentTemplate){
                                        // Only show one level from each template, skip the rest
                                        continue;
                                    }
                                    currentTemplateTop = parentTemplate;

                                    if (typeof TreeBrowser !== "undefined"){
                                        let treeBrowsers = TreeBrowser.findAllTreeBrowsers();
                                        if (treeBrowsers){
                                            templateMenu.addItem({
                                                label: "Edit in Cauldron",
                                                icon: IconRegistry.createIcon("mdc:mode_edit"),
                                                onAction: (menuItem) => {
                                                    // If this is inside an autoDom fragment, use the fragment
                                                    if (fragment){
                                                        EventSystem.triggerEvent("Cauldron.Open.FragmentEditor", {
                                                            fragment: fragment
                                                        });
                                                    } else {
                                                    }
                                                    // TODO: If this was not autoDom, edit plain HTML template instead
                                                }
                                            });
                                        }
                                    }  else {
                                        templateMenu.addItem({
                                            label: "Dump to console",
                                            icon: IconRegistry.createIcon("mdc:mode_edit"),
                                            onAction: (menuItem) => {
                                                console.log(fragment);
                                            }
                                        });
                                    }

                                    // Text
                                    let textView = document.createElement("pre");
                                    textView.classList.add("varv-inspector-preview");
                                    textView.innerText = templateNode.outerHTML;
                                    let source = textView.innerHTML;
                                    let replacement = "<b style='background:rgba(255,0,0,0.2)'>"+textView.innerHTML+"</b>";
                                    textView.innerText = currentTemplateTop.outerHTML;
                                    templateMenu.registerOnOpenCallback(()=>{
                                        textView.innerHTML = textView.innerHTML.replace(source,replacement);
                                        templateMenu.html.appendChild(textView);
                                    });

                                    let content = templateNode.tagName;
                                    if (fragment){
                                        console.log(fragment);
                                        let name = fragment.html[0].getAttribute("name");
                                        if (name != null && name != ""){
                                            content = name+" ";
                                        }
                                        if(fragment.html[0].id != null && fragment.html[0].id!="") {
                                            content += "#"+fragment.html[0].id;
                                        }
                                    }

                                    contextMenu.addItem({
                                        label: content,
                                        group: "Templates",
                                        groupOrder: 1,
                                        icon: IconRegistry.createIcon("code-fragment:text/html"),
                                        submenu: templateMenu
                                    });

                                }

                                contextMenu.open({
                                    x: evt.x,
                                    y: evt.y
                                });
                            };



                            console.groupCollapsed("Concepts - Closest concept is last");
                            for(let conceptBinding of conceptBindings) {
                                let concept = conceptBinding.concept;
                                let uuid = conceptBinding.uuid;

                                console.group("Concept:", concept.name, uuid);

                                console.groupCollapsed("Properties");
                                for(let property of concept.properties.values()) {
                                    let value = await property.getValue(uuid);
                                    console.log(property.name+": ", value);
                                }
                                console.groupEnd();

                                function debugAction(action) {
                                    if(action instanceof ActionChain) {
                                        if(action.actions.length === 1) {
                                            debugAction(action.actions[0]);
                                        } else {
                                            console.groupCollapsed(action.name+":", action.constructor.name);
                                            for(let actionChainElement of action.actions) {
                                                debugAction(actionChainElement);
                                            }
                                            console.groupEnd();
                                        }
                                    } else {
                                        let actionName = action.name;
                                        if(actionName.length > 0) {
                                            actionName += ":";
                                        }
                                        console.log(actionName, action.constructor.name, action.options);
                                    }
                                }

                                console.groupCollapsed("Actions");
                                for(let action of concept.actions.values()) {
                                    debugAction(action);
                                }
                                console.groupEnd();

                                console.groupCollapsed("Behaviours");
                                for(let behaviour of concept.behaviours.values()) {
                                    console.groupCollapsed(behaviour.name+":", behaviour.constructor.name);
                                    console.group("When:");
                                    for(let triggerName of behaviour.triggers) {
                                        let trigger = concept.getTrigger(triggerName);
                                        console.log(trigger.name+":", trigger.constructor.name, trigger.options);
                                    }
                                    console.groupEnd();
                                    console.group("Then:");
                                    for(let action of behaviour.actionChain.actions) {
                                        debugAction(action);
                                    }
                                    console.groupEnd();
                                    console.groupEnd();
                                }
                                console.groupEnd();

                                console.groupEnd();
                            }

                            console.groupEnd();

                            console.groupCollapsed("Views - Closest view is first");

                            let parent = evt.target;

                            while(parent != null && parent.parentNode != null) {
                                if(parent.matches("[view]")) {
                                    let viewName = parent.getAttribute("view");
                                    console.log("View:", viewName, parent);
                                }

                                parent = parent.parentNode;
                            }

                            console.groupEnd();

                            console.groupCollapsed("Properties - ");
                            for(let property of properties) {
                                let type = property.property.type;

                                if(type === "array") {
                                    type = property.property.options.items+"[]";
                                }

                                console.log(property.property.name+":", type);
                            }
                            console.groupEnd();

                            console.groupEnd();
                        }
                    }
                    window.Inspector = Inspector;
                    Inspector.instance = new Inspector();

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-dom-triggers" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv engine triggers for DOM elements",
                        "description": "A set of event handlers for triggering on DOM elements",
                        "dependencies": [

                        ],
                        "optionalDependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="DOMTriggers-script" type="disabled">
                    /**
                     *  DOMTriggers - Triggers based on DOM events
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */


                    // click(concept/element-property)
                    // hover(concept/element-property)
                    // focus(concept/element-property)
                    // key(key, concept/element-property focus, event=key-up, shift=false, meta=false)
                    // drag-n-drop hell

                    /**
                     * General MouseTrigger class, for use for the different ones
                     */
                    class MouseTrigger extends Trigger {
                        static options() {
                            return {
                                "$mouseTarget": "@enumValue[concept,property,view,runtimeLookup]",
                                "where": "filter"
                            }
                        }

                        constructor(name, options, concept, type) {
                            if(typeof options === "string") {
                                options = {
                                    runtimeLookup: options
                                }
                            }

                            super(name, options, concept);

                            this.type = type;

                            this.triggerDelete = null;
                        }

                        enable() {
                            const self = this;

                            this.triggerDelete = Trigger.registerTriggerEvent(this.type, async (context)=> {
                                //Try looking up shorthand
                                let options = Object.assign({}, this.options);

                                if(options.runtimeLookup != null) {
                                    let lookupResult = VarvEngine.lookupReference(options.runtimeLookup, self.concept);
                                    options = Object.assign(options, lookupResult);
                                }

                                //Always only 1 entry in array
                                context = context[0];

                                let resultContext = Action.cloneContext(context);

                                if(options.exactConceptMatch && options.concept == null) {
                                    //We are matching excact on concept, but have no concept, use owning concept
                                    options.concept = self.concept.name;
                                }

                                //Check if this context matches our options
                                if(options.concept != null) {
                                    //Reset target, we will set it if matching concept is found
                                    resultContext.target = null;

                                    for(let i = context.conceptUUIDs.length-1; i >= 0; i--) {
                                        let uuid = context.conceptUUIDs[i];
                                        let concept = await VarvEngine.getConceptFromUUID(uuid);

                                        if(concept != null) {
                                            if(options.exactConceptMatch) {
                                                //Exact match
                                                if(concept.name === options.concept) {
                                                    resultContext.target = uuid;
                                                    break;
                                                }
                                            } else {
                                                if(concept.isA(options.concept)) {
                                                    resultContext.target = uuid;
                                                    break;
                                                }
                                            }
                                        }
                                    }

                                    if(resultContext.target == null) {
                                        return;
                                    }
                                }

                                if(options.view != null) {
                                    if(!context.targetElement.closest("[view='"+options.view+"']")) {
                                        return;
                                    }
                                }

                                if(options.property) {
                                    let foundPropertyBinding = null;
                                    for(let i = context.properties.length-1; i>= 0; i--) {
                                        let propertyBinding = context.properties[i];
                                        if(propertyBinding.property.name === options.property) {
                                            foundPropertyBinding = propertyBinding;
                                        }
                                    }

                                    if(!foundPropertyBinding) {
                                        return;
                                    }

                                    //Set target to the property's owner.
                                    resultContext.target = foundPropertyBinding.uuid;

                                    if(context.targetElement.viewParticle != null) {
                                        if(typeof foundPropertyBinding.boundValue !== "undefined") {
                                            Action.setVariable(resultContext, "propertyValue", foundPropertyBinding.value);
                                        }
                                        if(typeof foundPropertyBinding.index !== "undefined") {
                                            Action.setVariable(resultContext, "propertyIndex", foundPropertyBinding.index);
                                        }

                                    } else {
                                        try {
                                            let propertyValueLookup = foundPropertyBinding.property.name + ".value";
                                            let propertyValue = await DOMView.singleton.evaluateValueInScope(propertyValueLookup, context.targetElement.scope);
                                            Action.setVariable(resultContext, "propertyValue", propertyValue);
                                        } catch(e) {
                                            console.warn("Error evaluating property value:", e);
                                        }

                                        try {
                                            let propertyIndexLookup = foundPropertyBinding.property.name + ".index";
                                            let propertyIndex = await DOMView.singleton.evaluateValueInScope(propertyIndexLookup, context.targetElement.scope);
                                            Action.setVariable(resultContext, "propertyIndex", propertyIndex);
                                        } catch(e) {
                                            console.warn("Error evaluating property index:", e);
                                        }
                                    }
                                }

                                if(options.unknown != null) {
                                    //Lookup of reference failed, skip trigger
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Unable to lookup reference, skipping trigger:", self);
                                    }
                                    return;
                                }

                                //Filter based on where
                                if(options.where != null) {
                                    let filter = await FilterAction.constructFilter(options.where);

                                    if(await filter.filter(resultContext)) {
                                    } else {
                                        if(DOMTriggers.DEBUG) {
                                            console.log("Mouse trigger was filtered because of where:", options.where, context);
                                        }
                                        return;
                                    }
                                }

                                if(options.preventDefault) {
                                    context.originalEvent.preventDefault();
                                }

                                await Trigger.trigger(self.name, resultContext).then(()=>{
                                    //Ignore
                                });
                            });
                        }

                        disable() {
                            if(this.triggerDelete != null) {
                                this.triggerDelete.delete();
                            }
                            this.triggerDelete = null;
                        }
                    }

                    /**
                     * A trigger "click" that listens for clicks on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "click": {
                     *         "concept": "theConceptIWantToHearClickTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "click": {
                     *         "concept": "theConceptIWantToHearClickTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "click": {
                     *         "view": "aViewBindingIWantToHearClickTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "click": {
                     *         "property": "aPropertyIWantToHearClickTriggerOn"
                     *     }
                     * }
                     */
                    class ClickTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "click");
                        }
                    }
                    Trigger.registerTrigger("click", ClickTrigger);
                    window.ClickTrigger = ClickTrigger;

                    /**
                     * A trigger "mousedown" that listens for mousdown events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "mousedown": {
                     *         "concept": "theConceptIWantToHearMousedownTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "mousedown": {
                     *         "concept": "theConceptIWantToHearMousedownTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "mousedown": {
                     *         "view": "aViewBindingIWantToHearMousedownTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "mousedown": {
                     *         "property": "aPropertyIWantToHearMousedownTriggerOn"
                     *     }
                     * }
                     */
                    class MousedownTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "mousedown");
                        }
                    }
                    Trigger.registerTrigger("mousedown", MousedownTrigger);
                    window.MousedownTrigger = MousedownTrigger;

                    /**
                     * A trigger "mouseup" that listens for mouseup events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "mouseup": {
                     *         "concept": "theConceptIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "mouseup": {
                     *         "concept": "theConceptIWantToHearMouseupTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseup": {
                     *         "view": "aViewBindingIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseup": {
                     *         "property": "aPropertyIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     */
                    class MouseupTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "mouseup");
                        }
                    }
                    Trigger.registerTrigger("mouseup", MouseupTrigger);
                    window.MouseupTrigger = MouseupTrigger;

                    /**
                     * A trigger "contextmenu" that listens for contextmenu events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "contextmenu": {
                     *         "concept": "theConceptIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "contextmenu": {
                     *         "concept": "theConceptIWantToHearMouseupTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "contextmenu": {
                     *         "view": "aViewBindingIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "contextmenu": {
                     *         "property": "aPropertyIWantToHearMouseupTriggerOn"
                     *     }
                     * }
                     */
                    class ContextmenuTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "contextmenu");
                        }
                    }
                    Trigger.registerTrigger("contextmenu", ContextmenuTrigger);
                    window.ContextmenuTrigger = ContextmenuTrigger;

                    /**
                     * A trigger "mousemove" that listens for mousemove events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "mousemove": {
                     *         "concept": "theConceptIWantToHearMousemoveTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "mousemove": {
                     *         "concept": "theConceptIWantToHearMousemoveTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "mousemove": {
                     *         "view": "aViewBindingIWantToHearMousemoveTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "mousemove": {
                     *         "property": "aPropertyIWantToHearMousemoveTriggerOn"
                     *     }
                     * }
                     */
                    class MousemoveTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "mousemove");
                        }
                    }
                    Trigger.registerTrigger("mousemove", MousemoveTrigger);
                    window.MousemoveTrigger = MousemoveTrigger;

                    /**
                     * A trigger "mouseover" that listens for mouseover events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "mouseover": {
                     *         "concept": "theConceptIWantToHearMouseoverTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "mouseover": {
                     *         "concept": "theConceptIWantToHearMouseoverTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseover": {
                     *         "view": "aViewBindingIWantToHearMouseoverTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseover": {
                     *         "property": "aPropertyIWantToHearMouseoverTriggerOn"
                     *     }
                     * }
                     */
                    class MouseoverTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "mouseover");
                        }
                    }
                    Trigger.registerTrigger("mouseover", MouseoverTrigger);
                    window.MouseoverTrigger = MouseoverTrigger;

                    /**
                     * A trigger "mouseout" that listens for mouseout events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "mouseout": {
                     *         "concept": "theConceptIWantToHearMouseoutTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "mouseout": {
                     *         "concept": "theConceptIWantToHearMouseoutTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseout": {
                     *         "view": "aViewBindingIWantToHearMouseoutTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "mouseout": {
                     *         "property": "aPropertyIWantToHearMouseoutTriggerOn"
                     *     }
                     * }
                     */
                    class MouseoutTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "mouseout");
                        }
                    }
                    Trigger.registerTrigger("mouseout", MouseoutTrigger);
                    window.MouseoutTrigger = MouseoutTrigger;

                    /**
                     * A trigger "wheel" that listens for wheel events on DOM elements
                     * @memberOf Triggers
                     * @example
                     * {
                     *     "wheel": {
                     *         "concept": "theConceptIWantToHearWheelTriggerOn"
                     *     }
                     * }
                     * @example
                     * //Match concept exact, not allowing any injected concepts to match
                     * {
                     *     "wheel": {
                     *         "concept": "theConceptIWantToHearWheelTriggerOn",
                     *         "exactConceptMatch": true
                     *     }
                     * }
                     * @example
                     * {
                     *     "wheel": {
                     *         "view": "aViewBindingIWantToHearWheelTriggerOn"
                     *     }
                     * }
                     * @example
                     * {
                     *     "wheel": {
                     *         "property": "aPropertyIWantToHearWheelTriggerOn"
                     *     }
                     * }
                     */
                    class WheelTrigger extends MouseTrigger {
                        constructor(name, options, concept) {
                            super(name, options, concept, "wheel");
                        }
                    }
                    Trigger.registerTrigger("wheel", WheelTrigger);
                    window.WheelTrigger = WheelTrigger;

                    /**
                     * A trigger "key" that listens for key events in the DOM
                     * <br />
                     * Options:
                     * <ul>
                     * <li>event - The event to filter on, keyDown | keyPress | keyUp (Defaults to keyPress)</li>
                     * <li>key - The key to filter on, ex. "a" or "Enter"</li>
                     * <li>ctrl - If ctrl should be pressed or not (If omitted, then state of ctrl is not checked)</li>
                     * <li>alt - If alt should be pressed or not (If omitted, then state of alt is not checked)</li>
                     * <li>shift - If shift should be pressed or not (If omitted, then state of shift is not checked)</li>
                     * <li>meta - If meta should be pressed or not (If omitted, then state of meta is not checked)</li>
                     * <li>focus - If anything should be in focus for the event to trigger, supports concept and view</li>
                     * <li>focus.exactConceptMatch - Should an exact match on concept be enforced. If no focus.concept is defined, the owning concept is used instead.</li>
                     * </ul>
                     * @memberOf Triggers
                     * @example
                     * //Trigger when key "Enter" is pressed and shift is held
                     * {
                     *     "key": {
                     *         "event": "keyPress",
                     *         "key": "Enter",
                     *         "shift": true
                     *     }
                     * }
                     *
                     * //Trigger when key "Enter" is pressed and ctrl is held, and view 'myView' is in focus
                     * {
                     *     "key": {
                     *         "event": "keyPress",
                     *         "key": "Enter",
                     *         "ctrl": true,
                     *         "focus": {"view": "myView"}
                     *     }
                     * }
                     *
                     * //Trigger when key "Enter" is pressed and ctrl is held, and view 'myView' is in focus, and owning concept matches exact on focused concept
                     * {
                     *     "key": {
                     *         "event": "keyPress",
                     *         "key": "Enter",
                     *         "ctrl": true,
                     *         "focus": {"view": "myView", "exactConceptMatch": true}
                     *     }
                     * }
                     */
                    class KeyTrigger extends Trigger {
                        static options() {
                            return {
                                "event": "enum[keyUp,keyDown,keyPress]",
                                "key": "@string",
                                "ctrl": "boolean%false",
                                "alt": "boolean%false",
                                "shift": "boolean%false",
                                "meta": "boolean%false",
                                "focus": "@enumValue[concept,view]"
                            }
                        }

                        constructor(name, options, concept) {
                            const defaultOptions = {
                                event: "keyPress"
                            }

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        enable() {
                            const self = this;

                            this.triggerDelete = Trigger.registerTriggerEvent("key", async (context) => {
                                //Always only 1 entry in array
                                context = context[0];

                                let resultContext = Action.cloneContext(context);

                                if(DOMTriggers.DEBUG) {
                                    console.log("Key trigger:", context, self.options);
                                }

                                if(self.options.key != null && self.options.code != null) {
                                    throw new Error("'key' trigger can only have one of \"key\" or \"code\" option, not both");
                                }

                                if(self.options.key != null && self.options.key.toLowerCase() !== context.variables.key.toLowerCase()) {
                                    //Key does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("key does not match!");
                                    }
                                    return;
                                }

                                if(self.options.code != null && self.options.code !== context.variables.code) {
                                    //Code does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("code does not match!");
                                    }
                                    return;
                                }

                                if(self.options.shift != null && self.options.shift !== context.variables.shift) {
                                    //Shift state does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Shift state does not match!");
                                    }
                                    return;
                                }

                                if(self.options.ctrl != null && self.options.ctrl !== context.variables.ctrl) {
                                    //Ctrl state does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Ctrl state does not match!");
                                    }
                                    return;
                                }

                                if(self.options.alt != null && self.options.alt !== context.variables.alt) {
                                    //Alt state does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Alt state does not match!");
                                    }
                                    return;
                                }

                                if(self.options.meta != null && self.options.meta !== context.variables.meta) {
                                    //Meta state does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Meta state does not match!");
                                    }
                                    return;
                                }

                                if(self.options.event != null && self.options.event !== context.event) {
                                    //Event type does not match
                                    if(DOMTriggers.DEBUG) {
                                        console.log("Event type does not match!");
                                    }
                                    return;
                                }

                                if(self.options.focus != null) {
                                    let focusOptions = self.options.focus;

                                    if(typeof focusOptions === "string") {
                                        focusOptions = VarvEngine.lookupReference(self.options.focus, self.concept);
                                    }

                                    if(self.options.focus.exactConceptMatch && focusOptions.concept == null) {
                                        focusOptions.concept = self.concept.name;
                                    }

                                    if(focusOptions.concept != null) {
                                        let foundFocusConcept = false;
                                        for(let uuid of context.conceptUUIDs) {
                                            let concept = await VarvEngine.getConceptFromUUID(uuid);
                                            if(self.options.focus.exactConceptMatch) {
                                                if (concept.name === self.options.focus) {
                                                    foundFocusConcept = true;
                                                    break;
                                                }
                                            } else {
                                                if (concept.isA(self.options.focus)) {
                                                    foundFocusConcept = true;
                                                    break;
                                                }
                                            }
                                        }

                                        if (!foundFocusConcept) {
                                            if (DOMTriggers.DEBUG) {
                                                console.log("Focus concept does not match!");
                                            }
                                            return;
                                        }
                                    }

                                    if(focusOptions.view != null) {
                                        let foundView = context.targetElement.closest("[view='"+focusOptions.view+"']");
                                        if(!foundView) {
                                            if(DOMTriggers.DEBUG) {
                                                console.log("Focus view does not match!");
                                            }
                                            return;
                                        }
                                    }

                                    if(focusOptions.property != null) {
                                        throw new Error("Unsupported focus on property for key trigger");
                                    }

                                    if(focusOptions.unknown != null) {
                                        if(DOMTriggers.DEBUG) {
                                            console.log("Focus unknown does not match!");
                                        }
                                        return;
                                    }
                                }

                                await Trigger.trigger(self.name, resultContext)
                            });
                        }

                        disable() {
                            if(this.triggerDelete != null) {
                                this.triggerDelete.delete();
                            }
                            this.triggerDelete = null;
                        }
                    }
                    Trigger.registerTrigger("key", KeyTrigger);
                    window.KeyTrigger = KeyTrigger;

                    class DOMTriggers {
                        static setup(targetDocument = document) {
                            if (targetDocument.registeredDOMTriggers){
                                console.log("DOMTriggers: Trying to register on a document that was already registered, ignoring");
                                return;
                            }

                            function mouseHandler(mouseEvent, type) {
                                let x = mouseEvent.pageX;
                                let y = mouseEvent.pageY;

                                let button = "unknown";

                                switch(mouseEvent.button) {
                                    case 0: {
                                        button = "left";
                                        break;
                                    }
                                    case 1: {
                                        button = "middle";
                                        break;
                                    }
                                    case 2: {
                                        button = "right";
                                        break;
                                    }
                                }

                                let uuids = [];

                                let target = null;

                                let properties = [];

                                if(DOMView.singleton != null) {
                                    uuids = DOMView.singleton.getConceptPath(mouseEvent.target).map((binding)=>{return binding.uuid});
                                    properties = DOMView.singleton.getPropertyPath(mouseEvent.target);
                                }

                                if(uuids.length > 0) {
                                    //Use nearest concept uuid as target, if ClickTrigger, does not filter on concept, this is the target that will be shown
                                    target = uuids[uuids.length-1];
                                }

                                let context = {
                                    variables: {
                                        x: x,
                                        y: y,
                                        button: button
                                    },
                                    conceptUUIDs: uuids,
                                    targetElement: mouseEvent.target,
                                    properties: properties,
                                    target: target,
                                    originalEvent: mouseEvent
                                };

                                if(type === "wheel") {
                                    context.variables["wheelDelta"] = mouseEvent.wheelDelta;
                                }

                                Trigger.trigger(type, context);
                            }

                            //Setup click
                            targetDocument.body.addEventListener("click", (evt)=>{
                                mouseHandler(evt, "click");
                            });
                            targetDocument.body.addEventListener("pointermove", (evt)=>{
                                mouseHandler(evt, "mousemove");
                            });
                            targetDocument.body.addEventListener("pointerover", (evt)=>{
                                mouseHandler(evt, "mouseover");
                            });
                            targetDocument.body.addEventListener("pointerout", (evt)=>{
                                mouseHandler(evt, "mouseout");
                            });
                            targetDocument.body.addEventListener("pointerup", (evt)=>{
                                mouseHandler(evt, "mouseup");
                            });
                            targetDocument.body.addEventListener("pointerdown", (evt)=>{
                                mouseHandler(evt, "mousedown");
                            });
                            targetDocument.body.addEventListener("contextmenu", (evt)=>{
                                mouseHandler(evt, "contextmenu");
                            });
                            targetDocument.body.addEventListener("wheel", (evt)=>{
                                mouseHandler(evt, "wheel");
                            });

                            //Setup key
                            function keyHandler(keyEvent, evtType) {
                                let shift = keyEvent.shiftKey;
                                let ctrl = keyEvent.ctrlKey;
                                let meta = keyEvent.metaKey;
                                let alt = keyEvent.altKey;

                                let target = null;
                                let uuids = DOMView.singleton.getConceptPath(keyEvent.target).map((binding)=>{ return binding.uuid});

                                let properties = DOMView.singleton.getPropertyPath(keyEvent.target);

                                if(uuids.length > 0) {
                                    //Use nearest concept uuid as target, if ClickTrigger, does not filter on concept, this is the target that will be shown
                                    target = uuids[uuids.length-1];
                                }

                                let context = {
                                    variables: {
                                        code: keyEvent.code,
                                        key: keyEvent.key,
                                        shift: shift,
                                        ctrl: ctrl,
                                        alt: alt,
                                        meta: meta,
                                    },
                                    event: evtType,
                                    targetElement: keyEvent.target,
                                    conceptUUIDs: uuids,
                                    properties: properties,
                                    target: target,
                                    focusElement: targetDocument.activeElement,
                                    originalEvent: keyEvent
                                }

                                Trigger.trigger("key", context);
                            }

                            targetDocument.body.addEventListener("keydown", (evt)=>{
                                keyHandler(evt, "keyDown");
                            });
                            targetDocument.body.addEventListener("keyup", (evt)=>{
                                keyHandler(evt, "keyUp");
                            });
                            targetDocument.body.addEventListener("keypress", (evt)=>{
                                keyHandler(evt, "keyPress");
                            });

                            targetDocument.registeredDOMTriggers = true;
                        }
                    }

                    DOMTriggers.setup();
                    DOMTriggers.DEBUG = false;
                    window.DOMTriggers = DOMTriggers;

                    // Also find all present and future sub-documents and try to inject our listeners in those documents as well
                    function injectTriggers(frame){
                        try {
                            DOMTriggers.setup(frame.contentDocument);
                        } catch (ex){
                            console.log("DOMTriggers in iframe is experimental and being silly");
                        }
                        frame.addEventListener("load", ()=>{
                            try {
                                DOMTriggers.setup(frame.contentDocument);
                            } catch (ex){
                                console.log("DOMTriggers in iframe is experimental and being silly in a slower way");
                            }
                        });
                    }
                    document.querySelectorAll("iframe").forEach((frame)=>{
                        injectTriggers(frame);
                    });
                    new MutationObserver((mutations) => {
                        for(let mutation of mutations) {
                            switch (mutation.type) {
                                case 'childList':
                                    for(let node of mutation.addedNodes) {
                                        if (node.tagName === "IFRAME") {
                                            injectTriggers(frame);
                                        }
                                    }
                                break;
                            }
                        }
                    }).observe(document.body, {
                        childList: true,
                        subtree: true,
                    });

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-builtin-triggers" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Standard Triggers",
                        "description": "Simple built-in triggers for varv",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="TimingTriggers-script" type="disabled">
                    /**
                     *  Timing Triggers - triggers based on time
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A trigger 'interval' that triggers at a given interval, this trigger event has no target.
                     * @memberOf Triggers
                     * @example
                     * //Trigger every 10 seconds
                     * {
                     *     "interval": 10
                     * }
                     */
                    class IntervalTrigger extends Trigger {
                        static options() {
                            return {
                                "interval": "number"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "number") {
                                options = {
                                    interval: options
                                }
                            }

                            super(name, options, concept);

                            this.intervalId = null;
                        }

                        enable() {
                            const self = this;

                            let interval = this.options.interval;

                            let currentRepetition = 0;

                            this.intervalId = setInterval(async ()=>{
                                await Trigger.trigger(self.name, {
                                    target: null,
                                    variables:{
                                        repetition: currentRepetition
                                    }
                                });

                                currentRepetition++;
                            }, interval);
                        }

                        disable() {
                            if(this.intervalId != null) {
                                clearInterval(this.intervalId);
                            }
                            this.intervalId = null;
                        }
                    }
                    Trigger.registerTrigger("interval", IntervalTrigger);
                    window.IntervalTrigger = IntervalTrigger;

                    </SCRIPT><SCRIPT id="PropertyTriggers-script" type="disabled">
                    /**
                     *  PropertyTriggers - triggers on property changes
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A trigger "stateChanged" that listens for property state changes
                     * @memberOf Triggers
                     * @example
                     * //Triggers the stateChanged event when myProperty has changed, only the first concept that has the property is checked.
                     * {
                     *     "stateChanged": "myProperty"
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when any property on myConcept changes
                     * {
                     *     "stateChanged": "myConcept"
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when any property on myConcept changes, or if myProperty changes, on the first concept it was found on
                     * {
                     *     "stateChanged": ["myConcept", "myProperty"]
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when property myProperty changes on myConcept
                     * {
                     *     "stateChanged": {"myConcept": "myProperty"}
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when property myProperty changes on myConcept
                     * {
                     *     "stateChanged": {
                     *         "concept": "myConcept",
                     *         "property": "myProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when property myProperty changes
                     * {
                     *     "stateChanged": {
                     *         "property": "myProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Triggers the stateChanged event when a property on myConcept changes
                     * {
                     *     "stateChanged": {
                     *         "concept": "myConcept"
                     *     }
                     * }
                     */
                    class StateChangedTrigger extends Trigger {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                //Shorthand options string
                                options = {
                                    runtimeLookup: [options]
                                };
                            } else if(Array.isArray(options)) {
                                //Shorthand options concept array
                                options = {
                                    runtimeLookup: []
                                }
                                for(let i = 0; i<options.length; i++) {
                                    options.runtimeLookup.push(options[i]);
                                }
                            } else if(Object.keys(options).length === 1) {
                                //Shorthand options {"concept": "property"}
                                let possibleConceptType = Object.keys(options)[0];
                                let concept = VarvEngine.getConceptFromType(possibleConceptType);

                                if(concept != null) {
                                    try {
                                        let property = concept.getProperty(options[possibleConceptType]);

                                        //We have both concept and property, so shorthand was correct
                                        options = {
                                            "concept": concept.name,
                                            "property": property.name
                                        }
                                    } catch(e) {
                                        //Ignore
                                    }
                                }
                            }

                            super(name, options, concept);
                            this.triggerDelete = null;
                        }

                        enable() {
                            const self = this;

                            this.triggerDelete = Trigger.registerTriggerEvent("stateChanged", async (context)=>{
                                //Always only 1 entry in array
                                context = context[0];

                                let options = Object.assign({}, self.options);

                                if(options.runtimeLookup != null) {
                                    let lookedUpReferences = [];
                                    options.runtimeLookup.forEach((reference)=>{
                                        let lookup = VarvEngine.lookupReference(reference, self.concept);
                                        lookedUpReferences.push(lookup);
                                    });

                                    //Set options to the looked up references
                                    options = Object.assign(options, lookedUpReferences);
                                }

                                //Check if options array shorthand
                                if(Array.isArray(options)) {
                                    let temp = options;
                                    options = {
                                        concept: [],
                                        property: []
                                    }

                                    temp.forEach((entry)=>{
                                        if(entry.concept != null) {
                                            options.concept.push(entry.concept);
                                        }

                                        if(entry.property != null) {
                                            options.property.push(entry.property);
                                        }
                                    })
                                }

                                let clonedContext = Action.cloneContext(context);

                                if(Trigger.DEBUG) {
                                    console.log("StateChangedTrigger:", self.name, options, ""+context.target);
                                }

                                let triggeringConcept = await VarvEngine.getConceptFromUUID(context.target);

                                if(triggeringConcept == null) {
                                    throw new Error("Unknown concept for UUID: "+context.target);
                                }

                                if(options.exactConceptMatch && options.concept == null) {
                                    //We are matching excact on concept, but have no concept, use owning concept
                                    options.concept = self.concept.name;
                                }

                                if(options.concept != null) {
                                    let filterConcepts = options.concept;
                                    if(!Array.isArray(filterConcepts)) {
                                        filterConcepts = [filterConcepts];
                                    }

                                    let found = filterConcepts.length === 0;

                                    for(let filterConcept of filterConcepts) {
                                        if(options.exactConceptMatch) {
                                            if (triggeringConcept.name === filterConcept) {
                                                found = true;
                                                break;
                                            }
                                        } else {
                                            if (triggeringConcept.isA(filterConcept)) {
                                                found = true;
                                                break;
                                            }
                                        }
                                    }

                                    if(!found) {
                                        //Skip based on wrong concept
                                        if(Trigger.DEBUG) {
                                            console.log("Skipping based on wrong concept");
                                        }
                                        return;
                                    }
                                }

                                if(options.property != null) {
                                    let filterProperties = options.property;
                                    if(!Array.isArray(filterProperties)) {
                                        filterProperties = [filterProperties];
                                    }

                                    let found = filterProperties.length === 0;

                                    for(let filterProperty of filterProperties) {
                                        if(context.property === filterProperty) {
                                            found = true;
                                            break;
                                        }
                                    }

                                    if(!found) {
                                        //Skip based on wrong property
                                        if (Trigger.DEBUG) {
                                            console.log("Skipping based on wrong property")
                                        }
                                        return;
                                    }
                                }

                                await Trigger.trigger(self.name, clonedContext);
                            });
                        }

                        disable() {
                            if(this.triggerDelete != null) {
                                this.triggerDelete.delete();
                            }
                            this.triggerDelete = null;
                        }
                    }
                    Trigger.registerTrigger("stateChanged", StateChangedTrigger);
                    window.StateChangedTrigger = StateChangedTrigger;

                    </SCRIPT><SCRIPT id="FlowTriggers-script" type="disabled">
                    /**
                     *  FlowTriggers - Triggers based on control flow and calls
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A trigger 'action' that triggers when an action is run
                     * @memberOf Triggers
                     * @example
                     * //Trigger before action 'myActionName' is run
                     * {
                     *     "action": {
                     *         "action": "myActionName",
                     *         "hook": "before"
                     *     }
                     * }
                     *
                     * //Trigger after action 'myActionName' is run
                     * {
                     *     "action": {
                     *         "action": "myActionName",
                     *         "hook": "after"
                     *     }
                     * }
                     *
                     * //Trigger after any of multiple actions are run
                     * {
                     *     "action": {
                     *         "action": ["myActionName", "mySecondActionName", "myThirdActionName"],
                     *         "hook": "after"
                     *     }
                     * }
                     * //Shorthand, trigger after 'myActionName' is run
                     * {
                     *     "action": "myActionName"
                     * }
                     *
                     * //Shorthand, trigger after 'myConcept.myActionName' is run
                     * {
                     *     "action": "myConcept.myActionName"
                     * }
                     *
                     * //Super shorthand, triggers after myActionName
                     * "myActionName"
                     */
                    class ActionTrigger extends Trigger {
                        static options() {
                            return {
                                "action": "string",
                                "hook": "enum[before,after]%after"
                            }
                        }

                        constructor(name, options, concept) {
                            if (typeof options === "string") {
                                options = {
                                    action: options
                                }
                            }

                            let defaultOptions = {
                                "hook": "after"
                            };

                            options = Object.assign({}, defaultOptions, options);

                            super(name, options, concept);
                        }

                        enable() {
                            const self = this;

                            this.deleteTrigger = Trigger.registerTriggerEvent("action", async (contexts)=>{
                                //Only 1 context
                                let context = contexts[0];

                                let actions = self.options.action;

                                if(!Array.isArray(actions)) {
                                    actions = [actions];
                                }

                                for(let actionEntry of actions) {
                                    let actionPart = actionEntry;
                                    let conceptPart = null;

                                    let split = actionEntry.split(".");
                                    if(split.length === 2) {
                                        //Action was on the form, concept.action
                                        actionPart = split[1];
                                        conceptPart = split[0];
                                    }

                                    if(conceptPart != null && context.actionConcept !== conceptPart) {
                                        //Not the concept we are looking for, skip
                                        continue;
                                    }

                                    if(context.actionName !== actionPart) {
                                        //Not the action we are looking for, skip
                                        continue;
                                    }

                                    if(context.hook !== self.options.hook) {
                                        //Not the hook we are looking at, skip
                                        continue;
                                    }

                                    let clonedContexts = Action.cloneContext(context.actionContext);

                                    await Trigger.trigger(self.name, clonedContexts);
                                }
                            });
                        }

                        disable() {
                            if(this.deleteTrigger != null) {
                                this.deleteTrigger.delete();
                            }
                        }

                        static async before(action, contexts) {
                            await ActionTrigger.doTrigger(action, contexts, false);
                        }

                        static async after(action, contexts) {
                            await ActionTrigger.doTrigger(action, contexts, true);
                        }

                        static async doTrigger(action, contexts, after) {
                            await Trigger.trigger("action", {
                                target: null,
                                actionContext: contexts,
                                actionName: action.name,
                                actionConcept: action.concept?.name,
                                hook: after?"after":"before"
                            });
                        }
                    }
                    Trigger.registerTrigger("action", ActionTrigger);
                    window.ActionTrigger = ActionTrigger;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-dom" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv DOM Data Store",
                        "description": "Allow data to be stored in the browser DOM",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="DOMDataStore-script" type="disabled">
                    /**
                     *  DOMDataStore - Store as DOM elements
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A general purpose storage that serializes Concepts and Properties into DOM-elements and their attributes
                     * and stores them in the document.
                     *
                     * For webstrates-based documents this allows synchronizing with other programs
                     * across the web as modifications made to the storage structure also make notifications
                     * back into the program.
                     *
                     * ### Options
                     * * storageName - The name of the element to store that data below (Default: "varv-data")
                     * * storageWebstrate - The name of the webstrate to store the data at (Default: the current webstrate)
                     *
                     * @memberOf Datastores
                     */
                    class DOMDataStore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);

                            this.deleteCallbacks = [];
                        }

                        destroy() {
                            if(this.iframeTransient != null) {
                                this.iframeTransient.remove();
                            }

                            this.stopObserver();

                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            });
                        }

                        async init() {
                            const self = this;

                            let storageName = "varv-data";
                            if(this.options.storageName != null) {
                                storageName = this.options.storageName;
                            }

                            let topElement = document;

                            //If webstrate is specified, find topElement inside iframe
                            if(this.options.storageWebstrate != null) {
                                if(DOMDataStore.DEBUG) {
                                    console.log("Opening storage webstrate:", this.options.storageWebstrate);
                                }
                                let transient = document.createElement("transient");
                                transient.style.display = "none";
                                transient.setAttribute("name", "storageWebstrate-"+this.options.storageWebstrate);
                                let iframe = document.createElement("iframe");

                                transient.appendChild(iframe);
                                document.body.appendChild(transient);

                                iframe.src = "/"+this.options.storageWebstrate;
                                await Observer.waitForTransclude(iframe);

                                if(DOMDataStore.DEBUG) {
                                    console.log("Storage webstrate ready:", this.options.storageWebstrate);
                                }

                                topElement = iframe.contentDocument;

                                this.iframeTransient = transient;
                            }

                            // Try to find an existing one
                            this.backingElement = topElement.querySelector(storageName);

                            this.queryCache = new QuerySelectorCache(this.backingElement);

                            // None exists, create one
                            if (!this.backingElement) {
                                this.backingElement = topElement.createElement(storageName, {approved: true});
                                topElement.body.appendChild(this.backingElement);

                                // TODO: Check if webstrates race condition happened here and remedy it
                            }

                            // Add an observer to data backing element
                            this.observer = new MutationObserver((mutations)=>{
                                self.mutationCallback(mutations);
                            });
                            self.startObserver();

                            //Setup disappeared listener?
                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("disappeared", async (context)=>{
                                if(DOMDataStore.DEBUG) {
                                    console.log("Saw disappeared UUID (DOMDataStore):", context.target);
                                }
                                let conceptDom = this.backingElement.querySelector("concept[uuid='"+context.target+"']");
                                if(conceptDom !== null) {
                                    self.executeObserverless(()=>{
                                        conceptDom.remove();
                                    });
                                }
                            }));

                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("appeared", async (context)=>{
                                if(DOMDataStore.DEBUG) {
                                    console.log("Saw appeared UUID (DOMDataStore):", context.target);
                                }

                                let mark = VarvPerformance.start();
                                if (self.isConceptMapped(context.concept)) {
                                    this.executeObserverless(() => {
                                        self.getConceptElementOrCreate(context.target, context.concept);
                                    });
                                }
                                VarvPerformance.stop("DOMDataStore.registerEventCallback.appeared", mark);
                            }));
                        }

                        async addConcept(node, uuid) {
                            let propertyChangedNodes = [];

                            let self = this;

                            // Check if already exists (this would be a bit weird but could happen in multi-backed concepts where the other backing already registered their part)
                            let conceptByUUID = await VarvEngine.getConceptFromUUID(uuid);

                            // Check if a duplicate already exists in the DOM marshalled data, since that is definitely a mistake
                            let foundConcepts = self.backingElement.querySelectorAll('concept[uuid="'+uuid+'"]');
                            if (foundConcepts.length > 1){
                                console.warn("Warning: More than one DOM concept node found for "+conceptByUUID.name +" - only one element is allowed per uuid, this is bad, deleting extra");

                                self.executeObserverless(()=>{
                                    //Clean everything but the first occurrence?
                                    Array.from(foundConcepts).slice(1).forEach((conceptElement)=>{
                                        conceptElement.remove();
                                    });
                                });

                                return;
                            }

                            // Check if the concept type is available and mapped
                            let conceptType = node.getAttribute("type");
                            if (conceptType===null) {
                                console.warn("DOM concept node added without type, ignoring for now - not sure how to handle it");
                                return;
                            }

                            let concept = VarvEngine.getConceptFromType(conceptType);
                            if (!concept){
                                console.warn("Warning: DOM concept node added for concept of unknown type '"+conceptType+"', ignoring");
                                return;
                            }

                            if (conceptByUUID && concept.name !== conceptByUUID.name){
                                console.warn("Warning: DOM concept node added which specified different type than the one registered in the current mapping, ignoring it");
                                return;
                            }

                            if (!self.isConceptMapped(concept)){
                                console.warn("Warning: DOM concept node added for concept for which there are no DOM-mapped properties in the current mapping, ignoring it");
                                return;
                            }

                            // Everything checks out, let's add it then'
                            if(DOMDataStore.DEBUG) {
                                console.log("DOM saw " + uuid + " of type "+conceptType);
                            }
                            self.registerConceptFromUUID(uuid, concept);

                            // Concepts can only exist as top-level but when added they can already carry properties as children nodes
                            Array.from(node.children).forEach((childNode)=>{
                                if (childNode.tagName==="PROPERTY"){
                                    // Make sure to import those property values if they exist
                                    propertyChangedNodes.push(childNode);
                                }
                            });

                            // Signal that someone made a new concept instance appear for the first time
                            if(conceptByUUID == null) {
                                await concept.appeared(uuid);
                            }

                            return propertyChangedNodes;
                        }

                        async removeConcept(node, uuid) {
                            let self = this;

                            let concept =  self.getConceptFromUUID(uuid);
                            if (!concept ){
                                console.warn("Notice: DOM concept node removed for concept with uuid "+uuid+" that we didn't know about, this inconsistency is odd");
                                return;
                            }

                            let foundConcepts = self.backingElement.querySelectorAll('concept[uuid="'+uuid+'"]');
                            if(foundConcepts.length > 0) {
                                console.warn("Notice: Node with uuid "+uuid+" still exists in DOM, not calling disappear");
                                return;
                            }

                            // Someone deleted this concept instance, let's tell everyone to delete it here too
                            await concept.disappeared(uuid);
                        }

                        async mutationCallback(mutationList) {
                            const self = this;

                            if(DOMDataStore.DEBUG) {
                                console.log("Got remote mutation", mutationList);
                            }

                            let addedConcepts = new Map();
                            let removedConcepts = new Map();
                            let propertyChangedNodes = [];

                            for(let mutation of mutationList) {
                                switch (mutation.type) {
                                    case 'childList':
                                        // Look for newly added concept instances first
                                        for(let node of mutation.addedNodes) {
                                            try {
                                                if (node.tagName==="CONCEPT"){
                                                    let uuid = node.getAttribute("uuid");
                                                    if (uuid===null) {
                                                        console.warn("DOM concept node added without uuid, ignored for now - not sure what to do about it");
                                                        continue;
                                                    }

                                                    addedConcepts.set(uuid, node);
                                                    //Since we saw this node added, it is no longer in queue to be removed
                                                    removedConcepts.delete(uuid);
                                                }

                                                // A property could also be added (set) directly by someone for the first time
                                                if (node.tagName==="PROPERTY"){
                                                    propertyChangedNodes.push(node);
                                                }
                                            } catch (ex){
                                                console.error("Unhandled exception in DOM node adding handler", ex);
                                            }
                                        }

                                        // Removals
                                        for(let node of mutation.removedNodes) {
                                            try {
                                                // Concepts can be removed (deleted) and they appear only as top-level nodes here
                                                if (node.tagName==="CONCEPT"){
                                                    let uuid = node.getAttribute("uuid");
                                                    if (uuid===null) {
                                                        console.warn("DOM concept node removed without uuid, ignored for now - not sure what to do about it");
                                                        return;
                                                    }

                                                    removedConcepts.set(uuid, node);
                                                    //Since we just removed this concept, it is no longer added
                                                    addedConcepts.delete(uuid);
                                                }
                                            } catch (ex){
                                                console.error("Unhandled exception in DOM node remove handler", ex);
                                            }
                                        }

                                        // Array property had one or more new child nodes added to it
                                        if (mutation.target.tagName==="PROPERTY"){
                                            propertyChangedNodes.push(mutation.target);
                                        }

                                        break;
                                    case 'attributes':
                                        // - Simple property value change
                                        if (mutation.attributeName==="value" && mutation.target.tagName==="PROPERTY"){
                                            propertyChangedNodes.push(mutation.target);
                                        }

                                        // TODO: uuid and/or type added to concept that was previously missing it and was thus ignored
                                        break;
                                }
                            }

                            for(let [uuid, node] of addedConcepts.entries()) {
                                let possibleChangedPropertyNodes = await self.addConcept(node, uuid);
                                if(possibleChangedPropertyNodes != null) {
                                    propertyChangedNodes.push(...possibleChangedPropertyNodes);
                                }
                            }

                            for(let entry of removedConcepts.entries()) {
                                await self.removeConcept(entry[1], entry[0]);

                                //Filter property changes, don't run the ones where we removed the concept!
                                propertyChangedNodes = propertyChangedNodes.filter((propertyNode)=>{
                                    let conceptElement = propertyNode.parentElement;
                                    let conceptUUID = conceptElement.getAttribute("uuid");

                                    return conceptUUID != entry[0];
                                });
                            }
                            for(let propertyNode of propertyChangedNodes) {
                                try {
                                    await self.synchronizePropertyElementFromDOM(propertyNode);
                                } catch(e) {
                                    console.error("Error synchronizing property element from dom: ", e);
                                }
                            }
                        }

                        createBackingStore(concept, property) {
                            if(DOMDataStore.DEBUG) {
                                console.log("DOMDataStore Mapping "+concept.name+"."+property.name);
                            }

                            const self = this;
                            if (!concept)
                                throw new Error('Cannot map invalid concept to DOM: ' + concept);
                            if (!property)
                                throw new Error('Cannot map invalid property to DOM for concept: ' + concept + "." + property);
                            if (this.isPropertyMapped(concept, property))
                                throw new Error('Already mapped a DOM backing store for: ' + concept.name + "." + property.name);

                            if (!this.isConceptMapped(concept)){
                                // TODO: This is the first time we hear about this concept, add some create/delete or appear/disappear events as well
                            }
                            let getter = (uuid) => {
                                if(DOMDataStore.DEBUG) {
                                    console.log("DOMDataStore getter: "+concept.name+"."+property.name);
                                }

                                let mark = VarvPerformance.start();

                                let conceptElement = self.queryCache.querySelector("concept[uuid='" + uuid + "']");
                                if (!conceptElement)
                                    throw new Error("No DOM data stored at all for "+concept.name+" with UUID "+uuid+" while getting "+concept.name+"."+property.name);
                                let propertyElement = conceptElement.querySelector("property[name='" + property.name + "']");
                                if (!propertyElement)
                                    throw new Error('No DOM data for property ' + concept.name + "." + property.name + " stored yet with UUID "+uuid);

                                let result = self.getPropertyFromDOM(concept, propertyElement, property);

                                VarvPerformance.stop("DOMDataStore.getter.nonCached", mark);

                                return result;
                            }

                            let setter = (uuid, value) => {
                                let mark = VarvPerformance.start();

                                if(DOMDataStore.DEBUG) {
                                    console.log("DOMDataStore setter: "+concept.name+"."+property.name);
                                }

                                this.executeObserverless(()=>{
                                    let conceptElement = self.getConceptElement(uuid, concept);
                                    if (!conceptElement){
                                        throw new Error("Cannot set property "+property.name+" on "+concept.name+" "+uuid+" because it has not appeared or was deleted");
                                    }

                                    let propertyElement = conceptElement.querySelector("property[name='" + property.name + "']");
                                    if (!propertyElement) {
                                        propertyElement = document.createElement("property", { approved: true });
                                        propertyElement.setAttribute("name", property.name, { approved: true });
                                        conceptElement.appendChild(propertyElement);
                                    }

                                    let oldValue;

                                    try {
                                        oldValue = property.typeCast(getter(uuid));
                                    } catch(e) {
                                        //Ignore
                                    }

                                    if(property.isSame(value, oldValue)) {
                                        //This value was already set in DOM, dont set it again
                                        if(DOMDataStore.DEBUG) {
                                            console.log("Skipping because same value...");
                                        }
                                        return;
                                    }

                                    if (Array.isArray(value)) {
                                        let entryElement = document.createElement("temp");
                                        value.forEach((entryValue) => {
                                            let entry = document.createElement("entry", {approved: true});
                                            if (Array.isArray(entryValue))
                                                throw new Error('Nested arrays not supported yet'); // TODO
                                            entry.setAttribute("value", entryValue);
                                            entryElement.appendChild(entry);
                                        });
                                        propertyElement.innerHTML = entryElement.innerHTML;
                                    } else {
                                        propertyElement.setAttribute("value", value, { approved: true });
                                    }
                                });
                                VarvPerformance.stop("DOMDataStore.setter", mark);
                            }
                            property.addSetCallback(setter);
                            property.addGetCallback(getter);

                            // Check if concept already is mapped, if not, register it
                            this.internalAddPropertyMapping(concept, property, {setter: setter, getter: getter});
                        }

                        getConceptElement(uuid){
                            return this.queryCache.querySelector("concept[uuid='" + uuid + "']");
                        }
                        getConceptElementOrCreate(uuid, concept) {
                            let mark = VarvPerformance.start();
                            let conceptElement = this.getConceptElement(uuid);
                            if (!conceptElement) {
                                conceptElement = document.createElement("concept", {approved: true});
                                conceptElement.setAttribute("type", concept.name, { approved: true });
                                conceptElement.setAttribute("uuid", uuid, { approved: true });
                                this.backingElement.appendChild(conceptElement);
                            }
                            VarvPerformance.stop("DOMDataStore.getConceptElementOrCreate", mark);
                            return conceptElement;
                        }

                        removeBackingStore(concept, property) {
                            if (!concept)
                                throw new Error('Cannot unmap invalid concept from DOM: ' + concept);
                            if (!property)
                                throw new Error('Cannot unmap invalid property from DOM for concept: ' + concept + "." + property);
                            if (!this.isConceptMapped(concept))
                                throw new Error('Cannot unmap property from concept not managed by DOM: ' + concept.name);
                            if (!this.isPropertyMapped(concept, property))
                                throw new Error('Cannot unmap property on managed DOM concept because the property was not mapped: ' + concept.name + "." + property.name);

                            let trackingData = this.internalPropertyTrackingData(concept, property);
                            property.removeSetCallback(trackingData.setter);
                            property.removeGetCallback(trackingData.getter);

                            // TODO: If this was the last mapping for this concept, also remove delete/create or appear/disappear events, we no longer care
                            this.internalRemovePropertyMapping(concept, property);
                        }

                        /**
                         * Loads all concept instances currently registered as backed from serialized state
                         *
                         * @returns {undefined}
                         */
                        async loadBackingStore() {
                            // We restore the state by faking that someone else just added all the contents of the
                            // backing element to our DOM
                            let fakeAddMutationList = [{
                                type: "childList",
                                target: this.backingElement,
                                addedNodes: Array.from(this.backingElement.children),
                                removedNodes: []
                            }];
                            await this.mutationCallback(fakeAddMutationList);
                        }

                        /**
                         * Starts this DOM datastore's mutation observer
                         * @ignore
                         * @protected
                         */
                        startObserver() {
                            this.observer.observe(this.backingElement, {
                                attributes: true,
                                childList: true,
                                subtree: true,
                                attributeOldValue: true,
                                characterData: false,
                                characterDataOldValue: false
                            });
                        }

                        /**
                         * Stops this DOM datastore's mutation observer, handling any mutations that is queued before stopping.
                         * @ignore
                         * @protected
                         */
                        stopObserver() {
                            let mutations = this.observer.takeRecords();
                            if (mutations.length > 0) {
                                this.mutationCallback(mutations);
                            }
                            this.observer.disconnect();
                        }

                        /**
                         * Run the given method without triggering the mutation observer
                         * @ignore
                         * @protected
                         * @param {Function} method - Method to call. Important: must not be async, the observer will be restarted as soon as this promise returns.
                         */
                        executeObserverless(method) {
                            this.stopObserver();

                            //Run our method, potentially adding mutations
                            method();

                            this.startObserver();
                        }

                        /**
                         * Reconstruct a value from DOM
                         * @param {Concept} concept
                         * @param {Element} propertyElement
                         * @param {Property} propertyObject
                         * @returns {any}
                         */
                        getPropertyFromDOM(concept, propertyElement, propertyObject){
                            // Reconstruct the value
                            if (propertyObject.type === "array") {
                                // Unpack as array property
                                let value = [];

                                propertyElement.querySelectorAll(":scope > entry").forEach((childNode) => {
                                    let entryValue = childNode.getAttribute("value");
                                    if (entryValue === null)
                                        throw new Error("Illegal array entry stored in DOM, cannot unmarshal " + concept.name + "." + propertyObject.name);
                                    value.push(entryValue);
                                });

                                return value;
                            } else {
                                // Unpack as flat property
                                let value = propertyElement.getAttribute("value");
                                if (value === null)
                                    throw new Error('No actual value stored in DOM backed property for ' + concept.name + "." + propertyObject.name);

                                return value;
                            }
                        }

                        /**
                         * Takes the element and looks up everything else from that and pushes its state
                         * to the concept
                         * @param {element} propertyElement The element with the property to push to concept
                         */
                        synchronizePropertyElementFromDOM(propertyElement){
                            const self = this;

                            // Lookup concept
                            let conceptElement = propertyElement.parentElement;

                            if(conceptElement.parentElement == null) {
                                console.warn("Parent was not inside dom, skipping synchronize!");
                                return;
                            }

                            if(DOMDataStore.DEBUG) {
                                console.log("Synchronizing:", conceptElement, propertyElement);
                            }

                            let conceptInstance = this.getConceptInstanceFromConceptElement(conceptElement);

                            // Lookup property
                            let propertyName = propertyElement.getAttribute("name");
                            if (propertyName === null) throw new Error("No property name on DOM property node "+conceptInstance.concept.name+" "+propertyElement);
                            let propertyObject = conceptInstance.concept.getProperty(propertyName);

                            return new Promise((resolve)=>{
                                // Fire a set on the property which in turn calls our setter method while pausing our observer to sync with other datastores
                                let value = self.getPropertyFromDOM(conceptInstance.concept, propertyElement, propertyObject);
                                if(DOMDataStore.DEBUG) {
                                    console.log("DOM: Pushing remote change to " + conceptInstance.uuid + " " + conceptInstance.concept.name + "." + propertyObject.name + "=" + value);
                                }
                                propertyObject.setValue(conceptInstance.uuid, propertyObject.typeCast(value)).then(()=>{
                                    resolve();
                                }).catch(()=>{
                                    //Unable to synchronize from dom, as dom did not validate
                                    resolve();
                                });
                            });
                        }

                        /**
                         * Lookup concept and uuid from a concept element
                         * @param {Element} conceptElement
                         * @returns {any}
                         */
                        getConceptInstanceFromConceptElement(conceptElement){
                            if (!conceptElement) throw new Error("Cannot get instance from undefined/null element");

                            // TODO: Consider if manually added elements should get autogenerated uuid somehow, for now ignore it
                            let uuid = conceptElement.getAttribute("uuid");
                            if (uuid===null) throw new Error("Incomplete null concept instance in DOM");

                            let type = conceptElement.getAttribute("type");
                            if (type===null) throw new Error("Incomplete concept instance in DOM ignored, missing type: "+conceptElement.innerHTML);
                            if (!this.isConceptTypeMapped(type)) throw new Error("DOM storage contains data for unmapped type, ignoring: "+type);

                            // Lookup Concept by type through registry
                            let concept = VarvEngine.getConceptFromType(type);
                            if (!concept) throw new Error("DOM storage contains data for mapped type that is not registered in the system: "+type);

                            return {concept: concept, uuid: uuid};
                        }
                    }
                    DOMDataStore.DEBUG = false;
                    window.DOMDataStore = DOMDataStore;

                    //Register default dom datastore
                    Datastore.registerDatastoreType("dom", DOMDataStore);

                    class QuerySelectorCache {
                        constructor(optionalParent) {
                            this.parent = optionalParent!=null?optionalParent:document;
                            this.cache = new Map();
                            this.reverseLookup = new Map();

                            this.setupObserver();
                        }

                        setupObserver() {
                            const self = this;

                            this.observer = new MutationObserver((mutations)=>{
                                mutations.forEach((mutation)=>{
                                    mutation.removedNodes.forEach((node)=>{
                                        let selectors = self.reverseLookup.get(node);
                                        if(selectors != null) {
                                            selectors.forEach((selector)=>{
                                                self.cache.delete(selector);
                                            });
                                            self.reverseLookup.delete(node);
                                            if(DOMDataStore.DEBUG) {
                                                console.log("Updated cache for: ", node);
                                            }
                                        }
                                    });
                                });
                            });

                            this.observer.observe(this.parent, {
                                childList: true
                            });
                        }

                        querySelector(selector) {
                            let mark = VarvPerformance.start();
                            let cacheEntry = this.cache.get(selector);
                            if(cacheEntry != null) {
                                VarvPerformance.stop("DOMDataStore.querySelector.cached", mark);
                                return cacheEntry;
                            }

                            let result = this.parent.querySelector(selector);

                            if(result != null) {
                                this.cache.set(selector, result);
                                let selectors = this.reverseLookup.get(result);
                                if(selectors == null) {
                                    selectors = new Set();
                                    this.reverseLookup.set(result, selectors);
                                }
                                selectors.add(selector);
                            }

                            VarvPerformance.stop("DOMDataStore.querySelector.nonCached", mark);

                            return result;
                        }
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-dom-highlight" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv DOM Highlighting",
                        "description": "Allows applications like Cauldron to highlight concepts, properties and similar directly in the DOMView",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="DOMHighlight-script" type="disabled">
                    class DOMHighlighter {
                        constructor(){
                            let self = this;

                            let conceptHighlightCallback = EventSystem.registerEventCallback("Varv.DOMView.HighlightConcept", (evt)=>{
                                let concept = evt.detail;
                                self.getViews().forEach((view)=>{
                                    self.walkView(view, self.clearHighlight);
                                    self.walkView(view, function highlightConcept(node){
                                        for (let conceptBinding of DOMView.singleton.getConceptPath(node)){
                                            if (conceptBinding.concept===concept){
                                                self.highlight(node);
                                                return false; // Don't highlight into children
                                            }
                                        }
                                        return true;
                                    });
                                });
                            });

                            let instanceHighlightCallback = EventSystem.registerEventCallback("Varv.DOMView.HighlightInstance", (evt)=>{
                                let uuid = evt.detail;
                                self.getViews().forEach((view)=>{
                                    self.walkView(view, self.clearHighlight);
                                    self.walkView(view, function highlightInstance(node){
                                        for (let conceptBinding of DOMView.singleton.getConceptPath(node)){
                                            if (conceptBinding.uuid===uuid){
                                                self.highlight(node);
                                                return false; // Don't highlight into children
                                            }
                                        }
                                        return true;
                                    });
                                });
                            });

                            let propertyHighlightCallback = EventSystem.registerEventCallback("Varv.DOMView.HighlightProperty", (evt)=>{
                                let property = evt.detail;
                                self.getViews().forEach((view)=>{
                                    self.walkView(view, self.clearHighlight);
                                    self.walkView(view, function highlightProperty(node){
                                        for (let entry of DOMView.singleton.getPropertyPath(node)){
                                            if (entry.property===property){
                                                if (node.setAttribute){
                                                    node.setAttribute("varv-domview-highlight",true);
                                                }
                                                return false;
                                            }
                                        }
                                        return true;
                                    });
                                });
                            });

                            let clearHighlightCallback = EventSystem.registerEventCallback("Varv.DOMView.ClearHighlights", (evt)=>{
                                self.getViews().forEach((view)=>{
                                    self.walkView(view, self.clearHighlight);
                                });
                            });
                        }

                        getViews(){
                            return document.querySelectorAll("varv-view");
                        }

                        highlight(node){
                            if (node.setAttribute){
                                node.setAttribute("varv-domview-highlight",true);
                            }
                        }

                        clearHighlight(node){
                            if (node.getAttribute && node.getAttribute("varv-domview-highlight")){
                                node.removeAttribute("varv-domview-highlight");
                            }
                            return true;
                        }

                        walkView(view, nodeCallback){
                            let diveIntoChildren = nodeCallback(view);
                            if (diveIntoChildren){
                                for (let child of view.childNodes){
                                    this.walkView(child, nodeCallback);
                                }
                            }
                        }
                    }

                    window.DOMHighlighter = DOMHighlighter;
                    window.DOMHighlighter.singleton = new DOMHighlighter();

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-domdiff-view" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv DOMDiff View",
                        "description": "Allow data to be visualized as a high-performance browser-based UI based on DOM-diffing",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="UpdatingEvalutation-script" type="disabled">
                    class UpdatingEvaluation {
                        constructor(originalText, scope, onChangeCallback){
                            this.originalText = originalText;
                            this.replacements = new Map();
                            this.tokens = originalText.match(/{(.+?)}/g);
                            if (!this.tokens) this.tokens = [];
                            this.onChangeCallback = onChangeCallback;
                            this.updateCallbacks = [];
                            this.destroyed = false;

                            let self = this;

                            // Prepare it once manually
                            for(let token of this.tokens) {
                                token = token.trim();
                                let lookupQuery = token.substring(1, token.length - 1);

                                let replacement = {
                                    value: undefined,
                                    getText: null,
                                    binding: null,
                                    propertyName: null
                                };
                                if (lookupQuery.includes("?")){
                                    let regexp = /^(?<condition>.+?)\?(?<quote1>["']?)(?<true>.+?)\k<quote1>(?::(?<quote2>["']?)(?<false>.*)\k<quote2>)?$/gm;

                                    let match = regexp.exec(lookupQuery);

                                    replacement.propertyName = match.groups.condition;

                                    let negated = false;

                                    if(replacement.propertyName.startsWith("!")) {
                                        negated = true;
                                        replacement.propertyName = replacement.propertyName.substring(1);
                                    }

                                    // Fancy { x ? y : < } query
                                    binding = DOMView.getBindingFromScope(replacement.propertyName, scope);
                                    replacement.textFunction = ()=>{
                                        if (replacement.binding===undefined) return undefined;
                                        let trueValue = match.groups.true;
                                        let falseValue = typeof match.groups.false === "undefined"?"":match.groups.false;

                                        if(negated) {
                                            let tmp = trueValue;
                                            trueValue = falseValue;
                                            falseValue = tmp;
                                        }

                                        return replacement.value?trueValue:falseValue;
                                    };
                                } else {
                                    // Normal {} query, the entire thing is the name
                                    replacement.propertyName = lookupQuery;
                                    replacement.binding = DOMView.getBindingFromScope(replacement.propertyName, scope);
                                    replacement.textFunction = ()=>{
                                        return replacement.value;
                                    };
                                }
                                this.replacements.set(lookupQuery, replacement);
                            }

                            this.initialUpdate = true;
                            this.update();
                        }

                        async update(){
                            let self = this;
                            let mark = VarvPerformance.start();

                            // Get the initial values the first time
                            if (this.initialUpdate){
                                await Promise.all(Array.from(this.replacements.values()).map(async (replacement)=>{
                                    // Fetch initial value
                                    if (!replacement.binding) return;
                                    replacement.value = await replacement.binding.getValueFor(replacement.propertyName);

                                    // Listen for future updates, if supported by the binding
                                    if (replacement.binding.generateRawChangeListener){
                                        let changedCallback = replacement.binding.generateRawChangeListener(replacement.propertyName, replacement.value);
                                        changedCallback.onChanged = async function updateUpdatingStringEvaluation(value){
                                            replacement.value = value;
                                            await self.update();
                                        };
                                        this.updateCallbacks.push(changedCallback);
                                    };
                                }));

                                this.initialUpdate = false;
                            }

                            try {
                                let text = this.originalText;
                                for(let token of this.tokens) {
                                    token = token.trim();
                                    let lookupQuery = token.substring(1, token.length - 1);

                                    let value = this.replacements.get(lookupQuery).textFunction();
                                    if (value !== undefined){
                                        text = text.replace(token, value); // STUB: This can fail if the first token is replaced with something that looks like the second token
                                    }
                                }

                                await this.onChangeCallback(text);
                            } catch (ex){
                                console.error(ex);
                            }

                            VarvPerformance.stop("UpdatingStringEvaluation.update", mark);
                        }

                        destroy(){
                            if (this.destroyed) {
                                if (DOMView.DEBUG){
                                    console.warn("FIXME: Harmless double desctruction, ignoring - but try not to destroy me this much");
                                }
                                return;
                            }
                            for (let entry of this.updateCallbacks){
                                entry.destroy();
                            }
                            this.destroyed = true;
                        }
                    }

                    window.UpdatingEvaluation = UpdatingEvaluation;

                    </SCRIPT><SCRIPT id="ViewParticle-script" type="disabled">
                    /**
                     * A view particle mst
                     * @type type
                     */
                    class ViewParticle {
                        constructor(node, parseNode, scope){
                            this.node = node;
                            this.parseNode = parseNode;
                            this.mountCallbacks = [];
                            this.renderCallbacks = [];
                            this.cleanup = [];
                            this.scope = scope;
                            this.initialRender = false;
                            node.viewParticle = this;
                        }

                        getNode(){
                            // TODO: error node when null
                            return this.node;
                        }

                        getTargetDocument(){
                            let doc = this.node.ownerDocument;
                            if (!doc.createElement) console.log("Weird root node", this, this.node, doc, this.parseNode, this.scope);
                            return doc;
                        }

                        addCleanup(callback){
                            this.cleanup.push(callback);
                        }

                        addOnMountedCallback(callback){
                            this.mountCallbacks.push(callback);
                        }

                        addOnRenderedCallback(callback){
                            this.renderCallbacks.push(callback);
                        }

                        mountInto(parentElement, insertBeforeNode=null){
                            parentElement.insertBefore(this.node, insertBeforeNode);
                            this.mountCallbacks.forEach((callback)=>{
                                callback();
                            });
                        }

                        onRendered(){
                            this.initialRender = true;
                            this.renderCallbacks.forEach((callback)=>{
                                callback();
                            });
                        }

                        hasRendered(){
                            return this.initialRender;
                        }

                        destroy(){
                            if (DOMView.DEBUG) console.log("Destroying particle ",this);
                            this.cleanup.forEach((callback)=>{
                                callback();
                            });
                            this.node.remove();
                        }
                    }

                    window.ViewParticle = ViewParticle;

                    </SCRIPT><SCRIPT id="ParseNode-script" type="disabled">
                    class ParseNode {
                        constructor(templateElement){
                            this.children = [];
                            this.cleanupCallbacks = [];
                            this.templateElement = templateElement;

                            if (DOMView.DEBUG){
                                console.log("adding ", templateElement);
                            }
                        }

                        parseTemplateNode(elementNode, parseOptions={}){
                            switch (elementNode.nodeType){
                                // Nodes that cannot have attributes are treated directly
                                case Node.COMMENT_NODE:
                                    // Drop all comments to minify view as much as possible - we cannot update them properly anyways
                                    return null;
                                case Node.TEXT_NODE:
                                    return new TextParseNode(elementNode);

                                // Nodes that may have attributes are handled below
                                case Node.ELEMENT_NODE:
                                    break;

                                // Unknown nodes are copied verbatim
                                default:
                                    return new YotaParseNode(elementNode);
                            }

                            // Handle filtering/duplication attributes before anything else (may need duplication)
                            if (!parseOptions.skipQuery){
                                const atts = elementNode.attributes;
                                if (atts && (atts["concept"] || atts["property"] || atts["if"])){
                                    // These are not valid on varv-template element
                                    if (elementNode==="VARV-TEMPLATE") {
                                        console.log("concept, property or if used on varv-template element itself is invalid");
                                    }
                                    return new QueryParseNode(elementNode);
                                }
                            }

                            // Handle HTML elements
                            switch (elementNode.tagName){
                                case "VARV-TEMPLATE":
                                    // Not used in output
                                    return null;
                                case "TEMPLATE-REF":
                                    return new TemplateRefParseNode(elementNode);
                                default:
                                    return new ElementParseNode(elementNode);
                            }
                        }

                        getErrorView(targetDocument, scope, error, ex=null){
                            console.log("DOMView runtime error", error, ex, scope, this.templateElement, this);

                            let element = targetDocument.createElement("varv-failure");
                            element.setAttribute("title", error + "\n" + ex);

                            return new ViewParticle(element, this, scope);
                        }
                    }

                    window.ParseNode = ParseNode;

                    </SCRIPT><SCRIPT id="YotaParseNode-script" type="disabled">
                    class YotaParseNode extends ParseNode {
                        getView(targetDocument, scope){
                            if (DOMView.DEBUG) console.log("instantiating yota", this.templateElement);

                            return new ViewParticle(targetDocument.importNode(this.templateElement,false), this, scope);
                        }
                    };

                    window.YotaParseNode = YotaParseNode;

                    </SCRIPT><SCRIPT id="TextParseNode-script" type="disabled">
                    class TextParseNode extends ParseNode {
                        getView(targetDocument, scope){
                            if (DOMView.DEBUG) console.log("instantiating text", this.templateElement);

                            let textNode = targetDocument.createTextNode("");
                            let view = new ViewParticle(textNode, this, scope);
                            view.updatingEvaluation = new UpdatingEvaluation(this.templateElement.nodeValue, scope, function textNodeUpdated(text){
                                textNode.nodeValue = text;
                            });
                            view.addCleanup(()=>{
                                view.updatingEvaluation.destroy();
                            });

                            return view;
                        }
                    };

                    window.TextParseNode = TextParseNode;

                    </SCRIPT><SCRIPT id="ScopedParseNode-script" type="disabled">
                    class ScopedParseNode extends ParseNode {
                        constructor(templateElement){
                            super(templateElement);
                        }

                        getView(targetDocument, scope){
                            if (DOMView.DEBUG) console.log("instantiating scopedparsenode abstract view for ", this.templateElement);
                            let self = this;
                            let view = new ViewParticle(targetDocument.createProcessingInstruction("varv-scope-anchor", {}), this, scope);
                            view.topGuardElement = view.getTargetDocument().createProcessingInstruction("varv-scope-topguard", {});
                            view.childViews = [];
                            this.generateScopes(view);

                            view.addOnMountedCallback(()=>{
                                // Plain move everything to new parent
                                view.getNode().parentElement.insertBefore(view.topGuardElement, view.getNode());
                                view.childViews.forEach((childView)=>{
                                    // Insert them before our anchor node
                                    childView.mountInto(view.getNode().parentElement, view.getNode());
                                });
                            });
                            view.addCleanup(()=>{
                                // Empty the view
                                self.onScopesUpdated(view, []);
                            });
                            return view;
                        }

                        onScopesUpdated(view, newChildScopes){
                            // Destroy views that are no longer in the new child scopes
                            let self = this;
                            let changes = 0;

                            // Add new views for newly added scopes while reordering
                            if (DOMView.DEBUG) console.log("Updating view scope, old=>new",view.childViews, newChildScopes);
                            let oldChildViews = view.childViews;
                            view.childViews = [];
                            newChildScopes.forEach((newChildScope)=>{
                                let existingView = false;
                                oldChildViews.forEach((childView)=>{
                                    if (ScopedParseNode.fastDeepEqual(childView.localScope,newChildScope)) existingView = childView;
                                });
                                if (existingView){
                                    oldChildViews.splice(oldChildViews.indexOf(existingView),1);
                                    view.childViews.push(existingView);
                                } else {
                                    view.childViews.push(()=>{
                                        /**
                                         * Very specific performance optimization:
                                         * TODO: If the only change in the scope is a PropertyArrayEntryBinding index on the top of the scope stack
                                         * we can migrate the view by performing binding updates instead of destroying it and recreating it here.
                                         * This happens often when reordering list entries.
                                         */
                                        let newLastOfScope = newChildScope[newChildScope.length-1];
                                        if (newLastOfScope instanceof PropertyArrayEntryBinding){
                                            for (let oldChildView of oldChildViews){
                                                let oldLastOfScope = oldChildView.localScope[oldChildView.localScope.length-1];
                                                if (oldLastOfScope instanceof PropertyArrayEntryBinding){
                                                    if (oldLastOfScope.identicalExceptIndex(newLastOfScope)){
                                                        // Identical tops (except index), compare rest of their localScope
                                                        if (DOMView.DEBUG || DOMView.DEBUG_PERFORMANCE) console.log("Could optimize maybe", newChildScope, oldChildView.localScope);
                                                        if (ScopedParseNode.fastDeepEqual(newChildScope.slice(0,-1),oldChildView.localScope.slice(0,-1))){
                                                            if (DOMView.DEBUG || DOMView.DEBUG_PERFORMANCE) console.log("Optimized",oldChildView);
                                                            oldChildViews.splice(oldChildViews.indexOf(oldChildView),1);
                                                            oldLastOfScope.updateIndex(newLastOfScope.index);
                                                            return oldChildView;
                                                        }
                                                    }
                                                }
                                            };
                                        }
                                        // /very specific performance optimization

                                        // Couldn't recover anything, just create a new view
                                        let childView;
                                        if (newLastOfScope instanceof RuntimeExceptionBinding){
                                            childView = self.getErrorView(view.getTargetDocument(), [...view.scope, ...newChildScope], newLastOfScope.errorMessage, newLastOfScope.ex);
                                        } else {
                                            childView = self.children[0].getView(view.getTargetDocument(),[...view.scope, ...newChildScope]);
                                        }
                                        changes++;
                                        childView.localScope = newChildScope;
                                        return childView;
                                    });
                                }
                            });

                            // Run optimizing functions
                            view.childViews = view.childViews.map((value)=>{
                                if (typeof(value)==="function") return value();
                                return value;
                            });

                            for (let i = oldChildViews.length-1; i>=0; i--){
                                let found = false;
                                view.childViews.forEach((childView)=>{
                                    if (childView===oldChildViews[i]) found = true;
                                });
                                if (!found){
                                    oldChildViews[i].destroy();
                                    oldChildViews.splice(i,1);
                                    changes++;
                                }
                            }
                            if (oldChildViews.length!==0) console.log("FIXME: DOMView oldChildViews postcondition inconsistency detected: 0!="+oldChildViews.length,oldChildViews);

                            if ((DOMView.DEBUG||DOMView.DEBUG_PERFORMANCE) && changes===0 && newChildScopes.length>0){
                                try {
                                    console.log("FIXME: DOMDiffView: Potential performance optimization for ScopedParseNode. onScopesUpdated() called but returned no change in scope",this);
                                    throw new Error("stacktrace");
                                } catch (ex) {
                                    console.log(ex);
                                }
                            }

                            this.stubResetView(view);
                        }

                        stubResetView(view){
                            if (view.getNode().parentNode === null) return; // Not in any document yet

                            let parent = view.getNode().parentNode;
                            let viewCount = view.childViews.length;

                            for (let i = 0; i < viewCount; i++){
                                if (DOMView.DEBUG) console.log("Validating view", view.childViews[i]);
                                let alreadyMountedCorrectly = true;

                                // A view is mounted correctly if it is mounted here and no view that is supposed to be later is mounted before it
                                if (view.childViews[i].getNode().parentElement!==parent){
                                    alreadyMountedCorrectly = false;
                                }
                                let anchorIndex = [...parent.childNodes].indexOf(view.childViews[i].getNode());
                                if (i!==viewCount-1){
                                    for (let o = i+1; o < viewCount; o++){
                                        let thisIndex = [...parent.childNodes].indexOf(view.childViews[o].getNode());
                                        if (thisIndex < anchorIndex && view.childViews[o].getNode().parentElement===parent) {
                                            console.log("Wrong location, found",anchorIndex, thisIndex,view.childViews[o].getNode());

                                            alreadyMountedCorrectly = false;
                                            break;
                                        }
                                    }
                                }

                                // If not mounted correctly, mount after previous view (or top guard if first view)
                                if (!alreadyMountedCorrectly){
                                    let mountAfter = view.topGuardElement;
                                    if (i!==0){
                                        mountAfter = view.childViews[i-1].getNode();
                                    }
                                    view.childViews[i].mountInto(view.getNode().parentElement, mountAfter.nextSibling);
                                }
                            }

                            view.onRendered();
                        }

                        showError(view, message, ex){
                            console.log(ex);
                            this.onScopesUpdated(view, []);
                            view.childViews.push(this.getErrorView(view.getTargetDocument(), view.scope, message, ex));
                            this.stubResetView(view);
                        }

                        static fastDeepEqual(a,b){
                            if (a === b) return true;

                            if (a && b && typeof a == 'object' && typeof b == 'object') {
                              if (a.constructor !== b.constructor) return false;

                              var length, i, keys;
                              if (Array.isArray(a)) {
                                length = a.length;
                                if (length != b.length) return false;
                                for (i = length; i-- !== 0;)
                                  if (!ScopedParseNode.fastDeepEqual(a[i], b[i])) return false;
                                return true;
                              }

                              if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;
                              if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();
                              if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();

                              keys = Object.keys(a);
                              length = keys.length;
                              if (length !== Object.keys(b).length) return false;

                              for (i = length; i-- !== 0;)
                                if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;

                              for (i = length; i-- !== 0;) {
                                var key = keys[i];
                                if (key.startsWith("_")) continue;
                                if (!ScopedParseNode.fastDeepEqual(a[key], b[key])) return false;
                              }

                              return true;
                            }

                            if(typeof a === "function" && typeof b === "function") {
                                return true;
                            }

                            // true if both NaN, false otherwise
                            return a!==a && b!==b;

                        };
                    };

                    window.ScopedParseNode = ScopedParseNode;

                    </SCRIPT><SCRIPT id="TemplateRefParseNode-script" type="disabled">
                    class TemplateRefParseNode extends ScopedParseNode {
                        constructor(templateElement){
                            super(templateElement);
                            this.children.push(new TemplateInstanceParseNode(templateElement));
                        }

                        getView(targetDocument, scope){
                            if (DOMView.DEBUG) console.log("instantiating template-ref for ", this.templateElement);
                            return super.getView(targetDocument, scope);
                        }

                        // Look at the TEMPLATE-NAME attribute and generate our scope(s)
                        generateScopes(view){
                            let self = this;
                            let templateQuery = this.templateElement.getAttribute("template-name");
                            let templateHookType = this.templateElement.getAttribute("template-hook");
                            if ((templateQuery!==null) && templateQuery.trim().length>0){
                                // Need to monitor a list of templates
                                view.templateUpdatingEvaluation = new UpdatingEvaluation(templateQuery, view.scope, async function templateNameAttributeChanged(templateName){
                                    try {
                                        // Find the template and create corresponding scopes
                                        let templates = document.querySelectorAll("varv-template[name='" + templateName+"']");
                                        let localScopes = [];

                                        if (templates.length===0) throw new Error("Template with name '"+templateName+"' does not exist (yet?)");
                                        switch (templateHookType){
                                            case "all":
                                                templates.forEach((template)=>{
                                                    localScopes.push([new TemplateBinding(template)]);
                                                });
                                                break;
                                            case "first":
                                                localScopes.push([new TemplateBinding(templates[0])]);
                                                break;
                                            case "last":
                                            default:
                                                localScopes.push([new TemplateBinding(templates[templates.length - 1])]);
                                        }

                                        self.onScopesUpdated(view, localScopes);
                                    } catch (ex){
                                        self.showError(view, "Template-ref='"+templateQuery+"': "+ex, ex);
                                        return;
                                    }
                                });
                                view.addCleanup(()=>{
                                    view.templateUpdatingEvaluation.destroy();
                                });
                            }
                        }
                    }
                    window.TemplateRefParseNode = TemplateRefParseNode;

                    /**
                     * A node that dynamically parses and renders a template from the scope all during getView rather than construction
                     * @type type
                     */
                    class TemplateInstanceParseNode extends ParseNode {
                        getView(targetDocument, scope){
                            let templateBinding = scope[scope.length-1];
                            if (!templateBinding instanceof TemplateBinding) throw new Error("STUB: Currently TemplateBinding MUST be the last element on the scope stack when rendering template instances");

                            // Dynamically parse and render the template now
                            let referencedTemplateElement = templateBinding.getTemplateElement()
                            if (DOMView.DEBUG) console.log("parsing template-instance for ", this.templateElement, referencedTemplateElement);
                            let view = new ViewParticle(targetDocument.createProcessingInstruction("varv-template-anchor", {}), this, scope);
                            let parseNodes = [];
                            for (let childNode of referencedTemplateElement.childNodes){
                                let parseChild = this.parseTemplateNode(childNode);
                                if (parseChild){
                                    // If this actually needs parsing, add it
                                    parseNodes.push(parseChild);
                                }
                            }

                            if (DOMView.DEBUG) console.log("creating template-instance view for ", view, parseNodes);
                            view.childViews = [];
                            parseNodes.forEach((parseChild)=>{
                                view.childViews.push(parseChild.getView(targetDocument, scope));
                            });

                            // Also destroy the template view children when our view is destroyed
                            view.addCleanup(()=>{
                                view.childViews.forEach((childView)=>{
                                    childView.destroy();
                                });
                            });

                            // When we are mounted into the document, think about the children!
                            view.addOnMountedCallback(()=>{
                                view.childViews.forEach((childView)=>{
                                    // Insert them before our anchor node
                                    childView.mountInto(view.getNode().parentNode, view.getNode());
                                });
                            });

                            return view;
                        }
                    };
                    window.TemplateInstanceParseNode = TemplateInstanceParseNode;

                    </SCRIPT><SCRIPT id="QueryParseNode-script" type="disabled">
                    class QueryParseNode extends ScopedParseNode {
                        constructor(templateElement){
                            super(templateElement);

                            // We are our own only child
                            this.children.push(this.parseTemplateNode(templateElement, {
                                skipQuery: true
                            }));
                        }

                        getView(targetDocument, scope){
                            if (DOMView.DEBUG) console.log("instantiating query for ", this.templateElement);
                            let view = super.getView(targetDocument, scope);
                            view.addCleanup(()=>{
                                // Change callbacks
                                view.conceptAppearedCallback?.delete();
                                view.conceptDisappearedCallback?.delete();

                                // Attribute evaluators
                                view.conceptUpdatingEvaluation?.destroy();
                                view.targetUpdatingEvaluation?.destroy();
                                view.propertyUpdatingEvaluation?.destroy();
                                view.conditionalUpdatingEvaluation?.destroy();
                            });
                            return view;
                        }

                        generateScopes(view){
                            view.propertyChangedCallbacks = [];
                            this.generateConceptScopes(view);
                        }

                        // Look at the CONCEPT and TARGET attributes and generate some scopes
                        generateConceptScopes(view){
                            let self = this;
                            let conceptQuery = this.templateElement.getAttribute("concept");
                            let targetQuery = this.templateElement.getAttribute("target");

                            let conceptTargetAttributesUpdated = async function conceptTargetAttributesUpdated(conceptName){
                                try {
                                    // Clean up any previous appeared/disappeared callbacks
                                    view.conceptAppearedCallback?.delete();
                                    view.conceptDisappearedCallback?.delete();

                                    // Concept enumeration queries
                                    let doConceptEnumeration = async function doConceptEnumerationForScopes(){
                                        // TODO: possibly filter for performance
                                        if (DOMView.DEBUG){
                                            if (self.templateElement.getAttribute("property")) console.log("FIXME: DOMView concept='' enumerations combined with property='' lookups on same element can be optimized further, use filters here");
                                            if (self.templateElement.getAttribute("if")) console.log("FIXME: DOMView concept='' enumerations combined with if='' can sometimes be optimized further, use filters here");
                                        }
                                        let instances = await VarvEngine.lookupInstances(VarvEngine.getAllImplementingConceptNames(conceptName)); // TODO: Fancy filtering opportunity here

                                        // Merge with any target query
                                        if (targetQuery && !instances.includes(targetQuery)){
                                            instances.push(targetQuery);
                                        }
                                        let localScopes = await Promise.all(instances.map(async function lookupConcreteTypes(uuid){
                                            let concreteConcept = await VarvEngine.getConceptFromUUID(uuid);
                                            return [new ConceptInstanceBinding(concreteConcept, uuid)];
                                        }));
                                        self.generatePropertyScopes(view, localScopes);
                                    };

                                    // Populate the scope
                                    await doConceptEnumeration();
                                    let refreshTimer;
                                    view.conceptAppearedCallback = VarvEngine.registerEventCallback("appeared", async (evt) => {
                                        if (evt.concept.isA(conceptName)){
                                            clearTimeout(refreshTimer);
                                            refreshTimer = setTimeout(()=>{
                                                doConceptEnumeration();
                                            },0);
                                        }
                                    });
                                    view.conceptDisappearedCallback = VarvEngine.registerEventCallback("disappeared", async (evt) => {
                                        if (evt.concept.isA(conceptName)){
                                            clearTimeout(refreshTimer);
                                            refreshTimer = setTimeout(()=>{
                                                doConceptEnumeration();
                                            },0);
                                        }
                                    });
                                } catch (ex){
                                    self.showError(view, "Evaluating concept='"+conceptQuery+"': "+ex, ex);
                                    return;
                                }
                            };

                            let emptyQuery = true;

                            if ((conceptQuery!==null) && conceptQuery.trim().length>0){
                                // Need to monitor a list of concept instances
                                view.conceptUpdatingEvaluation = new UpdatingEvaluation(conceptQuery, view.scope, conceptTargetAttributesUpdated);
                                emptyQuery = false;
                                // TODO: also run the above for concept added callbacks
                            }
                            if ((targetQuery!==null) && targetQuery.trim().length>0){
                                // Need to monitor a list of concept instances
                                view.targetUpdatingEvaluation = new UpdatingEvaluation(targetQuery, view.scope, conceptTargetAttributesUpdated);
                                emptyQuery = false;
                                // TODO: also run the above for concept added callbacks
                            }

                            if (emptyQuery){
                                // We can skip straight to property with just the view scope
                                self.generatePropertyScopes(view, [[]]);
                            }
                        }

                        // Look at the PROPERTY attribute and generate additional scopes for each given local scope
                        generatePropertyScopes(view, localScopes){
                            let self = this;

                            // Clean potential previous evaluation of property-args so it stops updating
                            if (view.propertyUpdatingEvaluation) {
                                view.propertyUpdatingEvaluation.destroy();
                                view.propertyUpdatingEvaluation = null;
                            }

                            let finalFiltering = function finalFiltering(scopeMap){
                                // Concat the results into one big array and ship it to the UI
                                let scopeCollection = [];
                                scopeMap.forEach((subscopes)=>{
                                    subscopes.forEach((actualScope)=>{
                                        scopeCollection.push(actualScope);
                                    });
                                });
                                self.generateConditionalScopes(view, scopeCollection);
                            };

                            // Look at property attribute
                            let propertyQuery = this.templateElement.getAttribute("property");
                            if ((propertyQuery!==null) && propertyQuery.trim().length>0){
                                if (DOMView.DEBUG) console.log("Generating property scopes...");

                                // Monitor property attribute for changes
                                view.propertyUpdatingEvaluation = new UpdatingEvaluation(propertyQuery, view.scope, async function propertyAttributeUpdated(property){
                                    // Clean up previous callbacks
                                    view.propertyChangedCallbacks.forEach((callback)=>{
                                        callback.destroy();
                                    });

                                    // Find the new properties for each existing scope
                                    if (DOMView.DEBUG) console.log("Property attribute value is now", property);
                                    if (property === undefined) throw new Error("Cannot render property '"+propertyQuery+"' which evaluates to undefined");
                                    try {
                                        // Insert localScopes in the right order
                                        let scopeMap = new Map(localScopes.map((localScope)=>{
                                            return [localScope, []];
                                        }));

                                        // Calculate all the initial derived scopes in parallel
                                        await Promise.all(localScopes.map(async function expandPropertyScope(localScope){
                                            // Sanity checks
                                            let binding = await DOMView.getBindingFromScope(property, [...view.scope, ...localScope]);
                                            if (!binding) throw new Error("Selecting undefined property '"+property+"' not found in scope");
                                            if (!(binding instanceof ConceptInstanceBinding)) throw new Error("Property='"+propertyQuery+"' (currently '"+property+"') must be a property on a concept");

                                            // Find the new scopes from a value
                                            let engineProperty = binding.getProperty(property);
                                            let valueToScopes = async function propertyValueToScopes(propertyValue){
                                                try {
                                                    if (DOMView.DEBUG) console.log("Property value is", propertyValue);
                                                    let as = self.templateElement.getAttribute("as");
                                                    if (propertyValue !== null && propertyValue !== undefined && propertyValue!=="") {
                                                        if (engineProperty.getType()==="array") {
                                                            // We need to map the array into additional childscopes with arrayentry bindings
                                                            scopeMap.set(localScope, await Promise.all(propertyValue.map(async (arrayEntry, index, inArray)=>{
                                                                let newScope = [...localScope];
                                                                if (engineProperty.isConceptArrayType()) {
                                                                    newScope.push(new ConceptInstanceBinding(await VarvEngine.getConceptFromUUID(arrayEntry),arrayEntry));
                                                                }
                                                                newScope.push(new PropertyArrayEntryBinding(engineProperty, binding.uuid, arrayEntry, index, inArray.length, as));
                                                                return newScope;
                                                            })));
                                                        } else {
                                                            // Single property value, no duplication
                                                            if (!engineProperty.isConceptType()) throw new Error("Cannot use a type for the property attribute that is not a list of references, a list of simple values or a single concept reference: "+propertyValue+" ("+engineProperty.type+")");
                                                            scopeMap.set(localScope,[[
                                                                ...localScope,
                                                                new ConceptInstanceBinding(await VarvEngine.getConceptFromUUID(propertyValue),propertyValue),
                                                                new PropertyBinding(engineProperty, binding.uuid, propertyValue, as)
                                                            ]]);
                                                        }
                                                    } else {
                                                        scopeMap.set(localScope,[]); // Empty scope
                                                    }
                                                } catch (ex){
                                                    scopeMap.set(localScope, [[new RuntimeExceptionBinding("Converting property value to scopes failed",ex)]]);
                                                }
                                            };

                                            // Initial setup
                                            let initialValue = await binding.getValueFor(property);
                                            await valueToScopes(initialValue);

                                            // Listen for changes in the looked up property and update the scopes if changed
                                            if (binding.generateRawChangeListener){
                                                let changedCallback = binding.generateRawChangeListener(property,initialValue);
                                                changedCallback.onChanged = async function queryParseNodePropertyChanged(value){
                                                    // Update the scopeMap with the new value
                                                    await valueToScopes(value);
                                                    finalFiltering(scopeMap);
                                                };
                                                view.propertyChangedCallbacks.push(changedCallback);
                                            };
                                        }));

                                        finalFiltering(scopeMap);
                                    } catch (ex){
                                            self.showError(view, "Evaluating property='"+propertyQuery+"': "+ex, ex);
                                            return;
                                    }

                                });
                            } else {
                                // Skip straight to conditionals with the given local scopes
                                self.generateConditionalScopes(view, localScopes);
                            }
                        }

                        // Look at IF attribute and remove local scopes that do not fit
                        generateConditionalScopes(view, localScopes){
                            let self = this;

                            // Clean potential previous evaluation of if-args so it stops updating
                            if (view.conditionalPropertyUpdateListeners){
                                view.conditionalPropertyUpdateListeners.forEach((listener)=>{
                                    listener.destroy();
                                });
                            }
                            view.conditionalPropertyUpdateListeners = [];
                            if (view.conditionalUpdatingEvaluation) {
                                view.conditionalUpdatingEvaluation.destroy();
                                view.conditionalUpdatingEvaluation = null;
                            }

                            // Look at the attribute
                            let conditionalQuery = this.templateElement.getAttribute("if");
                            if ((conditionalQuery!==null) && conditionalQuery.trim().length>0){
                                // Monitor the if-condition for changes
                                view.conditionalUpdatingEvaluation = new UpdatingEvaluation(conditionalQuery, view.scope, async function conditionalAttributeUpdated(condition){
                                    if (DOMView.DEBUG) console.log("If changed: ", condition);
                                    try {
                                        // Configure the if-test
                                        let negate = false;
                                        let isTestingInstanceOf = false;
                                        let testType;
                                        let conditionSource = condition;
                                        if(condition.startsWith("!")){
                                            conditionSource = condition.substring(1);
                                            negate = true;
                                        }
                                        if (conditionSource.includes("concept ")){ // Instance-of if
                                            isTestingInstanceOf = true;

                                            testType = conditionSource.substring(conditionSource.indexOf("concept ")+8);
                                            conditionSource = conditionSource.replace("concept "+testType, "").trim();
                                            if (conditionSource.length === 0){
                                                conditionSource = "concept::uuid"; // Use most recently bound concept
                                            }
                                        }

                                        // Insert localScopes in the right order
                                        let scopeMap = new Map(localScopes.map((localScope)=>{
                                            return [localScope, []];
                                        }));

                                        let onConditionalUpdateCompleted = function onConditionalUpdateCompleted(){
                                            // Flatten results to list
                                            let includedScopes = [];
                                            scopeMap.forEach((value,key)=>{
                                                if (value) includedScopes.push(key);
                                            });

                                            // Send to UI
                                            self.onScopesUpdated(view, includedScopes);
                                        };

                                        // Perform the conditional test
                                        await Promise.all(localScopes.map(async function applyConditional(localScope){
                                            // Sanity checks
                                            if (localScope.length>0 && (localScope[localScope.length-1] instanceof RuntimeExceptionBinding)){
                                                // Pass thru exceptions always, no if-ing
                                                console.log("Passing thru error",localScope);
                                                scopeMap.set(localScope, true);
                                                return;
                                            }
                                            let binding = await DOMView.getBindingFromScope(conditionSource, [...view.scope, ...localScope]);
                                            if (!binding) throw new Error("if='"+condition+"' selecting boolean '"+conditionSource+"' not bound in scope");
                                            let evaluateConditional = async function evaluateConditional(value){
                                                // Actual test
                                                let conditionalValue = false;
                                                try {
                                                    if (isTestingInstanceOf){
                                                        // This check must be against a uuid, look it up
                                                        let testTarget = await VarvEngine.getConceptFromUUID(value);
                                                        conditionalValue = testTarget.isA(testType);
                                                    } else {
                                                        conditionalValue = value;
                                                    }
                                                    if(negate) {
                                                        conditionalValue = !conditionalValue;
                                                    }
                                                } catch (ex){
                                                    console.warn(ex);
                                                }
                                                scopeMap.set(localScope, conditionalValue);

                                            };

                                            let initialValue = await binding.getValueFor(conditionSource);
                                            evaluateConditional(initialValue);

                                            // Listen for changes in the looked up value and update this subscope if changed
                                            if (binding.generateRawChangeListener){
                                                let changedCallback = binding.generateRawChangeListener(conditionSource, initialValue);
                                                changedCallback.onChanged = async function queryParseNodePropertyChanged(value){
                                                    // Update the scopeMap with the new value
                                                    await evaluateConditional(value);
                                                    onConditionalUpdateCompleted();
                                                };
                                                view.conditionalPropertyUpdateListeners.push(changedCallback);
                                            };
                                        }));

                                        onConditionalUpdateCompleted();
                                    } catch (ex){
                                        self.showError(view, "Evaluating if='"+conditionalQuery+"': "+ex, ex);
                                        return;
                                    }
                                });
                            } else {
                                // When there is no 'if=', all local scopes survive directly
                                this.onScopesUpdated(view, localScopes);
                            }
                        }
                    };

                    window.QueryParseNode = QueryParseNode;

                    </SCRIPT><SCRIPT id="ElementParseNode-script" type="disabled">
                    class ElementParseNode extends ParseNode {
                        constructor(templateElement){
                            super(templateElement);

                            // Parse the children
                            for (let childNode of templateElement.childNodes){
                                let parseChild = this.parseTemplateNode(childNode);
                                if (parseChild){
                                    // If this actually needs parsing, add it
                                    this.children.push(parseChild);
                                }
                            }
                        }

                        getView(targetDocument, scope){
                            let self = this;
                            if (DOMView.DEBUG) console.log("instantiating element", this.templateElement);

                            // Create the element itself
                            let name = this.templateElement.tagName;
                            let namespace = this.templateElement.namespaceURI;
                            if (name==="DOM-VIEW-TEMPLATE") name = "varv-view"; // The template itself renames to view
                            let element;
                            if (namespace.endsWith("html")){
                                element = targetDocument.createElement(name);
                            } else {
                                element = targetDocument.createElementNS(namespace, name);
                            }
                            let view = new ViewParticle(element, this, scope);
                            element.scope = scope;
                            element.templateElement = this.templateElement;
                            element.parseNode = this;

                            // Attach the children
                            view.childViews = [];
                            for (let child of this.children){
                                let childView = child.getView(targetDocument, scope);
                                view.childViews.push(childView);
                                childView.mountInto(element);
                            }

                            // Evaluate all attributes
                            for(let attr of Array.from(this.templateElement.attributes)) {
                                // Filtering attributes are ignored
                                if (attr.name==="concept" || attr.name==="property" || attr.name==="if") continue;

                                // Selects are a bit special, they depend on their children being present in order to set value
                                if (self.templateElement.tagName==="SELECT" && attr.name==="value"){
                                    let selectUpdater = function selectChildrenOptionsChanged(){
                                        element.value = element.varvValue;
                                    };
                                    view.childViews.forEach((childView)=>{
                                        childView.addOnRenderedCallback(()=>{
                                            setTimeout(selectUpdater,0);
                                        });
                                    });
                                }

                                // The rest are evaluated
                                let updatingEvaluation = new UpdatingEvaluation(attr.value, scope, function attributeNodeUpdated(value){
                                    let shouldUpdateAttribute = true;

                                    // Check for special attributes
                                    if (attr.name==="value"){
                                        switch (element.tagName){
                                            case "INPUT":
                                                shouldUpdateAttribute = false;
                                                if (self.templateElement.type==="checkbox"){
                                                    element.checked = value==="true" || value===true;
                                                } else {
                                                    element.value = value;
                                                }
                                                break;
                                            case "TEXTAREA":
                                                shouldUpdateAttribute = false;
                                                element.value = value;
                                                break;
                                            case "SELECT":
                                                // Update when children option render properly
                                                shouldUpdateAttribute = false;
                                                element.value = value;
                                                element.varvValue = value;
                                                break;
                                            case "DIV":
                                                shouldUpdateAttribute = false;
                                                if (!element.blockReadbacks){
                                                    element.innerHTML = value;
                                                }
                                                break;
                                        }
                                    } else if(attr.name === "disabled" && value === "false") {
                                        // Don't move disabled=false over
                                        shouldUpdateAttribute = false;
                                        element.removeAttribute(attr.name);
                                    }
                                    if (shouldUpdateAttribute){
                                        element.setAttribute(attr.name, value);
                                    }
                                });
                                view.addCleanup(()=>{
                                    updatingEvaluation.destroy();
                                });
                            }
                            this.addAttributeWriteBacks(element, scope);

                            // Also kill all the children if we get killed
                            view.addCleanup(()=>{
                                view.childViews.forEach((childView)=>{
                                    childView.destroy();
                                });
                            });
                            return view;
                        }

                        addAttributeWriteBacks(element, scope){
                            // Check for special elements that can push data back to the concepts
                            if (element.tagName==="INPUT" || element.tagName==="TEXTAREA"){
                                let writeBack = this.getAttributeWriteBack(this.templateElement.getAttribute("value"), scope);
                                if (writeBack!==null){
                                    element.addEventListener("input", ()=>{
                                        writeBack.set(element.getAttribute("type")==="checkbox"?element.checked:element.value);
                                    });
                                }
                            } else if (element.tagName==="SELECT"){
                                let writeBack = this.getAttributeWriteBack(this.templateElement.getAttribute("value"), scope);
                                if (writeBack!==null){
                                    element.addEventListener("input", ()=>{
                                        writeBack.set(element.value);
                                    });
                                }
                            } else if (element.tagName==="DIV" && element.getAttribute("contenteditable")!==null){
                                let writeBack = this.getAttributeWriteBack(this.templateElement.getAttribute("value"), scope);
                                if (writeBack!==null){
                                    let coalesceTimer = null;
                                    let needsAnotherUpdate = false;
                                    element.addEventListener("input", async ()=>{
                                        needsAnotherUpdate = true;
                                        if (!coalesceTimer){
                                            coalesceTimer = setTimeout(async ()=>{
                                                while (needsAnotherUpdate){
                                                    needsAnotherUpdate = false;
                                                    element.blockReadbacks = true; // Avoid reading our own changes back
                                                    await writeBack.set(element.innerHTML);
                                                    element.blockReadbacks = false;
                                                }
                                                coalesceTimer = null;
                                            }, 100);
                                        }
                                    });
                                }
                            }
                        }


                        /**
                         * Some attributes, like input.value, can bind to simple writebacks "{someProperty}" that are looked up in scope.
                         * @returns {binding} A binding if it exists in scope or null
                         */
                        getAttributeWriteBack(rawAttributeValue, scope){
                            if (rawAttributeValue===undefined || rawAttributeValue===null) return null; // Not set
                            if (!(rawAttributeValue.startsWith("{") && rawAttributeValue.endsWith("}"))) return null; // Not a dynamic binding at all

                            let valueLookupName = rawAttributeValue.substring(1, rawAttributeValue.length - 1);
                            let binding = DOMView.getBindingFromScope(valueLookupName,scope);
                            if (!(binding instanceof ConceptInstanceBinding)){
                                console.warn("DOMDiffView: Writeback attribute resolves to something that is not a writable property on a concept, assuming read-only", rawAttributeValue);
                                return null;
                            } else {
                                return {
                                    set: async function attributeWriteBack(value){
                                        await binding.setValueFor(valueLookupName, value);
                                    }
                                };
                            }
                        }

                    }

                    window.ElementParseNode = ElementParseNode;

                    </SCRIPT><SCRIPT id="RootParseNode-script" type="disabled">
                    class RootParseNode extends ElementParseNode {
                        render(){
                            // Find the target document
                            let targetFrameSpec = this.templateElement.getAttribute("target-iframe");
                            let targetDocument;
                            if (targetFrameSpec){
                                let frame = document.querySelector(targetFrameSpec);
                                if (!frame) throw new Error("DOMDiffView: dom-view-template with target-iframe that does not exist in document failed to render", targetFrameSpec, templateElement);
                                targetDocument = frame.contentDocument;
                            } else {
                                targetDocument = document;
                            }

                            // Construct the view
                            let scope = [new TemplateBinding(this.templateElement)];
                            let view = this.getView(targetDocument, scope);

                            // Find the target element
                            let targetSpec = this.templateElement.getAttribute("target-element");
                            if (targetFrameSpec){
                                // Rendering to an iframe
                                if (targetSpec){
                                    // This template uses a custom render target element, try to find it
                                    let targetElement = targetDocument.querySelector(targetSpec);
                                    if (targetElement){
                                        view.mountInto(targetElement);
                                    } else {
                                        console.error("DOMView: Rendering into nothingness since template target-element does not exist in target iframe: ", targetFrameSpec, targetSpec);
                                    }
                                } else {
                                    // Just plain add it to body
                                    view.mountInto(targetDocument.body);
                                }
                            } else {
                                // Rendering to the local document
                                if (targetSpec){
                                    // This template uses a custom render target element, try to find it
                                    let targetElement = targetDocument.querySelector(targetSpec);
                                    if (targetElement){
                                        view.mountInto(targetElement);
                                    } else {
                                        console.error("DOMView: Rendering into nothingness since template target-element does not exist in document: ", targetSpec);
                                    }
                                } else {
                                    // Default is to render just after the template element.
                                    // Special-case for CodeStrates-based templates (avoid getting deleted inside autoDOM)
                                    let autoDOM = this.templateElement.closest(".autoDom");
                                    if (autoDOM){
                                        // Add after autoDOM instead of inside of it
                                        if (!autoDOM.parentNode){
                                            console.log("DOMView: Was rendering an autoDOM template but it had no parent", templateElement);
                                        }
                                        view.mountInto(autoDOM.parentNode,autoDOM.nextElementSibling);
                                    } else {
                                        // Outside we just insert after the template directly
                                        if (!this.templateElement.parentNode){
                                            console.log("DOMView: Was rendering a non autoDOM template but it had no parent", templateElement);
                                        }
                                        view.mountInto(this.templateElement.parentNode, this.templateElement.nextElementSibling);
                                    }
                                }
                            }

                            return view;
                        }
                    };

                    window.RootParseNode = RootParseNode;

                    </SCRIPT><SCRIPT id="TemplateBinding-script" type="disabled">
                    class TemplateBinding {
                        constructor(templateRootElement) {
                            this.templateElement = templateRootElement;
                        }

                        getTemplateElement(){
                            return this.templateElement;
                        }

                        hasBindingFor(name) {
                            return false;
                        }
                    }

                    window.TemplateBinding = TemplateBinding;

                    </SCRIPT><SCRIPT id="ValueBinding-script" type="disabled">
                    class ValueBinding {
                        constructor(bindings) {
                            this.bindings = bindings;
                        }

                        hasBindingFor(name) {
                            return this.bindings.hasOwnProperty(name);
                        }

                        getValueFor(name) {
                            return this.bindings[name];
                        }
                    }

                    window.ValueBinding = ValueBinding;

                    </SCRIPT><SCRIPT id="RuntimeExceptionBinding-script" type="disabled">
                    class RuntimeExceptionBinding {
                        constructor(errorMessage, ex) {
                            this.errorMessage = errorMessage;
                            this.ex = ex;
                        }

                        hasBindingFor(name) {
                            return false;
                        }

                        getValueFor(name) {
                            throw new Error("Unsupported operation");
                        }
                    }

                    window.RuntimeExceptionBinding = RuntimeExceptionBinding;

                    </SCRIPT><SCRIPT id="PropertyBinding-script" type="disabled">
                    class PropertyBinding {
                        constructor(property, uuid, boundValue, as=null) {
                            this.uuid = uuid;
                            this.property = property;
                            this.boundValue = boundValue;
                            this.as = as;
                        }

                        hasBindingFor(name){
                            if (name===".value") return true;
                            if (this.as){
                                // We are available under as.value
                                return name===this.as+".value";
                            } else {
                                return name===this.property.name+".value";
                            }

                            return false;
                        }

                        getValueFor(name){
                            if (!this.hasBindingFor(name)) throw new Error("PropertyBinding asked for value for "+name+" but only supports "+this.property.name+".value/"+this.as+".value");
                            return this.boundValue;
                        }
                    }

                    window.PropertyBinding = PropertyBinding;

                    </SCRIPT><SCRIPT id="PropertyArrayEntryBinding-script" type="disabled">
                    class PropertyArrayEntryBinding extends PropertyBinding {
                        constructor(property, uuid, boundValue, index, length, as=null) {
                            super(property, uuid, boundValue, as);
                            this.index = index;
                            this.length = length;
                            this._reIndexCount = 0;
                            this._indexCallbacks = [];
                        }

                        hasBindingFor(name){
                            // We don't supply this ourselves
                            if (super.hasBindingFor(name)){
                                return true;
                            }

                            if (name===".index") return true;
                            if (name===".size") return true;
                            if (name==="view::reused") return true;
                            if (this.as){
                                // We are available under as.value
                                return name===this.as+".index";
                            } else {
                                return name===this.property.name+".index";
                            }
                        }

                        getValueFor(name){
                            if (!this.hasBindingFor(name)) throw new Error("PropertyArrayEntryBinding asked for value for "+name+" but does not support it");
                            if (name==="view::reused") return this._reIndexCount;

                            if (name.endsWith(".size")){
                                return this.length;
                            } else if (name.endsWith(".index")){
                                return this.index;
                            } else {
                                return this.boundValue;
                            }
                        }

                        updateIndex(newIndex){
                            this._reIndexCount++;
                            this.index = newIndex;
                            this._indexCallbacks.forEach((callback)=>{
                                try {
                                    callback();
                                } catch (ex){
                                    console.log(ex);
                                }
                            });
                        }

                        addIndexCallback(callback) {
                            this._indexCallbacks.push(callback);
                        }

                        removeIndexCallback(callback) {
                            let index = this._indexCallbacks.indexOf(callback);
                            if (index===-1){
                                console.warn("Cannot remove indexcallback that isn't part of list of callbacks: "+callback+" list is "+this._indexCallbacks);
                                return;
                            }
                            this._indexCallbacks.splice(index, 1);
                        }

                        generateRawChangeListener(name, oldValue=null){
                            if (!this.hasBindingFor(name)) throw new Error("PropertyArrayEntryBinding asked for change listener for "+name+" but does not support it");
                            let self = this;

                            let result = {
                                onChanged: async ()=>{console.error("DOMView bug: PropertyArrayEntryBinding raw change listener called without anything hooked up to it");},
                                destroy: ()=>{}
                            };
                            let changedCallback = false;
                            if (name==="view::reused"){
                                changedCallback = async function indexChanged(){
                                    await result.onChanged(self._reIndexCount);
                                };
                            } else if (name.endsWith(".index")){
                                changedCallback = async function indexChanged(){
                                    await result.onChanged(self.index);
                                };
                            }

                            if (changedCallback){
                                self.addIndexCallback(changedCallback);
                                result.destroy = ()=>{
                                    self.removeIndexCallback(changedCallback);
                                };
                            }
                            return result;
                        }

                        identicalExceptIndex(otherBinding){
                            return this.property === otherBinding.property &&
                                    this.uuid === otherBinding.uuid &&
                                    this.boundValue === otherBinding.boundValue;
                        }
                    }

                    window.PropertyArrayEntryBinding = PropertyArrayEntryBinding;

                    </SCRIPT><SCRIPT id="ConceptInstanceBinding-script" type="disabled">
                    class ConceptInstanceBinding {
                        constructor(concept, uuid) {
                            if (!uuid) throw new Error("Invalid reference to concept instance with a null or undefined uuid '"+uuid+"' and concept '"+concept+"'");
                            if (!concept) throw new Error("Invalid reference to unknown concept with uuid '"+uuid+"', concept is "+concept);
                            this.concept = concept;
                            this.uuid = uuid;
                        }

                        hasBindingFor(name) {
                            try {
                                this.getProperty(name);
                                return true;
                            } catch (ex) {
                                return false;
                            }
                        }

                        getProperty(lookupName){
                            if(lookupName.startsWith(this.concept.name+".")) {
                                lookupName = lookupName.substring(this.concept.name.length+1);
                            }
                            return this.concept.getProperty(lookupName);
                        }

                        generateRawChangeListener(lookupName, initialValue=null){
                            let self = this;
                            let oldValue;
                            if (Array.isArray(initialValue)){
                                oldValue = initialValue.slice();
                            } else {
                                oldValue = initialValue;
                            }

                            let property = this.getProperty(lookupName);

                            let result = {
                                onChanged: async ()=>{console.error("DOMView bug: ConceptInstanceBinding raw change listener called without anything hooked up to it", self.concept, self.uuid, self);}
                            };

                            // Listen for changes in the looked up property
                            let changedCallback = async function queryParseNodePropertyChanged(uuid, value){
                                if (uuid===self.uuid){
                                    let identical = false;
                                    if (Array.isArray(value)){
                                        identical = ScopedParseNode.fastDeepEqual(value, oldValue);
                                    } else {
                                        identical = (oldValue===value);
                                    }

                                    if (!identical){
                                        if (Array.isArray(value)){
                                            oldValue = value.slice();
                                        } else {
                                            oldValue = value;
                                        }
                                        await result.onChanged(value);
                                    }
                                }
                            };
                            property.addUpdatedCallback(changedCallback);
                            result.destroy = ()=>{
                                property.removeUpdatedCallback(changedCallback);
                            };
                            return result;
                        }

                        async getValueFor(name) {
                            let property = null;
                            try {
                                property = this.getProperty(name);
                            } catch(e) {
                                //Ignore
                            }

                            if(property === null) {
                                return undefined;
                            }

                            return await property.getValue(this.uuid);
                        }

                        async setValueFor(name, value){
                            const property = this.concept.getProperty(name);
                            await property.setValue(this.uuid, property.typeCast(value));
                        }
                    }

                    window.ConceptInstanceBinding = ConceptInstanceBinding;

                    </SCRIPT><SCRIPT id="DOMView-script" type="disabled">
                    class DOMView {
                        constructor(){
                            this.renders = [];
                        }

                        render(suggestedDelay=10){
                            clearTimeout(this.renderTimer);
                            this.renderTimer = setTimeout(()=>{
                                // Cleanup
                                this.renders.forEach((view)=>{
                                    view.destroy();
                                });

                                // Render new views
                                document.querySelectorAll("dom-view-template").forEach(async (template)=>{
                                    if (DOMView.DEBUG) console.log("Parsing",template);
                                    let root = new RootParseNode(template);
                                    if (DOMView.DEBUG) console.log("Rendering",template);
                                    this.renders.push(root.render());
                                    if (DOMView.DEBUG) console.log("Ready for use");
                                });
                            },suggestedDelay);
                        }

                        existsAsViewElement(viewName){
                            return document.querySelector("dom-view-template [view='"+viewName+"']");
                        }

                        /**
                         * Gets the most specific binding with a value for a name in the scope
                         * @param {type} bindingName
                         * @param {type} scope
                         * @returns {undefined|DOMView.getBindingFromScope.scope}
                         */
                        static getBindingFromScope(bindingName, scope){
                            for (let i = scope.length - 1; i >= 0; i--) {
                                if (scope[i].hasBindingFor(bindingName)) {
                                    return scope[i];
                                }
                            }
                            return undefined;
                        }

                        /**
                         * Convenience method that evaluates a value in scope
                         * @param {type} bindingName
                         * @param {type} scope
                         * @returns {undefined}
                         */
                        async evaluateValueInScope(bindingName, scope) {
                            let binding = DOMView.getBindingFromScope(bindingName, scope);
                            if (binding===undefined) return undefined;

                            return await binding.getValueFor(bindingName);
                        }

                        /**
                         * Gets an ordered list from the scope mapped by the mapper function given
                         */
                        getFilteredPath(viewElement, mapperFunction){
                            let element = viewElement;
                            while (element != null && !element.scope){
                                element = element.parentElement;
                                if (element==null){
                                    // No concepts in this tree path at all
                                    return [];
                                }
                            }

                            let result = [];
                            if(element != null && element.viewParticle != null) {
                                for (let binding of element.viewParticle.scope) {
                                    let mappedValue = mapperFunction(binding);
                                    if (mappedValue) result.push(mappedValue);
                                }
                            }
                            return result;
                        }

                        /**
                         * Gets an ordered list of concepts instances involved in rendering this view element
                         * @param {HTMLElement} viewElement
                         * @returns {string[]}
                         */
                        getConceptPath(viewElement){
                            return this.getFilteredPath(viewElement, (binding)=>{
                                if (binding instanceof ConceptInstanceBinding) return binding;
                            });
                        }

                        /**
                         * Gets an ordered list of template elements involved in rendering this view element
                         * @param {HTMLElement} viewElement
                         * @returns {string[]}
                         */
                        getTemplatePath(viewElement){
                            return this.getFilteredPath(viewElement, (binding)=>{
                                if (binding instanceof TemplateBinding) return binding.templateElement;
                            });
                        }

                        /**
                         * Gets an ordered list of properties involved in rendering this view element
                         * @param {HTMLElement} viewElement
                         * @returns {string[]}
                         */
                        getPropertyPath(viewElement){
                            return this.getFilteredPath(viewElement, (binding)=>{
                                if (binding instanceof PropertyBinding) return {uuid: binding.uuid, property: binding.property};
                            });
                        }
                    }

                    DOMView.DEBUG = false;
                    DOMView.DEBUG_PERFORMANCE = false;
                    DOMView.singleton = new DOMView();
                    window.DOMView = DOMView;


                    //If fragments exists postpone the DOMView until all fragments was loaded at least first time. (Fragments added later obviously does not count)
                    if(typeof Fragment !== "undefined") {
                        Fragment.addAllFragmentsLoadedCallback(()=>{
                            // We started after autoDOM has run, so no mutations. Bootstrap with what we have
                            console.log("DOMDiffView: Full re-render due to initial page load via Codestrates");
                            DOMView.singleton.render();

                            // STUB: Reload when templates change
                            let observer = new MutationObserver((mutations) => {
                                let reload = function reloadDueToMutations(){
                                    console.log("STUB: DOMDiffView: Full re-render due to templates changing");
                                    DOMView.singleton.render(300);
                                };
                                for(let mutation of mutations) {
                                    // From inside a template
                                    if (
                                           (mutation.target.matches && mutation.target.matches("dom-view-template"))
                                        || (mutation.target.closest && mutation.target.closest("dom-view-template"))
                                        || (mutation.target.parentElement && mutation.target.parentElement.closest("dom-view-template"))){
                                        reload();
                                        break;
                                    }

                                    // From outside a template
                                    if (mutation.type==="childList"){
                                        for (let node of [...mutation.addedNodes, ...mutation.removedNodes]){
                                            if (node.tagName === "DOM-VIEW-TEMPLATE" || (node.querySelector && node.querySelector("dom-view-template"))){
                                                reload();
                                                break;
                                            }
                                        }
                                    }
                                };
                            });
                            observer.observe(document.body, {
                                attributes: true,
                                attributeOldValue: false,
                                childList: true,
                                subtree: true,
                                characterData: true,
                                characterDataOldValue: false
                            });

                            VarvEngine.registerEventCallback("engineReloaded", (evt) => {
                                console.log("DOMDiffView: Full re-render due to engine reload");
                                DOMView.singleton.render();
                            });
                        });
                    } else {
                        VarvEngine.registerEventCallback("engineReloaded", (evt) => {
                            console.log("DOMDiffView: Full re-render due to engine reload");
                            DOMView.singleton.render();
                        });
                    }

                    </SCRIPT><STYLE id="domview-style">
                    dom-view-template {
                      display: none; }

                    varv-view {
                      display: contents; }
                      varv-view varv-failure:before {
                        content: "?";
                        width: 1em;
                        height: 1em;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        background: red;
                        cursor: pointer; }
                      varv-view [varv-domview-highlight] {
                        filter: invert(15%) drop-shadow(0 0 0.25em #6496ff); }

                    .hide-varv-errors varv-failure {
                      display: none; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-memory" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Memory Data Store",
                        "description": "Allow data to be stored in memory",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="MemoryDataStore-script" type="disabled">
                    /**
                     *  MemoryDataStore - stores properties temporarily in memory
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A general purpose datastore that stores properties temporarily in memory. The
                     * memory is lost on reload.
                     *
                     * This datastore registers as the type "memory".
                     *
                     * ### Options
                     * * "storageName" - The memory bucket name of the storage (default: "memory"). Multiple independant buckets can be maintained
                     *
                     * @memberOf Datastores
                     * @example
                     * {
                     *   "dataStores": {
                     *      "myDataStore": {
                     *          "type": "memory",
                     *          "options": {
                     *              "storageName": "myMemory"
                     *          }
                     *      },
                     *      ...
                     *  },
                     *  ...
                     *
                     */
                    class MemoryDataStore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);

                            this.deleteCallbacks = [];
                        }

                        isShared() {
                            return false;
                        }

                        destroy() {
                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            })
                        }

                        async init() {
                            const self = this;
                            this.typeVariable = "__memoryDataStore_internalType";

                            this.storageName = "memory";
                            if (this.options.storageName) this.storageName = this.options.storageName;

                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("disappeared", async (context)=> {
                                if(MemoryDataStore.DEBUG) {
                                    console.log("Saw disappeared UUID (MemoryDataStore):", context.target);
                                }

                                context.concept.properties.forEach((property) => {
                                    if (self.isPropertyMapped(context.concept, property)) {
                                        let data = self.internalPropertyTrackingData(context.concept, property);
                                        delete data[context.target];
                                    }
                                });
                                self.getStorage().delete(context.target);
                            }));
                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("appeared", async (context)=> {
                                if(MemoryDataStore.DEBUG) {
                                    console.log("Saw appeared UUID (MemoryDataStore):", context.target);
                                }
                                let mark = VarvPerformance.start();
                                if (self.isConceptMapped(context.concept) && !self.getStorage().has(context.target)){
                                    self.getStorage().set(context.target, {
                                        [self.typeVariable]: context.concept.name
                                    });
                                }
                                VarvPerformance.stop("MemoryDataStore.registerEventCallback.appeared", mark);
                            }));
                        }

                        getStorage(){
                            if (!MemoryDataStore.storages[this.storageName]){
                                MemoryDataStore.storages[this.storageName] = new Map();
                            }
                            return MemoryDataStore.storages[this.storageName];
                        }

                        createBackingStore(concept, property) {
                            const self = this;

                            if (this.isPropertyMapped(concept,property)) return;

                            let setter = (uuid, value) => {
                                let mark = VarvPerformance.start();
                                if (!self.getStorage().has(uuid)){
                                    throw new Error("Tried to set concept in memory that never appeared: "+concept.name+"."+property.name);
                                }

                                let data = self.getStorage().get(uuid);
                                data[property.name] = value;
                                VarvPerformance.stop("MemoryDataStore.setter", mark);
                            };
                            let getter = (uuid) => {
                                let mark = VarvPerformance.start();
                                let data = self.getStorage().get(uuid);
                                if (!data) throw new Error("Tried to get concept from memory that was never set: "+concept.name+"."+property.name);
                                if (!data.hasOwnProperty(property.name)) throw new Error("Tried to get property from memory that was never set: "+concept.name+"."+property.name);
                                let result = data[property.name];
                                VarvPerformance.stop("MemoryDataStore.getter", mark);
                                return result;
                            };
                            property.addSetCallback(setter);
                            property.addGetCallback(getter);

                            // Check if concept already is mapped, if not, register it
                            this.internalAddPropertyMapping(concept, property, {setter: setter, getter: getter});
                        }

                        removeBackingStore(concept, property) {
                            if (!this.isPropertyMapped(concept, property)){
                                throw new Error('Cannot unmap property from memory because the property was not mapped: ' + concept + "." + property);
                            }

                            let trackingData = this.internalPropertyTrackingData(concept, property);
                            property.removeSetCallback(trackingData.setter);
                            property.removeGetCallback(trackingData.getter);

                            this.internalRemovePropertyMapping(concept, property);
                        }

                        async loadBackingStore() {
                            // For each of our stored and mapped concepts
                            for(let [uuid,storedConcept] of this.getStorage().entries()) {
                                if (MemoryDataStore.DEBUG) console.log("Loading from memory",uuid,storedConcept);

                                let type = storedConcept[this.typeVariable];
                                if ((!type) || !this.isConceptTypeMapped(type)){
                                    if (MemoryDataStore.DEBUG) console.log("Ignoring concept from memory since it is not mapped", storedConcept);
                                    continue;
                                }

                                // Check if already registered and only generate an appear event if not
                                let conceptByUUID = await VarvEngine.getConceptFromUUID(uuid);
                                let concept = VarvEngine.getConceptFromType(type);

                                this.registerConceptFromUUID(uuid, concept);

                                // Stil set the properties that we know about
                                for (const [propertyName,value] of Object.entries(storedConcept)){
                                    if (propertyName !== this.typeVariable){
                                        try {
                                            let property = concept.getProperty(propertyName);
                                            if (MemoryDataStore.DEBUG) console.log("Loading property", property, value);
                                            if (this.isPropertyMapped(concept, property)){
                                                await property.setValue(uuid, value);
                                            }
                                        } catch (ex){
                                            console.error("Failed to push concept property from memory to concept", ex);
                                        }
                                    }
                                }

                                if (!conceptByUUID) {
                                    await concept.appeared(uuid);
                                }
                            }
                        }
                    }
                    MemoryDataStore.DEBUG = false;
                    window.MemoryDataStore = MemoryDataStore;
                    MemoryDataStore.storages = new Map();

                    // Register default dom datastore
                    Datastore.registerDatastoreType("memory", MemoryDataStore);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-localstorage" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv localStorage Datastore",
                        "description": "Store data in the browsers's local storage database",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="LocalStorageDataStore-script" type="disabled">
                    /**
                     *  LocalStorageDataStore - serializes into the localStorage database
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */


                    /**
                     * A storage that serializes into the localStorage database
                     *
                     * ### Options
                     * * storageName - The name of the prefix to store that data below (Default: "varv-data")
                     *
                     * @memberOf Datastores
                     */

                    class LocalStorageDataStore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);
                            if (typeof webstrate !== "undefined"){
                                this.storagePrefix = webstrate.webstrateId+"-datastore";
                            } else if (location.protocol !== "file:"){
                                this.storagePrefix = location.pathname+"-datastore";
                            } else {
                                this.storagePrefix = "varv-data";
                            }
                            this.entities = {};

                            if (this.options.storageName) this.storagePrefix = this.options.storageName;

                            this.deleteCallbacks = [];
                        }

                        isShared() {
                            return false;
                        }

                        async init(){
                            const self = this;

                            if (!localStorage) throw new Error("Cannot use localStorage as the feature is not available on this js runtime platform");

                            if (!localStorage.getItem(this.storagePrefix)) self.saveEntities();

                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("disappeared", async (context)=> {
                                if(LocalStorageDataStore.DEBUG) {
                                    console.log("Saw disappeared UUID (LocalStorageDataStore):", context.target);
                                }

                                if (!self.entities[context.target]) return; // avoid loops when we caused the disappear event ourselves

                                context.concept.properties.forEach((property) => {
                                    if (self.isPropertyMapped(context.concept, property)) {
                                        localStorage.removeItem(self.storagePrefix + "-" + context.target + "-" + property.name);
                                    }
                                });
                                delete self.entities[context.target];
                                self.saveEntities();
                            }));
                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("appeared", async (context)=> {
                                if(LocalStorageDataStore.DEBUG) {
                                    console.log("Saw appeared UUID (LocalStorageDataStore):", context.target);
                                }

                                let mark = VarvPerformance.start();
                                if (self.entities[context.target]) return; // avoid loops when we caused the appear event ourselves

                                if (self.isConceptMapped(context.concept)) {
                                    self.entities[context.target] = context.concept.name;
                                    self.saveEntities();
                                }
                                VarvPerformance.stop("LocalStorageDataStore.registerEventCallback.appeared", mark);
                            }));

                            this.storageEventListener = async function localStorageChangeUpdate(event){
                                if (event.key===self.storagePrefix){
                                    // This is a change in the active entities, pull any new ones
                                    let storedEntities = JSON.parse(event.newValue);
                                    for (const [uuid,type] of Object.entries(storedEntities)){
                                        if (!self.entities[uuid]){
                                            // TODO: check mapped type?
                                            self.entities[uuid] = type;
                                            await self.pullConcept(uuid);
                                        }
                                    }

                                    // and kill any that are gone
                                    for (const [uuid,type] of Object.entries(self.entities)){
                                        if (!storedEntities[uuid]){
                                            delete self.entities[uuid]; // delete our tracker BEFORE sending disappear event to avoid loops
                                            await VarvEngine.getConceptFromType(type).disappeared(uuid);
                                        }
                                    };
                                } else if (event.key.startsWith(self.storagePrefix+"-")){
                                    // This could be a property change event if the key matches a property
                                    let matches = new RegExp("^([^-]+)\-(.+?)$").exec(event.key.substring(self.storagePrefix.length+1));
                                    if (matches.length===3){
                                        if (event.newValue===null) return; // TODO: The property was removed, is there any way to handle this properly?

                                        let uuid = matches[1];
                                        let propertyName = matches[2];

                                        let concept = self.getConceptFromUUID(uuid);
                                        if (!concept){
                                            console.log("Localstorage got property update from concept with UUID that does not exist locally", uuid);
                                            return;
                                        }
                                        let property = concept.getProperty(propertyName);
                                        if (!property){
                                            console.log("Localstorage got property update from concept property that does not exist locally", concept, propertyName);
                                            return;
                                        }
                                        await property.setValue(uuid, JSON.parse(event.newValue));
                                    }
                                }
                            };

                            window.addEventListener("storage", this.storageEventListener);
                        }

                        destroy() {
                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            });

                            window.removeEventListener("storage", this.storageEventListener);
                        }

                        saveEntities(){
                            localStorage.setItem(this.storagePrefix, JSON.stringify(this.entities));
                        }

                        createBackingStore(concept, property) {
                            const self = this;

                            if (this.isPropertyMapped(concept,property)) {
                                console.log("FIXME: Trying to create localStorage backing store for already mapped property, ignored", concept, property);
                                return;
                            }

                            let setter = (uuid, value) => {
                                let mark = VarvPerformance.start();
                                if (!self.entities[uuid]){
                                    throw new Error("Tried to set concept property in localStorage for concept instance that never appeared: "+concept.name+"."+property.name);
                                }

                                localStorage.setItem(self.storagePrefix+"-"+uuid+"-"+property.name, JSON.stringify(value));
                                VarvPerformance.stop("LocalStorageDataStore.setter", mark);
                            };
                            let getter = (uuid) => {
                                let mark = VarvPerformance.start();
                                if (!self.entities[uuid]){
                                    throw new Error("Tried to get concept property from localStorage for concept instance that was never seen: "+concept.name+"."+property.name);
                                }

                                let data = localStorage.getItem(self.storagePrefix+"-"+uuid+"-"+property.name);
                                if (data===null){
                                    throw new Error("Tried to get concept property from localStorage that was never set: "+concept.name+"."+property.name);
                                }
                                let result =  JSON.parse(data);
                                VarvPerformance.stop("LocalStorageDataStore.getter", mark);
                                return result;
                            };
                            property.addSetCallback(setter);
                            property.addGetCallback(getter);

                            // Check if concept already is mapped, if not, register it
                            this.internalAddPropertyMapping(concept, property, {setter: setter, getter: getter});
                        }

                        removeBackingStore(concept, property) {
                            if (!this.isPropertyMapped(concept, property)){
                                throw new Error('Cannot unmap property from localStorage because the property was not mapped: ' + concept + "." + property);
                            }

                            let trackingData = this.internalPropertyTrackingData(concept, property);
                            property.removeSetCallback(trackingData.setter);
                            property.removeGetCallback(trackingData.getter);

                            this.internalRemovePropertyMapping(concept, property);
                        }

                        /**
                         * Loads all concept instances currently registered as backed from serialized state
                         *
                         * @returns {undefined}
                         */
                        async loadBackingStore() {
                            let self = this;
                            this.entities = JSON.parse(localStorage.getItem(this.storagePrefix));

                            for (const [uuid,type] of Object.entries(this.entities)){
                                await self.pullConcept(uuid);
                            }
                        }

                        async pullConcept(uuid){
                            let self = this;

                            let conceptType = this.entities[uuid];
                            if (!conceptType){
                                throw new Error("Tried to pull a concept from localStorage that wasn't a known entity in there");
                            }

                            const concept = VarvEngine.getConceptFromType(conceptType);
                            if (!concept) {
                                if (LocalStorageDataStore.DEBUG) console.log("LocalStorage: Ignoring unknown concept with type", type);
                                return;
                            }

                            if (!self.isConceptMapped(concept)){
                                if (LocalStorageDataStore.DEBUG) console.log("LocalStorage: Ignoring concept with type that isn't mapped to localStorage", type);
                                return;
                            }

                            let conceptByUUID = await VarvEngine.getConceptFromUUID(uuid);
                            this.registerConceptFromUUID(uuid, concept);

                            // Pull all properties
                            for (const property of concept.properties){
                                if (self.isPropertyMapped(concept, property)){
                                    try {
                                        let value = localStorage.getItem(self.storagePrefix+"-"+uuid+"-"+property.name);
                                        if (value!==null){
                                            await property.setValue(uuid, JSON.parse(value));
                                        }
                                    } catch (ex){
                                        // Ignore
                                    }
                                }
                            };

                            if (!conceptByUUID) {
                                await concept.appeared(uuid);
                            }
                        }
                    }
                    LocalStorageDataStore.DEBUG = false;
                    window.LocalStorageDataStore = LocalStorageDataStore;

                    //Register default dom datastore
                    Datastore.registerDatastoreType("localStorage", LocalStorageDataStore);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-signaling" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Signaling Data Store",
                        "description": "Live data sharing over webstrate signals",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="SignalingDataStore-script" type="disabled">
                    /**
                     *  SignalingDataStore - signals data over webstrate signals
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2024, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A general purpose datastore that signals changes to data over webstrate signals
                     *
                     * This datastore registers as the type "signaling".
                     *
                     * ### Options
                     * * "storageName" - The element name of the DOM element to send signals through (default: "varv-signaling")
                     *
                     * @memberOf Datastores
                     * @example
                     * {
                     *   "dataStores": {
                     *      "myDataStore": {
                     *          "type": "signaling",
                     *          "options": {
                     *              "storageName": "my-signals"
                     *          }
                     *      },
                     *      ...
                     *  },
                     *  ...
                     *
                     */
                    class SignalingDataStore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);

                            this.deleteCallbacks = [];
                            this.inflightChanges = new Set();
                        }

                        isShared() {
                            return true;
                        }

                        destroy() {
                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            });
                        }

                        async init() {
                            const self = this;

                            let storageName = "varv-signaling";
                            if(this.options.storageName != null) {
                                storageName = this.options.storageName;
                            }

                            // Try to find an element to signal on
                            let topElement = document;
                            this.backingElement = topElement.querySelector(storageName);
                            if (!this.backingElement) {
                                this.backingElement = topElement.createElement(storageName, {approved: true});
                                topElement.body.appendChild(this.backingElement);
                            }
                            let signalFunction = (message,sender)=>self.receiveSignal(message,sender)
                            this.backingElement.webstrate.on("signal", signalFunction);
                            this.deleteCallbacks.push({
                                delete: ()=>{
                                    this.backingElement.webstrate.off("signal", signalFunction);
                                }
                            });


                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("disappeared", async (context)=> {
                                if(SignalingDataStore.DEBUG) {
                                    console.log("Saw disappeared UUID (SignalingDataStore):", context.target);
                                }

                                context.concept.properties.forEach((property) => {
                                    if (self.isPropertyMapped(context.concept, property)) {
                                        let data = self.internalPropertyTrackingData(context.concept, property);
                                        delete data[context.target];
                                    }
                                });

                                // Broadcast to everyone
                                this.backingElement.webstrate.signal({
                                    q: "notifyDisappeared",
                                    type: context.concept.name,
                                    uuid: context.target
                                });
                            }));
                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("appeared", async (context)=> {
                                if(SignalingDataStore.DEBUG) {
                                    console.log("Saw appeared UUID (SignalingDataStore):", context.target);
                                }
                                if (self.isConceptMapped(context.concept)){
                                    if (self.inflightChanges.has("appear"+"."+context.target)) return; // This was caused by us, ignore it

                                    // Broadcast to everyone
                                    let initialInstance = {
                                        q: "notifyInitialInstance",
                                        type: context.concept.name,
                                        uuid: context.target,
                                        properties: {}
                                    };
                                    for (let property of Array.from(self.mappedConcepts.get(context.concept.name).keys())){
                                        try {
                                            initialInstance.properties[property] = await context.concept.getPropertyValue(context.target, property);
                                        } catch (ex){
                                            // May not have a getter at all, so skip it
                                        }
                                    }
                                    this.backingElement.webstrate.signal(initialInstance);
                                }
                            }));
                        }

                        async receiveSignal(message, sender){
                            if (sender==webstrate.clientId) return; // Ignore our own messages
                            if (!message.q) return;
                            if (SignalingDataStore.DEBUG) console.log(message, sender);
                            switch (message.q){
                                case "getConceptUUIDs":
                                    // A peer is asking us about what UUIDs we know about for a given concept type
                                    if ((!message.type) || !this.isConceptTypeMapped(message.type)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring concept listing request since it is not mapped on this peer", message);
                                        break;
                                    }
                                    this.backingElement.webstrate.signal({
                                        q: "notifyExists",
                                        type: message.type,
                                        uuids: await VarvEngine.getAllUUIDsFromType(message.type)
                                    }, [sender]);
                                    break;
                                case "notifyExists":
                                    // A peer is telling us about UUIDs it knows for a given concept type
                                    if ((!message.type) || !this.isConceptTypeMapped(message.type)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring concept listing notification since it is not mapped on this peer", message);
                                        break;
                                    }

                                    let properties = Array.from(this.mappedConcepts.get(message.type).keys());
                                    for (let uuid of message.uuids){
                                        // Check if we already synced this one and only request data discovery if not
                                        let ourConceptByUUID = await this.getConceptFromUUID(uuid);
                                        if (!ourConceptByUUID){
                                            this.backingElement.webstrate.signal({
                                                q: "getInitialInstance",
                                                uuid: uuid,
                                                properties: properties
                                            }, [sender]);
                                        }
                                    }
                                    break;
                                case "getInitialInstance":
                                    if (!(message.uuid&&message.properties)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring request for initial instance data with malformed request", message);
                                        break;
                                    }
                                    let initialConceptByUUID = await VarvEngine.getConceptFromUUID(message.uuid);
                                    if (!initialConceptByUUID){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring request for initial instance data for instance that doesn't exist", message);
                                        break;
                                    }

                                    // TODO: Check properties are actually mapped

                                    // Construct JSON representation of instance and send it back
                                    let initialInstanceReply = {
                                        q: "notifyInitialInstance",
                                        uuid: message.uuid,
                                        type: initialConceptByUUID.name,
                                        properties: {}
                                    };
                                    for (let property of message.properties){
                                        initialInstanceReply.properties[property] = await initialConceptByUUID.getPropertyValue(message.uuid, property);
                                    }
                                    this.backingElement.webstrate.signal(initialInstanceReply, [sender]);
                                    break;
                                case "notifyInitialInstance":
                                    if (!(message.uuid&&message.properties&&message.type)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring initial instance data with malformed structure", message);
                                        break;
                                    }

                                    let concept = VarvEngine.getConceptFromType(message.type);
                                    if (!concept){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring initial instance data with nonexisting concept", message);
                                        break;
                                    }
                                    if (!this.isConceptMapped(concept)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring initial instance data with non-mapped concept", message);
                                        break;
                                    }


                                    let varvInitialInstance = await VarvEngine.getConceptFromUUID(message.uuid);
                                    let usInitialInstance = this.getConceptFromUUID(message.uuid);

                                    // Maybe this was the first time Varv heard about this instance ever, in that case make it appear
                                    let appearChange = "appear"+"."+message.uuid;
                                    this.inflightChanges.add(appearChange); // Avoid writebacks from this
                                    if (!varvInitialInstance) {
                                        await concept.appeared(message.uuid);
                                    }

                                    if (!usInitialInstance){
                                        // This is the first time we signal about this instance but it may be in another local datastore
                                        this.registerConceptFromUUID(message.uuid, concept);

                                        // Pull the mapped properties from the hivemind to any other local datastore + the concept
                                        for (let propertyName of this.mappedConcepts.get(message.type).keys()){
                                            try {
                                                let property = concept.getProperty(propertyName);
                                                if (SignalingDataStore.DEBUG) console.log("Loading property", property, message.properties[propertyName]);
                                                // TODO: Error if not set in message
                                                await this._setVarvProperty(concept, message.uuid, propertyName, message.properties[propertyName]);
                                            } catch (ex){
                                                console.error("Failed to push concept property from signal to concept", ex);
                                            }
                                        }
                                    }
                                    this.inflightChanges.delete(appearChange); // Avoid writebacks from this

                                    break;
                                case "setProperty":
                                    if (!(message.uuid&&message.property)){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring property change with malformed data", message);
                                        break;
                                    }

                                    // TODO: Check if mapped
                                    let changedConcept = this.getConceptFromUUID(message.uuid);
                                    if (!changedConcept){
                                        if (SignalingDataStore.DEBUG) console.log("Ignoring property change for unknown UUID", message);
                                        break;
                                    }

                                    await this._setVarvProperty(changedConcept, message.uuid, message.property, message.value);
                                    break;
                                default:
                                    console.log("Unhandled signal ",message);
                            }
                        }

                        async _setVarvProperty(concept, uuid, propertyName, value){
                            let change = uuid+"."+propertyName;
                            this.inflightChanges.add(change); // Avoid writebacks from this
                            await concept.setPropertyValue(uuid, propertyName, value);
                            this.inflightChanges.delete(change);
                        }

                        createBackingStore(concept, property) {
                            const self = this;

                            // Check if concept already is mapped, if not, register it
                            if (this.isPropertyMapped(concept,property)) return;
                            let setter = (uuid, value) => {
                                if (self.inflightChanges.has(uuid+"."+property.name)) return;
                                self.backingElement.webstrate.signal({
                                    q: "setProperty",
                                    uuid: uuid,
                                    property: property.name,
                                    value: value
                                });
                            };
                            property.addSetCallback(setter);
                            this.internalAddPropertyMapping(concept, property, {setter: setter});
                        }

                        removeBackingStore(concept, property) {
                            if (!this.isPropertyMapped(concept, property)){
                                throw new Error('Cannot unmap property from signaling because the property was not mapped: ' + concept + "." + property);
                            }

                            let trackingData = this.internalPropertyTrackingData(concept, property);
                            property.removeSetCallback(trackingData.setter);
                            this.internalRemovePropertyMapping(concept, property);
                        }

                        async loadBackingStore() {
                            // For each of our stored and mapped concepts, enqueue a list request for UUIDs from the hivemind to populate local state
                            for (let conceptType of this.mappedConcepts.keys()){
                                this.backingElement.webstrate.signal({
                                    q: "getConceptUUIDs",
                                    type: conceptType
                                });
                            }
                        }
                    }
                    SignalingDataStore.DEBUG = false;
                    window.SignalingDataStore = SignalingDataStore;

                    // Register default dom datastore
                    Datastore.registerDatastoreType("signaling", SignalingDataStore);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-location" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv URL Data Store",
                        "description": "Access properties of the URL as concept data",
                        "dependencies": [
                            "#varv-engine"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="LocationDataStore-script" type="disabled">
                    /**
                     *  LocationDataStore - access/control the URL in browsers
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * A datastore that allows reading and writing the location, query and hash as data.
                     *
                     * This datastore registers as the type "location".
                     *
                     * Any field mapped to this datastore from any object will use the URL params as the
                     * source of the data. For example mapping the field "useBirds" will allow reading the
                     * xyz value of a ?fun=true&useBirds=xyz URL.
                     *
                     * The special mapping "locationHash" allows reading the hash-postfix of the URL. For
                     * example the "cats" from https://cavi.au.dk/#cats
                     *
                     * Listening for changes to the mapped locationHash will notify the program on load
                     * as well as if/when the hash changes.
                     *
                     * This datastore has no options.
                     *
                     * @memberOf Datastores
                     */
                    class LocationDataStore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);

                            this.deleteCallbacks = [];
                        }

                        isShared() {
                            return false;
                        }

                        destroy() {
                            this.deleteCallbacks.forEach((deleteCallback)=>{
                                deleteCallback.delete();
                            });
                        }

                        async init() {
                            const self = this;

                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("disappeared", async (context)=> {
                                if(LocationDataStore.DEBUG) {
                                    console.log("Saw disappeared UUID (LocationDataStore):", context.target);
                                }
                                // Do nothing?
                            }));
                            this.deleteCallbacks.push(VarvEngine.registerEventCallback("appeared", async (context)=> {
                                if(LocationDataStore.DEBUG) {
                                    console.log("Saw appeared UUID (LocationDataStore):", context.target);
                                }
                                let mark = VarvPerformance.start();
                                // Do nothing? Maybe call them like onload?
                                VarvPerformance.stop("LocationDataStore.registerEventCallback.appeared", mark);
                            }));

                            window.addEventListener("hashchange", function locationHashChanged(){
                                self.onHashChange();
                            });
                        }

                        createBackingStore(concept, property) {
                            const self = this;
                            if (this.isPropertyMapped(concept,property)) return;

                            let setter = (uuid, value) => {
                                let mark = VarvPerformance.start();

                                if (property.name==="locationHash"){
                                    if (decodeURIComponent(location.hash.substring(1))!==value){
                                        location.hash = value;
                                    }
                                } else {
                                    // This is a parameter/location change if it differs from current
                                    let urlParams = new URLSearchParams(window.location.search);
                                    if (urlParams.has(property.name)){
                                        if (urlParams.get(property.name)!=value){
                                            if (LocationDataStore.DEBUG) console.info("FIXME: Location datastore only supports getting, not setting URL paramters so far");
                                        }
                                    }
                                    return;
                                }

                                VarvPerformance.stop("LocationDataStore.setter", mark);
                            };
                            let getter = (uuid) => {
                                let mark = VarvPerformance.start();
                                if (property.name==="locationHash"){
                                    let result = decodeURIComponent(location.hash.substring(1));
                                    if (result === "") throw new Exception("Cannot get empty locationHash");
                                    VarvPerformance.stop("LocationDataStore.getter.hash", mark);
                                    return result;
                                } else {
                                    let urlParams = new URLSearchParams(window.location.search);
                                    if (!urlParams.has(property.name)) throw new Exception("Cannot get property not present in URL");
                                    VarvPerformance.stop("LocationDataStore.getter.argument", mark);
                                    return urlParams.get(property.name);
                                }
                            };
                            property.addSetCallback(setter);
                            property.addGetCallback(getter);

                            // Check if concept already is mapped, if not, register it
                            this.internalAddPropertyMapping(concept, property, {setter: setter, getter: getter});
                        }

                        removeBackingStore(concept, property) {
                            if (!this.isPropertyMapped(concept, property)){
                                throw new Error('Cannot unmap property from memory because the property was not mapped: ' + concept + "." + property);
                            }

                            let trackingData = this.internalPropertyTrackingData(concept, property);
                            property.removeSetCallback(trackingData.setter);
                            property.removeGetCallback(trackingData.getter);

                            this.internalRemovePropertyMapping(concept, property);
                        }

                        async onHashChange(){
                            if (LocationDataStore.DEBUG) console.log("Location hash changed", location.hash);
                            // For each of our mapped concepts
                            for (let [conceptName, properties] of this.mappedConcepts.entries()){
                                if (properties.has("locationHash")){
                                    let concept = VarvEngine.getConceptFromType(conceptName);
                                    let property = concept.getProperty("locationHash");
                                    let value = decodeURIComponent(location.hash.substring(1));

                                    if (LocationDataStore.DEBUG) console.log("Firing location hash property set", property, value);
                                    let uuids = await VarvEngine.getAllUUIDsFromType(concept.name, true);
                                    uuids.forEach(async uuid=>{
                                        await property.setValue(uuid, value);
                                    });
                                }
                            };
                        }

                        async loadBackingStore() {
                            const self = this;

                            if (LocationDataStore.DEBUG) console.info("LocationDataStore location is "+location);

                            setTimeout(async function onLoadLocationTriggers(){
                                if (location.hash){
                                    await self.onHashChange();
                                }

                                // On-load set the URL parameters too
                                for (let [name,value] of new URLSearchParams(window.location.search).entries()){
                                    for (let [conceptName, properties] of self.mappedConcepts.entries()){
                                        if (properties.has(name)){
                                            let concept = VarvEngine.getConceptFromType(conceptName);
                                            let property = concept.getProperty(name);

                                            if (LocationDataStore.DEBUG) console.log("Firing URL parameter property set", conceptName, concept, property, value);
                                            let uuids = await VarvEngine.getAllUUIDsFromType(conceptName, false); // nulllointer if true?
                                            uuids.forEach(async uuid=>{
                                                await property.setValue(uuid, value);
                                            });
                                        }
                                    };
                                }

                                self.hasLoaded = true;
                            },0);
                        }
                    }
                    LocationDataStore.DEBUG = false;
                    window.LocationDataStore = LocationDataStore;

                    // Register default dom datastore
                    Datastore.registerDatastoreType("location", LocationDataStore);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-builtin-actions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Standard Actions",
                        "description": "Simple built-in actions for varv",
                        "dependencies": [
                            "#varv-engine",
                            "wpm_js_libs #mathjs"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="ArrayActions-script" type="disabled">
                    /**
                     *  ArrayActions - Actions related to array functionallity
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that deal with arrays
                     * @namespace ArrayActions
                     */

                    /**
                     * Action "length" that can put the length of an array or string into a variable
                     * @memberOf ArrayActions
                     * @example
                     * // Find the length of a property (array or string)
                     * {
                     *     "length": {
                     *         "of": {"property": "myArrayOrStringProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Find the length of a property (array or string), on a non selected property
                     * {
                     *     "length": {
                     *         "of": {"property": "myConcept.myArrayOrStringProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Find the length of a variable (array or string)
                     * {
                     *     "length": {
                     *         "of": {"variable": "myArrayOrStringVariable"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Shorthand, set the variable "length" to the length of the property "myProperty"
                     * {
                     *     "length": "myProperty"
                     * }
                     *
                     * @example
                     * // Shorthand, set the variable "length" to the length of the variable "myVariable"
                     * {
                     *     "length": "$myVariable"
                     * }
                     */
                    class LengthAction extends Action {
                        static options() {
                            return {
                                "of": "enumValue[property,variable]",
                                "as": "@string"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {

                                if(options.trim().startsWith("$")) {
                                    //Shorthand lookup variable
                                    options = {
                                        of: {
                                            variable: options.trim().substring(1)
                                        }
                                    }
                                } else {
                                    options = {
                                        of: {
                                            property: options
                                        }
                                    }
                                }
                            }

                            super(name, options, concept);

                            if(this.options.of == null) {
                                if(this.options.property != null) {
                                    this.options.of = {
                                        property: this.options.property
                                    }

                                    delete this.options.property;
                                } else if(this.options.variable != null) {
                                    this.options.of = {
                                        variable: this.options.variable
                                    }

                                    delete this.options.variable;
                                }
                            }
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.of == null) {
                                throw new Error("Missing option 'of' on length action");
                            }

                            if(this.options.of.property == null && this.options.of.variable == null) {
                                throw new Error("Missing option 'of.property' or 'of.variable' on length action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                if(options.of.property != null) {
                                    // Length of property

                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array" && property.type !== "string") {
                                        throw new Error("Unable to get length of non array|string type property ["+property.name+"] on ["+concept.name+"]");
                                    }

                                    let value = await property.getValue(target);

                                    Action.setVariable(context, variableName, value.length);
                                } else if(options.of.variable != null) {
                                    // Length of variable
                                    const variableValue = Action.getVariable(context, options.of.variable);

                                    if(!Array.isArray(variableValue) && typeof variableValue !== "string") {
                                        throw new Error("Variable ["+options.of.variable+"] was not of type array or string!");
                                    }

                                    Action.setVariable(context, variableName, variableValue.length);
                                }

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("length", LengthAction);
                    window.LengthAction = LengthAction;

                    class AppendPrependAction extends Action {
                        constructor(name, options, concept, prepend = false) {
                            super(name, options, concept);

                            if(this.options.to == null) {
                                if(this.options.property != null) {
                                    this.options.to = {
                                        property: this.options.property
                                    }

                                    delete this.options.property;
                                } else if(this.options.variable != null) {
                                    this.options.to = {
                                        variable: this.options.variable
                                    }

                                    delete this.options.variable;
                                }
                            }

                            this.prepend = prepend;
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.to == null) {
                                throw new Error("Missing option 'to' on "+(this.prepend?"prepend":"append")+" action");
                            }

                            if(this.options.to.property == null && this.options.to.variable == null) {
                                throw new Error("Missing option 'to.property' or 'to.variable' on "+(this.prepend?"prepend":"append")+" action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options) =>{
                                let items = [];

                                if(options.item != null) {
                                    items.push(options.item);
                                } else if(options.items != null) {
                                    items.push(...options.items);
                                } else {
                                    throw new Error("Missing 'item' or 'items' option on Append/Prepend action.");
                                }

                                if(options.to.property != null) {
                                    // Append to property array

                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.to.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Unable to "+(this.prepend?"prepend":"append")+" to non array type property ["+property.name+"] on ["+concept.name+"]");
                                    }

                                    let value = await property.getValue(target);

                                    if(self.prepend) {
                                        items.reverse().forEach((item)=>{
                                            value.unshift(item);
                                        });
                                    } else {
                                        items.forEach((item)=>{
                                            value.push(item);
                                        });
                                    }

                                    await property.setValue(target, value);
                                } else if(options.to.variable != null) {
                                    // Append to variable array
                                    let array = Action.getVariable(context, options.to.variable);

                                    if(self.prepend) {
                                        items.reverse().forEach((item)=>{
                                            array.unshift(item);
                                        });
                                    } else {
                                        items.forEach((item)=>{
                                            array.push(item);
                                        });
                                    }
                                }

                                return context;
                            });
                        }
                    }

                    /**
                     * An action "append" that can append an 'item' or a number of 'items' to an array, the array can be from either a property or a variable
                     * @memberOf ArrayActions
                     * @example
                     * // Append a string item to an array inside a property
                     * {
                     *     "append": {
                     *         "to": {"property": "myStringArrayProperty"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Append a string item to an array inside a property, on a non selected concept
                     * {
                     *     "append": {
                     *         "to": {"property": "myConcept.myStringArrayProperty"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Append a string item to an array inside a variable
                     * {
                     *     "append": {
                     *         "to": {"variable": "myStringArrayVariable"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Append a number of string items to an array inside a variable
                     * {
                     *     "append": {
                     *         "to": {"variable": "myStringArrayVariable"},
                     *         "items": ["myStringItem1", "myStringItem2"]
                     *     }
                     * }
                     */
                    class AppendAction extends AppendPrependAction {
                        static options() {
                            return {
                                "to": "enumValue[property,variable]",
                                "item": "raw"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept, false);
                        }
                    }
                    Action.registerPrimitiveAction("append", AppendAction)
                    window.AppendAction = AppendAction;

                    /**
                     * An action "prepend" that can prepend an 'item' or a number of 'items' to an array, the array can be from either a property or a variable
                     * @memberOf ArrayActions
                     * @example
                     * // Prepend a string item to an array inside a property
                     * {
                     *     "prepend": {
                     *         "to": {"property": "myStringArrayProperty"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Prepend a string item to an array inside a property, on a non selected concept
                     * {
                     *     "prepend": {
                     *         "to": {"property": "myConcept.myStringArrayProperty"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Prepend a string item to an array inside a variable
                     * {
                     *     "prepend": {
                     *         "to": {"variable": "myStringArrayVariable"},
                     *         "item": "myStringItem"
                     *     }
                     * }
                     *
                     * @example
                     * // Prepend a number of string items to an array inside a variable
                     * {
                     *     "prepend": {
                     *         "to": {"variable": "myStringArrayVariable"},
                     *         "items": ["myStringItem1", "myStringItem2"]
                     *     }
                     * }
                     */
                    class PrependAction extends AppendPrependAction {
                        static options() {
                            return {
                                "to": "enumValue[property,variable]",
                                "item": "raw"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept, true);
                        }
                    }
                    Action.registerPrimitiveAction("prepend", PrependAction)
                    window.PrependAction = PrependAction;

                    /**
                     * An action "insert" that inserts an 'item' or 'items' into an array property or variable, at a given index.
                     * @memberOf ArrayActions
                     * @example
                     * {
                     *      /Insert "myNewItem" at index 2, in the array at myArrayProperty
                     *     "insert": {
                     *         "to": {"property": "myArrayProperty"},
                     *         "index": 2,
                     *         "item": "myNewItem"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *      /Insert "myNewItem" at index 2, in the array at myVariableArray
                     *     "insert": {
                     *         "to": {"variable": "myVariableArray"},
                     *         "index": 2,
                     *         "item": "myNewItem"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *      /Insert multiple items at index 3, in the array at myVariableArray
                     *     "insert": {
                     *         "to": {"variable": "myVariableArray"},
                     *         "index": 3,
                     *         "items": ["myNewItem", "mySecondNewItem"]
                     *     }
                     * }
                     */
                    class InsertAction extends Action {
                        constructor(name, options, concept) {
                            super(name, options, concept);

                            if(this.options.to == null) {
                                if(this.options.property != null) {
                                    this.options.to = {
                                        property: this.options.property
                                    }

                                    delete this.options.property;
                                } else if(this.options.variable != null) {
                                    this.options.to = {
                                        variable: this.options.variable
                                    }

                                    delete this.options.variable;
                                }
                            }
                        }

                        async apply(contexts, actionArguments = {}) {
                            if(this.options.to == null) {
                                throw new Error("Missing option 'to' on "+(this.prepend?"prepend":"append")+" action");
                            }

                            if(this.options.index == null) {
                                throw new Error("Missing option 'index' on insert action");
                            }

                            if(this.options.to.property == null && this.options.to.variable == null) {
                                throw new Error("Missing option 'to.property' or 'to.variable' on "+(this.prepend?"prepend":"append")+" action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.index < 0) {
                                    throw new Error("Option 'index' can not be less than 0: "+options.index);
                                }

                                let array = null;
                                let arrayPropertyTarget = null;
                                let arrayProperty = null;

                                if(options.to.property != null) {
                                    // Append to property array

                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.to.property);

                                    if (lookup == null) {
                                        throw new Error("No property [" + options.of.property + "] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if (property.type !== "array") {
                                        throw new Error("Unable to " + (this.prepend ? "prepend" : "append") + " to non array type property [" + property.name + "] on [" + concept.name + "]");
                                    }

                                    arrayPropertyTarget = target;
                                    arrayProperty = property;

                                    array = await property.getValue(target);
                                } else if(options.to.variable != null) {
                                    array = Action.getVariable(context, options.to.variable);
                                }

                                if(array == null) {
                                    throw new Error("Unable to find array: "+JSON.stringify(options, null, 2)+" in 'insert'");
                                }

                                if(options.index > array.length) {
                                    throw new Error("Option 'index' can not be more than array length: "+array.length);
                                }

                                let items = [];

                                if(options.item != null) {
                                    items.push(options.item);
                                } else if(options.items != null) {
                                    items.push(...options.items);
                                } else {
                                    throw new Error("Missing option either 'item' or 'items' on insert action");
                                }

                                items.reverse().forEach((item)=>{
                                    array.splice(options.index, 0, item);
                                });

                                if(arrayProperty != null) {
                                    //If property, remember to set it
                                    await arrayProperty.setValue(arrayPropertyTarget, array);
                                }

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("insert", InsertAction)
                    window.InsertAction = InsertAction;

                    class RemoveFirstLastAction extends Action {
                        constructor(name, options, concept, removeFirst = false) {

                            //Shorthand { "remove-first": "propertyName" }
                            if(typeof options === "string") {
                                if(options.trim().startsWith("$")) {
                                    options = {
                                        "of": {
                                            "variable": options.trim().substring(1)
                                        }
                                    }
                                } else {
                                    options = {
                                        "of": {
                                            "property": options
                                        }
                                    }
                                }
                            }

                            super(name, options, concept);

                            if(this.options.of == null) {
                                if(this.options.property != null) {
                                    this.options.of = {
                                        property: this.options.property
                                    }

                                    delete this.options.property;
                                } else if(this.options.variable != null) {
                                    this.options.of = {
                                        variable: this.options.variable
                                    }

                                    delete this.options.variable;
                                }
                            }

                            this.removeFirst = removeFirst;
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.of == null) {
                                throw new Error("Missing option 'of' on "+(this.removeFirst?"remove-first":"remove-last")+" action");
                            }

                            if(this.options.of.property == null && this.options.of.variable == null) {
                                throw new Error("Missing option 'of.property' or 'of.variable' on "+(this.removeFirst?"remove-first":"remove-last")+" action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                if(options.of.property != null) {
                                    // remove of property

                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Unable to "+(this.removeFirst?"remove-first":"remove-last")+" of non array type property ["+property.name+"] on ["+concept.name+"]");
                                    }

                                    let value = await property.getValue(target);

                                    let result = null;

                                    if(self.removeFirst) {
                                        result = value.shift();
                                    } else {
                                        result = value.pop();
                                    }

                                    // Set back the changed array
                                    await property.setValue(target, value);

                                    // Set result variable
                                    Action.setVariable(context, variableName, result);
                                } else if(options.of.variable != null) {
                                    // remove of variable
                                    const variableValue = Action.getVariable(context, options.of.variable);

                                    if(!Array.isArray(variableValue)) {
                                        throw new Error("Variable ["+options.of.variable+"] was not of type array!");
                                    }

                                    let result = null;

                                    if(self.removeFirst) {
                                        result = variableValue.shift();
                                    } else {
                                        result = variableValue.pop();
                                    }

                                    // Set back the changed array
                                    Action.setVariable(context, options.of.variable, variableValue);

                                    // Set the result variable
                                    Action.setVariable(context, variableName, result);
                                }

                                return context;
                            });
                        }
                    }

                    /**
                     * An action "removeFirst" that can remove the first item of an array, and set a variable to the removed item
                     * @memberOf ArrayActions
                     * @example
                     * // Remove the first item from an array property
                     * {
                     *     "removeFirst": {
                     *         "of": {"property": "myArrayProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Remove the first item from an array property, on a non selected concept
                     * {
                     *     "removeFirst": {
                     *         "of": {"property": "myConcept.myArrayProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Remove the first item from an array property, shorthand notation, result will be in variable named "removeFirst"
                     * {
                     *     "removeFirst": "myArrayProperty"
                     * }
                     *
                     * @example
                     * // Remove the first item from an array variable
                     * {
                     *     "removeFirst": {
                     *         "of": {"variable": "myArrayVariable"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     */
                    class RemoveFirstAction extends RemoveFirstLastAction {
                        static options() {
                            return {
                                "of": "enumValue[property,variable]",
                                "as": "@string"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept, true);
                        }
                    }
                    Action.registerPrimitiveAction("removeFirst", RemoveFirstAction);
                    window.RemoveFirstAction = RemoveFirstAction;

                    /**
                     * An action "removeLast" that can remove the last item of an array, and set a variable to the removed item
                     * @memberOf ArrayActions
                     * @example
                     * // Remove the last item from an array property
                     * {
                     *     "removeLast": {
                     *         "of": {"property": "myArrayProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Remove the last item from an array property, on a non selected concept
                     * {
                     *     "removeLast": {
                     *         "of": {"property": "myConcept.myArrayProperty"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Remove the last item from an array property, shorthand notation, result will be in variable named "removeLast"
                     * {
                     *     "removeLast": "myArrayProperty"
                     * }
                     *
                     * @example
                     * // Remove the last item from an array variable
                     * {
                     *     "removeLast": {
                     *         "of": {"variable": "myArrayVariable"},
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     */
                    class RemoveLastAction extends RemoveFirstLastAction {
                        static options() {
                            return {
                                "of": "enumValue[property,variable]",
                                "as": "@string"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept, false);
                        }
                    }
                    Action.registerPrimitiveAction("removeLast", RemoveLastAction);
                    window.RemoveLastAction = RemoveLastAction;

                    /**
                     * An action "removeItem" that can remove 1 or X items from a given index in an array, the array can be in either a property or a variable
                     *
                     * If removeCount is 1, then the result will be just the item removed, if its > 1, then the result will be an array of the removed items
                     * @memberOf ArrayActions
                     * @example
                     * //Remove 1 items starting from index 1 of an array property
                     * {
                     *     "removeItem": {
                     *         "of": { "property": "myArrayProperty" },
                     *         "index": 1,
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Remove 2 items starting from index 1 of an array property
                     * {
                     *     "removeItem": {
                     *         "of": { "property": "myArrayProperty" },
                     *         "index": 1,
                     *         "removeCount": 2,
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Remove 2 items starting from index 1 af an array variable
                     * {
                     *     "removeItem": {
                     *         "of": { "variable": "myArrayVariable" },
                     *         "index": 1,
                     *         "removeCount": 2,
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     */
                    class RemoveItemAction extends Action {
                        static options() {
                            return {
                                "of": "enumValue[property,variable]",
                                "index": "number",
                                "removeCount": "@number",
                                "as": "@string"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept);

                            if(this.options.of == null) {
                                if(this.options.property != null) {
                                    this.options.of = {
                                        property: this.options.property
                                    }

                                    delete this.options.property;
                                } else if(this.options.variable != null) {
                                    this.options.of = {
                                        variable: this.options.variable
                                    }

                                    delete this.options.variable;
                                }
                            }
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.of == null) {
                                throw new Error("Missing option 'of' on removeItem action");
                            }

                            if(this.options.of.property == null && this.options.of.variable == null) {
                                throw new Error("Missing option 'of.property' or 'of.variable' on removeItem action");
                            }

                            if(this.options.index == null && this.options.item == null) {
                                throw new Error("Missing option either 'index' or 'item' on removeItem action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                let removeCount = 1;

                                if(options.removeCount != null) {
                                    removeCount = options.removeCount;
                                }

                                if(options.of.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Unable to removeItem of non array type property ["+property.name+"] on ["+concept.name+"]");
                                    }

                                    let value = await property.getValue(target);

                                    let index = 0;

                                    if(options.index != null) {
                                        index = options.index;
                                    } else if(options.item != null) {
                                        index = value.indexOf(options.item);
                                    }

                                    let result = value.splice(index, removeCount);

                                    if(result.length === 1) {
                                        result = result[0];
                                    }

                                    await property.setValue(target, value);

                                    Action.setVariable(context, variableName, result);
                                } else if(options.of.variable != null) {
                                    let value = Action.getVariable(context, options.of.variable);

                                    let index = 0;

                                    if(options.index != null) {
                                        index = options.index;
                                    } else if(options.item != null) {
                                        index = value.indexOf(options.item);
                                    }

                                    let result = value.splice(index, removeCount);

                                    if(result.length === 1) {
                                        result = result[0];
                                    }

                                    Action.setVariable(context, variableName, result);
                                }

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("removeItem", RemoveItemAction);
                    window.RemoveItemAction = RemoveItemAction;

                    /**
                     * An action 'items' that extracts an array property or variable into another variable, optionally applying filtering
                     * @memberOf ArrayActions
                     * @example
                     * //Shorthand, returns result into variable 'items' and applies no filtering
                     * {
                     *     "items": "myArrayProperty"
                     * }
                     *
                     * @example
                     * //Shorthand, returns result into variable 'items' and applies no filtering
                     * {
                     *     "items": "$myArrayVariable"
                     * }
                     *
                     * @example
                     * //Property example
                     * {
                     *     "items:" {
                     *         "property": "myArrayProperty",
                     *         "as": "myResultVariableName",
                     *         "where": {
                     *             "equals": "my-specific-value"
                     *         }
                     *     }
                     * }
                     *
                     * //Property example, on non selected concept
                     * {
                     *     "items:" {
                     *         "property": "myConcept.myArrayProperty",
                     *         "as": "myResultVariableName",
                     *         "where": {
                     *             "equals": "my-specific-value"
                     *         }
                     *     }
                     * }
                     *
                     * @example
                     * //Variable example
                     * {
                     *     "items:" {
                     *         "variable": "myArrayVariableName",
                     *         "as": "myResultVariableName",
                     *         "where": {
                     *             "equals": "my-specific-value"
                     *         }
                     *     }
                     * }
                     */
                    class ItemsAction extends Action {
                        static options() {
                            return {
                                "$items": "enumValue[property,variable]",
                                "as": "@string",
                                "where": "filter"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                if(options.trim().startsWith("$")) {
                                    options = {
                                        variable: options.trim().substring(1)
                                    }
                                } else {
                                    options = {
                                        property: options
                                    }
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.property == null && options.variable == null) {
                                    throw new Error("Action 'items' must have either option 'property' or 'variable'");
                                }

                                let resultName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    resultName = options.as;
                                }

                                let result = null;

                                if(options.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Property ["+options.property+"] of ["+concept.name+"] is not an array");
                                    }

                                    result = await property.getValue(target);
                                } else if(options.variable != null) {
                                    result = Action.getVariable(context, options.variable);

                                    if(!Array.isArray(result)) {
                                        throw new Error("Variable ["+options.variable+"] did not contain an array!");
                                    }
                                }

                                if(options.where != null) {
                                    let filteredResult = [];

                                    let filter = FilterAction.constructFilter(options.where, true);

                                    for(let v of result) {
                                        //TODO: Might backfire if an array of strings contains the string equal to a concept?
                                        let concept = await VarvEngine.getConceptFromUUID(v);
                                        if(concept != null) {
                                            v = {
                                                target: v
                                            }
                                        }

                                        if(await filter.filter(v)) {
                                            if(v.target != null) {
                                                v = v.target;
                                            }
                                            filteredResult.push(v);
                                        }
                                    }

                                    result = filteredResult;
                                }

                                Action.setVariable(context, resultName, result);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("items", ItemsAction);
                    window.ItemsAction = ItemsAction;

                    /**
                     * An action 'join' that joins an array into a string and saves it in a variable, default separator: ","
                     * @memberOf ArrayActions
                     * @example
                     * {
                     *     "join": {
                     *         "property": "myProperty",
                     *         "separator": ","
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "join": {
                     *         "variable": "myProperty",
                     *         "separator": ","
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand, joins the array in property "myArrayProperty" into a string
                     * {
                     *     "join": "myArrayProperty"
                     * }
                     *
                     * @example
                     * //Shorthand, joins the array in variable "myArrayVariable" into a string
                     * {
                     *     "join": "$myArrayVariable"
                     * }
                     */
                    class JoinAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                if(options.trim().startsWith("$")) {
                                    options = {
                                        of: {
                                            variable: options.trim().substring(1)
                                        }
                                    }
                                } else {
                                    options = {
                                        of: {
                                            property: options
                                        }
                                    }
                                }
                            }

                            if(options.property != null) {
                                options.of = {
                                    property: options.property
                                }

                                delete options.property;
                            }

                            if(options.variable != null) {
                                options.of = {
                                    variable: options.variable
                                }

                                delete options.variable;
                            }

                            const defaultOptions = {
                                "separator": ","
                            }

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                let result = null;

                                let inputArray = null;

                                if(options?.of.property != null) {
                                    let lookup = VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Property ["+options.of.property+"] of ["+concept.name+"] is not an array");
                                    }

                                    inputArray = property.getValue(target);

                                } else if(options?.of.variable != null) {
                                    inputArray = Action.getVariable(context, options.of.variable);
                                } else {
                                    throw new Error("'join' requires either option 'of.property' or option 'of.variable' to be present:"+JSON.stringify(options));
                                }

                                if(!Array.isArray(inputArray)) {
                                    throw new Error("Targeted variable or property, did not result in an array: "+JSON.stringify(options));
                                }

                                if(inputArray != null) {
                                    result = inputArray.join(options.separator);
                                }

                                let variableName = Action.defaultVariableName(self);
                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, result);

                                return context;
                            });
                        }
                    }
                    window.JoinAction = JoinAction;
                    Action.registerPrimitiveAction("join", JoinAction);

                    /**
                     * An action 'slice' that slices a string or an array.
                     *
                     * @memberOf ArrayActions
                     *
                     * @example
                     * //Slices mySliceableProperty starting from 0, ending with 10, saving the result in "myResultVariable"
                     * {
                     *     "slice": {
                     *         "of": {
                     *             "property": "mySliceableProperty"
                     *         },
                     *         "start": 0,
                     *         "end": 10,
                     *         "as": "myResultVariable"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand: Slices the variable "mySliceableVariable", from 0 to end, which in practice, means its a copy of the whole thing
                     * {
                     *     "slice: "mySliceableVariable"
                     * }
                     */
                    class SliceAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                if(options.startsWith("$")) {
                                    options = {
                                        "of": {
                                            "variable": options.trim().substring(1)
                                        }
                                    }
                                } else {
                                    options = {
                                        "of": {
                                            "property": options
                                        }
                                    }
                                }
                            }

                            if(options.property != null) {
                                options.of = {
                                    property: options.property
                                }

                                delete options.property;
                            }

                            if(options.variable != null) {
                                options.of = {
                                    variable: options.variable
                                }

                                delete options.variable;
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            const self = this;
                            return this.forEachContext(contexts, actionArguments, async (context, options)=> {
                                let theThingToSlice = null;

                                if(options.of == null) {
                                    throw new Error("'slice' requires option 'of' to be present:"+JSON.stringify(options));
                                }

                                if(options.of.variable != null) {
                                    //Handle variable
                                    theThingToSlice = Action.getVariable(context, options.of.variable);
                                } else if(options.of.property != null) {
                                    //Handle property
                                    let lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Property ["+options.property+"] of ["+concept.name+"] is not an array");
                                    }

                                    theThingToSlice = await property.getValue(target);
                                } else {
                                    throw new Error("'slice' requires option 'of.variable' or 'of.property' to be present:"+JSON.stringify(options));
                                }

                                if(theThingToSlice == null) {
                                    throw new Error("'slice' the chosen array was null: "+JSON.stringify(options));
                                }

                                if(theThingToSlice.slice == null) {
                                    throw new Error("'slice' unable to slice on type: "+(typeof theThingToSlice));
                                }

                                let start = 0;
                                let end = theThingToSlice.length;

                                if(options.start != null) {
                                    start = options.start;
                                }

                                if(options.end != null) {
                                    end = options.end;
                                }

                                let result = theThingToSlice.slice(start, end);

                                let variableName = Action.defaultVariableName(self);
                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, result);

                                return context;
                            });
                        }
                    }
                    window.SliceAction = SliceAction;
                    Action.registerPrimitiveAction("slice", SliceAction);

                    /**
                     * An action 'index' that finds the index of a given item in an array
                     *
                     * @example
                     * //Lookup the item "myLookupItem" inside the array property "myArrayProperty", and save the resulting index in the variable "myResultVariableName"
                     * {"index": {
                     *     "of": {
                     *         "property": "myArrayProperty"
                     *     },
                     *     "item": "myLookupItem",
                     *     "as": "myResultVariableName"
                     * }}
                     *
                     * @example
                     * //Shorthand, lookup the "myLookupItem" inside the property array "myArrayProperty", and saves the index in the variable "index"
                     * {"index": {"myArrayProperty": "myLookupItem"}}
                     */
                    class IndexAction extends Action {
                        constructor(name, options, concept) {
                            //Handle {"index": {"$myVariable": "myItem"}} shorthand
                            //Handle {"index": {"myProperty": "myItem"}} shorthand

                            if(Object.keys(options).length === 1) {
                                let key = Object.keys(options)[0];
                                let value = options[key];

                                if(key.startsWith("$")) {
                                    options = {
                                        "of": {
                                            "variable": key.substring(1)
                                        },
                                        "item": value
                                    }
                                } else {
                                    options = {
                                        "of": {
                                            "property": key
                                        },
                                        "item": value
                                    }
                                }
                            }

                            if(options.property != null) {
                                options.of = {
                                    property: options.property
                                }

                                delete options.property;
                            }

                            if(options.variable != null) {
                                options.of = {
                                    variable: options.variable
                                }

                                delete options.variable;
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            const self = this;
                            return this.forEachContext(contexts, actionArguments, async (context, options) => {

                                let theArray = null;

                                if(options.of == null) {
                                    throw new Error("'index' requires option 'of' to be present:"+JSON.stringify(options));
                                }

                                if(options.item == null) {

                                }

                                if(options.of.variable != null) {
                                    //Handle variable
                                    theArray = Action.getVariable(context, options.of.variable);
                                } else if(options.of.property != null) {
                                    //Handle property
                                    let lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.of.property);

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if(property.type !== "array") {
                                        throw new Error("Property ["+options.property+"] of ["+concept.name+"] is not an array");
                                    }

                                    theArray = await property.getValue(target);
                                } else {
                                    throw new Error("'index' requires option 'of.variable' or 'of.property' to be present:"+JSON.stringify(options));
                                }

                                if(theArray == null) {
                                    throw new Error("'index' the chosen array was null: "+JSON.stringify(options));
                                }

                                if(theArray.indexOf == null) {
                                    throw new Error("'index' unable to find index on type: "+(typeof theArray));
                                }

                                let index = theArray.indexOf(options.item);

                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, index);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("index", IndexAction);
                    window.IndexAction = IndexAction;

                    </SCRIPT><SCRIPT id="ContextActions-script" type="disabled">
                    /**
                     *  ContextActions - Actions that manipulate the context
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that change the current context
                     * @namespace ContextActions
                     */

                    // gate(filter) // filter context
                    // gate(filter... or=[])

                    /**
                     * An action "select" that selects a number of concepts of the given type, optionally filtered by a where condition
                     * <br />
                     * Options:
                     * <ul>
                     * <li>concept: The concept to select</li>
                     * <li>property: Select the concepts this property holds</li>
                     * <li>target: The specific uuid to select</li>
                     * <li>as: The variable name to save the selection as</li>
                     * <li>where: A filter spec for filtering on the selection</li>
                     * <li>forEach (false): If true the select action is run 1 time for each currently selected concept</li>
                     * <li>stopIfEmpty (false): If true, the action chain stops if nothing is selected</li>
                     * </ul>
                     * @memberOf ContextActions
                     * @example
                     * //Select all concepts of a type
                     * {
                     *     "select": {
                     *         "concept": "myConceptType"
                     *     }
                     * }
                     *
                     * @example
                     * //Select all concepts of a type, and save the selected uuids in the variable $mySelection
                     * {
                     *     "select": {
                     *         "concept": "myConceptType",
                     *         "as": "mySelection"
                     *     }
                     * }
                     *
                     * @example
                     * //Select all concepts of a type (Shorthand version)
                     * {
                     *     "select": "myConceptType"
                     * }
                     *
                     * @example
                     * //Select concept with given uuid
                     * {
                     *     "select": {
                     *         "target": "someuuid"  //Can also be an array: "target": ["uuid1", "uuid2"]
                     *     }
                     * }
                     *
                     * @example
                     * //Select concept saved in variable, shorthand
                     * {
                     *     "select": "$myConceptVariable"
                     * }
                     *
                     * @example
                     * //Select all concepts of a type, filtering for some property. (Also supports "or", "and" and "not" inside the where clause)
                     * {
                     *     "select": {
                     *         "concept": "myConceptType",
                     *         "where": {
                     *             "property": "color",
                     *             "equals": "yellow"
                     *         }
                     *     }
                     * }
                     *
                     * @example
                     * //Select all concepts of a type, filtering using a calculation
                     * {
                     *     "select": {
                     *         "concept": "myConceptType",
                     *         "where": {
                     *             "calculate": "$myConceptType.myProperty$ + 10",
                     *             "equals": "15"
                     *         }
                     *     }
                     * }
                     *
                     * @example
                     * //Select all concepts of a type, filtering using lastTarget (only available in forEach)
                     * {
                     *     "select": {
                     *         "concept": "myConceptType",
                     *         "where": {
                     *             "property": "myConceptType.uuid",
                     *             "equals": "lastTarget.uuid$"
                     *         },
                     *         "forEach": true
                     *     }
                     * }
                     */
                    class SelectAction extends Action {
                        static options() {
                            return {
                                "$selectType": "enumValue[concept,property,variable]",
                                "where": "filter",
                                "as": "@string",
                                "forEach": "boolean%false",
                                "stopIfEmpty": "boolean%false"
                            };
                        }

                        constructor(name, options, concept) {
                            //Handle shorthand
                            if(typeof options === "string") {
                                if(options.trim().startsWith("$")) {
                                    options = {
                                        target: options
                                    }
                                } else {
                                    options = {
                                        concept: options
                                    }
                                }
                            }

                            const defaultOptions = {
                                forEach: false,
                                stopIfEmpty: false
                            };

                            options = Object.assign({}, defaultOptions, options);

                            let wherePart = options.where;
                            delete options.where;

                            super(name, options, concept);

                            this.wherePart = wherePart;
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            const DEBUG_SELECT = false;

                            async function doSelect(context, options, originalOptions) {
                                let mark = VarvPerformance.start();

                                if(DEBUG_SELECT) {
                                    console.group("doSelect");
                                    console.log("Context:", context);
                                    console.log("Options:", options);
                                    console.log("Where:", self.wherePart);
                                }

                                let conceptUUIDs = [];
                                let doFilter = true;

                                if(options.concept != null) {
                                    //Select concept from type
                                    if(DEBUG_SELECT) {
                                        console.log("Concept selection...");
                                    }

                                    doFilter = false;

                                    let filter = null;

                                    if(self.wherePart) {
                                        let clonedVariables = Object.assign({}, context.variables);

                                        let filterContext = {target: null, lastTarget: context.target, variables: clonedVariables};

                                        let lookupWhereWithArguments = await Action.lookupArguments(self.wherePart, actionArguments);

                                        let lookupWhereOptions = await Action.lookupVariables(lookupWhereWithArguments, filterContext);

                                        filter = await FilterAction.constructFilter(lookupWhereOptions);
                                    }

                                    let limit = 0;

                                    if(options.limit != null) {
                                        limit = options.limit;
                                    }

                                    conceptUUIDs = await VarvEngine.lookupInstances(VarvEngine.getAllImplementingConceptNames(options.concept), filter, context, limit, self.concept);

                                } else if(options.target != null) {
                                    if(DEBUG_SELECT) console.log("Selecting target:", options.target);

                                    //Select concept from target
                                    if (Array.isArray(options.target)) {
                                        conceptUUIDs.push(...options.target);
                                    } else {
                                        conceptUUIDs.push(options.target);
                                    }

                                    //Filter
                                    let filterResults = conceptUUIDs.map((uuid)=>{
                                        return VarvEngine.getConceptFromUUID(uuid);
                                    });

                                    filterResults = await Promise.all(filterResults);

                                    conceptUUIDs = conceptUUIDs.filter((uuid, index)=>{
                                        let shouldKeep = filterResults[index] != null;

                                        if(!shouldKeep) {
                                            console.warn("Could not find any concept with uuid: ["+uuid+"], ignoring!");
                                        }

                                        return shouldKeep;
                                    });
                                } else if(options.property != null) {
                                    //Select concept from property of type concept or concept[]
                                    let lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        if(DEBUG_SELECT) {
                                            console.groupEnd();
                                        }
                                        throw new Error("No property ["+options.property+"] found!");
                                    }

                                    if(lookup.property.isConceptType()) {
                                        let value = await lookup.property.getValue(lookup.target)
                                        conceptUUIDs.push(value);
                                    } else if(lookup.property.isConceptArrayType()) {
                                        let value = await lookup.property.getValue(lookup.target)
                                        conceptUUIDs.push(...value);
                                    } else {
                                        if(DEBUG_SELECT) {
                                            console.groupEnd();
                                        }
                                        throw new Error("Only able to select properties that are of concept or concept array type: ["+options.property+":"+lookup.property.type+"]");
                                    }

                                } else {
                                    if(DEBUG_SELECT) {
                                        console.groupEnd();
                                    }
                                    throw new Error("Missing option 'concept' or 'target' on select action");
                                }

                                //Filtering already done?

                                if(doFilter) {
                                    let filterMark= VarvPerformance.start();
                                    let filteredUUIDs = [];

                                    if (self.wherePart != null) {
                                        let lookupWhereWithArguments = await Action.lookupArguments(self.wherePart, actionArguments);

                                        let allPromises = [];

                                        for (let uuid of conceptUUIDs) {
                                            let clonedVariables = Object.assign({}, context.variables);

                                            let filterContext = {target: uuid, lastTarget: context.target, variables: clonedVariables};

                                            let lookupWhereOptions = await Action.lookupVariables(lookupWhereWithArguments, filterContext);

                                            let filter = await FilterAction.constructFilter(lookupWhereOptions);

                                            allPromises.push(filter.filter(filterContext, self.concept));
                                        }

                                        let filterResult = await Promise.all(allPromises);

                                        let index = 0;
                                        for (let uuid of conceptUUIDs) {
                                            if(filterResult[index]) {
                                                filteredUUIDs.push(uuid);
                                            }
                                            index++;
                                        }

                                    } else {
                                        filteredUUIDs.push(...conceptUUIDs);
                                    }
                                    VarvPerformance.stop("SelectAction.doSelect.filtering", filterMark, {filter: self.wherePart, numConcepts: conceptUUIDs.length});

                                    conceptUUIDs = filteredUUIDs;
                                }

                                let result = null;
                                if (options.keepContext){
                                    Action.setVariable(context, options.as?options.as:"select", conceptUUIDs);
                                    result = [context];
                                } else {
                                    result = conceptUUIDs.map((uuid)=>{
                                        // Turn into context
                                        let newContext = Object.assign({}, context, {target: uuid});
                                        //Make sure the target variable from commonVariables, does not bleed out, since we just set a correct target.
                                        delete newContext.variables["target"];
                                        return newContext;
                                    });

                                    if(options.as) {
                                        result.forEach((resultContext)=>{
                                            Action.setVariable(resultContext, options.as, conceptUUIDs);
                                        });
                                    }
                                }

                                VarvPerformance.stop("SelectAction.doSelect", mark);

                                if(DEBUG_SELECT) {
                                    console.groupEnd();
                                }

                                return result;
                            }

                            let result = [];

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            if(optionsWithArguments.forEach) {
                                //Individual mode
                                result = await this.forEachContext(contexts, actionArguments,async (context, options)=>{
                                    return await doSelect(context, options, optionsWithArguments);
                                });
                            } else {
                                //Bulk mode

                                //Find any common variables and keep
                                let commonVariables = Action.getCommonVariables(contexts);

                                let commonTarget = -1;

                                contexts.forEach((context)=>{
                                    if(commonTarget === -1) {
                                        commonTarget = context.target;
                                    } else {
                                        if(commonTarget !== context.target) {
                                            commonTarget = null;
                                        }
                                    }
                                });

                                let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {target: commonTarget, variables: commonVariables});
                                result = await doSelect({target: commonTarget, variables: commonVariables}, optionsWithVariablesAndArguments, optionsWithArguments);
                            }

                            if(optionsWithArguments.stopIfEmpty && result.length === 0) {
                                throw new StopError("Action '"+self.name+"' had no output, and 'stopIfEmpty' was set!");
                            }

                            return result;
                        }
                    }
                    Action.registerPrimitiveAction("select", SelectAction);
                    window.SelectAction = SelectAction;

                    /**
                     * An action 'storeSelection' that stores the current concept selection as a variable
                     * @memberOf ContextActions
                     * @example
                     * {
                     *     "storeSelection": {
                     *         "as": "mySelectionVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand
                     * {
                     *     "storeSelection": "mySelectionVariableName"
                     * }
                     */
                    class StoreSelectionAction extends Action {
                        static options() {
                            return {
                                "as": "@string"
                            };
                        }

                        constructor(name, options, concept) {

                            if(typeof options === "string") {
                                options = {
                                    "as": options
                                };
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            let uuids = contexts.filter((context)=>{
                                return context.target != null;
                            }).map((context)=>{
                                return context.target;
                            });

                            let variableName = Action.defaultVariableName(this);

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            let commonVariables = Action.getCommonVariables(contexts);
                            let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {variables: commonVariables});

                            if(optionsWithVariablesAndArguments.as) {
                                variableName = optionsWithVariablesAndArguments.as;
                            }

                            contexts.forEach((context)=>{
                                Action.setVariable(context, variableName, uuids.slice());
                            })

                            return contexts;
                        }
                    }
                    Action.registerPrimitiveAction("storeSelection", StoreSelectionAction);
                    window.StoreSelectionAction = StoreSelectionAction;

                    /**
                     * An action "limit" that limits the current selected concepts to a given count, starting from first or last
                     * @memberOf ContextActions
                     * @example
                     * //Limit concepts to 1, starting from first
                     * {
                     *     "limit": {
                     *         "count": 1,
                     *         "last": false
                     *     }
                     * }
                     *
                     * @example
                     * //Limit concepts to 1, starting from first (shorthand version)
                     * {
                     *     "limit": 1
                     * }
                     *
                     * @example
                     * //Limit concepts to 2, starting from last
                     * {
                     *     "limit": {
                     *         "count": 2,
                     *         "last": true
                     *     }
                     * }
                     */
                    class LimitAction extends Action {
                        static options() {
                            return {
                                "count": "number",
                                "last": "boolean%false"
                            };
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "number") {
                                options = {
                                    count: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            return this.forEachContext(contexts, actionArguments, (context, options, index)=>{
                                if(options.count == null) {
                                    throw new Error("Missing option 'count' on action 'limit'");
                                }

                                if(options.last === true) {
                                    //Allow the last "count" elements through
                                    if(index >= contexts.length - options.count) {
                                        return context;
                                    }
                                } else {
                                    //Allow the first "count" elements through
                                    if(index <= options.count-1) {
                                        return context;
                                    }
                                }
                            });
                        }
                    }
                    Action.registerPrimitiveAction("limit", LimitAction);
                    window.LimitAction = LimitAction;

                    /**
                     * An action "where" that filters on the currently selected concepts
                     *
                     * If the option "stopIfEmpty" is set to true, the action chain will terminate after the where action, if no concepts
                     * survived the filtering.
                     * <p>
                     * Available operators for property/variable/value filter:
                     * </p>
                     *
                     * <ul>
                     * <li>"equals" - "number", "boolean", "string", "concept", "array"</li>
                     * <li>"unequals" - "number", "boolean", "string", "concept", "array"</li>
                     * <li>"greaterThan" - "number", "string"</li>
                     * <li>"lessThan" - "number", "string"</li>
                     * <li>"greaterOrEquals" - "number", "string"</li>
                     * <li>"lessOrEquals" - "number", "string"</li>
                     * <li>"startsWith" - "string"</li>
                     * <li>"endsWith" - "string"</li>
                     * <li>"includes" - "string", "array"</li>
                     * <li>"includesAny" - "array"</li>
                     * <li>"includesAll" - "array"</li>
                     * <li>"matches" - "string"</li>
                     * </ul>
                     * @memberOf ContextActions
                     * @example
                     * {
                     *     "where": {
                     *         "or": [
                     *             {
                     *                 "calculate": "10 + $myVariable$",
                     *                 "equals": 15
                     *             },
                     *             {
                     *                 "not": {
                     *                     "variable": "myVariableName",
                     *                     "equals": "myVariableValue"
                     *                 }
                     *             },
                     *             {
                     *                 "not": {
                     *                     "property": "myProperty",
                     *                     "equals": "myPropertyValue"
                     *                 }
                     *             },
                     *             {
                     *                 "and": [
                     *                     {
                     *                         "property": "myOtherProperty",
                     *                         "unequals": "somethingelse"
                     *                     },
                     *                     {
                     *                         "property": "myThirdProperty",
                     *                         "lowerThan": 10
                     *                     }
                     *                 ]
                     *             }
                     *         ]
                     *     }
                     * }
                     */
                    class FilterAction extends Action {
                        static options() {
                            return {
                                "$where": "filter",
                                "stopIfEmpty": "boolean%false"
                            };
                        }
                        constructor(name, options, concept) {
                            const defaultOptions = {
                                stopIfEmpty: false
                            };

                            options = Object.assign({}, defaultOptions, options);

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            let result = await this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let mark = VarvPerformance.start();

                                try {
                                    let filter = FilterAction.constructFilter(options);

                                    let shouldKeep = await filter.filter(context, this.concept);

                                    VarvPerformance.stop("FilterAction.forEachContext.loop", mark);

                                    if (shouldKeep) {
                                        return context;
                                    }
                                } catch(e) {
                                    console.error(e);
                                }

                                return null;
                            });

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            if(optionsWithArguments.stopIfEmpty && result.length === 0) {
                                throw new StopError("Action '"+self.name+"' had no output, and 'stopIfEmpty' was set!");
                            }

                            return result;
                        }

                        static constructFilter(options) {
                            let filter = FilterAction.constructFilterInternal(options);
                            filter.constructOptions = options;
                            return filter;
                        }

                        static constructFilterInternal(options) {
                            try {
                                let operator = null;

                                for(let op in FilterOps) {
                                    if(typeof options[op] !== "undefined") {
                                        operator = op;
                                        break;
                                    }
                                }

                                if (operator !== null) {
                                    let value = options[operator];

                                    if(operator === "hasProperty") {
                                        return new FilterPropertyExists(value);
                                    }
                                    if(operator === "propertyType") {
                                        return new FilterPropertyType(options.property, value);
                                    }

                                    if(options.calculation != null) {
                                        //Property defined, this is a property filter
                                        return new FilterCalc(options.calculation, operator, value);
                                    }

                                    if(options.property != null) {
                                        //Property defined, this is a property filter
                                        return new FilterProperty(options.property, operator, value);
                                    }

                                    if(options.variable != null) {
                                        //Variable defined, this is a variable filter
                                        return new FilterVariable(options.variable, operator, value);
                                    }

                                    return new FilterValue(operator, value);
                                } else {
                                    //This should be an "and", "or", "not" or concept filter

                                    if(options.concept != null) {
                                        if(options.includeOthers != null) {
                                            return new FilterConcept(options.concept, options.includeOthers);
                                        }

                                        //Concept defined, this is a concept filter
                                        return new FilterConcept(options.concept);
                                    }

                                    if (options.or != null) {
                                        let orFilters = [];

                                        options.or.forEach((filterOptions) => {
                                            orFilters.push(FilterAction.constructFilter(filterOptions));
                                        });

                                        return new FilterOr(orFilters);
                                    } else if (options.and != null) {
                                        let andFilters = [];

                                        options.and.forEach((filterOptions) => {
                                            andFilters.push(FilterAction.constructFilter(filterOptions));
                                        });

                                        return new FilterAnd(andFilters);
                                    } else if (options.not != null) {
                                        return new FilterNot(FilterAction.constructFilter(options.not));
                                    }
                                }
                            } catch(e) {
                                console.error(e);
                            }

                            console.warn("No filter constructed using:", options);

                            return null;
                        }
                    }
                    Action.registerPrimitiveAction("where", FilterAction);
                    window.FilterAction = FilterAction;

                    /**
                     * An action "new" that creates a new concept, optionally setting properties on it as well.
                     * Runs in bulk mode unless 'forEach: true' is set. In bulk mode only 1 new concept is created, else 1 new would be created for every currently selected concept.
                     * 'select: false' is not supported in bulk mode ('forEach: false')
                     *
                     *
                     * @memberOf ContextActions
                     * @example
                     * {
                     *      "new": {
                     *          "concept": "myConcept",
                     *          "with": {
                     *              "myFirstProperty": "someValue",
                     *              "mySecondProperty": false
                     *              "myThirdProperty": "$myVariableName"
                     *          }
                     *      }
                     * }
                     *
                     * @example
                     * //Run in non-bulk mode, creates 1 "myConcept" for each currently selected concept
                     * {
                     *      "new": {
                     *          "concept": "myConcept",
                     *          "forEach": true
                     *      }
                     * }
                     *
                     * @example
                     * //Same as other example, but don't change the current selection, which means that the newly created concept is only passed along as a variable
                     * {
                     *      "new": {
                     *          "concept": "myConcept",
                     *          "with": {
                     *              "myFirstProperty": "someValue",
                     *              "mySecondProperty": false
                     *              "myThirdProperty": "$myVariableName"
                     *          },
                     *          "as": "myVariableName",
                     *          "select": false
                     *      }
                     * }
                     */
                    class NewAction extends Action {
                        static options() {
                            return {
                                "concept": "string",
                                "with": "propertyList",
                                "as": "@string",
                                "select": "boolean%true"
                            }
                        }
                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                options = {
                                    concept: options
                                }
                            }

                            const defaultOptions = {
                                select: true,
                                forEach: false
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            async function doNew(context, options) {
                                let concept = VarvEngine.getConceptFromType(options.concept);

                                let uuid = await concept.create(null, options.with);

                                let variableName = Action.defaultVariableName(self);

                                if (options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, uuid);

                                let select = options.select;

                                if(options.forEach == false) {
                                    if(!select) {
                                        console.warn("Uncompatible options for 'new' action - select: false and forEach: false. Bulk mode always selects the newly created instance")
                                    }

                                    select = true;
                                }

                                if(select) {
                                    context.target = uuid;
                                }

                                return context;
                            }

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            let result = [];

                            if(optionsWithArguments.forEach) {
                                result = await this.forEachContext(contexts, actionArguments, async (context, options) => {
                                    return await doNew(context, options);
                                });
                            } else {
                                //Bulk mode

                                //Find any common variables and keep
                                let commonVariables = Action.getCommonVariables(contexts);

                                let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {variables: commonVariables});

                                result = [await doNew({variables: commonVariables}, optionsWithVariablesAndArguments)];
                            }

                            return result;
                        }
                    }
                    Action.registerPrimitiveAction("new", NewAction);
                    window.NewAction = NewAction;

                    /**
                     * An action "remove" that removes instances of concepts
                     * @memberOf ContextActions
                     * @example
                     * //Remove the current context target
                     * {
                     *     "remove"
                     * }
                     *
                     * @example
                     * // Remove the concept or concepts (if variable points to an array) that the variable holds
                     * {
                     *     "remove": "$someVariable"
                     * }
                     */
                    class RemoveAction extends Action {
                        static options() {
                            return {
                                "target": "@string"
                            };
                        }

                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    target: options
                                }
                            }
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                let removeUuids = options.target;

                                if(removeUuids == null) {
                                    if(context.target == null) {
                                        throw new Error("No uuid's supplied to be removed, and context.target is non existant");
                                    }

                                    //No remove option specified, remove current target
                                    removeUuids = context.target;

                                    context.target = null;
                                }

                                if(!Array.isArray(removeUuids)) {
                                    removeUuids = [removeUuids];
                                }

                                for(let uuid of removeUuids) {
                                    let concept = await VarvEngine.getConceptFromUUID(uuid);
                                    await concept.delete(uuid);
                                }

                                //Return null, to signal that this target/context is now invalid.
                                return null;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("remove", RemoveAction);
                    window.RemoveAction = RemoveAction;

                    /**
                     * An action "eval" that takes a filter, and sets a variable to true/false, depending on if the filter matched or not
                     * @memberOf ContextActions
                     * @example
                     * {
                     *     "eval": {
                     *         "and": [
                     *             { "property": "myFirstProperty", "equals": false },
                     *             { "property": "mySecondProperty", "equals": false }
                     *         ]
                     *     }
                     * }
                     */
                    class EvalAction extends Action {
                        static options() {
                            return {
                                "$eval": "filter",
                                "as": "@string"
                            };
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;
                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                let filter = FilterAction.constructFilter(options);

                                let shouldFilter = await filter.filter(context);

                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, shouldFilter);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("eval", EvalAction);
                    window.EvalAction = EvalAction;

                    /**
                     * An action "count" that counts how many concepts exists with the given where filter. Sets a variable to the count
                     * @memberOf ContextActions
                     * @example
                     * // Counts how many "myConcept" that matches the given "where" filter, and saves the result as "myResultVariableName"
                     * {
                     *     "count": {
                     *         "concept": "myConcept",
                     *         "where": {
                     *             "property": "myProperty",
                     *             "equals": "myTestValue"
                     *         },
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Counts how many "myConcept" there is, and saves the result as "count"
                     * {
                     *     "count": "myConcept
                     * }
                     */
                    class CountAction extends SelectAction {
                        static options() {
                            return {
                                "$selectType": "enumValue[concept]",
                                "where": "filter",
                                "as": "@string",
                                "forEach": "boolean%false"
                            };
                        }

                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    concept: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            async function doCount(context, options) {
                                if(options.concept == null) {
                                    throw new Error("Count requires an option 'concept'");
                                }

                                let filter = null;

                                if(self.wherePart) {
                                    let clonedVariables = Object.assign({}, context.variables);

                                    let filterContext = {target: null, lastTarget: context.target, variables: clonedVariables};

                                    let lookupWhereWithArguments = await Action.lookupArguments(self.wherePart, actionArguments);

                                    let lookupWhereOptions = await Action.lookupVariables(lookupWhereWithArguments, filterContext);

                                    filter = await FilterAction.constructFilter(lookupWhereOptions);
                                }

                                return await VarvEngine.countInstances(VarvEngine.getAllImplementingConceptNames(options.concept), filter, context, 0, self.concept);
                            }

                            if(optionsWithArguments.forEach) {
                                return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                    let clonedContext = Action.cloneContext(context);

                                    let count = await doCount(clonedContext, options);

                                    let variableName = Action.defaultVariableName(self);

                                    if(options.as != null) {
                                        variableName = options.as;
                                    }

                                    Action.setVariable(context, variableName, count);

                                    return context;
                                });
                            } else {
                                //Bulk mode
                                //Find any common variables and keep
                                let commonVariables = Action.getCommonVariables(contexts);

                                let commonTarget = -1;

                                contexts.forEach((context)=>{
                                    if(commonTarget === -1) {
                                        commonTarget = context.target;
                                    } else {
                                        if(commonTarget !== context.target) {
                                            commonTarget = null;
                                        }
                                    }
                                });

                                let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {target: commonTarget, variables: commonVariables});

                                let count = await doCount({target: commonTarget, variables: commonVariables}, optionsWithVariablesAndArguments);

                                return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                    let variableName = Action.defaultVariableName(self);

                                    if(options.as != null) {
                                        variableName = options.as;
                                    }

                                    Action.setVariable(context, variableName, count);

                                    return context;
                                });
                            }
                        }
                    }
                    Action.registerPrimitiveAction("count", CountAction);
                    window.CountAction = CountAction;

                    /**
                     * An action "exists" that checks if any concepts exists with the given where filter. Sets a variable to true/false depending.
                     * @memberOf ContextActions
                     * @example
                     * // Sets a variable "myResultVariableName" to true/false depending on if any "myConcept" that matches the where filter exists
                     * {
                     *     "exists": {
                     *         "concept": "myConcept",
                     *         "where": {
                     *             "property": "myProperty",
                     *             "equals": "myTestValue"
                     *         },
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * // Sets a variable "exists" to true/false depending on if any "myConcept" exists
                     * {
                     *     "exists": "myConcept"
                     * }
                     */
                    class ExistsAction extends SelectAction {
                        static options() {
                            return {
                                "$selectType": "enumValue[concept]",
                                "where": "filter",
                                "as": "@string",
                                "forEach": "boolean%false"
                            };
                        }

                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    concept: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            async function doExists(context, options) {
                                if(options.concept == null) {
                                    throw new Error("Exists requires an option 'concept'")
                                }

                                let filter = null;

                                if(self.wherePart) {
                                    let clonedVariables = Object.assign({}, context.variables);

                                    let filterContext = {target: null, lastTarget: context.target, variables: clonedVariables};

                                    let lookupWhereWithArguments = await Action.lookupArguments(self.wherePart, actionArguments);

                                    let lookupWhereOptions = await Action.lookupVariables(lookupWhereWithArguments, filterContext);

                                    filter = await FilterAction.constructFilter(lookupWhereOptions);
                                }

                                return await VarvEngine.existsInstance(VarvEngine.getAllImplementingConceptNames(options.concept), filter, context, 1, self.concept);
                            }

                            if(optionsWithArguments.forEach) {
                                return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                    let clonedContext = Action.cloneContext(context);

                                    let exists = await doExists(clonedContext, options);

                                    let variableName = Action.defaultVariableName(self);

                                    if(options.as != null) {
                                        variableName = options.as;
                                    }

                                    Action.setVariable(context, variableName, exists);

                                    return context;
                                });
                            } else {
                                //Bulk mode
                                //Find any common variables and keep
                                let commonVariables = Action.getCommonVariables(contexts);

                                let commonTarget = -1;

                                contexts.forEach((context)=>{
                                    if(commonTarget === -1) {
                                        commonTarget = context.target;
                                    } else {
                                        if(commonTarget !== context.target) {
                                            commonTarget = null;
                                        }
                                    }
                                });

                                let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {target: commonTarget, variables: commonVariables});

                                let exists = await doExists({target: commonTarget, variables: commonVariables}, optionsWithVariablesAndArguments);

                                return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                    let variableName = Action.defaultVariableName(self);

                                    if(options.as != null) {
                                        variableName = options.as;
                                    }

                                    Action.setVariable(context, variableName, exists);

                                    return context;
                                });
                            }
                        }
                    }
                    Action.registerPrimitiveAction("exists", ExistsAction);
                    window.ExistsAction = ExistsAction;

                    /**
                     * An action 'sort' that sorts the selected concepts naturally based on a property/variable, can be sorted either ascending or descending.
                     *
                     * Always sorts "naturally", and only supports string, number and boolean types.
                     * @memberOf ContextActions
                     * @example
                     * {"sort": {
                     *     "property": "myProperty",
                     *     "order": "asc"
                     * }}
                     *
                     * @example
                     * {"sort": {
                     *     "variable": "myVariable",
                     *     "order": "desc"
                     * }}
                     *
                     * @example
                     * //Shorthand sorts ascending on property
                     * {"sort": "myProperty"}
                     */
                    class SortAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    "property": options
                                }
                            }

                            if(options.order == null) {
                                options.order = "asc"
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            if(optionsWithArguments.property == null && optionsWithArguments.variable == null) {
                                throw new Error("Missing option property or variable on sort action");
                            }

                            const sortedContexts = await Promise.all(contexts.map(async (context)=> {
                                let obj = {
                                    c: context,
                                    t: await VarvEngine.getConceptFromUUID(context.target),
                                };

                                if(optionsWithArguments.property) {
                                    //We have an invariant that says that all selected concepts are of same type
                                    console.warn("TODO: Implement some fix for polymorphism enabled sort");
                                    const concept = obj.t;
                                    if(concept == null) {
                                        throw new Error("Unable to find concept for uuid ["+obj.c.target+"]");
                                    }

                                    const property = concept.getProperty(optionsWithArguments.property);
                                    if(property == null) {
                                        throw new Error("Unable to find property ["+optionsWithArguments.property+"] on ["+concept.name+"]");
                                    }

                                    let value = await property.getValue(obj.c.target);
                                    obj.v = value;
                                } else {
                                    //Variable
                                    let value = Action.getVariable(obj.c, optionsWithArguments.variable);
                                    obj.v = value;
                                }

                                return obj;
                            }));

                            sortedContexts.sort((c1, c2)=>{
                                let s1 = c1.v;
                                let s2 = c2.v;

                                if(typeof s1 !== typeof s2) {
                                    throw new Error("Unable to sort when not the same type: ("+s1+") - ("+s2+")");
                                }

                                if(typeof s1 === "number") {
                                    return s1 - s2;
                                } else if(typeof s1 === "string") {
                                    return s1.localeCompare(s2);
                                } else if(typeof s1 === "boolean") {
                                    return s1 - s2;
                                } else {
                                    console.warn("Unable to sort "+(typeof s1));
                                }
                            });

                            return sortedContexts.map((o)=>{
                                return o.c;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("sort", SortAction);
                    window.SortAction = SortAction;


                    /**
                     * An action "clone" that copies instances of concepts
                     * @memberOf ContextActions
                     * @example
                     * // Clone the current context target
                     * {
                     *     "clone"
                     * }
                     *
                     * @example
                     * // Clone the concepts referenced in $myUuidArray
                     * {"clone": {
                     *  "of": "$myUuidArray"
                     * }}
                     *
                     * @example
                     * //Do a deep clone of current context target, setting the variable "myVariable" to the result, not selecting the new clone
                     * {"clone: {
                     *     "deep": true,
                     *     "select": false,
                     *     "as": "myVariable"
                     * }}
                     *
                     */
                    class CloneAction extends Action {
                        static options() {
                            return {
                                "target": "@string"
                            };
                        }

                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    of: options
                                }
                            }
                            const defaultOptions = {
                                select: true,
                                deep: false
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let cloneUUIDs = options.of;

                                if(cloneUUIDs == null) {
                                    if(context.target == null) {
                                        throw new Error("No uuid's in 'of' option supplied to be cloned, and context.target is non existant");
                                    }

                                    // No clone option specified, clone current target
                                    cloneUUIDs = context.target;
                                }

                                if(!Array.isArray(cloneUUIDs)) {
                                    cloneUUIDs = [cloneUUIDs];
                                }

                                let resultingContexts = [];

                                let newUUIDs = [];
                                for(let uuid of cloneUUIDs) {
                                    let concept = await VarvEngine.getConceptFromUUID(uuid);
                                    let clone = await concept.clone(uuid, options.deep);
                                    newUUIDs.push(clone);
                                }

                                // Handle "as" before creating result contexts as it needs to be on all of them.
                                let variableName = Action.defaultVariableName(self);

                                if (options.as != null) {
                                    variableName = options.as;
                                }

                                if(options.select) {
                                    //Select the new clones
                                    for(let uuid of newUUIDs) {
                                        let resultContext = Action.cloneContext(context);
                                        resultContext.target = uuid;

                                        let variableValue = newUUIDs;
                                        if(newUUIDs.length === 1) {
                                            variableValue = uuid;
                                        }

                                        Action.setVariable(resultContext, variableName, variableValue);
                                        resultingContexts.push(resultContext);
                                    }

                                    return resultingContexts;
                                } else {
                                    //Keep our old context selected
                                    if(newUUIDs.length === 1) {
                                        newUUIDs = newUUIDs[0];
                                    }

                                    Action.setVariable(context, variableName, newUUIDs);
                                    return context;
                                }
                            });
                        }
                    }
                    Action.registerPrimitiveAction("clone", CloneAction);
                    window.CloneAction = CloneAction;

                    /**
                     * An action 'setType' that can change the type of a concept instance, highly experimental
                     *
                     * @memberOf ContextActions
                     *
                     * @example
                     * //Changes the type of all currently selected concept instances to "myNewConcept"
                     * {
                     *     "setType": {"concept": "myNewConcept"}
                     * }
                     *
                     * @example
                     * //Shorthand
                     * {"setType": "myNewConcept"}
                     */
                    class SetTypeAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    concept: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options) => {
                                if(options.concept == null) {
                                    throw new Error("Missing concept in action 'setType'");
                                }

                                let targetConcept = VarvEngine.getConceptFromType(options.concept);

                                if(targetConcept == null) {
                                    throw new Error("Unknown concept \""+options.concept+"\" in action 'setType'");
                                }

                                if(context.target != null) {
                                    let concept = await VarvEngine.getConceptFromUUID(context.target);

                                    if(concept != null) {
                                        await VarvEngine.switchConceptType(context.target, targetConcept, concept);
                                    }
                                } else {
                                    throw new Error("Missing context.target in action 'setType'");
                                }

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("setType", SetTypeAction);
                    window.SetTypeAction = SetTypeAction;

                    </SCRIPT><SCRIPT id="MathActions-script" type="disabled">
                    /**
                     *  MathActions - Actions that calculate math
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that do math
                     * @namespace MathActions
                     */

                    class IncrementDecrementAction extends Action {
                        constructor(name, decrement, options, concept) {
                            // Handle string shorthand
                            if(typeof options === "string"){
                                options = {
                                    property: options
                                }
                            }

                            const defaultOptions = {
                                by: 1
                            }

                            super(name, Object.assign({}, defaultOptions, options), concept);

                            this.decrement = decrement;
                        }

                        /**
                         * @param {VarvContext[]} context
                         * @returns {Promise<VarvContext[]>}
                         */
                        async apply(contexts, actionArguments = {}) {
                            const self = this;

                            if(this.options.property == null && this.options.variable == null) {
                                throw new Error("Either 'property' or 'variable' needs to be set for action 'increment'");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    let currentValue = await property.getValue(target);

                                    if (this.decrement) {
                                        currentValue -= options.by;
                                    } else {
                                        currentValue += options.by;
                                    }

                                    await property.setValue(target, currentValue);
                                } else if(options.variable != null) {
                                    let currentValue = Action.getVariable(context, options.variable);

                                    if (this.decrement) {
                                        currentValue -= options.by;
                                    } else {
                                        currentValue += options.by;
                                    }

                                    Action.setVariable(context, options.variable, currentValue);
                                }

                                return context;
                            });
                        }
                    }

                    /**
                     * An action "increment" that increments a number property or variable
                     * @memberOf MathActions
                     * @example
                     * // Increment the property by 1
                     * {
                     *     "increment": {
                     *         "property": "myNumberProperty"
                     *     }
                     * }
                     *
                     * @example
                     * // Increment the property by 2
                     * {
                     *     "increment": {
                     *         "property": "myNumberProperty",
                     *         "by": 2
                     *     }
                     * }
                     *
                     * @example
                     * // Increment the property by 1, (Shorthand version)
                     * {
                     *     "increment": "myNumberProperty"
                     * }
                     *
                     * @example
                     * // Increment the variable by 2
                     * {
                     *     "increment": {
                     *         "variable": "myNumberVariable",
                     *         "by": 2
                     *     }
                     * }
                     */
                    class IncrementAction extends IncrementDecrementAction {
                        static options() {
                            return {
                                "$inc": "enumValue[property,variable]",
                                "by": "number%1"
                            }
                        }

                        constructor(name, options, concept) {
                            super(name, false, options, concept);
                        }
                    }
                    Action.registerPrimitiveAction("increment", IncrementAction);
                    window.IncrementAction = IncrementAction;

                    /**
                     * An action "decrement" that decrements a number property or variable
                     * @memberOf MathActions
                     * @example
                     * // Decrement the property by 1
                     * {
                     *     "decrement": {
                     *         "property": "myNumberProperty"
                     *     }
                     * }
                     *
                     * @example
                     * // Decrement the property by 2
                     * {
                     *     "decrement": {
                     *         "property": "myNumberProperty",
                     *         "by": 2
                     *     }
                     * }
                     *
                     * @example
                     * // Decrement the property by 1, (Shorthand version)
                     * {
                     *     "decrement": "myNumberProperty"
                     * }
                     *
                     * @example
                     * // Decrement the variable by 2
                     * {
                     *     "decrement": {
                     *         "variable": "myNumberVariable",
                     *         "by": 2
                     *     }
                     * }
                     */
                    class DecrementAction extends IncrementDecrementAction {
                        static options() {
                            return {
                                "$dec": "enumValue[property,variable]",
                                "by": "number%1"
                            }
                        }

                        constructor(name, options, concept) {
                            super(name, true, options, concept);
                        }
                    }
                    Action.registerPrimitiveAction("decrement", DecrementAction);
                    window.DecrementAction = DecrementAction;

                    /**
                     * An action 'calculate' that calculates a given math expression and sets a variable with the result
                     * @memberOf MathActions
                     * @example
                     * //Shorthand, calculates and sets result in variable 'calculate'
                     * {
                     *     "calculate": "42 + 60 + $myVariableName$
                     * }
                     *
                     * @example
                     * {
                     *     "calculate": {
                     *         "expression": "sqrt(2) * sqrt(2)",
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     */
                    class CalculateAction extends Action {
                        static options() {
                            return {
                                "expression": "string",
                                "as": "@string"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                options = {
                                    expression: options
                                }
                            }

                            if(Array.isArray((options))) {
                                options = {
                                    expression: options.join(";")
                                }
                            }

                            super(name, options, concept);
                        }

                        static evaluate(expression) {
                            let result = math.evaluate(expression);
                            if (typeof result === "object" && Array.isArray(result.entries) && result.entries.length>0){
                                // Collapse to single value if parser switched to multi-expression evaluation mode
                                result = result.entries[0];
                            }

                            return result;
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                let resultName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    resultName = options.as;
                                }

                                let result = CalculateAction.evaluate(options.expression);

                                Action.setVariable(context, resultName, result);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("calculate", CalculateAction);
                    window.CalculateAction = CalculateAction;

                    /**
                     * An action 'random' that generates a random number from within a range. Both minimum and maximum are inclusive
                     *
                     * If no range is specified. 0 - Number.MAX_SAFE_INTEGER (2^53 -1) is used as range.
                     * @memberOf MathActions
                     * @example
                     * //Shorthand, generates a random number between 0 and 10, saves the result in the variable named "random"
                     * {
                     *     "random": [0, 10]
                     * }
                     *
                     * @example
                     * //Generate a random integer between 0 and 10, and save the result in the variable "myResultVariableName"
                     * {
                     *     "random": {
                     *         "range": [0, 10],
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Generate a random float number between 0 and 10, and save the result in the variable "myResultVariableName"
                     * {
                     *     "random": {
                     *         "range": [0, 10],
                     *         "float": true,
                     *         "as": "myResultVariableName"
                     *     }
                     * }
                     */
                    class RandomAction extends Action {
                        static options() {
                            return {
                                "range": "range",
                                "float": "boolean%false",
                                "as": "@string"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(Array.isArray(options)) {
                                options = {
                                    range: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            function getRandomInt(min, max) {
                                min = Math.ceil(min);
                                max = Math.floor(max);
                                return Math.floor(Math.random() * (max - min + 1) + min);
                            }

                            function getRandomArbitrary(min, max) {
                                if(max < Number.MAX_VALUE) {
                                    //Upper bound is off by the smallest possible value
                                    //make it inclusive by incrementing by the smallest value
                                    max += Number.MIN_VALUE;
                                }
                                return Math.random() * (max - min) + min;
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let range = options.range;

                                if(range == null) {
                                    range = [0, Number.MAX_SAFE_INTEGER]
                                }

                                let randomNumber = Number.NaN;

                                if(options.float) {
                                    randomNumber = getRandomArbitrary(range[0], range[1]);
                                } else {
                                    randomNumber = getRandomInt(range[0], range[1]);
                                }

                                let variableName = Action.defaultVariableName(this);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, randomNumber);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("random", RandomAction);
                    window.RandomAction = RandomAction;

                    </SCRIPT><SCRIPT id="PropertyActions-script" type="disabled">
                    /**
                     *  PropertyActions - Actions that manipulate properties on concept instances
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that operate on properties
                     * @namespace PropertyActions
                     */

                    /**
                     * An action "set" that sets a property or variable to a given value
                     * @memberOf PropertyActions
                     * @example
                     * //Set property to a given value
                     * {
                     *     "set": {
                     *         "property": "myProperty",
                     *         "value": "myValueToSet"
                     *     }
                     * }
                     *
                     * @example
                     * //Set property to a given value (shorthand version)
                     * {
                     *     "set": {
                     *         "myProperty": "myValueToSet"
                     *     }
                     * }
                     *
                     * @example
                     * //Set variable to a given value (shorthand version)
                     * {
                     *     "set": {
                     *         "$myVariableName": "myValueToSet"
                     *     }
                     * }
                     *
                     * @example
                     * //Set a variable to a given value
                     * {
                     *     "set": {
                     *         "variable": "myVariableName",
                     *         "value": "myValueToSet"
                     *     }
                     * }
                     *
                     * @example
                     * //Set a property on a currently non selected concept to a given value
                     * {
                     *     "set": {
                     *         "property": "myConcept.myProperty",
                     *         "value": "myValueToSet"
                     *     }
                     * }
                     */
                    class SetAction extends Action {
                        static options() {
                            return {
                                "$setType": "enumValue[property,variable]",
                                "value": "raw"
                            }
                        }

                        constructor(name, options, concept) {
                            // Shorthand { "property-name": "value-to-set" }
                            if(Object.keys(options).length === 1) {
                                const key = Object.keys(options)[0];
                                const value = options[key];

                                if(key.trim().startsWith("$")) {
                                    options = {
                                        variable: key.trim().substring(1),
                                        value: value
                                    }
                                } else {
                                    options = {
                                        property: key,
                                        value: value
                                    }
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            const mark = "action-set-start-"+performance.now();

                            if(this.options.property == null && this.options.variable == null) {
                                throw new Error("Missing option 'property' or 'variable' on 'set' action: "+JSON.stringify(this.options, null, 2));
                            }

                            if(this.options.value == null) {
                                throw new Error("Missing option 'value' on 'set' action: "+JSON.stringify(this.options, null, 2));
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let mark = VarvPerformance.start();

                                if(options.property) {
                                    let lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property [" + options.property + "] found on any concept");
                                    }

                                    await lookup.property.setValue(lookup.target, options.value);
                                } else if(options.variable) {
                                    Action.setVariable(context, options.variable, options.value);
                                }

                                VarvPerformance.stop("SetAction.forEachContext.loop", mark);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("set", SetAction);
                    window.SetAction = SetAction;

                    /**
                     * An action 'get' that extracts a property and saves it in a variable
                     * @memberOf PropertyActions
                     * @example
                     * {
                     *     "get": {
                     *         "property": "myProperty",
                     *         "as": "myVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Get a property on a currently non selected concept
                     * {
                     *     "get": {
                     *         "property": "myConcept.myProperty",
                     *         "as": "myVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand example that gets the given property and sets it into variable 'get'
                     * {
                     *     "get": "myProperty"
                     * }
                     */
                    class GetAction extends Action {
                        static options() {
                            return {
                                "property": "string",
                                "as": "@string"
                            }
                        }
                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                options = {
                                    property: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.property == null) {
                                    throw new Error("Missing option 'property' on 'get' action");
                                }

                                let lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                if(lookup == null) {
                                    throw new Error("Unable to find property: "+options.property);
                                }

                                let value = await lookup.property.getValue(lookup.target);

                                let resultName = Action.defaultVariableName(self);
                                if(options.as != null) {
                                    resultName = options.as;
                                }

                                Action.setVariable(context, resultName, value);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("get", GetAction);
                    window.GetAction = GetAction;

                    /**
                     * An action "toggle" that toggles a boolean property or variable
                     * @memberOf PropertyActions
                     * @example
                     * //Toggle a boolean property
                     * {
                     *     "toggle": {
                     *         "property": "myBooleanProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Toggle a boolean property on a non selected concept
                     * {
                     *     "toggle": {
                     *         "property": "myConcept.myBooleanProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Toggle a boolean property (shorthand version)
                     * {
                     *     "toggle": "myBooleanProperty"
                     * }
                     *
                     * @example
                     * //Toggle a boolean variable (shorthand version)
                     * {
                     *     "toggle": "$myBooleanVariable"
                     * }
                     *
                     * @example
                     * //Toggle a boolean variable
                     * {
                     *     "toggle": {
                     *         "variable": "myBooleanVariable"
                     *     }
                     * }
                     */
                    class ToggleAction extends Action {
                        static options() {
                            return {
                                "$setType": "enumValue[property,variable]"
                            }
                        }
                        constructor(name, options, concept) {
                            // Shorthand "toggle": "property-to-toggle"
                            if(typeof options === "string") {
                                if(options.trim().startsWith("$")) {
                                    options = {
                                        variable: options.trim().substring(1),
                                    }
                                } else {
                                    options = {
                                        property: options,
                                    }
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.property == null && this.options.variable == null) {
                                throw new Error("Either 'property' or 'variable' must be set for 'toggle' action");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options) => {
                                if(options.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if (property.type !== "boolean") {
                                        throw new Error("Unable to toggle non boolean property [" + options.property + "] on [" + concept.name + "]");
                                    }

                                    let currentValue = await property.getValue(target);

                                    await property.setValue(target, !currentValue);
                                } else if(options.variable != null) {
                                    let currentValue = Action.getVariable(context, options.variable);

                                    if(typeof currentValue !== "boolean") {
                                        throw new Error("Unable to toggle non boolean variable ["+options.variable+"]");
                                    }

                                    Action.setVariable(context, options.variable, !currentValue);
                                }

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("toggle", ToggleAction);
                    window.ToggleAction = ToggleAction;

                    /**
                     * An action 'enums' that sets a variable to all possible values of an enum string type.
                     * @memberOf PropertyActions
                     * @example
                     * //Fetch all enum values for myEnumProperty and save in variable $enum
                     * {
                     *     "enums": {
                     *         "property": "myEnumProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Fetch all enum values for myEnumProperty and save in variable $myVariableName
                     * {
                     *     "enums": {
                     *         "property": "myEnumProperty",
                     *         "as": "myVariableName"
                     *     }
                     * }
                     *
                     * @example
                     * //Non selected concept version
                     * {
                     *     "enums": {
                     *         "property": "myConcept.myEnumProperty"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand version
                     * {
                     *     "enums": "myEnumProperty"
                     * }
                     */
                    class EnumsAction extends Action {
                        static options() {
                            return {
                                "property": "string",
                                "as": "@string"
                            }
                        }
                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                options = {
                                    property: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.property == null) {
                                    throw new Error("Missing required option 'property' for 'enums' action");
                                }

                                if(context.target == null) {
                                    throw new Error("Missing 'target' option for 'enums' action")
                                }

                                const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                if(lookup == null) {
                                    throw new Error("No property ["+options.of.property+"] found");
                                }

                                const property = lookup.property;

                                if(property.options.enum == null || property.type !== "string") {
                                    throw new Error("["+options.property+"] is not an enumerable string type");
                                }

                                let resultName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    resultName = options.as;
                                }

                                Action.setVariable(context, resultName, property.options.enum.slice());

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("enums", EnumsAction);
                    window.EnumsAction = EnumsAction;

                    /**
                     * An action 'getType' that sets a variable to the type of the looked up property/variable/target. If the lookup finds nothing, the variable is set to undefined.
                     *
                     * @memberOf PropertyActions
                     *
                     * @example
                     * {
                     *     "getType": {
                     *         "property": "myProperty",
                     *         "as": "myPropertyType"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "getType": {
                     *         "variable": "myVariableName",
                     *         "as": "myVariableType"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "getType": {
                     *         "target": "someConceptUUID",
                     *         "as": "myConceptType"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand retrieves the type of myProperty and puts it in the variable 'getType'
                     * //Looks up in the following order:
                     * //ContextConcept, LocalConcept, GlobalConcept, Variable, UUID
                     * {
                     *     "getType": "somePropertyNameVariableNameOrConceptUUID"
                     * }
                     *
                     * @example
                     * //Shorthand that looks up the current target's concept type
                     * "getType"
                     */
                    class GetTypeAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    runtimeLookup: options
                                }
                            }

                            if(typeof options === "object" && Object.keys(options).length === 0) {
                                options.target = "$target$";
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let self = this;
                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                if(options.runtimeLookup != null) {
                                    //Figure out what we are dealing with
                                    let found = false;

                                    //Check for property on specificConcept, contextConcept, localConcept or globalConcept
                                    let propertyLookupResult = await VarvEngine.lookupProperty(context.target, self.concept, options.runtimeLookup);
                                    if(propertyLookupResult != null) {
                                        options.property = propertyLookupResult.property;

                                        found = true;
                                    }

                                    //Check for variable
                                    if(!found) {
                                        //Not a property, try variable?
                                        try {
                                            Action.getVariable(context, options.runtimeLookup);

                                            options.variable = options.runtimeLookup;

                                            found = true;
                                        } catch(e) {
                                            //Do nothing
                                        }
                                    }

                                    //Check for concept type
                                    if(!found) {
                                        let concept = await VarvEngine.getConceptFromUUID(options.runtimeLookup);

                                        if(concept != null) {
                                            options.target = concept;
                                            found = true;
                                        }
                                    }

                                    if(!found) {
                                        throw new Error("Unable to lookup ["+options.runtimeLookup+"] to anything meaningfull for action 'getType'");
                                    }
                                }

                                if(options.property == null && options.variable == null && options.target == null) {
                                    throw new Error("Missing option, either 'property', 'variable' or 'target' should be present on action 'getType'");
                                }

                                let result = undefined;

                                if(options.property != null) {
                                    let foundProperty = null;

                                    if(options.property instanceof Property) {
                                        foundProperty = options.property;
                                    } else {
                                        let lookupResult = await VarvEngine.lookupProperty(context.target, self.concept, options.property);
                                        if(lookupResult != null) {
                                            foundProperty = lookupResult.property;
                                        }
                                    }

                                    if(foundProperty != null) {
                                        result = foundProperty.getType();

                                        if(result === "array") {
                                            result += ":"+foundProperty.getArrayType();
                                        }
                                    }
                                }

                                if(options.variable != null) {
                                    try {
                                        //Find type of variable?
                                        let value = Action.getVariable(context, options.variable);

                                        if (value != null) {
                                            if (Array.isArray(value)) {
                                                result = "array";
                                            } else if (typeof value === "number") {
                                                result = "number";
                                            } else if (typeof value === "boolean") {
                                                result = "boolean";
                                            } else if (typeof value === "string") {
                                                let concept = await VarvEngine.getConceptFromUUID(value);

                                                if (concept != null) {
                                                    result = concept.name;
                                                } else {
                                                    result = "string";
                                                }
                                            }
                                        } else {
                                            //Variable existed, but was null. Set type to "null" ?
                                            result = "null";
                                        }
                                    } catch(e) {
                                        //Do nothing
                                    }
                                }

                                if(options.target != null) {
                                    //Find type of concept
                                    let foundConcept = null;

                                    if(options.target instanceof Concept) {
                                        foundConcept = options.target;
                                    } else {
                                        foundConcept = await VarvEngine.getConceptFromUUID(options.target);
                                    }

                                    if(foundConcept != null) {
                                        result = foundConcept.name;
                                    }
                                }

                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, result);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("getType", GetTypeAction);
                    window.GetTypeAction = GetTypeAction;

                    /**
                     * An action 'conceptTypes' that returns the currently defined concept types, optionally filtered for injected/joined concepts
                     * @memberOf PropertyActions
                     *
                     * @example
                     * //Retrieve all concept types into the variable "myConceptTypes"
                     * {"conceptTypes": {"as": "myConceptTypes"}}
                     *
                     * @example
                     * //Retrieve all concept types, that have "myConcept" and "myOtherConcept" injected/joined. Saved into the variable "conceptTypes"
                     * {"conceptTypes": {
                     *     "isType": ["myConcept", "myOtherConcept"]
                     * }}
                     */
                    class ConceptTypesAction extends Action {
                        constructor(name, options, concept) {

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let testTypes = options.isType;
                                if(testTypes == null) {
                                    testTypes = [];
                                }
                                if(!Array.isArray(testTypes)) {
                                    testTypes = [testTypes];
                                }

                                let result = VarvEngine.concepts.filter((concept)=>{
                                    for(let testType of testTypes) {
                                        if(!concept.isA(testType)) {
                                            return false;
                                        }
                                    }
                                    return true;
                                }).map((concept)=>{
                                    return concept.name;
                                });

                                let variableName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    variableName = options.as;
                                }

                                Action.setVariable(context, variableName, result);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("conceptTypes", ConceptTypesAction);
                    window.ConceptTypesAction = ConceptTypesAction;

                    </SCRIPT><SCRIPT id="TextActions-script" type="disabled">
                    /**
                     *  TextActions - Actions related to string manipulation
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that operate on strings
                     * @namespace TextActions
                     */

                    /**
                     * An action "textTransform" that can transform a string to either "uppercase", "lowercase", "capitalize"
                     * @memberOf TextActions
                     * @example
                     * // Uppercase a string in a property
                     * {
                     *     "textTransform": {
                     *         "property": "myStringProperty",
                     *         "mode": "uppercase"
                     *     }
                     * }
                     *
                     * // Capitalize a string in a variable
                     * {
                     *     "textTransform": {
                     *         "variable": "myStringVariable",
                     *         "mode": "capitalize"
                     *     }
                     * }
                     */
                    class TextTransformAction extends Action {
                        static options() {
                            return {
                                "$transform": "enumValue[property,variable]",
                                "mode": "enum[uppercase,lowercase,capitalize]"
                            }
                        }
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            if(this.options.property == null && this.options.variable == null) {
                                throw new Error("Either 'property' or 'variable' must be set for action 'textTransform'");
                            }

                            if(this.options.mode == null) {
                                throw new Error("Missing option 'mode' for action 'textTransform'");
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                if(options.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if (property.type !== "string") {
                                        throw new Error("Unable to apply textTransform on non string property [" + options.property + "] on [" + concept.name + "]");
                                    }

                                    let currentValue = await property.getValue(target);

                                    currentValue = self.transform(currentValue, options.mode.toLowerCase());

                                    await property.setValue(target, currentValue);
                                } else if(options.variable != null) {
                                    let value = Action.getVariable(context, options.variable);

                                    if (typeof value !== "string") {
                                        throw new Error("Unable to apply textTransform on non string variable [" + options.variable + "]");
                                    }

                                    value = self.transform(value, options.mode.toLowerCase());

                                    Action.setVariable(context, options.variable, value);
                                }

                                return context;
                            });
                        }

                        transform(value, mode) {
                            switch (mode) {
                                case "uppercase": {
                                    value = value.toUpperCase();
                                    break;
                                }
                                case "lowercase": {
                                    value = value.toLowerCase();
                                    break;
                                }
                                case "capitalize": {
                                    const words = value.toLowerCase().split(" ");
                                    for (let i = 0; i < words.length; i++) {
                                        words[i] = words[i].charAt(0).toUpperCase() + words[i].substring(1);
                                    }
                                    value = words.join(" ");
                                    break;
                                }

                                default:
                                    throw new Error("Unknown text transform mode: " + mode);
                            }

                            return value;
                        }
                    }
                    Action.registerPrimitiveAction("textTransform", TextTransformAction);
                    window.TextTransformAction = TextTransformAction;

                    /**
                     * An action "concat" that concatenates an array of strings and saves the result in a variable
                     * @memberOf TextActions
                     * @example
                     * {
                     *     "concat": [
                     *         "Hello",
                     *         " ",
                     *         "World!"
                     *     ]
                     * }
                     *
                     * @example
                     * {
                     *     "concat": {
                     *          "strings": [
                     *              "How",
                     *              "dy!"
                     *          ],
                     *          "as": "myResultVariable"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "concat": {
                     *          "strings": [
                     *              "Hello, ",
                     *              "$myStringVariable",
                     *              " doing?"
                     *          ],
                     *          "as": "myResultVariable"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "concat": {
                     *          "strings": "$myStringArrayVariable",
                     *          "as": "myResultVariable"
                     *     }
                     * }
                     *
                     * @example
                     * {
                     *     "concat": {
                     *          "strings": [
                     *              "Variable: "
                     *              {"variable": "myStringVariable"},
                     *              " Property: ",
                     *              {"property": "myStringProperty"}
                     *          ],
                     *          "as": "myResultVariable"
                     *     }
                     * }
                     */
                    class ConcatAction extends Action {
                        constructor(name, options, concept) {
                            //Shorthand
                            if(Array.isArray(options) || typeof options === "string") {
                                options = {
                                    strings: options
                                }
                            }

                            if(typeof options.strings === "string") {
                                options.strings = [options.strings];
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let resultName = Action.defaultVariableName(self);

                                if(options.as != null) {
                                    resultName = options.as;
                                }

                                if(!Array.isArray(options.strings)) {
                                    throw new Error("Option 'strings' must be an array of strings");
                                }

                                let result = "";

                                for(let s of options.strings) {
                                    if(typeof s === "object") {
                                        if(s.variable != null) {
                                            s = Action.getVariable(context, s.variable);
                                        } else if(s.property != null) {
                                            const lookup = await VarvEngine.lookupProperty(context.target, self.concept, s.property);

                                            if(lookup == null) {
                                                throw new Error("No property ["+options.of.property+"] found");
                                            }

                                            const concept = lookup.concept;
                                            const property = lookup.property;
                                            const target = lookup.target;

                                            s = await property.getValue(target);
                                        } else {
                                            throw new Error("Unknown object type in concat strings array: "+JSON.stringify(s, null ,2));
                                        }
                                    }

                                    result += s;
                                }

                                Action.setVariable(context, resultName, result);

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("concat", ConcatAction);
                    window.ConcatAction = ConcatAction;

                    /**
                     * An action 'split' that splits a String into an array, based on the given delimiter. Default delimiter is ","
                     * @memberOf TextActions
                     * @example
                     * //Split the string in "myStringProperty" at the delimiter ";" and save the result in the variable "myArrayVariable", keeping any empty values. ex. "test;;test2" would not return the empty between ;;
                     * {
                     *     "split": {
                     *         "property": "myStringProperty",
                     *         "delimiter": ";",
                     *         "removeEmptyValues": false,
                     *         "as": "myArrayVariable"
                     *     }
                     * }
                     *
                     * @example
                     * //Split the string in "myStringVariable" at the delimiter ";" and save the result in the variable "myArrayVariable"
                     * {
                     *     "split": {
                     *         "variable": "myStringVariable",
                     *         "delimiter": ";",
                     *         "as": "myArrayVariable"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand example, splitting property using delimiter "," and saving result in variable "split"
                     * {
                     *     "split": "myStringProperty"
                     * }
                     *
                     * @example
                     * //Shorthand example, splitting variable using delimiter "," and saving result in variable "split"
                     * {
                     *     "split": "$myStringVariable"
                     * }
                     */
                    class TextSplitAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                if(options.startsWith("$")) {
                                    options = {
                                        "variable": options
                                    }
                                } else {
                                    options = {
                                        "property": options
                                    }
                                }
                            }

                            const defaultOptions = {
                                delimiter: ",",
                                removeEmptyValues: true
                            }

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            const self = this;

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let result = null;

                                if(options.property != null) {
                                    const lookup = await VarvEngine.lookupProperty(context.target, self.concept, options.property);

                                    if(lookup == null) {
                                        throw new Error("No property ["+options.of.property+"] found");
                                    }

                                    const concept = lookup.concept;
                                    const property = lookup.property;
                                    const target = lookup.target;

                                    if (property.type !== "string") {
                                        throw new Error("Unable to apply split on non string property [" + options.property + "] on [" + concept.name + "]");
                                    }

                                    let currentValue = await property.getValue(target);

                                    result = currentValue.split(options.delimiter);

                                } else if(options.variable != null) {
                                    let value = Action.getVariable(context, options.variable);

                                    if (typeof value !== "string") {
                                        throw new Error("Unable to apply textTransform on non string variable [" + options.variable + "]");
                                    }

                                    result = value.split(options.delimiter);
                                }

                                if(options.removeEmptyValues) {
                                    result = result.filter((v)=>{
                                        return v.trim().length > 0;
                                    });
                                }

                                if(result != null) {
                                    let resultName = Action.defaultVariableName(self);

                                    if (options.as != null) {
                                        resultName = options.as;
                                    }

                                    Action.setVariable(context, resultName, result);
                                }

                                return context;
                            });
                        }
                    }
                    window.TextSplitAction = TextSplitAction;
                    Action.registerPrimitiveAction("split", TextSplitAction);

                    </SCRIPT><SCRIPT id="TimingActions-script" type="disabled">
                    /**
                     *  TimingActions - Actions related to time
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that deal with time
                     * @namespace TimingActions
                     */

                    /**
                     * An action "wait" that waits for a given duration before continuing
                     * @memberOf TimingActions
                     * @example
                     * //Wait for 100ms
                     * {
                     *     "wait": {
                     *         "duration": 100
                     *     }
                     * }
                     *
                     * //Wait for 100ms (shorthand version)
                     * {
                     *     "wait": 100
                     * }
                     */
                    class WaitAction extends Action {
                        static options() {
                            return {
                                "duration": "number"
                            }
                        }

                        constructor(name, options, concept) {
                            //shorthand
                            if(typeof options === "number") {
                                options = {
                                    "duration": options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            if(this.options.duration == null) {
                                throw new Error("Option 'duration' must be present on 'wait' action");
                            }
                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                await new Promise((resolve)=>{
                                    setTimeout(()=>{
                                        resolve();
                                    }, options.duration);
                                })

                                return context;
                            });
                        }
                    }
                    Action.registerPrimitiveAction("wait", WaitAction);
                    window.WaitAction = WaitAction;

                    </SCRIPT><SCRIPT id="FlowActions-script" type="disabled">
                    /**
                     *  FlowActions - Actions that create control flow
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that control the flow of the program
                     * @namespace FlowActions
                     */

                    /**
                     * An action 'run' that runs another action, and continuing no matter the outcome of the other action.
                     * @memberOf FlowActions
                     * @example
                     * {
                     *     "run": {
                     *         "action": "myActionName"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand example
                     * {
                     *     "run": "myActionName"
                     * }
                     */
                    class RunAction extends Action {
                        static options() {
                            return {
                                "run": "string"
                            }
                        }

                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string") {
                                options = {
                                    action: options
                                }
                            }

                            const defaultOptions = {
                                lookupActionArguments: {},
                                stopOnError: true
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments) {
                            const self = this;

                            let optionsWithArguments = await Action.lookupArguments(this.options, actionArguments);

                            if(optionsWithArguments.action == null) {
                                throw new Error("Missing option 'action' for 'run' action");
                            }

                            //TODO: We assume that all concepts are of the same type, this is probabely wrong with otherConcepts being in play...
                            let contextConcept = null;
                            if(contexts.length > 0) {
                                contextConcept = await VarvEngine.getConceptFromUUID(contexts[0].target);
                            }

                            let commonVariables = Action.getCommonVariables(contexts);
                            let commonTarget = Action.getCommonTarget(contexts);

                            let optionsWithVariablesAndArguments = await Action.lookupVariables(optionsWithArguments, {target: commonTarget, variables: commonVariables});

                            let action = VarvEngine.lookupAction(optionsWithVariablesAndArguments.action, [contextConcept, self.concept]);

                            if(action == null) {
                                throw new Error("Unable to find action ["+optionsWithVariablesAndArguments.action+"]");
                            }

                            let clonedContexts = contexts.map((context)=> {
                                return Action.cloneContext(context);
                            });
                            if(contexts.savedVariables) {
                                clonedContexts.savedVariables = JSON.parse(JSON.stringify(contexts.savedVariables));
                            }

                            try {
                                await ActionTrigger.before(action, clonedContexts);
                                let mark = VarvPerformance.start();
                                let runContextsResult = await action.apply(clonedContexts, optionsWithVariablesAndArguments.lookupActionArguments);
                                if(action.isPrimitive) {
                                    VarvPerformance.stop("PrimitiveAction-"+action.name, mark);
                                } else {
                                    VarvPerformance.stop("CustomAction-"+action.name, mark);
                                }
                                await ActionTrigger.after(action, runContextsResult);
                            } catch(e) {
                                if(e instanceof StopError) {
                                    //console.log("Run Action was stopped: " + e.message);
                                } else {
                                    if(this.options.stopOnError === true) {
                                        throw e;
                                    }
                                }
                            }

                            return contexts;
                        }
                    }
                    Action.registerPrimitiveAction("run", RunAction);
                    window.RunAction = RunAction;
                    RunAction.DEBUG = false;

                    /**
                     * An action 'exit' that stops the action chain as soon as it is encountered
                     * @memberOf FlowActions
                     *
                     * @example
                     * "exit"
                     */
                    class ExitAction extends Action {
                        static options() {
                            return {};
                        }

                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            throw new StopError("Action '"+this.name+"' encountered!");
                        }
                    }
                    Action.registerPrimitiveAction("exit", ExitAction);
                    window.ExitAction = ExitAction;

                    /**
                     * An action 'switch' that can test several branches, and execute an array of actions if the branch matches
                     *
                     * Each branch is tested in the order they are present in the array.
                     *
                     * The where option is used as a filter, and if the filter matches the actions in then is applied
                     *
                     * Default is to break after a branch matches, but if "break": false is added as an option, it will continue to next branch
                     *
                     * If a branch has no where option, it is always executed if no branch has breaked until it is reached.
                     * @memberOf FlowActions
                     * @example
                     * {
                     *     "switch": [
                     *         {
                     *             "where": {"property": "myProperty", "equals": "myValue"},
                     *             "then": ["myAction", "myOtherAction"],
                     *             "break": true
                     *         },
                     *         {
                     *             "where": {"property": "myProperty", "equals": "myOtherValue"},
                     *             "then": ["myAction", "myOtherAction"],
                     *             "break": true
                     *         },
                     *         {
                     *             "then": ["myDefaultAction"]
                     *         }
                     *     ]
                     * }
                     */
                    class SwitchAction extends Action {
                        static options() {
                            return {
                                "$switch": "switch"
                            }
                        }

                        constructor(name, options, concept) {
                            if(options == null) {
                                options = [];
                            }

                            if(!Array.isArray(options)) {
                                options = [options];
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let results = [];

                            for (let context of contexts) {
                                //Make sure to clone context, since we change it directly, thus variables might be a shared object if not.
                                let clonedContext = Action.cloneContext(context);

                                let lookedUpOptions = [];

                                if(Array.isArray(options)) {
                                    //Lookup variables for each case
                                    for(let option of options) {
                                        let clonedOption = {};

                                        if(option.where != null) {
                                            clonedOption.where = await Action.lookupVariables(option.where, clonedContext);
                                        }
                                        if(option.break != null) {
                                            clonedOption.break = await Action.lookupVariables(option.break, clonedContext);
                                        }
                                        if(option.then) {
                                            clonedOption.then =  Action.clone(option.then);
                                        }

                                        lookedUpOptions.push(clonedOption);
                                    }
                                }

                                //Do switch
                                for(let caseOption of lookedUpOptions) {
                                    if(caseOption.where != null) {
                                        let filter = FilterAction.constructFilter(caseOption.where);

                                        let matches = await filter.filter(clonedContext);

                                        if(!matches) {
                                            //Did not match, skip to next branch
                                            continue;
                                        }
                                    }

                                    let actions = caseOption.then;
                                    if(!Array.isArray(actions)) {
                                        actions = [actions];
                                    }

                                    let action = ConceptLoader.parseAction(UUIDGenerator.generateUUID("SwitchCaseAction"), actions, this.concept);

                                    await ActionTrigger.before(action,  [clonedContext]);
                                    let mark = VarvPerformance.start();
                                    clonedContext = await action.apply([clonedContext]);
                                    if(action.isPrimitive) {
                                        VarvPerformance.stop("PrimitiveAction-"+action.name, mark);
                                    } else {
                                        VarvPerformance.stop("CustomAction-"+action.name, mark);
                                    }
                                    await ActionTrigger.after(action, [clonedContext]);

                                    let doBreak = true;

                                    if(caseOption.break != null) {
                                        doBreak = caseOption.break;
                                    }

                                    if(doBreak) {
                                        break;
                                    }
                                }

                                if (clonedContext != null) {
                                    if (Array.isArray(clonedContext)) {
                                        clonedContext.forEach((entry) => {
                                            results.push(entry);
                                        });
                                    } else {
                                        results.push(clonedContext);
                                    }
                                }
                            }

                            return results;
                        }
                    }
                    Action.registerPrimitiveAction("switch", SwitchAction);
                    window.SwitchAction = SwitchAction;


                    </SCRIPT><SCRIPT id="CustomActions-script" type="disabled">
                    /**
                     *  CustomActions - Actions that allow custom code
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions that handle custom code
                     * @namespace CustomActions
                     */

                    /**
                     * An action 'customJS' that can run a custom piece of javascript code on the current context, the function must be a function on the window object
                     * @memberOf CustomActions
                     * @example
                     * //Runs window.myFunction
                     * {
                     *     "customJS": {
                     *          "functionName": "myFunction"
                    *      }
                     * }
                     *
                     * //Shorthand, runs window.myFunction
                     * {
                     *     "customJS": "myFunction"
                     * }
                     */
                    class CustomJSAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    "functionName": options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            return this.forEachContext(contexts, actionArguments, async (context, options)=> {
                                if(this.options.functionName == null) {
                                    throw new Error("'functionName' must be set for action 'customJS'");
                                }

                                let f = window[options.functionName];

                                if(f == null) {
                                    throw new Error("'window."+options.functionName+"' is not defined");
                                }

                                if(typeof f !== "function") {
                                    throw new Error("'window."+options.functionName+"' is not a function");
                                }

                                return await f(context, options);
                            });
                        }
                    }
                    Action.registerPrimitiveAction("customJS", CustomJSAction);
                    window.CustomJSAction = CustomJSAction;

                    </SCRIPT><SCRIPT id="DebugActions-script" type="disabled">
                    /**
                     *  DebugActions - Actions that make debugging easier
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     * Actions related to debugging or benchmarking
                     * @namespace DebugActions
                     */

                    /**
                     * An action "debugConcept" that prints the currently selected concepts to the console.
                     * @memberOf DebugActions
                     *
                     * @example
                     * {
                     *     "debugConcept"
                     * }
                     */
                    class DebugConceptAction extends Action {
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let concept = await VarvEngine.getConceptFromUUID(context.target);

                                console.groupCollapsed("ConceptDebug:", concept.name, context.target);

                                for(let key of concept.properties.keys()) {
                                    let property = concept.properties.get(key);
                                    let value = await property.getValue(context.target);
                                    console.log(key, "->", value);
                                }

                                console.groupEnd();

                                return context;
                            });
                        }

                        static options() {
                            return {
                            };
                        }
                    }
                    Action.registerPrimitiveAction("debugConcept", DebugConceptAction);
                    window.DebugConceptAction = DebugConceptAction;

                    /**
                     * An action "debugContext" that prints the current context to the console
                     * @memberOf DebugActions
                     * @example
                     * {
                     *     "debugContext"
                     * }
                     */
                    class DebugContextAction extends Action {
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            console.groupCollapsed("ContextDebug");
                            console.log("Contexts:", contexts.map((context)=>{return Action.cloneContext(context)}));
                            console.log("ActionArguments:",actionArguments);
                            console.log("SavedVariables:", contexts.savedVariables);

                            console.group("forEachContext:")
                            const result = await this.forEachContext(contexts, actionArguments, async (context, options)=>{

                                console.log(JSON.parse(JSON.stringify(context)));

                                return context;
                            });
                            console.groupEnd();

                            console.groupEnd();

                            return result;
                        }

                        static options() {
                            return {
                            };
                        }
                    }
                    Action.registerPrimitiveAction("debugContext", DebugContextAction);
                    window.DebugContextAction = DebugContextAction;

                    /**
                     * An action "debugMessage" that can debug a message to the console
                     * @memberOf DebugActions
                     * @example
                     * {
                     *     "debugMessage": {
                     *         "message": "The message to debug"
                     *     }
                     * }
                     *
                     * @example
                     * //Shorthand version
                     * {
                     *     "debugMessage": "The message to debug"
                     * }
                     */
                    class DebugMessageAction extends Action {
                        constructor(name, options, concept) {
                            //Shorthand
                            if(typeof options === "string"){
                                options = {
                                    message: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments) {
                            if(this.options.bulk) {
                                console.log(this.options.message);
                                return contexts;
                            }

                            return this.forEachContext(contexts, actionArguments, async (context, options)=>{
                                let message = options.msg;

                                if(options.message != null) {
                                    message = options.message;
                                }
                                console.log(message);

                                return context;
                            });
                        }

                        static options() {
                            return {
                                "message": "string"
                            };
                        }
                    }
                    Action.registerPrimitiveAction("debugMessage", DebugMessageAction);
                    window.DebugMessageAction = DebugMessageAction;

                    /**
                     * An action 'varvPrefix' that sets the current prefix to VarvPerformance logging.
                     * @memberOf DebugActions
                     * @example
                     * // Set the VarvPerformance prefix to "myPrefix"
                     *
                     * {
                     *     "varvPrefix": "myPrefix"
                     * }
                     *
                     * @example
                     * // Remove the current VarvPerformance prefix
                     *
                     * {
                    *       "varvPrefix": ""
                     * }
                     */
                    class VarvPerformancePrefix extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    prefix: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let common = Action.getCommonVariables(contexts);
                            options = await Action.lookupVariables(options, {variables: common, target: null});

                            VarvPerformance.prefix = options.prefix

                            return contexts;
                        }
                    }
                    Action.registerPrimitiveAction("perfPrefix", VarvPerformancePrefix);
                    window.VarvPerformancePrefix = VarvPerformancePrefix;

                    /**
                     * An action 'repeat' that can run a set of actions a number of times
                     * @memberOf DebugActions
                     * @example
                     * // Runs the action "someAction" 10 times
                     * {
                     *     "repeat": {
                     *         iterations: 10,
                     *         actions: [
                     *             "someAction"
                     *         ]
                     *     }
                     * }
                     */
                    class RepeatAction extends Action {
                        constructor(name, options, concept) {
                            const defaultOptions = {
                                iterations: 1,
                                actions: []
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let actionOptions = options.actions;

                            delete options.actions;

                            let common = Action.getCommonVariables(contexts);
                            options = await Action.lookupVariables(options, {variables: common, target: null});

                            if(typeof options.iterations !== "number" || options.iterations <= 0) {
                                throw new Error("RepeatAction is missing options iterations, must be a number larger than 0");
                            }

                            if(!Array.isArray(options.actions)) {
                                options.actions = [options.actions];
                            }

                            let action = ConceptLoader.parseAction(UUIDGenerator.generateUUID("RepeatActions"), actionOptions, this.concept);

                            let clonedContext = Action.cloneContext(contexts);

                            for(let i = 0; i<options.iterations; i++) {

                                await ActionTrigger.before(action, clonedContext);
                                let mark = VarvPerformance.start();
                                clonedContext = await action.apply(clonedContext);
                                if (action.isPrimitive) {
                                    VarvPerformance.stop("PrimitiveAction-" + action.name, mark);
                                } else {
                                    VarvPerformance.stop("CustomAction-" + action.name, mark);
                                }
                                await ActionTrigger.after(action, clonedContext);
                            }

                            return clonedContext;
                        }
                    }
                    Action.registerPrimitiveAction("repeat", RepeatAction);
                    window.RepeatAction = RepeatAction;

                    /**
                     * An action 'profile' that starts or stops the javascript profiler, supports only 1 profile running at a time
                     * if another profile is running, that is stopped first before starting a new.
                     * @memberOf DebugActions
                     * @example
                     * // Starts the profiler, and gives it the given name
                     * {
                     *     "profile": {
                     *         "name": "A name for your profile"
                     *     }
                     * }
                     *
                     * @example
                     * // Starts the profiler, and gives it the given name, shorthand version
                     * {
                     *     "profile": "A name for your profile"
                     * }
                     *
                     * @example
                     * // Stops the currently running profile
                     * {
                     *     "profile": null
                     * }
                     */
                    class ProfileAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    "name": options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let common = Action.getCommonVariables(contexts);
                            options = await Action.lookupVariables(options, {variables: common, target: null});

                            if(console.profile == null) {
                                console.warn("console.profile not supported");
                            } else {
                                //Stop any current profile
                                if (ProfileAction.currentProfile != null) {
                                    console.profileEnd(ProfileAction.currentProfile);
                                    ProfileAction.currentProfile = null;
                                }

                                //Start new profile if requested
                                if(options.name != null) {
                                    console.profile(options.name);
                                    ProfileAction.currentProfile = options.name;
                                }
                            }

                            return contexts;
                        }
                    }
                    ProfileAction.currentProfile = null;
                    Action.registerPrimitiveAction("profile", ProfileAction);
                    window.ProfileAction = ProfileAction;

                    /**
                     * An action 'timer' that is used to record time between 2 points, only 1 timer is supported at a time
                     * If another timer is running when a new one is to be started, the old timer is stopped first.
                     * When the timer is stopped, the duration is debugged into the console
                     * @memberOf DebugActions
                     * @example
                     * // Stats a timer, and names it "myTimerName"
                     * {
                     *     "timer": {
                     *         "name": "myTimerName"
                     *     }
                     * }
                     *
                     * @example
                     * // Stats a timer, and names it "myTimerName", shorthand
                     * {
                     *     "timer": "myTimerName"
                     * }
                     */
                    class TimerAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    name: options
                                }
                            }

                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let common = Action.getCommonVariables(contexts);
                            options = await Action.lookupVariables(options, {variables: common, target: null});

                            //Stop any current timer
                            if (TimerAction.currentTimer != null) {
                                console.timeEnd(TimerAction.currentTimer);
                                TimerAction.currentTimer = null;
                            }

                            //Start new timer if requested
                            if(options.name != null) {
                                console.time(options.name);
                                TimerAction.currentTimer = options.name;
                            }

                            return contexts;
                        }
                    }
                    TimerAction.currentTimer = null;
                    Action.registerPrimitiveAction("timer", TimerAction);
                    window.TimerAction = TimerAction;

                    /**
                     * An action 'group' that can start/stop console groups. Only supports one group at a time, if another group is open, this will be closed first.
                     * @memberOf DebugActions
                     *
                     * @example
                     * // Starts a new console group "myGroupName" non collapsed
                     * {
                     *     "group": {
                     *         "name": "myGroupName",
                     *         "collapse": false
                     *     }
                     * }
                     *
                     * @example
                     * // Starts a new console group "myGroupName" non collapsed, shorthand
                     * {
                     *     "group": "myGroupName"
                     * }
                     *
                     * @example
                     * // Closes the current group
                     * {
                     *     "group": null
                     * }
                     */
                    class GroupAction extends Action {
                        constructor(name, options, concept) {
                            if(typeof options === "string") {
                                options = {
                                    name: options
                                }
                            }

                            let defaultOptions =  {
                                collapse: false
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let options = await Action.lookupArguments(this.options, actionArguments);

                            let common = Action.getCommonVariables(contexts);
                            options = await Action.lookupVariables(options, {variables: common, target: null});

                            //Stop any current profile
                            if (GroupAction.currentGroup != null) {
                                console.groupEnd();
                                GroupAction.currentGroup = null;
                            }

                            //Start new profile if requested
                            if(options.name != null) {
                                if(options.collapse) {
                                    console.groupCollapsed(options.name);
                                } else {
                                    console.group(options.name);
                                }
                                GroupAction.currentGroup = options.name;
                            }

                            return contexts;
                        }
                    }
                    GroupAction.currentGroup = null;
                    Action.registerPrimitiveAction("group", GroupAction);
                    window.GroupAction = GroupAction;

                    /**
                     * An action 'assert' that can be used to check that some state is as expected, uses filters
                     * @memberOf DebugActions
                     *
                     * @example
                     * // Assert that the property "myProperty" is less than 10
                     * {
                     *     "assert": {
                     *         "where": {
                     *             "property": "myProperty",
                     *             "lessThan": 10
                     *         }
                     *     }
                     * }
                     */
                    class AssertAction extends Action {
                        constructor(name, options, concept) {
                            if(options.where == null) {
                                //Lets assume we got the filter directly
                                options = {
                                    where: options
                                }

                                if(options.where.showAndReset != null) {
                                    options.showAndReset = options.where.showAndReset;
                                    delete options.where.showAndReset;
                                }
                            }

                            let defaultOptions = {
                                where: null,
                                showAndReset: false
                            };

                            super(name, Object.assign({}, defaultOptions, options), concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let self = this;

                            if (this.options.showAndReset === true) {
                                let color = "background: green; color: white;";

                                if (AssertAction.failed > 0) {
                                    color = "background: red; color: white;";
                                }

                                console.log("%c Successfull asserts: " + (AssertAction.total - AssertAction.failed) + "/" + AssertAction.total, color);
                                AssertAction.total = 0;
                                AssertAction.failed = 0;

                                return contexts;
                            } else {
                                return this.forEachContext(contexts, actionArguments, async (context, options, index)=>{
                                    AssertAction.total++;

                                    if(options.where == null) {
                                        throw new Error("Missing option 'where' on action 'assert'")
                                    }

                                    let filter = FilterAction.constructFilter(options.where);

                                    let pass = await filter.filter(context, self.concept, true);
                                    if(!pass) {
                                        AssertAction.failed++;
                                    }

                                    return context;
                                });
                            }
                        }
                    }
                    Action.registerPrimitiveAction("assert", AssertAction);
                    window.AssertAction = AssertAction;
                    AssertAction.failed = 0;
                    AssertAction.total = 0;

                    /**
                     * An action 'assertException' that works like 'run' but asserts that the action chain called by run, should throw an exception.
                     *
                     * @example
                     * {
                     *     "assertException": {
                     *         "action": "myExceptionThrowingAction"
                     *     }
                     * }
                     */
                    class AssertExceptionAction extends RunAction {
                        constructor(name, options, concept) {
                            super(name, options, concept);
                        }

                        async apply(contexts, actionArguments = {}) {
                            let exception = false;

                            try {
                                await super.apply(contexts, actionArguments);
                            } catch(e) {
                                //Exception
                                exception = true;
                            }

                            if(!exception) {
                                console.assert(false, "No error, when one was expected!");
                                AssertAction.failed++;
                            }

                            AssertAction.total++;

                            return contexts;
                        }
                    }
                    Action.registerPrimitiveAction("assertException", AssertExceptionAction);
                    window.AssertExceptionAction = AssertExceptionAction;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-cauldron" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Cauldron Datastore",
                        "description": "A datastore that allows mapping parts of concepts so that they show up in the Cauldron TreeBrowser and can be inspected with the inspector",
                        "dependencies": [
                            "#varv-engine",
                            "cauldron-repos #Cauldron"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="ConceptTreeGenerator-script" type="disabled">
                    /**
                     *  ConceptDecorator - decorates Concept nodes in TreeBrowser trees
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class ConceptTreeGenerator extends TreeGenerator {
                        constructor(parentNode) {
                            super();

                            this.rootNode = new TreeNode({
                                type: "ConceptRootNode",
                                context: null
                            });
                            TreeGenerator.decorateNode(this.rootNode);
                            parentNode.addNode(this.rootNode);
                        }

                        onAddDatastore(datastore){
                            let activeElement = document.activeElement;

                            let self = this;
                            let datastoreNode = new TreeNode({
                                type: "DatastoreNode",
                                lookupKey: datastore.name,
                                context: datastore
                            });
                            TreeGenerator.decorateNode(datastoreNode);
                            this.rootNode.addNode(datastoreNode);
                            this.rootNode.unfold();

                            datastore.registerDestroyCallback(()=>{
                                self.destroyNode(datastoreNode);
                            });

                            // Concepts
                            datastore.registerConceptAddedCallback((concept)=>{
                                datastoreNode.unfold();

                                let conceptNode = new TreeNode({
                                    type: "ConceptNode",
                                    lookupKey: concept.name,
                                    context: concept
                                });

                                // Instances
                                let instanceAddedCallback = datastore.registerConceptInstanceAddedCallback(concept, (uuid)=>{
                                    let node = self.addInstanceNode(datastore, conceptNode, concept, uuid);
                                    let instanceRemovedCallback = datastore.registerConceptInstanceRemovedCallback(concept, (removedUUID)=>{
                                        if (removedUUID===uuid){
                                            self.destroyNode(node);
                                        }
                                    });
                                    node.cleanup = [()=>{
                                        datastore.removeConceptInstanceRemovedCallback(concept, instanceRemovedCallback);
                                    }];
                                });

                                TreeGenerator.decorateNode(conceptNode);
                                datastoreNode.addNode(conceptNode);
                            });

                            // STUB: Concepts cannot be removed right now but should be cleaned up here
                            // datastore.removeConceptInstanceAddedCallback(concept, instanceAddedCallback);

                        }

                        destroyNode(node){
                            node.parentNode.removeNode(node);

                            // Run cleanup
                            if (node.cleanup){
                                for (let entry of node.cleanup){
                                    entry();
                                }
                            }

                            // Destroy children
                            for (let child of Array.from(node.childNodes)){ // copy to avoid concurrent mods
                                this.destroyNode(child);
                            }
                        }

                        addInstanceNode(datastore, parentNode, concept, uuid){
                            let instanceNode = new TreeNode({
                                type: "ConceptInstanceNode",
                                lookupKey: uuid,
                                context: {concept, uuid, datastore}
                            });
                            TreeGenerator.decorateNode(instanceNode);
                            parentNode.addNode(instanceNode);
                            return instanceNode;
                        }
                    }


                    EventSystem.registerEventCallback("Cauldron.TreeBrowserSpawned", ({detail: {root: rootNode}})=>{
                        let generator = new ConceptTreeGenerator(rootNode);
                        EventSystem.triggerEvent("Varv.ConceptTreeGeneratorSpawned", generator);
                        window.ConceptTreeGenerator.instances.push(generator);
                    });

                    window.ConceptTreeGenerator = ConceptTreeGenerator;
                    window.ConceptTreeGenerator.instances = [];

                    </SCRIPT><SCRIPT id="CauldronDatastore-script" type="disabled">
                    /**
                     *  CauldronDatastore
                     *     A datastore that allows mapping parts of concepts so that they show up in
                     *     the Cauldron TreeBrowser and are inspectable with the inspector
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class CauldronDatastore extends DirectDatastore {
                        constructor(name, options = {}) {
                            super(name, options);
                            let self = this;

                            this.destroyCallbacks = [];
                            this.conceptAddedCallbacks = [];
                            this.instanceAddedCallbacks = new Map();
                            this.instanceRemovedCallbacks = new Map();

                            this.appearCallback = VarvEngine.registerEventCallback("appeared", async (context)=> {
                                let mark = VarvPerformance.start();
                                if (self.isConceptMapped(context.concept)){
                                    let callbacks = self.instanceAddedCallbacks.get(context.concept.name);
                                    if (callbacks){
                                        for (let callback of callbacks){
                                            callback(context.target);
                                        }
                                    }
                                }
                                VarvPerformance.stop("CauldronDatastore.registerEventCallback.appeared", mark);
                            });
                            this.disappearCallback = VarvEngine.registerEventCallback("disappeared", async (context)=> {
                                if (self.isConceptMapped(context.concept)){
                                    let callbacks = self.instanceRemovedCallbacks.get(context.concept.name);
                                    if (callbacks){
                                        for (let callback of callbacks){
                                            callback(context.target);
                                        }
                                    }
                                }
                            });
                        }

                        isShared() {
                            return false;
                        }

                        destroy() {
                            this.appearCallback.delete();
                            this.disappearCallback.delete();
                            this.engineReloadedCallback.delete();
                            for (let callback of this.destroyCallbacks){
                                callback(this);
                            }
                        }

                        registerDestroyCallback(callback){
                            this.destroyCallbacks.push(callback);
                            return callback;
                        }

                        async init() {
                            let self = this;

                            this.engineReloadedCallback = VarvEngine.registerEventCallback("engineReloaded", ()=>{
                                console.log("Engine reloaded, register on trees!");
                                // Inform trees about us
                                for (let tree of window.ConceptTreeGenerator.instances){
                                    tree.onAddDatastore(this);
                                }

                                // Listen for new ones
                                EventSystem.registerEventCallback("Varv.ConceptTreeGeneratorSpawned", (evt)=>{
                                    evt.detail.onAddDatastore(self);
                                });
                            });
                        }

                        registerConceptAddedCallback(callback){
                            this.conceptAddedCallbacks.push(callback);

                            // Pre-feed with currently mapped
                            for (const conceptName of this.mappedConcepts.keys()){
                                callback(VarvEngine.getConceptFromType(conceptName));
                            }

                            return callback;
                        }

                        async registerConceptInstanceAddedCallback(concept, callback){
                            if (!this.instanceAddedCallbacks.has(concept.name)){
                                this.instanceAddedCallbacks.set(concept.name, []);
                            }

                            let callbacks = this.instanceAddedCallbacks.get(concept.name);
                            callbacks.push(callback);

                            // Pre-feed with currently mapped
                            for (const conceptUUID of await VarvEngine.getAllUUIDsFromType(concept.name)){
                                callback(conceptUUID);
                            }

                            return callback;
                        }

                        removeConceptInstanceAddedCallback(concept, callback){
                            let callbacks = this.instanceAddedCallbacks.get(concept.name);
                            if (!callbacks) {
                                console.log("Cauldron: Tried to remove a concept callback but couldn't", concept.name, callback);
                                return;
                            };
                            this.instanceAddedCallbacks.set(concept.name, callbacks.filter(e => e !== callback));
                        }

                        registerConceptInstanceRemovedCallback(concept, callback){
                            if (!this.instanceRemovedCallbacks.has(concept.name)){
                                this.instanceRemovedCallbacks.set(concept.name, []);
                            }

                            let callbacks = this.instanceRemovedCallbacks.get(concept.name);
                            callbacks.push(callback);

                            return callback;
                        }

                        removeConceptInstanceRemovedCallback(concept, callback){
                            let callbacks = this.instanceRemovedCallbacks.get(concept.name);
                            if (!callbacks) {
                                console.log("Cauldron: Tried to remove a concept removed callback but couldn't", concept.name, callback);
                                return;
                            };
                            this.instanceRemovedCallbacks.set(concept.name, callbacks.filter(e => e !== callback));
                        }

                        createBackingStore(concept, property) {
                            const self = this;

                            if (this.isPropertyMapped(concept,property)){
                                console.log("Already mapped property");
                                return;
                            }

                            if (!this.isConceptMapped(concept)){
                                // Concept add update
                                if(CauldronDatastore.DEBUG) {
                                    console.log("New concept", concept);
                                }
                                for (let callback of self.conceptAddedCallbacks){
                                    callback(concept);
                                }
                            }

                            // Check if concept already is mapped, if not, register it
                            this.internalAddPropertyMapping(concept, property, {});
                        }

                        removeBackingStore(concept, property) {
                            if (!this.isPropertyMapped(concept, property))
                                throw 'Cannot unmap property from memory because the property was not mapped: ' + concept + "." + property;

                            // TODO: Remove concept update

                            this.internalRemovePropertyMapping(concept, property);
                        }

                        loadBackingStore() {
                            // No storage, do nothing
                        }
                    }

                    window.CauldronDatastore = CauldronDatastore;

                    // Register default cauldron datastore
                    Datastore.registerDatastoreType("cauldron", CauldronDatastore);

                    </SCRIPT><SCRIPT id="InspectorConceptBinding-script" type="disabled">
                    /**
                     *  InspectorConceptBinding - Allow inspection of Concepts in the inspector
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class InspectorConceptBinding {
                        /**
                         * Inspects the given TreeNode and if supported, returns a map of editable attributes
                         * @param {TreeNode} treeNode
                         * @returns {Cauldron.InspectorElement[]}
                         */
                        static inspect(treeNode) {
                            let elements = [];
                            let concept = null;
                            let datastore = null;

                            switch (treeNode.type){
                                case "ConceptInstanceNode":
                                    concept = treeNode.context.concept;
                                    datastore = treeNode.context.datastore;

                                    let propertyEditors = new Cauldron.InspectorSegment("Properties", elements);
                                    elements.push(propertyEditors);
                                    for (const property of concept.properties.values()){
                                        if (datastore.isPropertyMapped(concept, property) || property.isDerived()){
                                            propertyEditors.push(new Cauldron.InspectorPropertyEditor(treeNode.context, property, treeNode.getTreeBrowser()));
                                        }
                                    }

                                    return elements;
                                    break;
                                case "ConceptNode":
                                    concept = treeNode.context;

                                    if (concept.properties.size>0){
                                        let propertiesView = new Cauldron.InspectorSegment("Properties", elements);
                                        elements.push(propertiesView);
                                        for (const property of concept.properties.values()){
                                            propertiesView.push(new Cauldron.InspectorPropertyView(treeNode.context, property, treeNode.getTreeBrowser()));
                                        }
                                    }

                                    if (concept.behaviours.size>0){
                                        let actionsView = new Cauldron.InspectorSegment("Actions", elements);
                                        elements.push(actionsView);
                                        for (const behaviour of concept.behaviours.values()){
                                            actionsView.push(new Cauldron.InspectorBehaviourView(treeNode.context, behaviour, treeNode.getTreeBrowser()));
                                        }
                                    }

                                    return elements;
                                    break;
                                default:
                                    return null;
                            }
                        }
                    }
                    window.Cauldron.InspectorConceptBinding = InspectorConceptBinding;
                    Cauldron.CauldronInspector.registerContentBinding(InspectorConceptBinding, 10);

                    class InspectorBehaviourView extends Cauldron.InspectorElement {
                        constructor(concept, behaviour, treeBrowser) {
                            super();

                            let label = document.createElement("span");
                            label.classList.add("cauldron-inspector-element-label");
                            label.textContent = behaviour.name;

                            let triggersCausingView = document.createElement("span");
                            triggersCausingView.classList.add("cauldron-inspector-element-field");
                            let triggerList = "";
                            for (let triggerName of behaviour.triggers.values()){
                                let trigger = concept.getTrigger(triggerName);
                                let triggerNameReal = "'"+triggerName+"'";
                                try {
                                    triggerNameReal = trigger.constructor.name;
                                } catch (ex){}
                                triggerList += "@"+triggerNameReal+" ";
                            }
                            triggersCausingView.textContent = triggerList;

                            // TODO: Jump to code link here

                            this.html.appendChild(label);
                            this.html.appendChild(triggersCausingView);
                        }
                    }
                    window.Cauldron.InspectorBehaviourView = InspectorBehaviourView;

                    class InspectorPropertyView extends Cauldron.InspectorElement {
                        constructor(concept, property, treeBrowser) {
                            super();

                            let label = document.createElement("span");
                            label.classList.add("cauldron-inspector-element-label");
                            label.textContent = property.name;

                            let theType = document.createElement("span");
                            theType.classList.add("cauldron-inspector-element-field");
                            theType.textContent = property.type + (property.isDerived()?" (derived)":"");

                            this.html.appendChild(label);
                            this.html.appendChild(theType);
                        }
                    }
                    window.Cauldron.InspectorPropertyView = InspectorPropertyView;



                    class InspectorPropertyEditor extends Cauldron.InspectorElement {
                        /**
                         *
                         * @param {Element} domElement
                         * @param {String} attrName
                         * @param {String} overrideLabel
                         */
                        constructor(conceptInstance, property, browser) {
                            super();
                            this.browser = browser;

                            let self = this;

                            this.conceptInstance = conceptInstance;
                            this.property = property;

                            if(property.isDerived()) {
                                this.readOnly = true;
                            }

                            if (property.type==="array"){
                                this.editor = document.createElement("div");
                            } else if (property.type==="boolean"){
                                this.editor = document.createElement("input");
                                this.editor.setAttribute("type", "checkbox");
                            } else if (property.type==="number"){
                                this.editor = document.createElement("input");
                                this.editor.setAttribute("type", "number");
                                this.editor.setAttribute("step", "1");
                            } else {
                                this.editor = document.createElement("input");
                                this.editor.setAttribute("contenteditable", "true");
                                this.editor.setAttribute("spellcheck", "false");
                            }
                            this.editor.classList.add("cauldron-inspector-element-editor");

                            if(this.readOnly) {
                                this.editor.setAttribute("disabled", true);
                            }

                            this.label = document.createElement("span");
                            this.label.classList.add("cauldron-inspector-element-label");
                            this.label.textContent = property.name;

                            this.html.append(this.label);

                            this.editorContainer = document.createElement("div");
                            this.editorContainer.appendChild(this.editor);
                            this.editorContainer.classList.add("cauldron-inspector-element-editor-container");
                            this.editorContainer.classList.add("cauldron-inspector-element-field");

                            this.html.appendChild(this.editorContainer);

                            this.html.classList.add("inspector-property");

                            this.html.addEventListener("click", ()=>{
                                EventSystem.triggerEventAsync("Varv.DOMView.HighlightProperty", property);
                            });

                            if(this.property.isConceptType()) {
                                this.autocompleteDiv = document.createElement("div");
                                this.autocompleteDiv.classList.add("cauldron-inspector-element-autocomplete");
                                this.autocompleteDiv.classList.add("hidden");
                                this.editorContainer.appendChild(this.autocompleteDiv);

                                if(!this.readOnly) {
                                    this.editor.addEventListener("focus", () => {
                                        self.autoComplete(self.editor.value);
                                    });
                                    document.addEventListener("pointerdown", (evt) => {
                                        if (evt.target.closest(".cauldron-inspector-element-editor-container") !== self.editorContainer) {
                                            self.autocompleteDiv.innerHTML = "";
                                            self.autocompleteDiv.classList.add("hidden");
                                        }
                                    });
                                }

                                // Add the click-to-locate feature
                                if (property.type!=="array"){
                                    this.locatorContainer = document.createElement("span");
                                    this.editorContainer.append(this.locatorContainer);
                                }
                            }

                            this.html.addEventListener("keydown", (event)=>{
                                if(event.code === "Enter") {
                                    event.preventDefault();
                                }
                            });

                            // Send changes to concept
                            this.html.addEventListener("input", (evt)=>{
                                if(self.property.isConceptType()) {
                                    self.autoComplete(self.editor.value);
                                }

                                self.persistValue();
                            });

                            // Fetch changes from concept
                            this.valueUpdaterCallback = async function onFieldUpdate(uuid, value){
                                let mark = VarvPerformance.start();
                                if (uuid===self.conceptInstance.uuid){
                                    if (property.type==="array"){
                                        self.editor.innerHTML="";
                                        let value = await property.getValue(conceptInstance.uuid);
                                        for(let i = 0; i < value.length; i++){
                                            let entry = value[i];
                                            let entryElement = document.createElement("div");
                                            entryElement.style.display = "flex";
                                            entryElement.style.alignItems = "center";

                                            if (!property.isDerived()){
                                                let deleter = IconRegistry.createIcon("mdc:delete");
                                                deleter.style.cursor = "pointer";
                                                deleter.style.flex = "1 1 0%";
                                                deleter.style.fontSize = "1.5em";
                                                deleter.addEventListener("click", ()=>{
                                                    // Delete this entry
                                                    value.splice(i, 1);
                                                    property.setValue(conceptInstance.uuid, value);
                                                });
                                                entryElement.appendChild(deleter);
                                            }

                                            let theText = document.createElement("div");
                                            theText.style.flex = "1 1 100%";
                                            theText.innerText = entry;
                                            entryElement.appendChild(theText);


                                            if (property.isConceptArrayType()){
                                                let link = self.getConceptLink(entry);
                                                link.style.flex = "1 1 0%";
                                                entryElement.appendChild(link);
                                            }

                                            self.editor.appendChild(entryElement);
                                        }

                                        if (!property.isDerived()){
                                            let adder = document.createElement("button");
                                            adder.innerText = "Add Entry";
                                            adder.addEventListener("click", ()=>{
                                                let newValue = prompt ("Value to add", "");
                                                newValue = self.convertArrayItem(newValue, property.options.items);
                                                value.push(newValue);
                                                property.setValue(conceptInstance.uuid, value);
                                            });
                                            self.editor.appendChild(adder);
                                        }
                                    } else if (property.type==="boolean"){
                                        self.editor.checked = value;
                                    } else {
                                        self.editor.value = value;

                                        if (property.isConceptType()){
                                            self.updateLocator();
                                        }
                                    }
                                }
                                VarvPerformance.stop("InspectorConceptBinding.valueUpdaterCallback", mark);
                            };

                            let possiblePromiseOrValue = property.getValue(conceptInstance.uuid);
                            if(possiblePromiseOrValue instanceof Promise) {
                                possiblePromiseOrValue.then((value)=>{
                                    self.valueUpdaterCallback(self.conceptInstance.uuid, value);
                                });
                            } else {
                                self.valueUpdaterCallback(self.conceptInstance.uuid, possiblePromiseOrValue);
                            }
                            property.addUpdatedCallback(this.valueUpdaterCallback);
                        }

                        convertArrayItem(value, itemsType){
                            if (itemsType === 'number')
                                return parseFloat(value);

                            if (itemsType === "boolean")
                                return value === "true";

                            return value;
                        }

                        updateLocator() {
                            this.locatorContainer.innerHTML = "";
                            this.locatorContainer.appendChild(this.getConceptLink(this.editor.value));
                        }

                        persistValue() {
                            try {
                                let value = null;
                                if (this.property.type==="boolean"){
                                    value = this.editor.checked;
                                } else {
                                    value = this.property.typeCast(this.editor.value);
                                    if (this.property.isConceptType()){
                                        this.updateLocator();
                                    }
                                }
                                this.property.setValue(this.conceptInstance.uuid, value);

                                //What is this method?
                                this.setFailing(false);
                            } catch (ex){
                                this.setFailing(true);
                            };
                        }

                        async autoComplete() {
                            const self = this;

                            let allUUIDS = await VarvEngine.getAllUUIDsFromType(this.property.type, true);

                            this.autocompleteDiv.innerHTML = "";

                            let ul = document.createElement("ul");

                            allUUIDS.forEach((uuid)=>{
                                let li = document.createElement("li");
                                li.textContent = uuid;
                                ul.appendChild(li);

                                li.addEventListener("mouseenter", ()=>{
                                    EventSystem.triggerEventAsync("Varv.DOMView.HighlightInstance", uuid);
                                });

                                li.addEventListener("mouseleave", ()=>{
                                    EventSystem.triggerEventAsync("Varv.DOMView.ClearHighlights");
                                });

                                li.addEventListener("click", ()=>{
                                    self.editor.value = uuid;
                                    self.autocompleteDiv.classList.add("hidden");
                                    self.persistValue();
                                });
                            });

                            this.autocompleteDiv.appendChild(ul);
                            this.autocompleteDiv.classList.remove("hidden");
                        }

                        getConceptLink(uuid){
                            let linker = IconRegistry.createIcon("mdc:gps_fixed");
                            linker.style.cursor = "pointer";
                            linker.addEventListener("click", ()=>{
                                let treeNodes = this.browser.findTreeNode(uuid);
                                if(treeNodes.length > 0) {
                                    let treeNode = treeNodes[0];
                                    treeNode.reveal();
                                    treeNode.select();
                                }
                            });
                            return linker;
                        }

                        destroy() {
                            super.destroy();
                            this.property.removeUpdatedCallback(this.valueUpdaterCallback);
                        }

                        focus(){
                            this.editor.select();
                        }
                    }

                    window.Cauldron.InspectorPropertyEditor = InspectorPropertyEditor;



                    EventSystem.registerEventCallback("TreeBrowser.Selection", ({detail: {selection: selection}})=>{
                        if (selection.context && selection.context instanceof Concept){
                            let concept = selection.context;
                            EventSystem.triggerEventAsync("Varv.DOMView.HighlightConcept", concept);
                        } else if (selection.context && selection.context.uuid) {
                            EventSystem.triggerEventAsync("Varv.DOMView.HighlightInstance", selection.context.uuid);
                        } else {
                            EventSystem.triggerEventAsync("Varv.DOMView.ClearHighlights");
                        }
                    });

                    </SCRIPT><SCRIPT id="ConceptDecorator-script" type="disabled">
                    /**
                     *  ConceptDecorator - decorates Concept nodes in TreeBrowser trees
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    /**
                     *
                     */
                    class ConceptDecorator {
                        /**
                         * Attempts to decorate the given TreeNode
                         * @param {TreeNode} node - The node to decorate
                         * @returns {boolean} True/False depending on if the node was decorated
                         */
                        static decorate(node) {
                            if(node.type === "ConceptNode") {
                                node.setProperty("content", node.context.name);
                                node.setProperty("icon", IconRegistry.createIcon("mdc:api"));
                                return true;
                            } else if(node.type === "ConceptInstanceNode") {
                                node.setProperty("content", node.context.uuid);
                                node.setProperty("icon", IconRegistry.createIcon("mdc:class"));
                                return true;
                            } else if(node.type === "DatastoreNode") {
                                node.setProperty("content", node.context.name);
                                node.setProperty("icon", IconRegistry.createIcon("mdc:circle"));
                                return true;
                            } else if(node.type === "ConceptRootNode") {
                                node.setProperty("content", "Concepts");
                                node.setProperty("icon", IconRegistry.createIcon("mdc:all_out"));
                                return true;
                            }

                            return false;
                        }

                        /**
                         * Attempts to decorate the given DataTransfer based on the given TreeNode
                         * @param {TreeNode} node
                         * @param {DataTransfer} dataTransfer
                         * @returns {boolean} True/False depending on if the DataTransfer was decorated
                         */
                        static decorateDataTransfer(node, dataTransfer) {
                            return false;
                        }
                    }

                    window.ConceptDecorator = ConceptDecorator;

                    TreeGenerator.registerDecorator(ConceptDecorator, 10);

                    </SCRIPT><SCRIPT id="ConceptMenuActions-script" type="disabled">
                    /**
                     *  ConceptTreeGenerator - Generate program/state structure to explore in Cauldron TreeBrowser
                     *
                     *  This code is licensed under the MIT License (MIT).
                     *
                     *  Copyright 2020, 2021, 2022 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Permission is hereby granted, free of charge, to any person obtaining a copy
                     *  of this software and associated documentation files (the Software), to deal
                     *  in the Software without restriction, including without limitation the rights
                     *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                     *  copies of the Software, and to permit persons to whom the Software is
                     *  furnished to do so, subject to the following conditions:
                     *
                     *  The above copyright notice and this permission notice shall be included in
                     *  all copies or substantial portions of the Software.
                     *
                     *  THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                     *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                     *  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                     *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                     *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                     *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
                     *  THE SOFTWARE.
                     *
                     */

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Create Instance",
                        group: "ConceptActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:class"),
                        onOpen: (menu)=>{
                            return menu.context.type == "ConceptNode";
                        },
                        onAction: async (menuItem) =>{
                            let id = await menuItem.menu.context.context.create();
                            setTimeout(()=>{
                                let treeBrowser = menuItem.menu.context.getTreeBrowser();
                                let treeNodes = treeBrowser.findTreeNode(id);
                                if(treeNodes.length > 0) {
                                    let treeNode = treeNodes[0];
                                    treeNode.reveal();
                                    treeNode.select();
                                }
                            }, 0);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Delete",
                        group: "ConceptActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:delete"),
                        onOpen: (menu)=>{
                            return menu.context.type == "ConceptInstanceNode";
                        },
                        onAction: async (menuItem) =>{
                            menuItem.menu.context.context.concept.delete(menuItem.menu.context.context.uuid);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Clone",
                        group: "ConceptActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:copy"),
                        onOpen: (menu)=>{
                            return menu.context.type == "ConceptInstanceNode";
                        },
                        onAction: async (menuItem) =>{
                            menuItem.menu.context.context.concept.clone(menuItem.menu.context.context.uuid);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Clone (Deep)",
                        group: "ConceptActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:copy"),
                        onOpen: (menu)=>{
                            return menu.context.type == "ConceptInstanceNode";
                        },
                        onAction: async (menuItem) =>{
                            menuItem.menu.context.context.concept.clone(menuItem.menu.context.context.uuid, true);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Copy ID",
                        group: "ConceptActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:copy"),
                        onOpen: (menu)=>{
                            return menu.context.type == "ConceptInstanceNode";
                        },
                        onAction: async (menuItem) =>{
                            await navigator.clipboard.writeText(menuItem.menu.context.context.uuid);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                        label: "Varv",
                        icon: IconRegistry.createIcon("webstrates:varv"),
                        onAction: () => {
                            window.open("https://varv.projects.cavi.au.dk/api/varv/");
                        }
                    });

                    //Setup cauldron menu item
                    MenuSystem.MenuManager.registerMenuItem("Cauldron.Editor.Toolbar", {
                        label: "JSON/YAML",
                        icon: IconRegistry.createIcon("mdc:cached"),
                        group: "EditActions",
                        groupOrder: 0,
                        order: 200,
                        onOpen: (menu) => {
                            return menu.context instanceof ConceptDefinitionFragment;
                        },
                        onAction: (menuItem) => {
                            EventSystem.triggerEvent("Varv.Convert.YAMLJSON", {
                                fragment: Fragment.one(menuItem.menu.context)
                            });
                        }
                    });

                    EventSystem.registerEventCallback("Varv.Convert.YAMLJSON", async (evt)=>{
                        let fragment = evt.detail.fragment;
                        let code = fragment.raw;

                        let convertedCode = YAMLJSONConverter.convert(code);
                        fragment.raw = convertedCode;

                        const detail = {
                            fragment: evt.detail.fragment,
                        };

                        EventSystem.triggerEvent("Cauldron.Open.FragmentEditor", detail);
                    });

                    </SCRIPT><STYLE id="base-style">
                    /* STUB: Not a proper MDC select popup, does not follow layouting guide */
                    .cauldron-inspector-element-autocomplete {
                      border: 1px dotted #ccc;
                      padding: 3px;
                      position: fixed;
                      z-index: 9000;
                      background: var(--mdc-theme-surface, white);
                      margin-top: 2em; }
                      .cauldron-inspector-element-autocomplete.hidden {
                        display: none; }
                      .cauldron-inspector-element-autocomplete ul {
                        list-style-type: none;
                        padding: 0;
                        margin: 0; }
                        .cauldron-inspector-element-autocomplete ul li {
                          padding: 5px 0;
                          cursor: pointer; }
                          .cauldron-inspector-element-autocomplete ul li:hover {
                            background: #eee; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-cauldron-delayloader" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv Cauldron (delayed)",
                        "description": "A delayed loader for the varv-cauldron package",
                        "dependencies": [
                            "codestrates-repos #EventSystem"
                        ],
                        "optionalDependencies": [
                            "#varv-cauldron",
                            "#varv-dom-highlight"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="cauldron-delayloader-script" type="disabled">
                    // Run when/if Cauldron is initialized
                    {
                        let alreadyInitializedDelayLoader = false;
                        EventSystem.registerEventCallback("Cauldron.OnOpen", async ()=>{
                                if (!alreadyInitializedDelayLoader){
                                    console.log("Fetching additional Varv packages for Cauldron integration");
                                    await wpm.require(["varv-cauldron", "varv-dom-highlight"]);

                                    // Cause a restart to update the TreeBrowser with the current Concepts
                                    EventSystem.triggerEvent("Varv.Restart");
                                    alreadyInitializedDelayLoader = true;
                                }
                        });
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv-react" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv React View",
                        "description": "Allow connection to browser-based UI based on React",
                        "dependencies": [
                            "#varv-engine",
                            "#varv-domdiff-view",
                            "codestrates-repos #fragment_js_babel"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "0.1",
                        "changelog": {}
                    }

                    </SCRIPT><SCRIPT id="JSXQueryParseNode-script" type="disabled">
                    class JSXQueryParseNode extends QueryParseNode {
                        constructor(reactParamsObject, scopeUpdateCallback){
                            super({
                                getAttribute: (attribute)=>reactParamsObject.hasOwnProperty(attribute)?reactParamsObject[attribute]:null
                            });
                            this.scopeUpdateCallback = scopeUpdateCallback;
                        }

                        onScopesUpdated(view, newChildScopes){
                            this.scopeUpdateCallback(newChildScopes);
                        }
                    }

                    window.JSXQueryParseNode = JSXQueryParseNode;

                    </SCRIPT><CODE-FRAGMENT data-type="text/javascript+babel" id="VarvReact">
                                        import React from "react"
                    let {useMemo} = React;

                    if (!window.VarvScope) window.VarvScope = React.createContext([]);

                    export const Varv = (params)=>{
                        let [lookupResult,setLookupResult] = React.useState([]);
                        let scope = React.useContext(VarvScope);

                        function onResultsUpdated(scopes){
                            setLookupResult(scopes);
                        }

                        React.useEffect(() => {
                            const queryParser = new JSXQueryParseNode(params, onResultsUpdated); // STUB: maybe reuse?
                            const view = queryParser.getView(document, scope);

                            return () => {
                                // TODO: Cleanup varv view
                                view.destroy();
                            };
                        }, [params.concept, params.property, params.target, params.if, scope]);

                        return lookupResult.map(result=>{
                            if (result.length==0){
                                // Empty scope just forwards children
                                return params.children;
                            } else if (result[0].errorMessage){
                                console.log(result[0].errorMessage,result[0].ex);
                                return &lt;varv-failure>{result[0].errorMessage}{result[0].ex.toString()}&lt;/varv-failure>
                            } else {
                                return &lt;VarvScope.Provider key={result[0].uuid} value={[...scope,...result]}>
                                    {params.children}
                                &lt;/VarvScope.Provider>
                            }
                        });
                    }

                    export function useProperty(lookup){
                        let scope = React.useContext(VarvScope);
                        let [value,setValue] = React.useState();
                        let [binding,setBinding] = React.useState();

                        // From React -> Varv
                        let storeValue = async function sendValueToVarv(value){
                            await binding.setValueFor(lookup, value);
                        }

                        // Add a cleanup hook
                        React.useEffect(() => {
                            // Fetch the binding from Varv -> React
                            let binding = DOMView.getBindingFromScope(lookup, scope);
                            if (!binding) throw new Error("Could not look up "+lookup+" in scope"+JSON.stringify(scope));
                            let changeListener = binding.generateRawChangeListener(lookup, null);
                            changeListener.onChanged = async function updateReactValueFromVarv(newValue){
                                if (Array.isArray(newValue)){
                                    // Make sure not to send the original array as React will remember it and not see changes
                                    setValue(structuredClone(newValue));
                                } else {
                                    setValue(newValue);
                                }
                            };

                            // Enqueue initial value fetch
                            let init = binding.getValueFor(lookup);
                            if (init.then) {
                                init.then((initialValue)=>{
                                    setValue(initialValue);
                                });
                            } else {
                                setValue(init);
                            }
                            setBinding(binding);

                            return () => {
                                if (changeListener && changeListener.destroy) changeListener.destroy();
                            };
                        }, []);

                        return [value,storeValue];
                    }


                    export function useAction(lookup, actionArguments = {}){
                        if (lookup.includes(".")) throw new Error("STUB: Only direct action names supported right now for useAction(), no fancy lookups");
                        let scope = React.useContext(VarvScope);
                        return (additionalActionArguments)=>{
                            // Lookup the action in scope
                            let target = null;
                            for (let i = scope.length-1; i>=0; i--){
                                let scopeEntry = scope[i];
                                if (scopeEntry.concept){
                                    if (!target) target = scopeEntry.uuid;
                                    if (scopeEntry.concept.actions){ // TODO: Also consider other kinds of scopes instead of assuming only Concept/Property
                                        let action = scopeEntry.concept.actions.get(lookup);
                                        if (action) {
                                            action.apply([{target:target}], {...actionArguments, ...additionalActionArguments});
                                            return;
                                        }
                                    }
                                }
                            }
                            throw new Error("Unknown action "+lookup+" not found in scope");
                        };
                    }


                                    </CODE-FRAGMENT></WPM-PACKAGE><WPM-PACKAGE data-repository="varv-repos" id="varv" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Varv",
                        "description": "The standard meta package for using Varv",
                        "dependencies": [
                            "#varv-engine",
                            "#varv-builtin-actions",
                            "#varv-builtin-triggers",
                            "#varv-dom",
                            "#varv-domdiff-view",
                            "#varv-dom-triggers",
                            "#varv-memory",
                            "#varv-localstorage",
                            "#varv-inspector",
                            "#varv-cauldron-delayloader",
                            "#varv-codestrates-extensions"
                        ],
                        "optionalDependencies": [
                            "#varv-cauldron",
                            "#varv-blockly",
                            "#varv-inspector"
                        ],
                        "assets": [],
                        "license": "MIT",
                        "version": "1.0",
                        "changelog": {}
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="EventSystem" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "EventSystem",
                        "description": "Can register and fire events",
                        "dependencies": [],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="eventsystem-script" type="disabled">
                    /**
                     *  EventSystem
                     *  General system for registering and handling events
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Handles sending / recieving named events
                     * @hideconstructor
                     */
                    class EventSystem {
                        /**
                         * Register a callback to be called when the given event is triggered
                         *
                         * @example
                         * registerEventCallback("myEvent", ({detail: detail})=>{
                         *     //My event has triggered
                         *     console.log("MyEvent triggered with details:", detail);
                         * });
                         *
                         * @param {string} eventName - The name of the event to register
                         * @param {Function} callback - The callback to call when the event triggers
                         *
                         * @returns {object} - An object with a method delete(), that removes the registered callback
                         */
                        static registerEventCallback(eventName, callback) {
                            let callbacks = EventSystem.callbackMap.get(eventName);
                            if(callbacks == null){
                                callbacks = new Set();
                                EventSystem.callbackMap.set(eventName, callbacks);
                            }

                            callbacks.add(callback);

                            return {
                                delete: () => {
                                    callbacks.delete(callback);
                                }
                            };
                        }

                        /**
                         * Trigger the event with the given name
                         *
                         * @example
                         * triggerEvent("myEvent", {
                         *     someData: "MyEventData"
                         * });
                         *
                         * @param {string} eventName - The name of the event to trigger
                         * @param {*} [detail] - The event detail to supply to the CustomEvent
                         * @returns {boolean} - true/false depending on if any callback asked to prevent default
                         */
                        static triggerEvent(eventName, detail = null){
                            let event = new CustomEvent(eventName, {
                                detail: detail
                            });

                            let preventDefault = false;

                            let callbacks = EventSystem.callbackMap.get(eventName);
                            if(callbacks != null) {
                                for(let callback of callbacks) {
                                    if(callback(event) === true) {
                                        preventDefault = true;
                                    }
                                }
                            }

                            return preventDefault;
                        }

                        /**
                         * Trigger the event with the given name
                         *
                         * @example
                         * triggerEvent("myEvent", {
                         *     someData: "MyEventData"
                         * });
                         *
                         * @param {string} eventName - The name of the event to trigger
                         * @param {*} [detail] - The event detail to supply to the CustomEvent
                         * @returns {Promise<boolean>} - true/false depending on if any callback asked to prevent default
                         */
                        static async triggerEventAsync(eventName, detail = null){
                            let event = new CustomEvent(eventName, {
                                detail: detail
                            });

                            let preventDefault = false;

                            let callbacks = EventSystem.callbackMap.get(eventName);

                            if(callbacks != null) {
                                for (let callback of callbacks) {
                                    let callbackReturn = callback(event);

                                    let result = null;

                                    result = (callbackReturn instanceof Promise)?await callbackReturn:callbackReturn;

                                    if (result === true) {
                                        preventDefault = true;
                                    }
                                }
                            }

                            return preventDefault;
                        }}

                    EventSystem.callbackMap = new Map();

                    window.EventSystem = EventSystem;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_core" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "The base fragment core required by all fragments",
                        "dependencies": [
                            "wpm_js_libs #cQuery",
                            "wpm_js_libs #Observer",
                            "wpm_js_libs #fastdiff",
                            "wpm_js_libs #diffHTML",
                            "wpm_js_libs #UUIDGenerator"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><STYLE id="base-style">
                    code-fragment {
                        display: none;
                    }
                    </STYLE><SCRIPT id="fragment_core-script" type="disabled">
                    /**
                     *  Fragment
                     *  The base class for all code fragments in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global cQuery, webstrate, HTMLElement, NodeList, UUIDGenerator, Observer, WPMv2, Text, DIFF_INSERT, DIFF_DELETE, wpm */

                    const dmp = new diff_match_patch();
                    let legacyWarningCounter = 0;

                    /**
                     * @namespace Fragments
                     */

                    /**
                     * Codestrate Fragment representing a <code-fragment></code-fragment> tag in codestrates.
                     * @abstract
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class Fragment {
                        get html(){
                            if (legacyWarningCounter<3){
                                try {
                                    throw new Error("Legacy read access of private field Fragment.html");
                                } catch (ex){
                                    console.info("Reading cQuery object from private field .html directly on Fragment will break in the future, use .element to get the DOMElement directly instead. Only the first 3 warnings are shown, printing a stack trace...",ex);
                                }
                            }
                            legacyWarningCounter++;
                            return cQuery(this.element);
                        }
                        set html(cQueryHTML){
                            try {
                                throw new Error("Legacy write access to private field Fragment.html");
                            } catch (ex){
                                console.warn("Writing a cQuery object to private field .html directly on Fragment will not be possible in the future, printing a stack trace...",ex);
                            }
                            this.element = cQueryHTML[0];
                        }

                        /**
                         * Create a new fragment using the given cQuery object as its base.
                         * @param {cQuery} cQueryHTMl - The cQuery object to use as base.
                         */
                        constructor(cQueryHTMl) {
                            let self = this;

                            // Legacy cQuery html element
                            cQueryHTMl.data("Fragment", this); // Legacy

                            this.element = cQueryHTMl[0];
                            this.element.fragment = this;

                            this.textInsertedCallbacks = [];
                            this.textDeletedCallbacks = [];
                            this.fragmentChangedCallbacks = [];
                            this.fragmentUnloadedCallbacks = [];
                            this.fragmentClassChangedCallbacks = [];
                            this.fragmentAutoChangedCallbacks = [];

                            this.uuid = UUIDGenerator.generateUUID("fragment-");

                            //Setup autodom and make it able to wait until it is complete.
                            this.autoDomDirty = true;
                            this.autoDomReady = false;
                            this.setupAutoDomHandling();

                            this.element.setAttribute("transient-fragment-uuid", this.uuid);

                            this.setupObservers();
                            this.startObserver();
                        }

                        /**
                         * Get the node that holds the text content of this fragment
                         * @protected
                         * @ignore
                         * @returns {Text}
                         */
                        getTextContentNode() {
                            let textContentNode = this.element;

                            this.checkTextContentNode(textContentNode);

                            return textContentNode;
                        }

                        /**
                         * Checks the given node for its feasibility of being the textContentNode
                         * @protected
                         * @ignore
                         * @param {Text} textContentNode - The text node to check
                         */
                        checkTextContentNode(textContentNode) {
                            if(textContentNode.childNodes.length > 1) {
                                console.warn("More than 1 childnode...", textContentNode.childNodes);
                            }
                        }

                        /**
                         * Triggers all callback handlers for the given type insert/delete
                         * @private
                         * @param {number} pos - The position the event happened
                         * @param {string} val - The value of the event
                         * @param {insert|delete} type - The type of the event
                         */
                        insertDeleteCallback(pos, val, type) {
                            switch (type) {
                                case "insert":
                                {
                                    this.textInsertedCallbacks.forEach((callback) => {
                                        callback(pos, val);
                                    });

                                    break;
                                }
                                case "delete":
                                {
                                    this.textDeletedCallbacks.forEach((callback) => {
                                        callback(pos, val);
                                    });

                                    break;
                                }
                            }
                        }

                        /**
                         * Handle the given mutations
                         * @private
                         * @param {Mutation[]} mutations - The mutations to handle
                         */
                        mutationCallback(mutations) {
                            let self = this;

                            let characterDataTargets = [];

                            let sendUpdateCallback = false;

                            mutations.forEach((mutation) => {
                                if(mutation.type === "attributes") {
                                    sendUpdateCallback = true;
                                }

                                if (mutation.type === "attributes" && mutation.attributeName === "auto" && mutation.target === self.element) {
                                    //If auto attribute changed, trigger onAutoChanged
                                    self.onAutoChanged(self.auto);
                                    sendUpdateCallback = false;
                                } else if (mutation.type === "attributes" && mutation.attributeName === "class" && mutation.target === self.element) {
                                    //If auto attribute changed, trigger onAutoChanged
                                    self.onClassChanged(this.element.classList);
                                    sendUpdateCallback = false;
                                } else if(mutation.type === "characterData") {
                                    if(mutation.target.characterDataAlreadyHandled) {
                                        return;
                                    }

                                    sendUpdateCallback = true;

                                    characterDataTargets.push(mutation.target);
                                    let newValue = mutation.target.nodeValue;
                                    let oldValue = mutation.oldValue;
                                    mutation.target.characterDataAlreadyHandled = true;

                                    //If characterData mutation, generate insert/delete ops
                                    let patches = dmp.patch_make(oldValue, newValue);
                                    Array.from(patches).forEach((patch)=>{
                                        let offset = patch.start1;
                                        patch.diffs.forEach((diff) => {
                                            let type = diff[0];
                                            let value = diff[1];

                                            switch(type) {
                                                case DIFF_INSERT:
                                                    self.insertDeleteCallback(offset, value, "insert");
                                                    offset += value.length;
                                                    break;
                                                case DIFF_DELETE:
                                                    self.insertDeleteCallback(offset, value, "delete");
                                                    break;
                                                case DIFF_EQUAL:
                                                    offset += value.length;
                                                    break;
                                            }
                                        });
                                    });
                                } else if(mutation.type === "childList") {
                                    sendUpdateCallback = true;
                                }
                            });

                            characterDataTargets.forEach((target)=>{
                                target.characterDataAlreadyHandled = false;
                            });

                            //Only send
                            if(this.element.parentNode != null && sendUpdateCallback) {
                                //Dont do changed callbacks if we are not in the dom?
                                this.triggerFragmentChanged(this);
                            }
                        }

                        /**
                         * @private
                         * @param context
                         */
                        triggerFragmentChanged(context) {
                            this.fragmentChangedCallbacks.slice().forEach((callback) => {
                                try {
                                    callback(context);
                                } catch(e) {
                                    console.group("Error: "+e);
                                    console.log("Callback:", callback);
                                    console.log("Context:", context);
                                    console.groupCollapsed("Trace");
                                    console.trace();
                                    console.groupEnd();
                                    console.groupEnd();
                                }
                            });
                        }

                        /**
                         * Sets up the mutation observer for this fragment
                         * @ignore
                         * @protected
                         */
                        setupObservers() {
                            let self = this;

                            this.mutationHandler = (mutations) => {
                                self.mutationCallback(mutations);
                            };

                            this.observer = new MutationObserver(this.mutationHandler);
                        }

                        /**
                         * Starts this fragments mutation observer
                         * @ignore
                         * @protected
                         */
                        startObserver() {
                            if(this.observer == null) {
                                return;
                            }

                            this.observer.observe(this.element, {
                                attributes: true,
                                childList: true,
                                subtree: true,
                                characterData: true,
                                characterDataOldValue: true
                            });
                        }

                        /**
                         * Stops this fragments mutation observer, handling any mutations that is queued before stopping.
                         * @ignore
                         * @protected
                         */
                        stopObserver() {
                            if(this.observer == null) {
                                return;
                            }

                            let mutations = this.observer.takeRecords();

                            if (mutations.length > 0) {
                                this.mutationCallback(mutations);
                            }

                            this.observer.disconnect();
                        }

                        /**
                         * Run the given method without triggering the mutation observer on this fragment, then trigger fragment changed callbacks with the given context
                         * @ignore
                         * @protected
                         * @param {Function} method - Method to call. Important: cannot be async or return a promise, the observer will be restarted as soon as this method returns.
                         * @param {Object} context - Context to pass along to the callbacks
                         */
                        executeObserverless(method, context, skipChangeCheck=false) {
                            this.stopObserver();

                            let before = null;

                            if(!skipChangeCheck) {
                                before = this.raw;
                            }

                            //Run our method, potentially adding mutations
                            method();

                            this.startObserver();

                            if(skipChangeCheck || before !== this.raw) {
                                this.triggerFragmentChanged(context);
                            }
                        }

                        /**
                         * The raw representation of this fragment, can be used to set/get the raw value.
                         *
                         * @example
                         * //Get the raw value of a fragment
                         * let fragmentValue = myFragment.raw;
                         *
                         * @example
                         * //Set the raw value of a fragment
                         * myFragment.raw = myNewFragmentValue;
                         *
                         * @type {string}
                         */
                        get raw() {
                            if(this.getTextContentNode().firstChild instanceof Text) {
                                return this.getTextContentNode().firstChild.nodeValue;
                            } else {
                                return this.getTextContentNode().textContent;
                            }
                        }

                        set raw(content) {
                            if(this.getTextContentNode().firstChild instanceof Text) {
                                this.getTextContentNode().firstChild.nodeValue = content;
                            } else {
                                this.getTextContentNode().textContent = content;
                            }
                        }

                        /**
                         * The auto attribute of this fragment, toggles automatic behaviour on/off
                         * @type {boolean}
                         */
                        get auto() {
                            return this.element.hasAttribute("auto");
                        }

                        set auto(auto) {
                            if (auto) {
                                this.element.setAttribute("auto", "");
                            } else {
                                this.element.removeAttribute("auto");
                            }
                        }

                        /**
                         * @callback Fragments.Fragment~fragmentChangedCallback
                         * @param {Fragment|Object} context - The context that called the callback
                         */

                        /**
                         * Register a callback to be run when this fragments content changes.
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnFragmentChangedHandler((context)=>{
                         *     //Fragment has changed
                         * });
                         *
                         * @param {Fragments.Fragment~fragmentChangedCallback} callback - The callback that is run when fragment content changes
                         */
                        registerOnFragmentChangedHandler(callback) {
                            let self = this;

                            this.fragmentChangedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.unRegisterOnFragmentChangedHandler(callback);
                                }
                            }
                        }

                        /**
                         * Unregister a callback handler
                         * @param {Fragments.Fragment~fragmentChangedCallback} callback - The callback to unregister
                         */
                        unRegisterOnFragmentChangedHandler(callback) {
                            this.fragmentChangedCallbacks.splice(this.fragmentChangedCallbacks.indexOf(callback), 1);
                        }

                        /**
                         * @callback Fragments.Fragment~fragmentUnloadedCallback
                         * @param {Fragments.Fragment} fragment - The fragment that called the callback
                         */

                        /**
                         * Register a callback to run when this fragment is unloaded
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnFragmentUnloadedHandler(()=>{
                         *     //Fragment is unloaded
                         * });
                         *
                         * @param {Fragments.Fragment~fragmentUnloadedCallback} callback - The callback to run when the fragment is unloaded
                         */
                        registerOnFragmentUnloadedHandler(callback) {
                            let self = this;

                            this.fragmentUnloadedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.unRegisterOnFragmentUnloadedHandler(callback);
                                }
                            }
                        }

                        /**
                         * Unregister a callback handler
                         * @param {Fragments.Fragment~fragmentUnloadedCallback} callback - The callback to unregister
                         */
                        unRegisterOnFragmentUnloadedHandler(callback) {
                            this.fragmentUnloadedCallbacks.splice(this.fragmentUnloadedCallbacks.indexOf(callback), 1);
                        }

                        /**
                         * @callback Fragments.Fragment~autoChangedCallback
                         * @param {Fragments.Fragment} fragment - The fragment
                         * @param {boolean} auto - The new value of auto
                         */

                        /**
                         * Register a callback to run when auto attribute changes on fragment
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnAutoChangedHandler((fragment, auto)=>{
                         *     //Fragment auto attribute changed
                         * });
                         *
                         * @param {Fragments.Fragment~autoChangedCallback} callback - The callback to run when auto changes
                         */
                        registerOnAutoChangedHandler(callback) {
                            let self = this;

                            this.fragmentAutoChangedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.unRegisterOnAutoChangedHandler(callback);
                                }
                            }
                        }

                        /**
                         * Unregister a callback handler
                         * @param {Fragments.Fragment~autoChangedCallback} callback - The callback to unregister
                         */
                        unRegisterOnAutoChangedHandler(callback) {
                            this.fragmentAutoChangedCallbacks.splice(this.fragmentAutoChangedCallbacks.indexOf(callback), 1);
                        }

                        /**
                         * @callback Fragments.Fragment~textInsertedCallback
                         * @param {number} position - The position where the text was inserted
                         * @param {string} value - The value of inserted text
                         */

                        /**
                         * Register a callback to run when text is inserted into this fragment
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnTextInsertedHandler((position, value)=>{
                         *     //Text "value" has been inserted into this fragment at "position"
                         * });
                         *
                         * @param {Fragments.Fragment~textInsertedCallback} callback - The callback to run when text is inserted
                         */
                        registerOnTextInsertedHandler(callback) {
                            let self = this;

                            this.textInsertedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.textInsertedCallbacks.splice(self.textInsertedCallbacks.indexOf(callback), 1);
                                }
                            }
                        }

                        /**
                         * @callback Fragments.Fragment~textDeletedCallback
                         * @param {number} position - The position where the text was deleted
                         * @param {string} value - The value of deleted text
                         */

                        /**
                         * Register a callback to run when text is deleted from this fragment
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnTextDeletedHandler((position, value)=>{
                         *     //Text "value" has been deleted from this fragment at "position"
                         * });
                         *
                         * @param {Fragments.Fragment~textDeletedCallback} callback - The callback to run when text is deleted
                         */
                        registerOnTextDeletedHandler(callback) {
                            let self = this;

                            this.textDeletedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.textDeletedCallbacks.splice(self.textDeletedCallbacks.indexOf(callback), 1);
                                }
                            }
                        }

                        /**
                         * @callback Fragments.Fragment~fragmentClassChangedCallback
                         * @param {string[]} classes - The classes that changed
                         */

                        /**
                         * Register a callback to run when the classes of this fragment changes
                         *
                         * @example
                         * Fragment.one("#myFragment").registerOnClassChangedHandler((classes)=>{
                         *     //Some classes changed on this fragment
                         * });
                         *
                         * @param {Fragments.Fragment~fragmentClassChangedCallback} callback - The callback to run when classes change on the fragment
                         */
                        registerOnClassChangedHandler(callback) {
                            let self = this;

                            this.fragmentClassChangedCallbacks.push(callback);

                            return {
                                delete: ()=>{
                                    self.fragmentClassChangedCallbacks.splice(self.fragmentClassChangedCallbacks.indexOf(callback), 1);
                                }
                            }
                        }

                        /**
                         * Handles when classes change on the fragment
                         * @private
                         * @param classes
                         */
                        onClassChanged(classes) {
                            this.fragmentClassChangedCallbacks.slice().forEach((cb)=>{
                                cb(classes);
                            });
                        }

                        /**
                         * The type of this fragment
                         * @type {string}
                         * @readonly
                         */
                        get type() {
                            return this.element.getAttribute("data-type");
                        }

                        /**
                         * Require this fragment and return the result. What require does depends on what type of fragment it is.
                         * @example
                         * let result = await Fragment.one("#myFragment").require()
                         *
                         * @abstract
                         * @param {json} [options] - The options to pass to require
                         * @returns {*} result of the require action
                         */
                        async require(options = {}) {
                            //Ovewritten in subclass
                        }

                        /**
                         * Tell this fragment to unload itself
                         * @example
                         * Fragment.one("#myFragment").unload();
                         */
                        unload() {
                            let self = this;

                            this.fragmentUnloadedCallbacks.slice().forEach((callback)=>{
                                callback(self);
                            });

                            if(this.supportsAutoDom()) {
                                this.clearAutoDom();
                            }

                            this.stopObserver();
                        }

                        /**
                         * Called when all fragments are loaded
                         * @private
                         */
                        async onFragmentsLoaded() {
                            if (this.auto && !Fragment.disableAutorun) {
                                await this.insertAutoDom();
                            }
                        }

                        /**
                         * @private
                         * @returns {boolean} - True/False depending on if this fragments supports automatic behaviour
                         */
                        supportsAuto() {
                            return this.supportsAutoDom();
                        }

                        /**
                         * @private
                         * @returns {boolean} True/False depending on if this fragment supports automatic dom insertion
                         */
                        supportsAutoDom() {
                            //Override in subclass
                            return false;
                        }


                        /**
                         * Setup handling of automatic dom insertion
                         * @private
                         * @returns {Promise<void>}
                         */
                        setupAutoDomHandling() {
                            if(!this.supportsAutoDom()) {
                                return;
                            }

                            let self = this;

                            this.registerOnFragmentChangedHandler((context) => {
                                self.autoDomDirty = true;
                                if (self.auto && !Fragment.disableAutorun) {
                                    self.insertAutoDom();
                                }
                            });
                        }

                        /**
                         * Called when auto attribute is changed on this fragment
                         * @private
                         * @param {boolean} auto - The new state of auto
                         */
                        onAutoChanged(auto) {
                            this.fragmentAutoChangedCallbacks.forEach((cb)=>{
                                cb(this, auto);
                            });

                            if(!this.supportsAutoDom()) {
                                return;
                            }

                            if (auto && !Fragment.disableAutorun) {
                                this.insertAutoDom();
                            } else {
                                this.clearAutoDom();
                            }
                        }

                        /**
                         * Create an instance of the automatic dom
                         * @private
                         * @returns {Promise<*>}
                         */
                        async createAutoDom() {
                            if(!this.supportsAutoDom()) {
                                return;
                            }

                            try {
                                return await this.require();
                            } catch(e) {
                                return null;
                            }
                        }

                        /**
                         * Ask this fragment to insert its automatic dom (regardless of Fragment.disableAutorun)
                         * @ignore
                         * @returns {Promise<void>} - Promise that resolves when the automatic dom is inserted into the document
                         */
                        insertAutoDom() {
                            let self = this;

                            if(!this.supportsAutoDom()) {
                                return;
                            }

                            if(!this.autoDomDirty) {
                                console.debug("Not inserting autoDom, as it is already present and not flagged dirty:", this.uuid);
                                return new Promise(async (resolve)=>{
                                    while(!self.autoDomReady) {
                                        await new Promise((timeoutPromiseResolve)=>{
                                            setTimeout(()=>{
                                                timeoutPromiseResolve();
                                            }, 10);
                                        });
                                    }
                                    resolve();
                                });
                            }

                            this.autoDomDirty = false;
                            this.autoDomReady = false;

                            return new Promise(async (resolve, reject)=>{
                                try {
                                    let autoDomContent = await this.createAutoDom();

                                    let oldTransient = cQuery("transient.autoDom#" + self.uuid);

                                    if(oldTransient.length > 0) {
                                        oldTransient[0].setAttribute("class", "autoDom");

                                        //Fix missing classes
                                        self.element.classList.forEach((c)=>{
                                            if (!oldTransient[0].classList.contains(c)) oldTransient[0].classList.add(c);
                                        });

                                        try {
                                            diff.innerHTML(oldTransient[0], autoDomContent, { parser: { strict: true } });
                                        } catch (ex){
                                            console.error("Failed to perform autoDOM diffing", ex);
                                            diff.release(oldTransient[0]); // Reset state trackers since the patch was not applied
                                        }

                                        function cssPath(element, path= []) {
                                            if(element.parentNode == null) {
                                                // Document fragment is the top node
                                                return path.reverse().join(" > ");
                                            }

                                            const parent = element.parentNode;
                                            const childIndex = Array.from(parent.children).indexOf(element) + 1;
                                            path.push(element.nodeName.toLowerCase()+":nth-child("+childIndex+")");
                                            return cssPath(parent, path);
                                        }

                                        // Update innerHTML for each template, as this is not part of the dom, and would not be updated otherwise
                                        cQuery(autoDomContent).find("template").forEach((template)=>{
                                            let path = cssPath(template);
                                            oldTransient[0].querySelector(path).innerHTML = autoDomContent.querySelector(path).innerHTML;
                                        });
                                    } else {
                                        let transient = cQuery("<transient></transient>");
                                        transient[0].setAttribute("id", self.uuid);
                                        transient.addClass("autoDom");

                                        self.element.classList.forEach((c)=>{
                                            transient.addClass(c);
                                        });

                                        if (autoDomContent != null && autoDomContent !== "") {
                                            transient.append(autoDomContent);
                                        }
                                        self.element.parentNode.insertBefore(transient[0], self.element.nextSibling);
                                    }

                                    self.autoDomReady = true;

                                    resolve();
                                } catch(e) {
                                    console.warn("Unable to insertAutoDom: ", e);
                                    self.autoDomDirty = true;
                                    reject();
                                }
                            });
                        }

                        /**
                         * Clear this fragments automatic dom from the document
                         * @ignore
                         */
                        clearAutoDom() {
                            if(!this.supportsAutoDom()) {
                                return;
                            }
                            cQuery("transient.autoDom#" + this.uuid).remove();
                            this.autoDomDirty = true;
                            this.autoDomReady = false;
                        }

                        /**
                         * Returns whether this fragment supports the run flag
                         * @private
                         * @returns {boolean}
                         */
                        supportsRun() {
                            return false;
                        }

                        /**
                         * Returns a dompath for finding this fragment
                         */
                        getDomPath() {
                            let child = this.element;
                            let parent = this.element.parentNode;

                            let domPath = [];

                            while(parent.parentNode != null) {
                                let children = Array.from(parent.childNodes);

                                let childIndex = children.indexOf(child);

                                domPath.push({
                                    parent: parent.tagName,
                                    childIndex: childIndex
                                });

                                child = parent;
                                parent = parent.parentNode;
                            }

                            domPath.reverse()

                            return domPath;
                        }

                        static findFromDomPath(domPath) {
                            let currentParent = document.querySelector(domPath[0].parent);

                            for(let dp of domPath) {
                                if(currentParent.tagName !== dp.parent) {
                                    throw new Error("DomPath invalid, should have seen "+dp.parent+" saw "+currentParent.tagName);
                                }
                                currentParent = Array.from(currentParent.childNodes)[dp.childIndex];
                            }

                            return currentParent;
                        }

                        /**
                         * Create a fragment of the given type.
                         *
                         * If no Fragment is registered for the given type, null is returned.
                         *
                         * @example
                         * let myJSFragment = Fragment.create("text/javascript");
                         *
                         * @param {string} type the type of fragment to create
                         * @returns {Fragments.Fragment} the created fragment, or null
                         */
                        static create(type) {
                            if (!Fragment.fragmentTypes.has(type)) {
                                console.error("Creating fragment of unregistered type:", type);
                                return null;
                            }

                            let fragmentDom = cQuery("<code-fragment data-type='" + type + "'></code-fragment>");

                            Fragment.setupFragment(fragmentDom);

                            return fragmentDom[0].fragment;
                        }

                        /**
                         * Registers a new fragment type
                         * @ignore
                         * @param {string} fragmentClass the fragment type to register
                         */
                        static registerFragmentType(fragmentClass) {
                            if (Fragment.fragmentTypes.has(fragmentClass.type())) {
                                console.error("Already have registered fragment type:", fragmentClass.type());
                                return;
                            }
                            Fragment.fragmentTypes.set(fragmentClass.type(), fragmentClass);

                            return Fragment.loadUnknownFragments(fragmentClass.type());
                        }

                        /**
                         * Unregisters a fragment type, this also triggers unload on all fragments of this type that is currently loaded
                         * @ignore
                         * @param {string} fragmentClass the fragment type to unregister
                         */
                        static unRegisterFragmentType(fragmentClass) {
                            Fragment.fragmentTypes.delete(fragmentClass.type());

                            // Remove and reinsert all fragments of this type as unknown
                            document.querySelectorAll("code-fragment[data-type='" + fragmentClass.type() + "']").forEach((fragmentElement) => {
                                fragmentElement.fragment?.unload();
                                Fragment.saveUnknownFragment(fragmentElement, fragmentClass.type());
                            });
                        }

                        /**
                         * Sets up the given fragment
                         * @private
                         * @param {cQuery} fragment - the fragment to set up
                         */
                        static setupFragment(fragment) {
                            if (fragment[0].fragment != null) return; //Already setup as fragment

                            let fragmentType = fragment[0].getAttribute("data-type");
                            if (!Fragment.fragmentTypes.has(fragmentType)) {
                                //Unknown fragment type

                                if (fragmentType != null) {
                                    Fragment.saveUnknownFragment(fragment, fragmentType);
                                }

                                return null;
                            }

                            let fragmentClass = Fragment.fragmentTypes.get(fragmentType);
                            return new fragmentClass(fragment);
                        }

                        /**
                         * Tries to setup all current and future fragments on the DOM
                         * @ignore
                         */
                        static async setupFragments() {
                            let foundFragments = [];

                            //Check fragments already in DOM
                            cQuery("code-fragment").forEach((fragmentDom) => {
                                fragmentDom = cQuery(fragmentDom);
                                let fragment = Fragment.setupFragment(fragmentDom);

                                if (fragment !== null) {
                                    foundFragments.push(fragment);
                                }
                            });

                            await Fragment.runFragmentsLoaded();

                            //Observe newly added fragments, and deleted fragments
                            let observer = new MutationObserver(async (mutations) => {

                                let foundFragments = [];

                                mutations.forEach((mutation) => {
                                    Array.from(mutation.addedNodes).forEach((node) => {
                                        node = cQuery(node);
                                        if (node.is("code-fragment")) {
                                            let fragment = Fragment.setupFragment(node);
                                            if(fragment != null) {
                                                foundFragments.push(fragment);
                                            }
                                        } else {
                                            if (node[0].querySelector != null) {
                                                node.find("code-fragment").forEach((child) => {
                                                    child = cQuery(child);
                                                    let fragment = Fragment.setupFragment(child);
                                                    if(fragment != null) {
                                                        foundFragments.push(fragment);
                                                    }
                                                });
                                            }
                                        }
                                    });
                                    Array.from(mutation.removedNodes).forEach((node) => {
                                        if(node.matches != null && node.matches("code-fragment")) {
                                            node.fragment?.unload();
                                        } else if(node.querySelector != null) {
                                            node.querySelectorAll("code-fragment").forEach((child)=>{
                                                child.fragment?.unload();
                                            });
                                        }
                                    });
                                });

                                await Fragment.runFragmentsLoaded();
                            });

                            observer.observe(document, {
                                attributes: false,
                                subtree: true,
                                childList: true
                            });
                        }

                        /**
                         * Loads all currently unloaded fragments
                         * @ignore
                         * @returns {Promise<void>} - Promise that resolves when all unloaded fragments are done loading
                         */
                        static async runFragmentsLoaded() {
                            if(!Fragment.allInstalledRun) {
                                return;
                            }

                            //Check if currently loading
                            while (Fragment.currentlyLoadingFragments) {
                                await new Promise((resolve) => {
                                    setTimeout(() => {
                                        resolve();
                                    }, 0);
                                });
                            }

                            Fragment.currentlyLoadingFragments = true;

                            let unloadedFragments = Fragment.find("code-fragment").filter((fragment)=>{
                                let isLoaded = fragment.isLoaded;
                                fragment.isLoaded = true;
                                return !isLoaded;
                            });

                            for(let fragment of unloadedFragments) {
                                fragment.isLoaded = true;
                                await fragment.onFragmentsLoaded();
                            }

                            Fragment.currentlyLoadingFragments = false;
                        }

                        /**
                         * Saves the given fragment for later loading when its no longer unknown
                         * @private
                         * @param {cQuery} fragment - the fragment to save
                         * @param {string} type - the type of the fragment
                         */
                        static saveUnknownFragment(fragment, type) {

                            //Unpack cQuery/jQuery objects, we want unique check of Set to work.
                            if (fragment[0] != null) {
                                fragment = fragment[0];
                            }

                            let fragmentsOfType = Fragment.unknownFragments.get(type);

                            if (fragmentsOfType == null) {
                                fragmentsOfType = new Set();
                                Fragment.unknownFragments.set(type, fragmentsOfType);
                            }

                            fragmentsOfType.add(fragment);
                        }

                        /**
                         * Loads all unknown fragments of a given type
                         * @private
                         * @param {type} type the fragment type to load
                         */
                        static loadUnknownFragments(type) {
                            let unknownFragments = Fragment.unknownFragments.get(type);

                            if (unknownFragments != null) {

                                let unknownFragmentsCopy = Array.from(unknownFragments);

                                //Clear the Set, fragments will be readded if not handled
                                unknownFragments.clear();

                                unknownFragmentsCopy.forEach((fragment) => {
                                    let frag = Fragment.setupFragment(cQuery(fragment));
                                });

                                return Fragment.runFragmentsLoaded();
                            }

                            return Promise.resolve();
                        }

                        /**
                         * Returns the first fragment that is found from the given query
                         *
                         * This is the equivalent of taking the first result of Fragment.find(query)
                         *
                         * @example
                         * let myFragment = Fragment.one("#myFragment");
                         *
                         * @param {string|cQuery|Array|Node} query - The query used to find fragments. Can be a css selector, a cQuery object, a dom element or an array of dom elements.
                         * @returns {Fragments.Fragment} - the found fragment, or null if none could be found
                         */
                        static one(query) {
                            let fragments = Fragment.find(query);

                            if (fragments.length > 0) {
                                return fragments[0];
                            }

                            return null;
                        }

                        /**
                         * Finds all fragments based on a given query
                         *
                         * @example
                         * let fragments = Fragment.find(".someClass");
                         *
                         * @param {string|cQuery|Array|Node} query - The query used to find fragments. Can be a css selector, a cQuery object, a dom element or an array of dom elements.
                         * @returns {Fragments.Fragment[]} The found fragments
                         */
                        static find(query) {
                            let fragments = [];

                            if (query != null) {
                                if (typeof query === "string") {
                                    cQuery(query).forEach((result) => {
                                        let fragment = result.fragment;
                                        if (fragment != null) {
                                            fragments.push(fragment);
                                        }
                                    });

                                } else if (Array.isArray(query) || query instanceof Array) {
                                    query.forEach((item) => {
                                        fragments = fragments.concat(Fragment.find(item));
                                    });

                                } else if (typeof query === "object") {
                                    if (query instanceof Fragment) {
                                        fragments.push(query);
                                    } else if (query instanceof HTMLElement) {
                                        let fragment = query.fragment;
                                        if (fragment != null) {
                                            fragments.push(fragment);
                                        }
                                    } else if (query instanceof NodeList) {
                                        fragments = fragments.concat(Fragment.find(Array.from(query)));
                                    }
                                }
                            }

                            return fragments;
                        }

                        static fromFragmentUUID(uuid) {
                            let node = document.querySelector("code-fragment[data-uuid='"+uuid.replace("_", "-")+"']");
                            return node?.fragment;
                        }

                        static addAllFragmentsLoadedCallback(callback) {
                            if (Fragment.initialLoadComplete){
                                callback(); // callbacks added late are called immedaitely
                            } else {
                                Fragment.allFragmentsLoadedCallbacks.push(callback);
                            }
                        }

                    }; window.Fragment = Fragment;

                    Fragment.allInstalledRun = false;
                    Fragment.initialLoadComplete = false;
                    Fragment.fragmentTypes = new Map();
                    Fragment.unknownFragments = new Map();
                    Fragment.disableAutorun = false;
                    Fragment.currentlyLoadingFragments = false;
                    Fragment.allFragmentsLoadedCallbacks = [];

                    const urlParams = new URLSearchParams(location.search);
                    Fragment.disableAutorun = (urlParams.get("codestrates") === "false");

                    if(window.disableCodestratesFragmentsAutorun === true) {
                        Fragment.disableAutorun = true;
                    }

                    Fragment.setupFragments();

                    wpm.onAllInstalled(()=>{
                        Fragment.allInstalledRun = true;
                        Fragment.runFragmentsLoaded().then(()=>{
                            Fragment.initialLoadComplete = true;
                            Fragment.allFragmentsLoadedCallbacks.forEach((callback)=>{
                                callback();
                            });
                        });
                    });

                    </SCRIPT><SCRIPT id="stackwalker-script" type="disabled">
                    /**
                     *  StackWalker
                     *  An exception parser that that tries to clean out useless info from
                     *  browser stack traces and provide only Codestrates-relevant parts
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * StackWalker can compactify stack traces to remove codestrates internal traces, thus making them easier to read
                     */
                    class StackWalker {
                        /**
                         * Given a full stack trace, produces a reduced stacktrace where only codestrate
                         * stack markers are used instead of every method invocation.
                         *
                         * @param {string[]} stack
                         * @returns {string[]} The cleaned stack trace array
                         */
                        static compactify(stack){
                            //Attempt to clean up some codestrates internal method code
                            let cleanedStack = [];

                            //If find pattern of Function.execute, codeStratesEvalInContext, eval, remove all 3
                            stackLoop: for(let i = 0; i<stack.length; i++) {
                                let si = stack[i];

                                cleanPatternLoop: for(let cleanPattern of StackWalker.stackCleanPatterns) {
                                    try {
                                        for(let j = 0; j<cleanPattern.pattern.length; j++) {
                                            let pattern = cleanPattern.pattern[j];
                                            let method = stack[i+j].method;

                                            if(pattern.startsWith("~")) {
                                                pattern = pattern.substring(1);
                                                if(method.indexOf(pattern) === -1) {
                                                    //This pattern did not match
                                                    continue cleanPatternLoop;
                                                }
                                            } else {
                                                if(method !== pattern) {
                                                    //This pattern did not match
                                                    continue cleanPatternLoop;
                                                }
                                            }
                                        }

                                        i += cleanPattern.pattern.length-1;

                                        if(cleanPattern.output != null) {
                                            let method = cleanPattern.output.method;

                                            if(typeof method === "function") {
                                                method = method(si);
                                            }

                                            cleanedStack.push({
                                                method: method,
                                                lineNumber: cleanPattern.output.lineNumber?si.lineNumber:null
                                            });
                                        }

                                        continue stackLoop;
                                    } catch(e) {

                                    }
                                }

                                cleanedStack.push(si);
                            }

                            return cleanedStack;
                        }
                    }

                    window.StackWalker = StackWalker;

                    StackWalker.stackCleanPatterns = [];

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "eval",
                            "codeStratesEvalInContext",
                            "Function.execute"
                        ],
                        output: null
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "codeStratesEvalInContext",
                            "Function.execute",
                            "~.require"
                        ],
                        output: null
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "_setup",
                            "_start",
                            "new _",
                            "internalP5Function"
                        ],
                        output: null
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "_.n.default.redraw",
                            "_draw"
                        ],
                        output: null
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "~.require",
                            "~.onFragmentsLoaded",
                            "Function.runFragmentsLoaded"
                        ],
                        output: {
                            method: "<Codestrate Autostart>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "~.require",
                            "eval",
                            "eval",
                            "Set.forEach",
                            "Function.triggerEvent",
                            "MenuItem.onAction",
                            "MenuItem.triggerOnAction",
                            "Menu.handleItemAction",
                            "HTMLDivElement.eval",
                            "h.a.emit",
                            "Object.notifySelected",
                            "_.handleItemAction",
                            "HTMLDivElement.handleItemAction_",
                            "d.a.emit",
                            "Object.notifyAction",
                            "d.handleClick",
                            "d.handleClickEvent_"
                        ],
                        output: {
                            method: "<Codestrate Run>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "TypeScriptAutoRunInternal",
                            "eval",
                            "Object.execCb",
                            "e.check",
                            "eval",
                            "eval",
                            "eval",
                            "each",
                            "emit",
                            "e.check",
                            "enable",
                            "e.init",
                            "a",
                            "Object.completeLoad",
                            "HTMLScriptElement.onScriptLoad"
                        ],
                        output: {
                            method: "<Codestrate Autorun>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "eval",
                            "Object.execCb",
                            "e.check",
                            "eval",
                            "eval",
                            "eval",
                            "each",
                            "emit",
                            "e.check",
                            "enable",
                            "e.init",
                            "a",
                            "Object.completeLoad",
                            "HTMLScriptElement.onScriptLoad"
                        ],
                        output: {
                            method: "<Codestrate Run>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "eval",
                            "Object.execCb",
                            "e.check",
                            "enable",
                            "e.init",
                            "eval"
                        ],
                        output: {
                            method: "<Codestrate Run>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "P5Fragment.require",
                            "P5Fragment.createAutoDom",
                            "P5Fragment.insertAutoDom",
                            "eval",
                            "eval",
                            "Array.forEach",
                            "P5Fragment.triggerFragmentChanged",
                            "P5Fragment.mutationCallback",
                            "MutationObserver.mutationHandler"
                        ],
                        output: {
                            method: "<Codestrate Autorun>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "P5Fragment.require",
                            "P5Fragment.createAutoDom",
                            "P5Fragment.insertAutoDom",
                            "P5Fragment.onFragmentsLoaded",
                            "Function.runFragmentsLoaded"
                        ],
                        output: {
                            method: "<Codestrate Autorun>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "P5Fragment.require",
                            "P5Fragment.createAutoDom",
                            "P5Fragment.insertAutoDom",
                            "eval",
                            "eval",
                            "Array.forEach",
                            "P5Fragment.triggerFragmentChanged",
                            "P5Fragment.executeObserverless",
                            "CodemirrorEditor.handleModelChanged",
                            "eval",
                            "signal",
                            "endOperation_finish",
                            "endOperations",
                            "at",
                            "finishOperation",
                            "endOperation",
                            "runInOp",
                            "~",
                            "HTMLTextAreaElement.<anonymous>"
                        ],
                        output: {
                            method: "<Codestrate Autorun>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "P5Fragment.require",
                            "P5Fragment.createAutoDom",
                            "P5Fragment.insertAutoDom",
                            "eval",
                            "eval",
                            "Array.forEach",
                            "P5Fragment.triggerFragmentChanged",
                            "P5Fragment.executeObserverless",
                            "CodemirrorEditor.handleModelChanged",
                            "eval",
                            "signal",
                            "endOperation_finish",
                            "endOperations",
                            "at",
                            "finishOperation",
                            "endOperation",
                            "HTMLTextAreaElement.<anonymous>"
                        ],
                        output: {
                            method: "<Codestrate Autorun>",
                            lineNumber: false
                        }
                    });

                    StackWalker.stackCleanPatterns.push({
                        pattern: [
                            "~CS_ASYNC_fragment_"
                        ],
                        output: {
                            method: (si) =>{
                                //Internal fragment
                                let fragmentUUID = si.method.substring(si.method.indexOf("CS_ASYNC_fragment_")+9).replace("_", "-");
                                let fragment = Fragment.fromFragmentUUID(fragmentUUID);

                                let attrName = fragment.element.getAttribute("name");
                                let attrId = fragment.element.getAttribute("id");

                                let name = (attrName != null && attrName.trim() !== "" ? attrName : "code-fragment");

                                if(attrId != null && attrId.trim() !== "") {
                                    name += "#"+attrId;
                                }

                                return fragment.constructor.name+" "+name;
                            },
                            lineNumber: true
                        }
                    })

                    /**
                     * A StackTrace object
                     * @memberof StackWalker
                     */
                    class StackTrace {
                        constructor(name, stack, extraReason) {
                            /** @member {string} */
                            this.name = name;
                            /** @member {string[]} */
                            this.stack = stack;
                            /** @member {string} */
                            this.extraReason = extraReason;
                        }
                    };

                    window.StackWalker.StackTrace = StackTrace;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="js-eval-engine" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Javascript Evaluator Engine",
                        "dependencies": [
                            "#EventSystem"
                        ],
                        "assets": [],
                        "license": "Apache 2.0",
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="jsEvalEngine-script" type="disabled">
                    /**
                     *  JsEvalEngine
                     *  Evaluate js while keeping track of it
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    function codeStratesEvalInContext(code, context) {
                        with(context) {
                            eval(code);
                        }
                    }

                    window.JsEvalEngine = class JsEvalEngine {
                        static async execute(code, options, fragment = null) {

                            options = Object.assign({}, JsEvalEngine.defaultOptions(fragment), options);

                            let resolver = null;
                            let rejector = null;

                            let asyncPromise = new Promise((resolve, reject)=>{
                                resolver = resolve;
                                rejector = reject;
                            });

                            let clonedConsole = Object.assign({}, console, options.customConsole);

                            let context = {
                                exports: {},
                                asyncResolve: resolver,
                                asyncReject: rejector,
                                console: clonedConsole,
                                fragmentSelfReference: fragment,
                                error: (e)=>{
                                    let parsedStack = JsEvalEngine.parseErrorStack(e.name, e.stack, e);
                                    EventSystem.triggerEvent("Codestrates.Fragment.Error", {
                                        messages: [parsedStack],
                                        fragment: fragment
                                    });
                                    let compactStack = StackWalker.compactify(parsedStack.stack);
                                    let lineNumber = compactStack[0].lineNumber;
                                    JsEvalEngine.doLog(console.error, fragment, lineNumber, parsedStack.extraReason, compactStack);
                                }
                            };

                            if(options.context != null) {
                                context = Object.assign({}, context, options.context);
                            }

                            let asyncCode = code;

                            if(options.async) {
                                asyncCode = JsEvalEngine.wrapInAsync(code, fragment != null ? "CS_ASYNC_" + fragment.uuid.replace("-", "_") : null);
                            }

                            try {
                                codeStratesEvalInContext.call(null, asyncCode, context);
                                if(!options.async) {
                                    context.asyncResolve();
                                }
                            } catch(e) {
                                context.error(e);
                                throw e;
                            }

                            await asyncPromise.catch((e)=>{context.error(e); throw e});

                            return context[options.exportsName];
                        }

                        static wrapInAsync(code, methodName) {
                            if(methodName == null) {
                                methodName = "anonymousAsyncEval";
                            }

                            //Make code async
                            return `(async function ${methodName}() { ${code} \n })().then(()=>{asyncResolve();}).catch((e)=>{asyncReject(e);});`;
                        }

                        static parseErrorStack(name, stack, error) {
                            let parsedStackTrace = [];
                            let extraReason = null;

                            if(stack == null) {
                                console.warn("parseErrorStack: empty stack!");
                                return new StackWalker.StackTrace(
                                    error,
                                    [],
                                    null
                                );
                            }

                            if(window.chrome) {
                                let stackSplit = stack.split("\n");

                                if(!stackSplit[0].trim().startsWith("at")) {
                                    extraReason = stackSplit[0];
                                }

                                stackSplit.filter((line)=>{
                                    return line.trim().startsWith("at");
                                }).forEach((line)=>{
                                    let trimmedLine = line.trim();

                                    let functionName = trimmedLine.substring(3, trimmedLine.indexOf("(")).trim();

                                    let lineNumberAndPosition = trimmedLine.substring(trimmedLine.indexOf("),")+2).trim().split(":");

                                    let lineNumber = parseInt(lineNumberAndPosition[1]);

                                    if(Number.isNaN(lineNumber)) {
                                        lineNumber = null;
                                    }

                                    parsedStackTrace.push({
                                        method: functionName,
                                        lineNumber: lineNumber,
                                        debug: trimmedLine
                                    });
                                });
                            } else if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1) {
                                let stackSplit = stack.split("\n");

                                stackSplit.forEach((line) => {
                                    let trimmedLine = line.trim();

                                    let functionName = trimmedLine.substring(0, trimmedLine.indexOf("@")).trim();

                                    let lineNumberAndPosition = trimmedLine.substring(trimmedLine.lastIndexOf(">") + 2).trim().split(":");

                                    let lineNumber = parseInt(lineNumberAndPosition[1]);

                                    if (Number.isNaN(lineNumber)) {
                                        lineNumber = null;
                                    }

                                    parsedStackTrace.push({
                                        method: functionName,
                                        lineNumber: lineNumber,
                                        debug: trimmedLine
                                    });
                                });
                            } else {
                                console.log("Unsupported browser for parsing stack trace: ", stack);
                                parsedStackTrace = stack;
                            }

                            return new StackWalker.StackTrace(
                                name,
                                parsedStackTrace,
                                extraReason
                            );
                        }

                        static defaultOptions(fragment = null) {
                            return {
                                context: null,
                                exportsName: "exports",
                                async: true,
                                customConsole: {
                                    log: (...messages)=> {
                                        JsEvalEngine.doLog(console.log, fragment, null, ...messages);
                                        if(typeof EventSystem !== "undefined") {
                                            EventSystem.triggerEvent("Codestrates.Fragment.Log", {
                                                messages: messages,
                                                fragment: fragment
                                            });
                                        }
                                    },
                                    warn: (...messages)=>{
                                        JsEvalEngine.doLog(console.warn, fragment, null, ...messages);
                                        if(typeof EventSystem !== "undefined") {
                                            EventSystem.triggerEvent("Codestrates.Fragment.Warn", {
                                                messages: messages,
                                                fragment: fragment
                                            });
                                        }
                                    },
                                    error: (...messages)=>{
                                        JsEvalEngine.doLog(console.error, fragment, null, ...messages);
                                        if(typeof EventSystem !== "undefined") {
                                            EventSystem.triggerEvent("Codestrates.Fragment.Error", {
                                                messages: messages,
                                                fragment: fragment
                                            });
                                        }
                                    }
                                }
                            };
                        }

                        static doLog(logger, fragment, lineNumber, ...messages) {
                            if(fragment != null) {
                                let name = fragment.element.getAttribute("name");
                                let id = fragment.element.getAttribute("id");

                                logger("Fragment ["+(name!=null&&name.trim()!==""?name:fragment.type)+(id!=null&&id.trim()!==""?"#"+id:"")+(lineNumber!=null?":"+lineNumber:"")+"]", ...messages);
                            } else {
                                logger(...messages);
                            }
                        }
                    };

                    window.addEventListener("unhandledrejection", (evt)=>{
                        if(evt.reason != null) {
                            let parsedStack = JsEvalEngine.parseErrorStack(evt.reason.name, evt.reason.stack);
                            EventSystem.triggerEvent("Codestrates.Fragment.Error", {
                                messages: ["Uncaught rejection in promise: ", parsedStack]
                            });
                        } else {
                            console.warn("Did not include a reason property:", evt);
                        }
                    });

                    window.addEventListener("error", (evt)=>{
                        if(evt.error != null) {
                            let parsedStack = JsEvalEngine.parseErrorStack(evt.error.message, evt.error.stack);
                            EventSystem.triggerEvent("Codestrates.Fragment.Error", {
                                messages: ["Uncaught exception: ", parsedStack]
                            });
                        } else {
                            console.warn("Did not include an error property:", evt);
                        }
                    });

                    //Setup infinite stack depth
                    Error.stackTraceLimit = Infinity;

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_html" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "HTML Fragment support for Codestrates",
                        "dependencies": [
                            "#fragment_core"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_html-script" type="disabled">
                    /**
                     *  HtmlFragment
                     *  Fragments with html that can be injected into the page in the same place
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Fragment, wpm */

                    wpm.onRemoved(()=>{
                        Fragment.unRegisterFragmentType(HtmlFragment);
                    });

                    /**
                     * A fragment containing html
                     *
                     * Supports autodom insertion
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class HtmlFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        supportsAutoDom() {
                            return true;
                        }

                        /**
                         * Get a document fragment containing the html from this fragment
                         *
                         * @example
                         * let documentFragment = Fragment.one("#myHtmlFragment").require();
                         *
                         * @returns {Promise<DocumentFragment>}
                         */
                        async require(options) {
                            let domFragment = document.createDocumentFragment();

                            let dom = cQuery("<div>"+this.raw+"</div>");

                            Array.from(dom[0].childNodes).forEach((node)=>{
                                domFragment.appendChild(node);
                            });

                            return domFragment;
                        }

                        getTextContentNode() {
                            if(this.element.childNodes.length > 1 || (this.element.firstChild != null && !(this.element.firstChild instanceof Text))) {
                                //We have at least one child, first of those is not a Text node, convert
                                let textNode = document.createTextNode("");
                                let content = this.element.innerHTML;
                                this.element.innerHTML = "";
                                this.element.appendChild(textNode);
                                textNode.nodeValue = content;
                                console.log("Converted HTML to single textNode");
                            }

                            return super.getTextContentNode();
                        }

                        static type() {
                            return "text/html";
                        }
                    }; window.HtmlFragment = HtmlFragment;

                    Fragment.registerFragmentType(HtmlFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_json" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "JSON-data Fragment for Codestrates",
                        "dependencies": [
                            "#fragment_core"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_json-script" type="disabled">
                    /**
                     *  JSONFragment
                     *  Fragments with json data that can be included
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Fragment, wpm */

                    wpm.onRemoved(()=>{
                        Fragment.unRegisterFragmentType(JSONFragment);
                    });

                    /**
                     * A fragment that contains json
                     *
                     * @extends Fragments.Fragment
                     * @memberof Fragments
                     * @hideconstructor
                     */
                    class JSONFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        /**
                         * Get the contained json as an object
                         * @example
                         * let jsonElement = Fragment.one("#myJsonFragment").require();
                         * @returns {Promise<Object>} - Promise that resolves to the json object with the json from this fragment.
                         */
                        async require(options = {}) {
                            return JSON.parse(this.raw);
                        }

                        static type() {
                            return "application/json";
                        }
                    }; window.JSONFragment = JSONFragment;

                    Fragment.registerFragmentType(JSONFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_wpm-descriptor" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "WPM package descriptor Fragment for Codestrates",
                        "dependencies": [
                            "#fragment_core"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_descriptor-script" type="disabled">
                    /**
                     *  DescriptorFragment
                     *  Support for WPM package descriptors in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Fragment, wpm, WPMv2 */

                    wpm.onRemoved(() => {
                        Fragment.unRegisterFragmentType(DescriptorFragment);
                    });

                    /**
                     * A fragment containing a WPM descriptor
                     *
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class DescriptorFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        getTextContentNode() {
                            let self = this;

                            let descriptor = this.element.querySelector("wpm-descriptor");
                            if (!descriptor) {
                                this.executeObserverless(() => {
                                    descriptor = document.createElement("wpm-descriptor");
                                    self.element.appendChild(descriptor);
                                    WPMv2.stripProtection(descriptor);
                                    descriptor.textContent = `{
                        "description": "",
                        "dependencies": [
                        ],
                        "assets": [],
                        "version": "1"
                    }`;
                                },null, true);
                            }

                            this.checkTextContentNode(descriptor);

                            return descriptor;
                        }

                        /**
                         *  A json object containing the descriptor json
                         * @example
                         * let descriptorJson = Fragment.one("#myDescriptorFragment").require();
                         * @returns {Promise<Object>}
                         */
                        async require(options = {}) {
                            return JSON.parse(this.raw);
                        }

                        static type() {
                            return "wpm/descriptor";
                        }
                    };

                    window.DescriptorFragment = DescriptorFragment;
                    Fragment.registerFragmentType(DescriptorFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_css" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "CSS Fragment for Codestrates",
                        "dependencies": [
                            "#fragment_core"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_css-script" type="disabled">
                    /**
                     *  CSSFragment
                     *  Fragments with css that can be injected into the page
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/


                    /* global webstrate, cQuery, Fragment, wpm */
                    wpm.onRemoved(()=>{
                        Fragment.unRegisterFragmentType(CSSFragment);
                    });

                    /**
                     * A fragment that contains css code
                     *
                     * Supports autodom insertion
                     * @hideconstructor
                     * @memberof Fragments
                     * @extends Fragments.Fragment
                     */
                    class CSSFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        /**
                         * Creates a new style element with the styles represented by this css fragment inserted.
                         *
                         * @example
                         * let styleElm = Fragment.one("#myCssFragment").require();
                         *
                         * @returns {Promise<HTMLStyleElement>} - Promise that resolves to the style element
                         */
                        async require(options = {}) {
                            let style = document.createElement("style");

                            style.textContent = this.raw;

                            return style;
                        }

                        supportsAutoDom() {
                            return true;
                        }

                        static type() {
                            return "text/css";
                        }
                    }; window.CSSFragment = CSSFragment;

                    Fragment.registerFragmentType(CSSFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_scss" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "SCSS Fragment for Codestrates",
                        "dependencies": [
                            "#fragment_core",
                            "wpm_js_libs #sass_js"
                        ],
                        "license": "Apache 2.0 (w/MIT)",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_scss-script" type="disabled">
                    /**
                     *  SCSSFragment
                     *  Compose and compile SCSS-scripts in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Fragment, fetchSassWorkerBlob, URL, wpm */

                    wpm.onRemoved(() => {
                        Fragment.unRegisterFragmentType(SCSSFragment);
                    });

                    /**
                     * A fragment containing scss
                     *
                     * Supports autodom insertion
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class SCSSFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        /**
                         * Create a style element containing the css rules resulting from compiling this fragments scss
                         * @example
                         * let styleElm = Fragment.one("#myScssFragment").require();
                         * @returns {Promise<HTMLStyleElement>}
                         */
                        require(options) {
                            let self = this;

                            return new Promise(async (resolve, reject) => {
                                // Check cached data
                                if (typeof AutoDOMCache !== "undefined"){
                                    let cache = await AutoDOMCache.get(self);
                                    if (cache!==null){
                                        let style = document.createElement("style");
                                        style.textContent = cache;
                                        resolve(style);
                                        return;
                                    }
                                }

                                let start = Date.now();

                                //Check for compiler
                                await new Promise((resolveCompiler)=>{
                                    if(SCSSFragment.compiler == null) {
                                        requirejs(["sass/sass"], (Sass)=> {
                                            fetchSassWorkerBlob().then((blob) => {
                                                SCSSFragment.compiler = new Sass(URL.createObjectURL(blob));
                                                resolveCompiler();
                                            });
                                        });
                                    } else {
                                        resolveCompiler();
                                    }
                                });

                                SCSSFragment.compiler.compile(self.raw, async (result) => {
                                    if (result.status === 0) {
                                        let style = document.createElement("style");
                                        style.textContent = result.text;

                                        // Store in cache for later too
                                        if (typeof AutoDOMCache !== "undefined"){
                                             await AutoDOMCache.set(self, result.text);
                                        }

                                        resolve(style);
                                    } else {
                                        reject(result.message);
                                    }
                                });
                            });
                        }

                        supportsAutoDom() {
                            return true;
                        }

                        static type() {
                            return "text/x-scss";
                        }
                    }; window.SCSSFragment = SCSSFragment;

                    Fragment.registerFragmentType(SCSSFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="editor_core" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "The base editor core required by all Codestrate editors",
                        "dependencies": [
                            "wpm_js_libs #cQuery",
                            "wpm_js_libs #CaviTouch",
                            "#fragment_core",
                            "#EventSystem"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="editor_core-script" type="disabled">
                    /**
                     *  Editor and EditorManager
                     *  Base classes for handling editors in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global cQuery, webstrate */

                    /**
                     * Triggers when a selection changes inside an editor
                     * @event Editors.Editor.EventSystem:"Codestrates.Editor.Selection"
                     * @type {Event}
                     * @property {Editors.Editor} editor - The editor that triggered the event
                     * @property {Editors.Editor~cursorSelection} selection - The selection
                     */

                    /**
                     * Triggers when an editor looses focus
                     * @event Editors.Editor.EventSystem:"Codestrates.Editor.Blur"
                     * @type {Event}
                     * @property {Editors.Editor} editor - The editor that triggered the event
                     */

                    /**
                     * Triggers when an editor gains focus
                     * @event Editors.Editor.EventSystem:"Codestrates.Editor.Focus"
                     * @type {Event}
                     * @property {Editors.Editor} editor - The editor that triggered the event
                     */
                    /**
                     * Triggers when an editor is closed
                     * @event Editors.Editor.EventSystem:"Codestrates.Editor.Closed"
                     * @type {Event}
                     * @property {Editors.Editor} editor - The editor that triggered the event
                     */
                    /**
                     * Triggers when an editor is opened
                     * @event Editors.Editor.EventSystem:"Codestrates.Editor.Opened"
                     * @type {Event}
                     * @property {Editors.Editor} editor - The editor that triggered the event
                     */

                    /**
                     * @namespace Editors
                     */

                    /**
                     * EditorManager
                     *
                     * @memberof Editors
                     */
                    class EditorManager {
                        /**
                         * @private
                         */
                        static registerEditor(editor) {
                            editor.types().forEach((type)=>{
                                EditorManager.registerEditorType(type, editor);
                            });
                        }

                        static registerEditorType(type, editor) {
                            let editors = EditorManager.editorTypes.get(type);
                            if(editors == null) {
                                editors = new Set();
                                EditorManager.editorTypes.set(type, editors);
                            }

                            editors.add(editor);
                        }

                        /**
                         * @private
                         */
                        static unregisterEditor(editor, editorClassName) {
                            for(let editors of EditorManager.editorTypes.values()) {
                                editors.delete(editor);
                            }

                            cQuery("."+editorClassName).forEach((editor)=>{
                                editor = cQuery(editor).data("Editor");
                                if(editor != null) {
                                    editor.unload();
                                }
                            });
                        }

                        /**
                         * @typedef {Object} EditorManager~EditorConfig
                         * @property {Editors.Editor} [editor] - The editor to use.
                         * @property {string} [theme] -  The theme to use, supports "light" or "dark".
                         * @property {string} [mode] - The editor mode, supports "inline" or "full".
                         * @property {boolean} [readOnly] - Should the editor be read only.
                         */

                        /**
                         * Create an editor for the given fragment/array of fragments.
                         *
                         * <pre><code>config options:
                         *  editor: null | EditorClass -- If not null, tries to create the specified editor
                         *  theme: "light" | "dark" -- The theme to use for the editor
                         *  mode: "inline" | "full" -- Inline fills the space its in, full resizes the editor to show all lines.
                         *  readOnly: true|false -- Should the editor be read only</code></pre>
                         *
                         * @example
                         * let editor = EditorManager.create(Fragment.one("#myFragment"), {theme:"light", mode: "full"})[0];
                         *
                         * @param {Fragments.Fragment|Fragments.Fragment[]} fragment - The fragment, or array of fragments to create the editors from
                         * @param {EditorManager~EditorConfig} config - The editor config to use
                         * @returns {Editors.Editor[]} the created editors
                         */
                        static createEditor(fragment, config = {}) {
                            let result = [];

                            let defaultConfig = {
                                editor: null,
                                theme: "light",
                                mode: "inline",
                                readOnly: false
                            };

                            config = Object.assign({}, defaultConfig, config);

                            if(Array.isArray(fragment)) {
                                for(let frag of fragment) {
                                    result = result.concat(EditorManager.createEditor(frag, config));
                                }
                            } else {
                                if(config.editor != null) {
                                    if(config.editor.types().includes(fragment.type)) {
                                        result.push(new config.editor(fragment, config));
                                    } else {
                                        let newConfig = Object.assign({}, config);
                                        newConfig.editor = null;
                                        result = result.concat(EditorManager.createEditor(fragment, newConfig));
                                        if(result.length === 0) {
                                            console.warn(config.editor.name+" does not support fragment type:", fragment.constructor.type());
                                            console.warn("Auto editor discovery did not find any usable editors.");
                                        } else {
                                            console.log(config.editor.name+" does not support fragment type:", fragment.constructor.type());
                                            console.log("Auto editor discovery: ", result);
                                        }
                                    }
                                } else {
                                    let editors = EditorManager.editorTypes.get(fragment.type);

                                    if(editors == null) {
                                        editors = new Set();
                                        EditorManager.editorTypes.set(fragment.type, editors);
                                    }

                                    //Filter preview editor from auto discovery, as it can not edit.
                                    const availableEditors = Array.from(editors).filter((editor)=>{
                                        return editor !== PreviewEditor;
                                    });

                                    if(availableEditors.length > 0) {
                                        //TODO: Maybee not just use the first editor available?
                                        result.push( new (availableEditors[0])(fragment, config));
                                    }
                                }
                            }

                            return result;
                        }

                        /**
                         * Used to load CSS for implementing editors
                         * @private
                         */
                        static loadCss(url) {
                            return new Promise((resolve, reject)=>{
                                let link = document.createElement("link");
                                link.type = "text/css";
                                link.rel = "stylesheet";
                                link.href = url;

                                link.setAttribute("transient-element", "");

                                document.head.append(link);

                                link.onload = ()=>{
                                    resolve();
                                };
                            });
                        }
                    }; window.EditorManager =  EditorManager;

                    EditorManager.editorTypes = new Map();

                    /**
                     * Editor represents a fragment editor
                     * @abstract
                     * @memberof Editors
                     * @hideconstructor
                     */
                    class Editor {
                        constructor(htmlClass, fragment, options = {}) {
                            this.html = cQuery("<div class='codestrates-editor-core'></div>");
                            this.html.data("Editor", this);

                            this.fragment = fragment;
                            this.handleModelChanges = true;

                            this.options = options;

                            this.editorDiv = cQuery("<div class='codestrates-editor-core-view "+htmlClass+"'></div>");

                            this.html.append(this.editorDiv);

                            this.foreignSelections = new Map();

                            this.eventDeleters = [];

                            if(options.mode === "inline") {
                                this.verticalResizeHandle = cQuery("<div class=\"codestrates-editor-core-resizer\"></div>");
                                this.html.append(this.verticalResizeHandle);
                                this.setupResizer();
                                this.html.addClass("resizeable");
                            } else if(options.mode === "component") {
                                this.html.addClass("component");
                            } else if(options.mode === "full") {
                                //Do nothing atm.
                            }

                            let self = this;

                            this.eventDeleters.push(this.fragment.registerOnFragmentChangedHandler((context)=>{
                                if(context === self) {
                                    return;
                                }

                                self.handleFragmentChanged();
                            }));

                            this.eventDeleters.push(this.fragment.registerOnTextInsertedHandler((pos, val)=>{
                                self.handleTextInserted(pos, val);
                            }));

                            this.eventDeleters.push(this.fragment.registerOnTextDeletedHandler((pos, val)=>{
                                self.handleTextDeleted(pos, val);
                            }));

                            this.resizeHandler = function() {
                                self.onSizeChanged();
                            };

                            this.focusOutHandler = function() {
                                self.triggerEditorLostFocus();
                            };

                            this.focusInHandler = function() {
                                self.triggerEditorGainedFocus();
                            };

                            window.addEventListener("resize", this.resizeHandler);

                            this.html[0].addEventListener("focusout", this.focusOutHandler);

                            this.html[0].addEventListener("focusin", this.focusInHandler);

                            //Setup live query to listen for cursors
                            this.otherCursorLiveQuery = this.html.liveQuery("[class*='otherCursor_']", {
                                added: (obj)=>{
                                    obj.classList.add("otherCursor");
                                }
                            });
                            this.otherSelectorLiveQuery = this.html.liveQuery("[class*='otherSelector_']", {
                                added: (obj)=>{
                                    obj.classList.add("otherSelector");
                                }
                            });

                            this.waitForDomInsertion().then(()=>{
                                self.waitForDisplay().then(()=>{
                                    self.onSizeChanged();
                                });
                            });
                        }

                        setWordwrap(state) {
                            //Override me
                            console.warn("Changing word wrap is not supported in this editor:"+this.constructor.name);
                        }

                        waitForDisplay() {
                            let self = this;

                            return new Promise((resolve, reject)=>{
                                function checkDisplay() {
                                    try {
                                        if (self.html[0].offsetWidth > 0) {
                                            resolve();
                                        } else {
                                            setTimeout(checkDisplay, 100);
                                        }
                                    } catch(e) {

                                    }
                                }

                                checkDisplay();
                            });
                        }

                        waitForDomInsertion() {
                            let self = this;

                            return new Promise((resolve, reject)=>{
                                let observer = new MutationObserver((mutations)=>{
                                    let foundEditor = false;
                                    mutations.forEach((mutation)=>{
                                        Array.from(mutation.addedNodes).forEach((addedNode)=>{
                                            if(addedNode === self.html[0]) {
                                                foundEditor = true;
                                            } else {
                                                let parent = self.html[0].parentNode;

                                                while(parent != null) {
                                                    if(parent === addedNode) {
                                                        foundEditor = true;
                                                        break;
                                                    }

                                                    parent = parent.parentNode;
                                                }
                                            }
                                        });
                                    });

                                    if(foundEditor) {
                                        observer.disconnect();
                                        resolve();
                                    }
                                });

                                observer.observe(document, {
                                    childList: true,
                                    subtree: true
                                });
                            });
                        }

                        /**
                         * Focuses the editor
                         */
                        focus() {
                            //Override in subclass
                        }

                        /**
                         * Sets the currently active line
                         */
                        setLine(line, column=1) {
                            //Override in subclass
                        }


                        /**
                         * @typedef {object} Editors.Editor~cursorSelection
                         * @property {number} startLine
                         * @property {number} startColumn
                         * @property {number} endLine
                         * @property {number} endColumn
                         * @property {number} positionLine
                         * @property {number} positionColumn
                         */

                        /**
                         * Sets a forign client selection marker in this editor
                         * @param {String} remoteClient - Webstrate clientId of the remote client that has a selection in the fragment this editor is editing
                         * @param {Editors.Editor~cursorSelection} cursorSelection - The selection
                         */
                        setForeignSelection(remoteClient, cursorSelection) {
                            if(cursorSelection == null) {
                                this.foreignSelections.delete(remoteClient);
                            } else {
                                this.foreignSelections.set(remoteClient, cursorSelection);
                            }
                            this.updateForeignSelections(remoteClient);
                        }

                        /**
                         * @private
                         */
                        updateForeignSelections(remoteClient=null) {
                            //Overrite in subclass
                        }

                        /**
                         * @private
                         */
                        triggerCursorSelection(selection) {
                            EventSystem.triggerEvent("Codestrates.Editor.Selection", {
                                editor: this,
                                selection: selection
                            });
                        }

                        /**
                         * @private
                         */
                        triggerEditorLostFocus() {
                            EventSystem.triggerEvent("Codestrates.Editor.Blur", {
                                editor: this
                            });
                        }

                        /**
                         * @private
                         */
                        triggerEditorGainedFocus() {
                            EventSystem.triggerEvent("Codestrates.Editor.Focus", {
                                editor: this
                            });
                        }

                        /**
                         * @private
                         */
                        triggerEditorClosed() {
                            EventSystem.triggerEvent("Codestrates.Editor.Closed", {
                                editor: this
                            });
                        }

                        /**
                         * @private
                         */
                        triggerEditorOpened() {
                            EventSystem.triggerEvent("Codestrates.Editor.Opened", {
                                editor: this
                            });
                        }

                        /**
                         * @private
                         */
                        onSizeChanged() {
                            //Overwrite in subclass
                        }

                        /**
                         * @private
                         */
                        setupResizer() {
                            let self = this;

                            new CaviTouch(this.verticalResizeHandle, {
                                dragMinDistance: 0
                            });

                            this.verticalResizeHandle.on("caviDrag", (evt)=>{
                                let height = self.html[0].clientHeight + evt.detail.caviEvent.deltaPosition.y;
                                self.html[0].style.height = height+"px";
                                self.onSizeChanged();
                            });
                        }

                        /**
                         * @private
                         */
                        handleFragmentChanged() {
                            let self = this;

                            this.handleModelChanges = false;
                            try {
                                let editorValue = this.getValue();
                                let fragmentValue = this.fragment.raw;

                                if(editorValue !== fragmentValue) {
                                    this.setValue(this.fragment.raw);
                                }
                            } catch(e) {
                                console.error("Error setting fragment value:", e);
                            }

                            setTimeout(()=>{
                                self.handleModelChanges = true;
                            },0);
                        }

                        /**
                         * @private
                         */
                        handleTextInserted(pos, val) {
                            let self = this;

                            this.handleModelChanges = false;
                            try {
                                this.insertText(pos, val);
                            } catch(e) {
                                console.error("Error setting fragment value:", e);
                            }

                            setTimeout(()=>{
                                self.handleModelChanges = true;
                            },0);
                        }

                        /**
                         * @private
                         */
                        handleTextDeleted(pos, val) {
                            let self = this;

                            this.handleModelChanges = false;
                            try {
                                this.deleteText(pos, val);
                            } catch(e) {
                                console.error("Error setting fragment value:", e);
                            }

                            setTimeout(()=>{
                                self.handleModelChanges = true;
                            },0);
                        }

                        /**
                         * @private
                         */
                        handleModelChanged() {
                            let self = this;

                            if(this.handleModelChanges) {
                                let changedValue = this.getValue();

                                if(changedValue !== self.fragment.raw) {
                                    this.fragment.executeObserverless(() => {
                                        EventSystem.triggerEvent("Codestrates.Editor.BeforeModelChanged", {
                                            editor: this
                                        });
                                        self.fragment.raw = changedValue;
                                        EventSystem.triggerEvent("Codestrates.Editor.AfterModelChanged", {
                                            editor: this
                                        });
                                    }, this);
                                }
                            }
                        }

                        /**
                         * Get the current string value of this editor
                         * @returns {string}
                         */
                        getValue() {
                            //Override in subclass
                            console.warn("getValue not overridden", this);
                        }

                        /**
                         * Sets the current string value of this editor
                         * @param {string} value
                         */
                        setValue(value) {
                            //Override in subclass
                            console.warn("setValue not overridden", this);
                        }

                        /**
                         * Inserts text into this editor
                         * @param {number} pos - The position to insert at
                         * @param {string} val - The value to insert
                         */
                        insertText(pos, val) {
                            //Override in subclass
                            console.warn("insertText not overridden", this);
                        }

                        /**
                         * Inserts text into this editor
                         * @param {number} pos - The position to delete from
                         * @param {string} val - The value to delete
                         */
                        deleteText(pos, val) {
                            //Override in subclass
                            console.warn("deleteText not overridden", this);
                        }

                        /**
                         * Inserts the given text at the current selection, if no selection just insert at the cursor position, else replace the current selection.
                         * @param {string} text - The text to insert
                         */
                        insertAtSelection(text) {
                            //Override in subclass
                            console.warn("insertAtSelection not overridden", this, text);
                        }

                        setTheme(themeName){
                            console.warn("editor.setTheme not supported for ", themeName, this);
                        }

                        /**
                         * Unloads this editor
                         */
                        unload() {
                            this.triggerEditorClosed();

                            this.eventDeleters.forEach((deleter)=>{
                                deleter.delete();
                            });

                            window.removeEventListener("resize", this.resizeHandler);

                            this.html[0].removeEventListener("focusout", this.focusOutHandler);

                            this.html[0].removeEventListener("focusin", this.focusInHandler);

                            this.otherCursorLiveQuery.stop();
                            this.otherSelectorLiveQuery.stop();
                            this.html.remove();
                            this.html.data("Editor", null);
                            this.html = null;
                        }
                    }; window.Editor = Editor;

                    </SCRIPT><STYLE id="base-style">
                    /**
                     *  Editor styles
                     *  Base classes for handling editors in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    .codestrates-editor-core {
                        position: relative;
                    }

                    .codestrates-editor-core.unsaved {
                        border: crimson solid 2px;
                    }

                    .codestrates-editor-core-view {
                        height: 100%;
                    }

                    .codestrates-editor-core.component {
                        height: 100%;
                    }

                    .codestrates-editor-core.resizeable {
                        min-height: 6em;
                        height: 6em;
                    }
                    .codestrates-editor-core.resizeable .codestrates-editor-core-resizer {
                        position: absolute;
                        cursor: ns-resize;
                        left: 0;
                        top: 100%;
                        width: 100%;
                        opacity: 0.2;
                        height: 0.5em;
                        border-top: 0.2em solid rgba(0,0,0,0.5);
                        transition: opacity 0.20s ease-out, border-top-width 0.20s ease-out;
                        z-index: 4;
                    }
                    .codestrates-editor-core.resizeable .codestrates-editor-core-resizer:hover {
                        opacity: 1;
                        border-top-width: 0.75em;
                    }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="FragmentFilesystemSync" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Allows syncing fragments into a directory structure on a local disk",
                        "dependencies": [
                            "#fragment_core",
                            "#EventSystem",
                            "webstrate-components-repos #MenuSystem"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "0.1"
                    }

                    </SCRIPT><SCRIPT id="FragmentFilesystemSync-script" type="disabled">
                    let store = "directoryHandles";
                    let folderElements = ["CODE-FOLDER","WPM-PACKAGE"];
                    let extensionTypes = {
                      "text/javascript": "js",
                      "text/javascript+babel": "jsx",
                      "text/x-typescript": "ts",
                      "text/python": "py",
                      "text/ruby": "rb",
                      "application/x-lua": "lua",
                      "text/html": "html",
                      "text/markdown": "md",
                      "text/x-latex": "tex",
                      "image/svg+xml": "svg",
                      "application/json": "json",
                      "wpm/descriptor": "json",
                      "text/varv": "json",
                      "text/css": "css",
                      "text/x-scss": "scss"
                    }
                    let autoCloneAttributes = ["id","data-repository","auto","class"];

                    class FragmentFilesystemSync {
                        static isSupported(){
                            if (!window) return false;
                            if (!window.showDirectoryPicker) return false;
                            if (!window.indexedDB) return false;
                            if (!window.MutationObserver) return false;
                            return true;
                        }

                        constructor(dbname){
                            let self = this;
                            this.isSyncing = false;
                            this.fragmentLinks = [];
                            this.directoryHandle = false;
                            this.pathMapping = new Map();
                            this.nodeMapping = new Map();

                            const request = indexedDB.open(dbname);
                            request.onerror = (event) => {
                                console.error("Failed to open filesystem sync IndexedDB",event);
                            };
                            request.onsuccess = (event) => {
                                self.db = event.target.result;
                                self.onPageLoad();
                            };
                            request.onupgradeneeded = (event) =>{
                                self.db = event.target.result;

                                // Create an objectStore to hold file handles to directories
                                self.db.createObjectStore(store, { keyPath: "webstrate" });
                            }
                        }

                        async onPageLoad(){
                            this.directoryHandle = await this.getSavedHandle();
                            if (this.directoryHandle){
                                // Sync immediately
                                this.enableSyncing();
                            }
                        }

                        getSavedHandle(){
                            return new Promise((resolve, reject)=>{
                                let request = this.db.transaction(store).objectStore(store).get(location.pathname);
                                request.onerror = (event) => {
                                    reject(event);
                                };
                                request.onsuccess = (event) => {
                                    resolve(request.result?.handle);
                                };
                            });
                        }

                        setDirectory(handle=false){
                            this.directoryHandle = handle;
                            return new Promise((resolve, reject)=>{
                                let request;
                                if (handle){
                                    request = this.db.transaction(store,"readwrite").objectStore(store).put(
                                        {
                                            webstrate: location.pathname,
                                            handle: handle
                                        }
                                    );
                                } else {
                                    request = this.db.transaction(store,"readwrite").objectStore(store).delete(location.pathname);
                                }
                                request.onerror = (event) => {reject(event);};
                                request.onsuccess = resolve;
                            });
                        }

                        async popupDirectoryPicker(){
                            let directoryHandle = await window.showDirectoryPicker({ mode:"readwrite"});
                            if (!directoryHandle) return;

                            let needConfirm = true;

                            // Check if folder is empty then it is ok
                            let fileCount = 0;
                            for await (const key of directoryHandle.keys()) {
                                fileCount++;
                            }
                            if (fileCount===0) needConfirm = false;

                            // Check if folder already contains meta file for this webstrate then it is also ok
                            try {
                                let metaFileHandle = await directoryHandle.getFileHandle("ffs.meta");
                                let metaFile = await metaFileHandle.getFile();
                                if (JSON.parse(await metaFile.text()).location==location.pathname) needConfirm = false;
                            } catch (ex){
                                // ignore
                            }

                            if (needConfirm && !window.confirm('Warning: The contents of the folder '+directoryHandle.name+' you selected will be overwritten with the fragments in this codestrate. All its content will be deleted!')) return;
                            return directoryHandle;
                        }

                        async enableSyncing(){
                            let self = this;
                            if (this.isSyncing) throw new Error("Cannot start FFS, already syncing, stop it first");
                            if (!this.directoryHandle) throw new Error("No sync directory set");
                            if (!await this.directoryHandle.requestPermission({mode: "readwrite"})) throw new Error("Must have access to dir");
                            console.log("Starting Fragment Filesystem Sync");

                            // TODO: Test if out-of-sync and ask for whether to overwrite filesystem or webstrate

                            // Clean up the directory
                            for await (const entry of this.directoryHandle.values()) {
                                await this.directoryHandle.removeEntry(entry.name, { recursive: true });
                            }

                            // Observe when fragments are added/removed
                            this.observer = new MutationObserver((mutations)=>{
                                for (const mutation of mutations) {
                                    if (mutation.type === "childList") {
                                        for (const addedNode of mutation.addedNodes){
                                            if (addedNode.matches && addedNode.matches("code-fragment")){
                                                self.onWSFragmentElementAdded(addedNode);
                                            } else if (addedNode.querySelectorAll) {
                                                addedNode.querySelectorAll("code-fragment").forEach((node)=>{
                                                    self.onWSFragmentElementAdded(node);
                                                })
                                            }
                                        }
                                        for (const removedNode of mutation.removedNodes){
                                            if (removedNode.matches && removedNode.matches("code-fragment")){
                                                self.onWSFragmentElementRemoved(removedNode);
                                            } else if (removedNode.querySelectorAll) {
                                                removedNode.querySelectorAll("code-fragment").forEach((node)=>{
                                                    self.onWSFragmentElementRemoved(node);
                                                })
                                            }
                                        }
                                    }
                                }
                            });
                            this.observer.observe(document.body, {childList:true, subtree:true});
                            document.querySelectorAll("body code-fragment").forEach((fragment)=>{
                                self.onWSFragmentElementAdded(fragment);
                            });

                            // Every second synchronize contents
                            let ffsUpdateTick = async () => {
                                let metaFileHandle = await this.directoryHandle.getFileHandle("ffs.meta", {create:true});
                                let metaFile = await metaFileHandle.getFile();
                                let oldMeta = {};
                                try {
                                    oldMeta = JSON.parse(await metaFile.text());
                                } catch (ex){
                                    // Ignore this, just create a new one
                                }
                                let metaChangeDetector = JSON.stringify(oldMeta.paths);

                                // Sync FS and WS
                                if (oldMeta.paths) await self.synchronizeFSOperations(oldMeta);
                                await self.synchronizeWSFragments();

                                // Generate new meta file for advanced merging functionality
                                let meta = {metaVersion: 1, version:webstrate.version, lastMetaSync: new Date().getTime(), paths:{},location:location.pathname};
                                for (const [path,part] of this.pathMapping){
                                    let entryMeta = {wid:part.node.webstrate.id};
                                    if (part.link){
                                        entryMeta.type = "fragment";
                                        entryMeta.lastModified = part.link.elementLastModified;
                                        entryMeta.hash = part.link.hash;
                                    } else {
                                        entryMeta.type = "directory";
                                    }
                                    autoCloneAttributes.forEach(attr=>{
                                        if (part.node.hasAttribute(attr)) entryMeta[attr] = part.node.getAttribute(attr);
                                    })
                                    meta.paths[path] = entryMeta;
                                };
                                if (metaChangeDetector!=JSON.stringify(meta.paths)){
                                    // Meta needs to be rewritten
                                    await writeFile(metaFileHandle, JSON.stringify(meta));
                                }
                                self.updater = setTimeout(ffsUpdateTick,1000);
                            };
                            ffsUpdateTick();

                            this.isSyncing = true;
                        }

                        disableSyncing(){
                            clearTimeout(this.updater);
                            this.observer?.disconnect();
                            this.fragmentLinks = [];
                            this.isSyncing = false;
                            console.log("Stopped FFS");
                        }

                        onWSFragmentElementAdded(fragmentElement){
                            // TODO: Check if already exists and ignore
                            setTimeout(()=>{this.fragmentLinks.push(new FragmentLink(fragmentElement.fragment))},1);
                        }
                        onWSFragmentElementRemoved(fragmentElement){
                            this.fragmentLinks = this.fragmentLinks.filter((link)=>link.fragment.element!==fragmentElement);
                        }

                        async synchronizeFSOperations(oldMeta){
                            async function addElementFromOldFS(path,element,type){
                                let parentPath = path.substring(0,path.lastIndexOf("/"));
                                let parentNode = false;
                                if (parentPath==""){
                                    parentNode = document.body;
                                } else if (oldMeta.paths[parentPath]) { // Try to find node by WSID
                                    let wsNode = findFolderNodeByWSID(oldMeta.paths[parentPath].wid);
                                    if (wsNode) parentNode = wsNode;
                                }

                                if (!parentNode){
                                    console.log("Couldn't map parent folder, giving up on adding", path);
                                } else {
                                    // TODO: Check for collisions/duplicates here
                                    let name = path.split("/");
                                    name = name[name.length-1];
                                    let extensionLocation = name.lastIndexOf(".");
                                    name = name.substring(0,(extensionLocation!=-1)?extensionLocation:undefined);

                                    element.setAttribute("name",name);
                                    parentNode.appendChild(element);
                                    WPMv2.stripProtection(element);

                                    // continue after webstrates id generation
                                    await new Promise(resolve => setTimeout(resolve, 0));
                                    oldMeta.paths[path] = {
                                        wid: element.webstrate.id,
                                        type: type
                                    };
                                }
                            }

                            // Check if any new files/dirs in FS with the old mapping from FS
                            await traverseDirectoryStructure("",this.directoryHandle, async (path,name,parent,entry)=>{
                                if (!oldMeta.paths[path]){
                                    // A new directory, create it in the webstrate
                                    let newFolderElement;
                                    if (name.endsWith(".wpm")){
                                        newFolderElement = document.createElement("wpm-package");
                                    } else {
                                        newFolderElement = document.createElement("code-folder");
                                    }
                                    await addElementFromOldFS(path,newFolderElement,"directory");
                                }

                                // Check again and flag as seen if it exists now
                                if (oldMeta.paths[path]) oldMeta.paths[path].seen = true;
                                return true;
                            }, async (path,name,parent,entry)=>{
                                if (!oldMeta.paths[path]){
                                    // A new file, create the fragment
                                    if (path==="/ffs.meta") return; // Ignore meta file
                                    let extension = name.substring(name.lastIndexOf(".")+1);
                                    let type = Object.keys(extensionTypes).find(key=>extensionTypes[key]==extension);
                                    if (FragmentFilesystemSync.DEBUG) console.log("New file spotted",extension,type,path,name,parent,entry);
                                    if (type){
                                        // Recognized fragment type
                                        let fragmentElement = document.createElement("code-fragment");
                                        fragmentElement.setAttribute("data-type",type);
                                        await addElementFromOldFS(path,fragmentElement,"fragment");

                                        // Check if this is a move/rename op
                                        let file = await entry.getFile();
                                        let contents = await file.text();
                                        if (contents.length>0){
                                            let hash = await sha256(contents);
                                            if (FragmentFilesystemSync.DEBUG) console.log("Looking for ",hash);
                                            let collision = Object.values(oldMeta.paths).find((p)=>{return p.type=="fragment" && p.hash==hash;});
                                            if (collision){
                                                // Copy over old attributes
                                                if (FragmentFilesystemSync.DEBUG) console.log("Found")
                                                autoCloneAttributes.forEach(attr=>{
                                                    if (FragmentFilesystemSync.DEBUG) console.log("Adding attrs")
                                                    if (collision[attr]===undefined){
                                                        if (FragmentFilesystemSync.DEBUG) console.log("removing attrs",attr);
                                                        fragmentElement.removeAttribute(attr);
                                                    } else {
                                                        if (FragmentFilesystemSync.DEBUG) console.log("added attrs",attr, collision[attr]);
                                                        fragmentElement.setAttribute(attr,collision[attr]);
                                                    }
                                                })
                                            }
                                        }
                                    }
                                }

                                // Check file existance again
                                if (oldMeta.paths[path]){
                                    // Also check for modifications
                                    let file = await entry.getFile();
                                    let oldFileMeta = oldMeta.paths[path]
                                    if ((!oldFileMeta.lastModified) || file.lastModified > oldMeta.lastMetaSync){
                                        let element = await findFragmentNodeByWSID(oldFileMeta.wid);
                                        if (!element){
                                            console.log("Couldn't find element node to push FS contents to",path);
                                        } else {
                                            element.fragment.raw = await file.text();
                                        }
                                    }

                                    oldMeta.paths[path].seen = true;
                                }
                            });

                            // Check if any deleted files in FS with the old mapping from FS
                            for (const [path,entry] of Object.entries(oldMeta.paths)){
                                if (!entry.seen){
                                    if (FragmentFilesystemSync.DEBUG) console.log("Detected deleted path in FS",path);
                                    switch (entry.type){
                                        case "directory":
                                            let wsDirNode = findFolderNodeByWSID(entry.wid);
                                            if (!wsDirNode){
                                                console.log("Couldn't find deleted directory in webstrate",entry);
                                            } else {
                                                wsDirNode.remove();
                                            }
                                            break;
                                        case "fragment":
                                            let wsFragNode = findFragmentNodeByWSID(entry.wid);
                                            if (!wsFragNode){
                                                console.log("Couldn't find deleted fragment in webstrate",entry);
                                            } else {
                                                wsFragNode.remove();
                                            }
                                            break;
                                            default:
                                                console.log("Unknown entry type deleted", entry)
                                    }
                                }
                            }

                            // Yield, to trigger mutation observers for deletions before continueing
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }

                        async synchronizeWSFragments(){
                            // Create new filename and directory mapping for fragment links
                            let sanitizeFileName = (rawName)=>rawName.replace(/[^()a-z0-9.#\-_ ]/gi, '_');
                            let newPathMapping = new Map();
                            let newNodeMapping = new Map();

                            // Recurse through folder elements and map them with unique names
                            let registerFolderElements = function registerFolderElements(currentPath, currentElement){
                                if (folderElements.includes(currentElement.nodeName)){
                                    // This is a folder
                                    let path;
                                    let counter = 0;
                                    let extension = "";
                                    if (currentElement.nodeName==="WPM-PACKAGE") extension = ".wpm";
                                    do {
                                        // Not unique, append a number
                                        path = currentPath + "/" + sanitizeFileName(getNodeName(currentElement))+(counter>0?"_"+counter:"")+extension;
                                        counter++;
                                    } while(newPathMapping.get(path));
                                    newPathMapping.set(path,{node:currentElement});
                                    newNodeMapping.set(currentElement,path);
                                    currentPath = path;
                                }
                                for (let i = 0; i<currentElement.children.length; i++){
                                    registerFolderElements(currentPath,currentElement.children[i]);
                                }
                            }
                            registerFolderElements("",document.body);

                            // Map fragments with unique names
                            this.fragmentLinks.forEach((link)=>{
                                // Find parent path
                                let path = "";
                                let parent = link.fragment.element.parentNode;
                                while (parent && parent.parentNode != null) {
                                    if (folderElements.includes(parent.nodeName)){
                                        path = newNodeMapping.get(parent);
                                        if (!path){
                                            console.warn("Weird", parent, link);
                                            throw new Error("FIXME: Cannot map fragment inside folder that wasn't detected properly");
                                        }
                                        break;
                                    }
                                    parent = parent.parentNode;
                                }

                                // Make fragment name unique
                                let fragmentPath;
                                let counter = 0;
                                do {
                                    fragmentPath = path + "/" + sanitizeFileName(link.getRawName())+(counter>0?"_"+counter:"")+"."+link.getExtension();
                                    counter++;
                                } while (newPathMapping.get(fragmentPath));
                                newPathMapping.set(fragmentPath,{node: link.fragment.element, link:link});
                                newNodeMapping.set(link.fragment.element,fragmentPath);
                            });
                            this.nodeMapping = newNodeMapping;
                            this.pathMapping = newPathMapping;




                            // Check if there are new dirs that need to be pushed to FS
                            let paths = Array.from(this.pathMapping.keys()).sort();
                            let sortedDirs = [{path:"",handle:this.directoryHandle}];
                            for (const path of paths){
                                let entity = this.pathMapping.get(path);
                                if (!entity.link){
                                    // Directory
                                    sortedDirs.push({path:path, handle:await getOrCreateFSDirectory(this.directoryHandle, path)});
                                }
                            }

                            // Check fragments to push to FS
                            for (const dir of sortedDirs){
                                if (!dir.handle) {
                                    console.log("Skipping file sync because directory could not be found",dir);
                                    continue;
                                }
                                for (const path of paths){
                                    if (path.substr(0,path.lastIndexOf("/"))==dir.path){
                                        let entity = this.pathMapping.get(path);
                                        if (entity.link){
                                            // File in this dir
                                            let fileWasJustCreated = false;
                                            let fileName = path.substring(path.lastIndexOf('/')+1);
                                            let fileHandle;
                                            try {
                                                fileHandle = await dir.handle.getFileHandle(fileName);
                                            } catch (ex){
                                                // Not found
                                                // TODO: Test for other things than NotFound
                                                try {
                                                    fileHandle = await dir.handle.getFileHandle(fileName, {create:true});
                                                    if (FragmentFilesystemSync.DEBUG) console.log("Creating new file in FS because it didnt exist",path)
                                                    fileWasJustCreated = true;
                                                } catch (ex2){
                                                    console.log("Cannot write file, skipping",path,ex2);
                                                }
                                            }

                                            let file = await fileHandle.getFile();
                                            if (fileWasJustCreated || entity.link.elementLastModified>file.lastModified){
                                                await writeFile(fileHandle, entity.link.fragment.raw);
                                            }
                                        }
                                    }
                                }
                            };

                            // Check if FS has fragments/dirs that should be deleted
                            let unknownPathDeleter = (path,name,parent,entry)=>{
                                if (!this.pathMapping.has(path)){
                                    if (path=="/ffs.meta") return false; // leave the meta file alone
                                    parent.removeEntry(name, {recursive:true}); // Delete it
                                    return false; // Do not continue into the directory
                                }
                                return true;
                            };
                            await traverseDirectoryStructure("",this.directoryHandle, unknownPathDeleter, unknownPathDeleter);
                        }
                    }

                    class FragmentLink {
                        constructor(fragment){
                            let self = this;
                            this.fragment = fragment;
                            if (!fragment) throw Error("Cannot construct FragmentLink without a fragment");

                            this.fragment.registerOnFragmentChangedHandler(()=>{self.onFragmentUpdated()});
                            this.onFragmentUpdated();
                            if (FragmentFilesystemSync.DEBUG) console.log("Monitoring",fragment);
                        }



                        async onFragmentUpdated(){
                            // Store time and hash
                            let newHash = await sha256(this.fragment.raw);
                            if (newHash!=this.hash){
                                this.hash = newHash;
                                this.elementLastModified = new Date().getTime();
                            }
                        }

                        getRawName(){
                            let name = getNodeName(this.fragment.element);
                            return name?name:this.fragment.type.substring(this.fragment.type.lastIndexOf('/')+1);
                        }

                        getExtension(){
                            let extension = extensionTypes[this.fragment.type];
                            if (!extension) extension = "txt";
                            return extension;
                        }
                    }


                    function getNodeName(node){
                        let name = node.hasAttribute("name")?node.getAttribute("name").trim():"";
                        if (name.length>0) return name;
                        let id = node.hasAttribute("id")?node.getAttribute("id").trim():"";
                        if (id.length>0) return "#"+id;
                        if (folderElements.includes(node.nodeName)) return node.nodeName.toLowerCase();
                        return false;
                    }

                    function findFolderNodeByWSID(wsid){
                        return Array.from(document.querySelectorAll(folderElements.join(","))).find(element=>element.webstrate?.id==wsid);
                    }
                    function findFragmentNodeByWSID(wsid){
                        return Array.from(document.querySelectorAll("code-fragment")).find(element=>element.webstrate?.id==wsid);
                    }

                    async function getOrCreateFSDirectory(base, path){
                        let directories = path.split("/");
                        let currentDir = base;
                        for (let directory of directories){
                            if (directory.length===0) continue; // skip initial slash
                            currentDir = await currentDir.getDirectoryHandle(directory, {create:true})
                        }
                        return currentDir;
                    }

                    async function writeFile(fileHandle, contents){
                        const writable = await fileHandle.createWritable();
                        await writable.write(contents);
                        await writable.close();
                    }

                    async function traverseDirectoryStructure(currentPath, dirHandle, dirCallback, fileCallback){
                        for await (let [name,entry] of dirHandle.entries()){
                            let newPath = currentPath+"/"+name
                            if (entry instanceof FileSystemFileHandle){
                                await fileCallback(newPath, name, dirHandle, entry);
                            } else if (entry instanceof FileSystemDirectoryHandle){
                                if (await dirCallback(newPath, name, dirHandle, entry)){
                                    await traverseDirectoryStructure(newPath, entry, dirCallback, fileCallback);
                                }
                            }
                        }
                    }

                    async function sha256(input){
                        const sourceBytes = new TextEncoder().encode(input);
                        const digest = await crypto.subtle.digest("SHA-256", sourceBytes);
                        const resultBytes = [...new Uint8Array(digest)];
                        return resultBytes.map(x => x.toString(16).padStart(2, '0')).join("");
                    }

                    FragmentFilesystemSync.DEBUG = false;
                    if (FragmentFilesystemSync.isSupported()){
                        Fragment.addAllFragmentsLoadedCallback(()=>{
                            window.fragmentFilesystemSync = new FragmentFilesystemSync("FragmentFilesystemSync");
                            window.FragmentFilesystemSync = FragmentFilesystemSync;

                            // Register with Cauldron (when available)
                            let item;
                            let registerMenuItem = function registerMenuItem(){
                                if (!item) item = MenuSystem.MenuManager.registerMenuItem("Cauldron.File.Sync", {
                                    label: "Fragments to Disk...",
                                    tooltip: "Copy fragments to a local folder when the page loads and keep them in sync",
                                    group: "Codestrates",
                                    groupOrder: 200,
                                    order: 200,
                                    checked: ()=>{
                                        return fragmentFilesystemSync.isSyncing;
                                    },
                                    onAction: async (menuItem)=>{
                                        // Toggle sync
                                        if (fragmentFilesystemSync.isSyncing){
                                            fragmentFilesystemSync.disableSyncing();
                                            fragmentFilesystemSync.setDirectory();
                                        } else {
                                            let dir = await fragmentFilesystemSync.popupDirectoryPicker();
                                            if (dir){
                                                await fragmentFilesystemSync.setDirectory(dir);
                                                fragmentFilesystemSync.enableSyncing();
                                            }
                                        }
                                    }
                                });
                            }

                            // If Cauldron is there already, run it, otherwise wait
                            if (typeof MenuSystem != 'undefined') {
                                registerMenuItem();
                            } else {
                                EventSystem.registerEventCallback('Cauldron.OnInit', registerMenuItem);
                            }

                            wpm.onRemoved(({detail: packageName})=>{
                                fragmentFilesystemSync.disableSyncing();
                                item?.delete();
                            });
                        });
                    }


                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_js" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Javascript Fragment for Codestrates",
                        "dependencies": [
                            "#fragment_core",
                            "#js-eval-engine"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_js-script" type="disabled">
                    /**
                     *  JavascriptFragment
                     *  Fragments with js that can be executed
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Fragment, wpm, JsEvalEngine */

                    wpm.onRemoved(()=>{
                        Fragment.unRegisterFragmentType(JavascriptFragment);
                    });

                    /**
                     * A fragment that contains js code
                     *
                     * Supports auto - executes require() on load
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class JavascriptFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        /**
                         * An object describing the options for require.
                         *
                         * Example:
                         * <pre><code>{
                         *     context: {
                         *         someVariable: "test"
                         *     },
                         *     customConsole: {
                         *         log: (...messages)=>{
                         *              console.log("Custom:", ...messages);
                         *         }
                         *     }
                         * }
                         * </code></pre>
                         *
                         * @typedef {Object} JavascriptFragment~RequireOptions
                         * @property {Object} [context] - The context to pass to the javascript environment
                         * @property {Object} [customConsole] - A custom object used instead of window.console, ie. to make custom log methods.
                         */

                        /**
                         * Evaluates the javascript inside this fragment and returns the export object
                         *
                         * @example
                         * let exportedObject = Fragment.one("#myJsFragment").require();
                         *
                         * @param {JavascriptFragment~RequireOptions} [options] - Object containing any custom options.
                         * @returns {Promise<Object>}
                         */
                        require(options = {}) {
                            return JsEvalEngine.execute(this.raw, options, this);;
                        }

                        async onFragmentsLoaded() {
                            if(this.auto && !Fragment.disableAutorun) {
                                await this.require();
                            }
                        }

                        supportsRun() {
                            return true;
                        }

                        supportsAuto() {
                            return true;
                        }

                        static type() {
                            return "text/javascript";
                        }
                    }; window.JavascriptFragment = JavascriptFragment;

                    Fragment.registerFragmentType(JavascriptFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="fragment_js_babel" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Javascript enhanced by Babel",
                        "dependencies": [
                            "#fragment_core",
                            "#js-eval-engine",
                            "wpm_js_libs #babel"
                        ],
                        "license": "Apache 2.0",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="fragment_js_babel-script" type="disabled">
                    /**
                     *  JavascriptBabelFragment
                     *  Write typescript code and execute it in Codestrates
                     *
                     *  Copyright 2024 Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, Fragment, wpm */

                    wpm.onRemoved(() => {
                        Fragment.unRegisterFragmentType(JavascriptBabelFragment);
                    });

                    /**
                     * A fragment containing Javascript code enchanced by Babel
                     *
                     * Supports auto - executes require() on load
                     * @extends Fragments.Fragment
                     * @hideconstructor
                     * @memberof Fragments
                     */
                    class JavascriptBabelFragment extends Fragment {
                        constructor(html) {
                            super(html);
                        }

                        /**
                         * Evaluates the JavaScript code inside this fragment and returns the export object
                         * @example
                         * let exportedObject = Fragment.one("#myJSFragment").require();
                         * @returns {Promise<Object>}
                         */
                        async require() {
                            let self = this;

                            // Support for css-like imports from other fragments
                            function fragmentImports({types,template}){
                                return {
                                    visitor: {
                                        ImportDeclaration(path,state){
                                            if (path?.node?.source?.value?.startsWith("#")){
                                                let fragmentString = path.node.source.value.replaceAll("\"","\\\"");
                                                let specifierString = "throw new Error('Couldnt parse import specifier, try something simpler like import {Thing} from \"...\"')";
                                                if (path.node.specifiers.length===1 && path.node.specifiers[0].type==="ImportNamespaceSpecifier"){
                                                    specifierString = "var "+path.node.specifiers[0].local.name+" = await fragment.require();";
                                                    path.scope.removeBinding(path.node.specifiers[0].local.name); // Fix Babel not removing old bindings from scope
                                                } else if (path.node.specifiers.length===1 && path.node.specifiers[0].type==="ImportDefaultSpecifier"){
                                                    specifierString = "var "+path.node.specifiers[0].local.name+" = (await fragment.require()).default;";
                                                    path.scope.removeBinding(path.node.specifiers[0].local.name); // Fix Babel not removing old bindings from scope
                                                } else {
                                                    let specifiers = path.node.specifiers.map(specifier=>{
                                                        let assignment = "var "+specifier.local.name+"=wrapper."+specifier.imported.name;
                                                        path.scope.removeBinding(specifier.local.name); // Fix Babel not removing old bindings from scope
                                                        return assignment;
                                                    });
                                                    specifierString = "let wrapper = await fragment.require();"+specifiers.join(";");
                                                }

                                                let replacementProgram = Babel.transform(`
                                                    {try {
                                                        let fragment = Fragment.one("`+fragmentString+`");
                                                        if (!fragment) throw new Error("Couldn't find fragment");
                                                        `+specifierString+`
                                                    } catch (ex){
                                                        throw new Error("Unable to import '`+path.node.source.value.replaceAll("\"","")+"' on line "+path.node.loc.start.line+`: "+ex);
                                                    }}
                                                `, {ast:true,code:false});
                                                path.replaceWith(replacementProgram.ast.program.body[0]);
                                            }
                                        }
                                    }
                                };
                            }
                            let ast = Babel.transform(self.raw+"/*"+Math.random()+"*/",{presets:["react"], ast:true, code:false, plugins:[fragmentImports]}).ast;

                            // Turn into real JS and return it
                            let processedCode = Babel.transformFromAst(ast,null, {presets:["react"]}).code;
                            processedCode = "let fragmentSelfReference = Fragment.one('code-fragment[transient-fragment-uuid=\""+this.uuid+"\"');"+processedCode;
                            //console.log(processedCode);
                            let output = await import(`data:text/javascript,${encodeURIComponent(processedCode)}`);
                            return output;
                        }

                        onFragmentsLoaded() {
                            if(this.auto && !Fragment.disableAutorun) {
                                this.require({
                                    autoRun: true
                                });
                            }
                        }

                        supportsAuto() {
                            return true;
                        }

                        supportsRun() {
                            return true;
                        }

                        static type() {
                            return "text/javascript+babel";
                        }
                    }; window.JavascriptBabelFragment = JavascriptBabelFragment;

                    Fragment.registerFragmentType(JavascriptBabelFragment);

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="codestrates-repos" id="editor_monaco" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "description": "Plugin to use Monaco Editor",
                        "dependencies": [
                            "wpm_js_libs #monaco_editor",
                            "#editor_core"
                        ],
                        "license": "Apache 2.0 (w/MIT)",
                        "assets": [],
                        "version": "1"
                    }

                    </SCRIPT><SCRIPT id="editor_monaco-script" type="disabled">
                    /**
                     *  MonacoEditor
                     *  Wrapper for using the Monaco editor in Codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate, cQuery, Editor, monaco, EditorManager */

                    wpm.onRemoved(()=>{
                        EditorManager.unregisterEditor(MonacoEditor, "monaco-editor");
                    });

                    /**
                     * An editor implementation using Monaco
                     *
                     * @memberof Editors
                     * @extends Editors.Editor
                     */
                    class MonacoEditor extends Editor {
                        constructor(fragment, options = {}) {
                            super("monaco-editor", fragment, options);

                            this.options = options;

                            this.foreignDecorators = new Map();

                            this.setupEditor();
                        }

                        static registerExtraType(mimeType, language) {
                            MonacoEditor.extraTypes.set(mimeType, language);
                            EditorManager.registerEditorType(mimeType, this);
                        }

                        async setupEditor() {
                            let self = this;

                            let language = "text";

                            switch (self.fragment.type) {
                                case "model/vnd.usda":
                                case "text/x-latex":
                                    language = "plaintext";
                                    break;

                                case "text/javascript":
                                case "text/javascript+babel":
                                case "text/whenjs":
                                case "text/p5js":
                                    language = "javascript";
                                    break;

                                case "text/python":
                                    language = "python";
                                    break;

                                case "text/markdown":
                                    language = "markdown";
                                    break;

                                case "text/html":
                                    language = "html";
                                    break;

                                case "text/css":
                                    language = "css";
                                    break;

                                case "text/x-scss":
                                    language = "scss";
                                    break;

                                case "application/x-lua":
                                    language = "lua";
                                    break;

                                case "text/ruby":
                                    language = "ruby";
                                    break;

                                case "text/x-typescript":
                                    language = "typescript";
                                    break;

                                case "wpm/descriptor":
                                case "application/json":
                                case "text/whenv2":
                                    language = "json";
                                    break;
                            }

                            if(MonacoEditor.extraTypes.has(self.fragment.type)) {
                                console.log("Using extra type:", self.fragment.type);
                                language = MonacoEditor.extraTypes.get(self.fragment.type);
                            }

                            requirejs(["vs/editor/editor.main"], (monaco) => {
                                EventSystem.triggerEvent("Codestrates.Editor.Monaco.Loaded", {
                                    monaco: monaco
                                });

                                let theme = "vs";
                                if (self.options.theme) theme = self.options.theme;
                                if (self.options.theme === "dark") theme = "vs-dark";

                                monaco.languages.json.jsonDefaults.diagnosticsOptions.enableSchemaRequest = true;

                                self.editor = monaco.editor.create(self.editorDiv[0], {
                                    value: this.fragment.raw,
                                    language: language,
                                    theme: theme,
                                    minimap: {
                                        enabled: false
                                    },
                                    automaticLayout: false,
                                    fixedOverflowWidgets: true,
                                    contextmenu: false,
                                    scrollBeyondLastLine: false,
                                    scrollBeyondLastColumn: 0,
                                    occurrencesHighlight: false,
                                    selectionHighlight: false,
                                    accessibilitySupport: "off",
                                    folding: false,
                                    guides: {
                                        bracketPairs: true
                                    },
                                    readOnly: this.options.readOnly,
                                    bracketPairColorization: {
                                        enabled: true
                                    },
                                    scrollbar: {
                                        alwaysConsumeMouseWheel: false,
                                        horizontal: 'auto',
                                        vertical: 'auto',
                                        horizontalScrollbarSize: 17
                                    }
                                });

                                self.editor.getModel().setEOL(0);

                                if (self.options.mode === "full") {
                                    //Setup resizeing for all the lines

                                    self.editor.getModel().onDidChangeContent(()=>{self.updateSize();});
                                    self.editor.getModel().onDidChangeDecorations(()=>{
                                        setTimeout(()=>{
                                            self.updateSize();
                                        }, 0);
                                    });

                                    self.updateSize();
                                }

                                self.editor.getModel().onDidChangeContent((evt) => {
                                    self.handleModelChanged();
                                });

                                self.editor.onDidChangeCursorSelection((evt)=>{
                                    self.triggerCursorSelection({
                                        startLine: evt.selection.startLineNumber,
                                        startColumn: evt.selection.startColumn,
                                        endLine: evt.selection.endLineNumber,
                                        endColumn: evt.selection.endColumn,
                                        positionLine: evt.selection.positionLineNumber,
                                        positionColumn: evt.selection.positionColumn
                                    });
                                });

                                self.triggerEditorOpened();
                            });
                        }

                        focus() {
                            let self = this;

                            if(this.editor == null) {
                                //Try to focus the editor as soon as its created.
                                setTimeout(()=>{
                                    self.focus();
                                }, 100);
                            } else {
                                this.editor.focus();
                            }
                        }

                        setLine(line, column=1) {
                            let self = this;

                            if(this.editor == null) {
                                //Try to focus the editor as soon as its created.
                                setTimeout(()=>{
                                    self.setLine(line);
                                }, 100);
                            } else {
                                this.editor.revealLineNearTop(line);
                                this.editor.setPosition({
                                    column: column,
                                    lineNumber: line
                                });
                            }
                        }

                        updateSize() {
                            let oldWidth = this.editor.getLayoutInfo().width;
                            let numLines = this.editor._modelData.viewModel._lines.getViewLineCount();

                            let height = 19;

                            let viewLines = this.editorDiv.find("div.view-line");

                            if (viewLines.length > 0) {
                                height = viewLines[0].offsetHeight;
                            }

                            this.editor.layout({
                                width: oldWidth,
                                height: numLines * height
                            });

                            let scrollHeight = this.editor.getScrollHeight();

                            if(this.editor.getLayoutInfo().height !== scrollHeight) {
                                this.editor.layout({
                                    width: oldWidth,
                                    height: scrollHeight
                                });
                            }
                        }

                        onSizeChanged() {
                            if (typeof this.editor!=="undefined"){

                                this.editor.layout();

                                if(this.mode === "full") {
                                    this.updateSize();
                                }
                            }
                        }

                        setTheme(themeName){
                            // STUB: Monaco does not support individual themes yet
                            // See this on why this will change all editors simultaneously: https://github.com/Microsoft/monaco-editor/issues/338
                            switch (themeName){
                                case "dark":
                                    // this.editor._themeService
                                    monaco.editor.setTheme("vs-dark");
                                    break
                                default:
                                    monaco.editor.setTheme("vs");
                            }
                        }

                        updateForeignSelections(remoteClient = null) {
                            let self = this;

                            if(this.editor == null) {
                                //Editor not ready yet.
                                return;
                            }

                            let clientsToUpdate = [];

                            if(remoteClient != null) {
                                clientsToUpdate.push(remoteClient);
                            } else {
                                clientsToUpdate = Array.from(this.foreignSelections.keys());
                            }

                            clientsToUpdate.forEach((client)=>{
                                let cursorSelection = self.foreignSelections.get(client);
                                let decorations = self.foreignDecorators.get(client);

                                if(decorations == null) {
                                    decorations = [];
                                }

                                let updatedDecoration = [];

                                if(cursorSelection != null) {
                                    updatedDecoration.push({
                                        range: new monaco.Range(cursorSelection.positionLine, cursorSelection.positionColumn, cursorSelection.positionLine, cursorSelection.positionColumn),
                                        options: {
                                            className: "otherCursor_" + client,
                                            zIndex: 1
                                        }
                                    });

                                    if (cursorSelection.startLine != cursorSelection.endLine || cursorSelection.startColumn != cursorSelection.endColumn) {
                                        updatedDecoration.push({
                                            range: new monaco.Range(cursorSelection.startLine, cursorSelection.startColumn, cursorSelection.endLine, cursorSelection.endColumn),
                                            options: {
                                                className: "otherSelection_" + client,
                                                zIndex: 0
                                            }
                                        });
                                    }
                                }

                                decorations = self.editor.deltaDecorations(decorations, updatedDecoration);

                                self.foreignDecorators.set(client, decorations);
                            });
                        }

                        getValue() {
                            if(this.editor == null) {
                                return null;
                            }

                            return this.editor.getModel().getValue();
                        }

                        setValue(value) {
                            if(this.editor == null) {
                                return;
                            }

                            this.editor.getModel().setValue(value);
                        }

                        insertText(pos, val) {
                            if(this.editor == null) {
                                return;
                            }

                            let startPosition = this.editor.getModel().getPositionAt(pos);
                            let range = monaco.Range.fromPositions(startPosition, startPosition);

                            this.editor.getModel().applyEdits([{
                                forceMoveMarkers: true,
                                range: range,
                                text: val
                            }]);

                            this.updateForeignSelections();
                        }

                        deleteText(pos, val) {
                            if(this.editor == null) {
                                return;
                            }

                            let startPosition = this.editor.getModel().getPositionAt(pos);
                            let endPosition = this.editor.getModel().getPositionAt(pos+val.length);
                            let range = monaco.Range.fromPositions(startPosition, endPosition);

                            this.editor.getModel().applyEdits([{
                                range: range,
                                text: ""
                            }]);

                            this.updateForeignSelections();
                        }

                        insertAtSelection(text) {
                            this.editor.executeEdits("draggedIntoEditor", [{
                                identifier: {
                                    major: 1,
                                    minor: 1
                                },
                                range: this.editor.getSelection(),
                                text: text,
                                forceMoveMarkers: true
                            }]);
                        }

                        unload() {
                            //Kill monaco?
                            if(this.editor != null) {
                                this.editor.getModel().dispose();
                                this.editor.dispose();
                                this.editor = null;
                            }

                            super.unload();
                        }

                        setWordwrap(state) {
                            if(this.editor != null) {
                                this.editor.updateOptions({"wordWrap": state?"on":"off"});
                            }
                        }

                        static types() {
                            return [
                                "text/javascript",
                                "text/javascript+babel",
                                "text/p5js",
                                "text/whenjs",
                                "text/whenv2",
                                "text/varv",
                                "text/varvscript",
                                "text/python",
                                "text/markdown",
                                "text/html",
                                "text/css",
                                "text/ruby",
                                "text/x-scss",
                                "text/x-typescript",
                                "application/x-lua",
                                "wpm/descriptor",
                                "model/vnd.usda",
                                "application/json",
                                "text/x-latex",
                                ...MonacoEditor.extraTypes.keys()
                            ];
                        }
                    }; window.MonacoEditor = MonacoEditor;
                    MonacoEditor.extraTypes = new Map();

                    EditorManager.registerEditor(MonacoEditor);

                    </SCRIPT><STYLE id="base-style">
                    .decorationsOverviewRuler {
                        display: none;
                    }

                    .otherCursor::before {
                        content: " ";
                        width: 2px;
                        height: 100%;
                        display: block;
                    }

                    .otherSelection {
                    }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronNamespace" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron namespace",
                        "description": "Provides the cauldron namespace",
                        "dependencies": [],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="namespace-script" type="disabled">
                    /**
                     * @namespace Cauldron
                     */
                    window.Cauldron = {};

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronCollaboration" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron collabration module",
                        "description": "Provides features for showing collaborators in different ways",
                        "dependencies": [
                            "codestrates-repos #EventSystem",
                            "wpm_js_libs #cQuery"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="collaboration-script" type="disabled">
                    /**
                     *  Collaboration
                     *  A collaboration overlay for showing other connected users' focus in Cauldron
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global webstrate */

                    class Collaboration {

                        constructor(numColors) {
                            let self = this;

                            //Setup colors
                            this.availableColors = new Set();

                            //Select 16 different colors
                            for(let i = 0; i<numColors; i++) {
                                this.availableColors.add(Collaboration.selectColor(i, numColors));
                            }

                            //Setup transient to hold styles
                            this.styleTransient = document.createElement("transient");
                            this.styleTransient.id = "Collaboration-Styles";
                            document.head.appendChild(this.styleTransient);

                            //Client map that holds all our known remote clients
                            this.clientMap = new Map();

                            this.currentFocusFragment = null;
                            this.currentSelection = null;

                            //Listen for clients leaving
                            webstrate.on("clientPart", (remoteClient)=>{
                                self.onClientPart(remoteClient);
                            });

                            //Listen for clients joining
                            webstrate.on("clientJoin", (remoteClient)=>{
                                self.setupClient(remoteClient);
                            });

                            //Setup already connected clients
                            webstrate.clients.forEach((client)=>{
                                if(client === webstrate.clientId) {
                                    //Ignore self
                                    return;
                                }

                                self.setupClient(client);
                            });

                            this.setupObserver();

                            this.setupEventHandlers();

                            document.querySelectorAll("code-fragment").forEach((fragment)=>{
                                self.handleFragmentFound(fragment);
                            });

                            webstrate.on("signal", (msg, sender)=>{
                                self.handleSignal(msg, sender);
                            });
                        }

                        handleSignal(msg, sender) {
                            let self = this;

                            //Ignore ourself
                            if(sender === webstrate.clientId) {
                                return;
                            }

                            if(msg.cmd != null) {
                                switch (msg.cmd) {
                                    case "Collaboration.UserJoined": {
                                        //Someone joined our webstrate, tell them who we are
                                        self.sendUserInfoSignal(sender);

                                        //Also tell them what we are currently focusing, and selecting
                                        self.sendCurrentFocusAndSelection(sender);

                                        break;
                                    }

                                    case "Collaboration.UserInfo": {
                                        let client = self.getClient(sender);
                                        client.info = msg.info;

                                        break;
                                    }
                                }
                            }
                        }

                        getClient(clientId) {
                            let client = this.clientMap.get(clientId);

                            if(client == null) {
                                client = {
                                    id: clientId
                                };
                                this.clientMap.set(clientId, client);
                            }

                            return client;
                        }

                        onClientPart(remoteClient) {
                            let client = this.getClient(remoteClient);

                            if(client.style != null) {
                                client.style.remove();
                                this.availableColors.add(client.color);
                            }

                            if(client.focusFragment != null) {
                                EventSystem.triggerEvent("Collaboration.FragmentUnfocused", {
                                    client: client,
                                    fragment: client.focusFragment
                                });
                            }

                            //Remove client info
                            this.clientMap.delete(remoteClient);
                        }

                        setupEventHandlers() {
                            let self = this;

                            EventSystem.registerEventCallback("Collaboration.FragmentFocused", ({detail: {client: client, fragment: fragment}})=>{
                                if(client.deleter != null) {
                                    client.deleter.delete();
                                }

                                let deleter = MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.MetaMenu", {
                                    icon: self.getClientIcon(client.id),
                                    onOpen: (menu, item)=>{
                                        return menu.context === fragment.element;
                                    }
                                });

                                client.deleter = deleter;
                            });

                            EventSystem.registerEventCallback("Collaboration.FragmentUnfocused", ({detail: {client: client, fragment: fragment, userName: userName}})=>{
                                if(client.deleter != null) {
                                    client.deleter.delete();
                                    client.deleter = null;
                                }
                            });

                            EventSystem.registerEventCallback("Codestrates.Editor.Selection", ({detail: {editor: editor, selection: selection}})=>{
                                if(self.currentFocusFragment !== editor.fragment) {
                                    self.setCurrentFocusedFragment(editor.fragment);
                                }

                                self.setCurrentSelection(selection);
                            });

                            EventSystem.registerEventCallback("Codestrates.Editor.Focus", ({detail: {editor: editor}})=>{
                                if(self.currentFocusFragment !== editor.fragment) {
                                    self.setCurrentFocusedFragment(editor.fragment);
                                }
                            });

                            EventSystem.registerEventCallback("Codestrates.Editor.Blur", ({detail: {editor: editor}})=>{
                                if(self.currentFocusFragment === editor.fragment) {
                                    self.setCurrentFocusedFragment(null);
                                }
                            });

                            EventSystem.registerEventCallback("Codestrates.Editor.Opened", ({detail: {editor: editor}})=>{
                                self.clientMap.forEach((client)=>{
                                    if(client.focusFragment === editor.fragment) {
                                        EventSystem.triggerEvent("Collaboration.FragmentSelection", {
                                            client: client,
                                            fragment: editor.fragment,
                                            selection: client.selection
                                        });
                                    }
                                });
                            });
                        }

                        setCurrentFocusedFragment(fragment) {
                            if(this.currentFocusFragment != null) {
                                //Send unfocus signal
                                this.sendUnfocusedSignal(this.currentFocusFragment);
                            }

                            this.currentFocusFragment = fragment;

                            //Send focus signal
                            if(this.currentFocusFragment != null) {
                                this.sendFocusedSignal(this.currentFocusFragment);
                            }
                        }

                        setCurrentSelection(selection) {
                            this.currentSelection = selection;
                            this.sendSelectionSignal(this.currentFocusFragment);
                        }

                        getUserInfo() {
                            return {
                                userName: webstrate.user.displayName!=null?webstrate.user.displayName:webstrate.clientId,
                                avatar:webstrate.user.avatarUrl!=null?webstrate.user.avatarUrl:null
                            }
                        }

                        sendCurrentFocusAndSelection(receiver) {
                            if(this.currentFocusFragment != null) {
                                this.sendFocusedSignal(this.currentFocusFragment, receiver);
                            }
                            if(this.currentSelection != null) {
                                this.sendSelectionSignal(this.currentFocusFragment, receiver);
                            }
                        }

                        /**
                         * Send our user info
                         * @param receiver - The webstrate client to receive our user info, if null, everyone gets it
                         */
                        sendUserInfoSignal(receiver) {
                            this.sendSignal({
                                msg: {
                                    cmd: "Collaboration.UserInfo",
                                    info: this.getUserInfo()
                                },
                                receiver: receiver
                            });
                        }

                        sendSelectionSignal(fragment, receiver) {
                            this.sendSignal({
                                msg: {
                                    cmd: "Collaboration.Fragment.Selection",
                                    selection: this.currentSelection
                                },
                                receiver: receiver,
                                fragment: fragment
                            });
                        }

                        sendSignal(options) {
                            let channel = webstrate;

                            if(options.fragment != null) {
                                channel = options.fragment.element.webstrate;
                            }

                            if(channel != null) {
                                if(options.receiver != null) {
                                    channel.signal(options.msg, [options.receiver]);
                                } else {
                                    channel.signal(options.msg);
                                }
                            }
                        }

                        /**
                         * Tell everyone that a fragment has been unfocused
                         * @param fragment - The fragment that was unfocused
                         */
                        sendUnfocusedSignal(fragment, receiver) {
                            this.sendSignal({
                                msg: {
                                    cmd: "Collaboration.Fragment.Unfocused"
                                },
                                receiver: receiver,
                                fragment: fragment
                            });
                        }

                        /**
                         * Tell everyone that a fragment has been focused
                         * @param fragment - The fragment that was unfocused
                         */
                        sendFocusedSignal(fragment, receiver) {
                            this.sendSignal({
                                msg: {
                                    cmd: "Collaboration.Fragment.Focused"
                                },
                                receiver: receiver,
                                fragment: fragment
                            });
                        }

                        /**
                         * Tell everyone that we joined the webstrate
                         */
                        sendJoinSignal() {
                            this.sendSignal({
                                msg: {
                                    cmd: "Collaboration.UserJoined"
                                }
                            });
                        }

                        setupClient(remoteClient) {
                            let client = this.getClient(remoteClient);

                            if(client.style == null) {
                                client.style = document.createElement("style");
                            }

                            let colorArray = Array.from(this.availableColors.values());
                            let random = Math.floor(Math.random() * colorArray.length);
                            let color = colorArray[random];
                            this.availableColors.delete(color);

                            client.color = color;

                            client.style.innerHTML = `
                    .otherCursor_${remoteClient}::before {
                        background-color: hsl(${color}, 100%, 65%);
                    }

                    .otherSelection_${remoteClient} {
                        background-color: hsla(${color}, 100%, 50%, 0.1);
                    }`

                            this.styleTransient.appendChild(client.style);
                        }

                        getClientIcon(remoteClient) {
                            let client = this.getClient(remoteClient);

                            let icon = WebstrateComponents.Tools.loadTemplate("Collaboration_icon");
                            cQuery(icon).one("#initials").appendChild(document.createTextNode(client.info.userName.substring(0, 2)));
                            cQuery(icon).one("#name").appendChild(document.createTextNode(client.info.userName));
                            if(client.info.avatar != null) {
                                cQuery(icon).one("image").setAttribute("href", client.info.avatar);
                            } else {
                                cQuery(icon).one("image").remove();
                            }
                            icon.style.color = `hsl(${client.color}, 100%, 15%)`;
                            icon.style.fill = `hsl(${client.color}, 100%, 75%)`;
                            icon.classList.add("collaboration-client-icon");
                            return icon;
                        }

                        handleFragmentFound(fragmentElement) {
                            let self = this;

                            let fragment = cQuery(fragmentElement).data("Fragment");

                            //Check if fragment is transient
                            if(webstrate.config.isTransientElement(fragmentElement)) {
                                //No colaboration possible on transient elements
                                return;
                            }

                            //Setup fragment listening of clients
                            fragmentElement.webstrate.on("signal", (msg, sender)=>{
                                if(sender === webstrate.clientId) {
                                    //Skip self
                                    return;
                                }

                                let client = self.getClient(sender);

                                if(msg.cmd === "Collaboration.Fragment.Selection" || msg.cmd === "Collaboration.Fragment.Focused") {
                                    if(client.focusFragment !== fragment) {
                                        client.focusFragment = fragment;
                                        EventSystem.triggerEvent("Collaboration.FragmentFocused", {
                                            client: client,
                                            fragment: fragment
                                        });
                                    }

                                    if(msg.selection != null) {
                                        client.selection = msg.selection;
                                        EventSystem.triggerEvent("Collaboration.FragmentSelection", {
                                            client: client,
                                            fragment: fragment,
                                            selection: msg.selection
                                        });
                                    }
                                } else if(msg.cmd === "Collaboration.Fragment.Unfocused") {
                                    if(client.focusFragment === fragment) {
                                        client.focusFragment = null;
                                        EventSystem.triggerEvent("Collaboration.FragmentUnfocused", {
                                            client: client,
                                            fragment: fragment
                                        });
                                    }
                                }
                            });
                        }

                        setupObserver() {
                            let self = this;

                            this.observer = new MutationObserver((mutations)=>{
                                mutations.forEach((mutation)=>{
                                    Array.from(mutation.addedNodes).forEach((addedNode)=>{
                                        if(addedNode.matches != null && addedNode.matches("code-fragment")) {
                                            self.handleFragmentFound(addedNode);
                                        }

                                        if(addedNode.querySelectorAll != null) {
                                            addedNode.querySelectorAll("code-fragment").forEach((fragment)=>{
                                                self.handleFragmentFound(fragment);
                                            });
                                        }
                                    });
                                });
                            });

                            this.observer.observe(document, {
                                childList: true,
                                subtree: true
                            });
                        }

                        //Get a color from a HSL divided spectrum
                        static selectColor(colorNum, colors){
                            if (colors < 1) colors = 1; // defaults to one color - avoid divide by zero
                            return (colorNum * (360 / colors) % 360);
                        }
                    }

                    if (typeof webstrate !== "undefined"){
                        // We only support collaboration with a webstrates server backend
                        Cauldron.Collaboration = new Collaboration(16);

                        //Signal everyon on the webstrate that we are here, and who we are
                        Cauldron.Collaboration.sendJoinSignal();
                        Cauldron.Collaboration.sendUserInfoSignal();
                    }

                    </SCRIPT><TEMPLATE id="Collaboration_icon">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <title id="name"></title>
                        <defs>
                            <linearGradient id="g" x1="0%" y1="0%" x2="0%" y2="100%">
                              <stop offset="60%" stop-color="#EEE"></stop>
                              <stop offset="90%" stop-color="#000"></stop>
                            </linearGradient>
                            <mask id="m">
                                <rect x="0" y="0" width="100" height="100" fill="url(#g)"></rect>
                            </mask>
                            <clipPath id="c"><circle cx="50" cy="50" r="44" fill="#FFF"></circle></clipPath>
                         </defs>
                        <circle cx="50" cy="50" r="47" stroke-width="6" stroke="currentColor"></circle>
                        <image mask="url(#m)" opacity="0.5" preserveAspectRatio="xMidYMid slice" clip-path="url(#c)" x="3" y="3" width="94" height="94" xlink:href></image>
                        <text id="initials" font-size="55" x="50%" y="50%" fill="currentColor" stroke="currentColor" dominant-baseline="central" text-anchor="middle" stroke-width="3"></text>
                    </svg>
                    </TEMPLATE><STYLE id="main-style">
                    /**
                     *  Collaboration Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .cauldron-editor-component-clientarea {
                      display: flex; }
                      .cauldron-editor-component-clientarea .collaboration-client-icon {
                        margin-left: -0.4em; }

                    .collaboration-client-icon {
                      width: 1.5em;
                      height: 1.5em;
                      transition: transform 0.1s ease-out;
                      user-select: none; }
                      .collaboration-client-icon:hover {
                        transform: scale(1.1); }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronSettings" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Editor Settings",
                        "description": "Settings for cauldron",
                        "dependencies": [
                            "codestrates-repos #EventSystem"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="settings-script" type="disabled">
                    /**
                     *  Cauldron Settings
                     *  Provides settings that are preserved via localStorage
                     *
                     *  Copyright 2020, 2021, 2024 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                     **/

                    /**
                     * Allow setting settings in localStorage
                     * @type type
                     */
                    class CauldronSettings {
                        /**
                         * Sets word-wrap state
                         * @param {boolean} state - true/false state of word-wrap
                         */
                        static setWordwrap(state) {
                            CauldronSettings.setSetting(CauldronSettings.SETTINGS.wordWrap, state);
                        }

                        /**
                         *
                         * @returns {boolean} true/false depending on if word wrap should be enabled or not
                         */
                        static getWordwrap() {
                            return CauldronSettings.getSetting(CauldronSettings.SETTINGS.wordWrap, false);
                        }

                        static getShadowRoot(){
                            return CauldronSettings.getSetting(CauldronSettings.SETTINGS.shadowRoot, false);
                        }
                        static setShadowRoot(value) {
                            CauldronSettings.setSetting(CauldronSettings.SETTINGS.shadowRoot, value);
                        }

                        static setTheme(theme) {
                            CauldronSettings.setSetting(CauldronSettings.SETTINGS.theme, theme);
                        }

                        static setPageTheme(theme){
                            CauldronSettings.pageTheme = theme;
                        }

                        static getTheme(){
                            // If the page has its own theme, use that
                            if (CauldronSettings.pageTheme) return CauldronSettings.pageTheme;

                            // Try to detect the browser default theme if not set
                            let defaultTheme = "light";
                            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                                defaultTheme = "dark";
                            }

                            return CauldronSettings.getSetting(CauldronSettings.SETTINGS.theme, defaultTheme);
                        }

                        /**
                         *
                         * @param {string} key
                         * @param {any} setting
                         */
                        static setSetting(key, setting) {
                            let settings = CauldronSettings.getSettings();
                            settings[key] = setting;
                            CauldronSettings.setSettings(settings);
                        }

                        /**
                         *
                         * @param {string} key
                         * @param {any} defaultValue
                         */
                        static getSetting(key, defaultValue) {
                            let settings = CauldronSettings.getSettings();
                            if(settings.hasOwnProperty(key)) {
                                return settings[key];
                            }

                            return defaultValue;
                        }

                        /**
                         *
                         * @param {Object} settings
                         */
                        static setSettings(settings) {
                            localStorage.setItem(CauldronSettings.STORAGE_KEY, JSON.stringify(settings));

                            EventSystem.triggerEvent("Cauldron.Settings.Updated", settings);
                            console.log("Settings updated:", settings);
                        }

                        /**
                         *
                         * @returns {Object}
                         */
                        static getSettings() {
                            try {
                                let settings = JSON.parse(localStorage.getItem(CauldronSettings.STORAGE_KEY));

                                if(settings == null || typeof settings !== "object") {
                                    settings = {};
                                }

                                return settings;
                            } catch(e) {
                                //Ignore
                                console.warn("Unable to load CauldronSettings, resetting...");
                            }

                            return {}
                        }
                    }

                    window.Cauldron.CauldronSettings = CauldronSettings;

                    CauldronSettings.SETTINGS = {
                        "wordWrap": "wordWrap",
                        "theme" : "theme",
                        "shadowRoot": "shadowRoot"
                    };

                    CauldronSettings.STORAGE_KEY = "Cauldron.Settings.Key";

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronActionMenu" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Main Actionbar",
                        "description": "Provides a small area for prominent actions",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="actionmenu-script" type="disabled">
                    /**
                     *  CauldronActionMenu
                     *  A menu for prominent Cauldron actions like closing Cauldron
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A menu for prominent Cauldron actions like closing Cauldron
                     */
                    window.CauldronActionMenu = class MainActions {
                        constructor(){
                            this.menu = MenuSystem.MenuManager.createMenu("Cauldron.MainActions", {
                                keepOpen: true,
                                layoutDirection: MenuSystem.Menu.LayoutDirection.HORIZONTAL
                            });

                            this.menu.open();
                            this.menu.html.classList.add("cauldron-actionmenu");
                        }

                        get html(){
                            return this.menu.html;
                        }
                    }

                    </SCRIPT><STYLE id="actionmenu-style">
                    /**
                     *  CauldronActionMenu Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .cauldron-actionmenu {
                      opacity: 0.7;
                      /* Material Design STUB */ }
                      .cauldron-actionmenu:hover {
                        opacity: 1; }
                      .cauldron-actionmenu .mdc-list-item {
                        padding: 0; }
                        .cauldron-actionmenu .mdc-list-item .mdc-list-item__graphic {
                          margin: 0; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronMainMenu" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Main Menu",
                        "description": "Provides the main menu for the editor",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="mainmenu-script" type="disabled">
                    /**
                     *  CauldronMainMenu
                     *  The primary top menu of Cauldron
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * The primary top menu of Cauldron
                     */
                    window.CauldronMainMenu = class MainMenu {
                        constructor(cauldron){
                            this.menu = MenuSystem.MenuManager.createMenu("Cauldron.MainMenu", {
                                keepOpen: true,
                                layoutDirection: MenuSystem.Menu.LayoutDirection.HORIZONTAL
                            });

                            // Register the basic submenus etc. that are always there
                            let fileMenu = MenuSystem.MenuManager.createMenu("Cauldron.File", {
                                context: {cauldron: cauldron},
                                groupDividers: true,
                                growDirection: MenuSystem.Menu.GrowDirection.DOWN
                            });
                            let syncMenu = MenuSystem.MenuManager.createMenu("Cauldron.File.Sync", {
                                context: {cauldron: cauldron}
                            });
                            fileMenu.addItem({
                                label: "Sync...",
                                group: "FileDirect",
                                groupOrder: -1,
                                order: 100,
                                icon: IconRegistry.createIcon("mdc:cloud_sync"),
                                onOpen: (menu)=>{
                                    return syncMenu.menuItems && syncMenu.menuItems.length>0;
                                },
                                submenu: syncMenu
                            });
                            let exportMenu = MenuSystem.MenuManager.createMenu("Cauldron.File.Export");
                            fileMenu.addItem({
                                label: "Export...",
                                group: "FileDirect",
                                groupOrder: -1,
                                order: 100,
                                icon: IconRegistry.createIcon("mdc:download"),
                                onOpen: (menu)=>{
                                    return exportMenu.menuItems && exportMenu.menuItems.length>0;
                                },
                                submenu: exportMenu
                            });

                            this.menu.addItem({
                                label: "File",
                                order: 0,
                                submenu: fileMenu,
                                submenuOnHover: false
                            });

                            // Register the basic submenus etc. that are always there
                            let settingsMenu = MenuSystem.MenuManager.createMenu("Cauldron.Settings", {
                                groupDividers: true,
                                growDirection: MenuSystem.Menu.GrowDirection.DOWN
                            });
                            this.menu.addItem({
                                label: "Settings",
                                order: 100,
                                submenu: settingsMenu,
                                submenuOnHover: false
                            });

                            let viewMenu = MenuSystem.MenuManager.createMenu("Cauldron.View", {
                                groupDividers: true,
                                growDirection: MenuSystem.Menu.GrowDirection.DOWN
                            });
                            this.menu.addItem({
                                label: "View",
                                order: 200,
                                submenu: viewMenu,
                                submenuOnHover: false
                            });

                            let helpMenu = MenuSystem.MenuManager.createMenu("Cauldron.Help", {
                                growDirection: MenuSystem.Menu.GrowDirection.DOWN
                            });
                            this.menu.addItem({
                                label: "Help",
                                order: 999,
                                submenu: helpMenu,
                                submenuOnHover: false
                            });


                            this.menu.open();
                            this.menu.html.classList.add("cauldron-mainmenu");
                        }

                        get html(){
                            return this.menu.html;
                        }
                    }

                    </SCRIPT><STYLE id="mainmenu-style">
                    .cauldron-mainmenu {
                        flex: 1 1 auto;
                    }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronConsole" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Console",
                        "description": "Show a log of fragment output with easy filtering and search",
                        "dependencies": [
                            "#CauldronNamespace"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="console-script" type="disabled">
                    /**
                     *  Cauldron Console
                     *  A textual console for error logging
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * A textual console for error logging
                     */
                    window.Cauldron.CauldronConsole = class CauldronConsole {
                        constructor() {
                            let self = this;

                            this.html = document.createElement("div");
                            this.html.classList.add("cauldron-console-content");

                            this.consoleUl = document.createElement("ul");

                            this.html.appendChild(this.consoleUl);

                            this.contextMenu = MenuSystem.MenuManager.createMenu("Cauldron.Inspector.ContextMenu");

                            //Make errors able to be JSON.stringifyied
                            if (!('toJSON' in Error.prototype)) {
                                Object.defineProperty(Error.prototype, 'toJSON', {
                                    value: function () {
                                        let alt = {};

                                        Object.getOwnPropertyNames(this).forEach(function (key) {
                                            alt[key] = this[key];
                                        }, this);

                                        return alt;
                                    },
                                    configurable: true,
                                    writable: true
                                });
                            }

                            MenuSystem.MenuManager.registerMenuItem("Cauldron.Inspector.ContextMenu", {
                                label: "Clear console",
                                onAction:()=>{
                                    self.consoleUl.innerHTML = "";
                                }
                            });

                            MenuSystem.MenuManager.registerMenuItem("Cauldron.Inspector.ContextMenu", {
                                label: "Filter",
                                onAction:()=>{
                                    let filter = prompt("Enter filter string:");

                                    let entries = Array.from(self.consoleUl.querySelectorAll(".cauldron-console-entry"));

                                    entries.forEach((entry)=>{
                                        entry.classList.add("cauldron-console-entry-filtered");
                                    });

                                    entries.filter((entry)=>{
                                        if(filter == null || filter.trim() === "") {
                                            return true;
                                        } else {
                                            return entry.textContent.toLowerCase().indexOf(filter.trim().toLowerCase()) !== -1;
                                        }
                                    }).forEach((entry)=>{
                                        entry.classList.remove("cauldron-console-entry-filtered");
                                    });
                                }
                            });

                            this.html.addEventListener("contextmenu", (evt)=>{
                                evt.preventDefault();
                            });

                            this.html.addEventListener("mouseup", (evt)=>{
                                if(evt.button !== 2) {
                                    return;
                                }

                                try {
                                    //Find top component after html
                                    let parent = self.html;
                                    while(parent.parentNode != null && !parent.parentNode.matches("html")) {
                                        parent = parent.parentNode;
                                    }
                                    parent.appendChild(self.contextMenu.html);

                                    self.contextMenu.open({
                                        x: evt.pageX,
                                        y: evt.pageY
                                    });
                                } catch(e) {
                                    console.error(e);
                                }
                                evt.preventDefault();
                            });

                            EventSystem.registerEventCallback("Codestrates.Fragment.Error", ({detail: {messages: messages, fragment: fragment}})=>{
                                self.handleMessages(messages, "error", fragment);
                            });

                            EventSystem.registerEventCallback("Codestrates.Fragment.Log", ({detail: {messages: messages, fragment: fragment}})=>{
                                self.handleMessages(messages, "log", fragment);
                            });

                            EventSystem.registerEventCallback("Codestrates.Fragment.Warn", ({detail: {messages: messages, fragment: fragment}})=>{
                                self.handleMessages(messages, "warn", fragment);
                            });
                        }

                        handleMessages(messages, type, fragment) {
                            let li = document.createElement("li");
                            li.classList.add("cauldron-console-entry");

                            let source = document.createElement("span");
                            source.classList.add("cauldron-console-source");
                            let sourceName = "";

                            if (fragment){
                                source.appendChild(IconRegistry.createIcon(["code-fragment:"+fragment.type, "mdc:insert_drive_file"]));
                                if (fragment.element.getAttribute("name")) sourceName = fragment.element.getAttribute("name")+" ";
                                if (fragment.element.id) sourceName += "#"+fragment.element.id;
                                if (sourceName==="") sourceName = fragment.element.tagName.toLowerCase();

                                new CaviTouch(source);

                                source.addEventListener("caviTap", ()=>{
                                    TreeBrowser.findAllTreeBrowsers().forEach((tb)=>{
                                        tb.findTreeNodeForContext(fragment.element).forEach((tn)=>{
                                            tn.reveal();
                                            tn.select();
                                        });
                                    });
                                });

                                source.addEventListener("caviDoubleTap", ()=>{
                                    TreeBrowser.findAllTreeBrowsers().forEach((tb)=>{
                                        tb.findTreeNodeForContext(fragment.element).forEach((tn)=>{
                                            tn.triggerAction();
                                        });
                                    });
                                });
                            }
                            let sourceTitle = document.createElement("span");
                            sourceTitle.textContent = sourceName;
                            source.appendChild(sourceTitle);
                            li.appendChild(source);

                            switch(type) {
                                case "log":
                                    li.classList.add("cauldron-console-entry-log");
                                    break;
                                case "error":
                                    li.classList.add("cauldron-console-error");
                                    break;
                                case "warn":
                                    li.classList.add("cauldron-console-warn");
                                    break;
                            }

                            messages.forEach((msg)=>{
                                let item = document.createElement("span");
                                if(typeof msg === "object") {
                                    function parseDom(dom) {
                                        let tagName = dom.tagName.toLowerCase();

                                        let attributes = "";

                                        Array.from(dom.attributes).forEach((attr)=>{
                                            if(attr.specified) {
                                                attributes += " "+attr.name+"='"+attr.value+"'";
                                            }
                                        });

                                        let result = "<"+tagName+attributes+"></"+tagName+">";

                                        return result;
                                    }

                                    if (msg instanceof Element) {
                                        item.textContent = parseDom(msg);
                                        item.classList.add("cauldron-console-entry-dom");
                                    } else if (msg instanceof StackWalker.StackTrace){
                                        item.textContent = msg.extraReason;
                                        let trace = document.createElement("ul");
                                        trace.classList.add("cauldron-console-entry-stacktrace");

                                        let stack = msg.stack;
                                        stack = StackWalker.compactify(msg.stack);

                                        stack.forEach((stackLine)=>{
                                            let li = document.createElement("li");
                                            li.textContent = stackLine.method + (stackLine.lineNumber != null?":" + stackLine.lineNumber:"");
                                            trace.appendChild(li);
                                        });
                                        item.appendChild(trace);
                                        item.classList.add("cauldron-console-entry-object", "cauldron-console-entry-folded");
                                        item.addEventListener("click", ()=>{
                                            item.classList.toggle("cauldron-console-entry-folded");
                                        });
                                    } else {
                                        let cache = [];

                                        function convertObject(obj) {
                                            if (obj instanceof Error) {
                                                obj = obj.toJSON();
                                            }

                                            if (obj instanceof Set) {
                                                obj = {
                                                    "Set": Array.from(obj)
                                                };
                                            }

                                            if (obj instanceof Map) {
                                                let objMap = {};

                                                obj.forEach((value, key) => {
                                                    objMap[key] = value;
                                                });

                                                obj = {
                                                    "Map": objMap
                                                };
                                            }

                                            return obj;
                                        }

                                        item.textContent = JSON.stringify(msg, (key, value) => {
                                            if (typeof value === "object" && value != null) {
                                                if (value instanceof Element) {
                                                    return parseDom(value);
                                                }

                                                if(cache.includes(value)) {
                                                    return;
                                                }

                                                cache.push(value);

                                                return convertObject(value);
                                            }

                                            return value;
                                        }, 2);;
                                        item.classList.add("cauldron-console-entry-object", "cauldron-console-entry-folded");
                                        item.addEventListener("click", ()=>{
                                            item.classList.toggle("cauldron-console-entry-folded");
                                        });
                                    }
                                } else {
                                    item.textContent = msg;
                                    item.classList.add("cauldron-console-entry-text");
                                }

                                li.appendChild(item);
                            });

                            this.consoleUl.appendChild(li);
                            this.html.scrollTo(0, this.html.scrollHeight);
                        }
                    };

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  Console Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .cauldron-console-content {
                      width: 100%;
                      height: 100%;
                      overflow: auto;
                      font-size: 0.9em; }
                      .cauldron-console-content ul {
                        margin: 0;
                        padding: 0; }
                      .cauldron-console-content .cauldron-console-entry {
                        font-family: monospace;
                        list-style: none;
                        padding: 1px 0.5em 1px 0;
                        border-bottom: 1px solid rgba(100, 100, 100, 0.08); }
                        .cauldron-console-content .cauldron-console-entry.cauldron-console-entry-filtered {
                          display: none; }
                        .cauldron-console-content .cauldron-console-entry .cauldron-console-source {
                          font-size: 0.9em;
                          cursor: pointer;
                          margin-right: 0.5em;
                          background: rgba(100, 100, 100, 0.1);
                          display: inline-flex;
                          align-items: center;
                          padding: 0.25em;
                          vertical-align: sub; }
                          .cauldron-console-content .cauldron-console-entry .cauldron-console-source .wsc-registry-icon {
                            height: 1.5em;
                            width: 1.25em;
                            margin-right: 0.25em; }
                        .cauldron-console-content .cauldron-console-entry.cauldron-console-error {
                          color: red;
                          background: rgba(255, 0, 0, 0.05); }
                          .cauldron-console-content .cauldron-console-entry.cauldron-console-error .cauldron-console-entry-object {
                            color: darkred; }
                            .cauldron-console-content .cauldron-console-entry.cauldron-console-error .cauldron-console-entry-object::before {
                              color: darkred; }
                        .cauldron-console-content .cauldron-console-entry.cauldron-console-warn {
                          color: #756600;
                          background: rgba(250, 242, 85, 0.1); }
                          .cauldron-console-content .cauldron-console-entry.cauldron-console-warn .cauldron-console-entry-object {
                            color: #4f4500; }
                            .cauldron-console-content .cauldron-console-entry.cauldron-console-warn .cauldron-console-entry-object::before {
                              color: #4f4500; }
                        .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-dom {
                          color: hotpink;
                          display: inline-block; }
                        .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-text {
                          padding-right: 1em; }
                        .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-object {
                          white-space: pre;
                          display: block; }
                          .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-object.cauldron-console-entry-folded {
                            white-space: nowrap;
                            text-overflow: ellipsis;
                            max-width: 100%;
                            overflow: hidden;
                            display: block;
                            height: 1em; }
                            .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-object.cauldron-console-entry-folded::before {
                              content: "[+]"; }
                          .cauldron-console-content .cauldron-console-entry .cauldron-console-entry-object::before {
                            content: "[-]"; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronInspector" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="inspector-script" type="disabled">
                    /**
                     *  CauldronInspector
                     *  Visual inspector of various elements that can be edited in Cauldron
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Visual inspector of various elements that can be edited in Cauldron
                     * @type type
                     */
                    class CauldronInspector {
                        constructor(){
                            let self = this;

                            this.html = document.createElement("div");
                            this.html.classList.add("cauldron-inspector");

                            this.fields = document.createElement("div");
                            this.fields.classList.add("cauldron-inspector-fields");
                            this.html.appendChild(this.fields);
                            this.currentSelection = null;

                            this.currentInspectElements = [];

                            EventSystem.registerEventCallback("TreeBrowser.Selection", ({detail: {selection: selection}})=>{
                                self.inspect(selection);
                            });
                        }

                        /**
                         *
                         * @param {TreeNode} selection
                         */
                        inspect(selection) {
                            let self = this;
                            this.currentSelection = selection;

                            this.html.scrollTo(0, 0);

                            let inspectorElements = null;
                            for(let inspector of CauldronInspector.contentBindings) {
                                inspectorElements = inspector.contentBinding.inspect(selection, this);

                                if(inspectorElements != null) {
                                    //First inspector to return something wins.
                                    break;
                                }
                            }

                            //Remove old elements
                            this.currentInspectElements.forEach((inspectElement)=>{
                                inspectElement.destroy();
                            });

                            this.currentInspectElements = [];

                            if(inspectorElements != null) {
                                inspectorElements.forEach((element)=>{
                                    self.fields.append(element.html);
                                    self.currentInspectElements.push(element);
                                });
                            }
                        }

                        reinspect(){
                            this.inspect(this.currentSelection);
                        }

                        /**
                         * Register a content binding for the CauldronInspector component
                         * @param contentBinding
                         * @param {Number} priority
                         */
                        static registerContentBinding(contentBinding, priority) {
                            CauldronInspector.contentBindings.push({
                                contentBinding: contentBinding,
                                priority: priority
                            });

                            //Sort decorators according to priority
                            CauldronInspector.contentBindings.sort((i1, i2)=>{
                                return i2.priority - i1.priority;
                            });
                        }
                    };

                    CauldronInspector.contentBindings = [];

                    window.Cauldron.CauldronInspector = CauldronInspector;

                    class InspectorSegment {
                        constructor(name, parentList){
                            this.html = document.createElement("div");
                            this.html.classList.add("cauldron-inspector-section");
                            let sectionHeader = document.createElement("div");
                            sectionHeader.classList.add("cauldron-inspector-header");
                            sectionHeader.innerText = name;
                            this.html.appendChild(sectionHeader);
                            this.parentList = parentList;
                        }

                        push(element){
                            this.parentList.push(element);
                        }

                        destroy() {
                            this.html.remove();
                        }
                    }
                    window.Cauldron.InspectorSegment = InspectorSegment;


                    class InspectorElement {
                        constructor() {
                            this._html = document.createElement("div");
                            this._html.classList.add("cauldron-inspector-element");
                        }

                        setFailing(failing){
                            if (failing){
                                if (!this._html.classList.contains("failing-element")) this._html.classList.toggle("failing-element");
                            } else {
                                if (this._html.classList.contains("failing-element")) this._html.classList.toggle("failing-element");
                            }
                        }

                        get html() {
                            return this._html;
                        }

                        destroy() {
                            this.html.remove();
                        }
                    }
                    window.Cauldron.InspectorElement = InspectorElement;

                    class InspectorHTMLElement extends InspectorElement {
                        constructor(html) {
                            super();

                            this.html.appendChild(html);
                        }
                    }

                    window.Cauldron.InspectorHTMLElement = InspectorHTMLElement;

                    </SCRIPT><SCRIPT id="InspectorHTMLBinding-script" type="disabled">
                    /**
                     *  Inspector HTML Bindings
                     *  Visual inspector of HTML and DOM elements
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Visual inspector of HTML and DOM elements
                     * @type type
                     */
                    class InspectorHTMLBinding {
                        /**
                         * Inspects the given TreeNode and if supported, returns a map of editable attributes
                         * @param {TreeNode} treeNode
                         * @returns {Cauldron.InspectorElement[]}
                         */
                        static inspect(treeNode, inspector) {
                            if(treeNode.type === "DomTreeNode") {
                                let elements = [];

                                InspectorHTMLBinding.focusEditor = new Cauldron.InspectorAttributeEditor(treeNode.context, "id");

                                let primaryFold = new Cauldron.InspectorSegment("Attributes", elements);
                                elements.push(primaryFold);
                                primaryFold.push(InspectorHTMLBinding.focusEditor);
                                let primaryAttributes = ["class", "name"];

                                switch (treeNode.context.tagName){
                                    case "IMG":
                                        primaryAttributes = [...primaryAttributes, "src", "alt", "width", "height"];
                                        break;
                                    case "SCRIPT":
                                        primaryAttributes = [...primaryAttributes, "src", "type"];
                                        break;
                                    case "IFRAME":
                                        primaryAttributes.push("src");
                                        break;
                                    case "A":
                                        primaryAttributes.push("href");
                                        break;
                                    case "INPUT":
                                        primaryAttributes = [...primaryAttributes, "type", "value"];
                                        break;
                                    case "OPTION":
                                        primaryAttributes.push("value");
                                        break;
                                    case "LINK":
                                        primaryAttributes = [...primaryAttributes, "type", "rel", "href"];
                                        break;
                                    case "LABEL":
                                        primaryAttributes.push("for");
                                        break;
                                    case "BUTTON":
                                        primaryAttributes.push("type");
                                        break;
                                    case "FORM":
                                        primaryAttributes = [...primaryAttributes, "action", "method"];
                                        break;
                                }
                                for (let attribute of primaryAttributes){
                                    primaryFold.push(new Cauldron.InspectorAttributeEditor(treeNode.context, attribute));
                                }
                                primaryAttributes.push("id"); // We already added this manually

                                // Add other attributes present which are not primary ones
                                let fold = new Cauldron.InspectorSegment("Additional Attributes", elements);
                                elements.push(fold);
                                for (let attributeEntry of treeNode.context.attributes){
                                    if (!primaryAttributes.includes(attributeEntry.name)){
                                        fold.push(new Cauldron.InspectorAttributeEditor(treeNode.context, attributeEntry.name));
                                    }
                                }
                                fold.push(new Cauldron.InspectorAttributeAdder(treeNode.context, inspector));

                                return elements;
                            }

                            return null;
                        }
                    }

                    window.Cauldron.InspectorHTMLBinding = InspectorHTMLBinding;

                    Cauldron.CauldronInspector.registerContentBinding(InspectorHTMLBinding, 10);

                    class InspectorAttributeAdder extends Cauldron.InspectorElement {
                        constructor(domElement, inspector){
                            super();
                            let label = document.createElement("label");
                            label.classList.add("cauldron-inspector-element-label");
                            let adderButton = document.createElement("button");
                            adderButton.innerText = "Add Attribute";
                            adderButton.classList.add("cauldron-inspector-element-editor");
                            this.html.append(label);
                            this.html.append(adderButton);

                            adderButton.addEventListener("click", ()=>{
                                let attributeName = prompt("Attribute Name:");
                                if (attributeName !== null && attributeName!==""){
                                    domElement.setAttribute(attributeName,"");
                                    inspector.reinspect();
                                }
                            });
                        }
                    }
                    window.Cauldron.InspectorAttributeAdder = InspectorAttributeAdder;


                    class InspectorAttributeEditor extends Cauldron.InspectorElement {
                        /**
                         *
                         * @param {Element} domElement
                         * @param {String} attrName
                         * @param {String} overrideLabel
                         */
                        constructor(domElement, attrName, overrideLabel= null) {
                            super();

                            let self = this;

                            this.domElement = domElement;
                            this.attrName = attrName;

                            this.editor = document.createElement("input");
                            this.editor.classList.add("cauldron-inspector-element-field");
                            this.editor.classList.add("cauldron-inspector-element-editor");
                            this.editor.setAttribute("contenteditable", "true");
                            this.editor.setAttribute("spellcheck", "false");

                            this.label = document.createElement("span");
                            this.label.classList.add("cauldron-inspector-element-label");
                            this.label.textContent = overrideLabel==null?this.attrName:overrideLabel;

                            this.html.append(this.label);
                            this.html.appendChild(this.editor);
                            this.html.classList.add("inspector-htmlnode");

                            this.editor.value = this.domElement.getAttribute(this.attrName);

                            this.observer = new MutationObserver((mutations)=>{
                                //handleMutations(mutations);
                            });

                            function handleMutations(mutations) {
                                //Attribute changed, update editor
                                if(mutations.length > 0) {
                                    self.editor.value = self.domElement.getAttribute(self.attrName);
                                }
                            }

                            function startObserver() {
                                self.observer.observe(self.domElement, {
                                    attributes: true,
                                    attributeFilter: [self.attrName]
                                });
                            }

                            function pauseObserver() {
                                let mutationRecords = self.observer.takeRecords();
                                self.observer.disconnect();
                                handleMutations(mutationRecords);
                            }

                            startObserver();

                            this.html.addEventListener("keydown", (event)=>{
                                if(event.code === "Enter") {
                                    event.preventDefault();
                                }
                            });

                            this.html.addEventListener("input", (evt)=>{
                                pauseObserver();
                                self.domElement.setAttribute(self.attrName, self.editor.value);
                                setTimeout(()=>{
                                    startObserver();
                                }, 0);
                            });
                        }

                        destroy() {
                            super.destroy();
                            this.observer.disconnect();
                        }

                        focus(){
                            this.editor.select();
                        }
                    }

                    window.Cauldron.InspectorAttributeEditor = InspectorAttributeEditor;

                    EventSystem.registerEventCallback("TreeBrowser.Keyup", ({detail: {evt: evt, treeNode: treeNode}})=>{
                        console.log(evt);
                        if(evt.key === "F2" && InspectorHTMLBinding.focusEditor) {
                            InspectorHTMLBinding.focusEditor.focus();
                        }
                    });

                    </SCRIPT><SCRIPT id="InspectorAssetBinding-script" type="disabled">
                    /**
                     *  Asset Inspector
                     *  Visual inspector for webstrate assets
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * Visual inspector for webstrate assets
                     * @type type
                     */
                    class InspectorAssetBinding {
                        /**
                         * Inspects the given TreeNode and if supported, returns a map of inspector elements
                         * @param {TreeNode} treeNode
                         * @returns {Cauldron.InspectorElement[]}
                         */
                        static inspect(treeNode) {
                            if(treeNode.type === "AssetNode" || treeNode.type === "AssetContainer") {
                                let elements = [];

                                elements.push(new Cauldron.InspectorAssetPreviewElement(treeNode));
                                elements.push(new Cauldron.InspectorAssetAttributeElement(treeNode, "fileName", "name"));
                                elements.push(new Cauldron.InspectorAssetAttributeElement(treeNode, "v", "version"));
                                elements.push(new Cauldron.InspectorAssetAttributeElement(treeNode, "fileSize", "size", true));
                                elements.push(new Cauldron.InspectorAssetAttributeElement(treeNode, "mimeType", "type"));

                                let downloadButton = ButtonSystem.ButtonFactory.createButton("Download", {
                                    onAction: ()=>{
                                        EventSystem.triggerEvent("Cauldron.Asset.Download", {
                                            asset: treeNode.context
                                        });
                                    },
                                    style: "outlined",
                                    icon: IconRegistry.createIcon("mdc:get_app"),
                                });

                                elements.push(new Cauldron.InspectorHTMLElement(downloadButton.html));

                                downloadButton.html.style.gridColumn = "1/3";

                                return elements;
                            }

                            return null;
                        }
                    }

                    window.Cauldron.InspectorAssetBinding = InspectorAssetBinding;

                    Cauldron.CauldronInspector.registerContentBinding(InspectorAssetBinding, 10);

                    class InspectorAssetAttributeElement extends Cauldron.InspectorElement {
                        /**
                         *
                         * @param {TreeNode} treeNode
                         * @param {String} attrName
                         * @param {String} overrideLabel
                         */
                        constructor(treeNode, attrName, overrideLabel = null, formatSize = false) {
                            super();

                            let self = this;

                            this.formatSize = formatSize;

                            this.treeNode = treeNode;
                            this.attrName = attrName;

                            this.label = document.createElement("span");
                            this.label.classList.add("cauldron-inspector-element-label");
                            this.label.textContent = overrideLabel==null?this.attrName+":":overrideLabel;

                            this.content = document.createElement("span");
                            this.content.classList.add("cauldron-inspector-element-field");

                            this.html.appendChild(this.label);
                            this.html.appendChild(this.content);

                            this.handleAssetUpdated = function() {
                                self.assetUpdated();
                            };

                            this.treeNode.registerOnDecoratedCallback(this.handleAssetUpdated);

                            this.assetUpdated();
                        }

                        destroy() {
                            super.destroy();
                            this.treeNode.deregisterOnDecoratedCallback(this.handleAssetUpdated);
                        }

                        assetUpdated() {
                            let value = this.treeNode.context[this.attrName];

                            if(this.formatSize) {
                                let unit = "B";

                                value = parseInt(value);

                                if(value > 1024) {
                                    value /= 1024;
                                    unit = "KiB";

                                    if(value > 1024) {
                                        value /= 1024;
                                        unit = "MiB";

                                        if(value > 1024) {
                                            value /= 1024;
                                            unit = "GiB";

                                            if(value > 1024) {
                                                value /= 1024;
                                                unit = "TiB";
                                            }
                                        }
                                    }
                                }



                                value = value.toFixed(2) + " " + unit;
                            }

                            this.content.textContent = value;
                        }
                    }

                    window.Cauldron.InspectorAssetAttributeElement = InspectorAssetAttributeElement;

                    class InspectorAssetPreviewElement extends Cauldron.InspectorElement {
                        constructor(treeNode) {
                            super();
                            let self = this;

                            this.treeNode = treeNode;

                            this.handleAssetUpdated = function() {
                                self.assetUpdated();
                            };

                            this.treeNode.registerOnDecoratedCallback(this.handleAssetUpdated);

                            this.assetUpdated();
                            this.html.classList.add("inspector-asset");
                        }

                        destroy() {
                            super.destroy();
                            this.treeNode.deregisterOnDecoratedCallback(this.handleAssetUpdated);
                        }

                        assetUpdated() {
                            while(this.html.firstChild) this.html.firstChild.remove();

                            let element = null;
                            switch(this.treeNode.context["mimeType"]){
                                case "image/svg+xml":
                                case "image/gif":
                                case "image/jpeg":
                                case "image/bmp":
                                case "image/x-icon":
                                case "image/png":
                                    element = document.createElement("img");
                                    element.src = location.href.split("?")[0] + this.treeNode.context["fileName"];
                                    break;

                                case "video/x-matroska":
                                case "video/quicktime":
                                case "video/mp4":
                                case "video/webm":
                                case "video/opgg":
                                    element = document.createElement("video");
                                    element.src = location.href.split("?")[0] + this.treeNode.context["fileName"];
                                    element.setAttribute("controls", true);
                                    break;

                                case "audio/mp3":
                                case "audio/wav":
                                case "audio/ogg":
                                case "audio/mpeg":
                                    element = document.createElement("audio");
                                    element.src = location.href.split("?")[0] + this.treeNode.context["fileName"];
                                    element.setAttribute("controls", true);
                                    break;

                                default:
                                    console.log("Unhandled mimeType:", this.treeNode.context["mimeType"]);
                                    return;
                            }

                            element.classList.add("cauldron-inspector-element-asset-preview");
                            element.setAttribute("tabindex","0");
                            this.html.appendChild(element);

                        }
                    }

                    window.Cauldron.InspectorAssetPreviewElement = InspectorAssetPreviewElement;

                    </SCRIPT><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Inspector",
                        "description": "Provides a list view of editable attributes and parameters",
                        "dependencies": [
                            "#CauldronNamespace"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  CauldronInspector Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    @keyframes cauldron-inspector-asset-preview-appears {
                      from {
                        opacity: 0;
                        transform: scaleY(0.2); }
                      to {
                        opacity: 1;
                        transform: scaleY(1); } }

                    .cauldron-inspector {
                      overflow-y: auto;
                      height: 100%;
                      font-size: 0.9em; }
                      .cauldron-inspector .cauldron-inspector-fields {
                        display: grid;
                        grid-template-columns: [label] 0fr [field] 1fr [extras] 0fr; }
                        .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-section {
                          grid-column-start: 1;
                          grid-column-end: -1; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-section:not(:first-child) {
                            padding-top: 1em; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-section .cauldron-inspector-header {
                            padding-left: 0.5em;
                            opacity: 0.7;
                            border-bottom: 1px solid rgba(0, 0, 0, 0.2); }
                        .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element {
                          display: contents; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-label {
                            grid-column-start: label;
                            text-align: right;
                            padding: 0.25em 0.5em;
                            background: rgba(100, 100, 100, 0.1);
                            opacity: 0.7;
                            display: flex;
                            align-items: center;
                            justify-content: right; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element:focus-within .cauldron-inspector-element-label {
                            opacity: 1; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element.failing-element * {
                            background: red !important; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-field {
                            background: rgba(100, 100, 100, 0.1);
                            grid-column-start: field;
                            justify-self: stretch;
                            padding: 0.25em;
                            display: flex; }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-editor {
                            background: transparent;
                            border: 0;
                            border-bottom: 1px solid rgba(100, 100, 100, 0.15);
                            min-width: 2em;
                            width: 95%;
                            color: var(--mdc-theme-primary-on-background); }
                          .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-asset-preview {
                            grid-column: 1/-1;
                            height: 5em;
                            max-width: 100%;
                            justify-self: center;
                            cursor: pointer;
                            position: relative; }
                            .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-asset-preview:focus, .cauldron-inspector .cauldron-inspector-fields .cauldron-inspector-element .cauldron-inspector-element-asset-preview:focus-within {
                              position: fixed;
                              left: 10%;
                              width: 80%;
                              top: 10%;
                              height: 80%;
                              background: rgba(0, 0, 0, 0.8);
                              box-shadow: 0 0 1em;
                              z-index: 9000;
                              animation: 0.1s cauldron-inspector-asset-preview-appears ease-out; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronEditor" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Editor",
                        "description": "Component that can show a Codestrates Editor",
                        "dependencies": [
                            "#CauldronNamespace"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="editor-component-script" type="disabled">
                    /**
                     *  CauldronEditor
                     *  Binding for editing Codestrate Fragments
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /**
                     * CauldronEditor is a component that can edit Codestrate Fragments
                     * @memberof Cauldron
                     */
                    class CauldronEditor {
                        /**
                         * Create a new CauldronEditor that edits the given Fragment
                         * @param {Fragments.Fragment} fragment - The fragment to edit
                         */
                        constructor(fragment, options) {
                            let self = this;

                            /** @member {Fragments.Fragment} - The fragment this CauldronEditor edits */
                            this.fragment = fragment;

                            this.options = options;

                            /** @member {Element} - The DOM element of this CauldronEditor */
                            this.html = document.createElement("div");
                            this.html.classList.add("cauldron-editor-component");

                            /** @member {Editors.Editor} - The codestrates editor of this CauldronEditor */
                            this.editor = EditorManager.createEditor(fragment, {
                                editor: this.options.editorClass,
                                theme: Cauldron.CauldronSettings.getTheme(),
                                mode: "component"
                            })[0];

                            this.toolbar = document.createElement("div");
                            this.toolbar.classList.add("cauldron-editor-component-toolbar");
                            this.southArea = document.createElement("div");
                            this.southArea.classList.add("cauldron-editor-component-south");

                            this.toolbarMenu = MenuSystem.MenuManager.createMenu("Cauldron.Editor.Toolbar", {
                                context: self.fragment,
                                keepOpen: true,
                                layoutDirection: MenuSystem.Menu.LayoutDirection.HORIZONTAL,
                                defaultFocus: false
                            });

                            this.toolbar.appendChild(this.toolbarMenu.html);

                            this.html.appendChild(this.toolbar);

                            if(this.editor != null) {
                                this.html.appendChild(this.editor.html[0]);
                            } else {
                                //Show warning instead of editor
                                let warningDiv = document.createElement("div");
                                this.html.appendChild(warningDiv);
                                warningDiv.textContent = "No suitable editors could be found for fragment type ["+this.fragment.type+"] - Maybe require more editors.";
                            }

                            this.html.appendChild(this.southArea);

                            this.fragment.registerOnAutoChangedHandler(()=>{
                                //Update menu when fragment changes
                                self.toolbarMenu.update();
                            });

                            function unloadHandler() {
                                try {
                                    self.html.glContainer.close();
                                    self.destroy();
                                } catch(e) {
                                    //Silent ignore
                                }
                                self.fragment.unRegisterOnFragmentUnloadedHandler(unloadHandler);
                            }

                            this.fragment.registerOnFragmentUnloadedHandler(unloadHandler);

                            this.html.addEventListener("keydown", (evt)=> {
                                if(evt.key === "s" && evt.ctrlKey) {
                                    evt.preventDefault();
                                }
                            });

                            this.clientIcons = new Map();

                            this.clientIconArea = document.createElement("div");
                            this.clientIconArea.classList.add("cauldron-editor-component-clientarea");
                            this.toolbar.insertBefore(this.clientIconArea, self.toolbar.firstChild);

                            this.eventDeleters = [];

                            this.eventDeleters.push(EventSystem.registerEventCallback("Collaboration.FragmentFocused", ({detail: { client:client, fragment: fragment}})=>{
                                if(fragment === self.fragment) {
                                    self.addClientIcon(client);
                                }
                            }));

                            this.eventDeleters.push(EventSystem.registerEventCallback("Collaboration.FragmentSelection", ({detail: { client:client, fragment: fragment, selection: selection}})=>{
                                if(fragment === self.fragment) {
                                    if(self.editor != null) {
                                        self.editor.setForeignSelection(client.id, selection);
                                    }
                                    self.addClientIcon(client);
                                }
                            }));

                            this.eventDeleters.push(EventSystem.registerEventCallback("Collaboration.FragmentUnfocused", ({detail: { client:client, fragment: fragment}})=>{
                                if(fragment === self.fragment) {
                                    if(self.editor != null) {
                                        self.editor.setForeignSelection(client.id, null);
                                    }
                                    self.removeClientIcon(client);
                                }
                            }));

                            // Handle live theme updates
                            this.eventDeleters.push(EventSystem.registerEventCallback("Cauldron.Theme", (event)=>{
                                if(self.editor !== null && event.detail.theme !== null) {
                                    self.editor.setTheme(event.detail.theme);
                                }
                            }));


                            if(this.editor != null) {
                                this.setupDropZone();

                                //Setup settings on editor opened, and settings updated
                                EventSystem.registerEventCallback("Cauldron.Settings.Updated", ({detail: settings}) => {
                                    self.editor.setWordwrap(Cauldron.CauldronSettings.getWordwrap());
                                });

                                EventSystem.registerEventCallback("Codestrates.Editor.Opened", ({detail: {editor}})=>{
                                    editor.setWordwrap(Cauldron.CauldronSettings.getWordwrap());
                                });
                            }
                        }

                        addClientIcon(client) {
                            if(!this.clientIcons.has(client.id)) {
                                let icon = Cauldron.Collaboration.getClientIcon(client.id);
                                this.clientIcons.set(client.id, icon);
                                this.clientIconArea.appendChild(icon);
                            }
                        }

                        removeClientIcon(client) {
                            if(this.clientIcons.has(client.id)) {
                                let icon = this.clientIcons.get(client.id);
                                this.clientIcons.delete(client.id);
                                icon.remove();
                            }
                        }

                        onSizeChanged() {
                            if(this.editor != null) {
                                this.editor.onSizeChanged();
                            }
                        }

                        get title() {
                            let content = "";
                            let name = this.fragment.element.getAttribute("name");
                            if (name != null && name != ""){
                                content = name+" ";
                            } else if(this.fragment.element.id != null && this.fragment.element.id!="") {
                                content += "#"+this.fragment.element.id;
                            }
                            if (!content){
                                content = this.fragment.element.tagName.toLowerCase();
                            }
                            if(typeof this.options.titleWrapper === "function") {
                                return this.options.titleWrapper(content);
                            } else {
                                return content;
                            }
                        }

                        get tooltip(){
                            let type = this.fragment.type;
                            let id = this.fragment.element.getAttribute("id");

                            let tooltip = "Fragment";

                            if (id != null && id.trim() !== "") {
                                tooltip += "#" + id;
                            }

                            tooltip += " [" + type + "]";
                            return tooltip;
                        }

                        focus() {
                            if(this.editor != null) {
                                this.editor.focus();
                            }
                        }

                        setLine(line, column=1) {
                            if(this.editor != null) {
                                this.editor.setLine(line, column);
                            }
                        }

                        destroy() {
                            if(this.editor != null) {
                                this.editor.unload();
                            }

                            this.editor = null;

                            this.eventDeleters.forEach((deleter)=>{
                                deleter.delete();
                            });
                        }

                        setupDropZone() {
                            let self = this;

                            new CaviDroppableHTML5(this.html, {
                                onDragLeave: (evt)=>{
                                },
                                onDragOver: (evt)=>{
                                    evt.dataTransfer.dropEffect = "none";

                                    if(evt.dataTransfer.types.includes("treenode/uuid")) {
                                        let dragUUID = null;

                                        evt.dataTransfer.types.forEach((type)=>{
                                            if(type.indexOf("treenodedata/uuid") !== -1) {
                                                dragUUID = type.split("|")[1];
                                            }
                                        });

                                        let dragged = document.querySelector("[transient-drag-id='" + dragUUID + "']");
                                        if (dragged != null && dragged.treeNode != null) {
                                            let allowedRequireFragments = ["text/javascript", "text/typescript", "text/ruby", "text/python", "application/x-lua"];

                                            if (dragged.treeNode.context.matches != null && dragged.treeNode.context.matches("code-fragment") && dragged.treeNode.context.hasAttribute("id") && allowedRequireFragments.includes(self.fragment.type)) {
                                                evt.dataTransfer.dropEffect = "copy";
                                            } else if(dragged.treeNode.type === "AssetNode" && allowedRequireFragments.includes(self.fragment.type) && (dragged.treeNode.context.fileName.endsWith(".js") || dragged.treeNode.context.fileName.endsWith(".css") )) {
                                                evt.dataTransfer.dropEffect = "copy";
                                            } else if(dragged.treeNode.type === "AssetNode" && self.fragment.type === "wpm/descriptor") {
                                                evt.dataTransfer.dropEffect = "copy";
                                            }
                                        }
                                    }
                                },
                                onDrop: (evt, dropEffect)=>{
                                    let otherWebstrate = null;

                                    if(evt.dataTransfer.types.includes("treenode/href")) {
                                        otherWebstrate = evt.dataTransfer.getData("treenode/href");
                                    }

                                    if(evt.dataTransfer.types.includes("treenode/uuid")) {
                                        try {
                                            let dragUUID = evt.dataTransfer.getData("treenode/uuid");
                                            let dragged = document.querySelector("[transient-drag-id='" + dragUUID + "']");
                                            if (dragged != null && dragged.treeNode != null) {
                                                //Found the dragged TreeNode

                                                let requireData = null;

                                                if(dragged.treeNode.type === "DomTreeNode") {
                                                    requireData = cQuery(dragged.treeNode.context).data("Fragment");
                                                } else if(dragged.treeNode.type === "AssetNode") {
                                                    requireData = dragged.treeNode.context;

                                                    if(self.fragment.type === "wpm/descriptor") {
                                                        //Special insert here
                                                        self.fragment.require().then((descJson)=>{
                                                            if(!descJson.assets.includes(requireData.fileName)) {
                                                                descJson.assets.push(requireData.fileName);
                                                                self.fragment.raw = JSON.stringify(descJson, null, 2);
                                                            }
                                                        });
                                                        return;
                                                    }
                                                }

                                                let requireLine = self.createRequireFromType(self.fragment.type, requireData);
                                                self.editor.insertAtSelection(requireLine);
                                                return;
                                            }
                                        } catch(e) {
                                            console.log("Error accepting drop as treenode/uuid", e);
                                        }
                                    }

                                    console.log("No supported data transfers:", evt.dataTransfer.types.slice());

                                    evt.dataTransfer.types.forEach((type)=>{
                                        console.log(type, evt.dataTransfer.getData(type));
                                    });
                                }
                            });
                        }

                        createRequireFromType(type, requireData) {
                            let requireLine = null;

                            if(requireData instanceof Fragment) {
                                let fragmentId = requireData.element.getAttribute("id");
                                switch(type) {
                                    case "text/javascript":
                                    case "text/typescript":
                                        requireLine = "let "+fragmentId+" = await Fragment.one(\"#"+fragmentId+"\").require();\n";
                                        break;

                                    case "text/ruby":
                                        requireLine = "Native(`Fragment`.JS.one(\"#"+fragmentId+"\").JS.require()).then { |result|\n" +
                                            "    result = Native(result);\n" +
                                            "}";
                                        break;
                                    case "text/python":
                                        requireLine = fragmentId+" = await window.Fragment.one(\"#"+fragmentId+"\").require()\n";
                                        break;
                                    case "application/x-lua":
                                        requireLine = "local "+fragmentId+" = pwait(js.global.Fragment:one(\"#"+fragmentId+"\"):require())\n";
                                        break;

                                    default:
                                        console.log("Unknown type for require creation: ", type);
                                }
                            } else if(requireData.fileName != null) {
                                //Assume asset if fileName exists
                                switch(type) {
                                    case "text/javascript":
                                    case "text/typescript":
                                        requireLine = "await wpm.requireExternal(\""+location.href+requireData.fileName+"\");\n";
                                        break;
                                    case "text/python":
                                        requireLine = "load(\""+location.href+requireData.fileName+"\");\n";
                                        break;

                                    default:
                                        console.log("Unknown type for require creation: ", type);
                                }
                            }

                            return requireLine;
                        }
                    }

                    window.Cauldron.CauldronEditor = CauldronEditor;

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  CauldronEditor Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    .cauldron-editor-component {
                      width: 100%;
                      height: 100%;
                      display: flex;
                      flex-direction: column; }
                      .cauldron-editor-component .cauldron-editor-component-toolbar {
                        background: var(--mdc-theme-surface, rgba(255, 255, 255, 0.6));
                        border-bottom: 1px solid #8a8a8a40;
                        display: flex;
                        justify-content: flex-end;
                        opacity: 0.7; }
                        .cauldron-editor-component .cauldron-editor-component-toolbar:hover {
                          opacity: 1; }
                      .cauldron-editor-component .codestrates-editor-core {
                        height: 0;
                        /** Layouting bug? **/
                        flex: 1 1 auto; }
                      .cauldron-editor-component .cauldron-editor-component-south {
                        background: rgba(255, 255, 255, 0.6);
                        display: flex;
                        justify-content: flex-start;
                        opacity: 0.7; }
                        .cauldron-editor-component .cauldron-editor-component-south:not(:empty), .cauldron-editor-component .cauldron-editor-component-south.unsaved-changes {
                          border-top: 1px solid #8a8a8a40;
                          padding: 0.25em; }
                        .cauldron-editor-component .cauldron-editor-component-south.unsaved-changes {
                          background-color: rgba(255, 0, 0, 0.5); }
                          .cauldron-editor-component .cauldron-editor-component-south.unsaved-changes::before {
                            content: "Unsaved changes!"; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronBase" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Editor",
                        "description": "The base core functionality of Cauldron",
                        "dependencies": [
                            "wpm_js_libs #cQuery",
                            "wpm_js_libs #CaviTouch",
                            "wpm_js_libs #golden-layout",
                            "wpm_js_libs #golden-layout_material-design-theme",
                            "wpm_js_libs #Uploader",
                            "webstrate-components-repos #EdgeDocker",
                            "webstrate-components-repos #FragmentLogoIcons",
                            "webstrate-components-repos #WebstrateIcons",
                            "webstrate-components-repos #MaterialDesignOutlinedIcons",
                            "webstrate-components-repos #MaterialMenu",
                            "webstrate-components-repos #TreeBrowser",
                            "webstrate-components-repos #ButtonSystem",
                            "webstrate-components-repos #ButtonSystem_MaterialDesign",
                            "webstrate-components-repos #ModalDialog",
                            "codestrates-repos #editor_monaco",
                            "#CauldronNamespace",
                            "#CauldronSettings",
                            "#CauldronMainMenu",
                            "#CauldronActionMenu",
                            "#CauldronInspector",
                            "#CauldronConsole",
                            "#CauldronEditor"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="base-script" type="disabled">
                    /**
                     *  Cauldron Base
                     *  The core IDE of Cauldron
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    /* global GoldenLayout */

                    /**
                     * Triggered when a Cauldron is opened.
                     * @event Cauldron.Cauldron#EventSystem:"Cauldron.OnOpen"
                     * @type {CustomEvent}
                     * @property {Cauldron.Cauldron} cauldron - The Cauldron that was opened
                     */

                    /**
                     * Triggered when a Cauldron is closed.
                     * @event Cauldron.Cauldron#EventSystem:"Cauldron.OnClose"
                     * @type {Event}
                     * @property {Cauldron.Cauldron} cauldron - The Cauldron that was closed
                     */

                    /**
                     * Triggered when a Cauldron is initialized.
                     * @event Cauldron.Cauldron#EventSystem:"Cauldron.OnInit"
                     * @type {Event}
                     * @property {Cauldron.Cauldron} cauldron - The Cauldron that was initialized
                     */

                    /**
                     * Tirgger to open a FragmentEditor
                     * @event Cauldron.Cauldron#EventSystem:"Cauldron.Open.FragmentEditor"
                     * @type {Event}
                     * @property {Fragment} fragment - The fragment to open in a FragmentEditor
                     */

                    /**
                     * The Cauldron editor
                     * @memberOf Cauldron
                     * @alias Cauldron
                     */
                    class CauldronBase {
                        /**
                         * Create a new Cauldron editor
                         */
                        constructor(config={}) {
                            let defaultConfig = {
                                edgeDockerMode: EdgeDocker.MODE.MINIMIZED,
                                edgeDockerLoadMode: true,
                                console: true,
                                inspector: true,
                                actionMenu: true,
                                tabContextMenu: true,
                                mainMenu: true,
                                dragAndDrop: true,
                                goldenLayoutSaveState: true,
                            };

                            this.config = Object.assign({}, defaultConfig, config);

                            this.setupGoldenLayoutPromise = null;

                            //Setup EdgeDocker
                            this.docker = new EdgeDocker({
                                mode: this.config.edgeDockerMode,
                                shadowRoot: Cauldron.CauldronSettings.getShadowRoot(),
                                shadowCompatibility: Cauldron.CauldronSettings.getShadowRoot()
                            });
                            this.docker.getComponentArea().classList.add("cauldron-themeable");
                            this.docker.getComponentArea().setAttribute("cauldron-theme", Cauldron.CauldronSettings.getTheme());

                            //Setup container divs
                            this.editorContentArea = document.createElement("div");
                            this.editorContentArea.classList.add("cauldron-base-content");
                            this.docker.getComponentArea().appendChild(this.editorContentArea);

                            //Setup main menu
                            if(this.config.mainMenu) {
                                this.topBar = document.createElement("div");
                                this.topBar.classList.add("cauldron-base-top");
                                this.mainMenu = new CauldronMainMenu(this);
                                this.docker.setupDragHandle(this.mainMenu.html);
                            }

                            // Action menu
                            if(this.config.actionMenu) {
                                this.actionMenu = new CauldronActionMenu();
                                this.topBar.appendChild(this.actionMenu.html);
                                this.topBar.appendChild(this.mainMenu.html);
                                this.editorContentArea.appendChild(this.topBar);
                            }

                            // Inspector
                            if(this.config.inspector) {
                                this.inspector = new Cauldron.CauldronInspector();
                            }

                            //Console
                            if(this.config.console) {
                                this.console = new Cauldron.CauldronConsole();
                            }

                            this.goldenLayoutArea = document.createElement("div");
                            this.goldenLayoutArea.classList.add("cauldron-layout");
                            this.editorContentArea.appendChild(this.goldenLayoutArea);

                            this.goldenLayoutInitDone = false;

                            //Added components
                            this.registeredComponentNames = new Set();

                            if(this.config.mainMenu) {
                                this.setupMenuItems();
                            }

                            if(this.config.dragAndDrop) {
                                this.setupDragAndDrop();
                            }

                            this.setupEvents();
                        }

                        /**
                         * Opens Cauldron IDE
                         * Optionally inside another element
                         */
                        async open(optionalParentElement=false) {
                            await this.setupGoldenLayout(this.goldenLayoutArea);

                            this.docker.dockInto(optionalParentElement);
                            if (optionalParentElement){
                                this.docker.setMode(EdgeDocker.MODE.EMBEDDED);
                            } else {
                                if(this.config.edgeDockerLoadMode) {
                                    this.docker.loadMode(EdgeDocker.MODE.RIGHT);
                                } else {
                                    this.docker.setMode(EdgeDocker.MODE.RIGHT, false);
                                }
                            }

                            await EventSystem.triggerEventAsync("Cauldron.OnOpen", {
                                cauldron: this
                            });

                            if(!this.goldenLayoutInitDone) {
                                let initialisedPromise = new Promise((resolve, reject)=>{
                                    this.goldenLayout.on("initialised", ()=>{
                                        resolve();
                                    });
                                });
                                this.goldenLayout.init();
                                await initialisedPromise;
                                this.goldenLayoutInitDone = true;
                                EventSystem.triggerEvent("Cauldron.OnInit", {
                                    cauldron: this
                                });
                            }
                        }


                        /**
                         * Closes Cauldron IDE
                         */
                        close() {
                            this.docker.setMode(EdgeDocker.MODE.MINIMIZED);

                            EventSystem.triggerEvent("Cauldron.OnClose", {
                                cauldron: this
                            });
                        }

                        /**
                         * Check wether this Cauldron editor is open
                         * @returns {boolean} true/false depending on if Cauldron is open or not
                         */
                        isOpen() {
                            return this.docker.currentMode !== EdgeDocker.MODE.MINIMIZED;
                        }

                        /**
                         * Sets the bounds of this Cauldron
                         * @param {Number} x
                         * @param {Number} y
                         * @param {Number} width
                         * @param {Number} height
                         */
                        setBounds(x, y, width, height) {
                            this.docker.setBounds(x, y, width, height);
                        }

                        /**
                         * The parent element to insert popups and overlays into when opening menus etc
                         * @returns element
                         */
                        getPopupParent(){
                            return this.docker.getComponentArea();
                        }

                        /**
                         * @private
                         */
                        setupEvents() {
                            let self = this;

                            EventSystem.registerEventCallback("Cauldron.ResetLayout", ()=>{
                                if(confirm("This will reset Cauldron layout, and reload the page, continue?")) {
                                    let key = "Cauldron-Saved-State-" + location.pathname.replace(/\//g, "");
                                    localStorage.setItem(key, null);
                                    location.reload();
                                }
                            });

                            EventSystem.registerEventCallback("Cauldron.Minimize", ()=>{
                                self.close();
                            });

                            EventSystem.registerEventCallback("Cauldron.Dock", ({detail:{pos: pos}})=>{
                                self.docker.setMode(pos);
                            });

                            EventSystem.registerEventCallback("Cauldron.Theme", ({detail:{theme: theme}})=>{
                                if (theme){
                                    self.docker.getComponentArea().setAttribute("cauldron-theme", theme);
                                }
                            });

                            EventSystem.registerEventCallback("TreeBrowser.TreeNode.Action", ({detail:{node: node, treeBrowser: treeBrowser}}) => {
                                if (node.type === "DomTreeNode" && node.context != null){
                                    if (node.context.matches("code-fragment")){
                                        let fragment = cQuery(node.context).data("Fragment");
                                        EventSystem.triggerEvent("Cauldron.Open.FragmentEditor", {
                                            fragment: fragment
                                        });
                                        return true; //Prevent default event
                                    } else if (node.context.matches("script, style")){
                                        EventSystem.triggerEvent("Cauldron.Open.InnerHTMLEditor", {
                                            element: node.context
                                        });
                                    }
                                }
                            });


                            EventSystem.registerEventCallback("Cauldron.Open.FragmentEditor", async ({detail: {fragment: fragment, line: line, column:column, editorClass: editorClass, titleWrapper: titleWrapper}})=>{

                                if(editorClass == null) {
                                    editorClass = MonacoEditor;
                                }

                                if(titleWrapper == null) {
                                    titleWrapper = (t) => {
                                        return t;
                                    }
                                }

                                //Make sure cauldron is open?
                                if(!this.goldenLayoutInitDone) {
                                    await new Promise((resolve)=>{
                                        EventSystem.registerEventCallback("Cauldron.OnInit", ()=>{
                                            //Since goldenLayout has just opened, lets step back and wait a tick
                                            setTimeout(()=>{
                                                resolve();
                                            }, 0);
                                        });
                                    })
                                }

                                self.createComponent("FragmentEditor", {
                                    fragment: fragment,
                                    line: line,
                                    column: column,
                                    editorClass: editorClass,
                                    titleWrapper: titleWrapper
                                }, false);
                            });

                            EventSystem.registerEventCallback("Cauldron.Open.Preview", ({detail: {fragment: fragment}})=>{
                                self.createComponent("FragmentEditor", {
                                    fragment: fragment,
                                    editorClass: PreviewEditor
                                });
                            });

                            EventSystem.registerEventCallback("Cauldron.Open.InnerHTMLEditor", ({detail: {element: element}}) => {
                                self.createComponent("DomElementEditor", {
                                    element: element
                                });
                            });
                        }

                        /**
                         * Selects a Golden Layout ContentItem, making it the active item in the Stack it lives inside.
                         * @param item - The Golden Layout ContentItem to select
                         * @private
                         */
                        selectItem(item) {
                            //Check for stack parent
                            if(item.parent != null && item.parent.type === "stack") {
                                item.parent.setActiveContentItem(item);
                            }
                        }

                        /**
                         * @private
                         */
                        setupMenuItems() {
                            let self = this;

                            MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                                label: "Console",
                                icon: IconRegistry.createIcon("mdc:laptop"),
                                order: 100,
                                onAction: ()=>{
                                    self.createComponent("Console", {}, false);
                                }
                            });

                            MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                                label: "Inspector",
                                icon: IconRegistry.createIcon("mdc:image_search"),
                                order: 101,
                                onAction: ()=>{
                                    self.createComponent("Inspector", {}, false);
                                }
                            });
                        }

                        /**
                         * Setup golden layout
                         * @param {Element} container - The DOM element to use as a container for golden layout
                         * @private
                         */
                        async setupGoldenLayout(container) {
                            let self = this;

                            if(this.setupGoldenLayoutPromise != null) {
                                await this.setupGoldenLayoutPromise;
                                return;
                            }

                            this.setupGoldenLayoutPromise = new Promise(async (resolve)=>{

                                await loadGoldenLayout(self.goldenLayoutArea);

                                let config = {
                                    settings: {
                                        showPopoutIcon: false,
                                        constrainDragToContainer: true
                                    },
                                    content: [
                                        {
                                            type: "row",
                                            content: [
                                                {
                                                    type: "column",
                                                    width: 25,
                                                    content: [
                                                        {
                                                            type: 'component',
                                                            componentName: 'TreeBrowser',
                                                            componentState: {},
                                                            isClosable: false
                                                        },
                                                        {
                                                            type: 'component',
                                                            height: 25,
                                                            componentName: 'Inspector',
                                                            componentState: {},
                                                            isClosable: true
                                                        }
                                                    ]
                                                },
                                                {
                                                    type: "column",
                                                    width: 75,
                                                    content: [
                                                        {
                                                            type: "stack",
                                                            id: "editors",
                                                            isClosable: false,
                                                            content: []
                                                        },
                                                        {
                                                            type: "component",
                                                            componentName: "Console",
                                                            componentState: {},
                                                            height: 25
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                };

                                if(self.config.goldenLayoutConfig) {
                                    config = self.config.goldenLayoutConfig;
                                }

                                if(self.config.goldenLayoutSaveState) {
                                    let savedState = null;
                                    try {
                                        let key = "Cauldron-Saved-State-" + location.pathname.replace(/\//g, "");

                                        savedState = JSON.parse(localStorage.getItem(key), (key, value) => {
                                            if (key === "content" && value instanceof Array) {
                                                value = value.filter((arrayValue) => {
                                                    return arrayValue !== null;
                                                });

                                                //Fix any content with a missing content array?
                                                value.forEach((child) => {
                                                    if (child.content == null) {
                                                        child.content = [];
                                                    }

                                                    let activeItem = null;

                                                    if (child.activeItemIndex != null) {
                                                        activeItem = child.content[child.activeItemIndex];
                                                    }

                                                    //Remove any components that did not deserialize correctly
                                                    value = value.filter((child) => {
                                                        if (child.componentState != null && child.componentState.deserializeSuccess != null && child.componentState.deserializeSuccess !== true) {
                                                            return false;
                                                        }

                                                        return true;
                                                    });

                                                    if (child.activeItemIndex != null) {
                                                        child.activeItemIndex = Math.max(0, child.content.indexOf(activeItem));
                                                    }
                                                });

                                            }

                                            if (key === "componentState" && value.serializer != null) {
                                                //Use serializer if present
                                                value.serializer.serialize = eval(value.serializer.serialize);
                                                value.serializer.deserialize = eval(value.serializer.deserialize);
                                                value.deserializeSuccess = value.serializer.deserialize(value);
                                            }

                                            return value;
                                        });
                                    } catch (e) {
                                        console.error("Error loading saved state:", e);
                                    }

                                    if (savedState != null) {
                                        self.goldenLayout = new GoldenLayout(savedState, container);
                                    } else {
                                        self.goldenLayout = new GoldenLayout(config, container);
                                    }

                                    let stateChangedTimeoutId = null;

                                    self.goldenLayout.on('stateChanged', function () {
                                        if (stateChangedTimeoutId != null) {
                                            clearTimeout(stateChangedTimeoutId);
                                            stateChangedTimeoutId = null;
                                        }

                                        stateChangedTimeoutId = setTimeout(() => {
                                            stateChangedTimeoutId = null;
                                            let config = self.goldenLayout.toConfig();

                                            let cache = [];

                                            let key = "Cauldron-Saved-State-" + location.pathname.replace(/\//g, "");

                                            localStorage.setItem(key, JSON.stringify(config, (key, value) => {
                                                if (key === "componentState" && value.serializer != null) {
                                                    //Take copy, overriding serializer
                                                    let clone = Object.assign({}, value, {serializer: {}});
                                                    delete clone.deserializeSuccess;

                                                    //Use serializer if present
                                                    value.serializer.serialize(clone);

                                                    clone.serializer.serialize = value.serializer.serialize.toString();
                                                    clone.serializer.deserialize = value.serializer.deserialize.toString();

                                                    return clone;
                                                }

                                                return value;
                                            }));
                                        }, 250);
                                    });
                                } else {
                                    self.goldenLayout = new GoldenLayout(config, container);
                                }

                                // Register TreeBrowser
                                await self.registerComponent("TreeBrowser", (state)=>{
                                    let rootNode = new TreeNode({
                                        context: null,
                                        type: "",
                                        hideSelf: true,
                                        alwaysOpen: true
                                    });

                                    let bodyNode = new DomTreeGenerator().generateTree(document.querySelector("html > body"));
                                    bodyNode.unfold();
                                    rootNode.addNode(bodyNode);

                                    if (typeof webstrate !== "undefined"){
                                        // If we are in a webstrate, also show its assets
                                        let assetNode = new AssetTreeGenerator().generateTree();
                                        assetNode.unfold();
                                        rootNode.addNode(assetNode);
                                    }

                                    EventSystem.triggerEvent("Cauldron.TreeBrowserSpawned", {
                                        root: rootNode
                                    });

                                    let tree = new TreeBrowser(rootNode);

                                    let treeContainer = document.createElement("div");
                                    treeContainer.classList.add("cauldron-navigator");
                                    treeContainer.appendChild(tree.html);

                                    return treeContainer;
                                });

                                //Register FragmentEditor
                                await self.registerComponent("FragmentEditor", (state)=>{

                                    const options = {
                                    };

                                    if(state.editorClass) {
                                        options.editorClass = state.editorClass;
                                    }

                                    if(state.titleWrapper) {
                                        options.titleWrapper = state.titleWrapper;
                                    }

                                    let editorComponent = new Cauldron.CauldronEditor(state.fragment, options);

                                    return {
                                        dom: editorComponent.html,
                                        serializer: {
                                            serialize: (state)=>{
                                                //Serialized needed state into string
                                                if(state.fragment != null && typeof state.fragment !== "string") {
                                                    state.fragment = state.fragment.element.__wid;
                                                }
                                                if(state.editorClass != null && typeof state.editorClass !== "string") {
                                                    state.editorClass = state.editorClass.prototype.constructor.name;
                                                }
                                                if(state.titleWrapper != null && typeof state.titleWrapper === "function") {
                                                    state.titleWrapper = state.titleWrapper.toString();
                                                }
                                                if(state.line) {
                                                    delete state.line;
                                                }
                                            },
                                            deserialize: (state)=>{
                                                //Deserialize state, and return true/false if success
                                                state.fragment = Fragment.find("code-fragment").find((frag)=>{
                                                    return frag.element.__wid === state.fragment;
                                                });

                                                if(state.editorClass != null) {
                                                    state.editorClass = window[state.editorClass];
                                                }

                                                if(state.titleWrapper != null) {
                                                    state.titleWrapper = eval(state.titleWrapper);
                                                }

                                                return state.fragment != null;
                                            }
                                        },
                                        onResize: ()=>{
                                            editorComponent.onSizeChanged();
                                        },
                                        onShow: ()=>{
                                            //On show is called right before the container is actually shown?
                                            setTimeout(()=>{
                                                editorComponent.onSizeChanged();
                                                editorComponent.focus();
                                                if(state.line != null) {
                                                    if (state.column!=null){
                                                        editorComponent.setLine(state.line, state.column);
                                                    } else {
                                                        editorComponent.setLine(state.line);
                                                    }
                                                    //Only do this once
                                                    delete state.line;
                                                    delete state.column;
                                                }
                                            }, 0);
                                        },
                                        onTab: (tab)=>{
                                            let lastTitle = null;
                                            let lastTooltop = null;

                                            function updateTab() {
                                                if(lastTooltop !== editorComponent.tooltip || lastTitle !== editorComponent.title) {
                                                    tab.element[0].title = editorComponent.tooltip;
                                                    tab.titleElement[0].innerText = editorComponent.title;

                                                    tab.titleElement.find(".cauldron-editor-tab-icon").remove();
                                                    let icon = IconRegistry.createIcon(["code-fragment:" + state.fragment.type, "mdc:insert_drive_file"]);
                                                    icon.classList.add("cauldron-editor-tab-icon");
                                                    if (icon) {
                                                        tab.titleElement.prepend(icon);
                                                    }

                                                    // Setup context menu for tab
                                                    tab.element[0].addEventListener("contextmenu", (e)=>{
                                                        e.preventDefault();
                                                    });
                                                    tab.element[0].addEventListener("mouseup", (e)=>{
                                                        if(e.button !== 2) {
                                                           return;
                                                        }

                                                        if(!self.config.tabContextMenu) {
                                                            return;
                                                        }

                                                        let contextMenu = MenuSystem.MenuManager.createMenu("Cauldron.Tab.ContextMenu", {
                                                            context: {tab:tab, editor:editorComponent},
                                                            groupDividers: true
                                                        });
                                                        contextMenu.registerOnCloseCallback(()=>{
                                                            if(contextMenu.html.parentNode != null) {
                                                                contextMenu.html.parentNode.removeChild(contextMenu.html);
                                                            }
                                                        });

                                                        //Find top component after html
                                                        let parent = tab.element[0];
                                                        while(parent.parentNode != null && !parent.parentNode.matches("html")) {
                                                            parent = parent.parentNode;
                                                        }
                                                        parent.appendChild(contextMenu.html);
                                                        contextMenu.open({
                                                            x: e.pageX,
                                                            y: e.pageY
                                                        });
                                                        e.stopPropagation();
                                                        e.preventDefault();
                                                    });

                                                    lastTooltop = editorComponent.tooltip;
                                                    lastTitle = editorComponent.title;
                                                }
                                            }

                                            state.fragment.registerOnFragmentChangedHandler(()=>{
                                                updateTab();
                                            });

                                            updateTab();
                                        },
                                        onDestroy: ()=>{
                                            editorComponent.destroy();
                                        }
                                    };
                                });

                                //Register innerHTML editor
                                await self.registerComponent("DomElementEditor", (state)=>{
                                    let element = state.element;

                                    let fragmentType = "text/html";
                                    let tabTitle = "Dom HTML";

                                    if(element.matches("style")) {
                                        fragmentType = "text/css";
                                        tabTitle = "Dom CSS";
                                    } else if(element.matches("script[type='text/javascript'], script:not([type])")) {
                                        fragmentType = "text/javascript";
                                        tabTitle = "Dom JS";
                                    }

                                    let fakeFragment = Fragment.create(fragmentType);
                                    fakeFragment.raw = element.innerHTML;

                                    fakeFragment.supportsAuto = ()=>{
                                        return false;
                                    };

                                    fakeFragment.supportsRun = ()=>{
                                        return false;
                                    };

                                    if(fragmentType === "text/css" || fragmentType === "text/javascript") {
                                        //Setup direct editing of style / script

                                    } else {
                                        fakeFragment.isInnerHtmlEditor = true;

                                        //Indirect editing with save button for the rest
                                        fakeFragment.save = ()=>{
                                            let test = document.createElement(element.tagName.toLowerCase());
                                            test.innerHTML = fakeFragment.raw;

                                            if(test.innerHTML != fakeFragment.raw) {
                                                if(!confirm("Your HTML does not parse correctly, the browser did some change, sure you want to save?")) {
                                                    return false;
                                                }
                                            }

                                            element.innerHTML = fakeFragment.raw;

                                            editorComponent.southArea.classList.remove("unsaved-changes");
                                        };
                                    }

                                    let observer = null;

                                    let removed = false;

                                    const options = {
                                        editorClass: MonacoEditor
                                    };

                                    if(state.editorClass) {
                                        options.editorClass = state.editorClass;
                                    }

                                    if(state.titleWrapper) {
                                        options.titleWrapper = state.titleWrapper;
                                    }

                                    let editorComponent = new Cauldron.CauldronEditor(fakeFragment, options);

                                    if(fragmentType === "text/css" || fragmentType === "text/javascript") {
                                        //Read back changes into dom
                                        fakeFragment.registerOnFragmentChangedHandler(()=>{
                                            if(!removed && element.parentNode != null) {
                                                observer.disconnect();
                                                if (element.firstChild instanceof Text) {
                                                    element.firstChild.nodeValue = fakeFragment.raw;
                                                } else {
                                                    element.textContent = fakeFragment.raw;
                                                }
                                                setTimeout(() => {
                                                    startObserver();
                                                }, 0);
                                            }
                                        });
                                    } else {
                                        //Setup direct editing of style / script
                                        let oldHandleModelChanged = editorComponent.editor.handleModelChanged;

                                        editorComponent.editor.handleModelChanged = function() {
                                            oldHandleModelChanged.bind(editorComponent.editor)();

                                            //Model changed, warn user
                                            editorComponent.southArea.classList.add("unsaved-changes");
                                        };

                                        editorComponent.html.addEventListener("keyup", (evt)=>{
                                            if(evt.key === "s" && evt.ctrlKey) {
                                                fakeFragment.save();
                                            }
                                        });
                                    }

                                    observer = new MutationObserver((mutations)=>{
                                        mutations.forEach((mutation)=>{
                                            Array.from(mutation.removedNodes).forEach((removedNode)=>{
                                                if(removedNode === element) {
                                                    fakeFragment.unload();
                                                    observer.disconnect();
                                                    removed = true;
                                                }
                                            });

                                            if(!removed) {
                                                if (fragmentType === "text/css" || fragmentType === "text/javascript") {
                                                    if (element.firstChild instanceof Text) {
                                                        fakeFragment.raw = element.innerHTML;
                                                    } else {
                                                        fakeFragment.raw = element.textContent;
                                                    }
                                                }
                                            }
                                        });
                                    });

                                    function startObserver() {
                                        observer.observe(element.parentNode, {
                                            childList: true,
                                            characterData: true,
                                            subtree: true
                                        });
                                    }

                                    startObserver();

                                    return {
                                        dom: editorComponent.html,
                                        serializer: {
                                            serialize: (state)=>{
                                                //Serialized needed state into string
                                                if(state.element != null && typeof state.element !== "string") {
                                                    state.element = state.element.tagName+":"+state.element.__wid;
                                                }
                                            },
                                            deserialize: (state)=>{
                                                //Deserialize state, and return true/false if success
                                                let split = state.element.split(":");
                                                state.element = Array.from(document.querySelectorAll(split[0])).find((elm)=>{
                                                    return elm.__wid === split[1];
                                                });

                                                return state.element != null;
                                            }
                                        },
                                        onTab: (tab)=>{
                                            tab.titleElement[0].innerText = tabTitle+": "+element.tagName.toLowerCase();
                                        },
                                        onShow: ()=>{
                                            //On show is called right before the container is actually shown?
                                            setTimeout(()=>{
                                                editorComponent.onSizeChanged();
                                            }, 0);
                                        },
                                        onDestroy: (container)=>{
                                            if(fragmentType === "text/css" || fragmentType === "text/javascript") {

                                            } else {
                                                if (editorComponent.southArea.classList.contains("unsaved-changes")) {
                                                    if (confirm("You have unsaved changes, save them now?")) {
                                                        fakeFragment.save();
                                                    }
                                                }
                                            }
                                        }
                                    };
                                });

                                //Register Inspector
                                await self.registerComponent("Inspector", (state)=>{
                                    return self.inspector.html;
                                });

                                //Register Console
                                await self.registerComponent("Console", (state)=>{
                                    return self.console.html;
                                });


                                function resizeGoldenLayout(){
                                    let bounds = {width: self.editorContentArea.offsetWidth, height:self.editorContentArea.offsetHeight};

                                    let topBarHeight = 0;
                                    if(self.topBar != null) {
                                        topBarHeight = self.topBar.offsetHeight;
                                    }
                                    self.goldenLayout.updateSize(bounds.width, bounds.height - topBarHeight);
                                }

                                window.addEventListener("resize", ()=>{
                                    resizeGoldenLayout();
                                });
                                let resizeObserver = new ResizeObserver((entries) => {
                                    resizeGoldenLayout();
                                });
                                resizeObserver.observe(self.docker.getComponentArea());

                                resolve();
                            });

                            await this.setupGoldenLayoutPromise;
                        }

                        hasComponent(componentName) {
                            return this.registeredComponentNames.has(componentName);
                        }

                        /**
                         * This callback is used to create components
                         * @callback Cauldron.Cauldron~creatorCallback
                         * @param {object} state - The state of the component
                         * @returns {Cauldron.Cauldron~creatorCallbackResult|Element}
                         */

                        /**
                         * This object is used to describe the serialize / deserialize of component state that cannot serialize correctly
                         * using only JSON stringify/parse.
                         * @typedef {object} Cauldron.Cauldron~serializer
                         * @property {Function} serialize
                         * @property {Function} deserialize
                         */

                        /**
                         * Represents the result of a component creator function
                         * @typedef {object} Cauldron.Cauldron~creatorCallbackResult
                         * @property {Element} dom - The dom element of the component
                         * @property {Cauldron.Cauldron~serializer} [serializer] - Serializer to use when state cannot serialize correctly using JSON stringify/parse
                         * @property {Cauldron.Cauldron~componentResizedCallback} [onResize] - Callback that is called when component is resized
                         * @property {Cauldron.Cauldron~tabCreatedCallback} [onTab] - Callback that is called when component has a tab created
                         * @property {Cauldron.Cauldron~componentDestroyCallback} [onDestroy] - Callback that is called when component is destroyed
                         * @property {Cauldron.Cauldron~componentShowCallback} [onShow] - Callback that is called when component is shown
                        */

                        /**
                         * @callback Cauldron.Cauldron~componentShowCallback
                         * @param {object} container - The Golden Layout container
                         */

                        /**
                         * @callback Cauldron.Cauldron~componentResizedCallback
                         * @param {object} container - The Golden Layout container
                         */

                        /**
                         * @callback Cauldron.Cauldron~componentDestroyCallback
                         * @param {object} container - The Golden Layout container
                         */

                        /**
                         * @callback Cauldron.Cauldron~tabCreatedCallback
                         * @param {object} tab - The tab that was created
                         * @param {object} container - The Golden Layout container
                         */

                        /**
                         * Register a component with Cauldron
                         *
                         * @example
                         * registerComponent("MyComponent", (state)=>{
                         *     let myComponentDom = document.createElement("div");
                         *     myComponentDom.textContent = state.someState;
                         *
                         *     return myComponentDom;
                         * });
                         *
                         * @example
                         * registerComponent("MyComponent", (state)=>{
                         *     let myComponentDom = document.createElement("div");
                         *     myComponentDom.textContent = state.someState;
                         *
                         *     return {
                         *         dom: myComponentDom,
                         *         onResize: ()=>{
                         *             //The component has been resized, do something
                         *         },
                         *         onTab: (tab)=>{
                         *             //The component has created a tab, do something to it
                         *         },
                         *         onShow: ()=>{
                         *             //Called when the component is made visible, ie. its tab is switched to
                         *         },
                         *         onDestroy: ()=>{
                         *             //Called when the component is destroyed
                         *         }
                         *     };
                         * });
                         *
                         * @example
                         * registerComponent("MyComponent", (state)=>{
                         *     let myComponentDom = document.createElement("div");
                         *     myComponentDom.textContent = state.someState;
                         *
                         *     return {
                         *         dom: myComponentDom,
                         *
                         *         //Setup serializer to handle state that cannot JSON stringify/parse correctly
                         *         serializer: {
                         *             serialize: (state)=>{
                         *                 //Serialize all state that cannot JSON stringify/parse correctly
                         *             },
                         *             deserialize: (state)=>{
                         *                 //Deserialize all state that cannot JSON stringify/parse correctly
                         *             }
                         *         }
                         *     };
                         * });
                         *
                         * @param {String} componentName - The name of the component
                         * @param {Cauldron.Cauldron~creatorCallback} creator
                         */
                        async registerComponent(componentName, creator) {
                            if(this.hasComponent(componentName)) {
                                //Already registered
                                return;
                            }

                            if(this.goldenLayout == null) {
                                await this.setupGoldenLayout(this.goldenLayoutArea);
                            }

                            this.registeredComponentNames.add(componentName);

                            await this.goldenLayout.registerComponent(componentName, function(container, state) {
                                try {
                                    let componentConfig = creator(state, container);

                                    if(componentConfig.serializer != null) {
                                        state.serializer = componentConfig.serializer;
                                        container.setState(state);
                                    }

                                    if(componentConfig instanceof Element) {
                                        container.getElement()[0].appendChild(componentConfig);
                                        componentConfig.glContainer = container;
                                    } else {
                                        container.getElement()[0].appendChild(componentConfig.dom);
                                        componentConfig.dom.glContainer = container;

                                        if(componentConfig.onResize != null) {
                                            container.on("resize", () => {
                                                componentConfig.onResize(container);
                                            });
                                        }

                                        if(componentConfig.onShow != null) {
                                            container.on("show", () => {
                                                componentConfig.onShow(container);
                                            });
                                        }

                                        if(componentConfig.onTab != null) {
                                            container.on("tab", (tab) => {
                                                componentConfig.onTab(tab, container);
                                            });
                                        }

                                        if(componentConfig.onDestroy != null) {
                                            container.on("destroy", () => {
                                                componentConfig.onDestroy(container);
                                            });
                                        }
                                    }
                                } catch(e) {
                                    console.error("Error creating component:", e);
                                    let errorDiv = document.createElement("div");
                                    errorDiv.innerHTML = "Something broke!";
                                    container.getElement()[0].appendChild(errorDiv);
                                    errorDiv.glContainer = container;
                                }
                            });
                        }

                        /**
                         * Create a component with the given name and state
                         *
                         * @example
                         * createComponent("MyComponent", {
                         *     someState: "ImportantStateData"
                         * });
                         *
                         * @param {String} componentName
                         * @param {object} [state]
                         * @param {boolean} [allowMultipleInstances=false] - Determines if multiple components with the same state are allowed, if set to true a new component will always be created. If false and a component with the same state already exists, then that component will be selected instead.
                         */
                        async createComponent(componentName, state = {}, allowMultipleInstances = false) {
                            if(!allowMultipleInstances) {
                                function compare(obj1, obj2) {
                                    //Check if these are equal
                                    if (Object.is(obj1, obj2)) {
                                        return true;
                                    }

                                    //Check if both are same type
                                    if (typeof obj1 !== typeof obj2) {
                                        return false;
                                    }

                                    //Since both were not equal, if one is null or undefined the other by definition is not
                                    if (obj1 == null || obj2 == null) {
                                        return false;
                                    }

                                    //Handle object
                                    if (typeof obj1 === "object") {

                                        //Only deep compare objects that are of constructor Object or Array
                                        if(obj1.constructor.name !== obj2.constructor.name) {
                                            return false;
                                        }

                                        if(obj1.constructor.name !== "Array" && obj1.constructor.name !== "Object") {
                                            //We already tested that constructor names are equal, and only want Array or Object
                                            return false;
                                        }

                                        for (let key in obj1) {
                                            if(obj1.hasOwnProperty(key)) {
                                                let obj1Value = obj1[key];
                                                let obj2Value = obj2[key];

                                                if (!compare(obj1Value, obj2Value)) {
                                                    return false;
                                                }
                                            }
                                        }

                                        for (let key in obj2) {
                                            if(obj2.hasOwnProperty(key)) {
                                                //Property existed in obj2 but not in obj1, everything else has already been tested
                                                if (typeof obj1[key] === "undefined") {
                                                    return false;
                                                }
                                            }
                                        }

                                        return true;
                                    }

                                    if(typeof obj1 === "function") {
                                        let equals = obj1.toString() === obj2.toString();

                                        return equals;
                                    }

                                    //Nothing else failed, equal i guess?

                                    return true;
                                }

                                //Check for already present editor
                                let foundComponents = this.goldenLayout.root.getItemsByFilter((item) => {
                                    if (item.componentName === componentName) {
                                        let componentState = item.container.getState();

                                        //Remove all our serializer stuff from state before comparing
                                        let compareClone1 = Object.assign({}, componentState, {
                                            componentName: null,
                                            deserializeSuccess: null,
                                            serializer: {},
                                            line: null,
                                            column: null
                                        });
                                        let compareClone2 = Object.assign({}, state, {
                                            componentName: null,
                                            deserializeSuccess: null,
                                            serializer: {},
                                            line: null,
                                            column: null
                                        });

                                        let equal = compare(compareClone1, compareClone2);

                                        return equal;
                                    }
                                });

                                if (foundComponents.length > 0) {
                                    //Attempt to update state
                                    foundComponents[0].config.componentState = Object.assign(foundComponents[0].config.componentState, state);

                                    //Select the already found component
                                    this.selectItem(foundComponents[0]);
                                    return;
                                }
                            }

                            this.goldenLayout.root.getItemsById("editors")[0].addChild({
                                type: "component",
                                componentName: componentName,
                                componentState: state
                            });
                        }

                        /**
                         * @private
                         */
                        setupDragAndDrop() {
                            function addAssetToDescriptor(descFrag, assetFileName) {
                                if(descFrag != null) {
                                    descFrag.require().then((descJson)=>{
                                        if(!descJson.assets.includes(assetFileName)) {
                                            descJson.assets.push(assetFileName);
                                            descFrag.raw = JSON.stringify(descJson, null, 2);
                                        }
                                    });
                                }
                            }
                            async function uploadFileAsset(file){
                                if (webstrate?.addAssetFromFile){
                                    await webstrate.addAssetFromFile(file);
                                } else {
                                    // Attempt a POST for servers that do not support upload through API
                                    await Uploader.upload(location.href, file, file.name);
                                }
                            }

                            EventSystem.registerEventCallback("TreeBrowser.TreeNode.Dropped", ({detail: { draggedNode: draggedNode, droppedNode: droppedNode, dropEffect: dropEffect, dragEvent: dragEvent}})=>{
                                if(draggedNode.type === "DomTreeNode" && droppedNode.type === "DomTreeNode") {
                                    if(dragEvent.altKey && dropEffect === "move") {
                                        //Move to before target
                                        droppedNode.context.parentNode.insertBefore(draggedNode.context, droppedNode.context);
                                    } else if(!droppedNode.context.matches("code-fragment")) {
                                        try {
                                            if(dropEffect === "move") {
                                                //Move inside target
                                                droppedNode.context.appendChild(draggedNode.context);
                                            } else if(dropEffect === "copy") {
                                                let clone = draggedNode.context.cloneNode(true);
                                                WPMv2.stripProtection(clone);
                                                droppedNode.context.appendChild(clone);
                                            }
                                            droppedNode.unfold();
                                        } catch(e) {
                                            //Hide errors
                                            console.error(e);
                                        }
                                    }
                                }

                                if(draggedNode.type === "AssetNode" && droppedNode.type === "DomTreeNode") {
                                    let descFrag = cQuery(droppedNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");

                                    addAssetToDescriptor(descFrag, draggedNode.context.fileName);
                                }

                                if(draggedNode.type === "AssetNode" && droppedNode.type === "AssetRootNode") {
                                    let parentNode = droppedNode.parentNode;
                                    if(parentNode != null && parentNode.type === "DomTreeNode" && parentNode.context.matches("wpm-package")) {

                                        let descFrag = cQuery(parentNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");

                                        addAssetToDescriptor(descFrag, draggedNode.context.fileName);
                                    }
                                }
                            });

                            EventSystem.registerEventCallback("TreeBrowser.DomFragment.Dropped", ({detail: { fragment: fragment, droppedNode: droppedNode, otherWebstrate: otherWebstrate}})=>{
                                if(droppedNode.type === "DomTreeNode") {
                                    let firstChild = fragment.firstChild;
                                    let descriptors = fragment.querySelectorAll("code-fragment[data-type='wpm/descriptor']");
                                    droppedNode.context.appendChild(fragment);
                                    if(otherWebstrate != null && otherWebstrate !== location.href) {
                                        //Let fragment stuff complete
                                        setTimeout(() => {
                                            descriptors.forEach((desc) => {
                                                let frag = Fragment.one(desc);
                                                frag.require().then((descJson) => {
                                                    descJson.assets.forEach((asset) => {
                                                        fetch(otherWebstrate + asset).then((response) => {
                                                            response.blob().then((blob) => {
                                                                Uploader.upload(location.href, blob, asset).then(() => {
                                                                    frag.triggerFragmentChanged(frag);
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        }, 0);
                                    }

                                    setTimeout(()=>{
                                        //unfold the node we dropped into
                                        TreeBrowser.findAllTreeBrowsers().forEach((tb)=>{
                                            tb.findTreeNodeForContext(firstChild.parentNode).forEach((treeNode)=>{
                                                treeNode.unfold();
                                            });
                                        });
                                    }, 0);
                                }
                            });

                            EventSystem.registerEventCallback("TreeBrowser.Asset.Dropped", async ({detail: { assetUrl: assetUrl, droppedNode: droppedNode}})=>{
                                let assetName = assetUrl.substring(assetUrl.lastIndexOf("/")+1);

                                if(droppedNode.type === "AssetNode" || droppedNode.type === "AssetRootNode" || droppedNode) {
                                    let parentNode = droppedNode.parentNode;

                                    fetch(assetUrl).then((response)=>{
                                        response.blob().then((blob)=>{
                                            Uploader.upload(location.href, blob, assetName).then(()=>{
                                                if(parentNode != null && parentNode.type === "DomTreeNode" && parentNode.context.matches("wpm-package")) {

                                                    let descFrag = cQuery(parentNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                                    addAssetToDescriptor(descFrag, assetName);
                                                }
                                            });
                                        });
                                    });
                                }

                                if(droppedNode.type === "DomTreeNode" && droppedNode.context.matches("wpm-package")) {
                                    let descFrag = cQuery(droppedNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                    if(descFrag != null) {
                                        fetch(assetUrl).then((response)=> {
                                            response.blob().then((blob) => {
                                                Uploader.upload(location.href, blob, assetName).then(() => {
                                                    addAssetToDescriptor(descFrag, assetName);
                                                });
                                            });
                                        });
                                    }
                                }
                            });

                            EventSystem.registerEventCallback("TreeBrowser.Files.Dropped", async ({detail: { files: files, droppedNode: droppedNode}})=>{
                                if(droppedNode.type === "AssetNode" || droppedNode.type === "AssetRootNode") {
                                    let parentNode = droppedNode.parentNode;
                                    for(let file of Array.from(files)) {
                                        await uploadFileAsset(file);

                                        // Drop on an asset in a WPMv2 package
                                        if(parentNode != null && parentNode.type === "DomTreeNode" && parentNode.context.matches("wpm-package")) {
                                            let descFrag = cQuery(parentNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                            addAssetToDescriptor(descFrag, file.name);
                                        }
                                    }
                                } else if(droppedNode.type === "DomTreeNode" && droppedNode.context.matches("wpm-package")) {
                                    // Drop into a WPMv2 package
                                    let descFrag = cQuery(droppedNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                    if(descFrag != null) {
                                        for(let file of Array.from(files)) {
                                            await uploadFileAsset(file);
                                            addAssetToDescriptor(descFrag, file.name);
                                        }
                                    }
                                }
                            });

                            EventSystem.registerEventCallback("TreeBrowser.TreeNode.DragOver", ({detail: {node: node, dragEvent: evt}})=>{

                                let defaultDropEffect = false;
                                let handled = false;

                                if(node.type === "DomTreeNode") {
                                    if(evt.dataTransfer.types.includes("Files")) {
                                        if(node.context.matches("wpm-package")) {
                                            let descFrag = cQuery(node.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                            if(descFrag != null) {
                                                evt.dataTransfer.dropEffect = "copy";
                                                handled = true;
                                            }
                                        }
                                    } else if(evt.dataTransfer.types.includes("treenode/uuid")){
                                        let dragUUID = null;

                                        evt.dataTransfer.types.forEach((type)=>{
                                            if(type.indexOf("treenodedata/uuid") !== -1) {
                                                dragUUID = type.split("|")[1];
                                            }
                                        });


                                        let dragged = document.querySelector("[transient-drag-id='" + dragUUID + "']");
                                        if (dragged != null && dragged.treeNode != null) {
                                            handled = true;
                                            if(dragged.treeNode.type === "DomTreeNode" ) {
                                                if(evt.altKey) {
                                                    //We are insertingBefore, not appending, only non allowed action is wpm-package inside wpm-package?
                                                    let draggedIsWpmPackage = dragged.treeNode.context.matches("wpm-package") || dragged.treeNode.context.querySelector("wpm-package") != null;
                                                    let droppedIsInsideWpmPackage = !node.context.matches("wpm-package") && node.context.closest("wpm-package") != null;

                                                    let droppedIsBody = node.context.matches("body");

                                                    if(!droppedIsBody && (!droppedIsInsideWpmPackage || !draggedIsWpmPackage)) {
                                                        defaultDropEffect = true;
                                                    }
                                                } else {
                                                    // Normal dragging
                                                    if (node.context.matches("script, style, code-fragment")){
                                                        // Certain targets themselves don't accept any DOM node being dragged onto them, so ignore them
                                                    } else if ((node.context.matches("wpm-package") || node.context.closest("wpm-package")!=null) && (dragged.treeNode.context.matches("wpm-package")||dragged.treeNode.context.querySelector("wpm-package")!=null)){
                                                        // Also we cannot drop something containing WPM packages into a WPM package, so it is ignored
                                                    } else if(dragged.treeNode.context.contains(node.context)) {
                                                        // You cannot drag something into part of itself, ignore it
                                                    } else {
                                                        // All other moves are fair game
                                                        defaultDropEffect = true;
                                                    }
                                                }

                                            } else if(dragged.treeNode.type === "AssetNode") {
                                                if(node.context.matches("wpm-package")) {
                                                    let descFrag = cQuery(node.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                                    if(descFrag != null) {
                                                        evt.dataTransfer.dropEffect = "copy";
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    if(!handled && evt.dataTransfer.types.includes("text/plain")) {
                                        if(!node.context.matches("code-fragment")) {
                                            defaultDropEffect = true;
                                        }
                                    }
                                } else if(node.type === "AssetRootNode") {
                                    if(evt.dataTransfer.types.includes("Files") || evt.dataTransfer.types.includes("treenode/asset")) {
                                        evt.dataTransfer.dropEffect = "copy";
                                    }
                                }

                                if(defaultDropEffect) {
                                    if(evt.ctrlKey) {
                                        evt.dataTransfer.dropEffect = "copy";
                                    } else {
                                        evt.dataTransfer.dropEffect = "move";
                                    }
                                }
                            });
                        }
                    }

                    window.Cauldron.Cauldron = CauldronBase;

                    </SCRIPT><STYLE id="main-style">
                    /**
                     *  Base Cauldron Styles
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/
                    @keyframes cauldron-logo-appears {
                      0% {
                        transform: scale(0) translateY(-5%) scaleX(6);
                        opacity: 0; }
                      100% {
                        transform: scale(0.5) translateY(-5%);
                        opacity: 0.08; } }

                    @keyframes cauldron-content-appears {
                      0% {
                        opacity: 0; }
                      100% {
                        opacity: 1; } }

                    .cauldron-navigator {
                      overflow-y: auto;
                      height: 100%;
                      overflow-x: hidden; }

                    .cauldron-base-top {
                      background: #8484840f;
                      border-bottom: 1px solid rgba(100, 100, 100, 0.1);
                      display: flex;
                      flex-direction: row-reverse;
                      justify-content: space-between;
                      flex: 0 0 auto; }

                    .cauldron-base-content {
                      display: flex;
                      flex-direction: column;
                      width: 100%;
                      height: 100%;
                      position: absolute;
                      top: 0;
                      left: 0;
                      overflow: hidden;
                      background: var(--mdc-theme-background, #FFFFFF);
                      color: var(--mdc-theme-text-primary-on-background, black);
                      font-family: sans-serif; }
                      .cauldron-base-content .cauldron-layout {
                        flex: 1 1 auto; }
                        .cauldron-base-content .cauldron-layout .lm_goldenlayout {
                          background: none; }
                        .cauldron-base-content .cauldron-layout .lm_title {
                          height: 100%;
                          margin-bottom: -5px; }
                          .cauldron-base-content .cauldron-layout .lm_title .cauldron-editor-tab-icon {
                            width: 1em;
                            height: 100%;
                            vertical-align: text-bottom;
                            padding-right: 0.3em; }
                        .cauldron-base-content .cauldron-layout .lm_tab {
                          margin-right: 1px;
                          padding-left: 0.3em;
                          padding-right: 20px;
                          display: flex; }
                        .cauldron-base-content .cauldron-layout .lm_content {
                          animation: 0.15s cauldron-content-appears ease-in; }
                        .cauldron-base-content .cauldron-layout .lm_items:empty {
                          position: relative; }
                          .cauldron-base-content .cauldron-layout .lm_items:empty:after {
                            position: absolute;
                            left: 0;
                            top: 0;
                            bottom: 0;
                            right: 0;
                            content: "";
                            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKAAQMAAAA2A1tgAAAABlBMVEUAAAAAAAClZ7nPAAAAAXRSTlMAQObYZgAADihJREFUeNrsnDGO3SAURT1x4dJL8DbSeWORzNJYCl1a0lEgiCKPfSBEjs17UlLYzfz/mX8E3AtcsGeG41r8oHstOWoDc9AGZqsNzOpArw3M6kCvDczqQKcMVHX3TrSaRG3njL+ASd3cdlBudNAEzrRZsYpWu4peu4pRfZ41g7IXnWoVN+21ZdY2zgedqNdmp93mMCjrnAbtNquHEqsKnHL22saJ2p2Y1DvRaHei0+5Er9BOV3Zi1Og4W7xOKkqUnWg0gL4YzlZ3MUFmEZAqrjmoADNvogaQhk6wZy8BRqxtzu60AmCJkU49c5Vf1+zOxmdJfo1nfQNA173c0eb5QM+SCLpRmzEnujYK5sEcTy1Ke0qqeL60AI0kvzpkLvzee6HAkj1ALxl/6ejPADCI8qv5fBXxUhBldvcpcwIYNQ5bcj6tlJNoSY6Hb8wJzLJ9Cqvg3quyjLweE9ecnQaQLDftPz/Y5guz3PipDkBBltvJEaDTyHKf4A2gMMttWQVIllt1akiWWyJAQVwky81hr6gQSJabvAqQLDc6JeCQP8eI1QGS5YxM5cU3CVsIzBZVdIBtlmNykG1qqZEQGE9VPCORCbZnF0CWw5UCIJkw/QbsjcTpgEBgGZUcl9JGFvo+YCDL8XEn8IO2IbMoLI20eQYhmRuWzJocZSOPRscisktWUZpXRC9JcKAXLTJLBgod5onsCmluzmcQ9sKBQo8R2XcywM42WyI7A0XSZn9EdnwdRGtywDcaQeTosDWb1tcfpj8dLtm2vl5CV7CxRWSfKuCW+tPhdHCbk43nxgm7OoajEhTzPRNE2muKaxLdEXucuKMSrokIlvvT4TdcE5jdHnciOeQrrvHloUmPKp7qAvyk+/4Uhg0d9OfDmhyCDW1Bj12qNCd2sqlxJ2DDXL/pUcXysqjU1gtckLK6a597gOQQbBgQuQtIDqltOAGcHvmb9QQbYqGMVZ/I/CcbrgDv31bjCKi14Qbw6SSx1pWqRE6fWrlnMrvShpXI8RMYnsnsWxtOAMdnY5ojIGyIyOETmJ75JpY2rET2x+fPfJNKG1Yi2y7glo9WAsz7ZQ6geeYbgw1tKXJm/9GxuV+POiFyAthhRCZAHkA6ga7DiGedEDkAfG7Ej7NOiMwpqn9oxON7eByFngOHHE8dfCWy6QRuARuWAy/3rvirx4aVyL3AxWJDRKZDHwNngw3Lged7gRM2rER2vU3+8psNJ1zTB8QpoRZZAMSGaJIkQGzIwIsSIDZEkyABYkM08RIgNkQTKwBiQzTJBrmeAmsbZlwDsNuGaJIkQGyIJlEGxIYLrqHI9/naogmMuQdI2EQTKwKuVVCA3gkkbGLrTOW7gZG67nTBXXZ03XBNN5C9PLbGeetTIEo4bL3TpUCLrXcEQNs1UFhNS8T2FIhX6MKdLgWmsguz5B4QR6V0YaqBpgcYyi6MEiD3FOjCUFv0GQ6v0YUe4PPjFpRcc2PDUQKkxcg6Pj9hwhq0GBWmfqBBY1RgjeoAjvAAzo+BnF8v8FIN9F3AAI9OE8yv1RW0gX4QTYdjidr+ADQCoFnrNm5CYOI2bOGooR8YeHwOYBIA3Q5ELynQDmsLjB2BmBGyUqXeyF5P1CtVkkR25tUNIEO5G2h2YADYd3+YOWEHeunfUpUriWgoM76Y+KUjr9nQykceOdgdAlnRQAF4IoxkoLBNCQBFA6XeSI3yRZTVHKBgoEBxJzv1LlFcUADi6yfDlzNS1wJbX0/MStdAbiTN+IS0+RjIBZBwqAREfTkw1NFLBlz4dfbKGkBEdkpAorISENfoAHGNELjy6zynpgFkC6gEZAuoCGSTJgfyO0YPOOEaMRCRkw4QTaIikB2LFBjL4yY1IKdDcmAq/+WDHnCjXDrbZLow6AANfzymA7RnCLU6QH9+1QiBTKobxQrA/IMvagC5vBw4VUCrDRxkQPxMqQhIAd/TBToF4FACjQZwq7tQDlwBBhXgAtCpAGeAgwoQZ0cdIM52OkCMaBSAzV0pORCZnQ4QmQcVIEVBCch6pwck/MuBlFk1IH/wKgdC9IMOkOsFvsAX+AJf4At8gf8QuOagB2zu5rXhyTwELvlvAekZcLzqUBD3getFrOaRzvvAMV8Ef8ruA9kv2raClN0GjvliN1aU3Qaumcu0ElPFm8CPq4OaLXPFm8D66Ofq0MXcAvIw42/OQS77+dPfAo61e9LFU3/pFpC78Lysz/7oTHsHSHlzN/mjeRL9BnDCLFSxfOvKNzeAK8VUsXiXqnff/wrEzahqedM88nALGH/zXarmQSS/Cax13bhZ33xzvQlM7eQSzvqYZthcA9vhy+ftF7d7QFMVLBdnsPMtYGwLrsuuge06srYVpOwOsD37uj7TvQa2RdcrzA2ga4su1sD170A+QmjV0zn85hTjHH6XAmm1+e8C5wt8gS/wBb7AF/iTfTvIgRqEwgD8CAt2snXHTeRKLl0YIXHhMbwKxgN4BbwBS4yE39JOhToulIeJi85mAn18Ydo+mLy0N3iDN/gHoAqLQZMWgzYvBl1ZDKL+9yAWg241aFeDBn4l+Ir0UlCA1ACayAXlFXSZCypsZuhgXQ2CBdrYQLEORPoVtPAMUCKTvoKGBaoDpH8JahaoG1iXgoXMFTSgBaBbBcpnsDVfTYP0DNq9KfIkaMtDGHsIUVYGWC6gKySQFCZB8wQik2yg54H+kt0NDItAsYEaUTJAdwElIhmEeTD/BrTw60C1Sa6BkQViSMZAAHFAXEADL1CXgi3BF4IWG5A5oGhgHbdlzQHtDooBLGSQNjAsAlHIInJA2cDSQzI5BC4oBzAR4DfEs8DcMy8JJqg2UOU+OEqgfRMLTEPmqXZcc8BKegTNDtZpUKOSiUMqWxQmiAG0INdGmjILJvMFZEPflQW44Ad4F3oqSyC1mU+CLtkP+ATfU1ntoEvzoAQw7MrmGyKRi9Og+wV0XxuIefCdHDvwDZ8QSCBMg1UApYNAwyT8NFjEGApUuYM0C34rBKQhIrfZqToNfs/khisAxAbqMg0ik0UYQN9Ak+fBRAaX+kgDbeKAOg/tvIMuzoPxEmL3DU8gzIPhEvKCGqjg2eAYFU2lWdDCP0dlFAb426g8D1Z6+rBeNza/AR3g58HyO7DSNKjTM2iQ50EZn0GFuLiO/e7/K4zf4A3e4A3e4A3e4A3+FejiYhB5LSieH4CtLFA+Ot8MwZ43w7q7/ZBE4INjUU4hckBqndYPoEZiga4SISiEDmYWaBsYL2BhgaaSQJQLwUKygbGDlQ+GAZR8UCGIDhLAAm0mDT+CdjVo4Dmgy5tAI6iZYCJ7BRUCF6wD+JIkD0QiN4Jv2WAklKEQueMMUDQwd1BWIiYYxAiqSuQY4JF2aQDRrhML9AfoO2g5oIJXiGtBvQg08QHoozrcQTMHHvPQIPME5inQ5R2sZOGvoJ4DUR5bihvr1wqeCRYCaCFoH+DeoMwBXT1A0UC9g7LOga+JqK2CO5slKj0MfYDqL0FZ9594ggr1vFMMpkAD3+ZicKyvGvW8KS1IIvw1aBHIdNDsYNynOwe6A9Q41leLQuQeoJ8Gy0/QfSzns0uYB20hdYABpoH+AINEnDiHHZT4VDdQsEDTwHyCn8sGShADVBvofoJf8gaq82REifTXoBxABaR2gcoRNweKDUQi+QCjKT+X1CVgMJVs6mAmlVigN9ig85/TJCg2QdZjDBm8R+hgIf3XoO9gGw/ArwPzDg7PZ1TS8a9BeYISqYHlApq/BGUDwwmGNi4PIMj+PaiaU/Yj+7iHQKaBngPS29ZGOMHyo727x40bBqIAPAILlToCj8KbhQJSpMyVCOQAOULYpWWqCAjBl3W22NjgDjUz9E8Qv1bGZ0vzRoS3WQfkmKTg9eSot6v0NwjIwe12FF0S6xNwl4HrU9Df/hOt7pcK9Lfj/FG25g4ApANLH4xysFEA3QNLQNOBvgOuf8AqBLdG8QHMHRCueBw6MNwBNxQ5iAcw9cC1rMhSsC73QHcB5R+m+SsY9x74qdAHEoOOBUkJgrpg1oDrT9DSOuCCzwowHOt37K4PflWB25cLWLvgNxXoL+B6dEGowPARaSvUCZBUoEMO88BYokNBngi2BUCaB/6oC4Cd+VpvIYhKAGgieBDQumAAacBCEXUmmCni6IJeByYKyH2wKUGP1AW3qgJ3WkHdrIcKJKJM/RQFGBox0YDHZNCXyeCWJ4NuN4P0CCT6j0DowDIL3N7BDriLQP8vgxHXpNcFA67JLwhmERhfASwiEPfB8Fzgofp2xPSCYJWAjgH9c4FNcwJgvw9CAm4vAvLX+PgzYFK8G0AMmCeBqwaMZ8CiWOXGgYdi8xpX+ipfFB5sikWpHAhBrzlwgbzZ/hyY5DU8GFBSxMiBBHlvwHYX4t4sPBjFvVlPghC3BpkBBWP2PBjYy4o/IUjHvIAHvXTM7gbuPAjpTLAPrifZ4gE0AItsT4BBTVGFj7Ax4Pk32DYCHSBqYhzd0QLRPTtIQOzn9o7fBDA/wv/6MgTHVfQnwPhIHI54PMMAZeaDiXkssvCd2N4OyBxiqjTqx70ZsDLbJA2/p1qw3APjWwEze4zZN8++ezvR3FUhmrsqjT137KC92XUqyB9ohl73E829tjebP3G9ttdzm000t9mNARddDZnoasgk2mto703iQG9vjb03xGU1t8bem0pszEO29ybzoLe2xj5m4uOMQ7aP+aBBjEO2b3MagZtpk+3L12iUxTQT+66UMegtM7FPhcZxhneXvdrlDBj0j9DeRDqTRd1CexMzo6iKQ+eyKErDJ+ru2H7PdDqqVttfEDudj6KE9qdIogTLGvPVsVXGnt8ubwuXPBpAmwAAAABJRU5ErkJggg==");
                            background-position: center;
                            background-size: contain;
                            background-repeat: no-repeat;
                            transform: scale(0.5) translateY(-5%);
                            opacity: 0.08;
                            box-sizing: border-box;
                            animation: 0.25s cauldron-logo-appears ease-in; }

                    /** Material STUBS **/
                    .cauldron-themeable {
                      /** Size resets */
                      --mdc-theme-primary: #3741bc;
                      --mdc-typography-subtitle1-font-size: 11pt;
                      --mdc-typography-subtitle1-line-height: 1.5em;
                      --mdc-typography-subtitle2-font-size: 0.875em;
                      --mdc-typography-caption-font-size: 0.75em;
                      --mdc-typography-caption-line-height: 1.25em;
                      --mdc-typography-body1-font-size: 1em;
                      --mdc-typography-body2-font-size: 0.875em;
                      --mdc-typography-headline6-font-size: 1.25em;
                      --mdc-typography-button-font-size: 0.875em;
                      font-size: 10pt;
                      /** Mixin fixes for mixins that drop live customizability **/ }
                      .cauldron-themeable .mdc-list {
                        line-height: var(--mdc-typography-subtitle1-line-height, 1.5em); }
                      .cauldron-themeable .mdc-menu .mdc-list, .cauldron-themeable .mdc-dialog .mdc-dialog__content, .cauldron-themeable .mdc-menu .mdc-list-item__graphic, .cauldron-themeable .mdc-data-table__header-cell, .cauldron-themeable .mdc-menu .mdc-list-item__meta,
                      .cauldron-themeable .mdc-data-table__pagination-total, .cauldron-themeable .mdc-data-table__pagination-rows-per-page-label, .cauldron-themeable .mdc-data-table__cell,
                      .cauldron-themeable .mdc-tab:not(.mdc-tab--active) .mdc-tab__icon, .cauldron-themeable .mdc-tab:not(.mdc-tab--active) .mdc-tab__text-label,
                      .cauldron-themeable .mdc-dialog .mdc-dialog__title {
                        color: var(--mdc-theme-text-primary-on-background); }
                      .cauldron-themeable .mdc-radio .mdc-radio__native-control:enabled:not(:checked) + .mdc-radio__background .mdc-radio__outer-circle {
                        border-color: var(--mdc-theme-text-secondary-on-background); }
                      .cauldron-themeable .mdc-text-field:not(.mdc-text-field--disabled) + .mdc-text-field-helper-line .mdc-text-field-helper-text {
                        color: var(--mdc-theme-secondary); }
                      .cauldron-themeable .cauldron-editor-component-toolbar .mdc-list-item__graphic {
                        margin-right: 0; }
                    </STYLE><STYLE id="theme_dark-style">
                    .cauldron-themeable[cauldron-theme="dark"] {
                      --mdc-theme-primary: #3ea2ff;
                      --mdc-theme-secondary: #0fa5ff;
                      --mdc-theme-background: rgb(24, 24, 24);
                      --mdc-theme-surface: rgb(38, 40, 56);
                      --mdc-theme-error: #b00020;
                      --mdc-theme-on-primary: #fff;
                      --mdc-theme-on-secondary: #fff;
                      --mdc-theme-on-surface: rgb(230, 234, 255);
                      --mdc-theme-on-error: #fff;
                      --mdc-theme-text-primary-on-background: rgba(255, 255, 255, 0.973);
                      --mdc-theme-text-secondary-on-background: rgba(106, 197, 255, 0.54);
                      --mdc-theme-text-hint-on-background: rgba(0, 0, 0, 0.38);
                      --mdc-theme-text-disabled-on-background: rgba(0, 0, 0, 0.38);
                      --mdc-theme-text-icon-on-background: rgba(218, 234, 255, 0.61);
                      --mdc-theme-text-primary-on-light: rgba(0, 0, 0, 0.87);
                      --mdc-theme-text-secondary-on-light: rgba(0, 0, 0, 0.54);
                      --mdc-theme-text-hint-on-light: rgba(0, 0, 0, 0.38);
                      --mdc-theme-text-disabled-on-light: rgba(0, 0, 0, 0.38);
                      --mdc-theme-text-icon-on-light: rgba(0, 0, 0, 0.38);
                      --mdc-theme-text-primary-on-dark: white;
                      --mdc-theme-text-secondary-on-dark: rgba(255, 255, 255, 0.7);
                      --mdc-theme-text-hint-on-dark: rgba(255, 255, 255, 0.5);
                      --mdc-theme-text-disabled-on-dark: rgba(255, 255, 255, 0.5);
                      --mdc-theme-text-icon-on-dark: rgba(255, 255, 255, 0.5);
                      /** Menu highlights **/
                      /** Golden layout **/ }
                      .cauldron-themeable[cauldron-theme="dark"] :not(.mdc-list-item--disabled).mdc-list-item .mdc-list-item__ripple::before,
                      .cauldron-themeable[cauldron-theme="dark"] :not(.mdc-list-item--disabled).mdc-list-item .mdc-list-item__ripple::after {
                        background-color: #fff; }
                      .cauldron-themeable[cauldron-theme="dark"] .cauldron-layout .lm_items:empty::after,
                      .cauldron-themeable[cauldron-theme="dark"] .lm_header .lm_tab .lm_close_tab,
                      .cauldron-themeable[cauldron-theme="dark"] .lm_controls {
                        filter: invert(1); }
                      .cauldron-themeable[cauldron-theme="dark"] .lm_content {
                        border-color: #3c4347; }
                    </STYLE></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="NewWebstrateActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "New Webstrate",
                        "description": "Actions that can create new Webstrates",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem",
                            "#CauldronBase"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="new-webstrate-actions-script" type="disabled">
                    /**
                     *  Webstrate Actions
                     *  Ways of copying and manipulating a webstrate into a new one through the menu
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    if (typeof webstrate !== "undefined"){
                        let newMenu = MenuSystem.MenuManager.createMenu("Cauldron.File.NewWebstrate");

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                            label: "New...",
                            group: "FileDirect",
                            groupOrder: -1,
                            order: -1,
                            onOpen: (menu)=>{
                                return newMenu.menuItems && newMenu.menuItems.length>0;
                            },
                            icon: IconRegistry.createIcon("mdc:note_add"),
                            submenu: newMenu
                        });

                        // New copy from this one
                        if (webstrate.copy){
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.File.NewWebstrate", {
                                label: "Copy",
                                tooltip: "A new copy of this webstrate without history",
                                icon: IconRegistry.createIcon("mdc:file_copy"),
                                onAction: ()=>{
                                    webstrate.copy();
                                }
                            });
                        }
                        if (webstrate.clone){
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.File.NewWebstrate", {
                                label: "Clone With History",
                                tooltip: "A new clone of this webstrate with history",
                                icon: IconRegistry.createIcon("mdc:file_copy"),
                                onAction: ()=>{
                                    webstrate.clone();
                                }
                            });
                        }



                        // New from prototype url
                        if (webstrate.newFromPrototypeURL){
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.File.NewWebstrate", {
                                label: "From URL...",
                                icon: IconRegistry.createIcon("mdc:link"),
                                onAction: ()=>{
                                    let url = prompt("Prototype URL:");
                                    if(url && url.trim().length > 0) {
                                        webstrate.newFromPrototypeURL(url,"urlprototype-"+(Math.random().toString(16).substr(2,8)));
                                    }
                                }
                            });
                        }

                        // New from prototype zip
                        if (webstrate.newFromPrototypeFile || webstrate.importFromZip){
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.File.NewWebstrate", {
                                label: "From Zip-Archive...",
                                tooltip: "Import from archive with assets",
                                icon: IconRegistry.createIcon("mdc:unarchive"),
                                onAction: async ()=>{
                                    if (webstrate.importFromZip){
                                        webstrate.importFromZip();
                                    } else if (webstrate.newFromPrototypeFile){
                                        let id = "fileprototype-"+(Math.random().toString(16).substr(2,8));
                                        await webstrate.newFromPrototypeFile(id);
                                        window.open("/"+id, '_blank').focus();
                                    }
                                }
                            });
                        }
                        if (webstrate.loadFromZip){
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.File.NewWebstrate", {
                                label: "From Native Binary Archive...",
                                tooltip: "Load from archive with history",
                                icon: IconRegistry.createIcon("mdc:unarchive"),
                                onAction: ()=>{
                                    webstrate.loadFromZip();
                                }
                            });
                        }
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="DocumentActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Document Actions",
                        "description": "Actions that change the webstrate itself",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem",
                            "#CauldronBase"
                        ],
                        "optionalDependencies": [
                            "webstrate-components-repos #WPMPackageBrowser",
                            "webstrate-components-repos #PermissionManager",
                            "webstrate-components-repos #RevisionBrowser",
                            "webstrate-components-repos #HeadEditorComponent"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="document-actions-script" type="disabled">
                    /**
                     *  Document Actions
                     *  Menu entries related to the Webstrate Document
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Copyright 2024 Janus B. Kristensen
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    if (webstrate?.tags){
                        // Show revisions if webstrate supports tagging
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                            label: "Revisions...",
                            group: "FileMeta",
                            groupOrder: 0,
                            icon: IconRegistry.createIcon("mdc:restore"),
                            order: 0,
                            onAction: async (menuItem)=>{
                                await wpm.require("RevisionBrowser");
                                let revisionBrowser = new RevisionBrowser();
                                let dialog = new WebstrateComponents.ModalDialog(revisionBrowser.html, {maximize: true});
                                menuItem.menu.context.cauldron.getPopupParent().appendChild(dialog.html);
                                dialog.open();

                                EventSystem.registerEventCallback("RevisionBrowser.OnRestore", (evt)=>{
                                    if(evt.detail === revisionBrowser) {
                                        dialog.close();
                                    }
                                });
                            }
                        });
                    }

                    if (webstrate?.permissions){
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                            label: "Permissions...",
                            group: "FileMeta",
                            groupOrder: 0,
                            icon: IconRegistry.createIcon("mdc:admin_panel_settings"),
                            order: 0,
                            onAction: async (menuItem)=>{
                                await wpm.require("PermissionManager");
                                let parent = menuItem.menu.context.cauldron.getPopupParent();
                                let pmui = new WebstrateComponents.PermissionManagerUI();
                                pmui.setTopLevelComponent(parent);
                                let dialog = new WebstrateComponents.ModalDialog(pmui.html);
                                parent.appendChild(dialog.html);
                                dialog.open();

                                EventSystem.registerEventCallback("PermissionManagerUI.Saved", (evt)=>{
                                    if(evt.detail === pmui) {
                                        dialog.close();
                                    }
                                });
                            }
                        });
                    }

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                        label: "Properties...",
                        group: "FileMeta",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:build_circle"),
                        order: 0,
                        onAction: async (menuItem)=>{
                            await wpm.require("HeadEditorComponent");
                            let headEditor = new HeadEditorComponent(false);
                            let dialog = new WebstrateComponents.ModalDialog(headEditor.html, {
                                title: "File Properties",
                                actions: {
                                    "Close":{primary:true}
                                }
                            });
                            menuItem.menu.context.cauldron.getPopupParent().appendChild(dialog.html);
                            dialog.open();

                            EventSystem.registerEventCallback("HeadEditorComponent.OnClose", (evt)=>{
                                if(evt.detail === headEditor) {
                                    dialog.close();
                                }
                            });
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                        label: "Packages...",
                        group: "FileMeta",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:extension"),
                        order: 0,
                        onAction: async (menuItem)=>{
                            await wpm.require("WPMPackageBrowser");
                            let parent = menuItem.menu.context.cauldron.getPopupParent();
                            let packageBrowser = new WPMPackageBrowser(false);
                            packageBrowser.setTopLevelComponent(parent);
                            let dialog = new WebstrateComponents.ModalDialog(packageBrowser.html, {flexContent: true});
                            parent.appendChild(dialog.html);
                            dialog.open();

                            EventSystem.registerEventCallback("WPMPackageBrowser.OnClose", (evt)=>{
                                if(evt.detail === packageBrowser) {
                                    dialog.close();
                                }
                            });
                        }
                    });


                    // Download as archive
                    if (webstrate?.exportToZip){
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File.Export", {
                            label: "As Zip-Archive...",
                            tooltip: "Flat format including assets",
                            icon: IconRegistry.createIcon("mdc:archive"),
                            onAction: ()=>{
                                webstrate.exportToZip();
                            }
                        });
                    } else if (typeof webstrate !== "undefined"){
                        // Assume old-school HTTP API
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File.Export", {
                            label: "As Zip-Archive...",
                            tooltip: "Flat format including assets",
                            icon: IconRegistry.createIcon("mdc:archive"),
                            onAction: ()=>{
                                window.location = location.href + "?dl";
                            }
                        });
                    }
                    if (webstrate?.saveToZip){
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File.Export", {
                            label: "As Native Binary Archive...",
                            tooltip: "Binary format including history",
                            icon: IconRegistry.createIcon("mdc:archive"),
                            onAction: ()=>{
                                webstrate.saveToZip();
                            }
                        });
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronEditorViewActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Editor View Actions",
                        "description": "Actions that change Cauldron",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem",
                            "#CauldronBase"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="cauldron-editor-view-actions-script" type="disabled">
                    /**
                     *  View Actions
                     *  Control the Cauldron docking mode
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    {
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.File", {
                            label: "Close",
                            group: "Cauldron",
                            icon: IconRegistry.createIcon("mdc:close"),
                            order: 9000,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Minimize");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Settings", {
                            label: "Word-wrap",
                            icon: IconRegistry.createIcon("mdc:wrap_text"),
                            order: 0,
                            checked: ()=>Cauldron.CauldronSettings.getWordwrap(),
                            onAction: (menuItem)=>{
                                //Toggle word wrap in all open and future editors
                                Cauldron.CauldronSettings.setWordwrap(!Cauldron.CauldronSettings.getWordwrap());
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.MainActions", {
                            icon: IconRegistry.createIcon("mdc:close"),
                            order: 9000,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Minimize");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock",{
                            label: "Left",
                            icon: IconRegistry.createIcon("mdc:vertical_split"),
                            order: 0,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Dock", {
                                    pos: EdgeDocker.MODE.LEFT
                                });
                            }
                        });
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock",{
                            label: "Right",
                            icon: IconRegistry.createIcon("mdc:vertical_split"),
                            order: 0,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Dock", {
                                    pos: EdgeDocker.MODE.RIGHT
                                });
                            }
                        });
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock",{
                            label: "Bottom",
                            icon: IconRegistry.createIcon("mdc:horizontal_split"),
                            order: 0,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Dock", {
                                    pos: EdgeDocker.MODE.BOTTOM
                                });
                            }
                        });
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock",{
                            label: "Float",
                            icon: IconRegistry.createIcon("mdc:featured_video"),
                            order: 0,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Dock", {
                                    pos: EdgeDocker.MODE.FLOAT
                                });
                            }
                        });
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock",{
                            label: "Maximize",
                            icon: IconRegistry.createIcon("mdc:aspect_ratio"),
                            order: 0,
                            onAction: ()=>{
                                EventSystem.triggerEvent("Cauldron.Dock", {
                                    pos: EdgeDocker.MODE.MAXIMIZED
                                });
                            }
                        });

                        let dockMenu = MenuSystem.MenuManager.createMenu("Cauldron.View.Dock");
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                            label: "Dock...",
                            group: "Positioning",
                            groupOrder:0,
                            icon: IconRegistry.createIcon("mdc:view_quilt"),
                            order: 0,
                            submenu: dockMenu
                        });

                        let themeMenu = MenuSystem.MenuManager.createMenu("Cauldron.View.Theme");
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                            label: "Theme...",
                            group: "LayoutCommands",
                            groupOrder:0,
                            icon: IconRegistry.createIcon("mdc:brush"),
                            order: 0,
                            submenu: themeMenu
                        });

                        ["Light", "Dark"].forEach((theme)=>{
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Theme",{
                                label: theme,
                                order: 0,
                                checked: ()=>Cauldron.CauldronSettings.getTheme()===theme.toLowerCase(),
                                onAction: ()=>{
                                    Cauldron.CauldronSettings.setTheme(theme.toLowerCase());
                                    EventSystem.triggerEvent("Cauldron.Theme", {
                                        theme: theme.toLowerCase()
                                    });
                                }
                            });
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                            label: "Reset layout",
                            group: "LayoutCommands",
                            groupOrder:10,


                            icon: IconRegistry.createIcon("mdc:settings_backup_restore"),
                            order: 1,
                            onAction:()=>{
                                EventSystem.triggerEvent("Cauldron.ResetLayout");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.View", {
                            label: (Cauldron.CauldronSettings.getShadowRoot()?"Disable":"Enable") +" ShadowDOM Experiment",
                            icon: IconRegistry.createIcon("mdc:science_off"),
                            order: 0,
                            onAction: (menuItem)=>{
                                Cauldron.CauldronSettings.setShadowRoot(!Cauldron.CauldronSettings.getShadowRoot());
                                window.location.reload();
                            }
                        });
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronEditorTabActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Editor Tabs Actions",
                        "description": "Actions that affect editor tabs",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem",
                            "#CauldronBase"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="cauldron-editor-tabs-actions-script" type="disabled">
                    /**
                     *  Tab Actions
                     *  Control the Cauldron tabs
                     *
                     *  Copyright 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    {
                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Tab.ContextMenu", {
                            label: "Close",
                            group: "Tab",
                            icon: IconRegistry.createIcon("mdc:close"),
                            order: 100,
                            onAction: (e)=>{
                                e.menu.context.tab.closeElement.click();
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Tab.ContextMenu", {
                            label: "Close Other",
                            group: "Tab",
                            icon: IconRegistry.createIcon("mdc:close"),
                            order: 110,
                            onOpen: (e)=>e.context.tab.header.tabs.length>1,
                            onAction: (e)=>{
                                let ourContent = e.menu.context.tab.contentItem;

                                for (let tab of e.menu.context.tab.header.tabs.slice()){
                                    if (tab.contentItem != ourContent){
                                        tab.closeElement.click();
                                    }
                                };
                                return true;
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Tab.ContextMenu", {
                            label: "Close All",
                            group: "Tab",
                            icon: IconRegistry.createIcon("mdc:close"),
                            order: 120,
                            onOpen: (e)=>e.context.tab.header.tabs.length>1,
                            onAction: (e)=>{
                                for (let tab of e.menu.context.tab.header.tabs.slice()){
                                    tab.closeElement.click();
                                };
                                return true;
                            }
                        });

                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronEditorDocumentation" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Documentation Help Menu",
                        "description": "Documentation for the help menu",
                        "dependencies": [
                            "webstrate-components-repos #MenuSystem",
                            "#CauldronBase"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="documentation-script" type="disabled">
                    /**
                     *  Help Actions
                     *  Links to various API and help documentation
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    {
                        let documentationMenu = MenuSystem.MenuManager.createMenu("Cauldron.Help.Documentation");

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help", {
                            label: "Documentation",
                            icon: IconRegistry.createIcon("mdc:menu_book"),
                            submenu: documentationMenu
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                            label: "Webstrates",
                            icon: IconRegistry.createIcon("webstrates:logo"),
                            onAction: () => {
                                window.open("https://webstrates.github.io/userguide/api.html");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                            label: "Codestrates",
                            icon: IconRegistry.createIcon("webstrates:codestrates"),
                            onAction: () => {
                                window.open("https://codestrates.projects.cavi.au.dk/api/codestrates/");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                            label: "Cauldron",
                            icon: IconRegistry.createIcon("webstrates:cauldron"),
                            onAction: () => {
                                window.open("https://codestrates.projects.cavi.au.dk/api/cauldron/");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                            label: "Webstrate Components",
                            icon: IconRegistry.createIcon("webstrates:components"),
                            onAction: () => {
                                window.open("https://webstrate.projects.cavi.au.dk/docs/webstrate_components/");
                            }
                        });

                        MenuSystem.MenuManager.registerMenuItem("Cauldron.Help.Documentation", {
                            label: "Webstrate Package Manager",
                            icon: IconRegistry.createIcon("webstrates:wpm-package-open"),
                            onAction: () => {
                                window.open("https://webstrate.projects.cavi.au.dk/docs/wpmv2/");
                            }
                        });
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronAssetActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Webstrate Asset Actions",
                        "description": "Management of assets",
                        "dependencies": [
                            "#CauldronBase",
                            "webstrate-components-repos #MenuSystem",
                            "webstrate-components-repos #wsc-icon-registry"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="asset-actions-script" type="disabled">
                    /**
                     *  Asset Actions
                     *  Menu entries related to assets in wpm packages
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Copyright 2024 Janus B. Kristensen
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Download",
                        group: "TransferActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:cloud_download"),
                        onOpen: (menu)=>{
                            return menu.context.type == "AssetNode" || menu.context.type == "AssetContainer";
                        },
                        onAction: (menuItem) =>{
                            EventSystem.triggerEvent("Cauldron.Asset.Download", {
                                asset: menuItem.menu.context.context
                            });
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Upload Files...",
                        group: "TransferActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:cloud_upload"),
                        onOpen: (menu)=>{
                            return menu.context.type == "AssetRootNode" && webstrate?.uploadAsset;
                        },
                        onAction: (menuItem) =>{
                            webstrate.uploadAsset();
                        }
                    });

                    EventSystem.registerEventCallback("Cauldron.Asset.Download", ({detail: {asset: asset}})=>{
                        let a = document.createElement("a");
                        a.setAttribute("href", location.href+asset.fileName);
                        a.setAttribute("download", asset.fileName);
                        a.setAttribute("target", "_blank");
                        a.click();
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Delete",
                        icon: IconRegistry.createIcon("mdc:delete"),
                        group: "ViolentActions",
                        groupOrder: 9000,
                        onOpen: (menu)=>{
                            return (menu.context.type == "AssetNode" || menu.context.type == "AssetContainer");
                        },
                        onAction: (menuItem)=>{
                            if(
                                menuItem.menu.context.parentNode != null &&
                                menuItem.menu.context.parentNode.parentNode != null &&
                                menuItem.menu.context.parentNode.parentNode.type === "DomTreeNode" &&
                                menuItem.menu.context.parentNode.parentNode.context.matches("wpm-package")
                            ) {
                                //Asset inside wpm-package

                                let descFrag = cQuery(menuItem.menu.context.parentNode.parentNode.context.querySelector("code-fragment[data-type='wpm/descriptor']")).data("Fragment");
                                if(descFrag != null) {
                                    let decision = confirm("Really delete: "+menuItem.menu.context.getProperty("content"));
                                    if(decision) {
                                        descFrag.require().then((descJson)=>{
                                            descJson.assets.splice(descJson.assets.indexOf(menuItem.menu.context.context.fileName), 1);
                                            descFrag.raw = JSON.stringify(descJson, null, 2);
                                        });
                                    }
                                }
                            } else {
                                //Asset node not inside a package
                                EventSystem.triggerEvent("Codestrates.Asset.Delete", {
                                    asset: menuItem.menu.context.context,
                                    success: ()=>{
                                        menuItem.menu.context.parentNode.removeNode(menuItem.menu.context);
                                    },
                                    fail: (err)=>{
                                        console.error(err);
                                    }
                                });
                            }
                        }
                    });

                    EventSystem.registerEventCallback("TreeBrowser.Keyup", ({detail: {evt: evt, treeNode: treeNode}})=>{
                        if(evt.key === "Delete") {
                            if(treeNode.type === "AssetNode" || treeNode.type === "AssetContainer") {
                                EventSystem.triggerEvent("Codestrates.Asset.Delete", {
                                    asset: treeNode.context,
                                    success: (err)=>{
                                        if(err == null) {
                                            treeNode.parentNode.removeNode(treeNode);
                                        } else {
                                            console.error(err);
                                        }
                                    }
                                });
                            }
                        }
                    });

                    EventSystem.registerEventCallback("Codestrates.Asset.Delete", async ({detail: {asset: asset, success: successCallback, fail: failCallback}})=>{
                        //Check if asset is used by any wpm-packages.
                        let descFragUsingAsset = [];

                        for(let wpmPackageElm of Array.from(document.querySelectorAll("wpm-package"))) {
                            let descFrag = cQuery(wpmPackageElm).find("code-fragment[data-type='wpm/descriptor']").data("Fragment");

                            if(descFrag != null) {
                                let descJson = await descFrag.require();

                                if(descJson.assets.includes(asset.fileName)) {
                                    descFragUsingAsset.push(descFrag);
                                }
                            }
                        }

                        let msg = "Really delete asset: "+asset.fileName;

                        if(descFragUsingAsset.length > 0) {
                            msg = "Really delete asset: "+asset.fileName+" (It is currently being used by "+descFragUsingAsset.length+" descriptor fragments, and will be removed from those as well";
                        }

                        let decision = confirm(msg);
                        if(decision) {
                            webstrate.deleteAsset(asset.fileName, (err) => {
                                if(err == null) {
                                    for(let descFrag of descFragUsingAsset) {
                                        descFrag.require().then((descJson)=>{
                                            descJson.assets.splice(descJson.assets.indexOf(asset.fileName), 1);
                                            descFrag.raw = JSON.stringify(descJson, null, 2);
                                        });
                                    }
                                    successCallback();
                                } else {
                                    failCallback(err);
                                }
                            });
                        }
                    });


                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronEditorCodestratesActions" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Codestrates Actions",
                        "description": "Several actions that apply to code fragments",
                        "dependencies": [
                            "#CauldronBase",
                            "webstrate-components-repos #MenuSystem",
                            "webstrate-components-repos #wsc-icon-registry"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="fragment-actions-script" type="disabled">
                    /**
                     *  Fragment Actions
                     *  Menu entries related to fragments in codestrates
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    // Filter with elements that cannot have children
                    let nonChildElements = "code-fragment, script, style";

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.Editor.Toolbar", {
                        label: "Run",
                        icon: IconRegistry.createIcon(["mdc:play_arrow"]),
                        tooltip: "Execute the contents of this fragment",
                        order: 200,
                        class: "runAction",
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.Fragment.Run", {
                                fragment: menuItem.menu.context
                            });
                        },
                        onOpen: (menu, menuItem)=>{
                            return menu.context.supportsRun();
                        }
                    });
                    EventSystem.registerEventCallback("Codestrates.Fragment.Run", async ({detail: {fragment: fragment}})=>{
                        try {
                            let result = await fragment.require();
                            console.log("Require result: ", result);
                        } catch(e) {
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.Editor.Toolbar", {
                        label: "Auto",
                        icon: IconRegistry.createIcon(["mdc:play_circle_outline"]),
                        tooltip: "Run this fragment automatically",
                        order: 100,
                        class: "autoAction",
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.Fragment.Auto", {
                                fragment: menuItem.menu.context
                            });

                            menuItem.active = menuItem.menu.context.auto;
                        },
                        onOpen: (menu, menuItem)=>{
                            if(menu.context.supportsAuto()) {
                                menuItem.active = menu.context.auto;
                                return true;
                            }

                            return false;
                        }
                    });

                    // Single-element Autorun On/Off
                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Enable Autorun",
                        icon: IconRegistry.createIcon("mdc:play_circle_outline"),
                        tooltip: "Execute the contents of this fragment when the page loads",
                        group: "EditActions",
                        groupOrder: 200,
                        order: 200,
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode" && menu.context.context.matches("code-fragment")) {
                                let fragment = Fragment.one(menu.context.context);

                                return fragment.supportsAuto() && !fragment.auto;
                            }
                        },
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.Fragment.AutoOn", {
                                fragment: Fragment.one(menuItem.menu.context.context)
                            });
                        }
                    });
                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Disable Autorun",
                        icon: IconRegistry.createIcon("mdc:play_circle_outline"),
                        tooltip: "Stop executing the contents of this fragment when the page loads",
                        group: "EditActions",
                        groupOrder: 200,
                        order: 200,
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode" && menu.context.context.matches("code-fragment")) {
                                let fragment = Fragment.one(menu.context.context);

                                return fragment.supportsAuto() && fragment.auto;
                            }
                        },
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.Fragment.AutoOff", {
                                fragment: Fragment.one(menuItem.menu.context.context)
                            });
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Enable Autorun Recursively",
                        icon: IconRegistry.createIcon("mdc:play_circle_outline"),
                        group: "FragmentActions",
                        groupOrder: 9000,
                        order: 205,
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode") {
                                let childFragments = Fragment.find(menu.context.context.querySelectorAll("code-fragment"));

                                let autoFragment = childFragments.find((fragment)=>{
                                    return fragment.supportsAuto() && !fragment.auto;
                                });

                                return autoFragment != null;
                            }
                        },
                        onAction: (menuItem)=>{
                            let fragments = menuItem.menu.context.context.querySelectorAll("code-fragment");
                            fragments.forEach((fragmentHtml)=>{
                                let fragment = Fragment.one(fragmentHtml);
                                if(fragment.supportsAuto() && !fragment.auto) {
                                    EventSystem.triggerEvent("Codestrates.Fragment.AutoOn", {
                                        fragment: fragment
                                    });
                                }
                            });
                        }
                    });
                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Disable Autorun Recursively",
                        icon: IconRegistry.createIcon("mdc:play_circle_outline"),
                        group: "FragmentActions",
                        groupOrder: 9000,
                        order: 210,
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode") {
                                let childFragments = Fragment.find(menu.context.context.querySelectorAll("code-fragment"));

                                let autoFragment = childFragments.find((fragment)=>{
                                    return fragment.supportsAuto() && fragment.auto;
                                });

                                return autoFragment != null;
                            }
                        },
                        onAction: (menuItem)=>{
                            let fragments = menuItem.menu.context.context.querySelectorAll("code-fragment");
                            fragments.forEach((fragmentHtml)=>{
                                let fragment = Fragment.one(fragmentHtml);
                                if(fragment.supportsAuto() && fragment.auto) {
                                    EventSystem.triggerEvent("Codestrates.Fragment.AutoOff", {
                                        fragment: fragment
                                    });
                                }
                            });
                        }
                    });
                    EventSystem.registerEventCallback("Codestrates.Fragment.Auto", ({detail: {fragment: fragment}})=>{
                        fragment.auto = !fragment.auto;
                    });
                    EventSystem.registerEventCallback("Codestrates.Fragment.AutoOn", ({detail: {fragment: fragment}})=>{
                        fragment.auto = true;
                    });
                    EventSystem.registerEventCallback("Codestrates.Fragment.AutoOff", ({detail: {fragment: fragment}})=>{
                        fragment.auto = false;
                    });


                    EventSystem.registerEventCallback("TreeBrowser.Keyup", ({detail: {evt: evt, treeNode: treeNode}})=>{
                        if(evt.key === "Delete") {
                            if(treeNode.type === "DomTreeNode") {
                                EventSystem.triggerEvent("Codestrates.DomNode.Delete", {
                                    treeNode: treeNode
                                });
                            }
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Delete",
                        icon: IconRegistry.createIcon("mdc:delete"),
                        group: "ViolentActions",
                        groupOrder: 9000,
                        order: 200,
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode") {
                                return true;
                            }
                        },
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.DomNode.Delete", {
                                treeNode: menuItem.menu.context
                            });
                        }
                    });
                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Move Up",
                        icon: IconRegistry.createIcon("mdc:north"),
                        group: "EditActions",
                        groupOrder: 9000,
                        order: 1000,
                        onOpen: (menu)=>{
                            if(menu.context.type === "DomTreeNode"){
                                let children = Array.from(menu.context.context.parentNode.children);
                                return children.indexOf(menu.context.context)>0;
                            }
                        },
                        onAction: (menuItem)=>{
                            let children = Array.from(menuItem.menu.context.context.parentNode.children);
                            let currentIndex = children.indexOf(menuItem.menu.context.context);
                            menuItem.menu.context.context.parentNode.insertBefore(menuItem.menu.context.context, children[currentIndex-1]);
                        }
                    });
                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Move Down",
                        icon: IconRegistry.createIcon("mdc:south"),
                        group: "EditActions",
                        groupOrder: 9000,
                        order: 1001,
                        onOpen: (menu)=>{
                            if(menu.context.type === "DomTreeNode"){
                                let children = Array.from(menu.context.context.parentNode.children);
                                return children.indexOf(menu.context.context)<children.length-1;
                            }
                        },
                        onAction: (menuItem)=>{
                            let children = Array.from(menuItem.menu.context.context.parentNode.children);
                            let currentIndex = children.indexOf(menuItem.menu.context.context);
                            menuItem.menu.context.context.parentNode.insertBefore(menuItem.menu.context.context, currentIndex===children.length-2?null:children[currentIndex+2]);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Duplicate",
                        icon: IconRegistry.createIcon("mdc:content_copy"),
                        group: "EditActions",
                        groupOrder: 9000,
                        order: 900,
                        onOpen: (menu)=>menu.context.type === "DomTreeNode",
                        onAction: (menuItem)=>{
                            let clone = menuItem.menu.context.context.cloneNode(true);
                            WPMv2.stripProtection(clone);
                            menuItem.menu.context.context.parentNode.insertBefore(clone, menuItem.menu.context.context);
                        }
                    });

                    EventSystem.registerEventCallback("Codestrates.DomNode.Delete", ({detail: {treeNode: treeNode}})=>{
                        let decision = confirm("Really delete: "+treeNode.getProperty("content"));
                        if(decision) {
                            treeNode.context.parentNode.removeChild(treeNode.context);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "New WPM Package",
                        icon: IconRegistry.createIcon("webstrates:wpm-package-open"),
                        order: 20,
                        group: "inserters",
                        groupOrder: -1,
                        onOpen: (menu)=>{
                            if (!window.DescriptorFragment) return false;
                            return menu.context.type == "DomTreeNode" && (!menu.context.context.matches("wpm-package")) && (!menu.context.context.matches(nonChildElements));
                        },
                        onAction: (menuItem)=>{
                            EventSystem.triggerEvent("Codestrates.Fragment.CreateWPMPackage", {
                                treeNode: menuItem.menu.context
                            });
                        }
                    });

                    EventSystem.registerEventCallback("Codestrates.Fragment.CreateWPMPackage", ({detail: {treeNode: treeNode}})=>{
                        let wpmPackage = document.createElement("wpm-package");

                        let wpmDescriptor = Fragment.create("wpm/descriptor");
                        wpmPackage.appendChild(wpmDescriptor.element);

                        WPMv2.stripProtection(wpmPackage);

                        treeNode.context.appendChild(wpmPackage);
                        setTimeout(()=>{
                            let treeBrowser = treeNode.getTreeBrowser();
                            let treeNodes = treeBrowser.findTreeNodeForContext(wpmPackage);
                            if(treeNodes.length > 0) {
                                let treeNode = treeNodes[0];
                                treeNode.reveal();
                                treeNode.select();
                            }
                        }, 0);
                    });

                    function insertNewElement(context, elementType){
                        try {
                            let element = document.createElement(elementType, {approved: true});
                            context.context.appendChild(element);
                            setTimeout(()=>{
                                let treeBrowser = context.getTreeBrowser();
                                let treeNodes = treeBrowser.findTreeNodeForContext(element);
                                if(treeNodes.length > 0) {
                                    let treeNode = treeNodes[0];
                                    treeNode.reveal();
                                    treeNode.select();
                                }
                            }, 1);
                            return element;
                        } catch(e) {
                            console.error(e);
                        }
                    }

                    let domMenu = MenuSystem.MenuManager.createMenu("Cauldron.TreeBrowser.DOMInsertMenu");
                    MenuSystem.MenuManager.registerMenuItem("Cauldron.TreeBrowser.DOMInsertMenu", {
                        label: "Script",
                        icon: IconRegistry.createIcon("mdc:code"),
                        onAction: (menuItem)=>insertNewElement(menuItem.menu.superMenu.context, "script")
                    });
                    MenuSystem.MenuManager.registerMenuItem("Cauldron.TreeBrowser.DOMInsertMenu", {
                        label: "Stylesheet",
                        icon: IconRegistry.createIcon("mdc:brush"),
                        onAction: (menuItem)=>insertNewElement(menuItem.menu.superMenu.context, "style")
                    });
                    MenuSystem.MenuManager.registerMenuItem("Cauldron.TreeBrowser.DOMInsertMenu", {
                        label: "Div",
                        icon: IconRegistry.createIcon("mdc:html"),
                        onAction: (menuItem)=>insertNewElement(menuItem.menu.superMenu.context, "div")
                    });


                    MenuSystem.MenuManager.registerMenuItem("Cauldron.TreeBrowser.DOMInsertMenu", {
                        label: "Other Element...",
                        order: 999,
                        icon: IconRegistry.createIcon("mdc:html"),
                        group: "inserters",
                        groupOrder: -1,
                        onAction: (menuItem)=>{
                            let elementType = prompt("Element Tag");
                            if (elementType===null) return;
                            insertNewElement(menuItem.menu.superMenu.context, elementType);
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "New Folder...",
                        order: 1,
                        icon: IconRegistry.createIcon("mdc:create_new_folder"),
                        group: "inserters",
                        groupOrder: -1,
                        onOpen: (menu)=>{
                            return menu.context.type == "DomTreeNode" && !menu.context.context.matches(nonChildElements);
                        },
                        onAction: (menuItem)=>{
                            let elementName = prompt("Folder Name");
                            if (elementName===null) return;
                            let element = insertNewElement(menuItem.menu.context, "code-folder");
                            element.setAttribute("name", elementName);
                        }
                    });


                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "New DOM Element...",
                        order: 10,
                        icon: IconRegistry.createIcon("mdc:html"),
                        group: "inserters",
                        groupOrder: -1,
                        onOpen: (menu)=>{
                            return menu.context.type == "DomTreeNode" && !menu.context.context.matches(nonChildElements);
                        },
                        submenu: domMenu
                    });

                    let fragmentMenu = MenuSystem.MenuManager.createMenu("FragmentInsertMenu");

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "New Fragment...",
                        icon: IconRegistry.createIcon("mdc:note_add"),
                        order: 5,
                        group: "inserters",
                        groupOrder: -1,
                        onOpen: (menu)=>{
                            if (Fragment.fragmentTypes.size === 0) return false;

                            let canOpen = menu.context.type == "DomTreeNode" && !menu.context.context.matches(nonChildElements);

                            // Check for new fragments not already registered in the menu
                            if (!fragmentMenu.alreadyRegistered){
                                fragmentMenu.alreadyRegistered = [];
                            }
                            Fragment.fragmentTypes.forEach((fragment, fragType)=>{
                                if (!fragmentMenu.alreadyRegistered.includes(fragType)){
                                    MenuSystem.MenuManager.registerMenuItem("FragmentInsertMenu", {
                                        label: fragment.name.replace("Fragment",""),
                                        icon: IconRegistry.createIcon(["code-fragment:"+fragType, "mdc:insert_drive_file"]),
                                        onAction: (menuItem)=>{
                                            let fragment = Fragment.create(fragType);
                                            WPMv2.stripProtection(fragment.element);
                                            menuItem.menu.superMenu.context.context.appendChild(fragment.element);
                                            setTimeout(()=>{
                                                //Find the newly added treenode and open the editor
                                                let treeBrowser = menuItem.menu.superMenu.context.getTreeBrowser();
                                                let treeNodes = treeBrowser.findTreeNodeForContext(fragment.element);
                                                if(treeNodes.length > 0) {
                                                    let treeNode = treeNodes[0];
                                                    treeNode.reveal();
                                                    treeNode.select();
                                                    //Is this needed?
                                                    treeNode.triggerAction();
                                                }
                                            }, 0);
                                        }
                                    });
                                    fragmentMenu.alreadyRegistered.push(fragType);
                                }
                            });

                            return canOpen;
                        },
                        submenu: fragmentMenu
                    });


                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Open Preview",
                        group: "EditActions",
                        groupOrder: 0,
                        icon: IconRegistry.createIcon("mdc:web"),
                        onOpen: (menu)=>{
                            if(menu.context.type == "DomTreeNode" && menu.context.context.matches("code-fragment")) {
                                let fragment = cQuery(menu.context.context).data("Fragment");

                                if(PreviewEditor.types().includes(fragment.type)) {
                                    return true;
                                }
                            }
                            return false;
                        },
                        onAction: (menuItem)=>{
                            let fragment = cQuery(menuItem.menu.context.context).data("Fragment");

                            EventSystem.triggerEvent("Cauldron.Open.Preview", {
                                fragment: fragment
                            });
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("TreeBrowser.TreeNode.ContextMenu", {
                        label: "Edit InnerHTML",
                        icon: IconRegistry.createIcon("mdc:edit"),
                        group: "EditActions",
                        groupOrder: 200,
                        order: 100,
                        onOpen: (menu)=>{
                            return menu.context.type === "DomTreeNode" && !menu.context.context.matches("code-fragment");
                        },
                        onAction: (menuItem)=>{
                            let element = menuItem.menu.context.context;

                            //Check for any code-fragment inside element
                            if(element.querySelector("code-fragment") != null) {
                                let decision = confirm("You are about to edit InnerHTML that contains or is itself a code-fragment, are you sure?");

                                if(!decision) {
                                    return;
                                }
                            }

                            EventSystem.triggerEvent("Cauldron.Open.InnerHTMLEditor", {
                                element: menuItem.menu.context.context
                            });
                        }
                    });

                    MenuSystem.MenuManager.registerMenuItem("Cauldron.Editor.Toolbar", {
                        label: "Save",
                        icon: IconRegistry.createIcon(["mdc:save"]),
                        onOpen: (menu)=>{
                            return menu.context.isInnerHtmlEditor === true;
                        },
                        onAction: (menuItem)=>{
                            menuItem.menu.context.save();
                        }
                    });

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="Cauldron" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                      "friendlyName": "Cauldron Editor",
                      "description": "The base core functionality of Cauldron",
                      "dependencies": [
                        "#CauldronBase",
                        "#NewWebstrateActions",
                        "#DocumentActions",
                        "#CauldronAssetActions",
                        "#CauldronEditorViewActions",
                        "#CauldronEditorTabActions",
                        "#CauldronEditorCodestratesActions",
                        "#CauldronEditorDocumentation",
                        "#CauldronCollaboration"
                      ],
                      "assets": [],
                      "version": "0.1",
                      "license": "Apache 2.0",
                      "changelog": {
                        "0.1": "Initial version"
                      }
                    }

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronLauncher" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Launcher",
                        "description": "Delayed-loads the newest (or included) version of Cauldron and adds it to the window object",
                        "dependencies": [
                            "#CauldronNamespace"
                        ],
                        "optionalDependencies": [
                            "#Cauldron"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="cauldron-launcher-script" type="disabled">
                    /**
                     *  CauldronLauncher
                     *  Launch Cauldron with delayed-load feature or directly if preloaded
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    // Create function on window to install Cauldron editor
                    window.cauldronEditor = async () => {
                        if(typeof Cauldron === "undefined" || typeof Cauldron.Cauldron === "undefined") {
                            await WPMv2.require({package: "Cauldron", repository: "cauldron-repos"});
                        }
                        if(typeof localCauldronEditor === "undefined") {
                            window.localCauldronEditor = new Cauldron.Cauldron();
                        }
                        localCauldronEditor.open();
                    };

                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronButtonLauncher" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Edit Button",
                        "description": "A floating edit button on your page that launches Cauldron",
                        "dependencies": [
                            "#CauldronLauncher"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="button-launcher-script" type="disabled">
                    // Add edit button to page that opens up the Cauldron editor
                    let button = document.createElement("button");
                    button.innerHTML="Edit"
                    button.style.position = "fixed";
                    button.style.top = "1em";
                    button.style.right = "1em";
                    button.id = "cauldron-edit-button";

                    let transientElement = document.createElement("transient");
                    transientElement.append(button);
                    document.body.appendChild(transientElement);

                    button.addEventListener("click", ()=>{
                        cauldronEditor();
                    });


                    </SCRIPT></WPM-PACKAGE><WPM-PACKAGE data-repository="cauldron-repos" id="CauldronURLLauncher" class="package" style="width: 0px; height: 0px; position: absolute; visibility: hidden;"><SCRIPT id="descriptor-script" type="descriptor">
                    {
                        "friendlyName": "Cauldron Edit URL",
                        "description": "Launches Cauldron when ?edit is added to the URL of the page, also adds the Popup option to the Views menu",
                        "dependencies": [
                            "#CauldronLauncher",
                            "codestrates-repos #EventSystem"
                        ],
                        "assets": [],
                        "version": "0.1",
                        "license": "Apache 2.0",
                        "changelog": {
                            "0.1": "Initial version"
                        }
                    }

                    </SCRIPT><SCRIPT id="url-launcher-script" type="disabled">
                    /**
                     *  URL Launcher
                     *  Launched Cauldron when a specific URL pattern is detected
                     *
                     *  Copyright 2020, 2021 Rolf Bagge, Janus B. Kristensen, CAVI,
                     *  Center for Advanced Visualization and Interaction, Aarhus University
                     *
                     *  Licensed under the Apache License, Version 2.0 (the "License");
                     *  you may not use this file except in compliance with the License.
                     *  You may obtain a copy of the License at
                     *
                     *     http://www.apache.org/licenses/LICENSE-2.0

                     *  Unless required by applicable law or agreed to in writing, software
                     *  distributed under the License is distributed on an "AS IS" BASIS,
                     *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                     *  See the License for the specific language governing permissions and
                     *  limitations under the License.
                    **/

                    // Launch Cauldron when ?edit is added to the URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const editorMode = urlParams.get('edit');

                    if(editorMode != null && editorMode !== false) {
                        // Be nice to Codestrates if it is running
                        window.disableCodestratesFragmentsAutorun = true;

                        EventSystem.registerEventCallback("Cauldron.OnInit", ({detail: {cauldron: cauldron}})=>{
                            EventSystem.triggerEvent("Cauldron.Dock", {
                                pos: EdgeDocker.MODE.MAXIMIZED
                            });
                        });

                        cauldronEditor();
                    }


                    //Run when/if Cauldron is initialized
                    if (typeof webstrate !== "undefined"){
                        EventSystem.registerEventCallback("Cauldron.OnInit", ()=>{
                            //Insert Cauldron view menu item
                            MenuSystem.MenuManager.registerMenuItem("Cauldron.View.Dock", {
                                label: "Popout editor",
                                icon: IconRegistry.createIcon("mdc:open_in_new"),
                                order: 1000, //Order us very low priority, so near the end of the menu
                                onAction: ()=>{
                                    window.open(location.href+"?edit");
                                }
                            });
                        });
                    }

                    </SCRIPT></WPM-PACKAGE>
            </CODE-FOLDER>
                <wpm-package id="WPM-dev" data-repository="https://cdn.jsdelivr.net/gh/Webstrates/WPM@master/build.html">
                    <script id="descriptor-script" type="descriptor">
                    {
                        "dependencies": [
                        ],
                        "forceEmbedding": true
                    }

                    </script>
                    <script id="WPMv2-script" src="https://cdn.jsdelivr.net/gh/Webstrates/WPM@master/WPMv2.js" type="text/javascript"></script>
                </wpm-package>

            <VARV-DATA><CONCEPT type="UserManager" uuid="conceptfe9fd885f117ee1c5400"></CONCEPT><CONCEPT type="User" uuid="concept6059cf8e0f9f49750a98"><PROPERTY name="name" value="Guest"></PROPERTY></CONCEPT><CONCEPT type="DashManager" uuid="conceptbacb71e5706a5e629be2"></CONCEPT><CONCEPT type="MovableManager" uuid="concept64cd1f4af50ed11df54d"><PROPERTY name="presentationMode" value="false"></PROPERTY></CONCEPT><CONCEPT type="Trashcan" uuid="conceptd579f914dc577751ebd7"><PROPERTY name="positionX" value="-0.9005849346761177"></PROPERTY><PROPERTY name="positionY" value="0.6340998628761509"></PROPERTY><PROPERTY name="positionZ" value="-0.6854724507638388"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.1388420780943169"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="conceptb0e13746979cf1294e92"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;mark&quot;:&quot;area&quot;}"></PROPERTY><PROPERTY name="snippetType" value="mark"></PROPERTY><PROPERTY name="positionX" value="-0.10107537256638555"></PROPERTY><PROPERTY name="positionY" value="1.1936268577884324"></PROPERTY><PROPERTY name="positionZ" value="-0.7782121358172824"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.32790731769007303"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="conceptaca1a4e62fe47da02878"><PROPERTY name="type" value="dataset"></PROPERTY><PROPERTY name="fragmentId" value="stocks-dataset"></PROPERTY><PROPERTY name="content" value></PROPERTY><PROPERTY name="snippetType" value="dataset"></PROPERTY><PROPERTY name="positionX" value="-0.5822660822543105"></PROPERTY><PROPERTY name="positionY" value="0.9027968763546985"></PROPERTY><PROPERTY name="positionZ" value="-0.782137740159119"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.19550629753951926"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concepte7c8ea74ccb1ed4f2b6c"><PROPERTY name="type" value="spec"></PROPERTY><PROPERTY name="fragmentId" value="stocks-spec"></PROPERTY><PROPERTY name="content" value></PROPERTY><PROPERTY name="snippetType" value="spec"></PROPERTY><PROPERTY name="positionX" value="-0.34460987035040747"></PROPERTY><PROPERTY name="positionY" value="0.9124341243079319"></PROPERTY><PROPERTY name="positionZ" value="-0.8184930469754206"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.07456106744542747"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="Visualization" uuid="conceptfb3f1593f0cc08e6cd98"><PROPERTY name="type" value="vegaLite_25D"></PROPERTY><PROPERTY name="positionX" value="-0.3428534400062323"></PROPERTY><PROPERTY name="positionY" value="1.1327194230516078"></PROPERTY><PROPERTY name="positionZ" value="-0.8147729253187748"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.05939000901609386"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY><PROPERTY name="visComponents"><ENTRY value="conceptb0e13746979cf1294e92"></ENTRY><ENTRY value="conceptaca1a4e62fe47da02878"></ENTRY><ENTRY value="concepte7c8ea74ccb1ed4f2b6c"></ENTRY></PROPERTY></CONCEPT><CONCEPT type="Visualization" uuid="concept5a8a5faaeb0384c64c7e"><PROPERTY name="type" value="vegaLite_2D"></PROPERTY><PROPERTY name="positionX" value="-0.6894332949832004"></PROPERTY><PROPERTY name="positionY" value="1.1464036774518829"></PROPERTY><PROPERTY name="positionZ" value="-0.7821399957827833"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.3230026626862015"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY><PROPERTY name="visComponents"><ENTRY value="conceptaca1a4e62fe47da02878"></ENTRY><ENTRY value="concepte7c8ea74ccb1ed4f2b6c"></ENTRY></PROPERTY></CONCEPT><CONCEPT type="VisShelf" uuid="concept28b98c603e2a3acf8ede"><PROPERTY name="positionX" value="-1.1150547360663308"></PROPERTY><PROPERTY name="positionY" value="0.9303616334740499"></PROPERTY><PROPERTY name="positionZ" value="-0.6588031588598415"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.5537793522951455"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY><PROPERTY name="type" value="visualizations"></PROPERTY><PROPERTY name="selectedParent" value="default_marks"></PROPERTY></CONCEPT><CONCEPT type="StickyNote" uuid="concept7c916be499c62e2aa654"><PROPERTY name="positionX" value="-0.04161114899403162"></PROPERTY><PROPERTY name="positionY" value="0.9027265041177903"></PROPERTY><PROPERTY name="positionZ" value="-0.7502015124670436"></PROPERTY><PROPERTY name="rotationX" value="-0.13259565795551043"></PROPERTY><PROPERTY name="rotationY" value="-0.1024884919211272"></PROPERTY><PROPERTY name="rotationZ" value="-0.2260397890964753"></PROPERTY><PROPERTY name="text" value="This is a showcase."></PROPERTY></CONCEPT><CONCEPT type="Visualization" uuid="concept3fe5fd28cf8417dc7a29"><PROPERTY name="type" value="optomancy"></PROPERTY><PROPERTY name="positionX" value="0.4600856312773768"></PROPERTY><PROPERTY name="positionY" value="1.1172292894576703"></PROPERTY><PROPERTY name="positionZ" value="-0.7136876045000597"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.6967669935780735"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY><PROPERTY name="visComponents"><ENTRY value="conceptb194013d0c829dbce359"></ENTRY><ENTRY value="concept49822446ba0b296eac8f"></ENTRY><ENTRY value="conceptdab941e96a80d3e93ff9"></ENTRY><ENTRY value="concept463d28bd2cb35af86f04"></ENTRY><ENTRY value="concept239a9feb6728bd31d1ad"></ENTRY><ENTRY value="concept39a7ebd20d93bfb585a9"></ENTRY></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="conceptb194013d0c829dbce359"><PROPERTY name="type" value="dataset"></PROPERTY><PROPERTY name="fragmentId" value="events-dataset"></PROPERTY><PROPERTY name="content" value></PROPERTY><PROPERTY name="snippetType" value="dataset"></PROPERTY><PROPERTY name="positionX" value="0.46851081524445504"></PROPERTY><PROPERTY name="positionY" value="0.8445927838570779"></PROPERTY><PROPERTY name="positionZ" value="-0.7116067942380953"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.15132835655780627"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept49822446ba0b296eac8f"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;mark&quot;:&quot;bar&quot;}"></PROPERTY><PROPERTY name="snippetType" value="mark"></PROPERTY><PROPERTY name="positionX" value="0.23852958542963915"></PROPERTY><PROPERTY name="positionY" value="1.036831725848601"></PROPERTY><PROPERTY name="positionZ" value="-0.7413297650854258"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.09166744780752319"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="conceptdab941e96a80d3e93ff9"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;encoding&quot;:{&quot;z&quot;:{&quot;field&quot;:&quot;Event&quot;}}}"></PROPERTY><PROPERTY name="snippetType" value="encodingZField"></PROPERTY><PROPERTY name="positionX" value="0.7782309336476294"></PROPERTY><PROPERTY name="positionY" value="0.9262810785025759"></PROPERTY><PROPERTY name="positionZ" value="-0.6952195038474243"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.027332953412068713"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept463d28bd2cb35af86f04"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;encoding&quot;:{&quot;x&quot;:{&quot;field&quot;:&quot;Year&quot;}}}"></PROPERTY><PROPERTY name="snippetType" value="encodingXField"></PROPERTY><PROPERTY name="positionX" value="0.7519000389660759"></PROPERTY><PROPERTY name="positionY" value="1.1385463522305792"></PROPERTY><PROPERTY name="positionZ" value="-0.715395373157995"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.0007368863398764964"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept239a9feb6728bd31d1ad"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;encoding&quot;:{&quot;y&quot;:{&quot;field&quot;:&quot;Operating Revenue&quot;}}}"></PROPERTY><PROPERTY name="snippetType" value="encodingYField"></PROPERTY><PROPERTY name="positionX" value="0.6948245993503323"></PROPERTY><PROPERTY name="positionY" value="0.7382393201378004"></PROPERTY><PROPERTY name="positionZ" value="-0.6774140726866107"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.056263472543382494"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept39a7ebd20d93bfb585a9"><PROPERTY name="type" value="specSnippet"></PROPERTY><PROPERTY name="fragmentId" value></PROPERTY><PROPERTY name="content" value="{&quot;encoding&quot;:{&quot;y&quot;:{&quot;type&quot;:&quot;quantitative&quot;}}}"></PROPERTY><PROPERTY name="snippetType" value="encodingYType"></PROPERTY><PROPERTY name="positionX" value="0.196782597807395"></PROPERTY><PROPERTY name="positionY" value="0.7862280267469913"></PROPERTY><PROPERTY name="positionZ" value="-0.7347617886465878"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="0.16010529803142173"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept33c9e66a253bda4c2605"><PROPERTY name="type" value="dataset"></PROPERTY><PROPERTY name="fragmentId" value="event-1-dataset"></PROPERTY><PROPERTY name="content" value></PROPERTY><PROPERTY name="snippetType" value="dataset"></PROPERTY><PROPERTY name="positionX" value="1.1515857150713429"></PROPERTY><PROPERTY name="positionY" value="0.8590598790757265"></PROPERTY><PROPERTY name="positionZ" value="-0.5478460351690533"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.27181457291168953"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT><CONCEPT type="Visualization" uuid="conceptd07db96f7f089c625434"><PROPERTY name="type" value="d3"></PROPERTY><PROPERTY name="positionX" value="1.0930146114319546"></PROPERTY><PROPERTY name="positionY" value="1.1399386245126835"></PROPERTY><PROPERTY name="positionZ" value="-0.6046489625791628"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.16853551683443616"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY><PROPERTY name="visComponents"><ENTRY value="concept33c9e66a253bda4c2605"></ENTRY><ENTRY value="concept49a33f79af7f79841d82"></ENTRY></PROPERTY></CONCEPT><CONCEPT type="VisComponent" uuid="concept49a33f79af7f79841d82"><PROPERTY name="type" value="d3Spec"></PROPERTY><PROPERTY name="fragmentId" value="event-d3-spec"></PROPERTY><PROPERTY name="content" value></PROPERTY><PROPERTY name="snippetType" value="d3Spec"></PROPERTY><PROPERTY name="positionX" value="1.346296548567718"></PROPERTY><PROPERTY name="positionY" value="1.0816107968611846"></PROPERTY><PROPERTY name="positionZ" value="-0.5150830265990557"></PROPERTY><PROPERTY name="rotationX" value="0"></PROPERTY><PROPERTY name="rotationY" value="-0.3964201717043435"></PROPERTY><PROPERTY name="rotationZ" value="0"></PROPERTY></CONCEPT></VARV-DATA><VARV-SIGNALING></VARV-SIGNALING><SCRIPT name="Import Mapping" type="importmap">{
    "imports": {
        "three": "https://esm.sh/*three@0.165.0",
        "three/": "https://esm.sh/*three@0.165.0/",
        "three-stdlib": "https://esm.sh/*three-stdlib@2.30.4",
        "three-mesh-bvh": "https://esm.sh/*three-mesh-bvh@0.7.6",

        "react": "https://esm.sh/*react@18.3.1",
        "react/": "https://esm.sh/*react@18.3.1/",
        "react-dom": "https://esm.sh/*react-dom@18.3.1",
        "react-dom/": "https://esm.sh/*react-dom@18.3.1/",
        "react-is": "https://esm.sh/*react-is@18.3.1",
        "react-composer": "https://esm.sh/*react-composer@5.0.3",
        "react-use-measure": "https://esm.sh/*react-use-measure@2.1.1",
        "react-merge-refs": "https://esm.sh/*react-merge-refs@1.1.0",
        "react-reconciler": "https://esm.sh/*react-reconciler@0.29.2",
        "react-reconciler/": "https://esm.sh/*react-reconciler@0.29.2/",
        "react-error-boundary": "https://esm.sh/*react-error-boundary@4.0.13",

        "@react-three/fiber": "https://esm.sh/*@react-three/fiber@8.16.8",
        "@react-three/drei": "https://esm.sh/*@react-three/drei@9.108.3",
        "@react-three/xr": "https://esm.sh/*@react-three/xr@5.7.1",

        "@react-spring/three": "https://esm.sh/*@react-spring/three@9.7.3",
        "@react-spring/core": "https://esm.sh/*@react-spring/core@9.7.3",
        "@react-spring/shared": "https://esm.sh/*@react-spring/shared@9.7.3",
        "@react-spring/animated": "https://esm.sh/*@react-spring/animated@9.7.3",
        "@react-spring/types": "https://esm.sh/*@react-spring/types@9.7.3",
        "@react-spring/rafz": "https://esm.sh/*@react-spring/rafz@9.7.3",

        "zustand": "https://esm.sh/*zustand@4.5.4",
        "zustand/": "https://esm.sh/*zustand@4.5.4/",

        "lodash": "https://esm.sh/*lodash@4.17.21",
        "lodash.pick": "https://esm.sh/*lodash.pick@4.4.0",
        "lodash.omit": "https://esm.sh/*lodash.omit@4.5.0",
        "lodash.clamp": "https://esm.sh/*lodash.clamp@4.0.3",
        "lodash.merge": "https://esm.sh/*lodash.merge@4.6.2",
        "lodash.mergewith": "https://esm.sh/*lodash.mergewith@4.6.2",

        "@babel/runtime/helpers/esm/extends": "https://esm.sh/*@babel/runtime@7.24.8/helpers/extends",
        "@monogrid/gainmap-js": "https://esm.sh/*@monogrid/gainmap-js@3.0.5",
        "@preact/signals-core": "https://esm.sh/*@preact/signals-core@1.6.1",
        "bidi-js": "https://esm.sh/*bidi-js@1.0.3",
        "camera-controls": "https://esm.sh/*camera-controls@2.8.5",
        "debounce": "https://esm.sh/*debounce@2.1.0",
        "detect-gpu": "https://esm.sh/*detect-gpu@5.0.40",
        "fast-json-patch": "https://esm.sh/*fast-json-patch@3.1.1",
        "fflate": "https://esm.sh/*fflate@0.8.2",
        "inline-style-parser": "https://esm.sh/*inline-style-parser@0.2.3",
        "its-fine": "https://esm.sh/*its-fine@1.2.5",
        "json-stringify-pretty-compact": "https://esm.sh/*json-stringify-pretty-compact@4.0.0",
        "maath": "https://esm.sh/*maath@0.10.8",
        "meshline": "https://esm.sh/*meshline@3.1.6",
        "node-html-parser": "https://esm.sh/node-html-parser@6.1.13",
        "object-assign": "https://esm.sh/*object-assign@4.1.1",
        "potpack": "https://esm.sh/*potpack@2.0.0",
        "prettier/": "https://esm.sh/*prettier@3.3.2/",
        "prop-types": "https://esm.sh/*prop-types@15.8.1",
        "scheduler": "https://esm.sh/*scheduler@0.23.2",
        "stats.js": "https://esm.sh/*stats.js@0.17.0",
        "stats-gl": "https://esm.sh/*stats-gl@2.2.8",
        "suspend-react": "https://esm.sh/*suspend-react@0.1.3",
        "tunnel-rat": "https://esm.sh/*tunnel-rat@0.1.2",
        "tw-to-css": "https://esm.sh/*tw-to-css@0.0.12",
        "troika-three-text": "https://esm.sh/*troika-three-text@0.49.0",
        "troika-three-utils": "https://esm.sh/*troika-three-utils@0.49.0",
        "troika-worker-utils": "https://esm.sh/*troika-worker-utils@0.49.0",
        "use-sync-external-store": "https://esm.sh/*use-sync-external-store@1.2.2",
        "use-sync-external-store/": "https://esm.sh/*use-sync-external-store@1.2.2/",
        "uuid": "https://esm.sh/*uuid@10.0.0",
        "webgl-sdf-generator": "https://esm.sh/*webgl-sdf-generator@1.1.1",
        "yoga-layout/": "https://esm.sh/*yoga-layout@3.0.4/",

        "vega": "https://esm.sh/vega@5.30.0",
        "vega-embed": "https://esm.sh/vega-embed@6.26.0",
        "d3": "https://esm.sh/d3@7.9.0",

        "@use-gesture/core": "https://esm.sh/*@use-gesture/core@10.3.1",
        "@use-gesture/core/actions": "https://esm.sh/*@use-gesture/core@10.3.1/actions",
        "@use-gesture/react": "https://esm.sh/*@use-gesture/react@10.3.1?external=@use-gesture/core,@use-gesture/core/actions",
        "@use-gesture/core/types": "https://esm.sh/*@use-gesture/core@10.3.1/types?external=@use-gesture/core,@use-gesture/core/actions",
        "@use-gesture/core/utils": "https://esm.sh/*@use-gesture/core@10.3.1/utils?external=@use-gesture/core,@use-gesture/core/actions"
    }
}</SCRIPT><CODE-FOLDER name="Varv Extensions"><CODE-FOLDER name="Actions"><CODE-FRAGMENT auto data-type="text/javascript" id name="Webstrate Client">class WebstrateClientAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }
    async apply(contexts, actionArguments) {
        const self = this;

        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            let resultName = Action.defaultVariableName(self);

            if (options.as != null) {
                resultName = options.as;
            }

            Action.setVariable(context, resultName, webstrate.clientId);

            return context;
        });
    }
}
Action.registerPrimitiveAction('webstrateClient', WebstrateClientAction);
window.WebstrateClientAction = WebstrateClientAction;
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/javascript+babel" id name="Camera and Controller">import * as THREE from "three";



const DEBUG = false;



let interactionDeviceStates = {};
window.VarvInteractionDeviceStates = interactionDeviceStates;

class DevicePositionAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }

    async apply(contexts, actionArguments) {
        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            const device = interactionDeviceStates[options.device];

            let x = 0;
            let y = 0;
            let z = 0;

            if (device) {
                let position = device.position;

                const distance = options.distance ? options.distance : 0;
                if (distance != 0) {
                    const direction = new THREE.Vector3(0, 0, -1);
                    direction.normalize();
                    direction.applyQuaternion(device.quaternion);

                    position = new THREE.Vector3();
                    position.copy(device.position).add(direction.multiplyScalar(distance));
                }

                x = position.x;
                y = position.y;
                z = position.z;
            }

            Action.setVariable(context, 'devPosX', x);
            Action.setVariable(context, 'devPosY', y);
            Action.setVariable(context, 'devPosZ', z);

            if (DEBUG) console.log('DevicePosition', camera, position);

            return context;
        });
    }
}
Action.registerPrimitiveAction('devicePosition', DevicePositionAction);
window.DevicePositionAction = DevicePositionAction;



class DeviceDistanceAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }

    async apply(contexts, actionArguments) {
        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            const device = interactionDeviceStates[options.device];

            const devicePosition = device.position;
            let x = devicePosition.x-options.x;
            let y = devicePosition.y-options.y;
            let z = devicePosition.z-options.z;
            const distance = Math.sqrt(x*x+y*y+z*z);

            Action.setVariable(context, 'devDist', distance);

            if (DEBUG) console.log('DeviceDistance', device, distance);

            return context;
        });
    }
}
Action.registerPrimitiveAction('deviceDistance', DeviceDistanceAction);
window.DeviceDistanceAction = DeviceDistanceAction;



class DeviceRotationAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }

    async apply(contexts, actionArguments) {
        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            const device = interactionDeviceStates[options.device];
            let x = 0;
            let y = 0;
            let z = 0;

            if (device) {
                x = device.rotation._x;
                y = device.rotation._y;
                z = device.rotation._z;
            }

            Action.setVariable(context, 'devRotX', x);
            Action.setVariable(context, 'devRotY', y);
            Action.setVariable(context, 'devRotZ', z);

            if (DEBUG) console.log('DeviceRotation', device, x, y, z);
            return context;
        });
    }
}
Action.registerPrimitiveAction('deviceRotation', DeviceRotationAction);
window.DeviceRotationAction = DeviceRotationAction;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Movable Actions" id auto>const MAX_DISTANCE = 0.5;



let positionXProperty, positionYProperty, positionZProperty;
VarvEngine.registerEventCallback('engineReloaded', (evt) => {
    positionXProperty = null;
    positionYProperty = null;
    positionZProperty = null;
});

async function getMovablePosition(movable) {
    if (!positionXProperty) {
        let movableType = VarvEngine.getConceptFromType('Movable');
        positionXProperty = movableType.getProperty('positionX');
        positionYProperty = movableType.getProperty('positionY');
        positionZProperty = movableType.getProperty('positionZ');
    }

    const x = await positionXProperty.getValue(movable, true);
    const y = await positionYProperty.getValue(movable, true);
    const z = await positionZProperty.getValue(movable, true);

    return [x, y, z];
};



class ClosestMovableAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }
    async apply(contexts, actionArguments) {
        const self = this;

        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            const movable = options.movable || context.target;
            const otherMovables = options.otherMovables;

            const movablePosition = await getMovablePosition(movable);
            let closest = '';
            let closestDistance = false;

            for (let i = 0; i &lt; otherMovables.length; i++) {
                const currentPosition = await getMovablePosition(otherMovables[i]);
                const a = movablePosition[0] - currentPosition[0];
                const b = movablePosition[1] - currentPosition[1];
                const c = movablePosition[2] - currentPosition[2];
                const currentDistance = Math.sqrt(a * a + b * b + c * c);
                if (!closestDistance || (closestDistance > currentDistance)) {
                    if (currentDistance &lt; MAX_DISTANCE) {
                        closest = otherMovables[i];
                    }
                    closestDistance = currentDistance;
                }
            }

            let resultName = Action.defaultVariableName(self);
            if (options.as != null) {
                resultName = options.as;
            }

            Action.setVariable(context, resultName, closest);

            return context;
        });
    }
}
Action.registerPrimitiveAction('closestMovable', ClosestMovableAction);
window.ClosestMovableAction = ClosestMovableAction;



class MovablesInRangeAction extends Action {
    constructor(name, options, concept) {
        super(name, options, concept);
    }
    async apply(contexts, actionArguments) {
        const self = this;

        return this.forEachContext(contexts, actionArguments, async (context, options) => {
            const movable = options.movable || context.target;
            const otherMovables = options.otherMovables;

            const maxDistance = options.maxDistance || MAX_DISTANCE;

            const movablePosition = await getMovablePosition(movable);
            let inRange = [];

            for (let i = 0; i &lt; otherMovables.length; i++) {
                const currentPosition = await getMovablePosition(otherMovables[i]);
                const a = movablePosition[0] - currentPosition[0];
                const b = movablePosition[1] - currentPosition[1];
                const c = movablePosition[2] - currentPosition[2];
                const currentDistance = Math.sqrt(a * a + b * b + c * c);
                if (currentDistance &lt; maxDistance) {
                    inRange.push(otherMovables[i]);
                }
            }

            let resultName = Action.defaultVariableName(self);
            if (options.as != null) {
                resultName = options.as;
            }

            Action.setVariable(context, resultName, inRange);

            return context;
        });
    }
}
Action.registerPrimitiveAction('movablesInRange', MovablesInRangeAction);
window.MovablesInRangeAction = MovablesInRangeAction;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="CustomJSBulkAction" auto>class CustomJSBulkAction extends Action {
    constructor(name, options, concept) {
        if (typeof options === 'string') {
            options = {
                'functionName': options
            }
        }
        super(name, options, concept);
    }
    async apply(contexts, actionArguments) {
        const f = window[this.options.functionName];
        if (f == null) {
            throw new Error('"window.' + this.options.functionName + '" is not defined');
        }
        if (typeof f !== 'function') {
            throw new Error('"window.' + this.options.functionName + '" is not a function');
        }
        return await f(contexts, actionArguments);

    }
}
Action.registerPrimitiveAction('customJSBulk', CustomJSBulkAction);
window.CustomJSAction = CustomJSBulkAction;
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Triggers"><CODE-FRAGMENT auto data-type="text/javascript" id name="Custom JS Trigger">class CustomJSTrigger extends Trigger {
    constructor(name, options, concept) {
        if (typeof options === 'string') {
            options = {
                type: options
            }
        }

        super(name, options, concept);

        if (!options || !options.type) {
            console.warn('CustomJSTrigger requires a type parameter.');
        }
    }

    enable() {
        const self = this;

        this.deleteTrigger = Trigger.registerTriggerEvent('customJSTrigger', async (contexts) => {
            if (contexts[0].variables.type != this.options.type) return;
            await Trigger.trigger(self.name, contexts);
        });
    }

    disable() {
        if (this.deleteTrigger != null) {
            this.deleteTrigger.delete();
        }
    }

    static trigger(type, payload) {
        const context = {
            variables: {
                type: type,
                ...payload
            },
            target: null,
            properties: null
        };
        Trigger.trigger('customJSTrigger', context);
    }

    static triggerWithTarget(type, target, payload) {
        const context = {
            variables: {
                type: type,
                ...payload
            },
            target: target,
            properties: null
        };
        Trigger.trigger('customJSTrigger', context);
    }
}
Trigger.registerTrigger('customJSTrigger', CustomJSTrigger);
window.CustomJSTrigger = CustomJSTrigger;
</CODE-FRAGMENT></CODE-FOLDER><CODE-FRAGMENT data-type="text/javascript" auto name="User Devices Function">// Put this before Varv fragments to avoid errors on load
const urlParams = new URLSearchParams(window.location.search);
const DISABLED = urlParams.get('dud') === 'true';
window.checkUserDevicesDisabled = (contexts) => {
    if (DISABLED) {
        throw new StopError('User devices are disabled.');
    } else {
        return contexts;
    }
};
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Varv Concepts"><CODE-FRAGMENT auto data-type="text/varv" name="UserManager">{
    "concepts": {
        "UserManager": {
            "schema": {
                "placeholder": "string",
                "loggedIn": "boolean",
                "localUser": { "User": { "default": "concept6059cf8e0f9f49750a98" }},
                "localUserName": { "string": {
                    "derive": {
                        "properties": [ "localUser", "User.name" ],
                        "transform": [
                            { "select": { "property": "UserManager.localUser" }},
                            { "get": "name" }
                        ]
                    }
                }}
            },
            "mappings": {
                "loggedIn": [ "memory", "cauldron" ],
                "localUser": [ "memory", "cauldron" ]
            },
            "actions": {
                "addUser": {
                    "when": { "click": { "view": "addUserButton" }},
                    "then": [
                        "random",
                        { "new": {
                            "concept": "User",
                            "with": {
                                "name": "User $random$"
                            }
                        }},
                        { "set": { "UserManager.localUser": "$target" }}
                    ]
                },
                "deleteUser": {
                    "when": { "click": { "view": "deleteUserButton" }},
                    "then": [
                        { "get": "UserManager.localUser" },
                        { "where": {
                            "variable": "get",
                            "unequals": "concept6059cf8e0f9f49750a98",
                            "stopIfEmpty": true
                        }},
                        { "set": { "localUser": "concept6059cf8e0f9f49750a98" }},
                        { "select": "$get" },
                        "remove"
                    ]
                },
                "selectUser": {
                    "when": { "click": "User" },
                    "then": [
                        { "set": { "localUser": "$target" }}
                    ]
                },
                "login": {
                    "when": { "click": { "view": "loginButton" }},
                    "then": [
                        { "set": { "loggedIn": true }}
                    ]
                }
            }
        },
        "User": {
            "schema": {
                "name": "string",
                "local": { "boolean": {
                    "derive": {
                        "properties": [ "UserManager.localUser" ],
                        "transform": [
                            { "eval": {
                                "property": "UserManager.localUser",
                                "equals": "$target"
                            }}
                        ]
                    }
                }}
            },
            "mappings": {
                "local": [ "memory", "cauldron" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/varv" name="Main">{
    "concepts": {
        "DashManager": {
            "schema": {
                "placeholder": "string"
            },
            "actions": {
                "createObject": {
                    "when": { "customJSTrigger": "createObject" },
                    "then": [
                        { "devicePosition": { "device": "$device", "distance": 0.5 }},
                        { "deviceRotation": { "device": "$device" }},
                        { "new": {
                            "concept": "$concept",
                            "with": {
                                "positionX": "$devPosX",
                                "positionY": "$devPosY",
                                "positionZ": "$devPosZ",
                                "rotationX": "$devRotX",
                                "rotationY": "$devRotY",
                                "rotationZ": "$devRotZ"
                            }
                        }}
                    ]
                },
                "imageUploaded": {
                    "when": { "customJSTrigger": "imageUploaded" },
                    "then": [
                        { "devicePosition": { "device": "camera", "distance": 0.5 }},
                        { "deviceRotation": { "device": "camera" }},
                        { "new": {
                            "concept": "Image",
                            "with": {
                                "url": "$fileName",
                                "positionX": "$devPosX",
                                "positionY": "$devPosY",
                                "positionZ": "$devPosZ",
                                "rotationX": "$devRotX",
                                "rotationY": "$devRotY",
                                "rotationZ": "$devRotZ"
                            }
                        }}
                    ]
                },
                "mergeComponents": {
                    "when": { "customJSTrigger": "mergeComponents" },
                    "then": [
                        { "select": {
                            "concept": "VisComponent",
                            "where": { "and": [
                                { "property": "selected", "equals": true },
                                { "or": [
                                    { "property": "type", "equals": "spec" },
                                    { "property": "type", "equals": "specSnippet" }
                                ]}
                            ]},
                            "stopIfEmpty": true
                        }},
                        { "get": { "property": "type", "as": "type" }},
                        { "get": { "property": "fragmentId", "as": "fragmentId" }},
                        { "get": { "property": "content", "as": "content" }},
                        { "get": { "property": "snippetType", "as": "snippetType" }},
                        { "get": { "property": "positionY", "as": "positionY" }},
                        { "customJSBulk": "mergeComponentsInScene" },
                        { "run": "unselectMovable" },
                        { "devicePosition": { "device": "$device", "distance": 0.5 }},
                        { "deviceRotation": { "device": "$device" }},
                        { "new": {
                            "concept": "VisComponent",
                            "with": {
                                "type": "spec",
                                "fragmentId": "$newFragmentId",
                                "positionX": "$devPosX",
                                "positionY": "$devPosY",
                                "positionZ": "$devPosZ",
                                "rotationX": "$devRotX",
                                "rotationY": "$devRotY",
                                "rotationZ": "$devRotZ"
                            }
                        }}
                    ]
                }
            }
        },
        "ScreenStream": {
            "schema": {
                "client": "string"
            },
            "actions":{
                "onMoved": {}
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        },
        "VideoStream": {
            "schema": {
                "client": "string"
            }
        },
        "AudioStream": {
            "schema": {
                "client": "string",
                "muted": "boolean"
            }
        },
        "StickyNote": {
            "schema": {
                "text": "string"
            },
            "actions":{
                "onMoved": {}
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        },
        "Image": {
            "schema": {
                "url": "string"
            },
            "actions":{
                "onMoved": {}
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/varv" name="Movable">{
    "concepts": {
        "Movable": {
            "schema": {
                "positionX": "number",
                "positionY": { "number": { "default": 1.5 }},
                "positionZ": "number",
                "rotationX": "number",
                "rotationY": "number",
                "rotationZ": "number",
                "scale": { "number": { "default": 1 }},
                "selected": "boolean",
                "hovered": "boolean",
                "beingDragged": { "boolean": {
                    "derive": {
                        "properties": [ "selected", "MovableManager.dragging" ],
                        "transform": [
                            { "get": { "property": "MovableManager.dragging", "as": "dragging" }},
                            { "eval": { "and": [
                                { "property": "selected", "equals": true },
                                { "variable": "dragging", "equals": true }
                            ]}}
                        ]
                    }
                }}
            },
            "mappings": {
                "selected": [ "memory", "cauldron" ],
                "hovered": [ "memory", "cauldron" ]
            }
        },
        "MovableManager": {
            "schema": {
                "multiSelect": "boolean",
                "dragging": "boolean",
                "draggingDevice": "string",
                "presentationMode": "boolean"
            },
            "actions": {
                "selectMovable": {
                    "when": { "customJSTrigger": "selectMovable" },
                    "then": [
                        { "select": { "target": "$uuid" }},
                        { "run": "dragEnd" },
                        { "run": "unselectMovableIfSingleSelect" },
                        { "set": { "selected": true }}
                    ]
                },
                "deselectMovable": {
                    "when": { "customJSTrigger": "deselectMovable" },
                    "then": [
                        { "where": {
                            "property": "multiSelect",
                            "equals": false,
                            "stopIfEmpty": true
                        }},
                        { "select": { "target": "$uuid" }},
                        { "set": { "selected": false }}
                    ]
                },
                "unselectMovableIfSingleSelect": [
                    { "where": {
                        "property": "multiSelect",
                        "equals": false,
                        "stopIfEmpty": true
                    }},
                    "unselectMovable"
                ],
                "unselectMovable": {
                    "when": { "customJSTrigger": "unselectMovable" },
                    "then": [
                        { "select": "Movable" },
                        { "set": { "selected": false }}
                    ]
                },
                "selectSelectedMovable": [
                    { "select": {
                        "concept": "Movable",
                        "where": { "and": [
                            { "property": "selected", "equals": true }
                        ]},
                        "stopIfEmpty": true
                    }}
                ],
                "cloneMovable": {
                    "when": { "customJSTrigger": "cloneMovable" },
                    "then": [
                        "selectSelectedMovable",
                        { "set": { "selected": false }},
                        "clone",
                        { "get": "positionY" },
                        { "set": { "positionY": { "calculate": "$get$ + 0.2" }}},
                        { "set": { "selected": true }}
                    ]
                },
                "deleteMovable": {
                    "when": { "customJSTrigger": "deleteMovable" },
                    "then": [
                        "selectSelectedMovable",
                        "remove"
                    ]
                },
                "deleteAllMovables": {
                    "when": { "customJSTrigger": "deleteAllMovables" },
                    "then": [
                        { "select": "Movable" },
                        "remove"
                    ]
                },
                "dragStart": {
                    "when": { "customJSTrigger": "dragStart" },
                    "then": [
                        { "select": "MovableManager" },
                        { "where": {
                            "property": "dragging",
                            "equals": false,
                            "stopIfEmpty": true
                        }},
                        { "set": { "draggingDevice": "$device" }},
                        "selectSelectedMovable",
                        { "set": { "dragging": true }}
                    ]
                },
                "dragEnd": {
                    "when": [
                        { "customJSTrigger": "dragEnd" }
                    ],
                    "then": [
                        { "select": "MovableManager" },
                        { "where": {
                            "property": "dragging",
                            "equals": true,
                            "stopIfEmpty": true
                        }},
                        { "set": { "dragging": false }}
                    ]
                }
            },
            "mappings": {
                "multiSelect": [ "memory", "cauldron" ],
                "dragging": [ "memory", "cauldron" ],
                "draggingDevice": [ "memory", "cauldron" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/varv" name="VisComponents and Snippets" auto>{
    "concepts": {
        "VisComponent": {
            "schema": {
                "type": { "string": {
                    "default": "spec",
                    "enum": [ "spec", "dataset", "d3Spec", "specSnippet" ]
                }},
                "fragmentId": "string",
                "content": "string",
                "snippetParent": "string",
                "snippetType": "string"
            },
            "actions": {
                "onMoved": { "then": [
                    { "run": "updateNearbyVisualizations" },
                    { "run": "updateVisualizationsWithThis" }
                ]},
                "updateNearbyVisualizations": [
                    { "get": "type" },
                    { "run": "updateNearbyVisualizationsWithSpecs" },
                    { "run": "updateNearbyVisualizationsWithDatasets" },
                    { "run": "updateNearbyVisualizationsWithD3Specs" }
                ],
                "updateNearbyVisualizationsWithSpecs": [
                    { "where": {
                        "or": [
                            { "property": "type", "equals": "spec" },
                            { "property": "type", "equals": "specSnippet" }
                        ],
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "Visualization",
                        "where": { "or": [
                            { "property": "type", "equals": "vegaLite_2D" },
                            { "property": "type", "equals": "vegaLite_25D" },
                            { "property": "type", "equals": "optomancy" }
                        ]},
                        "stopIfEmpty": true,
                        "keepContext": true,
                        "forEach": true
                    }},
                    "updateNearbyVisualizationsInProximity"
                ],
                "updateNearbyVisualizationsWithDatasets": [
                    { "where": {
                        "property": "type",
                        "equals": "dataset",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "Visualization",
                        "stopIfEmpty": true,
                        "keepContext": true,
                        "forEach": true
                    }},
                    "updateNearbyVisualizationsInProximity"
                ],
                "updateNearbyVisualizationsWithD3Specs": [
                    { "where": {
                        "property": "type",
                        "equals": "d3Spec",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "Visualization",
                        "where": { "property": "type", "equals": "d3" },
                        "stopIfEmpty": true,
                        "keepContext": true,
                        "forEach": true
                    }},
                    "updateNearbyVisualizationsInProximity"
                ],
                "updateNearbyVisualizationsInProximity": [
                    { "movablesInRange": {
                        "otherMovables": "$select"
                    }},
                    { "select": {
                        "target": "$movablesInRange",
                        "stopIfEmpty": true
                    }},
                    "updateComponents"
                ],
                "updateVisualizationsWithThis": {
                    "then": [
                        { "storeSelection": "this" },
                        { "select": {
                            "concept": "Visualization",
                            "stopIfEmpty": true,
                            "where": { "property": "visComponents", "includesAll": "$this" },
                            "forEach": true
                        }},
                        "updateComponents"
                    ]
                }
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/varv" name="Visualizations" auto>{
    "concepts": {
        "Visualization": {
            "schema": {
                "type": { "string": {
                    "default": "vegaLite_25D",
                    "enum": [ "vegaLite_2D", "vegaLite_25D", "optomancy", "d3" ]
                }},
                "visComponents": { "array": "VisComponent" }
            },
            "actions": {
                "onMoved": { "then": [
                    "updateComponents"
                ]},
                "updateComponents": [
                    { "get": "type" },
                    { "run": "updateComponentsForVegaLite2D" },
                    { "run": "updateComponentsForVegaLite25D" },
                    { "run": "updateComponentsForOptomancy" },
                    { "run": "updateComponentsForD3" }
                ],
                "updateComponentsForVegaLite2D": [
                    { "where": {
                        "variable": "get",
                        "equals": "vegaLite_2D",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "VisComponent",
                        "where": { "or": [
                            { "property": "type", "equals": "spec" },
                            { "property": "type", "equals": "dataset" },
                            { "property": "type", "equals": "specSnippet" }
                        ]},
                        "stopIfEmpty": true,
                        "keepContext": true
                    }},
                    "updateComponentsByProximity"
                ],
                "updateComponentsForVegaLite25D": [
                    { "where": {
                        "variable": "get",
                        "equals": "vegaLite_25D",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "VisComponent",
                        "where": { "or": [
                            { "property": "type", "equals": "spec" },
                            { "property": "type", "equals": "dataset" },
                            { "property": "type", "equals": "specSnippet" }
                        ]},
                        "stopIfEmpty": true,
                        "keepContext": true
                    }},
                    "updateComponentsByProximity"
                ],
                "updateComponentsForOptomancy": [
                    { "where": {
                        "variable": "get",
                        "equals": "optomancy",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "VisComponent",
                        "where": { "or": [
                            { "property": "type", "equals": "spec" },
                            { "property": "type", "equals": "dataset" },
                            { "property": "type", "equals": "specSnippet" }
                        ]},
                        "stopIfEmpty": true,
                        "keepContext": true
                    }},
                    "updateComponentsByProximity"
                ],
                "updateComponentsForD3": [
                    { "where": {
                        "variable": "get",
                        "equals": "d3",
                        "stopIfEmpty": true
                    }},
                    { "select": {
                        "concept": "VisComponent",
                        "where": { "or": [
                            { "property": "type", "equals": "dataset" },
                            { "property": "type", "equals": "d3Spec" }
                        ]},
                        "stopIfEmpty": true,
                        "keepContext": true
                    }},
                    "updateComponentsByProximity"
                ],
                "updateComponentsByProximity": [
                    { "movablesInRange": {
                        "otherMovables": "$select"
                    }},
                    { "where": {
                        "property": "visComponents",
                        "unequals": "$movablesInRange",
                        "stopIfEmpty": true
                    }},
                    { "set": { "visComponents": "$movablesInRange" }}
                ]
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/varv" name="VisShelf" auto> {
    "concepts": {
        "MovableManager": {
            "actions": {
                "instantiateVisComponent": {
                    "when": { "customJSTrigger": "instantiateVisComponent" },
                    "then": [
                        { "run": "unselectMovable" },
                        { "run": "dragEnd" },
                        { "new": {
                            "concept": "VisComponent",
                            "with": {
                                "type": "$componentType",
                                "fragmentId": "$fragmentId",
                                "content": "$content",
                                "snippetType": "$snippetType",
                                "positionX": "$positionX",
                                "positionY": "$positionY",
                                "positionZ": "$positionZ",
                                "selected": true
                            }
                        }},
                        "dragStart"
                    ]
                },
                "instantiateVisualization": {
                    "when": { "customJSTrigger": "instantiateVisualization" },
                    "then": [
                        { "run": "unselectMovable" },
                        { "run": "dragEnd" },
                        { "new": {
                            "concept": "Visualization",
                            "with": {
                                "type": "$visualizationType",
                                "positionX": "$positionX",
                                "positionY": "$positionY",
                                "positionZ": "$positionZ",
                                "selected": true
                            }
                        }},
                        "dragStart"
                    ]
                }
            }
        },
        "VisShelf": {
            "schema": {
                "type": { "string": { "default": "visualizations" }},
                "selectedParent": "string"
            },
            "actions": {
                "onMoved": {}
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        },
        "Trashcan": {
            "schema": {
                "placeholder": "string"
            },
            "actions": {
                "onMoved": {},
                "emptyTrash": {
                    "when": { "action": "dragEnd" },
                    "then": [
                        { "select": {
                            "concept": "Movable",
                            "where": {
                                "property": "selected",
                                "equals": true
                             },
                            "stopIfEmpty": true,
                            "keepContext": true
                        }},
                        { "select": "Trashcan" },
                        { "movablesInRange": {
                            "otherMovables": "$select",
                            "maxDistance": 0.2
                        }},
                        { "select": {
                            "target": "$movablesInRange",
                            "forEach": true
                        }},
                        { "get": "concept::name" },
                        { "where": {
                            "variable": "get",
                            "unequals": "Trashcan",
                            "stopIfEmpty": true
                        }},
                        "remove"
                    ]
                }
            },
            "extensions": {
                "inject": [ "Movable" ]
            }
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/varv" name="User Device">{
    "concepts": {
        "UserDevice": {
            "schema": {
                "type": {
                    "string":{
                        "default": "camera",
                        "enum": [ "camera", "controllerLeft", "controllerRight" ]
                    }
                },
                "userAgent": "string",
                "client": "string",
                "clientVideoStream": { "array": {
                    "items": "VideoStream",
                    "derive": {
                        "concepts": [ "VideoStream" ],
                        "properties": [ "client" ],
                        "transform": [
                            { "get": { "property": "client", "as": "client" }},
                            { "select": {
                                "concept": "VideoStream",
                                "where": { "property": "client", "equals": "$client" },
                                "keepContext": true
                            }}
                        ]
                    }
                }},
                "user": "string",
                "isMine": "boolean",
                "position": { "array": {
                    "items": "number",
                    "default": [ 0, 0, 0 ]
                }},
                "rotation": { "array": {
                    "items": "number",
                    "default": [ 0, 0, 0 ]
                }},
                "remoteControlled": "boolean",
                "remoteControllingClient": "string"
            },
            "actions": {
                "signalLocation": {
                    "when": { "interval": 100 },
                    "then": [
                        { "customJSBulk": "checkUserDevicesDisabled" },
                        { "select": {
                            "concept": "UserDevice",
                            "where": { "and": [
                                { "property": "isMine", "equals": true },
                                { "property": "remoteControlled", "equals": false }
                            ]},
                            "stopIfEmpty": true
                        }},
                        { "get": { "property": "type", "as": "type" }},
                        { "devicePosition": { "device": "$type" }},
                        { "deviceRotation": { "device": "$type" }},
                        { "set": { "position": [ "$devPosX$", "$devPosY$", "$devPosZ$" ] }},
                        { "set": { "rotation": [ "$devRotX$", "$devRotY$", "$devRotZ$" ] }},
                        { "get": "UserManager.localUserName" },
                        { "set": { "user": "$get" }}
                    ]
                },
                "signalRemoteLocation": {
                    "when": { "interval": 100 },
                    "then": [
                        { "customJSBulk": "checkUserDevicesDisabled" },
                        "webstrateClient",
                        { "select": {
                            "concept": "UserDevice",
                            "where": { "and": [
                                { "property": "isMine", "equals": false },
                                { "property": "remoteControlled", "equals": true },
                                { "property": "remoteControllingClient", "equals": "$webstrateClient" }
                            ]},
                            "stopIfEmpty": true
                        }},
                        { "devicePosition": { "device": "controllerRight", "distance": 0.1 }},
                        { "deviceRotation": { "device": "controllerRight" }},
                        { "set": { "position": [ "$devPosX$", "$devPosY$", "$devPosZ$" ] }},
                        { "set": { "rotation": [ "$devRotX$", "$devRotY$", "$devRotZ$" ] }}
                    ]
                }
            },
            "defaultMappings": [ "signaling", "memory", "cauldron" ],
            "mappings": {
                "isMine": [ "memory", "cauldron" ]
            }
        }
    },
    "dataStores": {
        "signaling": { "type": "signaling" }
    }
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Setup"><CODE-FRAGMENT data-type="text/javascript" name="Modules Loader" id auto>const modules = {};
window.modules = modules;

modules.streamManager = await Fragment.one('#stream-manager-module').require();
modules.screenStreams = await Fragment.one('#screen-streams-module').require();
modules.videoStreams = await Fragment.one('#video-streams-module').require();
modules.audioStreams = await Fragment.one('#audio-streams-module').require();

modules.visComponentManager = await Fragment.one('#vis-component-manager-module').require();
modules.decomposerMerger = await Fragment.one('#decomposer-merger-module').require();
modules.visSnippetManager = await Fragment.one('#vis-snippet-module').require();
modules.uploader = await Fragment.one('#uploader-module').require();

modules.screenshots = await Fragment.one('#screenshots-module').require();
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/javascript+babel" name="React Reloader">import React from 'react';
import { createRoot } from 'react-dom/client';



// Automatically reload this view if certain other fragments change
const changeFragments = [
    '#components [data-type="text/javascript+babel"]',
    '#elements [data-type="text/javascript+babel"]'
];

// Start the app
async function render() {
    if (!window.cachedAppRoot) {
        let element = document.createElement('transient');
        document.body.appendChild(element);
        window.cachedAppRoot = createRoot(element);
    }

    let content = await Fragment.one('#components [name="App"]').require();
    window.cachedAppRoot.render(React.createElement(content.App));
};

let reloadTimer = null;
const reload = () => {
    clearTimeout(reloadTimer);
    reloadTimer = setTimeout(async function reloadReact() {
        try {
            render();
        } catch (ex) {
            console.log(ex);
        }
    }, 1000);
};

changeFragments.forEach(frag => {
    let lookedUpFragments = Fragment.find(frag);
    lookedUpFragments.forEach((lookedUpFragment) => {
        lookedUpFragment.registerOnFragmentChangedHandler(() => {
            if (fragmentSelfReference.auto) {
                reload();
            }
        });
    });
});

reload();

VarvEngine.registerEventCallback('engineReloaded', () => {
    reload();
});
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Libs"><CODE-FRAGMENT data-type="text/javascript+babel" name="Optomancy" id="optomancy-lib">import lodash from 'lodash';
const { cloneDeep } = _;
import * as d3 from 'd3';

// applyTransforms.ts
/**
 * @name applyTransforms
 * @description Applies transforms to datasets
 * @param config An Optomancy config
 * @returns An object containing all transformed datasets
 */

const applyTransforms = (config, datasets) => {
  // Clone original datasets object using lodash/cloneDeep
  const transformedDatasets = cloneDeep(datasets); // TODO:
  // - Perform dataset transforms here and return transformed datasets object

  return transformedDatasets;
};

function _extends() {
  _extends = Object.assign ? Object.assign.bind() : function (target) {
    for (var i = 1; i &lt; arguments.length; i++) {
      var source = arguments[i];

      for (var key in source) {
        if (Object.prototype.hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }
    }

    return target;
  };
  return _extends.apply(this, arguments);
}

/**
 * @name isRootType
 * @description Type guard to check if the config passed in is of type RootType
 * @param config An optomancy config
 * @returns {boolean}
 */
function isRootType(config) {
  let key = "workspaces";
  return key in config;
}

/**
 * @name isWorkspaceType
 * @description Type guard to check if the config passed in is of type WorkspaceType
 * @param config An optomancy config
 * @returns {boolean}
 */
function isWorkspaceType(config) {
  let key = "views";
  return key in config;
}

const defaults = {
  view: {
    titlePadding: 0.1,
    width: 1,
    height: 1,
    depth: 1,
    x: 0,
    y: 0,
    z: 0,
    xrot: 0,
    yrot: 0,
    zrot: 0
  },
  mark: {
    defaultType: "point",
    types: {
      bar: {
        shape: "box"
      },
      point: {
        shape: "sphere"
      },
      line: {
        shape: "line"
      }
    },
    tooltip: {
      on: {
        content: "data"
      },
      off: false
    }
  },
  range: {
    size: [0, 0.1],
    length: [0, 0.1],
    offset: [0, 0, 1],
    rotation: [0, 360],
    color: {
      quantitative: "ramp",
      ordinal: "ordinal",
      nominal: "category",
      temporal: "ramp"
    },
    shape: ["sphere", "box", "tetrahedron", "torus", "cone"]
  },
  scheme: {
    ramp: "interpolateBlues",
    ordinal: "schemeBlues",
    category: "schemeTableau10"
  },
  scale: {
    nice: true,
    zero: true,
    paddingInner: 0.25,
    paddingOuter: 0.25
  },
  axis: {
    titlePadding: 0.1,
    filter: false,
    ticks: true,
    tickCount: 10,
    labels: true,
    face: {
      x: "front",
      y: "back",
      z: "left"
    },
    orient: {
      x: "bottom",
      y: "left",
      z: "bottom"
    }
  }
};

/**
 * @name getRanges
 * @description Get the ranges of each encoding channel from each view
 * @param view Calculate range for each encoding channel in this view
 * @return {array} Range array
 */

const getRanges = view => {
  const viewRanges = [];

  if ((view == null ? void 0 : view.encoding) !== undefined) {
    // This view doesn't have any layers so only has a single encoding object
    viewRanges.push(_getRangesFromEncoding(view.encoding));
  } else if ((view == null ? void 0 : view.layers) !== undefined) {
    // This view has layers, like onions, and ogres.
    // It has multiple encoding objects, one per layer, up to n layers.
    view.layers.forEach(layer => {
      viewRanges.push(_getRangesFromEncoding(layer.encoding));
    });
    return viewRanges;
  } else {
    // FIXME: Return error:
    // Encoding is undefined
    return [];
  }

  return viewRanges;
  /**
   * @name _getRangesFromEncoding
   * @description Gets ranges from an encoding object
   * @param encoding A view encoding object
   * @returns An range object or range object array
   */

  function _getRangesFromEncoding(encoding) {
    var _view$width, _view$height, _view$depth;

    const ranges = {};
    let channel;

    for (channel in encoding) {
      var _encoding$channel$sca;

      // Object.keys(encoding).forEach((channel) => {
      let range = []; // If a range is specified...

      if ((_encoding$channel$sca = encoding[channel].scale) != null && _encoding$channel$sca.range) {
        // ...use this range
        range = encoding[channel].scale.range;
      } else {
        // If the range is not specified, do a lookup
        switch (channel) {
          case "x":
          case "width":
            range = [0, (_view$width = view.width) != null ? _view$width : defaults.view.width];
            break;

          case "y":
          case "height":
            range = [0, (_view$height = view.height) != null ? _view$height : defaults.view.height];
            break;

          case "z":
          case "depth":
            range = [0, (_view$depth = view.depth) != null ? _view$depth : defaults.view.depth];
            break;

          case "opacity":
            range = [0, 1];
            break;

          case "size":
            range = defaults.range.size;
            break;

          case "length":
            range = defaults.range.length;
            break;

          case "color":
            // FIXME:
            range = defaults.range.color[encoding[channel].type]; // range = defaults.range.color.quantitative;

            break;

          case "shape":
            range = defaults.range.shape;
            break;

          case "xrot":
          case "yrot":
          case "zrot":
            range = defaults.range.rotation;
            break;

          case "xoffset":
          case "yoffset":
          case "zoffset":
            range = defaults.range.offset;
            break;
        }

        ranges[channel] = range;
      }
    }

    return ranges;
  }
};

/**
 * @name getDomains
 * @description Get the domains of each encoding channel from each view
 * @param view Calculate domain for each encoding channel in this view
 * @param dataset The dataset corresponding to this view
 * @return {object | array} Domain object (or domain object array)
 */

const getDomains = (view, dataset) => {
  if ((view == null ? void 0 : view.encoding) !== undefined) {
    // This view doesn't have any layers so only has a single encoding object
    return _getDomainsFromEncoding(view.encoding, dataset);
  } else if ((view == null ? void 0 : view.layers) !== undefined) {
    // This view has layers, like onions, and ogres.
    // It has multiple encoding objects, one per layer, up to n layers.
    const viewDomains = [];
    view.layers.forEach(layer => {
      viewDomains.push(_getDomainsFromEncoding(layer.encoding, dataset));
    });
    return viewDomains;
  } else {
    // FIXME: Return error:
    // Encoding is undefined
    return [];
  }
  /**
   * @name _getDomainsFromEncoding
   * @description Gets domains from an encoding object
   * @param encoding A view encoding object
   * @param dataset The dataset corresponding to this view
   * @returns An object or domain arrays
   */


  function _getDomainsFromEncoding(encoding, dataset) {
    const domains = {};
    Object.keys(encoding).forEach(channel => {
      var _encoding$channel$sca;

      let domain = []; // If a domain is specified...

      if ((_encoding$channel$sca = encoding[channel].scale) != null && _encoding$channel$sca.domain) {
        // ...use this domain
        domain = encoding[channel].scale.domain;
      } else if (encoding[channel].value) {
        // ...or use a value if specified
        domain = encoding[channel].value;
      } else {
        const values = dataset.map(row => row[encoding[channel].field]);

        switch (encoding[channel].type) {
          case "quantitative":
            // Should the domain start from zero?
            // Check upper and lower bounds, then scale.zero
            const extent = d3.extent(values);

            if (extent[0] > 0) {
              var _encoding$channel$sca2;

              // Domain lower bound greater than zero
              if (((_encoding$channel$sca2 = encoding[channel].scale) == null ? void 0 : _encoding$channel$sca2.zero) === true) {
                domain = [0, d3.max(values)];
              } else {
                domain = [...extent];
              }
            } else if (extent[1] &lt; 0) {
              var _encoding$channel$sca3;

              // Domain upper bound less than zero
              if (((_encoding$channel$sca3 = encoding[channel].scale) == null ? void 0 : _encoding$channel$sca3.zero) === true) {
                domain = [d3.max(values), 0];
              } else {
                domain = [...extent];
              }
            } else {
              domain = [...extent];
            }

            break;

          case "temporal":
          case "nominal":
          case "ordinal":
          default:
            // Reduce the dataset to a unique set of values
            // No spreading?
            // - See: https://stackoverflow.com/a/20070691
            //   and: https://github.com/Microsoft/TypeScript/issues/8856
            domain = Array.from(new Set(values));
            break;
        }

        domains[channel] = domain;
      }
    });
    return domains;
  }
};

// createScales.ts
/**
 * @name createScales
 * @description Create scales for encoding channels in config
 * @param view Create scale for each encoding channel in this view
 * @param ranges Ranges object
 * @param domains Domains object
 * @returns An object containing all scales for all workspaces
 */

const createScales = (view, // FIXME: Consider creating CompiledViewType etc.?
ranges, domains) => {
  if ((view == null ? void 0 : view.encoding) !== undefined) {
    // This view doesn't have any layers so only has a single encoding object
    return _createScalesFromEncoding(view.encoding);
  } else if ((view == null ? void 0 : view.layers) !== undefined) {
    // This view has layers, like onions, and ogres.
    // It has multiple encoding objects, one per layer, up to n layers.
    const viewScales = [];
    view.layers.forEach(layer => {
      viewScales.push(_createScalesFromEncoding(layer.encoding));
    });
    return viewScales;
  } else {
    // FIXME: Return error:
    // Encoding is undefined
    return [];
  }
  /**
   * @name _createScalesFromEncoding
   * @description Create scales from an encoding object
   * @param encoding A view encoding object
   * @returns A scale object or scale object array
   */


  function _createScalesFromEncoding(encoding) {
    const scales = {};
    Object.keys(encoding).forEach(channel => {
      var _encoding$channel, _encoding$channel$sca, _encoding$channel$sca3, _encoding$channel2, _encoding$channel2$sc;

      // This channel's scale
      let scale; // Create scales for each channel based on encoding type

      if (encoding[channel].value) {
        // Channel value is constant
        scale = () => encoding[channel].value;
      } else {
        switch (encoding[channel].type) {
          // Quantitative field scales
          case "quantitative":
            switch (channel) {
              // Colour channel
              case "color":
                let scheme = (_encoding$channel = encoding[channel]) == null ? void 0 : (_encoding$channel$sca = _encoding$channel.scale) == null ? void 0 : _encoding$channel$sca.scheme; // If a scheme is defined, use that scheme

                if (scheme !== undefined) {
                  if (typeof scheme === "string") {
                    // Scheme is a string
                    scale = d3.scaleSequential().domain(domains[channel]).interpolator(d3[scheme]);
                  } else {
                    var _encoding$channel$sca2;

                    // Scheme is an array
                    scale = d3.scaleLinear().domain(domains[channel]).range(ranges[channel]); // Nice the scale

                    if (((_encoding$channel$sca2 = encoding[channel].scale) == null ? void 0 : _encoding$channel$sca2.nice) === true) {
                      scale = scale.nice();
                    }
                  }
                }

                break;
              // All other quantitative channels

              default:
                // Default scale
                scale = d3.scaleLinear().domain(domains[channel]).range(ranges[channel]); // Nice the scale

                if (((_encoding$channel$sca3 = encoding[channel].scale) == null ? void 0 : _encoding$channel$sca3.nice) === true) {
                  scale = scale.nice();
                }

                break;
            }

            break;

          case "nominal": // TODO: Move default case here once ordinal and temporal scales are defined

          case "ordinal": // TODO: Add ordinal scales

          case "temporal": // TODO: Add temporal scales

          default:
            // Set padding inner and outer
            // Padding outer acts as padding for scalePoint
            const paddingInner = encoding[channel].scale.paddingInner;
            const paddingOuter = encoding[channel].scale.paddingOuter; // Get type of mark

            let markType = typeof view.mark !== "string" ? view.mark.type : defaults.mark.defaultType;

            switch (channel) {
              case "x":
              case "y":
              case "z":
                switch (markType) {
                  case "bar":
                    scale = d3.scaleBand().domain(domains[channel]).paddingInner(paddingInner).paddingOuter(paddingOuter).range(ranges[channel]);
                    break;

                  case "point":
                    scale = d3.scalePoint().domain(domains[channel]).padding(paddingOuter).range(ranges[channel]);
                    break;
                }

                break;

              case "color":
                let scheme = (_encoding$channel2 = encoding[channel]) == null ? void 0 : (_encoding$channel2$sc = _encoding$channel2.scale) == null ? void 0 : _encoding$channel2$sc.scheme;

                if (scheme !== undefined) {
                  if (typeof scheme === "string") {
                    // Scheme is a string
                    scale = d3.scaleOrdinal().domain(domains[channel]).range(d3[scheme]);
                  } else {
                    // Scheme is an array
                    scale = d3.scaleOrdinal().domain(domains[channel]).range(ranges[channel]);
                  }
                }

                break;

              case "shape":
                scale = d3.scaleOrdinal().domain(domains[channel]).range(ranges[channel]);
                break;

              default:
                scale = d3.scaleOrdinal().domain(domains[channel]).range(ranges[channel]);
                break;
            }

            break;
        }
      }

      scales[channel] = scale;
    });
    return scales;
  }
};

/**
 * @name compileConfig
 * @description Infers missing config values and assigns sensible defaults
 * @param userConfig A user supplied Optomancy config
 * @param transformedDatasets Transformed datasets
 * @returns {object} A compiled config
 */

const compileConfig = (config, transformedDatasets) => {
  let compiledConfig;
  let compiledScales = []; // Convert datasets object to array of datasets for compiled config
  // This will encode datasets into compiled configs though Optomancy can instead
  // refer to datasets by name (at the view level) to its internal datasets object.

  const datasets = Object.keys(transformedDatasets).map(el => ({
    name: el,
    values: [...transformedDatasets[el]]
  })); // Re-shape config into RootType config

  if (isRootType(config)) {
    // RootType config
    compiledConfig = cloneDeep(config);
  } else if (isWorkspaceType(config)) {
    // WorkspaceType config
    // Workspace configs have just one workspace and one dataset
    compiledConfig = {
      datasets: [...datasets],
      workspaces: [_extends({}, cloneDeep(config), {
        // 0th dataset (only 1 dataset for WorkspaceType configs)
        data: datasets[0].name
      })]
    };
  } else {
    // ViewType config
    compiledConfig = {
      datasets: [...datasets],
      workspaces: [_extends({
        title: config.title,
        data: datasets[0].name
      }, config.transform && {
        transform: cloneDeep(config.transform)
      }, {
        views: [_extends({}, cloneDeep(config))]
      })]
    }; // Remove data property from view config (moved to level above)

    delete compiledConfig.workspaces[0].views[0].data; // Remove transform property from view config (moved to level above, if exists)

    delete compiledConfig.workspaces[0].views[0].transform;
  }

  compiledConfig.workspaces.forEach((workspace, w) => {
    // Add workspace array to compiled scales shape
    compiledScales.push([]); // Get name of dataset as string

    let datasetName;

    if (typeof workspace.data === "string") {
      datasetName = workspace.data;
    } else {
      // FIXME: Return error:
      // Dataset name does not match known dataset
      return;
    } // The dataset associated with this workspace


    const dataset = transformedDatasets[datasetName]; // Loop over all workspaces...

    workspace.views.forEach((view, v) => {
      // TODO: Complete all inferences:
      // - Legend
      // Add view array to compiled scales shape
      compiledScales[w].push([]);

      if ((view == null ? void 0 : view.encoding) !== undefined && (view == null ? void 0 : view.layers) === undefined) {
        // This view does not have layers so only has a single encoding object
        // Create layers object
        // FIXME: The check for layers may be redundant?
        // --------------------
        // Top level view properties: See defaults.view
        let el;

        for (el in defaults.view) {
          if (view[el] === undefined) {
            compiledConfig.workspaces[w].views[v][el] = defaults.view[el];
          }
        } // --------------------
        // Mark: See defaults.mark
        // Mark type


        let markType;

        if (typeof view.mark === "object") {
          markType = view.mark.type;
        } else {
          markType = view.mark;
        } // Mark shape


        let markShape;

        if (typeof view.mark === "object") {
          markShape = view.mark.shape;
        } else {
          markShape = defaults.mark.types[markType].shape;
        } // Mark tooltip


        let markTooltip;

        if (typeof view.mark === "object") {
          if (typeof view.mark.tooltip === "object") {
            markTooltip = view.mark.tooltip;
          } else if (view.mark.tooltip === true) {
            markTooltip = defaults.mark.tooltip.on;
          }
        } else {
          markTooltip = defaults.mark.tooltip.off;
        } // Replace existing mark config with compiled mark object


        compiledConfig.workspaces[w].views[v].mark = {
          type: markType,
          shape: markShape,
          tooltip: markTooltip
        }; // --------------------
        // Ranges
        // Ranges are calculated here as subsequent inferences require ranges

        const ranges = getRanges(view); // Add channel properties
        // Object.keys(view.encoding).forEach((el) => {

        let encoding;

        for (encoding in view.encoding) {
          let channel = view.encoding[encoding]; // TODO: Throw error if channel doesn't exist

          if (channel === undefined) return; // Config encoding object

          const enc = compiledConfig.workspaces[w].views[v].encoding[encoding]; // --------------------
          // Scale object
          // Add a scale object if one does not exist

          if (channel.scale === undefined) {
            enc.scale = {};
          } // --------------------
          // Set scale range
          // Only add range if this encoding channel is not a constant
          // No layers, so we can assert the range is at position 0


          if (channel.value === undefined) {
            // TODO:
            // I don't like this, revisit the IRange | IRange[] typing
            enc.scale.range = ranges[0][encoding];
          } // --------------------
          // Scheme
          // If this is a colour scale, it should have a scheme
          // The scheme contains a named scale range or an array of colours


          if (encoding === "color") {
            var _channel$scale, _channel$scale2;

            // If a scheme is provided, validate it
            let scheme = channel == null ? void 0 : (_channel$scale = channel.scale) == null ? void 0 : _channel$scale.scheme;
            // If the range is a string but the scheme is already set, ignore range


            if (typeof (channel == null ? void 0 : (_channel$scale2 = channel.scale) == null ? void 0 : _channel$scale2.range) === "string" && scheme === undefined) {
              enc.scale.scheme = defaults.scheme[defaults.range.color[channel.type]];
            }
          } // --------------------
          // Nice
          // Nice the scale, never nice non-quantitative scales


          if (channel.type === "quantitative" && channel.scale.nice === undefined) {
            enc.scale.nice = defaults.scale.nice;
          } // --------------------
          // Zero
          // Scale starts from zero, never zero non-quantitative scales


          if (channel.type === "quantitative" && channel.scale.zero === undefined) {
            enc.scale.zero = defaults.scale.zero;
          } // Scale padding (only x, y, or z and non-quantitative fields)


          if (["x", "y", "z"].includes(encoding) && channel.type !== "quantitative") {
            var _channel$scale3, _channel$scale4;

            // --------------------
            // Padding inner
            // Sets padding inner to band scales
            if ((channel == null ? void 0 : (_channel$scale3 = channel.scale) == null ? void 0 : _channel$scale3.paddingInner) === undefined) {
              enc.scale.paddingInner = defaults.scale.paddingInner;
            } // --------------------
            // Padding outer
            // Sets padding outer to band scales, sets padding to point scales


            if ((channel == null ? void 0 : (_channel$scale4 = channel.scale) == null ? void 0 : _channel$scale4.paddingOuter) === undefined) {
              enc.scale.paddingOuter = defaults.scale.paddingOuter;
            }
          } // --------------------
          // Axis
          // Set axis properties
          // Only applies to x, y and z channels


          if (["x", "y", "z"].includes(encoding)) {
            // Add axis object if one does not exist
            if ((channel == null ? void 0 : channel.axis) === undefined) {
              enc.axis = {};
            }

            if (channel != null && channel.axis && typeof channel.axis !== "boolean" && typeof (enc == null ? void 0 : enc.axis) !== "boolean") {
              // --------------------
              // Axis title
              // Set axis title to field name if not specified
              if (channel.axis.title === undefined) {
                enc.axis.title = channel.field;
              } // --------------------
              // Axis title padding
              // Set axis title padding if not specified


              if (channel.axis.titlePadding === undefined) {
                enc.axis.titlePadding = defaults.axis.titlePadding;
              } // --------------------
              // Axis filter
              // Set axis filter on or off


              if (channel.axis.filter === undefined) {
                enc.axis.filter = defaults.axis.filter;
              } // --------------------
              // Axis face
              // Set axis face


              if (channel.axis.face === undefined) {
                enc.axis.face = defaults.axis.face[encoding];
              } // --------------------
              // Axis orient
              // Set axis orient


              if (channel.axis.orient === undefined) {
                enc.axis.orient = defaults.axis.orient[encoding];
              } // --------------------
              // Axis ticks
              // Set axis tick visibility


              if (channel.axis.ticks === undefined) {
                enc.axis.ticks = defaults.axis.ticks;
              } // --------------------
              // Axis tick count
              // Set axis tick count


              if (channel.axis.tickCount === undefined) {
                enc.axis.tickCount = defaults.axis.tickCount;
              } // --------------------
              // Axis labels
              // Set axis label visability


              if (channel.axis.labels === undefined) {
                enc.axis.labels = defaults.axis.labels;
              }
            } // --------------------
            // Legend
            // TODO: Complete legend inference

          }
        } // });
        // --------------------
        // Domains
        // Get the domain from each encoding channel in this view


        const domains = getDomains(compiledConfig.workspaces[w].views[v], dataset); // --------------------
        // Scales
        // Using domains and ranges to produce scale functions
        // These scale functions are for mapping data and are not added to the config

        const scales = createScales(compiledConfig.workspaces[w].views[v], ranges[0], // No layers: [0]
        domains);
        compiledScales[w][v].push(scales); // Scales are exported in a 3D array:
        //   view ----------------+
        //   workspace --------v  v
        //              scales[0][0].channel
        //
        // Current Example:
        //   [  &lt;------ workspaces
        //     [  &lt;---- views
        //       {  &lt;-- view
        //         x: () => {},
        //       } || [ &lt; -- TODO: layer
        //         {
        //           x: () => {},
        //         }
        //       ]
        //     ]
        //   ]
        //
        // In Progress Example:
        //   [  &lt;-------- workspaces
        //     [  &lt;------ views       (workspace[w])
        //       [  &lt;---- view        (views[w])
        //         {  &lt;-- layer       (layers[l])
        //           x: () => {},
        //         }
        //       ]
        //     ]
        //   ]
        // Add domain to compiled config
        // This is necessary because some domains will have been niced or zeroed

        Object.keys(view.encoding).forEach(el => {
          var _view$encoding;

          let channel = (_view$encoding = view.encoding) == null ? void 0 : _view$encoding[el]; // If this encoding has a field (excluding constant channels)

          if (channel.value === undefined) {
            // Add domain to compiled config
            // Indexing 0 as there is only 1 layer per view here
            compiledConfig.workspaces[w].views[v].encoding[el].scale.domain = compiledScales[w][v][0][el].domain();
          }
        });
      } else if ((view == null ? void 0 : view.layers) !== undefined) {
        // This view has layers, like onions, and ogres.
        // It has multiple encoding objects, one per layer, up to n layers.
        view.layers.forEach((layer, k) => {// TODO: Support layer compilation
          // - This should be achieved by extracting view-level compilation
          //   into a function that accepts a layer-like object and calling
          //   it here on each layer
        });
      }
    });
  });
  return {
    config: compiledConfig,
    scales: compiledScales
  };
};

// parseDatasets.ts
/**
 * @name parseDatasets
 * @description Retrieves and parses a datasets from config
 * @param config An Optomancy config object
 * @returns An object containing all datasets associated with this config
 */

const parseDatasets = config => {
  // Dataset storage object
  const datasets = {};

  if (isRootType(config)) {
    // Using RootType config
    config.datasets.map(_parseDataConfig);
  } else {
    // Using WorkspaceType or ViewType config
    _parseDataConfig(config == null ? void 0 : config.data);
  }
  /**
   * @name _parseDataConfig
   * @description Parses the data portion of config
   * @param configData Data portion of config
   * @private
   */


  function _parseDataConfig(configData) {
    if (typeof configData === "string") {
      // Data is a string
      // Check list of datasets to see if this is a reference first
      if (!datasets.hasOwnProperty(configData)) {
        // Dataset is a url
        _loadDatasetFromURL(configData);
      }
    } else {
      // Data object
      // If data object has a url and/or name
      if (configData != null && configData.url && configData != null && configData.name) {
        // Dataset is a url with a name
        // { url: 'something', name: 'something' }
        _loadDatasetFromURL(configData.url);
      } else if (configData != null && configData.url) {
        // Dataset is a url
        // { url: 'something' }
        _loadDatasetFromURL(configData.url);
      } else if (configData != null && configData.values) {
        // Dataset is a JSON array
        if (configData != null && configData.name) {
          // If a name is supplied, store with this name
          // { values: [], name: 'something' }
          datasets[configData.name] = [...configData.values];
        } else {
          // If a name is not supplied, use default
          // { values: [], name: "dataset{n}" }
          let countDatasets = Object.keys(datasets).length + 1;
          datasets[`dataset${countDatasets}`] = [...configData.values];
        }
      }
    }
  }
  /**
   * @name _loadDatasetFromURL
   * @description Load a dataset from a URL
   * @param url URL of dataset to load
   * @param name {optional} Name of dataset
   * @private
   */


  function _loadDatasetFromURL(url, name) {
    // Get file type
    url.split(".").pop().toLowerCase(); // Check if file type is supported
    // let countDatasets = Object.keys(datasets).length + 1;
    // datasets[`dataset${countDatasets}`] = [...];

  }

  return datasets;
};

// parseConfig.ts
/**
 * @name parseConfig
 * @description Parses an Optomancy config
 * @param userConfig An Optomancy config
 * @returns {object} A compiled optomancy config, datasets and scales
 */

const parseConfig = userConfig => {
  // 1) Validate config
  // TODO:
  // - Validate config before parsing
  //   Use AJV or equivalent against an Optomancy config JSON schema
  // 2) Retrieve and parse datasets
  const datasets = parseDatasets(userConfig); // 3) Apply dataset transforms

  const transformedDatasets = applyTransforms(userConfig, datasets); // 4) Infer config defaults, producing compiled config and a set of scales

  const {
    config,
    scales
  } = compileConfig(userConfig, transformedDatasets); // 5) Export transformed datasets, scales, compiled config and meta data

  return {
    datasets: transformedDatasets,
    config,
    scales
  };
};

var ConfigType = {
  __proto__: null
};

var RootType = {
  __proto__: null
};

var WorkspaceType = {
  __proto__: null
};

//type Without&lt;T, U> = { [P in Exclude&lt;keyof T, keyof U>]?: never };

var DataType = {
  __proto__: null
};

var ViewType = {
  __proto__: null
};

var LayerType = {
  __proto__: null
};

var AxisType = {
  __proto__: null
};

var ChannelType = {
  __proto__: null
};

var EncodingType = {
  __proto__: null
};

var LegendType = {
  __proto__: null
};

var MarkType = {
  __proto__: null
};

var ScaleType = {
  __proto__: null
};

var TooltipType = {
  __proto__: null
};

var TransformType = {
  __proto__: null
};

class Optomancy {
  // TODO: Check this ---------------------vvvvvvvvvvvvv
  constructor(userConfig) {
    this.userConfig = void 0;
    this.datasets = void 0;
    this.config = void 0;
    this.scales = void 0;
    this.parseConfig = void 0;
    window.d3 = d3;
    // console.log("\n*_.-'Optomancy Started'-._*\n\n");
    // console.log(`Started at: ${new Date()}`);
    this.userConfig = userConfig;
    const {
      datasets,
      config,
      scales
    } = parseConfig(this.userConfig);
    this.datasets = datasets;
    this.config = config;
    this.scales = scales;
    this.parseConfig = parseConfig;
  }

} // Optomancy Config Types

export { AxisType as Axis, ChannelType as Channel, ConfigType as Config, DataType as Data, EncodingType as Encoding, LayerType as Layer, LegendType as Legend, MarkType as Mark, Optomancy, RootType as Root, ScaleType as Scale, TooltipType as Tooltip, TransformType as Transform, ViewType as View, WorkspaceType as Workspace };
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" id="optomancy-r3f-lib" name="Optomancy R3F">import { jsx, jsxs, Fragment as JSXFragment } from "react/jsx-runtime";
import { Optomancy } from "#optomancy-lib";
import { useFrame, extend } from "@react-three/fiber";
import * as THREE from "three";
import { UniformsUtils, MeshDepthMaterial, RGBADepthPacking, MeshDistanceMaterial, ShaderChunk, Mesh, FrontSide, Color, Vector2, Texture, LinearFilter, InstancedBufferGeometry, Sphere, Box3, BackSide, DoubleSide, InstancedBufferAttribute, Vector4, Matrix3, MeshBasicMaterial, Matrix4, Vector3, PlaneGeometry, BufferGeometry, Float32BufferAttribute } from "three";
import React, { useContext, useRef } from "react";
import { Text as Text$1 } from "@react-three/drei";
import { useInteraction } from "@react-three/xr";
function workerBootstrap() {
  var modules = /* @__PURE__ */ Object.create(null);
  function registerModule(ref, callback) {
    var id = ref.id;
    var name = ref.name;
    var dependencies = ref.dependencies;
    if (dependencies === void 0)
      dependencies = [];
    var init = ref.init;
    if (init === void 0)
      init = function() {
      };
    var getTransferables = ref.getTransferables;
    if (getTransferables === void 0)
      getTransferables = null;
    if (modules[id]) {
      return;
    }
    try {
      dependencies = dependencies.map(function(dep) {
        if (dep && dep.isWorkerModule) {
          registerModule(dep, function(depResult) {
            if (depResult instanceof Error) {
              throw depResult;
            }
          });
          dep = modules[dep.id].value;
        }
        return dep;
      });
      init = rehydrate("&lt;" + name + ">.init", init);
      if (getTransferables) {
        getTransferables = rehydrate("&lt;" + name + ">.getTransferables", getTransferables);
      }
      var value = null;
      if (typeof init === "function") {
        value = init.apply(void 0, dependencies);
      } else {
        console.error("worker module init function failed to rehydrate");
      }
      modules[id] = {
        id,
        value,
        getTransferables
      };
      callback(value);
    } catch (err) {
      if (!(err && err.noLog)) {
        console.error(err);
      }
      callback(err);
    }
  }
  function callModule(ref, callback) {
    var ref$1;
    var id = ref.id;
    var args = ref.args;
    if (!modules[id] || typeof modules[id].value !== "function") {
      callback(new Error("Worker module " + id + ": not found or its 'init' did not return a function"));
    }
    try {
      var result = (ref$1 = modules[id]).value.apply(ref$1, args);
      if (result && typeof result.then === "function") {
        result.then(handleResult, function(rej) {
          return callback(rej instanceof Error ? rej : new Error("" + rej));
        });
      } else {
        handleResult(result);
      }
    } catch (err) {
      callback(err);
    }
    function handleResult(result2) {
      try {
        var tx = modules[id].getTransferables && modules[id].getTransferables(result2);
        if (!tx || !Array.isArray(tx) || !tx.length) {
          tx = void 0;
        }
        callback(result2, tx);
      } catch (err) {
        console.error(err);
        callback(err);
      }
    }
  }
  function rehydrate(name, str) {
    var result = void 0;
    self.troikaDefine = function(r) {
      return result = r;
    };
    var url = URL.createObjectURL(
      new Blob(
        ["/** " + name.replace(/\*/g, "") + " **/\n\ntroikaDefine(\n" + str + "\n)"],
        { type: "application/javascript" }
      )
    );
    try {
      importScripts(url);
    } catch (err) {
      console.error(err);
    }
    URL.revokeObjectURL(url);
    delete self.troikaDefine;
    return result;
  }
  self.addEventListener("message", function(e) {
    var ref = e.data;
    var messageId = ref.messageId;
    var action = ref.action;
    var data = ref.data;
    try {
      if (action === "registerModule") {
        registerModule(data, function(result) {
          if (result instanceof Error) {
            postMessage({
              messageId,
              success: false,
              error: result.message
            });
          } else {
            postMessage({
              messageId,
              success: true,
              result: { isCallable: typeof result === "function" }
            });
          }
        });
      }
      if (action === "callModule") {
        callModule(data, function(result, transferables) {
          if (result instanceof Error) {
            postMessage({
              messageId,
              success: false,
              error: result.message
            });
          } else {
            postMessage({
              messageId,
              success: true,
              result
            }, transferables || void 0);
          }
        });
      }
    } catch (err) {
      postMessage({
        messageId,
        success: false,
        error: err.stack
      });
    }
  });
}
function defineMainThreadModule(options) {
  var moduleFunc = function() {
    var args = [], len = arguments.length;
    while (len--)
      args[len] = arguments[len];
    return moduleFunc._getInitResult().then(function(initResult) {
      if (typeof initResult === "function") {
        return initResult.apply(void 0, args);
      } else {
        throw new Error("Worker module function was called but `init` did not return a callable function");
      }
    });
  };
  moduleFunc._getInitResult = function() {
    var dependencies = options.dependencies;
    var init = options.init;
    dependencies = Array.isArray(dependencies) ? dependencies.map(
      function(dep) {
        return dep && dep._getInitResult ? dep._getInitResult() : dep;
      }
    ) : [];
    var initPromise = Promise.all(dependencies).then(function(deps) {
      return init.apply(null, deps);
    });
    moduleFunc._getInitResult = function() {
      return initPromise;
    };
    return initPromise;
  };
  return moduleFunc;
}
var supportsWorkers = function() {
  var supported = false;
  if (typeof window !== "undefined" && typeof window.document !== "undefined") {
    try {
      var worker = new Worker(
        URL.createObjectURL(new Blob([""], { type: "application/javascript" }))
      );
      worker.terminate();
      supported = true;
    } catch (err) {
      if (typeof process !== "undefined" && process.env.NODE_ENV === "test")
        ;
      else {
        console.log(
          "Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: [" + err.message + "]"
        );
      }
    }
  }
  supportsWorkers = function() {
    return supported;
  };
  return supported;
};
var _workerModuleId = 0;
var _messageId = 0;
var _allowInitAsString = false;
var workers = /* @__PURE__ */ Object.create(null);
var registeredModules = /* @__PURE__ */ Object.create(null);
var openRequests = /* @__PURE__ */ Object.create(null);
function defineWorkerModule(options) {
  if ((!options || typeof options.init !== "function") && !_allowInitAsString) {
    throw new Error("requires `options.init` function");
  }
  var dependencies = options.dependencies;
  var init = options.init;
  var getTransferables = options.getTransferables;
  var workerId = options.workerId;
  if (!supportsWorkers()) {
    return defineMainThreadModule(options);
  }
  if (workerId == null) {
    workerId = "#default";
  }
  var id = "workerModule" + ++_workerModuleId;
  var name = options.name || id;
  var registrationPromise = null;
  dependencies = dependencies && dependencies.map(function(dep) {
    if (typeof dep === "function" && !dep.workerModuleData) {
      _allowInitAsString = true;
      dep = defineWorkerModule({
        workerId,
        name: "&lt;" + name + "> function dependency: " + dep.name,
        init: "function(){return (\n" + stringifyFunction(dep) + "\n)}"
      });
      _allowInitAsString = false;
    }
    if (dep && dep.workerModuleData) {
      dep = dep.workerModuleData;
    }
    return dep;
  });
  function moduleFunc() {
    var args = [], len = arguments.length;
    while (len--)
      args[len] = arguments[len];
    if (!registrationPromise) {
      registrationPromise = callWorker(workerId, "registerModule", moduleFunc.workerModuleData);
      var unregister = function() {
        registrationPromise = null;
        registeredModules[workerId].delete(unregister);
      };
      (registeredModules[workerId] || (registeredModules[workerId] = /* @__PURE__ */ new Set())).add(unregister);
    }
    return registrationPromise.then(function(ref) {
      var isCallable = ref.isCallable;
      if (isCallable) {
        return callWorker(workerId, "callModule", { id, args });
      } else {
        throw new Error("Worker module function was called but `init` did not return a callable function");
      }
    });
  }
  moduleFunc.workerModuleData = {
    isWorkerModule: true,
    id,
    name,
    dependencies,
    init: stringifyFunction(init),
    getTransferables: getTransferables && stringifyFunction(getTransferables)
  };
  return moduleFunc;
}
function terminateWorker(workerId) {
  if (registeredModules[workerId]) {
    registeredModules[workerId].forEach(function(unregister) {
      unregister();
    });
  }
  if (workers[workerId]) {
    workers[workerId].terminate();
    delete workers[workerId];
  }
}
function stringifyFunction(fn) {
  var str = fn.toString();
  if (!/^function/.test(str) && /^\w+\s*\(/.test(str)) {
    str = "function " + str;
  }
  return str;
}
function getWorker(workerId) {
  var worker = workers[workerId];
  if (!worker) {
    var bootstrap = stringifyFunction(workerBootstrap);
    worker = workers[workerId] = new Worker(
      URL.createObjectURL(
        new Blob(
          ["/** Worker Module Bootstrap: " + workerId.replace(/\*/g, "") + " **/\n\n;(" + bootstrap + ")()"],
          { type: "application/javascript" }
        )
      )
    );
    worker.onmessage = function(e) {
      var response = e.data;
      var msgId = response.messageId;
      var callback = openRequests[msgId];
      if (!callback) {
        throw new Error("WorkerModule response with empty or unknown messageId");
      }
      delete openRequests[msgId];
      callback(response);
    };
  }
  return worker;
}
function callWorker(workerId, action, data) {
  return new Promise(function(resolve, reject) {
    var messageId = ++_messageId;
    openRequests[messageId] = function(response) {
      if (response.success) {
        resolve(response.result);
      } else {
        reject(new Error("Error in worker " + action + " call: " + response.error));
      }
    };
    getWorker(workerId).postMessage({
      messageId,
      action,
      data
    });
  });
}
function SDFGenerator() {
  var exports = function(exports2) {
    function pointOnQuadraticBezier(x0, y0, x1, y1, x2, y2, t, pointOut) {
      var t2 = 1 - t;
      pointOut.x = t2 * t2 * x0 + 2 * t2 * t * x1 + t * t * x2;
      pointOut.y = t2 * t2 * y0 + 2 * t2 * t * y1 + t * t * y2;
    }
    function pointOnCubicBezier(x0, y0, x1, y1, x2, y2, x3, y3, t, pointOut) {
      var t2 = 1 - t;
      pointOut.x = t2 * t2 * t2 * x0 + 3 * t2 * t2 * t * x1 + 3 * t2 * t * t * x2 + t * t * t * x3;
      pointOut.y = t2 * t2 * t2 * y0 + 3 * t2 * t2 * t * y1 + 3 * t2 * t * t * y2 + t * t * t * y3;
    }
    function forEachPathCommand(pathString, commandCallback) {
      var segmentRE = /([MLQCZ])([^MLQCZ]*)/g;
      var match, firstX, firstY, prevX, prevY;
      while (match = segmentRE.exec(pathString)) {
        var args = match[2].replace(/^\s*|\s*$/g, "").split(/[,\s]+/).map(function(v) {
          return parseFloat(v);
        });
        switch (match[1]) {
          case "M":
            prevX = firstX = args[0];
            prevY = firstY = args[1];
            break;
          case "L":
            if (args[0] !== prevX || args[1] !== prevY) {
              commandCallback("L", prevX, prevY, prevX = args[0], prevY = args[1]);
            }
            break;
          case "Q": {
            commandCallback("Q", prevX, prevY, prevX = args[2], prevY = args[3], args[0], args[1]);
            break;
          }
          case "C": {
            commandCallback("C", prevX, prevY, prevX = args[4], prevY = args[5], args[0], args[1], args[2], args[3]);
            break;
          }
          case "Z":
            if (prevX !== firstX || prevY !== firstY) {
              commandCallback("L", prevX, prevY, firstX, firstY);
            }
            break;
        }
      }
    }
    function pathToLineSegments(pathString, segmentCallback, curvePoints) {
      if (curvePoints === void 0)
        curvePoints = 16;
      var tempPoint = { x: 0, y: 0 };
      forEachPathCommand(pathString, function(command, startX, startY, endX, endY, ctrl1X, ctrl1Y, ctrl2X, ctrl2Y) {
        switch (command) {
          case "L":
            segmentCallback(startX, startY, endX, endY);
            break;
          case "Q": {
            var prevCurveX = startX;
            var prevCurveY = startY;
            for (var i = 1; i &lt; curvePoints; i++) {
              pointOnQuadraticBezier(
                startX,
                startY,
                ctrl1X,
                ctrl1Y,
                endX,
                endY,
                i / (curvePoints - 1),
                tempPoint
              );
              segmentCallback(prevCurveX, prevCurveY, tempPoint.x, tempPoint.y);
              prevCurveX = tempPoint.x;
              prevCurveY = tempPoint.y;
            }
            break;
          }
          case "C": {
            var prevCurveX$1 = startX;
            var prevCurveY$1 = startY;
            for (var i$1 = 1; i$1 &lt; curvePoints; i$1++) {
              pointOnCubicBezier(
                startX,
                startY,
                ctrl1X,
                ctrl1Y,
                ctrl2X,
                ctrl2Y,
                endX,
                endY,
                i$1 / (curvePoints - 1),
                tempPoint
              );
              segmentCallback(prevCurveX$1, prevCurveY$1, tempPoint.x, tempPoint.y);
              prevCurveX$1 = tempPoint.x;
              prevCurveY$1 = tempPoint.y;
            }
            break;
          }
        }
      });
    }
    var viewportQuadVertex = "precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}";
    var copyTexFragment = "precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}";
    var cache = /* @__PURE__ */ new WeakMap();
    var glContextParams = {
      premultipliedAlpha: false,
      preserveDrawingBuffer: true,
      antialias: false,
      depth: false
    };
    function withWebGLContext(glOrCanvas, callback) {
      var gl = glOrCanvas.getContext ? glOrCanvas.getContext("webgl", glContextParams) : glOrCanvas;
      var wrapper = cache.get(gl);
      if (!wrapper) {
        let getExtension = function(name) {
          var ext = extensions[name];
          if (!ext) {
            ext = extensions[name] = gl.getExtension(name);
            if (!ext) {
              throw new Error(name + " not supported");
            }
          }
          return ext;
        }, compileShader = function(src, type) {
          var shader = gl.createShader(type);
          gl.shaderSource(shader, src);
          gl.compileShader(shader);
          return shader;
        }, withProgram = function(name, vert, frag, func) {
          if (!programs[name]) {
            var attributes = {};
            var uniforms = {};
            var program = gl.createProgram();
            gl.attachShader(program, compileShader(vert, gl.VERTEX_SHADER));
            gl.attachShader(program, compileShader(frag, gl.FRAGMENT_SHADER));
            gl.linkProgram(program);
            programs[name] = {
              program,
              transaction: function transaction(func2) {
                gl.useProgram(program);
                func2({
                  setUniform: function setUniform(type, name2) {
                    var values = [], len = arguments.length - 2;
                    while (len-- > 0)
                      values[len] = arguments[len + 2];
                    var uniformLoc = uniforms[name2] || (uniforms[name2] = gl.getUniformLocation(program, name2));
                    gl["uniform" + type].apply(gl, [uniformLoc].concat(values));
                  },
                  setAttribute: function setAttribute(name2, size, usage, instancingDivisor, data) {
                    var attr = attributes[name2];
                    if (!attr) {
                      attr = attributes[name2] = {
                        buf: gl.createBuffer(),
                        // TODO should we destroy our buffers?
                        loc: gl.getAttribLocation(program, name2),
                        data: null
                      };
                    }
                    gl.bindBuffer(gl.ARRAY_BUFFER, attr.buf);
                    gl.vertexAttribPointer(attr.loc, size, gl.FLOAT, false, 0, 0);
                    gl.enableVertexAttribArray(attr.loc);
                    if (isWebGL2) {
                      gl.vertexAttribDivisor(attr.loc, instancingDivisor);
                    } else {
                      getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(attr.loc, instancingDivisor);
                    }
                    if (data !== attr.data) {
                      gl.bufferData(gl.ARRAY_BUFFER, data, usage);
                      attr.data = data;
                    }
                  }
                });
              }
            };
          }
          programs[name].transaction(func);
        }, withTexture = function(name, func) {
          textureUnit++;
          try {
            gl.activeTexture(gl.TEXTURE0 + textureUnit);
            var texture = textures[name];
            if (!texture) {
              texture = textures[name] = gl.createTexture();
              gl.bindTexture(gl.TEXTURE_2D, texture);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
            }
            gl.bindTexture(gl.TEXTURE_2D, texture);
            func(texture, textureUnit);
          } finally {
            textureUnit--;
          }
        }, withTextureFramebuffer = function(texture, textureUnit2, func) {
          var framebuffer = gl.createFramebuffer();
          framebufferStack.push(framebuffer);
          gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
          gl.activeTexture(gl.TEXTURE0 + textureUnit2);
          gl.bindTexture(gl.TEXTURE_2D, texture);
          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
          try {
            func(framebuffer);
          } finally {
            gl.deleteFramebuffer(framebuffer);
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebufferStack[--framebufferStack.length - 1] || null);
          }
        }, handleContextLoss = function() {
          extensions = {};
          programs = {};
          textures = {};
          textureUnit = -1;
          framebufferStack.length = 0;
        };
        var isWebGL2 = typeof WebGL2RenderingContext !== "undefined" && gl instanceof WebGL2RenderingContext;
        var extensions = {};
        var programs = {};
        var textures = {};
        var textureUnit = -1;
        var framebufferStack = [];
        gl.canvas.addEventListener("webglcontextlost", function(e) {
          handleContextLoss();
          e.preventDefault();
        }, false);
        cache.set(gl, wrapper = {
          gl,
          isWebGL2,
          getExtension,
          withProgram,
          withTexture,
          withTextureFramebuffer,
          handleContextLoss
        });
      }
      callback(wrapper);
    }
    function renderImageData(glOrCanvas, imageData, x, y, width, height, channels, framebuffer) {
      if (channels === void 0)
        channels = 15;
      if (framebuffer === void 0)
        framebuffer = null;
      withWebGLContext(glOrCanvas, function(ref) {
        var gl = ref.gl;
        var withProgram = ref.withProgram;
        var withTexture = ref.withTexture;
        withTexture("copy", function(tex, texUnit) {
          gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, imageData);
          withProgram("copy", viewportQuadVertex, copyTexFragment, function(ref2) {
            var setUniform = ref2.setUniform;
            var setAttribute = ref2.setAttribute;
            setAttribute("aUV", 2, gl.STATIC_DRAW, 0, new Float32Array([0, 0, 2, 0, 0, 2]));
            setUniform("1i", "image", texUnit);
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer || null);
            gl.disable(gl.BLEND);
            gl.colorMask(channels & 8, channels & 4, channels & 2, channels & 1);
            gl.viewport(x, y, width, height);
            gl.scissor(x, y, width, height);
            gl.drawArrays(gl.TRIANGLES, 0, 3);
          });
        });
      });
    }
    function resizeWebGLCanvasWithoutClearing2(canvas, newWidth, newHeight) {
      var width = canvas.width;
      var height = canvas.height;
      withWebGLContext(canvas, function(ref) {
        var gl = ref.gl;
        var data = new Uint8Array(width * height * 4);
        gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, data);
        canvas.width = newWidth;
        canvas.height = newHeight;
        renderImageData(gl, data, 0, 0, width, height);
      });
    }
    var webglUtils = /* @__PURE__ */ Object.freeze({
      __proto__: null,
      withWebGLContext,
      renderImageData,
      resizeWebGLCanvasWithoutClearing: resizeWebGLCanvasWithoutClearing2
    });
    function generate$2(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      var textureData = new Uint8Array(sdfWidth * sdfHeight);
      var viewBoxWidth = viewBox[2] - viewBox[0];
      var viewBoxHeight = viewBox[3] - viewBox[1];
      var segments = [];
      pathToLineSegments(path, function(x1, y1, x2, y2) {
        segments.push({
          x1,
          y1,
          x2,
          y2,
          minX: Math.min(x1, x2),
          minY: Math.min(y1, y2),
          maxX: Math.max(x1, x2),
          maxY: Math.max(y1, y2)
        });
      });
      segments.sort(function(a, b) {
        return a.maxX - b.maxX;
      });
      for (var sdfX = 0; sdfX &lt; sdfWidth; sdfX++) {
        for (var sdfY = 0; sdfY &lt; sdfHeight; sdfY++) {
          var signedDist = findNearestSignedDistance(
            viewBox[0] + viewBoxWidth * (sdfX + 0.5) / sdfWidth,
            viewBox[1] + viewBoxHeight * (sdfY + 0.5) / sdfHeight
          );
          var alpha = Math.pow(1 - Math.abs(signedDist) / maxDistance, sdfExponent) / 2;
          if (signedDist &lt; 0) {
            alpha = 1 - alpha;
          }
          alpha = Math.max(0, Math.min(255, Math.round(alpha * 255)));
          textureData[sdfY * sdfWidth + sdfX] = alpha;
        }
      }
      return textureData;
      function findNearestSignedDistance(x, y) {
        var closestDistSq = Infinity;
        var closestDist = Infinity;
        for (var i = segments.length; i--; ) {
          var seg = segments[i];
          if (seg.maxX + closestDist &lt;= x) {
            break;
          }
          if (x + closestDist > seg.minX && y - closestDist &lt; seg.maxY && y + closestDist > seg.minY) {
            var distSq = absSquareDistanceToLineSegment(x, y, seg.x1, seg.y1, seg.x2, seg.y2);
            if (distSq &lt; closestDistSq) {
              closestDistSq = distSq;
              closestDist = Math.sqrt(closestDistSq);
            }
          }
        }
        if (isPointInPoly(x, y)) {
          closestDist = -closestDist;
        }
        return closestDist;
      }
      function isPointInPoly(x, y) {
        var winding = 0;
        for (var i = segments.length; i--; ) {
          var seg = segments[i];
          if (seg.maxX &lt;= x) {
            break;
          }
          var intersects = seg.y1 > y !== seg.y2 > y && x &lt; (seg.x2 - seg.x1) * (y - seg.y1) / (seg.y2 - seg.y1) + seg.x1;
          if (intersects) {
            winding += seg.y1 &lt; seg.y2 ? 1 : -1;
          }
        }
        return winding !== 0;
      }
    }
    function generateIntoCanvas$2(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, canvas, x, y, channel) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (x === void 0)
        x = 0;
      if (y === void 0)
        y = 0;
      if (channel === void 0)
        channel = 0;
      generateIntoFramebuffer$1(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, canvas, null, x, y, channel);
    }
    function generateIntoFramebuffer$1(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, glOrCanvas, framebuffer, x, y, channel) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (x === void 0)
        x = 0;
      if (y === void 0)
        y = 0;
      if (channel === void 0)
        channel = 0;
      var data = generate$2(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent);
      var rgbaData = new Uint8Array(data.length * 4);
      for (var i = 0; i &lt; data.length; i++) {
        rgbaData[i * 4 + channel] = data[i];
      }
      renderImageData(glOrCanvas, rgbaData, x, y, sdfWidth, sdfHeight, 1 &lt;&lt; 3 - channel, framebuffer);
    }
    function absSquareDistanceToLineSegment(x, y, lineX0, lineY0, lineX1, lineY1) {
      var ldx = lineX1 - lineX0;
      var ldy = lineY1 - lineY0;
      var lengthSq = ldx * ldx + ldy * ldy;
      var t = lengthSq ? Math.max(0, Math.min(1, ((x - lineX0) * ldx + (y - lineY0) * ldy) / lengthSq)) : 0;
      var dx = x - (lineX0 + t * ldx);
      var dy = y - (lineY0 + t * ldy);
      return dx * dx + dy * dy;
    }
    var javascript = /* @__PURE__ */ Object.freeze({
      __proto__: null,
      generate: generate$2,
      generateIntoCanvas: generateIntoCanvas$2,
      generateIntoFramebuffer: generateIntoFramebuffer$1
    });
    var mainVertex = "precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}";
    var mainFragment = "precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x&lt;(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y&lt;vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}";
    var postFragment = "precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}";
    var viewportUVs = new Float32Array([0, 0, 2, 0, 0, 2]);
    var implicitContext = null;
    var isTestingSupport = false;
    var NULL_OBJECT = {};
    var supportByCanvas = /* @__PURE__ */ new WeakMap();
    function validateSupport(glOrCanvas) {
      if (!isTestingSupport && !isSupported(glOrCanvas)) {
        throw new Error("WebGL generation not supported");
      }
    }
    function generate$1(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, glOrCanvas) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (glOrCanvas === void 0)
        glOrCanvas = null;
      if (!glOrCanvas) {
        glOrCanvas = implicitContext;
        if (!glOrCanvas) {
          var canvas = typeof OffscreenCanvas === "function" ? new OffscreenCanvas(1, 1) : typeof document !== "undefined" ? document.createElement("canvas") : null;
          if (!canvas) {
            throw new Error("OffscreenCanvas or DOM canvas not supported");
          }
          glOrCanvas = implicitContext = canvas.getContext("webgl", { depth: false });
        }
      }
      validateSupport(glOrCanvas);
      var rgbaData = new Uint8Array(sdfWidth * sdfHeight * 4);
      withWebGLContext(glOrCanvas, function(ref) {
        var gl = ref.gl;
        var withTexture = ref.withTexture;
        var withTextureFramebuffer = ref.withTextureFramebuffer;
        withTexture("readable", function(texture, textureUnit) {
          gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, sdfWidth, sdfHeight, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
          withTextureFramebuffer(texture, textureUnit, function(framebuffer) {
            generateIntoFramebuffer(
              sdfWidth,
              sdfHeight,
              path,
              viewBox,
              maxDistance,
              sdfExponent,
              gl,
              framebuffer,
              0,
              0,
              0
              // red channel
            );
            gl.readPixels(0, 0, sdfWidth, sdfHeight, gl.RGBA, gl.UNSIGNED_BYTE, rgbaData);
          });
        });
      });
      var data = new Uint8Array(sdfWidth * sdfHeight);
      for (var i = 0, j = 0; i &lt; rgbaData.length; i += 4) {
        data[j++] = rgbaData[i];
      }
      return data;
    }
    function generateIntoCanvas$1(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, canvas, x, y, channel) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (x === void 0)
        x = 0;
      if (y === void 0)
        y = 0;
      if (channel === void 0)
        channel = 0;
      generateIntoFramebuffer(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, canvas, null, x, y, channel);
    }
    function generateIntoFramebuffer(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, glOrCanvas, framebuffer, x, y, channel) {
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (x === void 0)
        x = 0;
      if (y === void 0)
        y = 0;
      if (channel === void 0)
        channel = 0;
      validateSupport(glOrCanvas);
      var lineSegmentCoords = [];
      pathToLineSegments(path, function(x1, y1, x2, y2) {
        lineSegmentCoords.push(x1, y1, x2, y2);
      });
      lineSegmentCoords = new Float32Array(lineSegmentCoords);
      withWebGLContext(glOrCanvas, function(ref) {
        var gl = ref.gl;
        var isWebGL2 = ref.isWebGL2;
        var getExtension = ref.getExtension;
        var withProgram = ref.withProgram;
        var withTexture = ref.withTexture;
        var withTextureFramebuffer = ref.withTextureFramebuffer;
        var handleContextLoss = ref.handleContextLoss;
        withTexture("rawDistances", function(intermediateTexture, intermediateTextureUnit) {
          if (sdfWidth !== intermediateTexture._lastWidth || sdfHeight !== intermediateTexture._lastHeight) {
            gl.texImage2D(
              gl.TEXTURE_2D,
              0,
              gl.RGBA,
              intermediateTexture._lastWidth = sdfWidth,
              intermediateTexture._lastHeight = sdfHeight,
              0,
              gl.RGBA,
              gl.UNSIGNED_BYTE,
              null
            );
          }
          withProgram("main", mainVertex, mainFragment, function(ref2) {
            var setAttribute = ref2.setAttribute;
            var setUniform = ref2.setUniform;
            var instancingExtension = !isWebGL2 && getExtension("ANGLE_instanced_arrays");
            var blendMinMaxExtension = !isWebGL2 && getExtension("EXT_blend_minmax");
            setAttribute("aUV", 2, gl.STATIC_DRAW, 0, viewportUVs);
            setAttribute("aLineSegment", 4, gl.DYNAMIC_DRAW, 1, lineSegmentCoords);
            setUniform.apply(void 0, ["4f", "uGlyphBounds"].concat(viewBox));
            setUniform("1f", "uMaxDistance", maxDistance);
            setUniform("1f", "uExponent", sdfExponent);
            withTextureFramebuffer(intermediateTexture, intermediateTextureUnit, function(framebuffer2) {
              gl.enable(gl.BLEND);
              gl.colorMask(true, true, true, true);
              gl.viewport(0, 0, sdfWidth, sdfHeight);
              gl.scissor(0, 0, sdfWidth, sdfHeight);
              gl.blendFunc(gl.ONE, gl.ONE);
              gl.blendEquationSeparate(gl.FUNC_ADD, isWebGL2 ? gl.MAX : blendMinMaxExtension.MAX_EXT);
              gl.clear(gl.COLOR_BUFFER_BIT);
              if (isWebGL2) {
                gl.drawArraysInstanced(gl.TRIANGLES, 0, 3, lineSegmentCoords.length / 4);
              } else {
                instancingExtension.drawArraysInstancedANGLE(gl.TRIANGLES, 0, 3, lineSegmentCoords.length / 4);
              }
            });
          });
          withProgram("post", viewportQuadVertex, postFragment, function(program) {
            program.setAttribute("aUV", 2, gl.STATIC_DRAW, 0, viewportUVs);
            program.setUniform("1i", "tex", intermediateTextureUnit);
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
            gl.disable(gl.BLEND);
            gl.colorMask(channel === 0, channel === 1, channel === 2, channel === 3);
            gl.viewport(x, y, sdfWidth, sdfHeight);
            gl.scissor(x, y, sdfWidth, sdfHeight);
            gl.drawArrays(gl.TRIANGLES, 0, 3);
          });
        });
        if (gl.isContextLost()) {
          handleContextLoss();
          throw new Error("webgl context lost");
        }
      });
    }
    function isSupported(glOrCanvas) {
      var key = !glOrCanvas || glOrCanvas === implicitContext ? NULL_OBJECT : glOrCanvas.canvas || glOrCanvas;
      var supported = supportByCanvas.get(key);
      if (supported === void 0) {
        isTestingSupport = true;
        var failReason = null;
        try {
          var expectedResult = [
            97,
            106,
            97,
            61,
            99,
            137,
            118,
            80,
            80,
            118,
            137,
            99,
            61,
            97,
            106,
            97
          ];
          var testResult = generate$1(
            4,
            4,
            "M8,8L16,8L24,24L16,24Z",
            [0, 0, 32, 32],
            24,
            1,
            glOrCanvas
          );
          supported = testResult && expectedResult.length === testResult.length && testResult.every(function(val, i) {
            return val === expectedResult[i];
          });
          if (!supported) {
            failReason = "bad trial run results";
            console.info(expectedResult, testResult);
          }
        } catch (err) {
          supported = false;
          failReason = err.message;
        }
        if (failReason) {
          console.warn("WebGL SDF generation not supported:", failReason);
        }
        isTestingSupport = false;
        supportByCanvas.set(key, supported);
      }
      return supported;
    }
    var webgl = /* @__PURE__ */ Object.freeze({
      __proto__: null,
      generate: generate$1,
      generateIntoCanvas: generateIntoCanvas$1,
      generateIntoFramebuffer,
      isSupported
    });
    function generate(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent) {
      if (maxDistance === void 0)
        maxDistance = Math.max(viewBox[2] - viewBox[0], viewBox[3] - viewBox[1]) / 2;
      if (sdfExponent === void 0)
        sdfExponent = 1;
      try {
        return generate$1.apply(webgl, arguments);
      } catch (e) {
        console.info("WebGL SDF generation failed, falling back to JS", e);
        return generate$2.apply(javascript, arguments);
      }
    }
    function generateIntoCanvas(sdfWidth, sdfHeight, path, viewBox, maxDistance, sdfExponent, canvas, x, y, channel) {
      if (maxDistance === void 0)
        maxDistance = Math.max(viewBox[2] - viewBox[0], viewBox[3] - viewBox[1]) / 2;
      if (sdfExponent === void 0)
        sdfExponent = 1;
      if (x === void 0)
        x = 0;
      if (y === void 0)
        y = 0;
      if (channel === void 0)
        channel = 0;
      try {
        return generateIntoCanvas$1.apply(webgl, arguments);
      } catch (e) {
        console.info("WebGL SDF generation failed, falling back to JS", e);
        return generateIntoCanvas$2.apply(javascript, arguments);
      }
    }
    exports2.forEachPathCommand = forEachPathCommand;
    exports2.generate = generate;
    exports2.generateIntoCanvas = generateIntoCanvas;
    exports2.javascript = javascript;
    exports2.pathToLineSegments = pathToLineSegments;
    exports2.webgl = webgl;
    exports2.webglUtils = webglUtils;
    Object.defineProperty(exports2, "__esModule", { value: true });
    return exports2;
  }({});
  return exports;
}
function bidiFactory() {
  var bidi = function(exports) {
    var DATA = {
      "R": "13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",
      "EN": "1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",
      "ES": "17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",
      "ET": "z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",
      "AN": "16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",
      "CS": "18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",
      "B": "a,3,f+2,2v,690",
      "S": "9,2,k",
      "WS": "c,k,4f4,1vk+a,u,1j,335",
      "ON": "x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",
      "BN": "0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",
      "NSM": "lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",
      "AL": "16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",
      "LRO": "6ct",
      "RLO": "6cu",
      "LRE": "6cq",
      "RLE": "6cr",
      "PDF": "6cs",
      "LRI": "6ee",
      "RLI": "6ef",
      "FSI": "6eg",
      "PDI": "6eh"
    };
    var TYPES = {};
    var TYPES_TO_NAMES = {};
    TYPES.L = 1;
    TYPES_TO_NAMES[1] = "L";
    Object.keys(DATA).forEach(function(type, i) {
      TYPES[type] = 1 &lt;&lt; i + 1;
      TYPES_TO_NAMES[TYPES[type]] = type;
    });
    Object.freeze(TYPES);
    var ISOLATE_INIT_TYPES = TYPES.LRI | TYPES.RLI | TYPES.FSI;
    var STRONG_TYPES = TYPES.L | TYPES.R | TYPES.AL;
    var NEUTRAL_ISOLATE_TYPES = TYPES.B | TYPES.S | TYPES.WS | TYPES.ON | TYPES.FSI | TYPES.LRI | TYPES.RLI | TYPES.PDI;
    var BN_LIKE_TYPES = TYPES.BN | TYPES.RLE | TYPES.LRE | TYPES.RLO | TYPES.LRO | TYPES.PDF;
    var TRAILING_TYPES = TYPES.S | TYPES.WS | TYPES.B | ISOLATE_INIT_TYPES | TYPES.PDI | BN_LIKE_TYPES;
    var map = null;
    function parseData() {
      if (!map) {
        map = /* @__PURE__ */ new Map();
        var loop = function(type2) {
          if (DATA.hasOwnProperty(type2)) {
            var lastCode = 0;
            DATA[type2].split(",").forEach(function(range) {
              var ref = range.split("+");
              var skip = ref[0];
              var step = ref[1];
              skip = parseInt(skip, 36);
              step = step ? parseInt(step, 36) : 0;
              map.set(lastCode += skip, TYPES[type2]);
              for (var i = 0; i &lt; step; i++) {
                map.set(++lastCode, TYPES[type2]);
              }
            });
          }
        };
        for (var type in DATA)
          loop(type);
      }
    }
    function getBidiCharType(char) {
      parseData();
      return map.get(char.codePointAt(0)) || TYPES.L;
    }
    function getBidiCharTypeName(char) {
      return TYPES_TO_NAMES[getBidiCharType(char)];
    }
    var data$1 = {
      "pairs": "14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",
      "canonical": "6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"
    };
    function parseCharacterMap(encodedString, includeReverse) {
      var radix = 36;
      var lastCode = 0;
      var map2 = /* @__PURE__ */ new Map();
      var reverseMap = includeReverse && /* @__PURE__ */ new Map();
      var prevPair;
      encodedString.split(",").forEach(function visit(entry) {
        if (entry.indexOf("+") !== -1) {
          for (var i = +entry; i--; ) {
            visit(prevPair);
          }
        } else {
          prevPair = entry;
          var ref = entry.split(">");
          var a = ref[0];
          var b = ref[1];
          a = String.fromCodePoint(lastCode += parseInt(a, radix));
          b = String.fromCodePoint(lastCode += parseInt(b, radix));
          map2.set(a, b);
          includeReverse && reverseMap.set(b, a);
        }
      });
      return { map: map2, reverseMap };
    }
    var openToClose, closeToOpen, canonical;
    function parse$1() {
      if (!openToClose) {
        var ref = parseCharacterMap(data$1.pairs, true);
        var map2 = ref.map;
        var reverseMap = ref.reverseMap;
        openToClose = map2;
        closeToOpen = reverseMap;
        canonical = parseCharacterMap(data$1.canonical, false).map;
      }
    }
    function openingToClosingBracket(char) {
      parse$1();
      return openToClose.get(char) || null;
    }
    function closingToOpeningBracket(char) {
      parse$1();
      return closeToOpen.get(char) || null;
    }
    function getCanonicalBracket(char) {
      parse$1();
      return canonical.get(char) || null;
    }
    var TYPE_L = TYPES.L;
    var TYPE_R = TYPES.R;
    var TYPE_EN = TYPES.EN;
    var TYPE_ES = TYPES.ES;
    var TYPE_ET = TYPES.ET;
    var TYPE_AN = TYPES.AN;
    var TYPE_CS = TYPES.CS;
    var TYPE_B = TYPES.B;
    var TYPE_S = TYPES.S;
    var TYPE_ON = TYPES.ON;
    var TYPE_BN = TYPES.BN;
    var TYPE_NSM = TYPES.NSM;
    var TYPE_AL = TYPES.AL;
    var TYPE_LRO = TYPES.LRO;
    var TYPE_RLO = TYPES.RLO;
    var TYPE_LRE = TYPES.LRE;
    var TYPE_RLE = TYPES.RLE;
    var TYPE_PDF = TYPES.PDF;
    var TYPE_LRI = TYPES.LRI;
    var TYPE_RLI = TYPES.RLI;
    var TYPE_FSI = TYPES.FSI;
    var TYPE_PDI = TYPES.PDI;
    function getEmbeddingLevels(string, baseDirection) {
      var MAX_DEPTH = 125;
      var charTypes = new Uint32Array(string.length);
      for (var i = 0; i &lt; string.length; i++) {
        charTypes[i] = getBidiCharType(string[i]);
      }
      var charTypeCounts = /* @__PURE__ */ new Map();
      function changeCharType(i2, type2) {
        var oldType = charTypes[i2];
        charTypes[i2] = type2;
        charTypeCounts.set(oldType, charTypeCounts.get(oldType) - 1);
        if (oldType & NEUTRAL_ISOLATE_TYPES) {
          charTypeCounts.set(NEUTRAL_ISOLATE_TYPES, charTypeCounts.get(NEUTRAL_ISOLATE_TYPES) - 1);
        }
        charTypeCounts.set(type2, (charTypeCounts.get(type2) || 0) + 1);
        if (type2 & NEUTRAL_ISOLATE_TYPES) {
          charTypeCounts.set(NEUTRAL_ISOLATE_TYPES, (charTypeCounts.get(NEUTRAL_ISOLATE_TYPES) || 0) + 1);
        }
      }
      var embedLevels = new Uint8Array(string.length);
      var isolationPairs = /* @__PURE__ */ new Map();
      var paragraphs = [];
      var paragraph = null;
      for (var i$1 = 0; i$1 &lt; string.length; i$1++) {
        if (!paragraph) {
          paragraphs.push(paragraph = {
            start: i$1,
            end: string.length - 1,
            // 3.3.1 P2-P3: Determine the paragraph level
            level: baseDirection === "rtl" ? 1 : baseDirection === "ltr" ? 0 : determineAutoEmbedLevel(i$1, false)
          });
        }
        if (charTypes[i$1] & TYPE_B) {
          paragraph.end = i$1;
          paragraph = null;
        }
      }
      var FORMATTING_TYPES = TYPE_RLE | TYPE_LRE | TYPE_RLO | TYPE_LRO | ISOLATE_INIT_TYPES | TYPE_PDI | TYPE_PDF | TYPE_B;
      var nextEven = function(n) {
        return n + (n & 1 ? 1 : 2);
      };
      var nextOdd = function(n) {
        return n + (n & 1 ? 2 : 1);
      };
      for (var paraIdx = 0; paraIdx &lt; paragraphs.length; paraIdx++) {
        paragraph = paragraphs[paraIdx];
        var statusStack = [{
          _level: paragraph.level,
          _override: 0,
          //0=neutral, 1=L, 2=R
          _isolate: 0
          //bool
        }];
        var stackTop = void 0;
        var overflowIsolateCount = 0;
        var overflowEmbeddingCount = 0;
        var validIsolateCount = 0;
        charTypeCounts.clear();
        for (var i$2 = paragraph.start; i$2 &lt;= paragraph.end; i$2++) {
          var charType = charTypes[i$2];
          stackTop = statusStack[statusStack.length - 1];
          charTypeCounts.set(charType, (charTypeCounts.get(charType) || 0) + 1);
          if (charType & NEUTRAL_ISOLATE_TYPES) {
            charTypeCounts.set(NEUTRAL_ISOLATE_TYPES, (charTypeCounts.get(NEUTRAL_ISOLATE_TYPES) || 0) + 1);
          }
          if (charType & FORMATTING_TYPES) {
            if (charType & (TYPE_RLE | TYPE_LRE)) {
              embedLevels[i$2] = stackTop._level;
              var level = (charType === TYPE_RLE ? nextOdd : nextEven)(stackTop._level);
              if (level &lt;= MAX_DEPTH && !overflowIsolateCount && !overflowEmbeddingCount) {
                statusStack.push({
                  _level: level,
                  _override: 0,
                  _isolate: 0
                });
              } else if (!overflowIsolateCount) {
                overflowEmbeddingCount++;
              }
            } else if (charType & (TYPE_RLO | TYPE_LRO)) {
              embedLevels[i$2] = stackTop._level;
              var level$1 = (charType === TYPE_RLO ? nextOdd : nextEven)(stackTop._level);
              if (level$1 &lt;= MAX_DEPTH && !overflowIsolateCount && !overflowEmbeddingCount) {
                statusStack.push({
                  _level: level$1,
                  _override: charType & TYPE_RLO ? TYPE_R : TYPE_L,
                  _isolate: 0
                });
              } else if (!overflowIsolateCount) {
                overflowEmbeddingCount++;
              }
            } else if (charType & ISOLATE_INIT_TYPES) {
              if (charType & TYPE_FSI) {
                charType = determineAutoEmbedLevel(i$2 + 1, true) === 1 ? TYPE_RLI : TYPE_LRI;
              }
              embedLevels[i$2] = stackTop._level;
              if (stackTop._override) {
                changeCharType(i$2, stackTop._override);
              }
              var level$2 = (charType === TYPE_RLI ? nextOdd : nextEven)(stackTop._level);
              if (level$2 &lt;= MAX_DEPTH && overflowIsolateCount === 0 && overflowEmbeddingCount === 0) {
                validIsolateCount++;
                statusStack.push({
                  _level: level$2,
                  _override: 0,
                  _isolate: 1,
                  _isolInitIndex: i$2
                });
              } else {
                overflowIsolateCount++;
              }
            } else if (charType & TYPE_PDI) {
              if (overflowIsolateCount > 0) {
                overflowIsolateCount--;
              } else if (validIsolateCount > 0) {
                overflowEmbeddingCount = 0;
                while (!statusStack[statusStack.length - 1]._isolate) {
                  statusStack.pop();
                }
                var isolInitIndex = statusStack[statusStack.length - 1]._isolInitIndex;
                if (isolInitIndex != null) {
                  isolationPairs.set(isolInitIndex, i$2);
                  isolationPairs.set(i$2, isolInitIndex);
                }
                statusStack.pop();
                validIsolateCount--;
              }
              stackTop = statusStack[statusStack.length - 1];
              embedLevels[i$2] = stackTop._level;
              if (stackTop._override) {
                changeCharType(i$2, stackTop._override);
              }
            } else if (charType & TYPE_PDF) {
              if (overflowIsolateCount === 0) {
                if (overflowEmbeddingCount > 0) {
                  overflowEmbeddingCount--;
                } else if (!stackTop._isolate && statusStack.length > 1) {
                  statusStack.pop();
                  stackTop = statusStack[statusStack.length - 1];
                }
              }
              embedLevels[i$2] = stackTop._level;
            } else if (charType & TYPE_B) {
              embedLevels[i$2] = paragraph.level;
            }
          } else {
            embedLevels[i$2] = stackTop._level;
            if (stackTop._override && charType !== TYPE_BN) {
              changeCharType(i$2, stackTop._override);
            }
          }
        }
        var levelRuns = [];
        var currentRun = null;
        for (var i$3 = paragraph.start; i$3 &lt;= paragraph.end; i$3++) {
          var charType$1 = charTypes[i$3];
          if (!(charType$1 & BN_LIKE_TYPES)) {
            var lvl = embedLevels[i$3];
            var isIsolInit = charType$1 & ISOLATE_INIT_TYPES;
            var isPDI = charType$1 === TYPE_PDI;
            if (currentRun && lvl === currentRun._level) {
              currentRun._end = i$3;
              currentRun._endsWithIsolInit = isIsolInit;
            } else {
              levelRuns.push(currentRun = {
                _start: i$3,
                _end: i$3,
                _level: lvl,
                _startsWithPDI: isPDI,
                _endsWithIsolInit: isIsolInit
              });
            }
          }
        }
        var isolatingRunSeqs = [];
        for (var runIdx = 0; runIdx &lt; levelRuns.length; runIdx++) {
          var run = levelRuns[runIdx];
          if (!run._startsWithPDI || run._startsWithPDI && !isolationPairs.has(run._start)) {
            var seqRuns = [currentRun = run];
            for (var pdiIndex = void 0; currentRun && currentRun._endsWithIsolInit && (pdiIndex = isolationPairs.get(currentRun._end)) != null; ) {
              for (var i$4 = runIdx + 1; i$4 &lt; levelRuns.length; i$4++) {
                if (levelRuns[i$4]._start === pdiIndex) {
                  seqRuns.push(currentRun = levelRuns[i$4]);
                  break;
                }
              }
            }
            var seqIndices = [];
            for (var i$5 = 0; i$5 &lt; seqRuns.length; i$5++) {
              var run$1 = seqRuns[i$5];
              for (var j = run$1._start; j &lt;= run$1._end; j++) {
                seqIndices.push(j);
              }
            }
            var firstLevel = embedLevels[seqIndices[0]];
            var prevLevel = paragraph.level;
            for (var i$6 = seqIndices[0] - 1; i$6 >= 0; i$6--) {
              if (!(charTypes[i$6] & BN_LIKE_TYPES)) {
                prevLevel = embedLevels[i$6];
                break;
              }
            }
            var lastIndex = seqIndices[seqIndices.length - 1];
            var lastLevel = embedLevels[lastIndex];
            var nextLevel = paragraph.level;
            if (!(charTypes[lastIndex] & ISOLATE_INIT_TYPES)) {
              for (var i$7 = lastIndex + 1; i$7 &lt;= paragraph.end; i$7++) {
                if (!(charTypes[i$7] & BN_LIKE_TYPES)) {
                  nextLevel = embedLevels[i$7];
                  break;
                }
              }
            }
            isolatingRunSeqs.push({
              _seqIndices: seqIndices,
              _sosType: Math.max(prevLevel, firstLevel) % 2 ? TYPE_R : TYPE_L,
              _eosType: Math.max(nextLevel, lastLevel) % 2 ? TYPE_R : TYPE_L
            });
          }
        }
        for (var seqIdx = 0; seqIdx &lt; isolatingRunSeqs.length; seqIdx++) {
          var ref = isolatingRunSeqs[seqIdx];
          var seqIndices$1 = ref._seqIndices;
          var sosType = ref._sosType;
          var eosType = ref._eosType;
          if (charTypeCounts.get(TYPE_NSM)) {
            for (var si = 0; si &lt; seqIndices$1.length; si++) {
              var i$8 = seqIndices$1[si];
              if (charTypes[i$8] & TYPE_NSM) {
                var prevType = sosType;
                for (var sj = si - 1; sj >= 0; sj--) {
                  if (!(charTypes[seqIndices$1[sj]] & BN_LIKE_TYPES)) {
                    prevType = charTypes[seqIndices$1[sj]];
                    break;
                  }
                }
                changeCharType(i$8, prevType & (ISOLATE_INIT_TYPES | TYPE_PDI) ? TYPE_ON : prevType);
              }
            }
          }
          if (charTypeCounts.get(TYPE_EN)) {
            for (var si$1 = 0; si$1 &lt; seqIndices$1.length; si$1++) {
              var i$9 = seqIndices$1[si$1];
              if (charTypes[i$9] & TYPE_EN) {
                for (var sj$1 = si$1 - 1; sj$1 >= -1; sj$1--) {
                  var prevCharType = sj$1 === -1 ? sosType : charTypes[seqIndices$1[sj$1]];
                  if (prevCharType & STRONG_TYPES) {
                    if (prevCharType === TYPE_AL) {
                      changeCharType(i$9, TYPE_AN);
                    }
                    break;
                  }
                }
              }
            }
          }
          if (charTypeCounts.get(TYPE_AL)) {
            for (var si$2 = 0; si$2 &lt; seqIndices$1.length; si$2++) {
              var i$10 = seqIndices$1[si$2];
              if (charTypes[i$10] & TYPE_AL) {
                changeCharType(i$10, TYPE_R);
              }
            }
          }
          if (charTypeCounts.get(TYPE_ES) || charTypeCounts.get(TYPE_CS)) {
            for (var si$3 = 1; si$3 &lt; seqIndices$1.length - 1; si$3++) {
              var i$11 = seqIndices$1[si$3];
              if (charTypes[i$11] & (TYPE_ES | TYPE_CS)) {
                var prevType$1 = 0, nextType = 0;
                for (var sj$2 = si$3 - 1; sj$2 >= 0; sj$2--) {
                  prevType$1 = charTypes[seqIndices$1[sj$2]];
                  if (!(prevType$1 & BN_LIKE_TYPES)) {
                    break;
                  }
                }
                for (var sj$3 = si$3 + 1; sj$3 &lt; seqIndices$1.length; sj$3++) {
                  nextType = charTypes[seqIndices$1[sj$3]];
                  if (!(nextType & BN_LIKE_TYPES)) {
                    break;
                  }
                }
                if (prevType$1 === nextType && (charTypes[i$11] === TYPE_ES ? prevType$1 === TYPE_EN : prevType$1 & (TYPE_EN | TYPE_AN))) {
                  changeCharType(i$11, prevType$1);
                }
              }
            }
          }
          if (charTypeCounts.get(TYPE_EN)) {
            for (var si$4 = 0; si$4 &lt; seqIndices$1.length; si$4++) {
              var i$12 = seqIndices$1[si$4];
              if (charTypes[i$12] & TYPE_EN) {
                for (var sj$4 = si$4 - 1; sj$4 >= 0 && charTypes[seqIndices$1[sj$4]] & (TYPE_ET | BN_LIKE_TYPES); sj$4--) {
                  changeCharType(seqIndices$1[sj$4], TYPE_EN);
                }
                for (var sj$5 = si$4 + 1; sj$5 &lt; seqIndices$1.length && charTypes[seqIndices$1[sj$5]] & (TYPE_ET | BN_LIKE_TYPES); sj$5++) {
                  changeCharType(seqIndices$1[sj$5], TYPE_EN);
                }
              }
            }
          }
          if (charTypeCounts.get(TYPE_ET) || charTypeCounts.get(TYPE_ES) || charTypeCounts.get(TYPE_CS)) {
            for (var si$5 = 0; si$5 &lt; seqIndices$1.length; si$5++) {
              var i$13 = seqIndices$1[si$5];
              if (charTypes[i$13] & (TYPE_ET | TYPE_ES | TYPE_CS)) {
                changeCharType(i$13, TYPE_ON);
                for (var sj$6 = si$5 - 1; sj$6 >= 0 && charTypes[seqIndices$1[sj$6]] & BN_LIKE_TYPES; sj$6--) {
                  changeCharType(seqIndices$1[sj$6], TYPE_ON);
                }
                for (var sj$7 = si$5 + 1; sj$7 &lt; seqIndices$1.length && charTypes[seqIndices$1[sj$7]] & BN_LIKE_TYPES; sj$7++) {
                  changeCharType(seqIndices$1[sj$7], TYPE_ON);
                }
              }
            }
          }
          if (charTypeCounts.get(TYPE_EN)) {
            for (var si$6 = 0, prevStrongType = sosType; si$6 &lt; seqIndices$1.length; si$6++) {
              var i$14 = seqIndices$1[si$6];
              var type = charTypes[i$14];
              if (type & TYPE_EN) {
                if (prevStrongType === TYPE_L) {
                  changeCharType(i$14, TYPE_L);
                }
              } else if (type & STRONG_TYPES) {
                prevStrongType = type;
              }
            }
          }
          if (charTypeCounts.get(NEUTRAL_ISOLATE_TYPES)) {
            var R_TYPES_FOR_N_STEPS = TYPE_R | TYPE_EN | TYPE_AN;
            var STRONG_TYPES_FOR_N_STEPS = R_TYPES_FOR_N_STEPS | TYPE_L;
            var bracketPairs = [];
            {
              var openerStack = [];
              for (var si$7 = 0; si$7 &lt; seqIndices$1.length; si$7++) {
                if (charTypes[seqIndices$1[si$7]] & NEUTRAL_ISOLATE_TYPES) {
                  var char = string[seqIndices$1[si$7]];
                  var oppositeBracket = void 0;
                  if (openingToClosingBracket(char) !== null) {
                    if (openerStack.length &lt; 63) {
                      openerStack.push({ char, seqIndex: si$7 });
                    } else {
                      break;
                    }
                  } else if ((oppositeBracket = closingToOpeningBracket(char)) !== null) {
                    for (var stackIdx = openerStack.length - 1; stackIdx >= 0; stackIdx--) {
                      var stackChar = openerStack[stackIdx].char;
                      if (stackChar === oppositeBracket || stackChar === closingToOpeningBracket(getCanonicalBracket(char)) || openingToClosingBracket(getCanonicalBracket(stackChar)) === char) {
                        bracketPairs.push([openerStack[stackIdx].seqIndex, si$7]);
                        openerStack.length = stackIdx;
                        break;
                      }
                    }
                  }
                }
              }
              bracketPairs.sort(function(a, b) {
                return a[0] - b[0];
              });
            }
            for (var pairIdx = 0; pairIdx &lt; bracketPairs.length; pairIdx++) {
              var ref$1 = bracketPairs[pairIdx];
              var openSeqIdx = ref$1[0];
              var closeSeqIdx = ref$1[1];
              var foundStrongType = false;
              var useStrongType = 0;
              for (var si$8 = openSeqIdx + 1; si$8 &lt; closeSeqIdx; si$8++) {
                var i$15 = seqIndices$1[si$8];
                if (charTypes[i$15] & STRONG_TYPES_FOR_N_STEPS) {
                  foundStrongType = true;
                  var lr = charTypes[i$15] & R_TYPES_FOR_N_STEPS ? TYPE_R : TYPE_L;
                  if (lr === getEmbedDirection(i$15)) {
                    useStrongType = lr;
                    break;
                  }
                }
              }
              if (foundStrongType && !useStrongType) {
                useStrongType = sosType;
                for (var si$9 = openSeqIdx - 1; si$9 >= 0; si$9--) {
                  var i$16 = seqIndices$1[si$9];
                  if (charTypes[i$16] & STRONG_TYPES_FOR_N_STEPS) {
                    var lr$1 = charTypes[i$16] & R_TYPES_FOR_N_STEPS ? TYPE_R : TYPE_L;
                    if (lr$1 !== getEmbedDirection(i$16)) {
                      useStrongType = lr$1;
                    } else {
                      useStrongType = getEmbedDirection(i$16);
                    }
                    break;
                  }
                }
              }
              if (useStrongType) {
                charTypes[seqIndices$1[openSeqIdx]] = charTypes[seqIndices$1[closeSeqIdx]] = useStrongType;
                if (useStrongType !== getEmbedDirection(seqIndices$1[openSeqIdx])) {
                  for (var si$10 = openSeqIdx + 1; si$10 &lt; seqIndices$1.length; si$10++) {
                    if (!(charTypes[seqIndices$1[si$10]] & BN_LIKE_TYPES)) {
                      if (getBidiCharType(string[seqIndices$1[si$10]]) & TYPE_NSM) {
                        charTypes[seqIndices$1[si$10]] = useStrongType;
                      }
                      break;
                    }
                  }
                }
                if (useStrongType !== getEmbedDirection(seqIndices$1[closeSeqIdx])) {
                  for (var si$11 = closeSeqIdx + 1; si$11 &lt; seqIndices$1.length; si$11++) {
                    if (!(charTypes[seqIndices$1[si$11]] & BN_LIKE_TYPES)) {
                      if (getBidiCharType(string[seqIndices$1[si$11]]) & TYPE_NSM) {
                        charTypes[seqIndices$1[si$11]] = useStrongType;
                      }
                      break;
                    }
                  }
                }
              }
            }
            for (var si$12 = 0; si$12 &lt; seqIndices$1.length; si$12++) {
              if (charTypes[seqIndices$1[si$12]] & NEUTRAL_ISOLATE_TYPES) {
                var niRunStart = si$12, niRunEnd = si$12;
                var prevType$2 = sosType;
                for (var si2 = si$12 - 1; si2 >= 0; si2--) {
                  if (charTypes[seqIndices$1[si2]] & BN_LIKE_TYPES) {
                    niRunStart = si2;
                  } else {
                    prevType$2 = charTypes[seqIndices$1[si2]] & R_TYPES_FOR_N_STEPS ? TYPE_R : TYPE_L;
                    break;
                  }
                }
                var nextType$1 = eosType;
                for (var si2$1 = si$12 + 1; si2$1 &lt; seqIndices$1.length; si2$1++) {
                  if (charTypes[seqIndices$1[si2$1]] & (NEUTRAL_ISOLATE_TYPES | BN_LIKE_TYPES)) {
                    niRunEnd = si2$1;
                  } else {
                    nextType$1 = charTypes[seqIndices$1[si2$1]] & R_TYPES_FOR_N_STEPS ? TYPE_R : TYPE_L;
                    break;
                  }
                }
                for (var sj$8 = niRunStart; sj$8 &lt;= niRunEnd; sj$8++) {
                  charTypes[seqIndices$1[sj$8]] = prevType$2 === nextType$1 ? prevType$2 : getEmbedDirection(seqIndices$1[sj$8]);
                }
                si$12 = niRunEnd;
              }
            }
          }
        }
        for (var i$17 = paragraph.start; i$17 &lt;= paragraph.end; i$17++) {
          var level$3 = embedLevels[i$17];
          var type$1 = charTypes[i$17];
          if (level$3 & 1) {
            if (type$1 & (TYPE_L | TYPE_EN | TYPE_AN)) {
              embedLevels[i$17]++;
            }
          } else {
            if (type$1 & TYPE_R) {
              embedLevels[i$17]++;
            } else if (type$1 & (TYPE_AN | TYPE_EN)) {
              embedLevels[i$17] += 2;
            }
          }
          if (type$1 & BN_LIKE_TYPES) {
            embedLevels[i$17] = i$17 === 0 ? paragraph.level : embedLevels[i$17 - 1];
          }
          if (i$17 === paragraph.end || getBidiCharType(string[i$17]) & (TYPE_S | TYPE_B)) {
            for (var j$1 = i$17; j$1 >= 0 && getBidiCharType(string[j$1]) & TRAILING_TYPES; j$1--) {
              embedLevels[j$1] = paragraph.level;
            }
          }
        }
      }
      return {
        levels: embedLevels,
        paragraphs
      };
      function determineAutoEmbedLevel(start, isFSI) {
        for (var i2 = start; i2 &lt; string.length; i2++) {
          var charType2 = charTypes[i2];
          if (charType2 & (TYPE_R | TYPE_AL)) {
            return 1;
          }
          if (charType2 & (TYPE_B | TYPE_L) || isFSI && charType2 === TYPE_PDI) {
            return 0;
          }
          if (charType2 & ISOLATE_INIT_TYPES) {
            var pdi = indexOfMatchingPDI(i2);
            i2 = pdi === -1 ? string.length : pdi;
          }
        }
        return 0;
      }
      function indexOfMatchingPDI(isolateStart) {
        var isolationLevel = 1;
        for (var i2 = isolateStart + 1; i2 &lt; string.length; i2++) {
          var charType2 = charTypes[i2];
          if (charType2 & TYPE_B) {
            break;
          }
          if (charType2 & TYPE_PDI) {
            if (--isolationLevel === 0) {
              return i2;
            }
          } else if (charType2 & ISOLATE_INIT_TYPES) {
            isolationLevel++;
          }
        }
        return -1;
      }
      function getEmbedDirection(i2) {
        return embedLevels[i2] & 1 ? TYPE_R : TYPE_L;
      }
    }
    var data = "14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1";
    var mirrorMap;
    function parse() {
      if (!mirrorMap) {
        var ref = parseCharacterMap(data, true);
        var map2 = ref.map;
        var reverseMap = ref.reverseMap;
        reverseMap.forEach(function(value, key) {
          map2.set(key, value);
        });
        mirrorMap = map2;
      }
    }
    function getMirroredCharacter(char) {
      parse();
      return mirrorMap.get(char) || null;
    }
    function getMirroredCharactersMap(string, embeddingLevels, start, end) {
      var strLen = string.length;
      start = Math.max(0, start == null ? 0 : +start);
      end = Math.min(strLen - 1, end == null ? strLen - 1 : +end);
      var map2 = /* @__PURE__ */ new Map();
      for (var i = start; i &lt;= end; i++) {
        if (embeddingLevels[i] & 1) {
          var mirror = getMirroredCharacter(string[i]);
          if (mirror !== null) {
            map2.set(i, mirror);
          }
        }
      }
      return map2;
    }
    function getReorderSegments(string, embeddingLevelsResult, start, end) {
      var strLen = string.length;
      start = Math.max(0, start == null ? 0 : +start);
      end = Math.min(strLen - 1, end == null ? strLen - 1 : +end);
      var segments = [];
      embeddingLevelsResult.paragraphs.forEach(function(paragraph) {
        var lineStart = Math.max(start, paragraph.start);
        var lineEnd = Math.min(end, paragraph.end);
        if (lineStart &lt; lineEnd) {
          var lineLevels = embeddingLevelsResult.levels.slice(lineStart, lineEnd + 1);
          for (var i = lineEnd; i >= lineStart && getBidiCharType(string[i]) & TRAILING_TYPES; i--) {
            lineLevels[i] = paragraph.level;
          }
          var maxLevel = paragraph.level;
          var minOddLevel = Infinity;
          for (var i$1 = 0; i$1 &lt; lineLevels.length; i$1++) {
            var level = lineLevels[i$1];
            if (level > maxLevel) {
              maxLevel = level;
            }
            if (level &lt; minOddLevel) {
              minOddLevel = level | 1;
            }
          }
          for (var lvl = maxLevel; lvl >= minOddLevel; lvl--) {
            for (var i$2 = 0; i$2 &lt; lineLevels.length; i$2++) {
              if (lineLevels[i$2] >= lvl) {
                var segStart = i$2;
                while (i$2 + 1 &lt; lineLevels.length && lineLevels[i$2 + 1] >= lvl) {
                  i$2++;
                }
                if (i$2 > segStart) {
                  segments.push([segStart + start, i$2 + start]);
                }
              }
            }
          }
        }
      });
      return segments;
    }
    function getReorderedString(string, embedLevelsResult, start, end) {
      var indices = getReorderedIndices(string, embedLevelsResult, start, end);
      var chars = [].concat(string);
      indices.forEach(function(charIndex, i) {
        chars[i] = (embedLevelsResult.levels[charIndex] & 1 ? getMirroredCharacter(string[charIndex]) : null) || string[charIndex];
      });
      return chars.join("");
    }
    function getReorderedIndices(string, embedLevelsResult, start, end) {
      var segments = getReorderSegments(string, embedLevelsResult, start, end);
      var indices = [];
      for (var i = 0; i &lt; string.length; i++) {
        indices[i] = i;
      }
      segments.forEach(function(ref) {
        var start2 = ref[0];
        var end2 = ref[1];
        var slice = indices.slice(start2, end2 + 1);
        for (var i2 = slice.length; i2--; ) {
          indices[end2 - i2] = slice[i2];
        }
      });
      return indices;
    }
    exports.closingToOpeningBracket = closingToOpeningBracket;
    exports.getBidiCharType = getBidiCharType;
    exports.getBidiCharTypeName = getBidiCharTypeName;
    exports.getCanonicalBracket = getCanonicalBracket;
    exports.getEmbeddingLevels = getEmbeddingLevels;
    exports.getMirroredCharacter = getMirroredCharacter;
    exports.getMirroredCharactersMap = getMirroredCharactersMap;
    exports.getReorderSegments = getReorderSegments;
    exports.getReorderedIndices = getReorderedIndices;
    exports.getReorderedString = getReorderedString;
    exports.openingToClosingBracket = openingToClosingBracket;
    Object.defineProperty(exports, "__esModule", { value: true });
    return exports;
  }({});
  return bidi;
}
const voidMainRegExp = /\bvoid\s+main\s*\(\s*\)\s*{/g;
function expandShaderIncludes(source) {
  const pattern = /^[ \t]*#include +&lt;([\w\d./]+)>/gm;
  function replace(match, include) {
    let chunk = ShaderChunk[include];
    return chunk ? expandShaderIncludes(chunk) : match;
  }
  return source.replace(pattern, replace);
}
const _lut = [];
for (let i = 0; i &lt; 256; i++) {
  _lut[i] = (i &lt; 16 ? "0" : "") + i.toString(16);
}
function generateUUID() {
  const d0 = Math.random() * 4294967295 | 0;
  const d1 = Math.random() * 4294967295 | 0;
  const d2 = Math.random() * 4294967295 | 0;
  const d3 = Math.random() * 4294967295 | 0;
  const uuid = _lut[d0 & 255] + _lut[d0 >> 8 & 255] + _lut[d0 >> 16 & 255] + _lut[d0 >> 24 & 255] + "-" + _lut[d1 & 255] + _lut[d1 >> 8 & 255] + "-" + _lut[d1 >> 16 & 15 | 64] + _lut[d1 >> 24 & 255] + "-" + _lut[d2 & 63 | 128] + _lut[d2 >> 8 & 255] + "-" + _lut[d2 >> 16 & 255] + _lut[d2 >> 24 & 255] + _lut[d3 & 255] + _lut[d3 >> 8 & 255] + _lut[d3 >> 16 & 255] + _lut[d3 >> 24 & 255];
  return uuid.toUpperCase();
}
const assign$1 = Object.assign || function() {
  let target = arguments[0];
  for (let i = 1, len = arguments.length; i &lt; len; i++) {
    let source = arguments[i];
    if (source) {
      for (let prop in source) {
        if (Object.prototype.hasOwnProperty.call(source, prop)) {
          target[prop] = source[prop];
        }
      }
    }
  }
  return target;
};
const epoch = Date.now();
const CONSTRUCTOR_CACHE = /* @__PURE__ */ new WeakMap();
const SHADER_UPGRADE_CACHE = /* @__PURE__ */ new Map();
let materialInstanceId = 1e10;
function createDerivedMaterial(baseMaterial, options) {
  const optionsKey = getKeyForOptions(options);
  let ctorsByDerivation = CONSTRUCTOR_CACHE.get(baseMaterial);
  if (!ctorsByDerivation) {
    CONSTRUCTOR_CACHE.set(baseMaterial, ctorsByDerivation = /* @__PURE__ */ Object.create(null));
  }
  if (ctorsByDerivation[optionsKey]) {
    return new ctorsByDerivation[optionsKey]();
  }
  const privateBeforeCompileProp = `_onBeforeCompile${optionsKey}`;
  const onBeforeCompile = function(shaderInfo, renderer) {
    baseMaterial.onBeforeCompile.call(this, shaderInfo, renderer);
    const cacheKey = this.customProgramCacheKey() + "|" + shaderInfo.vertexShader + "|" + shaderInfo.fragmentShader;
    let upgradedShaders = SHADER_UPGRADE_CACHE[cacheKey];
    if (!upgradedShaders) {
      const upgraded = upgradeShaders(this, shaderInfo, options, optionsKey);
      upgradedShaders = SHADER_UPGRADE_CACHE[cacheKey] = upgraded;
    }
    shaderInfo.vertexShader = upgradedShaders.vertexShader;
    shaderInfo.fragmentShader = upgradedShaders.fragmentShader;
    assign$1(shaderInfo.uniforms, this.uniforms);
    if (options.timeUniform) {
      shaderInfo.uniforms[options.timeUniform] = {
        get value() {
          return Date.now() - epoch;
        }
      };
    }
    if (this[privateBeforeCompileProp]) {
      this[privateBeforeCompileProp](shaderInfo);
    }
  };
  const DerivedMaterial = function DerivedMaterial2() {
    return derive(options.chained ? baseMaterial : baseMaterial.clone());
  };
  const derive = function(base) {
    const derived = Object.create(base, descriptor);
    Object.defineProperty(derived, "baseMaterial", { value: baseMaterial });
    Object.defineProperty(derived, "id", { value: materialInstanceId++ });
    derived.uuid = generateUUID();
    derived.uniforms = assign$1({}, base.uniforms, options.uniforms);
    derived.defines = assign$1({}, base.defines, options.defines);
    derived.defines[`TROIKA_DERIVED_MATERIAL_${optionsKey}`] = "";
    derived.extensions = assign$1({}, base.extensions, options.extensions);
    derived._listeners = void 0;
    return derived;
  };
  const descriptor = {
    constructor: { value: DerivedMaterial },
    isDerivedMaterial: { value: true },
    customProgramCacheKey: {
      writable: true,
      configurable: true,
      value: function() {
        return baseMaterial.customProgramCacheKey() + "|" + optionsKey;
      }
    },
    onBeforeCompile: {
      get() {
        return onBeforeCompile;
      },
      set(fn) {
        this[privateBeforeCompileProp] = fn;
      }
    },
    copy: {
      writable: true,
      configurable: true,
      value: function(source) {
        baseMaterial.copy.call(this, source);
        if (!baseMaterial.isShaderMaterial && !baseMaterial.isDerivedMaterial) {
          assign$1(this.extensions, source.extensions);
          assign$1(this.defines, source.defines);
          assign$1(this.uniforms, UniformsUtils.clone(source.uniforms));
        }
        return this;
      }
    },
    clone: {
      writable: true,
      configurable: true,
      value: function() {
        const newBase = new baseMaterial.constructor();
        return derive(newBase).copy(this);
      }
    },
    /**
     * Utility to get a MeshDepthMaterial that will honor this derived material's vertex
     * transformations and discarded fragments.
     */
    getDepthMaterial: {
      writable: true,
      configurable: true,
      value: function() {
        let depthMaterial = this._depthMaterial;
        if (!depthMaterial) {
          depthMaterial = this._depthMaterial = createDerivedMaterial(
            baseMaterial.isDerivedMaterial ? baseMaterial.getDepthMaterial() : new MeshDepthMaterial({ depthPacking: RGBADepthPacking }),
            options
          );
          depthMaterial.defines.IS_DEPTH_MATERIAL = "";
          depthMaterial.uniforms = this.uniforms;
        }
        return depthMaterial;
      }
    },
    /**
     * Utility to get a MeshDistanceMaterial that will honor this derived material's vertex
     * transformations and discarded fragments.
     */
    getDistanceMaterial: {
      writable: true,
      configurable: true,
      value: function() {
        let distanceMaterial = this._distanceMaterial;
        if (!distanceMaterial) {
          distanceMaterial = this._distanceMaterial = createDerivedMaterial(
            baseMaterial.isDerivedMaterial ? baseMaterial.getDistanceMaterial() : new MeshDistanceMaterial(),
            options
          );
          distanceMaterial.defines.IS_DISTANCE_MATERIAL = "";
          distanceMaterial.uniforms = this.uniforms;
        }
        return distanceMaterial;
      }
    },
    dispose: {
      writable: true,
      configurable: true,
      value() {
        const { _depthMaterial, _distanceMaterial } = this;
        if (_depthMaterial)
          _depthMaterial.dispose();
        if (_distanceMaterial)
          _distanceMaterial.dispose();
        baseMaterial.dispose.call(this);
      }
    }
  };
  ctorsByDerivation[optionsKey] = DerivedMaterial;
  return new DerivedMaterial();
}
function upgradeShaders(material, { vertexShader, fragmentShader }, options, key) {
  let {
    vertexDefs,
    vertexMainIntro,
    vertexMainOutro,
    vertexTransform,
    fragmentDefs,
    fragmentMainIntro,
    fragmentMainOutro,
    fragmentColorTransform,
    customRewriter,
    timeUniform
  } = options;
  vertexDefs = vertexDefs || "";
  vertexMainIntro = vertexMainIntro || "";
  vertexMainOutro = vertexMainOutro || "";
  fragmentDefs = fragmentDefs || "";
  fragmentMainIntro = fragmentMainIntro || "";
  fragmentMainOutro = fragmentMainOutro || "";
  if (vertexTransform || customRewriter) {
    vertexShader = expandShaderIncludes(vertexShader);
  }
  if (fragmentColorTransform || customRewriter) {
    fragmentShader = fragmentShader.replace(
      /^[ \t]*#include &lt;((?:tonemapping|encodings|fog|premultiplied_alpha|dithering)_fragment)>/gm,
      "\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n"
    );
    fragmentShader = expandShaderIncludes(fragmentShader);
  }
  if (customRewriter) {
    let res = customRewriter({ vertexShader, fragmentShader });
    vertexShader = res.vertexShader;
    fragmentShader = res.fragmentShader;
  }
  if (fragmentColorTransform) {
    let postChunks = [];
    fragmentShader = fragmentShader.replace(
      /^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,
      // [^]+? = non-greedy match of any chars including newlines
      (match) => {
        postChunks.push(match);
        return "";
      }
    );
    fragmentMainOutro = `${fragmentColorTransform}
${postChunks.join("\n")}
${fragmentMainOutro}`;
  }
  if (timeUniform) {
    const code = `
uniform float ${timeUniform};
`;
    vertexDefs = code + vertexDefs;
    fragmentDefs = code + fragmentDefs;
  }
  if (vertexTransform) {
    vertexShader = `vec3 troika_position_${key};
vec3 troika_normal_${key};
vec2 troika_uv_${key};
${vertexShader}
`;
    vertexDefs = `${vertexDefs}
void troikaVertexTransform${key}(inout vec3 position, inout vec3 normal, inout vec2 uv) {
  ${vertexTransform}
}
`;
    vertexMainIntro = `
troika_position_${key} = vec3(position);
troika_normal_${key} = vec3(normal);
troika_uv_${key} = vec2(uv);
troikaVertexTransform${key}(troika_position_${key}, troika_normal_${key}, troika_uv_${key});
${vertexMainIntro}
`;
    vertexShader = vertexShader.replace(/\b(position|normal|uv)\b/g, (match, match1, index, fullStr) => {
      return /\battribute\s+vec[23]\s+$/.test(fullStr.substr(0, index)) ? match1 : `troika_${match1}_${key}`;
    });
    if (!(material.map && material.map.channel > 0)) {
      vertexShader = vertexShader.replace(/\bMAP_UV\b/g, `troika_uv_${key}`);
    }
  }
  vertexShader = injectIntoShaderCode(vertexShader, key, vertexDefs, vertexMainIntro, vertexMainOutro);
  fragmentShader = injectIntoShaderCode(fragmentShader, key, fragmentDefs, fragmentMainIntro, fragmentMainOutro);
  return {
    vertexShader,
    fragmentShader
  };
}
function injectIntoShaderCode(shaderCode, id, defs, intro, outro) {
  if (intro || outro || defs) {
    shaderCode = shaderCode.replace(
      voidMainRegExp,
      `
${defs}
void troikaOrigMain${id}() {`
    );
    shaderCode += `
void main() {
  ${intro}
  troikaOrigMain${id}();
  ${outro}
}`;
  }
  return shaderCode;
}
function optionsJsonReplacer(key, value) {
  return key === "uniforms" ? void 0 : typeof value === "function" ? value.toString() : value;
}
let _idCtr = 0;
const optionsHashesToIds = /* @__PURE__ */ new Map();
function getKeyForOptions(options) {
  const optionsHash = JSON.stringify(options, optionsJsonReplacer);
  let id = optionsHashesToIds.get(optionsHash);
  if (id == null) {
    optionsHashesToIds.set(optionsHash, id = ++_idCtr);
  }
  return id;
}
/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/
function typrFactory() {
  return "undefined" == typeof window && (self.window = self), function(r) {
    var e = { parse: function(r2) {
      var t2 = e._bin, a2 = new Uint8Array(r2);
      if ("ttcf" == t2.readASCII(a2, 0, 4)) {
        var n = 4;
        t2.readUshort(a2, n), n += 2, t2.readUshort(a2, n), n += 2;
        var o = t2.readUint(a2, n);
        n += 4;
        for (var s = [], i = 0; i &lt; o; i++) {
          var h = t2.readUint(a2, n);
          n += 4, s.push(e._readFont(a2, h));
        }
        return s;
      }
      return [e._readFont(a2, 0)];
    }, _readFont: function(r2, t2) {
      var a2 = e._bin, n = t2;
      a2.readFixed(r2, t2), t2 += 4;
      var o = a2.readUshort(r2, t2);
      t2 += 2, a2.readUshort(r2, t2), t2 += 2, a2.readUshort(r2, t2), t2 += 2, a2.readUshort(r2, t2), t2 += 2;
      for (var s = ["cmap", "head", "hhea", "maxp", "hmtx", "name", "OS/2", "post", "loca", "glyf", "kern", "CFF ", "GDEF", "GPOS", "GSUB", "SVG "], i = { _data: r2, _offset: n }, h = {}, d = 0; d &lt; o; d++) {
        var f = a2.readASCII(r2, t2, 4);
        t2 += 4, a2.readUint(r2, t2), t2 += 4;
        var u = a2.readUint(r2, t2);
        t2 += 4;
        var l = a2.readUint(r2, t2);
        t2 += 4, h[f] = { offset: u, length: l };
      }
      for (d = 0; d &lt; s.length; d++) {
        var v = s[d];
        h[v] && (i[v.trim()] = e[v.trim()].parse(r2, h[v].offset, h[v].length, i));
      }
      return i;
    }, _tabOffset: function(r2, t2, a2) {
      for (var n = e._bin, o = n.readUshort(r2, a2 + 4), s = a2 + 12, i = 0; i &lt; o; i++) {
        var h = n.readASCII(r2, s, 4);
        s += 4, n.readUint(r2, s), s += 4;
        var d = n.readUint(r2, s);
        if (s += 4, n.readUint(r2, s), s += 4, h == t2)
          return d;
      }
      return 0;
    } };
    e._bin = { readFixed: function(r2, e2) {
      return (r2[e2] &lt;&lt; 8 | r2[e2 + 1]) + (r2[e2 + 2] &lt;&lt; 8 | r2[e2 + 3]) / 65540;
    }, readF2dot14: function(r2, t2) {
      return e._bin.readShort(r2, t2) / 16384;
    }, readInt: function(r2, t2) {
      return e._bin._view(r2).getInt32(t2);
    }, readInt8: function(r2, t2) {
      return e._bin._view(r2).getInt8(t2);
    }, readShort: function(r2, t2) {
      return e._bin._view(r2).getInt16(t2);
    }, readUshort: function(r2, t2) {
      return e._bin._view(r2).getUint16(t2);
    }, readUshorts: function(r2, t2, a2) {
      for (var n = [], o = 0; o &lt; a2; o++)
        n.push(e._bin.readUshort(r2, t2 + 2 * o));
      return n;
    }, readUint: function(r2, t2) {
      return e._bin._view(r2).getUint32(t2);
    }, readUint64: function(r2, t2) {
      return 4294967296 * e._bin.readUint(r2, t2) + e._bin.readUint(r2, t2 + 4);
    }, readASCII: function(r2, e2, t2) {
      for (var a2 = "", n = 0; n &lt; t2; n++)
        a2 += String.fromCharCode(r2[e2 + n]);
      return a2;
    }, readUnicode: function(r2, e2, t2) {
      for (var a2 = "", n = 0; n &lt; t2; n++) {
        var o = r2[e2++] &lt;&lt; 8 | r2[e2++];
        a2 += String.fromCharCode(o);
      }
      return a2;
    }, _tdec: "undefined" != typeof window && window.TextDecoder ? new window.TextDecoder() : null, readUTF8: function(r2, t2, a2) {
      var n = e._bin._tdec;
      return n && 0 == t2 && a2 == r2.length ? n.decode(r2) : e._bin.readASCII(r2, t2, a2);
    }, readBytes: function(r2, e2, t2) {
      for (var a2 = [], n = 0; n &lt; t2; n++)
        a2.push(r2[e2 + n]);
      return a2;
    }, readASCIIArray: function(r2, e2, t2) {
      for (var a2 = [], n = 0; n &lt; t2; n++)
        a2.push(String.fromCharCode(r2[e2 + n]));
      return a2;
    }, _view: function(r2) {
      return r2._dataView || (r2._dataView = r2.buffer ? new DataView(r2.buffer, r2.byteOffset, r2.byteLength) : new DataView(new Uint8Array(r2).buffer));
    } }, e._lctf = {}, e._lctf.parse = function(r2, t2, a2, n, o) {
      var s = e._bin, i = {}, h = t2;
      s.readFixed(r2, t2), t2 += 4;
      var d = s.readUshort(r2, t2);
      t2 += 2;
      var f = s.readUshort(r2, t2);
      t2 += 2;
      var u = s.readUshort(r2, t2);
      return t2 += 2, i.scriptList = e._lctf.readScriptList(r2, h + d), i.featureList = e._lctf.readFeatureList(r2, h + f), i.lookupList = e._lctf.readLookupList(r2, h + u, o), i;
    }, e._lctf.readLookupList = function(r2, t2, a2) {
      var n = e._bin, o = t2, s = [], i = n.readUshort(r2, t2);
      t2 += 2;
      for (var h = 0; h &lt; i; h++) {
        var d = n.readUshort(r2, t2);
        t2 += 2;
        var f = e._lctf.readLookupTable(r2, o + d, a2);
        s.push(f);
      }
      return s;
    }, e._lctf.readLookupTable = function(r2, t2, a2) {
      var n = e._bin, o = t2, s = { tabs: [] };
      s.ltype = n.readUshort(r2, t2), t2 += 2, s.flag = n.readUshort(r2, t2), t2 += 2;
      var i = n.readUshort(r2, t2);
      t2 += 2;
      for (var h = s.ltype, d = 0; d &lt; i; d++) {
        var f = n.readUshort(r2, t2);
        t2 += 2;
        var u = a2(r2, h, o + f, s);
        s.tabs.push(u);
      }
      return s;
    }, e._lctf.numOfOnes = function(r2) {
      for (var e2 = 0, t2 = 0; t2 &lt; 32; t2++)
        0 != (r2 >>> t2 & 1) && e2++;
      return e2;
    }, e._lctf.readClassDef = function(r2, t2) {
      var a2 = e._bin, n = [], o = a2.readUshort(r2, t2);
      if (t2 += 2, 1 == o) {
        var s = a2.readUshort(r2, t2);
        t2 += 2;
        var i = a2.readUshort(r2, t2);
        t2 += 2;
        for (var h = 0; h &lt; i; h++)
          n.push(s + h), n.push(s + h), n.push(a2.readUshort(r2, t2)), t2 += 2;
      }
      if (2 == o) {
        var d = a2.readUshort(r2, t2);
        t2 += 2;
        for (h = 0; h &lt; d; h++)
          n.push(a2.readUshort(r2, t2)), t2 += 2, n.push(a2.readUshort(r2, t2)), t2 += 2, n.push(a2.readUshort(r2, t2)), t2 += 2;
      }
      return n;
    }, e._lctf.getInterval = function(r2, e2) {
      for (var t2 = 0; t2 &lt; r2.length; t2 += 3) {
        var a2 = r2[t2], n = r2[t2 + 1];
        if (r2[t2 + 2], a2 &lt;= e2 && e2 &lt;= n)
          return t2;
      }
      return -1;
    }, e._lctf.readCoverage = function(r2, t2) {
      var a2 = e._bin, n = {};
      n.fmt = a2.readUshort(r2, t2), t2 += 2;
      var o = a2.readUshort(r2, t2);
      return t2 += 2, 1 == n.fmt && (n.tab = a2.readUshorts(r2, t2, o)), 2 == n.fmt && (n.tab = a2.readUshorts(r2, t2, 3 * o)), n;
    }, e._lctf.coverageIndex = function(r2, t2) {
      var a2 = r2.tab;
      if (1 == r2.fmt)
        return a2.indexOf(t2);
      if (2 == r2.fmt) {
        var n = e._lctf.getInterval(a2, t2);
        if (-1 != n)
          return a2[n + 2] + (t2 - a2[n]);
      }
      return -1;
    }, e._lctf.readFeatureList = function(r2, t2) {
      var a2 = e._bin, n = t2, o = [], s = a2.readUshort(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = a2.readASCII(r2, t2, 4);
        t2 += 4;
        var d = a2.readUshort(r2, t2);
        t2 += 2;
        var f = e._lctf.readFeatureTable(r2, n + d);
        f.tag = h.trim(), o.push(f);
      }
      return o;
    }, e._lctf.readFeatureTable = function(r2, t2) {
      var a2 = e._bin, n = t2, o = {}, s = a2.readUshort(r2, t2);
      t2 += 2, s > 0 && (o.featureParams = n + s);
      var i = a2.readUshort(r2, t2);
      t2 += 2, o.tab = [];
      for (var h = 0; h &lt; i; h++)
        o.tab.push(a2.readUshort(r2, t2 + 2 * h));
      return o;
    }, e._lctf.readScriptList = function(r2, t2) {
      var a2 = e._bin, n = t2, o = {}, s = a2.readUshort(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = a2.readASCII(r2, t2, 4);
        t2 += 4;
        var d = a2.readUshort(r2, t2);
        t2 += 2, o[h.trim()] = e._lctf.readScriptTable(r2, n + d);
      }
      return o;
    }, e._lctf.readScriptTable = function(r2, t2) {
      var a2 = e._bin, n = t2, o = {}, s = a2.readUshort(r2, t2);
      t2 += 2, s > 0 && (o.default = e._lctf.readLangSysTable(r2, n + s));
      var i = a2.readUshort(r2, t2);
      t2 += 2;
      for (var h = 0; h &lt; i; h++) {
        var d = a2.readASCII(r2, t2, 4);
        t2 += 4;
        var f = a2.readUshort(r2, t2);
        t2 += 2, o[d.trim()] = e._lctf.readLangSysTable(r2, n + f);
      }
      return o;
    }, e._lctf.readLangSysTable = function(r2, t2) {
      var a2 = e._bin, n = {};
      a2.readUshort(r2, t2), t2 += 2, n.reqFeature = a2.readUshort(r2, t2), t2 += 2;
      var o = a2.readUshort(r2, t2);
      return t2 += 2, n.features = a2.readUshorts(r2, t2, o), n;
    }, e.CFF = {}, e.CFF.parse = function(r2, t2, a2) {
      var n = e._bin;
      (r2 = new Uint8Array(r2.buffer, t2, a2))[t2 = 0], r2[++t2], r2[++t2], r2[++t2], t2++;
      var o = [];
      t2 = e.CFF.readIndex(r2, t2, o);
      for (var s = [], i = 0; i &lt; o.length - 1; i++)
        s.push(n.readASCII(r2, t2 + o[i], o[i + 1] - o[i]));
      t2 += o[o.length - 1];
      var h = [];
      t2 = e.CFF.readIndex(r2, t2, h);
      var d = [];
      for (i = 0; i &lt; h.length - 1; i++)
        d.push(e.CFF.readDict(r2, t2 + h[i], t2 + h[i + 1]));
      t2 += h[h.length - 1];
      var f = d[0], u = [];
      t2 = e.CFF.readIndex(r2, t2, u);
      var l = [];
      for (i = 0; i &lt; u.length - 1; i++)
        l.push(n.readASCII(r2, t2 + u[i], u[i + 1] - u[i]));
      if (t2 += u[u.length - 1], e.CFF.readSubrs(r2, t2, f), f.CharStrings) {
        t2 = f.CharStrings;
        u = [];
        t2 = e.CFF.readIndex(r2, t2, u);
        var v = [];
        for (i = 0; i &lt; u.length - 1; i++)
          v.push(n.readBytes(r2, t2 + u[i], u[i + 1] - u[i]));
        f.CharStrings = v;
      }
      if (f.ROS) {
        t2 = f.FDArray;
        var c = [];
        t2 = e.CFF.readIndex(r2, t2, c), f.FDArray = [];
        for (i = 0; i &lt; c.length - 1; i++) {
          var p = e.CFF.readDict(r2, t2 + c[i], t2 + c[i + 1]);
          e.CFF._readFDict(r2, p, l), f.FDArray.push(p);
        }
        t2 += c[c.length - 1], t2 = f.FDSelect, f.FDSelect = [];
        var U = r2[t2];
        if (t2++, 3 != U)
          throw U;
        var g = n.readUshort(r2, t2);
        t2 += 2;
        for (i = 0; i &lt; g + 1; i++)
          f.FDSelect.push(n.readUshort(r2, t2), r2[t2 + 2]), t2 += 3;
      }
      return f.Encoding && (f.Encoding = e.CFF.readEncoding(r2, f.Encoding, f.CharStrings.length)), f.charset && (f.charset = e.CFF.readCharset(r2, f.charset, f.CharStrings.length)), e.CFF._readFDict(r2, f, l), f;
    }, e.CFF._readFDict = function(r2, t2, a2) {
      var n;
      for (var o in t2.Private && (n = t2.Private[1], t2.Private = e.CFF.readDict(r2, n, n + t2.Private[0]), t2.Private.Subrs && e.CFF.readSubrs(r2, n + t2.Private.Subrs, t2.Private)), t2)
        -1 != ["FamilyName", "FontName", "FullName", "Notice", "version", "Copyright"].indexOf(o) && (t2[o] = a2[t2[o] - 426 + 35]);
    }, e.CFF.readSubrs = function(r2, t2, a2) {
      var n = e._bin, o = [];
      t2 = e.CFF.readIndex(r2, t2, o);
      var s, i = o.length;
      s = i &lt; 1240 ? 107 : i &lt; 33900 ? 1131 : 32768, a2.Bias = s, a2.Subrs = [];
      for (var h = 0; h &lt; o.length - 1; h++)
        a2.Subrs.push(n.readBytes(r2, t2 + o[h], o[h + 1] - o[h]));
    }, e.CFF.tableSE = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 0, 111, 112, 113, 114, 0, 115, 116, 117, 118, 119, 120, 121, 122, 0, 123, 0, 124, 125, 126, 127, 128, 129, 130, 131, 0, 132, 133, 0, 134, 135, 136, 137, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 138, 0, 139, 0, 0, 0, 0, 140, 141, 142, 143, 0, 0, 0, 0, 0, 144, 0, 0, 0, 145, 0, 0, 146, 147, 148, 149, 0, 0, 0, 0], e.CFF.glyphByUnicode = function(r2, e2) {
      for (var t2 = 0; t2 &lt; r2.charset.length; t2++)
        if (r2.charset[t2] == e2)
          return t2;
      return -1;
    }, e.CFF.glyphBySE = function(r2, t2) {
      return t2 &lt; 0 || t2 > 255 ? -1 : e.CFF.glyphByUnicode(r2, e.CFF.tableSE[t2]);
    }, e.CFF.readEncoding = function(r2, t2, a2) {
      e._bin;
      var n = [".notdef"], o = r2[t2];
      if (t2++, 0 != o)
        throw "error: unknown encoding format: " + o;
      var s = r2[t2];
      t2++;
      for (var i = 0; i &lt; s; i++)
        n.push(r2[t2 + i]);
      return n;
    }, e.CFF.readCharset = function(r2, t2, a2) {
      var n = e._bin, o = [".notdef"], s = r2[t2];
      if (t2++, 0 == s)
        for (var i = 0; i &lt; a2; i++) {
          var h = n.readUshort(r2, t2);
          t2 += 2, o.push(h);
        }
      else {
        if (1 != s && 2 != s)
          throw "error: format: " + s;
        for (; o.length &lt; a2; ) {
          h = n.readUshort(r2, t2);
          t2 += 2;
          var d = 0;
          1 == s ? (d = r2[t2], t2++) : (d = n.readUshort(r2, t2), t2 += 2);
          for (i = 0; i &lt;= d; i++)
            o.push(h), h++;
        }
      }
      return o;
    }, e.CFF.readIndex = function(r2, t2, a2) {
      var n = e._bin, o = n.readUshort(r2, t2) + 1, s = r2[t2 += 2];
      if (t2++, 1 == s)
        for (var i = 0; i &lt; o; i++)
          a2.push(r2[t2 + i]);
      else if (2 == s)
        for (i = 0; i &lt; o; i++)
          a2.push(n.readUshort(r2, t2 + 2 * i));
      else if (3 == s)
        for (i = 0; i &lt; o; i++)
          a2.push(16777215 & n.readUint(r2, t2 + 3 * i - 1));
      else if (1 != o)
        throw "unsupported offset size: " + s + ", count: " + o;
      return (t2 += o * s) - 1;
    }, e.CFF.getCharString = function(r2, t2, a2) {
      var n = e._bin, o = r2[t2], s = r2[t2 + 1];
      r2[t2 + 2], r2[t2 + 3], r2[t2 + 4];
      var i = 1, h = null, d = null;
      o &lt;= 20 && (h = o, i = 1), 12 == o && (h = 100 * o + s, i = 2), 21 &lt;= o && o &lt;= 27 && (h = o, i = 1), 28 == o && (d = n.readShort(r2, t2 + 1), i = 3), 29 &lt;= o && o &lt;= 31 && (h = o, i = 1), 32 &lt;= o && o &lt;= 246 && (d = o - 139, i = 1), 247 &lt;= o && o &lt;= 250 && (d = 256 * (o - 247) + s + 108, i = 2), 251 &lt;= o && o &lt;= 254 && (d = 256 * -(o - 251) - s - 108, i = 2), 255 == o && (d = n.readInt(r2, t2 + 1) / 65535, i = 5), a2.val = null != d ? d : "o" + h, a2.size = i;
    }, e.CFF.readCharString = function(r2, t2, a2) {
      for (var n = t2 + a2, o = e._bin, s = []; t2 &lt; n; ) {
        var i = r2[t2], h = r2[t2 + 1];
        r2[t2 + 2], r2[t2 + 3], r2[t2 + 4];
        var d = 1, f = null, u = null;
        i &lt;= 20 && (f = i, d = 1), 12 == i && (f = 100 * i + h, d = 2), 19 != i && 20 != i || (f = i, d = 2), 21 &lt;= i && i &lt;= 27 && (f = i, d = 1), 28 == i && (u = o.readShort(r2, t2 + 1), d = 3), 29 &lt;= i && i &lt;= 31 && (f = i, d = 1), 32 &lt;= i && i &lt;= 246 && (u = i - 139, d = 1), 247 &lt;= i && i &lt;= 250 && (u = 256 * (i - 247) + h + 108, d = 2), 251 &lt;= i && i &lt;= 254 && (u = 256 * -(i - 251) - h - 108, d = 2), 255 == i && (u = o.readInt(r2, t2 + 1) / 65535, d = 5), s.push(null != u ? u : "o" + f), t2 += d;
      }
      return s;
    }, e.CFF.readDict = function(r2, t2, a2) {
      for (var n = e._bin, o = {}, s = []; t2 &lt; a2; ) {
        var i = r2[t2], h = r2[t2 + 1];
        r2[t2 + 2], r2[t2 + 3], r2[t2 + 4];
        var d = 1, f = null, u = null;
        if (28 == i && (u = n.readShort(r2, t2 + 1), d = 3), 29 == i && (u = n.readInt(r2, t2 + 1), d = 5), 32 &lt;= i && i &lt;= 246 && (u = i - 139, d = 1), 247 &lt;= i && i &lt;= 250 && (u = 256 * (i - 247) + h + 108, d = 2), 251 &lt;= i && i &lt;= 254 && (u = 256 * -(i - 251) - h - 108, d = 2), 255 == i)
          throw u = n.readInt(r2, t2 + 1) / 65535, d = 5, "unknown number";
        if (30 == i) {
          var l = [];
          for (d = 1; ; ) {
            var v = r2[t2 + d];
            d++;
            var c = v >> 4, p = 15 & v;
            if (15 != c && l.push(c), 15 != p && l.push(p), 15 == p)
              break;
          }
          for (var U = "", g = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, ".", "e", "e-", "reserved", "-", "endOfNumber"], S = 0; S &lt; l.length; S++)
            U += g[l[S]];
          u = parseFloat(U);
        }
        if (i &lt;= 21) {
          if (f = ["version", "Notice", "FullName", "FamilyName", "Weight", "FontBBox", "BlueValues", "OtherBlues", "FamilyBlues", "FamilyOtherBlues", "StdHW", "StdVW", "escape", "UniqueID", "XUID", "charset", "Encoding", "CharStrings", "Private", "Subrs", "defaultWidthX", "nominalWidthX"][i], d = 1, 12 == i)
            f = ["Copyright", "isFixedPitch", "ItalicAngle", "UnderlinePosition", "UnderlineThickness", "PaintType", "CharstringType", "FontMatrix", "StrokeWidth", "BlueScale", "BlueShift", "BlueFuzz", "StemSnapH", "StemSnapV", "ForceBold", 0, 0, "LanguageGroup", "ExpansionFactor", "initialRandomSeed", "SyntheticBase", "PostScript", "BaseFontName", "BaseFontBlend", 0, 0, 0, 0, 0, 0, "ROS", "CIDFontVersion", "CIDFontRevision", "CIDFontType", "CIDCount", "UIDBase", "FDArray", "FDSelect", "FontName"][h], d = 2;
        }
        null != f ? (o[f] = 1 == s.length ? s[0] : s, s = []) : s.push(u), t2 += d;
      }
      return o;
    }, e.cmap = {}, e.cmap.parse = function(r2, t2, a2) {
      r2 = new Uint8Array(r2.buffer, t2, a2), t2 = 0;
      var n = e._bin, o = {};
      n.readUshort(r2, t2), t2 += 2;
      var s = n.readUshort(r2, t2);
      t2 += 2;
      var i = [];
      o.tables = [];
      for (var h = 0; h &lt; s; h++) {
        var d = n.readUshort(r2, t2);
        t2 += 2;
        var f = n.readUshort(r2, t2);
        t2 += 2;
        var u = n.readUint(r2, t2);
        t2 += 4;
        var l = "p" + d + "e" + f, v = i.indexOf(u);
        if (-1 == v) {
          var c;
          v = o.tables.length, i.push(u);
          var p = n.readUshort(r2, u);
          0 == p ? c = e.cmap.parse0(r2, u) : 4 == p ? c = e.cmap.parse4(r2, u) : 6 == p ? c = e.cmap.parse6(r2, u) : 12 == p ? c = e.cmap.parse12(r2, u) : console.debug("unknown format: " + p, d, f, u), o.tables.push(c);
        }
        if (null != o[l])
          throw "multiple tables for one platform+encoding";
        o[l] = v;
      }
      return o;
    }, e.cmap.parse0 = function(r2, t2) {
      var a2 = e._bin, n = {};
      n.format = a2.readUshort(r2, t2), t2 += 2;
      var o = a2.readUshort(r2, t2);
      t2 += 2, a2.readUshort(r2, t2), t2 += 2, n.map = [];
      for (var s = 0; s &lt; o - 6; s++)
        n.map.push(r2[t2 + s]);
      return n;
    }, e.cmap.parse4 = function(r2, t2) {
      var a2 = e._bin, n = t2, o = {};
      o.format = a2.readUshort(r2, t2), t2 += 2;
      var s = a2.readUshort(r2, t2);
      t2 += 2, a2.readUshort(r2, t2), t2 += 2;
      var i = a2.readUshort(r2, t2);
      t2 += 2;
      var h = i / 2;
      o.searchRange = a2.readUshort(r2, t2), t2 += 2, o.entrySelector = a2.readUshort(r2, t2), t2 += 2, o.rangeShift = a2.readUshort(r2, t2), t2 += 2, o.endCount = a2.readUshorts(r2, t2, h), t2 += 2 * h, t2 += 2, o.startCount = a2.readUshorts(r2, t2, h), t2 += 2 * h, o.idDelta = [];
      for (var d = 0; d &lt; h; d++)
        o.idDelta.push(a2.readShort(r2, t2)), t2 += 2;
      for (o.idRangeOffset = a2.readUshorts(r2, t2, h), t2 += 2 * h, o.glyphIdArray = []; t2 &lt; n + s; )
        o.glyphIdArray.push(a2.readUshort(r2, t2)), t2 += 2;
      return o;
    }, e.cmap.parse6 = function(r2, t2) {
      var a2 = e._bin, n = {};
      n.format = a2.readUshort(r2, t2), t2 += 2, a2.readUshort(r2, t2), t2 += 2, a2.readUshort(r2, t2), t2 += 2, n.firstCode = a2.readUshort(r2, t2), t2 += 2;
      var o = a2.readUshort(r2, t2);
      t2 += 2, n.glyphIdArray = [];
      for (var s = 0; s &lt; o; s++)
        n.glyphIdArray.push(a2.readUshort(r2, t2)), t2 += 2;
      return n;
    }, e.cmap.parse12 = function(r2, t2) {
      var a2 = e._bin, n = {};
      n.format = a2.readUshort(r2, t2), t2 += 2, t2 += 2, a2.readUint(r2, t2), t2 += 4, a2.readUint(r2, t2), t2 += 4;
      var o = a2.readUint(r2, t2);
      t2 += 4, n.groups = [];
      for (var s = 0; s &lt; o; s++) {
        var i = t2 + 12 * s, h = a2.readUint(r2, i + 0), d = a2.readUint(r2, i + 4), f = a2.readUint(r2, i + 8);
        n.groups.push([h, d, f]);
      }
      return n;
    }, e.glyf = {}, e.glyf.parse = function(r2, e2, t2, a2) {
      for (var n = [], o = 0; o &lt; a2.maxp.numGlyphs; o++)
        n.push(null);
      return n;
    }, e.glyf._parseGlyf = function(r2, t2) {
      var a2 = e._bin, n = r2._data, o = e._tabOffset(n, "glyf", r2._offset) + r2.loca[t2];
      if (r2.loca[t2] == r2.loca[t2 + 1])
        return null;
      var s = {};
      if (s.noc = a2.readShort(n, o), o += 2, s.xMin = a2.readShort(n, o), o += 2, s.yMin = a2.readShort(n, o), o += 2, s.xMax = a2.readShort(n, o), o += 2, s.yMax = a2.readShort(n, o), o += 2, s.xMin >= s.xMax || s.yMin >= s.yMax)
        return null;
      if (s.noc > 0) {
        s.endPts = [];
        for (var i = 0; i &lt; s.noc; i++)
          s.endPts.push(a2.readUshort(n, o)), o += 2;
        var h = a2.readUshort(n, o);
        if (o += 2, n.length - o &lt; h)
          return null;
        s.instructions = a2.readBytes(n, o, h), o += h;
        var d = s.endPts[s.noc - 1] + 1;
        s.flags = [];
        for (i = 0; i &lt; d; i++) {
          var f = n[o];
          if (o++, s.flags.push(f), 0 != (8 & f)) {
            var u = n[o];
            o++;
            for (var l = 0; l &lt; u; l++)
              s.flags.push(f), i++;
          }
        }
        s.xs = [];
        for (i = 0; i &lt; d; i++) {
          var v = 0 != (2 & s.flags[i]), c = 0 != (16 & s.flags[i]);
          v ? (s.xs.push(c ? n[o] : -n[o]), o++) : c ? s.xs.push(0) : (s.xs.push(a2.readShort(n, o)), o += 2);
        }
        s.ys = [];
        for (i = 0; i &lt; d; i++) {
          v = 0 != (4 & s.flags[i]), c = 0 != (32 & s.flags[i]);
          v ? (s.ys.push(c ? n[o] : -n[o]), o++) : c ? s.ys.push(0) : (s.ys.push(a2.readShort(n, o)), o += 2);
        }
        var p = 0, U = 0;
        for (i = 0; i &lt; d; i++)
          p += s.xs[i], U += s.ys[i], s.xs[i] = p, s.ys[i] = U;
      } else {
        var g;
        s.parts = [];
        do {
          g = a2.readUshort(n, o), o += 2;
          var S = { m: { a: 1, b: 0, c: 0, d: 1, tx: 0, ty: 0 }, p1: -1, p2: -1 };
          if (s.parts.push(S), S.glyphIndex = a2.readUshort(n, o), o += 2, 1 & g) {
            var m = a2.readShort(n, o);
            o += 2;
            var b = a2.readShort(n, o);
            o += 2;
          } else {
            m = a2.readInt8(n, o);
            o++;
            b = a2.readInt8(n, o);
            o++;
          }
          2 & g ? (S.m.tx = m, S.m.ty = b) : (S.p1 = m, S.p2 = b), 8 & g ? (S.m.a = S.m.d = a2.readF2dot14(n, o), o += 2) : 64 & g ? (S.m.a = a2.readF2dot14(n, o), o += 2, S.m.d = a2.readF2dot14(n, o), o += 2) : 128 & g && (S.m.a = a2.readF2dot14(n, o), o += 2, S.m.b = a2.readF2dot14(n, o), o += 2, S.m.c = a2.readF2dot14(n, o), o += 2, S.m.d = a2.readF2dot14(n, o), o += 2);
        } while (32 & g);
        if (256 & g) {
          var y = a2.readUshort(n, o);
          o += 2, s.instr = [];
          for (i = 0; i &lt; y; i++)
            s.instr.push(n[o]), o++;
        }
      }
      return s;
    }, e.GDEF = {}, e.GDEF.parse = function(r2, t2, a2, n) {
      var o = t2;
      t2 += 4;
      var s = e._bin.readUshort(r2, t2);
      return { glyphClassDef: 0 === s ? null : e._lctf.readClassDef(r2, o + s) };
    }, e.GPOS = {}, e.GPOS.parse = function(r2, t2, a2, n) {
      return e._lctf.parse(r2, t2, a2, n, e.GPOS.subt);
    }, e.GPOS.subt = function(r2, t2, a2, n) {
      var o = e._bin, s = a2, i = {};
      if (i.fmt = o.readUshort(r2, a2), a2 += 2, 1 == t2 || 2 == t2 || 3 == t2 || 7 == t2 || 8 == t2 && i.fmt &lt;= 2) {
        var h = o.readUshort(r2, a2);
        a2 += 2, i.coverage = e._lctf.readCoverage(r2, h + s);
      }
      if (1 == t2 && 1 == i.fmt) {
        var d = o.readUshort(r2, a2);
        a2 += 2, 0 != d && (i.pos = e.GPOS.readValueRecord(r2, a2, d));
      } else if (2 == t2 && i.fmt >= 1 && i.fmt &lt;= 2) {
        d = o.readUshort(r2, a2);
        a2 += 2;
        var f = o.readUshort(r2, a2);
        a2 += 2;
        var u = e._lctf.numOfOnes(d), l = e._lctf.numOfOnes(f);
        if (1 == i.fmt) {
          i.pairsets = [];
          var v = o.readUshort(r2, a2);
          a2 += 2;
          for (var c = 0; c &lt; v; c++) {
            var p = s + o.readUshort(r2, a2);
            a2 += 2;
            var U = o.readUshort(r2, p);
            p += 2;
            for (var g = [], S = 0; S &lt; U; S++) {
              var m = o.readUshort(r2, p);
              p += 2, 0 != d && (P = e.GPOS.readValueRecord(r2, p, d), p += 2 * u), 0 != f && (x = e.GPOS.readValueRecord(r2, p, f), p += 2 * l), g.push({ gid2: m, val1: P, val2: x });
            }
            i.pairsets.push(g);
          }
        }
        if (2 == i.fmt) {
          var b = o.readUshort(r2, a2);
          a2 += 2;
          var y = o.readUshort(r2, a2);
          a2 += 2;
          var F = o.readUshort(r2, a2);
          a2 += 2;
          var C = o.readUshort(r2, a2);
          a2 += 2, i.classDef1 = e._lctf.readClassDef(r2, s + b), i.classDef2 = e._lctf.readClassDef(r2, s + y), i.matrix = [];
          for (c = 0; c &lt; F; c++) {
            var _ = [];
            for (S = 0; S &lt; C; S++) {
              var P = null, x = null;
              0 != d && (P = e.GPOS.readValueRecord(r2, a2, d), a2 += 2 * u), 0 != f && (x = e.GPOS.readValueRecord(r2, a2, f), a2 += 2 * l), _.push({ val1: P, val2: x });
            }
            i.matrix.push(_);
          }
        }
      } else if (4 == t2 && 1 == i.fmt)
        i.markCoverage = e._lctf.readCoverage(r2, o.readUshort(r2, a2) + s), i.baseCoverage = e._lctf.readCoverage(r2, o.readUshort(r2, a2 + 2) + s), i.markClassCount = o.readUshort(r2, a2 + 4), i.markArray = e.GPOS.readMarkArray(r2, o.readUshort(r2, a2 + 6) + s), i.baseArray = e.GPOS.readBaseArray(r2, o.readUshort(r2, a2 + 8) + s, i.markClassCount);
      else if (6 == t2 && 1 == i.fmt)
        i.mark1Coverage = e._lctf.readCoverage(r2, o.readUshort(r2, a2) + s), i.mark2Coverage = e._lctf.readCoverage(r2, o.readUshort(r2, a2 + 2) + s), i.markClassCount = o.readUshort(r2, a2 + 4), i.mark1Array = e.GPOS.readMarkArray(r2, o.readUshort(r2, a2 + 6) + s), i.mark2Array = e.GPOS.readBaseArray(r2, o.readUshort(r2, a2 + 8) + s, i.markClassCount);
      else {
        if (9 == t2 && 1 == i.fmt) {
          var I = o.readUshort(r2, a2);
          a2 += 2;
          var w = o.readUint(r2, a2);
          if (a2 += 4, 9 == n.ltype)
            n.ltype = I;
          else if (n.ltype != I)
            throw "invalid extension substitution";
          return e.GPOS.subt(r2, n.ltype, s + w);
        }
        console.debug("unsupported GPOS table LookupType", t2, "format", i.fmt);
      }
      return i;
    }, e.GPOS.readValueRecord = function(r2, t2, a2) {
      var n = e._bin, o = [];
      return o.push(1 & a2 ? n.readShort(r2, t2) : 0), t2 += 1 & a2 ? 2 : 0, o.push(2 & a2 ? n.readShort(r2, t2) : 0), t2 += 2 & a2 ? 2 : 0, o.push(4 & a2 ? n.readShort(r2, t2) : 0), t2 += 4 & a2 ? 2 : 0, o.push(8 & a2 ? n.readShort(r2, t2) : 0), t2 += 8 & a2 ? 2 : 0, o;
    }, e.GPOS.readBaseArray = function(r2, t2, a2) {
      var n = e._bin, o = [], s = t2, i = n.readUshort(r2, t2);
      t2 += 2;
      for (var h = 0; h &lt; i; h++) {
        for (var d = [], f = 0; f &lt; a2; f++)
          d.push(e.GPOS.readAnchorRecord(r2, s + n.readUshort(r2, t2))), t2 += 2;
        o.push(d);
      }
      return o;
    }, e.GPOS.readMarkArray = function(r2, t2) {
      var a2 = e._bin, n = [], o = t2, s = a2.readUshort(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = e.GPOS.readAnchorRecord(r2, a2.readUshort(r2, t2 + 2) + o);
        h.markClass = a2.readUshort(r2, t2), n.push(h), t2 += 4;
      }
      return n;
    }, e.GPOS.readAnchorRecord = function(r2, t2) {
      var a2 = e._bin, n = {};
      return n.fmt = a2.readUshort(r2, t2), n.x = a2.readShort(r2, t2 + 2), n.y = a2.readShort(r2, t2 + 4), n;
    }, e.GSUB = {}, e.GSUB.parse = function(r2, t2, a2, n) {
      return e._lctf.parse(r2, t2, a2, n, e.GSUB.subt);
    }, e.GSUB.subt = function(r2, t2, a2, n) {
      var o = e._bin, s = a2, i = {};
      if (i.fmt = o.readUshort(r2, a2), a2 += 2, 1 != t2 && 2 != t2 && 4 != t2 && 5 != t2 && 6 != t2)
        return null;
      if (1 == t2 || 2 == t2 || 4 == t2 || 5 == t2 && i.fmt &lt;= 2 || 6 == t2 && i.fmt &lt;= 2) {
        var h = o.readUshort(r2, a2);
        a2 += 2, i.coverage = e._lctf.readCoverage(r2, s + h);
      }
      if (1 == t2 && i.fmt >= 1 && i.fmt &lt;= 2) {
        if (1 == i.fmt)
          i.delta = o.readShort(r2, a2), a2 += 2;
        else if (2 == i.fmt) {
          var d = o.readUshort(r2, a2);
          a2 += 2, i.newg = o.readUshorts(r2, a2, d), a2 += 2 * i.newg.length;
        }
      } else if (2 == t2 && 1 == i.fmt) {
        d = o.readUshort(r2, a2);
        a2 += 2, i.seqs = [];
        for (var f = 0; f &lt; d; f++) {
          var u = o.readUshort(r2, a2) + s;
          a2 += 2;
          var l = o.readUshort(r2, u);
          i.seqs.push(o.readUshorts(r2, u + 2, l));
        }
      } else if (4 == t2) {
        i.vals = [];
        d = o.readUshort(r2, a2);
        a2 += 2;
        for (f = 0; f &lt; d; f++) {
          var v = o.readUshort(r2, a2);
          a2 += 2, i.vals.push(e.GSUB.readLigatureSet(r2, s + v));
        }
      } else if (5 == t2 && 2 == i.fmt) {
        if (2 == i.fmt) {
          var c = o.readUshort(r2, a2);
          a2 += 2, i.cDef = e._lctf.readClassDef(r2, s + c), i.scset = [];
          var p = o.readUshort(r2, a2);
          a2 += 2;
          for (f = 0; f &lt; p; f++) {
            var U = o.readUshort(r2, a2);
            a2 += 2, i.scset.push(0 == U ? null : e.GSUB.readSubClassSet(r2, s + U));
          }
        }
      } else if (6 == t2 && 3 == i.fmt) {
        if (3 == i.fmt) {
          for (f = 0; f &lt; 3; f++) {
            d = o.readUshort(r2, a2);
            a2 += 2;
            for (var g = [], S = 0; S &lt; d; S++)
              g.push(e._lctf.readCoverage(r2, s + o.readUshort(r2, a2 + 2 * S)));
            a2 += 2 * d, 0 == f && (i.backCvg = g), 1 == f && (i.inptCvg = g), 2 == f && (i.ahedCvg = g);
          }
          d = o.readUshort(r2, a2);
          a2 += 2, i.lookupRec = e.GSUB.readSubstLookupRecords(r2, a2, d);
        }
      } else {
        if (7 == t2 && 1 == i.fmt) {
          var m = o.readUshort(r2, a2);
          a2 += 2;
          var b = o.readUint(r2, a2);
          if (a2 += 4, 9 == n.ltype)
            n.ltype = m;
          else if (n.ltype != m)
            throw "invalid extension substitution";
          return e.GSUB.subt(r2, n.ltype, s + b);
        }
        console.debug("unsupported GSUB table LookupType", t2, "format", i.fmt);
      }
      return i;
    }, e.GSUB.readSubClassSet = function(r2, t2) {
      var a2 = e._bin.readUshort, n = t2, o = [], s = a2(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = a2(r2, t2);
        t2 += 2, o.push(e.GSUB.readSubClassRule(r2, n + h));
      }
      return o;
    }, e.GSUB.readSubClassRule = function(r2, t2) {
      var a2 = e._bin.readUshort, n = {}, o = a2(r2, t2), s = a2(r2, t2 += 2);
      t2 += 2, n.input = [];
      for (var i = 0; i &lt; o - 1; i++)
        n.input.push(a2(r2, t2)), t2 += 2;
      return n.substLookupRecords = e.GSUB.readSubstLookupRecords(r2, t2, s), n;
    }, e.GSUB.readSubstLookupRecords = function(r2, t2, a2) {
      for (var n = e._bin.readUshort, o = [], s = 0; s &lt; a2; s++)
        o.push(n(r2, t2), n(r2, t2 + 2)), t2 += 4;
      return o;
    }, e.GSUB.readChainSubClassSet = function(r2, t2) {
      var a2 = e._bin, n = t2, o = [], s = a2.readUshort(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = a2.readUshort(r2, t2);
        t2 += 2, o.push(e.GSUB.readChainSubClassRule(r2, n + h));
      }
      return o;
    }, e.GSUB.readChainSubClassRule = function(r2, t2) {
      for (var a2 = e._bin, n = {}, o = ["backtrack", "input", "lookahead"], s = 0; s &lt; o.length; s++) {
        var i = a2.readUshort(r2, t2);
        t2 += 2, 1 == s && i--, n[o[s]] = a2.readUshorts(r2, t2, i), t2 += 2 * n[o[s]].length;
      }
      i = a2.readUshort(r2, t2);
      return t2 += 2, n.subst = a2.readUshorts(r2, t2, 2 * i), t2 += 2 * n.subst.length, n;
    }, e.GSUB.readLigatureSet = function(r2, t2) {
      var a2 = e._bin, n = t2, o = [], s = a2.readUshort(r2, t2);
      t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = a2.readUshort(r2, t2);
        t2 += 2, o.push(e.GSUB.readLigature(r2, n + h));
      }
      return o;
    }, e.GSUB.readLigature = function(r2, t2) {
      var a2 = e._bin, n = { chain: [] };
      n.nglyph = a2.readUshort(r2, t2), t2 += 2;
      var o = a2.readUshort(r2, t2);
      t2 += 2;
      for (var s = 0; s &lt; o - 1; s++)
        n.chain.push(a2.readUshort(r2, t2)), t2 += 2;
      return n;
    }, e.head = {}, e.head.parse = function(r2, t2, a2) {
      var n = e._bin, o = {};
      return n.readFixed(r2, t2), t2 += 4, o.fontRevision = n.readFixed(r2, t2), t2 += 4, n.readUint(r2, t2), t2 += 4, n.readUint(r2, t2), t2 += 4, o.flags = n.readUshort(r2, t2), t2 += 2, o.unitsPerEm = n.readUshort(r2, t2), t2 += 2, o.created = n.readUint64(r2, t2), t2 += 8, o.modified = n.readUint64(r2, t2), t2 += 8, o.xMin = n.readShort(r2, t2), t2 += 2, o.yMin = n.readShort(r2, t2), t2 += 2, o.xMax = n.readShort(r2, t2), t2 += 2, o.yMax = n.readShort(r2, t2), t2 += 2, o.macStyle = n.readUshort(r2, t2), t2 += 2, o.lowestRecPPEM = n.readUshort(r2, t2), t2 += 2, o.fontDirectionHint = n.readShort(r2, t2), t2 += 2, o.indexToLocFormat = n.readShort(r2, t2), t2 += 2, o.glyphDataFormat = n.readShort(r2, t2), t2 += 2, o;
    }, e.hhea = {}, e.hhea.parse = function(r2, t2, a2) {
      var n = e._bin, o = {};
      return n.readFixed(r2, t2), t2 += 4, o.ascender = n.readShort(r2, t2), t2 += 2, o.descender = n.readShort(r2, t2), t2 += 2, o.lineGap = n.readShort(r2, t2), t2 += 2, o.advanceWidthMax = n.readUshort(r2, t2), t2 += 2, o.minLeftSideBearing = n.readShort(r2, t2), t2 += 2, o.minRightSideBearing = n.readShort(r2, t2), t2 += 2, o.xMaxExtent = n.readShort(r2, t2), t2 += 2, o.caretSlopeRise = n.readShort(r2, t2), t2 += 2, o.caretSlopeRun = n.readShort(r2, t2), t2 += 2, o.caretOffset = n.readShort(r2, t2), t2 += 2, t2 += 8, o.metricDataFormat = n.readShort(r2, t2), t2 += 2, o.numberOfHMetrics = n.readUshort(r2, t2), t2 += 2, o;
    }, e.hmtx = {}, e.hmtx.parse = function(r2, t2, a2, n) {
      for (var o = e._bin, s = { aWidth: [], lsBearing: [] }, i = 0, h = 0, d = 0; d &lt; n.maxp.numGlyphs; d++)
        d &lt; n.hhea.numberOfHMetrics && (i = o.readUshort(r2, t2), t2 += 2, h = o.readShort(r2, t2), t2 += 2), s.aWidth.push(i), s.lsBearing.push(h);
      return s;
    }, e.kern = {}, e.kern.parse = function(r2, t2, a2, n) {
      var o = e._bin, s = o.readUshort(r2, t2);
      if (t2 += 2, 1 == s)
        return e.kern.parseV1(r2, t2 - 2, a2, n);
      var i = o.readUshort(r2, t2);
      t2 += 2;
      for (var h = { glyph1: [], rval: [] }, d = 0; d &lt; i; d++) {
        t2 += 2;
        a2 = o.readUshort(r2, t2);
        t2 += 2;
        var f = o.readUshort(r2, t2);
        t2 += 2;
        var u = f >>> 8;
        if (0 != (u &= 15))
          throw "unknown kern table format: " + u;
        t2 = e.kern.readFormat0(r2, t2, h);
      }
      return h;
    }, e.kern.parseV1 = function(r2, t2, a2, n) {
      var o = e._bin;
      o.readFixed(r2, t2), t2 += 4;
      var s = o.readUint(r2, t2);
      t2 += 4;
      for (var i = { glyph1: [], rval: [] }, h = 0; h &lt; s; h++) {
        o.readUint(r2, t2), t2 += 4;
        var d = o.readUshort(r2, t2);
        t2 += 2, o.readUshort(r2, t2), t2 += 2;
        var f = d >>> 8;
        if (0 != (f &= 15))
          throw "unknown kern table format: " + f;
        t2 = e.kern.readFormat0(r2, t2, i);
      }
      return i;
    }, e.kern.readFormat0 = function(r2, t2, a2) {
      var n = e._bin, o = -1, s = n.readUshort(r2, t2);
      t2 += 2, n.readUshort(r2, t2), t2 += 2, n.readUshort(r2, t2), t2 += 2, n.readUshort(r2, t2), t2 += 2;
      for (var i = 0; i &lt; s; i++) {
        var h = n.readUshort(r2, t2);
        t2 += 2;
        var d = n.readUshort(r2, t2);
        t2 += 2;
        var f = n.readShort(r2, t2);
        t2 += 2, h != o && (a2.glyph1.push(h), a2.rval.push({ glyph2: [], vals: [] }));
        var u = a2.rval[a2.rval.length - 1];
        u.glyph2.push(d), u.vals.push(f), o = h;
      }
      return t2;
    }, e.loca = {}, e.loca.parse = function(r2, t2, a2, n) {
      var o = e._bin, s = [], i = n.head.indexToLocFormat, h = n.maxp.numGlyphs + 1;
      if (0 == i)
        for (var d = 0; d &lt; h; d++)
          s.push(o.readUshort(r2, t2 + (d &lt;&lt; 1)) &lt;&lt; 1);
      if (1 == i)
        for (d = 0; d &lt; h; d++)
          s.push(o.readUint(r2, t2 + (d &lt;&lt; 2)));
      return s;
    }, e.maxp = {}, e.maxp.parse = function(r2, t2, a2) {
      var n = e._bin, o = {}, s = n.readUint(r2, t2);
      return t2 += 4, o.numGlyphs = n.readUshort(r2, t2), t2 += 2, 65536 == s && (o.maxPoints = n.readUshort(r2, t2), t2 += 2, o.maxContours = n.readUshort(r2, t2), t2 += 2, o.maxCompositePoints = n.readUshort(r2, t2), t2 += 2, o.maxCompositeContours = n.readUshort(r2, t2), t2 += 2, o.maxZones = n.readUshort(r2, t2), t2 += 2, o.maxTwilightPoints = n.readUshort(r2, t2), t2 += 2, o.maxStorage = n.readUshort(r2, t2), t2 += 2, o.maxFunctionDefs = n.readUshort(r2, t2), t2 += 2, o.maxInstructionDefs = n.readUshort(r2, t2), t2 += 2, o.maxStackElements = n.readUshort(r2, t2), t2 += 2, o.maxSizeOfInstructions = n.readUshort(r2, t2), t2 += 2, o.maxComponentElements = n.readUshort(r2, t2), t2 += 2, o.maxComponentDepth = n.readUshort(r2, t2), t2 += 2), o;
    }, e.name = {}, e.name.parse = function(r2, t2, a2) {
      var n = e._bin, o = {};
      n.readUshort(r2, t2), t2 += 2;
      var s = n.readUshort(r2, t2);
      t2 += 2, n.readUshort(r2, t2);
      for (var i, h = ["copyright", "fontFamily", "fontSubfamily", "ID", "fullName", "version", "postScriptName", "trademark", "manufacturer", "designer", "description", "urlVendor", "urlDesigner", "licence", "licenceURL", "---", "typoFamilyName", "typoSubfamilyName", "compatibleFull", "sampleText", "postScriptCID", "wwsFamilyName", "wwsSubfamilyName", "lightPalette", "darkPalette"], d = t2 += 2, f = 0; f &lt; s; f++) {
        var u = n.readUshort(r2, t2);
        t2 += 2;
        var l = n.readUshort(r2, t2);
        t2 += 2;
        var v = n.readUshort(r2, t2);
        t2 += 2;
        var c = n.readUshort(r2, t2);
        t2 += 2;
        var p = n.readUshort(r2, t2);
        t2 += 2;
        var U = n.readUshort(r2, t2);
        t2 += 2;
        var g, S = h[c], m = d + 12 * s + U;
        if (0 == u)
          g = n.readUnicode(r2, m, p / 2);
        else if (3 == u && 0 == l)
          g = n.readUnicode(r2, m, p / 2);
        else if (0 == l)
          g = n.readASCII(r2, m, p);
        else if (1 == l)
          g = n.readUnicode(r2, m, p / 2);
        else if (3 == l)
          g = n.readUnicode(r2, m, p / 2);
        else {
          if (1 != u)
            throw "unknown encoding " + l + ", platformID: " + u;
          g = n.readASCII(r2, m, p), console.debug("reading unknown MAC encoding " + l + " as ASCII");
        }
        var b = "p" + u + "," + v.toString(16);
        null == o[b] && (o[b] = {}), o[b][void 0 !== S ? S : c] = g, o[b]._lang = v;
      }
      for (var y in o)
        if (null != o[y].postScriptName && 1033 == o[y]._lang)
          return o[y];
      for (var y in o)
        if (null != o[y].postScriptName && 0 == o[y]._lang)
          return o[y];
      for (var y in o)
        if (null != o[y].postScriptName && 3084 == o[y]._lang)
          return o[y];
      for (var y in o)
        if (null != o[y].postScriptName)
          return o[y];
      for (var y in o) {
        i = y;
        break;
      }
      return console.debug("returning name table with languageID " + o[i]._lang), o[i];
    }, e["OS/2"] = {}, e["OS/2"].parse = function(r2, t2, a2) {
      var n = e._bin.readUshort(r2, t2);
      t2 += 2;
      var o = {};
      if (0 == n)
        e["OS/2"].version0(r2, t2, o);
      else if (1 == n)
        e["OS/2"].version1(r2, t2, o);
      else if (2 == n || 3 == n || 4 == n)
        e["OS/2"].version2(r2, t2, o);
      else {
        if (5 != n)
          throw "unknown OS/2 table version: " + n;
        e["OS/2"].version5(r2, t2, o);
      }
      return o;
    }, e["OS/2"].version0 = function(r2, t2, a2) {
      var n = e._bin;
      return a2.xAvgCharWidth = n.readShort(r2, t2), t2 += 2, a2.usWeightClass = n.readUshort(r2, t2), t2 += 2, a2.usWidthClass = n.readUshort(r2, t2), t2 += 2, a2.fsType = n.readUshort(r2, t2), t2 += 2, a2.ySubscriptXSize = n.readShort(r2, t2), t2 += 2, a2.ySubscriptYSize = n.readShort(r2, t2), t2 += 2, a2.ySubscriptXOffset = n.readShort(r2, t2), t2 += 2, a2.ySubscriptYOffset = n.readShort(r2, t2), t2 += 2, a2.ySuperscriptXSize = n.readShort(r2, t2), t2 += 2, a2.ySuperscriptYSize = n.readShort(r2, t2), t2 += 2, a2.ySuperscriptXOffset = n.readShort(r2, t2), t2 += 2, a2.ySuperscriptYOffset = n.readShort(r2, t2), t2 += 2, a2.yStrikeoutSize = n.readShort(r2, t2), t2 += 2, a2.yStrikeoutPosition = n.readShort(r2, t2), t2 += 2, a2.sFamilyClass = n.readShort(r2, t2), t2 += 2, a2.panose = n.readBytes(r2, t2, 10), t2 += 10, a2.ulUnicodeRange1 = n.readUint(r2, t2), t2 += 4, a2.ulUnicodeRange2 = n.readUint(r2, t2), t2 += 4, a2.ulUnicodeRange3 = n.readUint(r2, t2), t2 += 4, a2.ulUnicodeRange4 = n.readUint(r2, t2), t2 += 4, a2.achVendID = [n.readInt8(r2, t2), n.readInt8(r2, t2 + 1), n.readInt8(r2, t2 + 2), n.readInt8(r2, t2 + 3)], t2 += 4, a2.fsSelection = n.readUshort(r2, t2), t2 += 2, a2.usFirstCharIndex = n.readUshort(r2, t2), t2 += 2, a2.usLastCharIndex = n.readUshort(r2, t2), t2 += 2, a2.sTypoAscender = n.readShort(r2, t2), t2 += 2, a2.sTypoDescender = n.readShort(r2, t2), t2 += 2, a2.sTypoLineGap = n.readShort(r2, t2), t2 += 2, a2.usWinAscent = n.readUshort(r2, t2), t2 += 2, a2.usWinDescent = n.readUshort(r2, t2), t2 += 2;
    }, e["OS/2"].version1 = function(r2, t2, a2) {
      var n = e._bin;
      return t2 = e["OS/2"].version0(r2, t2, a2), a2.ulCodePageRange1 = n.readUint(r2, t2), t2 += 4, a2.ulCodePageRange2 = n.readUint(r2, t2), t2 += 4;
    }, e["OS/2"].version2 = function(r2, t2, a2) {
      var n = e._bin;
      return t2 = e["OS/2"].version1(r2, t2, a2), a2.sxHeight = n.readShort(r2, t2), t2 += 2, a2.sCapHeight = n.readShort(r2, t2), t2 += 2, a2.usDefault = n.readUshort(r2, t2), t2 += 2, a2.usBreak = n.readUshort(r2, t2), t2 += 2, a2.usMaxContext = n.readUshort(r2, t2), t2 += 2;
    }, e["OS/2"].version5 = function(r2, t2, a2) {
      var n = e._bin;
      return t2 = e["OS/2"].version2(r2, t2, a2), a2.usLowerOpticalPointSize = n.readUshort(r2, t2), t2 += 2, a2.usUpperOpticalPointSize = n.readUshort(r2, t2), t2 += 2;
    }, e.post = {}, e.post.parse = function(r2, t2, a2) {
      var n = e._bin, o = {};
      return o.version = n.readFixed(r2, t2), t2 += 4, o.italicAngle = n.readFixed(r2, t2), t2 += 4, o.underlinePosition = n.readShort(r2, t2), t2 += 2, o.underlineThickness = n.readShort(r2, t2), t2 += 2, o;
    }, null == e && (e = {}), null == e.U && (e.U = {}), e.U.codeToGlyph = function(r2, e2) {
      var t2 = r2.cmap, a2 = -1;
      if (null != t2.p0e4 ? a2 = t2.p0e4 : null != t2.p3e1 ? a2 = t2.p3e1 : null != t2.p1e0 ? a2 = t2.p1e0 : null != t2.p0e3 && (a2 = t2.p0e3), -1 == a2)
        throw "no familiar platform and encoding!";
      var n = t2.tables[a2];
      if (0 == n.format)
        return e2 >= n.map.length ? 0 : n.map[e2];
      if (4 == n.format) {
        for (var o = -1, s = 0; s &lt; n.endCount.length; s++)
          if (e2 &lt;= n.endCount[s]) {
            o = s;
            break;
          }
        if (-1 == o)
          return 0;
        if (n.startCount[o] > e2)
          return 0;
        return 65535 & (0 != n.idRangeOffset[o] ? n.glyphIdArray[e2 - n.startCount[o] + (n.idRangeOffset[o] >> 1) - (n.idRangeOffset.length - o)] : e2 + n.idDelta[o]);
      }
      if (12 == n.format) {
        if (e2 > n.groups[n.groups.length - 1][1])
          return 0;
        for (s = 0; s &lt; n.groups.length; s++) {
          var i = n.groups[s];
          if (i[0] &lt;= e2 && e2 &lt;= i[1])
            return i[2] + (e2 - i[0]);
        }
        return 0;
      }
      throw "unknown cmap table format " + n.format;
    }, e.U.glyphToPath = function(r2, t2) {
      var a2 = { cmds: [], crds: [] };
      if (r2.SVG && r2.SVG.entries[t2]) {
        var n = r2.SVG.entries[t2];
        return null == n ? a2 : ("string" == typeof n && (n = e.SVG.toPath(n), r2.SVG.entries[t2] = n), n);
      }
      if (r2.CFF) {
        var o = { x: 0, y: 0, stack: [], nStems: 0, haveWidth: false, width: r2.CFF.Private ? r2.CFF.Private.defaultWidthX : 0, open: false }, s = r2.CFF, i = r2.CFF.Private;
        if (s.ROS) {
          for (var h = 0; s.FDSelect[h + 2] &lt;= t2; )
            h += 2;
          i = s.FDArray[s.FDSelect[h + 1]].Private;
        }
        e.U._drawCFF(r2.CFF.CharStrings[t2], o, s, i, a2);
      } else
        r2.glyf && e.U._drawGlyf(t2, r2, a2);
      return a2;
    }, e.U._drawGlyf = function(r2, t2, a2) {
      var n = t2.glyf[r2];
      null == n && (n = t2.glyf[r2] = e.glyf._parseGlyf(t2, r2)), null != n && (n.noc > -1 ? e.U._simpleGlyph(n, a2) : e.U._compoGlyph(n, t2, a2));
    }, e.U._simpleGlyph = function(r2, t2) {
      for (var a2 = 0; a2 &lt; r2.noc; a2++) {
        for (var n = 0 == a2 ? 0 : r2.endPts[a2 - 1] + 1, o = r2.endPts[a2], s = n; s &lt;= o; s++) {
          var i = s == n ? o : s - 1, h = s == o ? n : s + 1, d = 1 & r2.flags[s], f = 1 & r2.flags[i], u = 1 & r2.flags[h], l = r2.xs[s], v = r2.ys[s];
          if (s == n)
            if (d) {
              if (!f) {
                e.U.P.moveTo(t2, l, v);
                continue;
              }
              e.U.P.moveTo(t2, r2.xs[i], r2.ys[i]);
            } else
              f ? e.U.P.moveTo(t2, r2.xs[i], r2.ys[i]) : e.U.P.moveTo(t2, (r2.xs[i] + l) / 2, (r2.ys[i] + v) / 2);
          d ? f && e.U.P.lineTo(t2, l, v) : u ? e.U.P.qcurveTo(t2, l, v, r2.xs[h], r2.ys[h]) : e.U.P.qcurveTo(t2, l, v, (l + r2.xs[h]) / 2, (v + r2.ys[h]) / 2);
        }
        e.U.P.closePath(t2);
      }
    }, e.U._compoGlyph = function(r2, t2, a2) {
      for (var n = 0; n &lt; r2.parts.length; n++) {
        var o = { cmds: [], crds: [] }, s = r2.parts[n];
        e.U._drawGlyf(s.glyphIndex, t2, o);
        for (var i = s.m, h = 0; h &lt; o.crds.length; h += 2) {
          var d = o.crds[h], f = o.crds[h + 1];
          a2.crds.push(d * i.a + f * i.b + i.tx), a2.crds.push(d * i.c + f * i.d + i.ty);
        }
        for (h = 0; h &lt; o.cmds.length; h++)
          a2.cmds.push(o.cmds[h]);
      }
    }, e.U._getGlyphClass = function(r2, t2) {
      var a2 = e._lctf.getInterval(t2, r2);
      return -1 == a2 ? 0 : t2[a2 + 2];
    }, e.U._applySubs = function(r2, t2, a2, n) {
      for (var o = r2.length - t2 - 1, s = 0; s &lt; a2.tabs.length; s++)
        if (null != a2.tabs[s]) {
          var i, h = a2.tabs[s];
          if (!h.coverage || -1 != (i = e._lctf.coverageIndex(h.coverage, r2[t2]))) {
            if (1 == a2.ltype)
              r2[t2], 1 == h.fmt ? r2[t2] = r2[t2] + h.delta : r2[t2] = h.newg[i];
            else if (4 == a2.ltype)
              for (var d = h.vals[i], f = 0; f &lt; d.length; f++) {
                var u = d[f], l = u.chain.length;
                if (!(l > o)) {
                  for (var v = true, c = 0, p = 0; p &lt; l; p++) {
                    for (; -1 == r2[t2 + c + (1 + p)]; )
                      c++;
                    u.chain[p] != r2[t2 + c + (1 + p)] && (v = false);
                  }
                  if (v) {
                    r2[t2] = u.nglyph;
                    for (p = 0; p &lt; l + c; p++)
                      r2[t2 + p + 1] = -1;
                    break;
                  }
                }
              }
            else if (5 == a2.ltype && 2 == h.fmt)
              for (var U = e._lctf.getInterval(h.cDef, r2[t2]), g = h.cDef[U + 2], S = h.scset[g], m = 0; m &lt; S.length; m++) {
                var b = S[m], y = b.input;
                if (!(y.length > o)) {
                  for (v = true, p = 0; p &lt; y.length; p++) {
                    var F = e._lctf.getInterval(h.cDef, r2[t2 + 1 + p]);
                    if (-1 == U && h.cDef[F + 2] != y[p]) {
                      v = false;
                      break;
                    }
                  }
                  if (v) {
                    var C = b.substLookupRecords;
                    for (f = 0; f &lt; C.length; f += 2)
                      C[f], C[f + 1];
                  }
                }
              }
            else if (6 == a2.ltype && 3 == h.fmt) {
              if (!e.U._glsCovered(r2, h.backCvg, t2 - h.backCvg.length))
                continue;
              if (!e.U._glsCovered(r2, h.inptCvg, t2))
                continue;
              if (!e.U._glsCovered(r2, h.ahedCvg, t2 + h.inptCvg.length))
                continue;
              var _ = h.lookupRec;
              for (m = 0; m &lt; _.length; m += 2) {
                U = _[m];
                var P = n[_[m + 1]];
                e.U._applySubs(r2, t2 + U, P, n);
              }
            }
          }
        }
    }, e.U._glsCovered = function(r2, t2, a2) {
      for (var n = 0; n &lt; t2.length; n++) {
        if (-1 == e._lctf.coverageIndex(t2[n], r2[a2 + n]))
          return false;
      }
      return true;
    }, e.U.glyphsToPath = function(r2, t2, a2) {
      for (var n = { cmds: [], crds: [] }, o = 0, s = 0; s &lt; t2.length; s++) {
        var i = t2[s];
        if (-1 != i) {
          for (var h = s &lt; t2.length - 1 && -1 != t2[s + 1] ? t2[s + 1] : 0, d = e.U.glyphToPath(r2, i), f = 0; f &lt; d.crds.length; f += 2)
            n.crds.push(d.crds[f] + o), n.crds.push(d.crds[f + 1]);
          a2 && n.cmds.push(a2);
          for (f = 0; f &lt; d.cmds.length; f++)
            n.cmds.push(d.cmds[f]);
          a2 && n.cmds.push("X"), o += r2.hmtx.aWidth[i], s &lt; t2.length - 1 && (o += e.U.getPairAdjustment(r2, i, h));
        }
      }
      return n;
    }, e.U.P = {}, e.U.P.moveTo = function(r2, e2, t2) {
      r2.cmds.push("M"), r2.crds.push(e2, t2);
    }, e.U.P.lineTo = function(r2, e2, t2) {
      r2.cmds.push("L"), r2.crds.push(e2, t2);
    }, e.U.P.curveTo = function(r2, e2, t2, a2, n, o, s) {
      r2.cmds.push("C"), r2.crds.push(e2, t2, a2, n, o, s);
    }, e.U.P.qcurveTo = function(r2, e2, t2, a2, n) {
      r2.cmds.push("Q"), r2.crds.push(e2, t2, a2, n);
    }, e.U.P.closePath = function(r2) {
      r2.cmds.push("Z");
    }, e.U._drawCFF = function(r2, t2, a2, n, o) {
      for (var s = t2.stack, i = t2.nStems, h = t2.haveWidth, d = t2.width, f = t2.open, u = 0, l = t2.x, v = t2.y, c = 0, p = 0, U = 0, g = 0, S = 0, m = 0, b = 0, y = 0, F = 0, C = 0, _ = { val: 0, size: 0 }; u &lt; r2.length; ) {
        e.CFF.getCharString(r2, u, _);
        var P = _.val;
        if (u += _.size, "o1" == P || "o18" == P)
          s.length % 2 != 0 && !h && (d = s.shift() + n.nominalWidthX), i += s.length >> 1, s.length = 0, h = true;
        else if ("o3" == P || "o23" == P) {
          s.length % 2 != 0 && !h && (d = s.shift() + n.nominalWidthX), i += s.length >> 1, s.length = 0, h = true;
        } else if ("o4" == P)
          s.length > 1 && !h && (d = s.shift() + n.nominalWidthX, h = true), f && e.U.P.closePath(o), v += s.pop(), e.U.P.moveTo(o, l, v), f = true;
        else if ("o5" == P)
          for (; s.length > 0; )
            l += s.shift(), v += s.shift(), e.U.P.lineTo(o, l, v);
        else if ("o6" == P || "o7" == P)
          for (var x = s.length, I = "o6" == P, w = 0; w &lt; x; w++) {
            var k = s.shift();
            I ? l += k : v += k, I = !I, e.U.P.lineTo(o, l, v);
          }
        else if ("o8" == P || "o24" == P) {
          x = s.length;
          for (var G = 0; G + 6 &lt;= x; )
            c = l + s.shift(), p = v + s.shift(), U = c + s.shift(), g = p + s.shift(), l = U + s.shift(), v = g + s.shift(), e.U.P.curveTo(o, c, p, U, g, l, v), G += 6;
          "o24" == P && (l += s.shift(), v += s.shift(), e.U.P.lineTo(o, l, v));
        } else {
          if ("o11" == P)
            break;
          if ("o1234" == P || "o1235" == P || "o1236" == P || "o1237" == P)
            "o1234" == P && (p = v, U = (c = l + s.shift()) + s.shift(), C = g = p + s.shift(), m = g, y = v, l = (b = (S = (F = U + s.shift()) + s.shift()) + s.shift()) + s.shift(), e.U.P.curveTo(o, c, p, U, g, F, C), e.U.P.curveTo(o, S, m, b, y, l, v)), "o1235" == P && (c = l + s.shift(), p = v + s.shift(), U = c + s.shift(), g = p + s.shift(), F = U + s.shift(), C = g + s.shift(), S = F + s.shift(), m = C + s.shift(), b = S + s.shift(), y = m + s.shift(), l = b + s.shift(), v = y + s.shift(), s.shift(), e.U.P.curveTo(o, c, p, U, g, F, C), e.U.P.curveTo(o, S, m, b, y, l, v)), "o1236" == P && (c = l + s.shift(), p = v + s.shift(), U = c + s.shift(), C = g = p + s.shift(), m = g, b = (S = (F = U + s.shift()) + s.shift()) + s.shift(), y = m + s.shift(), l = b + s.shift(), e.U.P.curveTo(o, c, p, U, g, F, C), e.U.P.curveTo(o, S, m, b, y, l, v)), "o1237" == P && (c = l + s.shift(), p = v + s.shift(), U = c + s.shift(), g = p + s.shift(), F = U + s.shift(), C = g + s.shift(), S = F + s.shift(), m = C + s.shift(), b = S + s.shift(), y = m + s.shift(), Math.abs(b - l) > Math.abs(y - v) ? l = b + s.shift() : v = y + s.shift(), e.U.P.curveTo(o, c, p, U, g, F, C), e.U.P.curveTo(o, S, m, b, y, l, v));
          else if ("o14" == P) {
            if (s.length > 0 && !h && (d = s.shift() + a2.nominalWidthX, h = true), 4 == s.length) {
              var O = s.shift(), T = s.shift(), D = s.shift(), B = s.shift(), A = e.CFF.glyphBySE(a2, D), R = e.CFF.glyphBySE(a2, B);
              e.U._drawCFF(a2.CharStrings[A], t2, a2, n, o), t2.x = O, t2.y = T, e.U._drawCFF(a2.CharStrings[R], t2, a2, n, o);
            }
            f && (e.U.P.closePath(o), f = false);
          } else if ("o19" == P || "o20" == P) {
            s.length % 2 != 0 && !h && (d = s.shift() + n.nominalWidthX), i += s.length >> 1, s.length = 0, h = true, u += i + 7 >> 3;
          } else if ("o21" == P)
            s.length > 2 && !h && (d = s.shift() + n.nominalWidthX, h = true), v += s.pop(), l += s.pop(), f && e.U.P.closePath(o), e.U.P.moveTo(o, l, v), f = true;
          else if ("o22" == P)
            s.length > 1 && !h && (d = s.shift() + n.nominalWidthX, h = true), l += s.pop(), f && e.U.P.closePath(o), e.U.P.moveTo(o, l, v), f = true;
          else if ("o25" == P) {
            for (; s.length > 6; )
              l += s.shift(), v += s.shift(), e.U.P.lineTo(o, l, v);
            c = l + s.shift(), p = v + s.shift(), U = c + s.shift(), g = p + s.shift(), l = U + s.shift(), v = g + s.shift(), e.U.P.curveTo(o, c, p, U, g, l, v);
          } else if ("o26" == P)
            for (s.length % 2 && (l += s.shift()); s.length > 0; )
              c = l, p = v + s.shift(), l = U = c + s.shift(), v = (g = p + s.shift()) + s.shift(), e.U.P.curveTo(o, c, p, U, g, l, v);
          else if ("o27" == P)
            for (s.length % 2 && (v += s.shift()); s.length > 0; )
              p = v, U = (c = l + s.shift()) + s.shift(), g = p + s.shift(), l = U + s.shift(), v = g, e.U.P.curveTo(o, c, p, U, g, l, v);
          else if ("o10" == P || "o29" == P) {
            var L = "o10" == P ? n : a2;
            if (0 == s.length)
              console.debug("error: empty stack");
            else {
              var W = s.pop(), M = L.Subrs[W + L.Bias];
              t2.x = l, t2.y = v, t2.nStems = i, t2.haveWidth = h, t2.width = d, t2.open = f, e.U._drawCFF(M, t2, a2, n, o), l = t2.x, v = t2.y, i = t2.nStems, h = t2.haveWidth, d = t2.width, f = t2.open;
            }
          } else if ("o30" == P || "o31" == P) {
            var V = s.length, E = (G = 0, "o31" == P);
            for (G += V - (x = -3 & V); G &lt; x; )
              E ? (p = v, U = (c = l + s.shift()) + s.shift(), v = (g = p + s.shift()) + s.shift(), x - G == 5 ? (l = U + s.shift(), G++) : l = U, E = false) : (c = l, p = v + s.shift(), U = c + s.shift(), g = p + s.shift(), l = U + s.shift(), x - G == 5 ? (v = g + s.shift(), G++) : v = g, E = true), e.U.P.curveTo(o, c, p, U, g, l, v), G += 4;
          } else {
            if ("o" == (P + "").charAt(0))
              throw console.debug("Unknown operation: " + P, r2), P;
            s.push(P);
          }
        }
      }
      t2.x = l, t2.y = v, t2.nStems = i, t2.haveWidth = h, t2.width = d, t2.open = f;
    };
    var t = e, a = { Typr: t };
    return r.Typr = t, r.default = a, Object.defineProperty(r, "__esModule", { value: true }), r;
  }({}).Typr;
}
/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering.
Original licenses apply:
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/
function woff2otfFactory() {
  return function(r) {
    var e = Uint8Array, n = Uint16Array, t = Uint32Array, a = new e([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, 0, 0, 0]), i = new e([0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13, 0, 0]), o = new e([16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15]), f = function(r2, e2) {
      for (var a2 = new n(31), i2 = 0; i2 &lt; 31; ++i2)
        a2[i2] = e2 += 1 &lt;&lt; r2[i2 - 1];
      var o2 = new t(a2[30]);
      for (i2 = 1; i2 &lt; 30; ++i2)
        for (var f2 = a2[i2]; f2 &lt; a2[i2 + 1]; ++f2)
          o2[f2] = f2 - a2[i2] &lt;&lt; 5 | i2;
      return [a2, o2];
    }, u = f(a, 2), v = u[0], s = u[1];
    v[28] = 258, s[258] = 28;
    for (var l = f(i, 0)[0], c = new n(32768), g = 0; g &lt; 32768; ++g) {
      var h = (43690 & g) >>> 1 | (21845 & g) &lt;&lt; 1;
      h = (61680 & (h = (52428 & h) >>> 2 | (13107 & h) &lt;&lt; 2)) >>> 4 | (3855 & h) &lt;&lt; 4, c[g] = ((65280 & h) >>> 8 | (255 & h) &lt;&lt; 8) >>> 1;
    }
    var w = function(r2, e2, t2) {
      for (var a2 = r2.length, i2 = 0, o2 = new n(e2); i2 &lt; a2; ++i2)
        ++o2[r2[i2] - 1];
      var f2, u2 = new n(e2);
      for (i2 = 0; i2 &lt; e2; ++i2)
        u2[i2] = u2[i2 - 1] + o2[i2 - 1] &lt;&lt; 1;
      if (t2) {
        f2 = new n(1 &lt;&lt; e2);
        var v2 = 15 - e2;
        for (i2 = 0; i2 &lt; a2; ++i2)
          if (r2[i2])
            for (var s2 = i2 &lt;&lt; 4 | r2[i2], l2 = e2 - r2[i2], g2 = u2[r2[i2] - 1]++ &lt;&lt; l2, h2 = g2 | (1 &lt;&lt; l2) - 1; g2 &lt;= h2; ++g2)
              f2[c[g2] >>> v2] = s2;
      } else
        for (f2 = new n(a2), i2 = 0; i2 &lt; a2; ++i2)
          r2[i2] && (f2[i2] = c[u2[r2[i2] - 1]++] >>> 15 - r2[i2]);
      return f2;
    }, d = new e(288);
    for (g = 0; g &lt; 144; ++g)
      d[g] = 8;
    for (g = 144; g &lt; 256; ++g)
      d[g] = 9;
    for (g = 256; g &lt; 280; ++g)
      d[g] = 7;
    for (g = 280; g &lt; 288; ++g)
      d[g] = 8;
    var m = new e(32);
    for (g = 0; g &lt; 32; ++g)
      m[g] = 5;
    var b = w(d, 9, 1), p = w(m, 5, 1), y = function(r2) {
      for (var e2 = r2[0], n2 = 1; n2 &lt; r2.length; ++n2)
        r2[n2] > e2 && (e2 = r2[n2]);
      return e2;
    }, L = function(r2, e2, n2) {
      var t2 = e2 / 8 | 0;
      return (r2[t2] | r2[t2 + 1] &lt;&lt; 8) >> (7 & e2) & n2;
    }, U = function(r2, e2) {
      var n2 = e2 / 8 | 0;
      return (r2[n2] | r2[n2 + 1] &lt;&lt; 8 | r2[n2 + 2] &lt;&lt; 16) >> (7 & e2);
    }, k = ["unexpected EOF", "invalid block type", "invalid length/literal", "invalid distance", "stream finished", "no stream handler", , "no callback", "invalid UTF-8 data", "extra field too long", "date not in range 1980-2099", "filename too long", "stream finishing", "invalid zip data"], T = function(r2, e2, n2) {
      var t2 = new Error(e2 || k[r2]);
      if (t2.code = r2, Error.captureStackTrace && Error.captureStackTrace(t2, T), !n2)
        throw t2;
      return t2;
    }, O = function(r2, f2, u2) {
      var s2 = r2.length;
      if (!s2 || u2 && !u2.l && s2 &lt; 5)
        return f2 || new e(0);
      var c2 = !f2 || u2, g2 = !u2 || u2.i;
      u2 || (u2 = {}), f2 || (f2 = new e(3 * s2));
      var h2, d2 = function(r3) {
        var n2 = f2.length;
        if (r3 > n2) {
          var t2 = new e(Math.max(2 * n2, r3));
          t2.set(f2), f2 = t2;
        }
      }, m2 = u2.f || 0, k2 = u2.p || 0, O2 = u2.b || 0, A2 = u2.l, x2 = u2.d, E = u2.m, D = u2.n, M = 8 * s2;
      do {
        if (!A2) {
          u2.f = m2 = L(r2, k2, 1);
          var S = L(r2, k2 + 1, 3);
          if (k2 += 3, !S) {
            var V = r2[(I = ((h2 = k2) / 8 | 0) + (7 & h2 && 1) + 4) - 4] | r2[I - 3] &lt;&lt; 8, _ = I + V;
            if (_ > s2) {
              g2 && T(0);
              break;
            }
            c2 && d2(O2 + V), f2.set(r2.subarray(I, _), O2), u2.b = O2 += V, u2.p = k2 = 8 * _;
            continue;
          }
          if (1 == S)
            A2 = b, x2 = p, E = 9, D = 5;
          else if (2 == S) {
            var j = L(r2, k2, 31) + 257, z = L(r2, k2 + 10, 15) + 4, C = j + L(r2, k2 + 5, 31) + 1;
            k2 += 14;
            for (var F = new e(C), P = new e(19), q = 0; q &lt; z; ++q)
              P[o[q]] = L(r2, k2 + 3 * q, 7);
            k2 += 3 * z;
            var B = y(P), G = (1 &lt;&lt; B) - 1, H = w(P, B, 1);
            for (q = 0; q &lt; C; ) {
              var I, J = H[L(r2, k2, G)];
              if (k2 += 15 & J, (I = J >>> 4) &lt; 16)
                F[q++] = I;
              else {
                var K = 0, N = 0;
                for (16 == I ? (N = 3 + L(r2, k2, 3), k2 += 2, K = F[q - 1]) : 17 == I ? (N = 3 + L(r2, k2, 7), k2 += 3) : 18 == I && (N = 11 + L(r2, k2, 127), k2 += 7); N--; )
                  F[q++] = K;
              }
            }
            var Q = F.subarray(0, j), R = F.subarray(j);
            E = y(Q), D = y(R), A2 = w(Q, E, 1), x2 = w(R, D, 1);
          } else
            T(1);
          if (k2 > M) {
            g2 && T(0);
            break;
          }
        }
        c2 && d2(O2 + 131072);
        for (var W = (1 &lt;&lt; E) - 1, X = (1 &lt;&lt; D) - 1, Y = k2; ; Y = k2) {
          var Z = (K = A2[U(r2, k2) & W]) >>> 4;
          if ((k2 += 15 & K) > M) {
            g2 && T(0);
            break;
          }
          if (K || T(2), Z &lt; 256)
            f2[O2++] = Z;
          else {
            if (256 == Z) {
              Y = k2, A2 = null;
              break;
            }
            var $ = Z - 254;
            if (Z > 264) {
              var rr = a[q = Z - 257];
              $ = L(r2, k2, (1 &lt;&lt; rr) - 1) + v[q], k2 += rr;
            }
            var er = x2[U(r2, k2) & X], nr = er >>> 4;
            er || T(3), k2 += 15 & er;
            R = l[nr];
            if (nr > 3) {
              rr = i[nr];
              R += U(r2, k2) & (1 &lt;&lt; rr) - 1, k2 += rr;
            }
            if (k2 > M) {
              g2 && T(0);
              break;
            }
            c2 && d2(O2 + 131072);
            for (var tr = O2 + $; O2 &lt; tr; O2 += 4)
              f2[O2] = f2[O2 - R], f2[O2 + 1] = f2[O2 + 1 - R], f2[O2 + 2] = f2[O2 + 2 - R], f2[O2 + 3] = f2[O2 + 3 - R];
            O2 = tr;
          }
        }
        u2.l = A2, u2.p = Y, u2.b = O2, A2 && (m2 = 1, u2.m = E, u2.d = x2, u2.n = D);
      } while (!m2);
      return O2 == f2.length ? f2 : function(r3, a2, i2) {
        (null == a2 || a2 &lt; 0) && (a2 = 0), (null == i2 || i2 > r3.length) && (i2 = r3.length);
        var o2 = new (r3 instanceof n ? n : r3 instanceof t ? t : e)(i2 - a2);
        return o2.set(r3.subarray(a2, i2)), o2;
      }(f2, 0, O2);
    }, A = new e(0);
    var x = "undefined" != typeof TextDecoder && new TextDecoder();
    try {
      x.decode(A, { stream: true }), 1;
    } catch (r2) {
    }
    return r.convert_streams = function(r2) {
      var e2 = new DataView(r2), n2 = 0;
      function t2() {
        var r3 = e2.getUint16(n2);
        return n2 += 2, r3;
      }
      function a2() {
        var r3 = e2.getUint32(n2);
        return n2 += 4, r3;
      }
      function i2(r3) {
        m2.setUint16(b2, r3), b2 += 2;
      }
      function o2(r3) {
        m2.setUint32(b2, r3), b2 += 4;
      }
      for (var f2 = { signature: a2(), flavor: a2(), length: a2(), numTables: t2(), reserved: t2(), totalSfntSize: a2(), majorVersion: t2(), minorVersion: t2(), metaOffset: a2(), metaLength: a2(), metaOrigLength: a2(), privOffset: a2(), privLength: a2() }, u2 = 0; Math.pow(2, u2) &lt;= f2.numTables; )
        u2++;
      u2--;
      for (var v2 = 16 * Math.pow(2, u2), s2 = 16 * f2.numTables - v2, l2 = 12, c2 = [], g2 = 0; g2 &lt; f2.numTables; g2++)
        c2.push({ tag: a2(), offset: a2(), compLength: a2(), origLength: a2(), origChecksum: a2() }), l2 += 16;
      var h2, w2 = new Uint8Array(12 + 16 * c2.length + c2.reduce(function(r3, e3) {
        return r3 + e3.origLength + 4;
      }, 0)), d2 = w2.buffer, m2 = new DataView(d2), b2 = 0;
      return o2(f2.flavor), i2(f2.numTables), i2(v2), i2(u2), i2(s2), c2.forEach(function(r3) {
        o2(r3.tag), o2(r3.origChecksum), o2(l2), o2(r3.origLength), r3.outOffset = l2, (l2 += r3.origLength) % 4 != 0 && (l2 += 4 - l2 % 4);
      }), c2.forEach(function(e3) {
        var n3, t3 = r2.slice(e3.offset, e3.offset + e3.compLength);
        if (e3.compLength != e3.origLength) {
          var a3 = new Uint8Array(e3.origLength);
          n3 = new Uint8Array(t3, 2), O(n3, a3);
        } else
          a3 = new Uint8Array(t3);
        w2.set(a3, e3.outOffset);
        var i3 = 0;
        (l2 = e3.outOffset + e3.origLength) % 4 != 0 && (i3 = 4 - l2 % 4), w2.set(new Uint8Array(i3).buffer, e3.outOffset + e3.origLength), h2 = l2 + i3;
      }), d2.slice(0, h2);
    }, Object.defineProperty(r, "__esModule", { value: true }), r;
  }({}).convert_streams;
}
function parserFactory(Typr, woff2otf) {
  const cmdArgLengths = {
    M: 2,
    L: 2,
    Q: 4,
    C: 6,
    Z: 0
  };
  const joiningTypeRawData = { "C": "18g,ca,368,1kz", "D": "17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v", "R": "17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6", "L": "x9u,jff,a,fd,jv", "T": "4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n" };
  const JT_LEFT = 1, JT_RIGHT = 2, JT_DUAL = 4, JT_TRANSPARENT = 8, JT_JOIN_CAUSING = 16, JT_NON_JOINING = 32;
  let joiningTypeMap;
  function getCharJoiningType(ch) {
    if (!joiningTypeMap) {
      const m = {
        R: JT_RIGHT,
        L: JT_LEFT,
        D: JT_DUAL,
        C: JT_JOIN_CAUSING,
        U: JT_NON_JOINING,
        T: JT_TRANSPARENT
      };
      joiningTypeMap = /* @__PURE__ */ new Map();
      for (let type in joiningTypeRawData) {
        let lastCode = 0;
        joiningTypeRawData[type].split(",").forEach((range) => {
          let [skip, step] = range.split("+");
          skip = parseInt(skip, 36);
          step = step ? parseInt(step, 36) : 0;
          joiningTypeMap.set(lastCode += skip, m[type]);
          for (let i = step; i--; ) {
            joiningTypeMap.set(++lastCode, m[type]);
          }
        });
      }
    }
    return joiningTypeMap.get(ch) || JT_NON_JOINING;
  }
  const ISOL = 1, INIT = 2, FINA = 3, MEDI = 4;
  const formsToFeatures = [null, "isol", "init", "fina", "medi"];
  function detectJoiningForms(str) {
    const joiningForms = new Uint8Array(str.length);
    let prevJoiningType = JT_NON_JOINING;
    let prevForm = ISOL;
    let prevIndex = -1;
    for (let i = 0; i &lt; str.length; i++) {
      const code = str.codePointAt(i);
      let joiningType = getCharJoiningType(code) | 0;
      let form = ISOL;
      if (joiningType & JT_TRANSPARENT) {
        continue;
      }
      if (prevJoiningType & (JT_LEFT | JT_DUAL | JT_JOIN_CAUSING)) {
        if (joiningType & (JT_RIGHT | JT_DUAL | JT_JOIN_CAUSING)) {
          form = FINA;
          if (prevForm === ISOL || prevForm === FINA) {
            joiningForms[prevIndex]++;
          }
        } else if (joiningType & (JT_LEFT | JT_NON_JOINING)) {
          if (prevForm === INIT || prevForm === MEDI) {
            joiningForms[prevIndex]--;
          }
        }
      } else if (prevJoiningType & (JT_RIGHT | JT_NON_JOINING)) {
        if (prevForm === INIT || prevForm === MEDI) {
          joiningForms[prevIndex]--;
        }
      }
      prevForm = joiningForms[i] = form;
      prevJoiningType = joiningType;
      prevIndex = i;
      if (code > 65535)
        i++;
    }
    return joiningForms;
  }
  function stringToGlyphs(font, str) {
    const glyphIds = [];
    for (let i = 0; i &lt; str.length; i++) {
      const cc = str.codePointAt(i);
      if (cc > 65535)
        i++;
      glyphIds.push(Typr.U.codeToGlyph(font, cc));
    }
    const gsub = font["GSUB"];
    if (gsub) {
      const { lookupList, featureList } = gsub;
      let joiningForms;
      const supportedFeatures = /^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/;
      const usedLookups = [];
      featureList.forEach((feature) => {
        if (supportedFeatures.test(feature.tag)) {
          for (let ti = 0; ti &lt; feature.tab.length; ti++) {
            if (usedLookups[feature.tab[ti]])
              continue;
            usedLookups[feature.tab[ti]] = true;
            const tab = lookupList[feature.tab[ti]];
            const isJoiningFeature = /^(isol|init|fina|medi)$/.test(feature.tag);
            if (isJoiningFeature && !joiningForms) {
              joiningForms = detectJoiningForms(str);
            }
            for (let ci = 0; ci &lt; glyphIds.length; ci++) {
              if (!joiningForms || !isJoiningFeature || formsToFeatures[joiningForms[ci]] === feature.tag) {
                Typr.U._applySubs(glyphIds, ci, tab, lookupList);
              }
            }
          }
        }
      });
    }
    return glyphIds;
  }
  function calcGlyphPositions(font, glyphIds) {
    const positions = new Int16Array(glyphIds.length * 3);
    let glyphIndex = 0;
    for (; glyphIndex &lt; glyphIds.length; glyphIndex++) {
      const glyphId = glyphIds[glyphIndex];
      if (glyphId === -1)
        continue;
      positions[glyphIndex * 3 + 2] = font.hmtx.aWidth[glyphId];
      const gpos = font.GPOS;
      if (gpos) {
        const llist = gpos.lookupList;
        for (let i = 0; i &lt; llist.length; i++) {
          const lookup = llist[i];
          for (let j = 0; j &lt; lookup.tabs.length; j++) {
            const tab = lookup.tabs[j];
            if (lookup.ltype === 1) {
              const ind = Typr._lctf.coverageIndex(tab.coverage, glyphId);
              if (ind !== -1 && tab.pos) {
                applyValueRecord(tab.pos, glyphIndex);
                break;
              }
            } else if (lookup.ltype === 2) {
              let adj = null;
              let prevGlyphIndex = getPrevGlyphIndex();
              if (prevGlyphIndex !== -1) {
                const coverageIndex = Typr._lctf.coverageIndex(tab.coverage, glyphIds[prevGlyphIndex]);
                if (coverageIndex !== -1) {
                  if (tab.fmt === 1) {
                    const right = tab.pairsets[coverageIndex];
                    for (let k = 0; k &lt; right.length; k++) {
                      if (right[k].gid2 === glyphId)
                        adj = right[k];
                    }
                  } else if (tab.fmt === 2) {
                    const c1 = Typr.U._getGlyphClass(glyphIds[prevGlyphIndex], tab.classDef1);
                    const c2 = Typr.U._getGlyphClass(glyphId, tab.classDef2);
                    adj = tab.matrix[c1][c2];
                  }
                  if (adj) {
                    if (adj.val1)
                      applyValueRecord(adj.val1, prevGlyphIndex);
                    if (adj.val2)
                      applyValueRecord(adj.val2, glyphIndex);
                    break;
                  }
                }
              }
            } else if (lookup.ltype === 4) {
              const markArrIndex = Typr._lctf.coverageIndex(tab.markCoverage, glyphId);
              if (markArrIndex !== -1) {
                const baseGlyphIndex = getPrevGlyphIndex(isBaseGlyph);
                const baseArrIndex = baseGlyphIndex === -1 ? -1 : Typr._lctf.coverageIndex(tab.baseCoverage, glyphIds[baseGlyphIndex]);
                if (baseArrIndex !== -1) {
                  const markRecord = tab.markArray[markArrIndex];
                  const baseAnchor = tab.baseArray[baseArrIndex][markRecord.markClass];
                  positions[glyphIndex * 3] = baseAnchor.x - markRecord.x + positions[baseGlyphIndex * 3] - positions[baseGlyphIndex * 3 + 2];
                  positions[glyphIndex * 3 + 1] = baseAnchor.y - markRecord.y + positions[baseGlyphIndex * 3 + 1];
                  break;
                }
              }
            } else if (lookup.ltype === 6) {
              const mark1ArrIndex = Typr._lctf.coverageIndex(tab.mark1Coverage, glyphId);
              if (mark1ArrIndex !== -1) {
                const prevGlyphIndex = getPrevGlyphIndex();
                if (prevGlyphIndex !== -1) {
                  const prevGlyphId = glyphIds[prevGlyphIndex];
                  if (getGlyphClass(font, prevGlyphId) === 3) {
                    const mark2ArrIndex = Typr._lctf.coverageIndex(tab.mark2Coverage, prevGlyphId);
                    if (mark2ArrIndex !== -1) {
                      const mark1Record = tab.mark1Array[mark1ArrIndex];
                      const mark2Anchor = tab.mark2Array[mark2ArrIndex][mark1Record.markClass];
                      positions[glyphIndex * 3] = mark2Anchor.x - mark1Record.x + positions[prevGlyphIndex * 3] - positions[prevGlyphIndex * 3 + 2];
                      positions[glyphIndex * 3 + 1] = mark2Anchor.y - mark1Record.y + positions[prevGlyphIndex * 3 + 1];
                      break;
                    }
                  }
                }
              }
            }
          }
        }
      } else if (font.kern && !font.cff) {
        const prevGlyphIndex = getPrevGlyphIndex();
        if (prevGlyphIndex !== -1) {
          const ind1 = font.kern.glyph1.indexOf(glyphIds[prevGlyphIndex]);
          if (ind1 !== -1) {
            const ind2 = font.kern.rval[ind1].glyph2.indexOf(glyphId);
            if (ind2 !== -1) {
              positions[prevGlyphIndex * 3 + 2] += font.kern.rval[ind1].vals[ind2];
            }
          }
        }
      }
    }
    return positions;
    function getPrevGlyphIndex(filter) {
      for (let i = glyphIndex - 1; i >= 0; i--) {
        if (glyphIds[i] !== -1 && (!filter || filter(glyphIds[i]))) {
          return i;
        }
      }
      return -1;
    }
    function isBaseGlyph(glyphId) {
      return getGlyphClass(font, glyphId) === 1;
    }
    function applyValueRecord(source, gi) {
      for (let i = 0; i &lt; 3; i++) {
        positions[gi * 3 + i] += source[i] || 0;
      }
    }
  }
  function getGlyphClass(font, glyphId) {
    const classDef = font.GDEF && font.GDEF.glyphClassDef;
    return classDef ? Typr.U._getGlyphClass(glyphId, classDef) : 0;
  }
  function firstNum(...args) {
    for (let i = 0; i &lt; args.length; i++) {
      if (typeof args[i] === "number") {
        return args[i];
      }
    }
  }
  function wrapFontObj(typrFont) {
    const glyphMap = /* @__PURE__ */ Object.create(null);
    const os2 = typrFont["OS/2"];
    const hhea = typrFont.hhea;
    const unitsPerEm = typrFont.head.unitsPerEm;
    const ascender = firstNum(os2 && os2.sTypoAscender, hhea && hhea.ascender, unitsPerEm);
    const fontObj = {
      unitsPerEm,
      ascender,
      descender: firstNum(os2 && os2.sTypoDescender, hhea && hhea.descender, 0),
      capHeight: firstNum(os2 && os2.sCapHeight, ascender),
      xHeight: firstNum(os2 && os2.sxHeight, ascender),
      lineGap: firstNum(os2 && os2.sTypoLineGap, hhea && hhea.lineGap),
      supportsCodePoint(code) {
        return Typr.U.codeToGlyph(typrFont, code) > 0;
      },
      forEachGlyph(text, fontSize, letterSpacing, callback) {
        let penX = 0;
        const fontScale = 1 / fontObj.unitsPerEm * fontSize;
        const glyphIds = stringToGlyphs(typrFont, text);
        let charIndex = 0;
        const positions = calcGlyphPositions(typrFont, glyphIds);
        glyphIds.forEach((glyphId, i) => {
          if (glyphId !== -1) {
            let glyphObj = glyphMap[glyphId];
            if (!glyphObj) {
              const { cmds, crds } = Typr.U.glyphToPath(typrFont, glyphId);
              let path = "";
              let crdsIdx = 0;
              for (let i2 = 0, len = cmds.length; i2 &lt; len; i2++) {
                const numArgs = cmdArgLengths[cmds[i2]];
                path += cmds[i2];
                for (let j = 1; j &lt;= numArgs; j++) {
                  path += (j > 1 ? "," : "") + crds[crdsIdx++];
                }
              }
              let xMin, yMin, xMax, yMax;
              if (crds.length) {
                xMin = yMin = Infinity;
                xMax = yMax = -Infinity;
                for (let i2 = 0, len = crds.length; i2 &lt; len; i2 += 2) {
                  let x = crds[i2];
                  let y = crds[i2 + 1];
                  if (x &lt; xMin)
                    xMin = x;
                  if (y &lt; yMin)
                    yMin = y;
                  if (x > xMax)
                    xMax = x;
                  if (y > yMax)
                    yMax = y;
                }
              } else {
                xMin = xMax = yMin = yMax = 0;
              }
              glyphObj = glyphMap[glyphId] = {
                index: glyphId,
                advanceWidth: typrFont.hmtx.aWidth[glyphId],
                xMin,
                yMin,
                xMax,
                yMax,
                path
              };
            }
            callback.call(
              null,
              glyphObj,
              penX + positions[i * 3] * fontScale,
              positions[i * 3 + 1] * fontScale,
              charIndex
            );
            penX += positions[i * 3 + 2] * fontScale;
            if (letterSpacing) {
              penX += letterSpacing * fontSize;
            }
          }
          charIndex += text.codePointAt(charIndex) > 65535 ? 2 : 1;
        });
        return penX;
      }
    };
    return fontObj;
  }
  return function parse(buffer) {
    const peek = new Uint8Array(buffer, 0, 4);
    const tag = Typr._bin.readASCII(peek, 0, 4);
    if (tag === "wOFF") {
      buffer = woff2otf(buffer);
    } else if (tag === "wOF2") {
      throw new Error("woff2 fonts not supported");
    }
    return wrapFontObj(Typr.parse(buffer)[0]);
  };
}
const workerModule = /* @__PURE__ */ defineWorkerModule({
  name: "Typr Font Parser",
  dependencies: [typrFactory, woff2otfFactory, parserFactory],
  init(typrFactory2, woff2otfFactory2, parserFactory2) {
    const Typr = typrFactory2();
    const woff2otf = woff2otfFactory2();
    return parserFactory2(Typr, woff2otf);
  }
});
/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering.
Original MIT license applies
*/
function unicodeFontResolverClientFactory() {
  return function(t) {
    var n = function() {
      this.buckets = /* @__PURE__ */ new Map();
    };
    n.prototype.add = function(t2) {
      var n2 = t2 >> 5;
      this.buckets.set(n2, (this.buckets.get(n2) || 0) | 1 &lt;&lt; (31 & t2));
    }, n.prototype.has = function(t2) {
      var n2 = this.buckets.get(t2 >> 5);
      return void 0 !== n2 && 0 != (n2 & 1 &lt;&lt; (31 & t2));
    }, n.prototype.serialize = function() {
      var t2 = [];
      return this.buckets.forEach(function(n2, r2) {
        t2.push((+r2).toString(36) + ":" + n2.toString(36));
      }), t2.join(",");
    }, n.prototype.deserialize = function(t2) {
      var n2 = this;
      this.buckets.clear(), t2.split(",").forEach(function(t3) {
        var r2 = t3.split(":");
        n2.buckets.set(parseInt(r2[0], 36), parseInt(r2[1], 36));
      });
    };
    var r = Math.pow(2, 8), e = r - 1, o = ~e;
    function a(t2) {
      var n2 = function(t3) {
        return t3 & o;
      }(t2).toString(16), e2 = function(t3) {
        return (t3 & o) + r - 1;
      }(t2).toString(16);
      return "codepoint-index/plane" + (t2 >> 16) + "/" + n2 + "-" + e2 + ".json";
    }
    function i(t2, n2) {
      var r2 = t2 & e, o2 = n2.codePointAt(r2 / 6 | 0);
      return 0 != ((o2 = (o2 || 48) - 48) & 1 &lt;&lt; r2 % 6);
    }
    function u(t2, n2) {
      var r2;
      (r2 = t2, r2.replace(/U\+/gi, "").replace(/^,+|,+$/g, "").split(/,+/).map(function(t3) {
        return t3.split("-").map(function(t4) {
          return parseInt(t4.trim(), 16);
        });
      })).forEach(function(t3) {
        var r3 = t3[0], e2 = t3[1];
        void 0 === e2 && (e2 = r3), n2(r3, e2);
      });
    }
    function c(t2, n2) {
      u(t2, function(t3, r2) {
        for (var e2 = t3; e2 &lt;= r2; e2++)
          n2(e2);
      });
    }
    var s = {}, f = {}, l = /* @__PURE__ */ new WeakMap(), v = "https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";
    function d(t2) {
      var r2 = l.get(t2);
      return r2 || (r2 = new n(), c(t2.ranges, function(t3) {
        return r2.add(t3);
      }), l.set(t2, r2)), r2;
    }
    var h, p = /* @__PURE__ */ new Map();
    function g(t2, n2, r2) {
      return t2[n2] ? n2 : t2[r2] ? r2 : function(t3) {
        for (var n3 in t3)
          return n3;
      }(t2);
    }
    function w(t2, n2) {
      var r2 = n2;
      if (!t2.includes(r2)) {
        r2 = 1 / 0;
        for (var e2 = 0; e2 &lt; t2.length; e2++)
          Math.abs(t2[e2] - n2) &lt; Math.abs(r2 - n2) && (r2 = t2[e2]);
      }
      return r2;
    }
    function k(t2) {
      return h || (h = /* @__PURE__ */ new Set(), c("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000", function(t3) {
        h.add(t3);
      })), h.has(t2);
    }
    return t.CodePointSet = n, t.clearCache = function() {
      s = {}, f = {};
    }, t.getFontsForString = function(t2, n2) {
      void 0 === n2 && (n2 = {});
      var r2, e2 = n2.lang;
      void 0 === e2 && (e2 = /\p{Script=Hangul}/u.test(r2 = t2) ? "ko" : /\p{Script=Hiragana}|\p{Script=Katakana}/u.test(r2) ? "ja" : "en");
      var o2 = n2.category;
      void 0 === o2 && (o2 = "sans-serif");
      var u2 = n2.style;
      void 0 === u2 && (u2 = "normal");
      var c2 = n2.weight;
      void 0 === c2 && (c2 = 400);
      var l2 = (n2.dataUrl || v).replace(/\/$/g, ""), h2 = /* @__PURE__ */ new Map(), y = new Uint8Array(t2.length), b = {}, m = {}, A = new Array(t2.length), S = /* @__PURE__ */ new Map(), j = false;
      function M(t3) {
        var n3 = p.get(t3);
        return n3 || (n3 = fetch(l2 + "/" + t3).then(function(t4) {
          if (!t4.ok)
            throw new Error(t4.statusText);
          return t4.json().then(function(t5) {
            if (!Array.isArray(t5) || 1 !== t5[0])
              throw new Error("Incorrect schema version; need 1, got " + t5[0]);
            return t5[1];
          });
        }).catch(function(n4) {
          if (l2 !== v)
            return j || (console.error('unicode-font-resolver: Failed loading from dataUrl "' + l2 + '", trying default CDN. ' + n4.message), j = true), l2 = v, p.delete(t3), M(t3);
          throw n4;
        }), p.set(t3, n3)), n3;
      }
      for (var P = function(n3) {
        var r3 = t2.codePointAt(n3), e3 = a(r3);
        A[n3] = e3, s[e3] || S.has(e3) || S.set(e3, M(e3).then(function(t3) {
          s[e3] = t3;
        })), r3 > 65535 && (n3++, E = n3);
      }, E = 0; E &lt; t2.length; E++)
        P(E);
      return Promise.all(S.values()).then(function() {
        S.clear();
        for (var n3 = function(n4) {
          var o3 = t2.codePointAt(n4), a2 = null, u3 = s[A[n4]], c3 = void 0;
          for (var l3 in u3) {
            var v2 = m[l3];
            if (void 0 === v2 && (v2 = m[l3] = new RegExp(l3).test(e2 || "en")), v2) {
              for (var d2 in c3 = l3, u3[l3])
                if (i(o3, u3[l3][d2])) {
                  a2 = d2;
                  break;
                }
              break;
            }
          }
          if (!a2) {
            t:
              for (var h3 in u3)
                if (h3 !== c3) {
                  for (var p2 in u3[h3])
                    if (i(o3, u3[h3][p2])) {
                      a2 = p2;
                      break t;
                    }
                }
          }
          a2 || (console.debug("No font coverage for U+" + o3.toString(16)), a2 = "latin"), A[n4] = a2, f[a2] || S.has(a2) || S.set(a2, M("font-meta/" + a2 + ".json").then(function(t3) {
            f[a2] = t3;
          })), o3 > 65535 && (n4++, r3 = n4);
        }, r3 = 0; r3 &lt; t2.length; r3++)
          n3(r3);
        return Promise.all(S.values());
      }).then(function() {
        for (var n3, r3 = null, e3 = 0; e3 &lt; t2.length; e3++) {
          var a2 = t2.codePointAt(e3);
          if (r3 && (k(a2) || d(r3).has(a2)))
            y[e3] = y[e3 - 1];
          else {
            r3 = f[A[e3]];
            var i2 = b[r3.id];
            if (!i2) {
              var s2 = r3.typeforms, v2 = g(s2, o2, "sans-serif"), p2 = g(s2[v2], u2, "normal"), m2 = w(null === (n3 = s2[v2]) || void 0 === n3 ? void 0 : n3[p2], c2);
              i2 = b[r3.id] = l2 + "/font-files/" + r3.id + "/" + v2 + "." + p2 + "." + m2 + ".woff";
            }
            var S2 = h2.get(i2);
            null == S2 && (S2 = h2.size, h2.set(i2, S2)), y[e3] = S2;
          }
          a2 > 65535 && (e3++, y[e3] = y[e3 - 1]);
        }
        return { fontUrls: Array.from(h2.keys()), chars: y };
      });
    }, Object.defineProperty(t, "__esModule", { value: true }), t;
  }({});
}
function createFontResolver(fontParser, unicodeFontResolverClient) {
  const parsedFonts = /* @__PURE__ */ Object.create(null);
  const loadingFonts = /* @__PURE__ */ Object.create(null);
  function doLoadFont(url, callback) {
    const onError = (err) => {
      console.error(`Failure loading font ${url}`, err);
    };
    try {
      const request = new XMLHttpRequest();
      request.open("get", url, true);
      request.responseType = "arraybuffer";
      request.onload = function() {
        if (request.status >= 400) {
          onError(new Error(request.statusText));
        } else if (request.status > 0) {
          try {
            const fontObj = fontParser(request.response);
            fontObj.src = url;
            callback(fontObj);
          } catch (e) {
            onError(e);
          }
        }
      };
      request.onerror = onError;
      request.send();
    } catch (err) {
      onError(err);
    }
  }
  function loadFont(fontUrl, callback) {
    let font = parsedFonts[fontUrl];
    if (font) {
      callback(font);
    } else if (loadingFonts[fontUrl]) {
      loadingFonts[fontUrl].push(callback);
    } else {
      loadingFonts[fontUrl] = [callback];
      doLoadFont(fontUrl, (fontObj) => {
        fontObj.src = fontUrl;
        parsedFonts[fontUrl] = fontObj;
        loadingFonts[fontUrl].forEach((cb) => cb(fontObj));
        delete loadingFonts[fontUrl];
      });
    }
  }
  return function(text, callback, {
    lang,
    fonts: userFonts = [],
    style = "normal",
    weight = "normal",
    unicodeFontsURL
  } = {}) {
    const charResolutions = new Uint8Array(text.length);
    const fontResolutions = [];
    if (!text.length) {
      allDone();
    }
    const fontIndices = /* @__PURE__ */ new Map();
    const fallbackRanges = [];
    if (style !== "italic")
      style = "normal";
    if (typeof weight !== "number") {
      weight = weight === "bold" ? 700 : 400;
    }
    if (userFonts && !Array.isArray(userFonts)) {
      userFonts = [userFonts];
    }
    userFonts = userFonts.slice().filter((def) => !def.lang || def.lang.test(lang)).reverse();
    if (userFonts.length) {
      const UNKNOWN = 0;
      const RESOLVED = 1;
      const NEEDS_FALLBACK = 2;
      let prevCharResult = UNKNOWN;
      (function resolveUserFonts(startIndex = 0) {
        for (let i = startIndex, iLen = text.length; i &lt; iLen; i++) {
          const codePoint = text.codePointAt(i);
          if (prevCharResult === RESOLVED && fontResolutions[charResolutions[i - 1]].supportsCodePoint(codePoint) || /\s/.test(text[i])) {
            charResolutions[i] = charResolutions[i - 1];
            if (prevCharResult === NEEDS_FALLBACK) {
              fallbackRanges[fallbackRanges.length - 1][1] = i;
            }
          } else {
            for (let j = charResolutions[i], jLen = userFonts.length; j &lt;= jLen; j++) {
              if (j === jLen) {
                const range = prevCharResult === NEEDS_FALLBACK ? fallbackRanges[fallbackRanges.length - 1] : fallbackRanges[fallbackRanges.length] = [i, i];
                range[1] = i;
                prevCharResult = NEEDS_FALLBACK;
              } else {
                charResolutions[i] = j;
                const { src, unicodeRange } = userFonts[j];
                if (!unicodeRange || isCodeInRanges(codePoint, unicodeRange)) {
                  const fontObj = parsedFonts[src];
                  if (!fontObj) {
                    loadFont(src, () => {
                      resolveUserFonts(i);
                    });
                    return;
                  }
                  if (fontObj.supportsCodePoint(codePoint)) {
                    let fontIndex = fontIndices.get(fontObj);
                    if (typeof fontIndex !== "number") {
                      fontIndex = fontResolutions.length;
                      fontResolutions.push(fontObj);
                      fontIndices.set(fontObj, fontIndex);
                    }
                    charResolutions[i] = fontIndex;
                    prevCharResult = RESOLVED;
                    break;
                  }
                }
              }
            }
          }
          if (codePoint > 65535 && i + 1 &lt; iLen) {
            charResolutions[i + 1] = charResolutions[i];
            i++;
            if (prevCharResult === NEEDS_FALLBACK) {
              fallbackRanges[fallbackRanges.length - 1][1] = i;
            }
          }
        }
        resolveFallbacks();
      })();
    } else {
      fallbackRanges.push([0, text.length - 1]);
      resolveFallbacks();
    }
    function resolveFallbacks() {
      if (fallbackRanges.length) {
        const fallbackString = fallbackRanges.map((range) => text.substring(range[0], range[1] + 1)).join("\n");
        unicodeFontResolverClient.getFontsForString(fallbackString, {
          lang: lang || void 0,
          style,
          weight,
          dataUrl: unicodeFontsURL
        }).then(({ fontUrls, chars }) => {
          const fontIndexOffset = fontResolutions.length;
          let charIdx = 0;
          fallbackRanges.forEach((range) => {
            for (let i = 0, endIdx = range[1] - range[0]; i &lt;= endIdx; i++) {
              charResolutions[range[0] + i] = chars[charIdx++] + fontIndexOffset;
            }
            charIdx++;
          });
          let loadedCount = 0;
          fontUrls.forEach((url, i) => {
            loadFont(url, (fontObj) => {
              fontResolutions[i + fontIndexOffset] = fontObj;
              if (++loadedCount === fontUrls.length) {
                allDone();
              }
            });
          });
        });
      } else {
        allDone();
      }
    }
    function allDone() {
      callback({
        chars: charResolutions,
        fonts: fontResolutions
      });
    }
    function isCodeInRanges(code, ranges) {
      for (let k = 0; k &lt; ranges.length; k++) {
        const [start, end = start] = ranges[k];
        if (start &lt;= code && code &lt;= end) {
          return true;
        }
      }
      return false;
    }
  };
}
const fontResolverWorkerModule = /* @__PURE__ */ defineWorkerModule({
  name: "FontResolver",
  dependencies: [
    createFontResolver,
    workerModule,
    unicodeFontResolverClientFactory
  ],
  init(createFontResolver2, fontParser, unicodeFontResolverClientFactory2) {
    return createFontResolver2(fontParser, unicodeFontResolverClientFactory2());
  }
});
function createTypesetter(resolveFonts, bidi) {
  const INF = Infinity;
  const DEFAULT_IGNORABLE_CHARS = /[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/;
  const lineBreakingWhiteSpace = `[^\\S\\u00A0]`;
  const BREAK_AFTER_CHARS = new RegExp(`${lineBreakingWhiteSpace}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);
  function calculateFontRuns({ text, lang, fonts: fonts2, style, weight, preResolvedFonts, unicodeFontsURL }, onDone) {
    const onResolved = ({ chars, fonts: parsedFonts }) => {
      let curRun, prevVal;
      const runs = [];
      for (let i = 0; i &lt; chars.length; i++) {
        if (chars[i] !== prevVal) {
          prevVal = chars[i];
          runs.push(curRun = { start: i, end: i, fontObj: parsedFonts[chars[i]] });
        } else {
          curRun.end = i;
        }
      }
      onDone(runs);
    };
    if (preResolvedFonts) {
      onResolved(preResolvedFonts);
    } else {
      resolveFonts(
        text,
        onResolved,
        { lang, fonts: fonts2, style, weight, unicodeFontsURL }
      );
    }
  }
  function typeset({
    text = "",
    font,
    lang,
    sdfGlyphSize = 64,
    fontSize = 400,
    fontWeight = 1,
    fontStyle = "normal",
    letterSpacing = 0,
    lineHeight = "normal",
    maxWidth = INF,
    direction,
    textAlign = "left",
    textIndent = 0,
    whiteSpace = "normal",
    overflowWrap = "normal",
    anchorX = 0,
    anchorY = 0,
    metricsOnly = false,
    unicodeFontsURL,
    preResolvedFonts = null,
    includeCaretPositions = false,
    chunkedBoundsSize = 8192,
    colorRanges = null
  }, callback) {
    const mainStart = now2();
    const timings = { fontLoad: 0, typesetting: 0 };
    if (text.indexOf("\r") > -1) {
      console.info("Typesetter: got text with \\r chars; normalizing to \\n");
      text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    }
    fontSize = +fontSize;
    letterSpacing = +letterSpacing;
    maxWidth = +maxWidth;
    lineHeight = lineHeight || "normal";
    textIndent = +textIndent;
    calculateFontRuns({
      text,
      lang,
      style: fontStyle,
      weight: fontWeight,
      fonts: typeof font === "string" ? [{ src: font }] : font,
      unicodeFontsURL,
      preResolvedFonts
    }, (runs) => {
      timings.fontLoad = now2() - mainStart;
      const hasMaxWidth = isFinite(maxWidth);
      let glyphIds = null;
      let glyphFontIndices = null;
      let glyphPositions = null;
      let glyphData = null;
      let glyphColors = null;
      let caretPositions = null;
      let visibleBounds = null;
      let chunkedBounds = null;
      let maxLineWidth = 0;
      let renderableGlyphCount = 0;
      let canWrap = whiteSpace !== "nowrap";
      const metricsByFont = /* @__PURE__ */ new Map();
      const typesetStart = now2();
      let lineXOffset = textIndent;
      let prevRunEndX = 0;
      let currentLine = new TextLine();
      const lines = [currentLine];
      runs.forEach((run) => {
        const { fontObj } = run;
        const { ascender, descender, unitsPerEm, lineGap, capHeight, xHeight } = fontObj;
        let fontData2 = metricsByFont.get(fontObj);
        if (!fontData2) {
          const fontSizeMult2 = fontSize / unitsPerEm;
          const calcLineHeight = lineHeight === "normal" ? (ascender - descender + lineGap) * fontSizeMult2 : lineHeight * fontSize;
          const halfLeading = (calcLineHeight - (ascender - descender) * fontSizeMult2) / 2;
          const caretHeight = Math.min(calcLineHeight, (ascender - descender) * fontSizeMult2);
          const caretTop = (ascender + descender) / 2 * fontSizeMult2 + caretHeight / 2;
          fontData2 = {
            index: metricsByFont.size,
            src: fontObj.src,
            fontObj,
            fontSizeMult: fontSizeMult2,
            unitsPerEm,
            ascender: ascender * fontSizeMult2,
            descender: descender * fontSizeMult2,
            capHeight: capHeight * fontSizeMult2,
            xHeight: xHeight * fontSizeMult2,
            lineHeight: calcLineHeight,
            baseline: -halfLeading - ascender * fontSizeMult2,
            // baseline offset from top of line height
            // cap: -halfLeading - capHeight * fontSizeMult, // cap from top of line height
            // ex: -halfLeading - xHeight * fontSizeMult, // ex from top of line height
            caretTop: (ascender + descender) / 2 * fontSizeMult2 + caretHeight / 2,
            caretBottom: caretTop - caretHeight
          };
          metricsByFont.set(fontObj, fontData2);
        }
        const { fontSizeMult } = fontData2;
        const runText = text.slice(run.start, run.end + 1);
        let prevGlyphX, prevGlyphObj;
        fontObj.forEachGlyph(runText, fontSize, letterSpacing, (glyphObj, glyphX, glyphY, charIndex) => {
          glyphX += prevRunEndX;
          charIndex += run.start;
          prevGlyphX = glyphX;
          prevGlyphObj = glyphObj;
          const char = text.charAt(charIndex);
          const glyphWidth = glyphObj.advanceWidth * fontSizeMult;
          const curLineCount = currentLine.count;
          let nextLine;
          if (!("isEmpty" in glyphObj)) {
            glyphObj.isWhitespace = !!char && new RegExp(lineBreakingWhiteSpace).test(char);
            glyphObj.canBreakAfter = !!char && BREAK_AFTER_CHARS.test(char);
            glyphObj.isEmpty = glyphObj.xMin === glyphObj.xMax || glyphObj.yMin === glyphObj.yMax || DEFAULT_IGNORABLE_CHARS.test(char);
          }
          if (!glyphObj.isWhitespace && !glyphObj.isEmpty) {
            renderableGlyphCount++;
          }
          if (canWrap && hasMaxWidth && !glyphObj.isWhitespace && glyphX + glyphWidth + lineXOffset > maxWidth && curLineCount) {
            if (currentLine.glyphAt(curLineCount - 1).glyphObj.canBreakAfter) {
              nextLine = new TextLine();
              lineXOffset = -glyphX;
            } else {
              for (let i = curLineCount; i--; ) {
                if (i === 0 && overflowWrap === "break-word") {
                  nextLine = new TextLine();
                  lineXOffset = -glyphX;
                  break;
                } else if (currentLine.glyphAt(i).glyphObj.canBreakAfter) {
                  nextLine = currentLine.splitAt(i + 1);
                  const adjustX = nextLine.glyphAt(0).x;
                  lineXOffset -= adjustX;
                  for (let j = nextLine.count; j--; ) {
                    nextLine.glyphAt(j).x -= adjustX;
                  }
                  break;
                }
              }
            }
            if (nextLine) {
              currentLine.isSoftWrapped = true;
              currentLine = nextLine;
              lines.push(currentLine);
              maxLineWidth = maxWidth;
            }
          }
          let fly = currentLine.glyphAt(currentLine.count);
          fly.glyphObj = glyphObj;
          fly.x = glyphX + lineXOffset;
          fly.y = glyphY;
          fly.width = glyphWidth;
          fly.charIndex = charIndex;
          fly.fontData = fontData2;
          if (char === "\n") {
            currentLine = new TextLine();
            lines.push(currentLine);
            lineXOffset = -(glyphX + glyphWidth + letterSpacing * fontSize) + textIndent;
          }
        });
        prevRunEndX = prevGlyphX + prevGlyphObj.advanceWidth * fontSizeMult + letterSpacing * fontSize;
      });
      let totalHeight = 0;
      lines.forEach((line) => {
        let isTrailingWhitespace = true;
        for (let i = line.count; i--; ) {
          const glyphInfo = line.glyphAt(i);
          if (isTrailingWhitespace && !glyphInfo.glyphObj.isWhitespace) {
            line.width = glyphInfo.x + glyphInfo.width;
            if (line.width > maxLineWidth) {
              maxLineWidth = line.width;
            }
            isTrailingWhitespace = false;
          }
          let { lineHeight: lineHeight2, capHeight, xHeight, baseline } = glyphInfo.fontData;
          if (lineHeight2 > line.lineHeight)
            line.lineHeight = lineHeight2;
          const baselineDiff = baseline - line.baseline;
          if (baselineDiff &lt; 0) {
            line.baseline += baselineDiff;
            line.cap += baselineDiff;
            line.ex += baselineDiff;
          }
          line.cap = Math.max(line.cap, line.baseline + capHeight);
          line.ex = Math.max(line.ex, line.baseline + xHeight);
        }
        line.baseline -= totalHeight;
        line.cap -= totalHeight;
        line.ex -= totalHeight;
        totalHeight += line.lineHeight;
      });
      let anchorXOffset = 0;
      let anchorYOffset = 0;
      if (anchorX) {
        if (typeof anchorX === "number") {
          anchorXOffset = -anchorX;
        } else if (typeof anchorX === "string") {
          anchorXOffset = -maxLineWidth * (anchorX === "left" ? 0 : anchorX === "center" ? 0.5 : anchorX === "right" ? 1 : parsePercent(anchorX));
        }
      }
      if (anchorY) {
        if (typeof anchorY === "number") {
          anchorYOffset = -anchorY;
        } else if (typeof anchorY === "string") {
          anchorYOffset = anchorY === "top" ? 0 : anchorY === "top-baseline" ? -lines[0].baseline : anchorY === "top-cap" ? -lines[0].cap : anchorY === "top-ex" ? -lines[0].ex : anchorY === "middle" ? totalHeight / 2 : anchorY === "bottom" ? totalHeight : anchorY === "bottom-baseline" ? lines[lines.length - 1].baseline : parsePercent(anchorY) * totalHeight;
        }
      }
      if (!metricsOnly) {
        const bidiLevelsResult = bidi.getEmbeddingLevels(text, direction);
        glyphIds = new Uint16Array(renderableGlyphCount);
        glyphFontIndices = new Uint8Array(renderableGlyphCount);
        glyphPositions = new Float32Array(renderableGlyphCount * 2);
        glyphData = {};
        visibleBounds = [INF, INF, -INF, -INF];
        chunkedBounds = [];
        if (includeCaretPositions) {
          caretPositions = new Float32Array(text.length * 4);
        }
        if (colorRanges) {
          glyphColors = new Uint8Array(renderableGlyphCount * 3);
        }
        let renderableGlyphIndex = 0;
        let prevCharIndex = -1;
        let colorCharIndex = -1;
        let chunk;
        let currentColor;
        lines.forEach((line, lineIndex) => {
          let { count: lineGlyphCount, width: lineWidth } = line;
          if (lineGlyphCount > 0) {
            let trailingWhitespaceCount = 0;
            for (let i = lineGlyphCount; i-- && line.glyphAt(i).glyphObj.isWhitespace; ) {
              trailingWhitespaceCount++;
            }
            let lineXOffset2 = 0;
            let justifyAdjust = 0;
            if (textAlign === "center") {
              lineXOffset2 = (maxLineWidth - lineWidth) / 2;
            } else if (textAlign === "right") {
              lineXOffset2 = maxLineWidth - lineWidth;
            } else if (textAlign === "justify" && line.isSoftWrapped) {
              let whitespaceCount = 0;
              for (let i = lineGlyphCount - trailingWhitespaceCount; i--; ) {
                if (line.glyphAt(i).glyphObj.isWhitespace) {
                  whitespaceCount++;
                }
              }
              justifyAdjust = (maxLineWidth - lineWidth) / whitespaceCount;
            }
            if (justifyAdjust || lineXOffset2) {
              let justifyOffset = 0;
              for (let i = 0; i &lt; lineGlyphCount; i++) {
                let glyphInfo = line.glyphAt(i);
                const glyphObj2 = glyphInfo.glyphObj;
                glyphInfo.x += lineXOffset2 + justifyOffset;
                if (justifyAdjust !== 0 && glyphObj2.isWhitespace && i &lt; lineGlyphCount - trailingWhitespaceCount) {
                  justifyOffset += justifyAdjust;
                  glyphInfo.width += justifyAdjust;
                }
              }
            }
            const flips = bidi.getReorderSegments(
              text,
              bidiLevelsResult,
              line.glyphAt(0).charIndex,
              line.glyphAt(line.count - 1).charIndex
            );
            for (let fi = 0; fi &lt; flips.length; fi++) {
              const [start, end] = flips[fi];
              let left = Infinity, right = -Infinity;
              for (let i = 0; i &lt; lineGlyphCount; i++) {
                if (line.glyphAt(i).charIndex >= start) {
                  let startInLine = i, endInLine = i;
                  for (; endInLine &lt; lineGlyphCount; endInLine++) {
                    let info = line.glyphAt(endInLine);
                    if (info.charIndex > end) {
                      break;
                    }
                    if (endInLine &lt; lineGlyphCount - trailingWhitespaceCount) {
                      left = Math.min(left, info.x);
                      right = Math.max(right, info.x + info.width);
                    }
                  }
                  for (let j = startInLine; j &lt; endInLine; j++) {
                    const glyphInfo = line.glyphAt(j);
                    glyphInfo.x = right - (glyphInfo.x + glyphInfo.width - left);
                  }
                  break;
                }
              }
            }
            let glyphObj;
            const setGlyphObj = (g) => glyphObj = g;
            for (let i = 0; i &lt; lineGlyphCount; i++) {
              const glyphInfo = line.glyphAt(i);
              glyphObj = glyphInfo.glyphObj;
              const glyphId = glyphObj.index;
              const rtl = bidiLevelsResult.levels[glyphInfo.charIndex] & 1;
              if (rtl) {
                const mirrored = bidi.getMirroredCharacter(text[glyphInfo.charIndex]);
                if (mirrored) {
                  glyphInfo.fontData.fontObj.forEachGlyph(mirrored, 0, 0, setGlyphObj);
                }
              }
              if (includeCaretPositions) {
                const { charIndex, fontData: fontData2 } = glyphInfo;
                const caretLeft = glyphInfo.x + anchorXOffset;
                const caretRight = glyphInfo.x + glyphInfo.width + anchorXOffset;
                caretPositions[charIndex * 4] = rtl ? caretRight : caretLeft;
                caretPositions[charIndex * 4 + 1] = rtl ? caretLeft : caretRight;
                caretPositions[charIndex * 4 + 2] = line.baseline + fontData2.caretBottom + anchorYOffset;
                caretPositions[charIndex * 4 + 3] = line.baseline + fontData2.caretTop + anchorYOffset;
                const ligCount = charIndex - prevCharIndex;
                if (ligCount > 1) {
                  fillLigatureCaretPositions(caretPositions, prevCharIndex, ligCount);
                }
                prevCharIndex = charIndex;
              }
              if (colorRanges) {
                const { charIndex } = glyphInfo;
                while (charIndex > colorCharIndex) {
                  colorCharIndex++;
                  if (colorRanges.hasOwnProperty(colorCharIndex)) {
                    currentColor = colorRanges[colorCharIndex];
                  }
                }
              }
              if (!glyphObj.isWhitespace && !glyphObj.isEmpty) {
                const idx = renderableGlyphIndex++;
                const { fontSizeMult, src: fontSrc, index: fontIndex } = glyphInfo.fontData;
                const fontGlyphData = glyphData[fontSrc] || (glyphData[fontSrc] = {});
                if (!fontGlyphData[glyphId]) {
                  fontGlyphData[glyphId] = {
                    path: glyphObj.path,
                    pathBounds: [glyphObj.xMin, glyphObj.yMin, glyphObj.xMax, glyphObj.yMax]
                  };
                }
                const glyphX = glyphInfo.x + anchorXOffset;
                const glyphY = glyphInfo.y + line.baseline + anchorYOffset;
                glyphPositions[idx * 2] = glyphX;
                glyphPositions[idx * 2 + 1] = glyphY;
                const visX0 = glyphX + glyphObj.xMin * fontSizeMult;
                const visY0 = glyphY + glyphObj.yMin * fontSizeMult;
                const visX1 = glyphX + glyphObj.xMax * fontSizeMult;
                const visY1 = glyphY + glyphObj.yMax * fontSizeMult;
                if (visX0 &lt; visibleBounds[0])
                  visibleBounds[0] = visX0;
                if (visY0 &lt; visibleBounds[1])
                  visibleBounds[1] = visY0;
                if (visX1 > visibleBounds[2])
                  visibleBounds[2] = visX1;
                if (visY1 > visibleBounds[3])
                  visibleBounds[3] = visY1;
                if (idx % chunkedBoundsSize === 0) {
                  chunk = { start: idx, end: idx, rect: [INF, INF, -INF, -INF] };
                  chunkedBounds.push(chunk);
                }
                chunk.end++;
                const chunkRect = chunk.rect;
                if (visX0 &lt; chunkRect[0])
                  chunkRect[0] = visX0;
                if (visY0 &lt; chunkRect[1])
                  chunkRect[1] = visY0;
                if (visX1 > chunkRect[2])
                  chunkRect[2] = visX1;
                if (visY1 > chunkRect[3])
                  chunkRect[3] = visY1;
                glyphIds[idx] = glyphId;
                glyphFontIndices[idx] = fontIndex;
                if (colorRanges) {
                  const start = idx * 3;
                  glyphColors[start] = currentColor >> 16 & 255;
                  glyphColors[start + 1] = currentColor >> 8 & 255;
                  glyphColors[start + 2] = currentColor & 255;
                }
              }
            }
          }
        });
        if (caretPositions) {
          const ligCount = text.length - prevCharIndex;
          if (ligCount > 1) {
            fillLigatureCaretPositions(caretPositions, prevCharIndex, ligCount);
          }
        }
      }
      const fontData = [];
      metricsByFont.forEach(({ index, src, unitsPerEm, ascender, descender, lineHeight: lineHeight2, capHeight, xHeight }) => {
        fontData[index] = { src, unitsPerEm, ascender, descender, lineHeight: lineHeight2, capHeight, xHeight };
      });
      timings.typesetting = now2() - typesetStart;
      callback({
        glyphIds,
        //id for each glyph, specific to that glyph's font
        glyphFontIndices,
        //index into fontData for each glyph
        glyphPositions,
        //x,y of each glyph's origin in layout
        glyphData,
        //dict holding data about each glyph appearing in the text
        fontData,
        //data about each font used in the text
        caretPositions,
        //startX,endX,bottomY caret positions for each char
        // caretHeight, //height of cursor from bottom to top - todo per glyph?
        glyphColors,
        //color for each glyph, if color ranges supplied
        chunkedBounds,
        //total rects per (n=chunkedBoundsSize) consecutive glyphs
        fontSize,
        //calculated em height
        topBaseline: anchorYOffset + lines[0].baseline,
        //y coordinate of the top line's baseline
        blockBounds: [
          //bounds for the whole block of text, including vertical padding for lineHeight
          anchorXOffset,
          anchorYOffset - totalHeight,
          anchorXOffset + maxLineWidth,
          anchorYOffset
        ],
        visibleBounds,
        //total bounds of visible text paths, may be larger or smaller than blockBounds
        timings
      });
    });
  }
  function measure(args, callback) {
    typeset({ ...args, metricsOnly: true }, (result) => {
      const [x0, y0, x1, y1] = result.blockBounds;
      callback({
        width: x1 - x0,
        height: y1 - y0
      });
    });
  }
  function parsePercent(str) {
    let match = str.match(/^([\d.]+)%$/);
    let pct = match ? parseFloat(match[1]) : NaN;
    return isNaN(pct) ? 0 : pct / 100;
  }
  function fillLigatureCaretPositions(caretPositions, ligStartIndex, ligCount) {
    const ligStartX = caretPositions[ligStartIndex * 4];
    const ligEndX = caretPositions[ligStartIndex * 4 + 1];
    const ligBottom = caretPositions[ligStartIndex * 4 + 2];
    const ligTop = caretPositions[ligStartIndex * 4 + 3];
    const guessedAdvanceX = (ligEndX - ligStartX) / ligCount;
    for (let i = 0; i &lt; ligCount; i++) {
      const startIndex = (ligStartIndex + i) * 4;
      caretPositions[startIndex] = ligStartX + guessedAdvanceX * i;
      caretPositions[startIndex + 1] = ligStartX + guessedAdvanceX * (i + 1);
      caretPositions[startIndex + 2] = ligBottom;
      caretPositions[startIndex + 3] = ligTop;
    }
  }
  function now2() {
    return (self.performance || Date).now();
  }
  function TextLine() {
    this.data = [];
  }
  const textLineProps = ["glyphObj", "x", "y", "width", "charIndex", "fontData"];
  TextLine.prototype = {
    width: 0,
    lineHeight: 0,
    baseline: 0,
    cap: 0,
    ex: 0,
    isSoftWrapped: false,
    get count() {
      return Math.ceil(this.data.length / textLineProps.length);
    },
    glyphAt(i) {
      let fly = TextLine.flyweight;
      fly.data = this.data;
      fly.index = i;
      return fly;
    },
    splitAt(i) {
      let newLine = new TextLine();
      newLine.data = this.data.splice(i * textLineProps.length);
      return newLine;
    }
  };
  TextLine.flyweight = textLineProps.reduce((obj, prop, i, all) => {
    Object.defineProperty(obj, prop, {
      get() {
        return this.data[this.index * textLineProps.length + i];
      },
      set(val) {
        this.data[this.index * textLineProps.length + i] = val;
      }
    });
    return obj;
  }, { data: null, index: 0 });
  return {
    typeset,
    measure
  };
}
const now = () => (self.performance || Date).now();
const mainThreadGenerator = /* @__PURE__ */ SDFGenerator();
let warned;
function generateSDF(width, height, path, viewBox, distance, exponent, canvas, x, y, channel, useWebGL = true) {
  if (!useWebGL) {
    return generateSDF_JS_Worker(width, height, path, viewBox, distance, exponent, canvas, x, y, channel);
  }
  return generateSDF_GL(width, height, path, viewBox, distance, exponent, canvas, x, y, channel).then(
    null,
    (err) => {
      if (!warned) {
        console.warn(`WebGL SDF generation failed, falling back to JS`, err);
        warned = true;
      }
      return generateSDF_JS_Worker(width, height, path, viewBox, distance, exponent, canvas, x, y, channel);
    }
  );
}
const queue = [];
const chunkTimeBudget = 5;
let timer = 0;
function nextChunk() {
  const start = now();
  while (queue.length && now() - start &lt; chunkTimeBudget) {
    queue.shift()();
  }
  timer = queue.length ? setTimeout(nextChunk, 0) : 0;
}
const generateSDF_GL = (...args) => {
  return new Promise((resolve, reject) => {
    queue.push(() => {
      const start = now();
      try {
        mainThreadGenerator.webgl.generateIntoCanvas(...args);
        resolve({ timing: now() - start });
      } catch (err) {
        reject(err);
      }
    });
    if (!timer) {
      timer = setTimeout(nextChunk, 0);
    }
  });
};
const threadCount = 4;
const idleTimeout = 2e3;
const threads = {};
let callNum = 0;
function generateSDF_JS_Worker(width, height, path, viewBox, distance, exponent, canvas, x, y, channel) {
  const workerId = "TroikaTextSDFGenerator_JS_" + callNum++ % threadCount;
  let thread = threads[workerId];
  if (!thread) {
    thread = threads[workerId] = {
      workerModule: defineWorkerModule({
        name: workerId,
        workerId,
        dependencies: [
          SDFGenerator,
          now
        ],
        init(_createSDFGenerator, now2) {
          const generate = _createSDFGenerator().javascript.generate;
          return function(...args) {
            const start = now2();
            const textureData = generate(...args);
            return {
              textureData,
              timing: now2() - start
            };
          };
        },
        getTransferables(result) {
          return [result.textureData.buffer];
        }
      }),
      requests: 0,
      idleTimer: null
    };
  }
  thread.requests++;
  clearTimeout(thread.idleTimer);
  return thread.workerModule(width, height, path, viewBox, distance, exponent).then(({ textureData, timing }) => {
    const start = now();
    const imageData = new Uint8Array(textureData.length * 4);
    for (let i = 0; i &lt; textureData.length; i++) {
      imageData[i * 4 + channel] = textureData[i];
    }
    mainThreadGenerator.webglUtils.renderImageData(canvas, imageData, x, y, width, height, 1 &lt;&lt; 3 - channel);
    timing += now() - start;
    if (--thread.requests === 0) {
      thread.idleTimer = setTimeout(() => {
        terminateWorker(workerId);
      }, idleTimeout);
    }
    return { timing };
  });
}
function warmUpSDFCanvas(canvas) {
  if (!canvas._warm) {
    mainThreadGenerator.webgl.isSupported(canvas);
    canvas._warm = true;
  }
}
const resizeWebGLCanvasWithoutClearing = mainThreadGenerator.webglUtils.resizeWebGLCanvasWithoutClearing;
const CONFIG = {
  defaultFontURL: null,
  unicodeFontsURL: null,
  sdfGlyphSize: 64,
  sdfMargin: 1 / 16,
  sdfExponent: 9,
  textureWidth: 2048
};
const tempColor = /* @__PURE__ */ new Color();
function now$1() {
  return (self.performance || Date).now();
}
const atlases = /* @__PURE__ */ Object.create(null);
function getTextRenderInfo(args, callback) {
  args = assign({}, args);
  const totalStart = now$1();
  const { defaultFontURL } = CONFIG;
  const fonts2 = [];
  if (defaultFontURL) {
    fonts2.push({ label: "default", src: toAbsoluteURL(defaultFontURL) });
  }
  if (args.font) {
    fonts2.push({ label: "user", src: toAbsoluteURL(args.font) });
  }
  args.font = fonts2;
  args.text = "" + args.text;
  args.sdfGlyphSize = args.sdfGlyphSize || CONFIG.sdfGlyphSize;
  args.unicodeFontsURL = args.unicodeFontsURL || CONFIG.unicodeFontsURL;
  if (args.colorRanges != null) {
    let colors = {};
    for (let key in args.colorRanges) {
      if (args.colorRanges.hasOwnProperty(key)) {
        let val = args.colorRanges[key];
        if (typeof val !== "number") {
          val = tempColor.set(val).getHex();
        }
        colors[key] = val;
      }
    }
    args.colorRanges = colors;
  }
  Object.freeze(args);
  const { textureWidth, sdfExponent } = CONFIG;
  const { sdfGlyphSize } = args;
  const glyphsPerRow = textureWidth / sdfGlyphSize * 4;
  let atlas = atlases[sdfGlyphSize];
  if (!atlas) {
    const canvas = document.createElement("canvas");
    canvas.width = textureWidth;
    canvas.height = sdfGlyphSize * 256 / glyphsPerRow;
    atlas = atlases[sdfGlyphSize] = {
      glyphCount: 0,
      sdfGlyphSize,
      sdfCanvas: canvas,
      sdfTexture: new Texture(
        canvas,
        void 0,
        void 0,
        void 0,
        LinearFilter,
        LinearFilter
      ),
      contextLost: false,
      glyphsByFont: /* @__PURE__ */ new Map()
    };
    atlas.sdfTexture.generateMipmaps = false;
    initContextLossHandling(atlas);
  }
  const { sdfTexture, sdfCanvas } = atlas;
  typesetInWorker(args).then((result) => {
    const { glyphIds, glyphFontIndices, fontData, glyphPositions, fontSize, timings } = result;
    const neededSDFs = [];
    const glyphBounds = new Float32Array(glyphIds.length * 4);
    let boundsIdx = 0;
    let positionsIdx = 0;
    const quadsStart = now$1();
    const fontGlyphMaps = fontData.map((font) => {
      let map = atlas.glyphsByFont.get(font.src);
      if (!map) {
        atlas.glyphsByFont.set(font.src, map = /* @__PURE__ */ new Map());
      }
      return map;
    });
    glyphIds.forEach((glyphId, i) => {
      const fontIndex = glyphFontIndices[i];
      const { src: fontSrc, unitsPerEm } = fontData[fontIndex];
      let glyphInfo = fontGlyphMaps[fontIndex].get(glyphId);
      if (!glyphInfo) {
        const { path, pathBounds } = result.glyphData[fontSrc][glyphId];
        const fontUnitsMargin = Math.max(pathBounds[2] - pathBounds[0], pathBounds[3] - pathBounds[1]) / sdfGlyphSize * (CONFIG.sdfMargin * sdfGlyphSize + 0.5);
        const atlasIndex = atlas.glyphCount++;
        const sdfViewBox2 = [
          pathBounds[0] - fontUnitsMargin,
          pathBounds[1] - fontUnitsMargin,
          pathBounds[2] + fontUnitsMargin,
          pathBounds[3] + fontUnitsMargin
        ];
        fontGlyphMaps[fontIndex].set(glyphId, glyphInfo = { path, atlasIndex, sdfViewBox: sdfViewBox2 });
        neededSDFs.push(glyphInfo);
      }
      const { sdfViewBox } = glyphInfo;
      const posX = glyphPositions[positionsIdx++];
      const posY = glyphPositions[positionsIdx++];
      const fontSizeMult = fontSize / unitsPerEm;
      glyphBounds[boundsIdx++] = posX + sdfViewBox[0] * fontSizeMult;
      glyphBounds[boundsIdx++] = posY + sdfViewBox[1] * fontSizeMult;
      glyphBounds[boundsIdx++] = posX + sdfViewBox[2] * fontSizeMult;
      glyphBounds[boundsIdx++] = posY + sdfViewBox[3] * fontSizeMult;
      glyphIds[i] = glyphInfo.atlasIndex;
    });
    timings.quads = (timings.quads || 0) + (now$1() - quadsStart);
    const sdfStart = now$1();
    timings.sdf = {};
    const currentHeight = sdfCanvas.height;
    const neededRows = Math.ceil(atlas.glyphCount / glyphsPerRow);
    const neededHeight = Math.pow(2, Math.ceil(Math.log2(neededRows * sdfGlyphSize)));
    if (neededHeight > currentHeight) {
      console.info(`Increasing SDF texture size ${currentHeight}->${neededHeight}`);
      resizeWebGLCanvasWithoutClearing(sdfCanvas, textureWidth, neededHeight);
      sdfTexture.dispose();
    }
    Promise.all(neededSDFs.map(
      (glyphInfo) => generateGlyphSDF(glyphInfo, atlas, args.gpuAccelerateSDF).then(({ timing }) => {
        timings.sdf[glyphInfo.atlasIndex] = timing;
      })
    )).then(() => {
      if (neededSDFs.length && !atlas.contextLost) {
        safariPre15Workaround(atlas);
        sdfTexture.needsUpdate = true;
      }
      timings.sdfTotal = now$1() - sdfStart;
      timings.total = now$1() - totalStart;
      callback(Object.freeze({
        parameters: args,
        sdfTexture,
        sdfGlyphSize,
        sdfExponent,
        glyphBounds,
        glyphAtlasIndices: glyphIds,
        glyphColors: result.glyphColors,
        caretPositions: result.caretPositions,
        chunkedBounds: result.chunkedBounds,
        ascender: result.ascender,
        descender: result.descender,
        lineHeight: result.lineHeight,
        capHeight: result.capHeight,
        xHeight: result.xHeight,
        topBaseline: result.topBaseline,
        blockBounds: result.blockBounds,
        visibleBounds: result.visibleBounds,
        timings: result.timings
      }));
    });
  });
  Promise.resolve().then(() => {
    if (!atlas.contextLost) {
      warmUpSDFCanvas(sdfCanvas);
    }
  });
}
function generateGlyphSDF({ path, atlasIndex, sdfViewBox }, { sdfGlyphSize, sdfCanvas, contextLost }, useGPU) {
  if (contextLost) {
    return Promise.resolve({ timing: -1 });
  }
  const { textureWidth, sdfExponent } = CONFIG;
  const maxDist = Math.max(sdfViewBox[2] - sdfViewBox[0], sdfViewBox[3] - sdfViewBox[1]);
  const squareIndex = Math.floor(atlasIndex / 4);
  const x = squareIndex % (textureWidth / sdfGlyphSize) * sdfGlyphSize;
  const y = Math.floor(squareIndex / (textureWidth / sdfGlyphSize)) * sdfGlyphSize;
  const channel = atlasIndex % 4;
  return generateSDF(sdfGlyphSize, sdfGlyphSize, path, sdfViewBox, maxDist, sdfExponent, sdfCanvas, x, y, channel, useGPU);
}
function initContextLossHandling(atlas) {
  const canvas = atlas.sdfCanvas;
  canvas.addEventListener("webglcontextlost", (event) => {
    console.log("Context Lost", event);
    event.preventDefault();
    atlas.contextLost = true;
  });
  canvas.addEventListener("webglcontextrestored", (event) => {
    console.log("Context Restored", event);
    atlas.contextLost = false;
    const promises = [];
    atlas.glyphsByFont.forEach((glyphMap) => {
      glyphMap.forEach((glyph) => {
        promises.push(generateGlyphSDF(glyph, atlas, true));
      });
    });
    Promise.all(promises).then(() => {
      safariPre15Workaround(atlas);
      atlas.sdfTexture.needsUpdate = true;
    });
  });
}
function assign(toObj, fromObj) {
  for (let key in fromObj) {
    if (fromObj.hasOwnProperty(key)) {
      toObj[key] = fromObj[key];
    }
  }
  return toObj;
}
let linkEl;
function toAbsoluteURL(path) {
  if (!linkEl) {
    linkEl = typeof document === "undefined" ? {} : document.createElement("a");
  }
  linkEl.href = path;
  return linkEl.href;
}
function safariPre15Workaround(atlas) {
  if (typeof createImageBitmap !== "function") {
    console.info("Safari&lt;15: applying SDF canvas workaround");
    const { sdfCanvas, sdfTexture } = atlas;
    const { width, height } = sdfCanvas;
    const gl = atlas.sdfCanvas.getContext("webgl");
    let pixels = sdfTexture.image.data;
    if (!pixels || pixels.length !== width * height * 4) {
      pixels = new Uint8Array(width * height * 4);
      sdfTexture.image = { width, height, data: pixels };
      sdfTexture.flipY = false;
      sdfTexture.isDataTexture = true;
    }
    gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
  }
}
const typesetterWorkerModule = /* @__PURE__ */ defineWorkerModule({
  name: "Typesetter",
  dependencies: [
    createTypesetter,
    fontResolverWorkerModule,
    bidiFactory
  ],
  init(createTypesetter2, fontResolver, bidiFactory2) {
    return createTypesetter2(fontResolver, bidiFactory2());
  }
});
const typesetInWorker = /* @__PURE__ */ defineWorkerModule({
  name: "Typesetter",
  dependencies: [
    typesetterWorkerModule
  ],
  init(typesetter) {
    return function(args) {
      return new Promise((resolve) => {
        typesetter.typeset(args, resolve);
      });
    };
  },
  getTransferables(result) {
    const transferables = [];
    for (let p in result) {
      if (result[p] && result[p].buffer) {
        transferables.push(result[p].buffer);
      }
    }
    return transferables;
  }
});
const templateGeometries = {};
function getTemplateGeometry(detail) {
  let geom = templateGeometries[detail];
  if (!geom) {
    const front = new PlaneGeometry(1, 1, detail, detail);
    const back = front.clone();
    const frontAttrs = front.attributes;
    const backAttrs = back.attributes;
    const combined = new BufferGeometry();
    const vertCount = frontAttrs.uv.count;
    for (let i = 0; i &lt; vertCount; i++) {
      backAttrs.position.array[i * 3] *= -1;
      backAttrs.normal.array[i * 3 + 2] *= -1;
    }
    ["position", "normal", "uv"].forEach((name) => {
      combined.setAttribute(
        name,
        new Float32BufferAttribute(
          [...frontAttrs[name].array, ...backAttrs[name].array],
          frontAttrs[name].itemSize
        )
      );
    });
    combined.setIndex([...front.index.array, ...back.index.array.map((n) => n + vertCount)]);
    combined.translate(0.5, 0.5, 0);
    geom = templateGeometries[detail] = combined;
  }
  return geom;
}
const glyphBoundsAttrName = "aTroikaGlyphBounds";
const glyphIndexAttrName = "aTroikaGlyphIndex";
const glyphColorAttrName = "aTroikaGlyphColor";
class GlyphsGeometry extends InstancedBufferGeometry {
  constructor() {
    super();
    this.detail = 1;
    this.curveRadius = 0;
    this.groups = [
      { start: 0, count: Infinity, materialIndex: 0 },
      { start: 0, count: Infinity, materialIndex: 1 }
    ];
    this.boundingSphere = new Sphere();
    this.boundingBox = new Box3();
  }
  computeBoundingSphere() {
  }
  computeBoundingBox() {
  }
  // Since our base geometry contains triangles for both front and back sides, we can emulate
  // the "side" by restricting the draw range.
  setSide(side) {
    const verts = this.getIndex().count;
    this.setDrawRange(side === BackSide ? verts / 2 : 0, side === DoubleSide ? verts : verts / 2);
  }
  set detail(detail) {
    if (detail !== this._detail) {
      this._detail = detail;
      if (typeof detail !== "number" || detail &lt; 1) {
        detail = 1;
      }
      let tpl = getTemplateGeometry(detail);
      ["position", "normal", "uv"].forEach((attr) => {
        this.attributes[attr] = tpl.attributes[attr].clone();
      });
      this.setIndex(tpl.getIndex().clone());
    }
  }
  get detail() {
    return this._detail;
  }
  set curveRadius(r) {
    if (r !== this._curveRadius) {
      this._curveRadius = r;
      this._updateBounds();
    }
  }
  get curveRadius() {
    return this._curveRadius;
  }
  /**
   * Update the geometry for a new set of glyphs.
   * @param {Float32Array} glyphBounds - An array holding the planar bounds for all glyphs
   *        to be rendered, 4 entries for each glyph: x1,x2,y1,y1
   * @param {Float32Array} glyphAtlasIndices - An array holding the index of each glyph within
   *        the SDF atlas texture.
   * @param {Array} blockBounds - An array holding the [minX, minY, maxX, maxY] across all glyphs
   * @param {Array} [chunkedBounds] - An array of objects describing bounds for each chunk of N
   *        consecutive glyphs: `{start:N, end:N, rect:[minX, minY, maxX, maxY]}`. This can be
   *        used with `applyClipRect` to choose an optimized `instanceCount`.
   * @param {Uint8Array} [glyphColors] - An array holding r,g,b values for each glyph.
   */
  updateGlyphs(glyphBounds, glyphAtlasIndices, blockBounds, chunkedBounds, glyphColors) {
    updateBufferAttr(this, glyphBoundsAttrName, glyphBounds, 4);
    updateBufferAttr(this, glyphIndexAttrName, glyphAtlasIndices, 1);
    updateBufferAttr(this, glyphColorAttrName, glyphColors, 3);
    this._blockBounds = blockBounds;
    this._chunkedBounds = chunkedBounds;
    this.instanceCount = glyphAtlasIndices.length;
    this._updateBounds();
  }
  _updateBounds() {
    const bounds = this._blockBounds;
    if (bounds) {
      const { curveRadius, boundingBox: bbox } = this;
      if (curveRadius) {
        const { PI, floor, min, max, sin, cos } = Math;
        const halfPi = PI / 2;
        const twoPi = PI * 2;
        const absR = Math.abs(curveRadius);
        const leftAngle = bounds[0] / absR;
        const rightAngle = bounds[2] / absR;
        const minX = floor((leftAngle + halfPi) / twoPi) !== floor((rightAngle + halfPi) / twoPi) ? -absR : min(sin(leftAngle) * absR, sin(rightAngle) * absR);
        const maxX = floor((leftAngle - halfPi) / twoPi) !== floor((rightAngle - halfPi) / twoPi) ? absR : max(sin(leftAngle) * absR, sin(rightAngle) * absR);
        const maxZ = floor((leftAngle + PI) / twoPi) !== floor((rightAngle + PI) / twoPi) ? absR * 2 : max(absR - cos(leftAngle) * absR, absR - cos(rightAngle) * absR);
        bbox.min.set(minX, bounds[1], curveRadius &lt; 0 ? -maxZ : 0);
        bbox.max.set(maxX, bounds[3], curveRadius &lt; 0 ? 0 : maxZ);
      } else {
        bbox.min.set(bounds[0], bounds[1], 0);
        bbox.max.set(bounds[2], bounds[3], 0);
      }
      bbox.getBoundingSphere(this.boundingSphere);
    }
  }
  /**
   * Given a clipping rect, and the chunkedBounds from the last updateGlyphs call, choose the lowest
   * `instanceCount` that will show all glyphs within the clipped view. This is an optimization
   * for long blocks of text that are clipped, to skip vertex shader evaluation for glyphs that would
   * be clipped anyway.
   *
   * Note that since `drawElementsInstanced[ANGLE]` only accepts an instance count and not a starting
   * offset, this optimization becomes less effective as the clipRect moves closer to the end of the
   * text block. We could fix that by switching from instancing to a full geometry with a drawRange,
   * but at the expense of much larger attribute buffers (see classdoc above.)
   *
   * @param {Vector4} clipRect
   */
  applyClipRect(clipRect) {
    let count = this.getAttribute(glyphIndexAttrName).count;
    let chunks = this._chunkedBounds;
    if (chunks) {
      for (let i = chunks.length; i--; ) {
        count = chunks[i].end;
        let rect = chunks[i].rect;
        if (rect[1] &lt; clipRect.w && rect[3] > clipRect.y && rect[0] &lt; clipRect.z && rect[2] > clipRect.x) {
          break;
        }
      }
    }
    this.instanceCount = count;
  }
}
function updateBufferAttr(geom, attrName, newArray, itemSize) {
  const attr = geom.getAttribute(attrName);
  if (newArray) {
    if (attr && attr.array.length === newArray.length) {
      attr.array.set(newArray);
      attr.needsUpdate = true;
    } else {
      geom.setAttribute(attrName, new InstancedBufferAttribute(newArray, itemSize));
      delete geom._maxInstanceCount;
      geom.dispose();
    }
  } else if (attr) {
    geom.deleteAttribute(attrName);
  }
}
const VERTEX_DEFS = `
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform vec4 uTroikaTotalBounds;
uniform vec4 uTroikaClipRect;
uniform mat3 uTroikaOrient;
uniform bool uTroikaUseGlyphColors;
uniform float uTroikaDistanceOffset;
uniform float uTroikaBlurRadius;
uniform vec2 uTroikaPositionOffset;
uniform float uTroikaCurveRadius;
attribute vec4 aTroikaGlyphBounds;
attribute float aTroikaGlyphIndex;
attribute vec3 aTroikaGlyphColor;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec3 vTroikaGlyphColor;
varying vec2 vTroikaGlyphDimensions;
`;
const VERTEX_TRANSFORM = `
vec4 bounds = aTroikaGlyphBounds;
bounds.xz += uTroikaPositionOffset.x;
bounds.yw -= uTroikaPositionOffset.y;

vec4 outlineBounds = vec4(
  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,
  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius
);
vec4 clippedBounds = vec4(
  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),
  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)
);

vec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);

position.xy = mix(bounds.xy, bounds.zw, clippedXY);

uv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);

float rad = uTroikaCurveRadius;
if (rad != 0.0) {
  float angle = position.x / rad;
  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);
  normal.xz = vec2(sin(angle), cos(angle));
}

position = uTroikaOrient * position;
normal = uTroikaOrient * normal;

vTroikaGlyphUV = clippedXY.xy;
vTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);

${""}
float txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;
vec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;
vec2 txStartUV = txUvPerSquare * vec2(
  mod(floor(aTroikaGlyphIndex / 4.0), txCols),
  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)
);
vTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);
vTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);
`;
const FRAGMENT_DEFS = `
uniform sampler2D uTroikaSDFTexture;
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform float uTroikaSDFExponent;
uniform float uTroikaDistanceOffset;
uniform float uTroikaFillOpacity;
uniform float uTroikaOutlineOpacity;
uniform float uTroikaBlurRadius;
uniform vec3 uTroikaStrokeColor;
uniform float uTroikaStrokeWidth;
uniform float uTroikaStrokeOpacity;
uniform bool uTroikaSDFDebug;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec2 vTroikaGlyphDimensions;

float troikaSdfValueToSignedDistance(float alpha) {
  // Inverse of exponential encoding in webgl-sdf-generator
  ${""}
  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);
  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;
  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);
  return signedDist;
}

float troikaGlyphUvToSdfValue(vec2 glyphUV) {
  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);
  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);
  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1
  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;
}

float troikaGlyphUvToDistance(vec2 uv) {
  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));
}

float troikaGetAADist() {
  ${""}
  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300
  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;
  #else
  return vTroikaGlyphDimensions.x / 64.0;
  #endif
}

float troikaGetFragDistValue() {
  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);
  float distance = troikaGlyphUvToDistance(clampedGlyphUV);

  // Extrapolate distance when outside bounds:
  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 :
    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);

  ${""}

  return distance;
}

float troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {
  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)
  float alpha = step(-distanceOffset, -distance);
  #else

  float alpha = smoothstep(
    distanceOffset + aaDist,
    distanceOffset - aaDist,
    distance
  );
  #endif

  return alpha;
}
`;
const FRAGMENT_TRANSFORM = `
float aaDist = troikaGetAADist();
float fragDistance = troikaGetFragDistValue();
float edgeAlpha = uTroikaSDFDebug ?
  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :
  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));

#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)
vec4 fillRGBA = gl_FragColor;
fillRGBA.a *= uTroikaFillOpacity;
vec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);
if (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;
gl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(
  -uTroikaStrokeWidth - aaDist,
  -uTroikaStrokeWidth + aaDist,
  fragDistance
));
gl_FragColor.a *= edgeAlpha;
#endif

if (edgeAlpha == 0.0) {
  discard;
}
`;
function createTextDerivedMaterial(baseMaterial) {
  const textMaterial = createDerivedMaterial(baseMaterial, {
    chained: true,
    extensions: {
      derivatives: true
    },
    uniforms: {
      uTroikaSDFTexture: { value: null },
      uTroikaSDFTextureSize: { value: new Vector2() },
      uTroikaSDFGlyphSize: { value: 0 },
      uTroikaSDFExponent: { value: 0 },
      uTroikaTotalBounds: { value: new Vector4(0, 0, 0, 0) },
      uTroikaClipRect: { value: new Vector4(0, 0, 0, 0) },
      uTroikaDistanceOffset: { value: 0 },
      uTroikaOutlineOpacity: { value: 0 },
      uTroikaFillOpacity: { value: 1 },
      uTroikaPositionOffset: { value: new Vector2() },
      uTroikaCurveRadius: { value: 0 },
      uTroikaBlurRadius: { value: 0 },
      uTroikaStrokeWidth: { value: 0 },
      uTroikaStrokeColor: { value: new Color() },
      uTroikaStrokeOpacity: { value: 1 },
      uTroikaOrient: { value: new Matrix3() },
      uTroikaUseGlyphColors: { value: true },
      uTroikaSDFDebug: { value: false }
    },
    vertexDefs: VERTEX_DEFS,
    vertexTransform: VERTEX_TRANSFORM,
    fragmentDefs: FRAGMENT_DEFS,
    fragmentColorTransform: FRAGMENT_TRANSFORM,
    customRewriter({ vertexShader, fragmentShader }) {
      let uDiffuseRE = /\buniform\s+vec3\s+diffuse\b/;
      if (uDiffuseRE.test(fragmentShader)) {
        fragmentShader = fragmentShader.replace(uDiffuseRE, "varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g, "vTroikaGlyphColor");
        if (!uDiffuseRE.test(vertexShader)) {
          vertexShader = vertexShader.replace(
            voidMainRegExp,
            "uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"
          );
        }
      }
      return { vertexShader, fragmentShader };
    }
  });
  textMaterial.transparent = true;
  Object.defineProperties(textMaterial, {
    isTroikaTextMaterial: { value: true },
    // WebGLShadowMap reverses the side of the shadow material by default, which fails
    // for planes, so here we force the `shadowSide` to always match the main side.
    shadowSide: {
      get() {
        return this.side;
      },
      set() {
      }
    }
  });
  return textMaterial;
}
const defaultMaterial = /* @__PURE__ */ new MeshBasicMaterial({
  color: 16777215,
  side: DoubleSide,
  transparent: true
});
const defaultStrokeColor = 8421504;
const tempMat4 = /* @__PURE__ */ new Matrix4();
const tempVec3a = /* @__PURE__ */ new Vector3();
const tempVec3b = /* @__PURE__ */ new Vector3();
const tempArray = [];
const origin = /* @__PURE__ */ new Vector3();
const defaultOrient = "+x+y";
function first(o) {
  return Array.isArray(o) ? o[0] : o;
}
let getFlatRaycastMesh = () => {
  const mesh = new Mesh(
    new PlaneGeometry(1, 1),
    defaultMaterial
  );
  getFlatRaycastMesh = () => mesh;
  return mesh;
};
let getCurvedRaycastMesh = () => {
  const mesh = new Mesh(
    new PlaneGeometry(1, 1, 32, 1),
    defaultMaterial
  );
  getCurvedRaycastMesh = () => mesh;
  return mesh;
};
const syncStartEvent = { type: "syncstart" };
const syncCompleteEvent = { type: "synccomplete" };
const SYNCABLE_PROPS = [
  "font",
  "fontSize",
  "fontStyle",
  "fontWeight",
  "lang",
  "letterSpacing",
  "lineHeight",
  "maxWidth",
  "overflowWrap",
  "text",
  "direction",
  "textAlign",
  "textIndent",
  "whiteSpace",
  "anchorX",
  "anchorY",
  "colorRanges",
  "sdfGlyphSize"
];
const COPYABLE_PROPS = SYNCABLE_PROPS.concat(
  "material",
  "color",
  "depthOffset",
  "clipRect",
  "curveRadius",
  "orientation",
  "glyphGeometryDetail"
);
class Text extends Mesh {
  constructor() {
    const geometry = new GlyphsGeometry();
    super(geometry, null);
    this.text = "";
    this.anchorX = 0;
    this.anchorY = 0;
    this.curveRadius = 0;
    this.direction = "auto";
    this.font = null;
    this.unicodeFontsURL = null;
    this.fontSize = 0.1;
    this.fontWeight = "normal";
    this.fontStyle = "normal";
    this.lang = null;
    this.letterSpacing = 0;
    this.lineHeight = "normal";
    this.maxWidth = Infinity;
    this.overflowWrap = "normal";
    this.textAlign = "left";
    this.textIndent = 0;
    this.whiteSpace = "normal";
    this.material = null;
    this.color = null;
    this.colorRanges = null;
    this.outlineWidth = 0;
    this.outlineColor = 0;
    this.outlineOpacity = 1;
    this.outlineBlur = 0;
    this.outlineOffsetX = 0;
    this.outlineOffsetY = 0;
    this.strokeWidth = 0;
    this.strokeColor = defaultStrokeColor;
    this.strokeOpacity = 1;
    this.fillOpacity = 1;
    this.depthOffset = 0;
    this.clipRect = null;
    this.orientation = defaultOrient;
    this.glyphGeometryDetail = 1;
    this.sdfGlyphSize = null;
    this.gpuAccelerateSDF = true;
    this.debugSDF = false;
  }
  /**
   * Updates the text rendering according to the current text-related configuration properties.
   * This is an async process, so you can pass in a callback function to be executed when it
   * finishes.
   * @param {function} [callback]
   */
  sync(callback) {
    if (this._needsSync) {
      this._needsSync = false;
      if (this._isSyncing) {
        (this._queuedSyncs || (this._queuedSyncs = [])).push(callback);
      } else {
        this._isSyncing = true;
        this.dispatchEvent(syncStartEvent);
        getTextRenderInfo({
          text: this.text,
          font: this.font,
          lang: this.lang,
          fontSize: this.fontSize || 0.1,
          fontWeight: this.fontWeight || "normal",
          fontStyle: this.fontStyle || "normal",
          letterSpacing: this.letterSpacing || 0,
          lineHeight: this.lineHeight || "normal",
          maxWidth: this.maxWidth,
          direction: this.direction || "auto",
          textAlign: this.textAlign,
          textIndent: this.textIndent,
          whiteSpace: this.whiteSpace,
          overflowWrap: this.overflowWrap,
          anchorX: this.anchorX,
          anchorY: this.anchorY,
          colorRanges: this.colorRanges,
          includeCaretPositions: true,
          //TODO parameterize
          sdfGlyphSize: this.sdfGlyphSize,
          gpuAccelerateSDF: this.gpuAccelerateSDF,
          unicodeFontsURL: this.unicodeFontsURL
        }, (textRenderInfo) => {
          this._isSyncing = false;
          this._textRenderInfo = textRenderInfo;
          this.geometry.updateGlyphs(
            textRenderInfo.glyphBounds,
            textRenderInfo.glyphAtlasIndices,
            textRenderInfo.blockBounds,
            textRenderInfo.chunkedBounds,
            textRenderInfo.glyphColors
          );
          const queued = this._queuedSyncs;
          if (queued) {
            this._queuedSyncs = null;
            this._needsSync = true;
            this.sync(() => {
              queued.forEach((fn) => fn && fn());
            });
          }
          this.dispatchEvent(syncCompleteEvent);
          if (callback) {
            callback();
          }
        });
      }
    }
  }
  /**
   * Initiate a sync if needed - note it won't complete until next frame at the
   * earliest so if possible it's a good idea to call sync() manually as soon as
   * all the properties have been set.
   * @override
   */
  onBeforeRender(renderer, scene, camera, geometry, material, group) {
    this.sync();
    if (material.isTroikaTextMaterial) {
      this._prepareForRender(material);
    }
    material._hadOwnSide = material.hasOwnProperty("side");
    this.geometry.setSide(material._actualSide = material.side);
    material.side = FrontSide;
  }
  onAfterRender(renderer, scene, camera, geometry, material, group) {
    if (material._hadOwnSide) {
      material.side = material._actualSide;
    } else {
      delete material.side;
    }
  }
  /**
   * Shortcut to dispose the geometry specific to this instance.
   * Note: we don't also dispose the derived material here because if anything else is
   * sharing the same base material it will result in a pause next frame as the program
   * is recompiled. Instead users can dispose the base material manually, like normal,
   * and we'll also dispose the derived material at that time.
   */
  dispose() {
    this.geometry.dispose();
  }
  /**
   * @property {TroikaTextRenderInfo|null} textRenderInfo
   * @readonly
   * The current processed rendering data for this TextMesh, returned by the TextBuilder after
   * a `sync()` call. This will be `null` initially, and may be stale for a short period until
   * the asynchrous `sync()` process completes.
   */
  get textRenderInfo() {
    return this._textRenderInfo || null;
  }
  // Handler for automatically wrapping the base material with our upgrades. We do the wrapping
  // lazily on _read_ rather than write to avoid unnecessary wrapping on transient values.
  get material() {
    let derivedMaterial = this._derivedMaterial;
    const baseMaterial = this._baseMaterial || this._defaultMaterial || (this._defaultMaterial = defaultMaterial.clone());
    if (!derivedMaterial || derivedMaterial.baseMaterial !== baseMaterial) {
      derivedMaterial = this._derivedMaterial = createTextDerivedMaterial(baseMaterial);
      baseMaterial.addEventListener("dispose", function onDispose() {
        baseMaterial.removeEventListener("dispose", onDispose);
        derivedMaterial.dispose();
      });
    }
    if (this.outlineWidth || this.outlineBlur || this.outlineOffsetX || this.outlineOffsetY) {
      let outlineMaterial = derivedMaterial._outlineMtl;
      if (!outlineMaterial) {
        outlineMaterial = derivedMaterial._outlineMtl = Object.create(derivedMaterial, {
          id: { value: derivedMaterial.id + 0.1 }
        });
        outlineMaterial.isTextOutlineMaterial = true;
        outlineMaterial.depthWrite = false;
        outlineMaterial.map = null;
        derivedMaterial.addEventListener("dispose", function onDispose() {
          derivedMaterial.removeEventListener("dispose", onDispose);
          outlineMaterial.dispose();
        });
      }
      return [
        outlineMaterial,
        derivedMaterial
      ];
    } else {
      return derivedMaterial;
    }
  }
  set material(baseMaterial) {
    if (baseMaterial && baseMaterial.isTroikaTextMaterial) {
      this._derivedMaterial = baseMaterial;
      this._baseMaterial = baseMaterial.baseMaterial;
    } else {
      this._baseMaterial = baseMaterial;
    }
  }
  get glyphGeometryDetail() {
    return this.geometry.detail;
  }
  set glyphGeometryDetail(detail) {
    this.geometry.detail = detail;
  }
  get curveRadius() {
    return this.geometry.curveRadius;
  }
  set curveRadius(r) {
    this.geometry.curveRadius = r;
  }
  // Create and update material for shadows upon request:
  get customDepthMaterial() {
    return first(this.material).getDepthMaterial();
  }
  get customDistanceMaterial() {
    return first(this.material).getDistanceMaterial();
  }
  _prepareForRender(material) {
    const isOutline = material.isTextOutlineMaterial;
    const uniforms = material.uniforms;
    const textInfo = this.textRenderInfo;
    if (textInfo) {
      const { sdfTexture, blockBounds } = textInfo;
      uniforms.uTroikaSDFTexture.value = sdfTexture;
      uniforms.uTroikaSDFTextureSize.value.set(sdfTexture.image.width, sdfTexture.image.height);
      uniforms.uTroikaSDFGlyphSize.value = textInfo.sdfGlyphSize;
      uniforms.uTroikaSDFExponent.value = textInfo.sdfExponent;
      uniforms.uTroikaTotalBounds.value.fromArray(blockBounds);
      uniforms.uTroikaUseGlyphColors.value = !isOutline && !!textInfo.glyphColors;
      let distanceOffset = 0;
      let blurRadius = 0;
      let strokeWidth = 0;
      let fillOpacity;
      let strokeOpacity;
      let strokeColor;
      let offsetX = 0;
      let offsetY = 0;
      if (isOutline) {
        let { outlineWidth, outlineOffsetX, outlineOffsetY, outlineBlur, outlineOpacity } = this;
        distanceOffset = this._parsePercent(outlineWidth) || 0;
        blurRadius = Math.max(0, this._parsePercent(outlineBlur) || 0);
        fillOpacity = outlineOpacity;
        offsetX = this._parsePercent(outlineOffsetX) || 0;
        offsetY = this._parsePercent(outlineOffsetY) || 0;
      } else {
        strokeWidth = Math.max(0, this._parsePercent(this.strokeWidth) || 0);
        if (strokeWidth) {
          strokeColor = this.strokeColor;
          uniforms.uTroikaStrokeColor.value.set(strokeColor == null ? defaultStrokeColor : strokeColor);
          strokeOpacity = this.strokeOpacity;
          if (strokeOpacity == null)
            strokeOpacity = 1;
        }
        fillOpacity = this.fillOpacity;
      }
      uniforms.uTroikaDistanceOffset.value = distanceOffset;
      uniforms.uTroikaPositionOffset.value.set(offsetX, offsetY);
      uniforms.uTroikaBlurRadius.value = blurRadius;
      uniforms.uTroikaStrokeWidth.value = strokeWidth;
      uniforms.uTroikaStrokeOpacity.value = strokeOpacity;
      uniforms.uTroikaFillOpacity.value = fillOpacity == null ? 1 : fillOpacity;
      uniforms.uTroikaCurveRadius.value = this.curveRadius || 0;
      let clipRect = this.clipRect;
      if (clipRect && Array.isArray(clipRect) && clipRect.length === 4) {
        uniforms.uTroikaClipRect.value.fromArray(clipRect);
      } else {
        const pad = (this.fontSize || 0.1) * 100;
        uniforms.uTroikaClipRect.value.set(
          blockBounds[0] - pad,
          blockBounds[1] - pad,
          blockBounds[2] + pad,
          blockBounds[3] + pad
        );
      }
      this.geometry.applyClipRect(uniforms.uTroikaClipRect.value);
    }
    uniforms.uTroikaSDFDebug.value = !!this.debugSDF;
    material.polygonOffset = !!this.depthOffset;
    material.polygonOffsetFactor = material.polygonOffsetUnits = this.depthOffset || 0;
    const color = isOutline ? this.outlineColor || 0 : this.color;
    if (color == null) {
      delete material.color;
    } else {
      const colorObj = material.hasOwnProperty("color") ? material.color : material.color = new Color();
      if (color !== colorObj._input || typeof color === "object") {
        colorObj.set(colorObj._input = color);
      }
    }
    let orient = this.orientation || defaultOrient;
    if (orient !== material._orientation) {
      let rotMat = uniforms.uTroikaOrient.value;
      orient = orient.replace(/[^-+xyz]/g, "");
      let match = orient !== defaultOrient && orient.match(/^([-+])([xyz])([-+])([xyz])$/);
      if (match) {
        let [, hSign, hAxis, vSign, vAxis] = match;
        tempVec3a.set(0, 0, 0)[hAxis] = hSign === "-" ? 1 : -1;
        tempVec3b.set(0, 0, 0)[vAxis] = vSign === "-" ? -1 : 1;
        tempMat4.lookAt(origin, tempVec3a.cross(tempVec3b), tempVec3b);
        rotMat.setFromMatrix4(tempMat4);
      } else {
        rotMat.identity();
      }
      material._orientation = orient;
    }
  }
  _parsePercent(value) {
    if (typeof value === "string") {
      let match = value.match(/^(-?[\d.]+)%$/);
      let pct = match ? parseFloat(match[1]) : NaN;
      value = (isNaN(pct) ? 0 : pct / 100) * this.fontSize;
    }
    return value;
  }
  /**
   * Translate a point in local space to an x/y in the text plane.
   */
  localPositionToTextCoords(position, target = new Vector2()) {
    target.copy(position);
    const r = this.curveRadius;
    if (r) {
      target.x = Math.atan2(position.x, Math.abs(r) - Math.abs(position.z)) * Math.abs(r);
    }
    return target;
  }
  /**
   * Translate a point in world space to an x/y in the text plane.
   */
  worldPositionToTextCoords(position, target = new Vector2()) {
    tempVec3a.copy(position);
    return this.localPositionToTextCoords(this.worldToLocal(tempVec3a), target);
  }
  /**
   * @override Custom raycasting to test against the whole text block's max rectangular bounds
   * TODO is there any reason to make this more granular, like within individual line or glyph rects?
   */
  raycast(raycaster, intersects) {
    const { textRenderInfo, curveRadius } = this;
    if (textRenderInfo) {
      const bounds = textRenderInfo.blockBounds;
      const raycastMesh = curveRadius ? getCurvedRaycastMesh() : getFlatRaycastMesh();
      const geom = raycastMesh.geometry;
      const { position, uv } = geom.attributes;
      for (let i = 0; i &lt; uv.count; i++) {
        let x = bounds[0] + uv.getX(i) * (bounds[2] - bounds[0]);
        const y = bounds[1] + uv.getY(i) * (bounds[3] - bounds[1]);
        let z = 0;
        if (curveRadius) {
          z = curveRadius - Math.cos(x / curveRadius) * curveRadius;
          x = Math.sin(x / curveRadius) * curveRadius;
        }
        position.setXYZ(i, x, y, z);
      }
      geom.boundingSphere = this.geometry.boundingSphere;
      geom.boundingBox = this.geometry.boundingBox;
      raycastMesh.matrixWorld = this.matrixWorld;
      raycastMesh.material.side = this.material.side;
      tempArray.length = 0;
      raycastMesh.raycast(raycaster, tempArray);
      for (let i = 0; i &lt; tempArray.length; i++) {
        tempArray[i].object = this;
        intersects.push(tempArray[i]);
      }
    }
  }
  copy(source) {
    const geom = this.geometry;
    super.copy(source);
    this.geometry = geom;
    COPYABLE_PROPS.forEach((prop) => {
      this[prop] = source[prop];
    });
    return this;
  }
  clone() {
    return new this.constructor().copy(this);
  }
}
SYNCABLE_PROPS.forEach((prop) => {
  const privateKey = "_private_" + prop;
  Object.defineProperty(Text.prototype, prop, {
    get() {
      return this[privateKey];
    },
    set(value) {
      if (value !== this[privateKey]) {
        this[privateKey] = value;
        this._needsSync = true;
      }
    }
  });
});
/* @__PURE__ */ new WeakMap();
/* @__PURE__ */ new WeakMap();
const OptomancyContext = React.createContext(null);
const defaultOptions = {
  theme: "light",
  interactive: false,
  renderText: true
};
const OptionsContext = React.createContext(defaultOptions);
const Providers = ({ children, optomancy, options = {} }) => {
  return /* @__PURE__ */ jsx(OptionsContext.Provider, { value: options, children: /* @__PURE__ */ jsx(OptomancyContext.Provider, { value: optomancy, children }) });
};
const defaultIndex = {
  workspace: 0,
  view: 0,
  layer: 0
};
const IndexContext = React.createContext(defaultIndex);
const fonts = {
  Roboto: "https://fonts.gstatic.com/s/roboto/v18/KFOmCnqEu92Fr1Mu4mxM.woff"
};
const Ticks = ({
  channel,
  axisName,
  axisColor,
  axisLength,
  sF,
  ...rest
}) => {
  var _a;
  const optomancy = useContext(OptomancyContext);
  const index = useContext(IndexContext);
  const options = useContext(OptionsContext);
  const TICK_RADIUS = AXIS_RADIUS * 2 * sF;
  const TICK_WIDTH = AXIS_RADIUS * sF;
  const LABEL_FONT_SIZE = 0.03 * sF;
  let tickValues;
  let tickOffset = 0;
  let tickCount = null;
  const axisScale = optomancy.scales[index.workspace][index.view][index.layer][axisName];
  if (channel.type === "quantitative") {
    tickCount = typeof channel.axis !== "boolean" && ((_a = channel == null ? void 0 : channel.axis) == null ? void 0 : _a.tickCount) || tickCount;
    if (tickCount !== null) {
      tickValues = axisScale.ticks(tickCount);
    } else {
      tickValues = axisScale.ticks();
    }
  } else {
    tickValues = axisScale.domain();
    tickOffset = axisScale.bandwidth() / 2;
  }
  const ticks = tickValues.map((tick, i) => {
    const key = `a${axisName}t${i}w${index.workspace}v${index.view}l${index.layer}}`;
    return /* @__PURE__ */ jsxs(
      "mesh",
      {
        position: [0, axisScale(tick) + tickOffset - axisLength / 2, 0],
        children: [
          /* @__PURE__ */ jsx(
            "cylinderGeometry",
            {
              attach: "geometry",
              args: [TICK_RADIUS, TICK_RADIUS, TICK_WIDTH]
            }
          ),
          /* @__PURE__ */ jsx("meshStandardMaterial", { color: axisColor })
        ]
      },
      key
    );
  });
  const labels = tickValues.map((tick, i) => {
    let value = tick;
    if (typeof value === "number" && typeof (channel == null ? void 0 : channel.numberFormat) === "string")
      ;
    const key = `a${axisName}tv${i}w${index.workspace}v${index.view}l${index.layer}}`;
    return /* @__PURE__ */ jsx(
      "group",
      {
        position: getLabelPosition(
          axisName,
          tick,
          axisScale,
          tickOffset,
          axisLength,
          sF
        ),
        rotation: getLabelRotation(axisName),
        children: /* @__PURE__ */ jsx(
          Text$1,
          {
            anchorX: "right",
            anchorY: "middle",
            textAlign: "right",
            color: axisColor,
            font: fonts.Roboto,
            fontSize: LABEL_FONT_SIZE,
            material: new THREE.MeshPhongMaterial(),
            children: value
          }
        )
      },
      key
    );
  });
  return /* @__PURE__ */ jsxs(JSXFragment, { children: [
    ticks,
    options.renderText && labels
  ] });
};
function getLabelPosition(type, tick, axisScale, tickOffset, axisLength, sF) {
  const LABEL_OFFSET = -0.05;
  switch (type) {
    case "x":
      return new THREE.Vector3(
        -LABEL_OFFSET * sF,
        axisScale(tick) + tickOffset - axisLength / 2,
        0
      );
    case "y":
      return new THREE.Vector3(
        LABEL_OFFSET * sF,
        axisScale(tick) + tickOffset - axisLength / 2,
        0
      );
    case "z":
      return new THREE.Vector3(
        0,
        axisScale(tick) + tickOffset - axisLength / 2,
        LABEL_OFFSET * sF
      );
    default:
      return new THREE.Vector3(
        -LABEL_OFFSET * sF,
        axisScale(tick) + tickOffset - axisLength / 2,
        0
      );
  }
}
function getLabelRotation(type) {
  switch (type) {
    case "x":
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(180));
    case "y":
      return new THREE.Euler(0, 0, 0);
    case "z":
      return new THREE.Euler(
        THREE.MathUtils.degToRad(-90),
        THREE.MathUtils.degToRad(-90),
        THREE.MathUtils.degToRad(-90)
      );
    default:
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(180));
  }
}
const AXIS_RADIUS = 5e-3;
const TITLE_FONT_SIZE = 0.075;
const TITLE_OFFSET = 0.2;
const Axis = ({ children, type, view, channel, ...rest }) => {
  const options = useContext(OptionsContext);
  const axisColor = (options == null ? void 0 : options.theme) === "light" ? "black" : "white";
  const axisLength = getLength(type, view);
  const sF = getViewScaleFactor(type, view);
  return channel.axis !== void 0 ? /* @__PURE__ */ jsxs(
    "mesh",
    {
      ...rest,
      rotation: getRotation(type),
      position: getPosition(type, view),
      children: [
        /* @__PURE__ */ jsx(
          "cylinderGeometry",
          {
            attach: "geometry",
            args: [AXIS_RADIUS * sF, AXIS_RADIUS * sF, axisLength]
          }
        ),
        /* @__PURE__ */ jsx("meshStandardMaterial", { color: axisColor }),
        /* @__PURE__ */ jsx(
          Ticks,
          {
            channel,
            axisName: type,
            axisColor,
            axisLength,
            sF
          }
        ),
        options.renderText && /* @__PURE__ */ jsx(
          Text$1,
          {
            anchorX: "center",
            anchorY: "middle",
            color: axisColor,
            rotation: getTitleRotation(type),
            position: getTitlePosition(type, sF),
            font: fonts.Roboto,
            fontSize: TITLE_FONT_SIZE * sF,
            material: new THREE.MeshPhongMaterial(),
            children: typeof channel.axis !== "boolean" && channel.axis.title
          }
        )
      ]
    }
  ) : null;
};
function getViewScaleFactor(type, view) {
  return type === "x" ? view.width : type === "y" ? view.height : type === "z" ? view.depth : 1;
}
function getRotation(type) {
  switch (type) {
    case "x":
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(-90));
    case "y":
      return new THREE.Euler(0, 0, 0);
    case "z":
      return new THREE.Euler(THREE.MathUtils.degToRad(-90), 0, 0);
    default:
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(90));
  }
}
function getLength(type, view) {
  switch (type) {
    case "x":
      return view.width ?? 1;
    case "y":
      return view.height ?? 1;
    case "z":
      return view.depth ?? 1;
    default:
      return view.width ?? 1;
  }
}
function getPosition(type, view) {
  switch (type) {
    case "x":
      return new THREE.Vector3(0, -view.height / 2, view.depth / 2);
    case "y":
      return new THREE.Vector3(-view.width / 2, 0, view.depth / 2);
    case "z":
      return new THREE.Vector3(-view.width / 2, -view.height / 2, 0);
    default:
      return new THREE.Vector3(0, -view.height / 2, view.depth / 2);
  }
}
function getTitleRotation(type) {
  switch (type) {
    case "x":
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(90));
    case "y":
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(90));
    case "z":
      return new THREE.Euler(
        0,
        THREE.MathUtils.degToRad(-90),
        THREE.MathUtils.degToRad(-90)
      );
    default:
      return new THREE.Euler(0, 0, THREE.MathUtils.degToRad(90));
  }
}
function getTitlePosition(type, sF) {
  switch (type) {
    case "x":
      return new THREE.Vector3(TITLE_OFFSET * sF, 0, 0);
    case "y":
      return new THREE.Vector3(-TITLE_OFFSET * sF, 0, 0);
    case "z":
      return new THREE.Vector3(0, 0, -TITLE_OFFSET * sF);
    default:
      new THREE.Vector3(0, -TITLE_OFFSET, 0);
  }
}
const CartesianAxes = ({ children, view, ...rest }) => {
  return /* @__PURE__ */ jsxs("group", { ...rest, children: [
    view.encoding && view.encoding.x ? /* @__PURE__ */ jsx(Axis, { type: "x", view, channel: view.encoding.x }) : null,
    view.encoding && view.encoding.y ? /* @__PURE__ */ jsx(Axis, { type: "y", view, channel: view.encoding.y }) : null,
    view.encoding && view.encoding.z ? /* @__PURE__ */ jsx(Axis, { type: "z", view, channel: view.encoding.z }) : null
  ] });
};
const SphereMark = ({ position, color, sF, rest }) => {
  return /* @__PURE__ */ jsxs("mesh", { ...rest, position, children: [
    /* @__PURE__ */ jsx("sphereGeometry", { args: [0.01 * sF, 8, 8] }),
    /* @__PURE__ */ jsx("meshStandardMaterial", { color, roughness: 0.1, metalness: 0.1 })
  ] });
};
const BoxMark = ({
  position,
  dimensions = [0.1, 0.1, 0.1],
  color,
  rest
}) => {
  return /* @__PURE__ */ jsxs("mesh", { ...rest, position, children: [
    /* @__PURE__ */ jsx("boxGeometry", { args: dimensions }),
    /* @__PURE__ */ jsx("meshStandardMaterial", { color })
  ] });
};
const getBoxProperties = (optomancy, index, view, xValue, yValue, zValue) => {
  var _a, _b, _c, _d, _e, _f;
  const xFieldType = ((_b = (_a = view.encoding) == null ? void 0 : _a.x) == null ? void 0 : _b.type) || null;
  const yFieldType = ((_d = (_c = view.encoding) == null ? void 0 : _c.y) == null ? void 0 : _d.type) || null;
  const zFieldType = ((_f = (_e = view.encoding) == null ? void 0 : _e.z) == null ? void 0 : _f.type) || null;
  const q = [];
  const n = [];
  xFieldType === "quantitative" ? q.push("x") : xFieldType === null && n.push("x");
  yFieldType === "quantitative" ? q.push("y") : yFieldType === null && n.push("y");
  zFieldType === "quantitative" ? q.push("z") : zFieldType === null && n.push("z");
  const quantAxisField = q[0];
  optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].width;
  optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].height;
  optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].depth;
  const xScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].x;
  const yScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].y;
  const zScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].z;
  let xPos = 0;
  let yPos = 0;
  let zPos = 0;
  let width = 0;
  let height = 0;
  let depth = 0;
  switch (quantAxisField) {
    case "x":
      xPos = xScale ? xValue / 2 : 1e-3;
      yPos = yScale ? yValue + yScale.bandwidth() / 2 : 1e-3;
      zPos = zScale ? -(zValue + zScale.bandwidth() / 2) || 0 : -1e-3;
      width = xValue || 1e-3;
      height = yScale ? yScale.bandwidth() : 1e-3;
      depth = zScale ? zScale.bandwidth() : 1e-4;
      break;
    case "y":
      xPos = xScale ? xValue + xScale.bandwidth() / 2 : 1e-3;
      yPos = xScale ? yValue / 2 : 1e-3;
      zPos = zScale ? -(zValue + zScale.bandwidth() / 2) || 0 : -1e-3;
      width = xScale ? xScale.bandwidth() : 1e-3;
      height = yValue || 1e-3;
      depth = zScale ? zScale.bandwidth() : 1e-3;
      break;
    case "z":
      xPos = xScale ? xValue + xScale.bandwidth() / 2 : 1e-3;
      yPos = yScale ? yValue + yScale.bandwidth() / 2 || 0 : 1e-3;
      zPos = zScale ? -(zValue / 2) : -1e-3;
      width = xScale ? xScale.bandwidth() : 1e-3;
      height = yScale ? yScale.bandwidth() : 1e-3;
      depth = zValue || 1e-3;
      break;
  }
  const position = new THREE.Vector3(xPos || 0, yPos || 0, zPos || 0);
  const dimensions = [width, height, depth];
  return { position, dimensions };
};
const getMarkKey = (markIndex, workspaceIndex, viewIndex, layerIndex) => {
  return `m${markIndex}w${workspaceIndex}v${viewIndex}l${layerIndex}`;
};
const Marks = ({ children, view, ...rest }) => {
  const optomancy = useContext(OptomancyContext);
  const index = useContext(IndexContext);
  const options = useContext(OptionsContext);
  const datasetName = optomancy == null ? void 0 : optomancy.config.workspaces[index.workspace].data;
  const dataset = typeof datasetName === "string" ? optomancy == null ? void 0 : optomancy.datasets[datasetName] : [];
  const xScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].x;
  const yScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].y;
  const zScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].z;
  const colorScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].color;
  const sizeScale = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].size;
  const xField = view.encoding.x && view.encoding.x.field;
  const yField = view.encoding.y && view.encoding.y.field;
  const zField = view.encoding.z && view.encoding.z.field;
  const colorField = view.encoding.color && view.encoding.color.field;
  const sizeField = view.encoding.size && view.encoding.size.field;
  const instancedMarks = ({ d = void 0, ...props }) => {
    const o = new THREE.Object3D();
    const c = new THREE.Color();
    if (d === void 0)
      return null;
    const length = d.length;
    const ref = useRef();
    const hoveredRef = useRef();
    const markType2 = typeof view.mark !== "string" ? view.mark.type : "point";
    const markShape = typeof view.mark !== "string" ? view.mark.shape : "sphere";
    function renderMarks(d2) {
      for (let i = 0; i &lt; length; i++) {
        const row = d2[i];
        const xValue = xField ? xScale(row[xField]) : 0;
        const yValue = yField ? yScale(row[yField]) : 0;
        const zValue = zField ? zScale(row[zField]) : 0;
        const colorValue = colorField ? row[colorField] : 0;
        const color = colorScale ? colorScale(colorValue) : "red";
        const sizeValue = sizeField ? row[sizeField] : 0;
        const size = sizeScale ? sizeScale(sizeValue) : 0.01;
        if (markType2 === "point") {
          o.position.set(
            xScale ? xValue : 0,
            yScale ? yValue : 0,
            zScale ? -zValue : 0
          );
          o.scale.set(size, size, size);
        }
        if (markType2 === "bar") {
          const { position, dimensions } = getBoxProperties(
            optomancy,
            index,
            view,
            xValue,
            yValue,
            zValue
          );
          o.position.set(position.x, position.y, position.z);
          o.scale.set(...dimensions);
        }
        if (i === hoveredRef.current) {
          ref.current.setColorAt(i, c.set("black"));
        } else {
          ref.current.setColorAt(i, c.set(color));
        }
        o.updateMatrix();
        ref.current.setMatrixAt(i, o.matrix);
        ref.current.instanceColor.needsUpdate = true;
      }
      ref.current.instanceMatrix.needsUpdate = true;
      ref.current.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
    }
    useFrame(() => {
      renderMarks(d);
    });
    useInteraction(ref, "onHover", (e) => {
      hoveredRef.current = e.intersection.instanceId;
    });
    useInteraction(ref, "onBlur", (e) => {
      hoveredRef.current = null;
    });
    const onPointerOver = (e) => {
      e.stopPropagation();
      hoveredRef.current = e.instanceId;
    };
    const onPointerOut = () => {
      hoveredRef.current = null;
    };
    return /* @__PURE__ */ jsx("group", { ...props, children: /* @__PURE__ */ jsxs(
      "instancedMesh",
      {
        ref,
        args: [, , length],
        onPointerOver: (options == null ? void 0 : options.interactive) ? onPointerOver : void 0,
        onPointerOut: (options == null ? void 0 : options.interactive) ? onPointerOut : void 0,
        material: new THREE.MeshStandardMaterial(),
        children: [
          markShape === "box" && /* @__PURE__ */ jsx("boxGeometry", {}),
          markShape === "sphere" && /* @__PURE__ */ jsx("sphereGeometry", {})
        ]
      }
    ) });
  };
  let markType = typeof view.mark !== "string" ? view.mark.type : "point";
  dataset.map((row, i) => {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    const key = getMarkKey(i, index.workspace, index.view, index.layer);
    const xValue = xField ? xScale(row[xField]) : 0;
    const yValue = yField ? yScale(row[yField]) : 0;
    const zValue = zField ? zScale(row[zField]) : 0;
    const colorValue = colorField ? row[colorField] : 0;
    const color = colorScale ? colorScale(colorValue) : "red";
    const markShape = typeof view.mark !== "string" ? view.mark.shape : "sphere";
    switch (markType) {
      case "point": {
        const position = new THREE.Vector3(
          xScale ? xValue : 0,
          yScale ? yValue : 0,
          zScale ? -zValue : 0
        );
        const sF = view.width || 1;
        switch (markShape) {
          case "box":
            return /* @__PURE__ */ jsx(
              BoxMark,
              {
                position,
                dimensions: [0.1, 0.1, 0.1],
                color,
                rest
              },
              key
            );
          case "sphere":
          default:
            return /* @__PURE__ */ jsx(
              SphereMark,
              {
                position,
                color,
                rest,
                sF
              },
              key
            );
        }
      }
      case "bar": {
        const xFieldType = ((_b = (_a = view.encoding) == null ? void 0 : _a.x) == null ? void 0 : _b.type) || null;
        const yFieldType = ((_d = (_c = view.encoding) == null ? void 0 : _c.y) == null ? void 0 : _d.type) || null;
        const zFieldType = ((_f = (_e = view.encoding) == null ? void 0 : _e.z) == null ? void 0 : _f.type) || null;
        ((_h = (_g = view.encoding) == null ? void 0 : _g.color) == null ? void 0 : _h.type) || null;
        const q = [];
        const n = [];
        xFieldType === "quantitative" ? q.push("x") : xFieldType === null && n.push("x");
        yFieldType === "quantitative" ? q.push("y") : yFieldType === null && n.push("y");
        zFieldType === "quantitative" ? q.push("z") : zFieldType === null && n.push("z");
        const quantAxisField = q[0];
        optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].width;
        optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].height;
        optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].depth;
        const xScale2 = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].x;
        const yScale2 = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].y;
        const zScale2 = optomancy == null ? void 0 : optomancy.scales[index.workspace][index.view][index.layer].z;
        let xPos = 0;
        let yPos = 0;
        let zPos = 0;
        let width = 0;
        let height = 0;
        let depth = 0;
        switch (quantAxisField) {
          case "x":
            xPos = xScale2 ? xValue / 2 : 1e-3;
            yPos = yScale2 ? yValue + yScale2.bandwidth() / 2 : 1e-3;
            zPos = zScale2 ? -(zValue + zScale2.bandwidth() / 2) || 0 : -1e-3;
            width = xValue || 1e-3;
            height = yScale2 ? yScale2.bandwidth() : 1e-3;
            depth = zScale2 ? zScale2.bandwidth() : 1e-4;
            break;
          case "y":
            xPos = xScale2 ? xValue + xScale2.bandwidth() / 2 : 1e-3;
            yPos = xScale2 ? yValue / 2 : 1e-3;
            zPos = zScale2 ? -(zValue + zScale2.bandwidth() / 2) || 0 : -1e-3;
            width = xScale2 ? xScale2.bandwidth() : 1e-3;
            height = yValue || 1e-3;
            depth = zScale2 ? zScale2.bandwidth() : 1e-3;
            break;
          case "z":
            xPos = xScale2 ? xValue + xScale2.bandwidth() / 2 : 1e-3;
            yPos = yScale2 ? yValue + yScale2.bandwidth() / 2 || 0 : 1e-3;
            zPos = zScale2 ? -(zValue / 2) : -1e-3;
            width = xScale2 ? xScale2.bandwidth() : 1e-3;
            height = yScale2 ? yScale2.bandwidth() : 1e-3;
            depth = zValue || 1e-3;
            break;
        }
        const position = new THREE.Vector3(xPos || 0, yPos || 0, zPos || 0);
        const dimensions = [width, height, depth];
        switch (markShape) {
          case "box":
          default:
            return /* @__PURE__ */ jsx(
              BoxMark,
              {
                position,
                dimensions,
                color,
                rest
              },
              key
            );
        }
      }
      default:
        return null;
    }
  });
  return /* @__PURE__ */ jsx(
    "group",
    {
      position: [
        -view.width / 2,
        -view.height / 2,
        -view.depth / 2 + view.depth
      ],
      children: instancedMarks({ d: dataset })
    }
  );
};
function getViewPosition(view, index) {
  const viewMargin = 0.5;
  return new THREE.Vector3(
    index + viewMargin * index + view.x,
    0 + view.y,
    // 0 + view.x!,
    // index + viewMargin * index + view.y!,
    -1 + view.z
  );
}
const View = ({ children, view, ...rest }) => {
  const index = useContext(IndexContext);
  return /* @__PURE__ */ jsxs("mesh", { ...rest, position: getViewPosition(view, index.view), children: [
    /* @__PURE__ */ jsx(CartesianAxes, { view }),
    /* @__PURE__ */ jsx(Marks, { view, position: [0, 0, 0] }),
    children
  ] });
};
function getWorkspaceDimensions(workspace) {
  return {
    width: workspace.views.map((view) => view.width).reduce((a, b) => a + b),
    height: workspace.views.map((view) => view.height).reduce((a, b) => a + b),
    depth: workspace.views.map((view) => view.depth).reduce((a, b) => a + b)
  };
}
function getWorkspacePosition(workspace, index) {
  const workspaceMargin = 0.2;
  // console.log(index, getWorkspaceDimensions(workspace).height);
  return new THREE.Vector3(
    0,
    +getWorkspaceDimensions(workspace).height + workspaceMargin,
    0
  );
}
const Workspace = ({ workspace, workspaceIndex, ...rest }) => {
  return /* @__PURE__ */ jsx("mesh", { ...rest, position: getWorkspacePosition(workspace, workspaceIndex), children: workspace.views.map((view, viewIndex) => (
    // TODO: This provider assumes no layers, update the location of this provider to be within View once layers are supported
    /* @__PURE__ */ jsx(
      IndexContext.Provider,
      {
        value: { workspace: workspaceIndex, view: viewIndex, layer: 0 },
        children: /* @__PURE__ */ jsx(View, { view })
      },
      `workspace_${workspaceIndex}-view_${viewIndex}`
    )
  )) });
};
const Workspaces = ({ ...rest }) => {
  const optomancy = useContext(OptomancyContext);
  return /* @__PURE__ */ jsx("mesh", { ...rest, children: optomancy && optomancy.config.workspaces.map(
    (workspace, i) => /* @__PURE__ */ jsx(
      Workspace,
      {
        workspace,
        workspaceIndex: i
      },
      `workspace_${i}`
    )
  ) });
};
extend({ TroikaText: Text });
const OptomancyR3F = ({ config, options, ...rest }) => {
  const optomancy = new Optomancy(config);
  // console.log("OptomancyR3F -> userConfig", optomancy.userConfig);
  // console.log("OptomancyR3F -> config", optomancy.config);
  // console.log("OptomancyR3F -> scales", optomancy.scales);
  // console.log("OptomancyR3F -> datasets", optomancy.datasets);
  return /* @__PURE__ */ jsx(Providers, { options, optomancy, children: /* @__PURE__ */ jsx(Workspaces, { ...rest }) });
};
export {
  OptomancyR3F
};
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Styles"><CODE-FRAGMENT data-type="text/css" auto name="Inter Font">@font-face {
    font-family: "Inter";
    font-weight: 100 900;
    font-display: swap;
    font-style: normal;
    src: url("inter-variable.zip/inter-variable.woff2") format("woff2-variations"),
         url("inter-variable.zip/inter-variable.woff2") format("woff2");
    src: url("inter-variable.zip/inter-variable.woff2") format("woff2") tech("variations");
}

@font-face {
    font-family: "Inter";
    font-weight: 100 900;
    font-display: swap;
    font-style: italic;
    src: url("inter-variable.zip/inter-variable-Italic.woff2") format("woff2-variations"),
         url("inter-variable.zip/inter-variable-Italic.woff2") format("woff2");
    src: url("inter-variable.zip/inter-variable-Italic.woff2") format("woff2") tech("variations");
}
</CODE-FRAGMENT><CODE-FRAGMENT auto data-type="text/x-scss" name="UI Styling">@mixin heading-font {
    font-weight: 500;
    font-size: 13px;
    letter-spacing: 0.25px;
}

body {
    margin: 0;
    font-family: Inter, sans-serif;
    height: 100vh;
}

#cauldron-edit-button {
    z-index: 100001;
    user-select: none;
    cursor: pointer;
}

fiber-scene,
#embed-root {
    display: none;
}

.fiber-renderer,
#fiber-renderer {
    display: block;
    width: 100%;
    height: 100vh;
    top: 0;
    left: 0;
    overflow: hidden;
}

.crosshair {
    display: none;
    position: absolute;
    left: 50%;
    top: 50%;
    background: #FF3D00;
    outline: 2px solid #E4E3DF;
    border: 2px solid #231F20;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}



.user-manager-modal {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    z-index: 100000;
    -webkit-backdrop-filter: saturate(180%) blur(10px);
    backdrop-filter: saturate(180%) blur(5px);
    background: rgba(192, 192, 192, .60) !important;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;

    button {
        @include heading-font;

        user-select: none;
        border-radius: 4px;
        padding: 2px 8px;
        background: #636363;
        color: #fff;
        vertical-align: middle;
        text-align: center;
        cursor: pointer;
        border: none;

        &:hover {
            background: #848484;
        }

        &:active {
            background: #606060;
        }

        &.red {
            background: #d32f2f !important;

            &:hover {
                background: #ff6659 !important;
            }

            &:active {
                background: #9a0007 !important;
            }
        }

        &.green {
            background: #2e7d32 !important;

            &:hover {
                background: #60ad5e !important;
            }

            &:active {
                background: #005005 !important;
            }
        }
    }

    label {
        @include heading-font;

        user-select: none;
        white-space: nowrap;

        background: #eeeeee;
        color: #000000;

        border-radius: 4px;
        padding-left: 8px;
        padding-right: 8px;
        padding-right: 0;

        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: center;
        gap: 4px;

        input[type="checkbox"] {
            width: 24px;
        }

        input:not([type="checkbox"]),
        select {
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
            height: 100%;
        }
    }

    input:not([type="checkbox"]),
    select,
    textarea {
        border-radius: 4px;
        border: none;
        padding: 0 8px;
        text-overflow: ellipsis;
        outline: none;
        color: #000;
        width: 100%;
    }

    .user-manager {
        background: #fafafa;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        gap: 12px;
        max-width: 100%;
        box-shadow: 0 0 12px 0 rgba(0, 0, 0, 0.25);
    }


    .user-headline {
        font-size: 24px;
        font-weight: 700;
        cursor: default;
        user-select: none;
    }

    .user-menu {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 8px;
        min-height: 32px;
        padding: 8px;
        border-radius: 4px;
        background: #ddd;
    }

    .user-list {
        display: flex;
        flex-direction: row;
        gap: 8px;
        padding: 8px;
        border-radius: 4px;
        background: #ddd;
    }

    .user {
        height: 20px;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 20px;
        background: #eeeeee;
        user-select: none;
    }

    .user[local="true"] {
        background: #FFAB40;
    }

    .login-button {
        height: 64px;
    }
}

.floating-menus {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    align-items: flex-end;
    justify-content: space-between;
    gap: 8px;
}

.floating-menu {
    z-index: 99999;
    -webkit-backdrop-filter: saturate(180%) blur(10px);
    backdrop-filter: saturate(180%) blur(10px);
    background: rgba(255, 255, 255, .60) !important;
    border-radius: 12px;
    border: 1px solid #cccccc70;
    box-shadow: 0 0 8px 0 rgba(0, 0, 0, 0.025);
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 12px;
    flex: 0 1 192px;

    max-height: 40px;
    overflow: hidden;
    transition: max-height 500ms ease-in-out;

    &:hover:not(.always-visible) {
        max-height: initial;

        .title {
            order: 999;
        }
    }

    &.always-visible {
        max-height: initial;
    }

    .spacer {
        border-bottom: 1px solid #63636370;
        margin: 0 32px;
    }

    .title {
        @include heading-font;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;

        user-select: none;
        text-align: center;
        cursor: default;
        color: #636363dd;
    }

    button {
        @include heading-font;
        min-height: 40px;

        user-select: none;
        border-radius: 4px;
        padding: 4px 8px;
        background: #63636390;
        color: #fff;
        vertical-align: middle;
        text-align: center;
        cursor: pointer;
        border: none;

        &:hover {
            background: #848484cc;
        }

        &:active {
            background: #606060cc;
        }

        &.red {
            background: #d32f2f90 !important;

            &:hover {
                background: #ff6659cc !important;
            }

            &:active {
                background: #9a0007cc !important;
            }
        }

        &.green {
            background: #2e7d3290 !important;

            &:hover {
                background: #61ad5ecc !important;
            }

            &:active {
                background: #005005cc !important;
            }
        }

        &[toggled="true"] {
            background: #FF910090 !important;
        }
    }

    .upload-drop-zone {
        @include heading-font;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;

        user-select: none;
        text-align: center;
        cursor: pointer;
        background: #ddd;
        border-radius: 4px;

        &.upload-drop-zone--over {
            background: #ccc;
            cursor: copy;
        }
    }
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Modules"><CODE-FRAGMENT data-type="text/javascript+babel" name="Helpers" id="helpers">export const recordAudio = (duration) => {
    return new Promise((resolve, reject) => {
        let chunks = [];

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                chunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(chunks, { type: 'audio/wav' });
                resolve(audioBlob);
            };

            mediaRecorder.start();

            setTimeout(() => {
                mediaRecorder.stop();
            }, duration);
        }).catch(error => {
            reject(error);
        });
    });
};

export const transcribeAudio = async (duration, audioBlob = false, recordingEndedCallback = false) => {
    if (!window.API_KEY) {
        window.API_KEY = prompt('Please enter your OpenAI API key:');
        if (!window.API_KEY) {
            if (recordingEndedCallback) recordingEndedCallback();
            console.error('An API_KEY is required to transcribe audio.');
            return;
        }
    }

    let audioBlobToTranscribe = audioBlob;
    if (!audioBlobToTranscribe) {
        audioBlobToTranscribe = await recordAudio(duration);
    }

    if (recordingEndedCallback) recordingEndedCallback();

    const formData = new FormData();
    formData.append('file', audioBlobToTranscribe, 'recording.wav');
    formData.append('model', 'whisper-1');

    const whisperResponse = await fetch('https://api.openai.com/v1/audio/transcriptions', {
        method: 'POST',
        mode: 'cors',
        headers: { 'Authorization': `Bearer ${API_KEY}` },
        body: formData,
    });
    const whisperData = await whisperResponse.json();

    return whisperData.text;
};

export const sendGPTPrompt = async (body) => {
    if (!window.API_KEY) {
        window.API_KEY = prompt('Please enter your OpenAI API key:');
        if (!window.API_KEY) {
            console.error('An API_KEY is required to transcribe audio.');
            return;
        }
    }

    const options = {
        method: 'POST',
        mode: 'cors',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify(body)
    };
    console.log('OpenAI API call options:', options);

    const gptResponse = await fetch('https://api.openai.com/v1/chat/completions', options);
    const gptData = await gptResponse.json();
    return gptData;
};

export const getGPTContent = (gptData) => gptData.choices[0].message.content;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Screenshots" id="screenshots-module">const createFileName = () => {
    const date = new Date();
    return `screenshot_${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
};

const dataURLToBlob = (dataURL) => {
    const byteString = atob(dataURL.split(',')[1]);
    const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i &lt; byteString.length; i += 1) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeString });
};

const uploadAsset = async (dataURL, fileName) => {
    const formData = new FormData();
    const blob = dataURLToBlob(dataURL);
    formData.append('file', blob, fileName);

    const request = new XMLHttpRequest();
    request.open('POST', window.location.pathname);
    request.send(formData);

    return new Promise((resolve, reject) => {
        request.addEventListener('load', () => {
            const asset = JSON.parse(request.responseText);
            resolve(asset);
        });
        request.addEventListener('error', () => {
            reject(new Error('Failed to upload screenshot'));
        });
    });
};

const captureScreenshot = async () => {
    const canvas = document.querySelector('body transient canvas[data-engine]');
    if (!canvas) {
        console.warn('Screenshot failed: No canvas found');
        return;
    }

    const dataURL = canvas.toDataURL('image/png');
    const asset = await uploadAsset(dataURL, createFileName() + '.png');

    CustomJSTrigger.trigger('imageUploaded', { fileName: asset.fileName });
};
window.captureScreenshot = captureScreenshot;



exports.captureScreenshot = captureScreenshot;
</CODE-FRAGMENT><CODE-FOLDER name="Streams"><CODE-FRAGMENT data-type="text/javascript" id="stream-manager-module" name="Stream Manager">let clicked = false;
document.addEventListener('click', () => { clicked = true; });
const doIfClicked = (callback) => {
    if (clicked) {
        setTimeout(() => {
            callback();
        }, 200);
    } else {
        document.addEventListener('click', () => {
            callback();
        });
    }
};



const DEBUG = false;



/**
 * A generic stream sharing class for Webstrate servers with stream signalling support.
 */
class StreamShare {
    /**
     * Creates a streamshare using the given element to signal
     * addition and removal of streams. Up to one stream per client
     * is possible for each element.
     */
    constructor(element) {
        let self = this;
        this.clientStreams = new Map();
        this.addedListeners = [];
        if (!element) throw new Error('Must provide an actual DOM element for signalling, was ', element);
        if (element.parentElement === undefined) throw new Error('StreamShare element must be in DOM');
        this.supported = true;
        if (!(element.webstrate && element.webstrate.signalStream)) {
            this.supported = false;
            if (DEBUG) console.log('StreamShare: The webstrate implementation or element does not support webstrate stream signalling, stream sharing is disabled', element);
            return;
        }
        this.element = element;

        this.element.webstrate.on('signalStream', function onSignalStream(clientId, meta, accept) {
            let con = accept(function (stream) {
                if (self.clientStreams.get(clientId)) {
                    if (DEBUG) console.log('StreamShare: Warning: Only one stream per client is supported per element but ' + clientId + ' shared another one...');
                }
                self.clientStreams.set(clientId, stream);
                self._onStreamAdded(clientId, stream);
            });
        });
    }

    stopSharing() {
        if (this.currentSignallingFunction) {
            this.element.webstrate.stopStreamSignal(this.currentSignallingFunction);
            this.currentSignallingFunction = null;
        }
        if (this.currentStream) {
            this.currentStream.getTracks().forEach(track => track.stop());
            this.currentStream = null;
        }
    }

    async shareStream(media, displayOptions = null) {
        let self = this;
        if (!this.supported) {
            console.log('Tried to share a stream on an unsupported StreamShare, see previous warnings');
            return;
        }

        // Get the stream
        if (!displayOptions) {
            console.error('displayOptions are required to share a stream.');
        }

        if (this.currentStream) {
            this.stopSharing();
        }
        if (media == 'displayMedia') {
            this.currentStream = await navigator.mediaDevices.getDisplayMedia(displayOptions);
        } else {
            this.currentStream = await navigator.mediaDevices.getUserMedia(displayOptions);
        }
        this.currentSignallingFunction = function signalStream(clientId, accept) {
            let con = accept(self.currentStream, {}, () => {
                if (DEBUG) console.log('StreamShare: client ' + clientId + ' started receiving our streamshare');
            });
            con.onclose(() => {
                if (DEBUG) console.log('StreamShare: client ' + clientId + ' stopped receiving our streamshare');
            });
        };

        // Register the stream on the element
        if (DEBUG) console.log('StreamShare: Starting streamshare');
        this._onStreamAdded(webstrate.clientId, this.currentStream);
        this.element.webstrate.signalStream(this.currentSignallingFunction);
        return this.currentStream;
    }

    _onStreamAdded(client, stream) {
        // Notify listeners
        this.clientStreams.set(client, stream);
        this.addedListeners.forEach(listener => {
            listener(client, stream);
        });
    }
    addStreamAddedListener(listener) {
        this.addedListeners.push(listener);

        // Backfill with current streams
        for (let [key, value] of this.clientStreams) {
            listener(key, value);
        }
    }
    removeStreamAddedListener(listener) {
        const index = this.addedListeners.indexOf(listener);
        if (index > -1) {
            this.addedListeners.splice(index, 1);
        }
    }
}



const cleanupConceptTypes = [];
const cleanup = async () => {
    // Remove screenshares when a client leaves or joins
    for (const conceptType in cleanupConceptTypes) {
        if (webstrate.clients.length &lt; 1) return;
        let concept = VarvEngine.getConceptFromType(conceptType);
        let shares = await (VarvEngine.lookupInstances(conceptType));
        shares.filter(share => !webstrate.clients.includes(concept.getPropertyValue(share, 'client'))).forEach(share => { concept.delete(share); });
    }
};
webstrate.on('clientPart', cleanup);
webstrate.on('clientJoin', cleanup);



exports.doIfClicked = doIfClicked;
exports.StreamShare = StreamShare;
exports.cleanupConceptTypes = cleanupConceptTypes;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Screen Streams" id="screen-streams-module">const { doIfClicked, StreamShare, cleanupConceptTypes } = modules.streamManager;



const DOM_ELEMENT = document.querySelector('#screen-streams-module');
const CONCEPT_NAME = 'ScreenStream';
const ID_PREFIX = CONCEPT_NAME + '-';
const QUERY_PREFIX = '#' + ID_PREFIX;



// Hook up new streams with a video element
cleanupConceptTypes.push(CONCEPT_NAME);
const streamShare = new StreamShare(DOM_ELEMENT);
streamShare.addStreamAddedListener((client, stream) => {
    console.log('Got screenStream from ' + client);

    // Find or create their element
    let element = document.querySelector(QUERY_PREFIX + client);
    if (!element) {
        element = document.createElement('video');
        element.style.position = 'fixed';
        element.style.width = '0px';
        element.id = ID_PREFIX + client;
        element.muted = true;
        document.body.appendChild(element);
    }
    element.srcObject = stream;
    doIfClicked(() => { element.play(); });
});

// Convenience functions for managing Varv spawning and despawning
window.stopSharingMyScreen = async () => {
    streamShare.stopSharing();
    const concept = VarvEngine.getConceptFromType(CONCEPT_NAME);
    const instances = await VarvEngine.lookupInstances(CONCEPT_NAME, new FilterProperty('client', FilterOps.equals, webstrate.clientId));
    instances.forEach(instance => concept.delete(instance));
};
window.shareMyScreen = async () => {
    const stream = await streamShare.shareStream('displayMedia', {
        video: {
            displaySurface: 'browser',
        },
        audio: {
            suppressLocalAudioPlayback: false,
        },
        preferCurrentTab: false,
        selfBrowserSurface: 'exclude',
        systemAudio: 'exclude',
        surfaceSwitching: 'include',
        monitorTypeSurfaces: 'include',
    });
    if (stream) {
        stream.getVideoTracks()[0].addEventListener('ended', () => {
            window.stopSharingMyScreen();
        });
        return VarvEngine.getConceptFromType(CONCEPT_NAME).create(null, { client: webstrate.clientId });
    }
};



exports.QUERY_PREFIX = QUERY_PREFIX;
exports.streamShare = streamShare;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Video Streams" id="video-streams-module">const { doIfClicked, StreamShare, cleanupConceptTypes } = modules.streamManager;



const DOM_ELEMENT = document.querySelector('#video-streams-module');
const CONCEPT_NAME = 'VideoStream';
const ID_PREFIX = CONCEPT_NAME + '-';
const QUERY_PREFIX = '#' + ID_PREFIX;



// Hook up new streams with a video element
cleanupConceptTypes.push(CONCEPT_NAME);
const streamShare = new StreamShare(DOM_ELEMENT);
streamShare.addStreamAddedListener((client, stream) => {
    console.log('Got videoStream from ' + client);

    // Find or create their element
    let element = document.querySelector(QUERY_PREFIX + client);
    if (!element) {
        element = document.createElement('video');
        element.style.position = 'fixed';
        element.style.width = '0px';
        element.id = ID_PREFIX + client;
        element.muted = true;
        document.body.appendChild(element);
    }
    element.srcObject = stream;
    doIfClicked(() => { element.play(); });
});

// Convenience functions for managing Varv spawning and despawning
window.stopSharingMyVideo = async () => {
    streamShare.stopSharing();
    const concept = VarvEngine.getConceptFromType(CONCEPT_NAME);
    const instances = await VarvEngine.lookupInstances(CONCEPT_NAME, new FilterProperty('client', FilterOps.equals, webstrate.clientId));
    instances.forEach(instance => concept.delete(instance));
};
window.shareMyVideo = async () => {
    const instances = await VarvEngine.lookupInstances(CONCEPT_NAME, new FilterProperty('client', FilterOps.equals, webstrate.clientId));
    if (instances.length > 0) {
        console.log('Already sharing video');
        return;
    }
    const stream = await streamShare.shareStream('userMedia', {
        video: true,
        audio: false
    });
    if (stream) {
        stream.getVideoTracks()[0].addEventListener('ended', () => {
            window.stopSharingMyVideo();
        });
        return VarvEngine.getConceptFromType(CONCEPT_NAME).create(null, { client: webstrate.clientId });
    }
};



exports.QUERY_PREFIX = QUERY_PREFIX;
exports.streamShare = streamShare;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Audio Streams" id="audio-streams-module">const { doIfClicked, StreamShare, cleanupConceptTypes } = modules.streamManager;



const DOM_ELEMENT = document.querySelector('#audio-streams-module');
const CONCEPT_NAME = 'AudioStream';
const ID_PREFIX = CONCEPT_NAME + '-';
const QUERY_PREFIX = '#' + ID_PREFIX;



// Hook up new streams with a video element
cleanupConceptTypes.push(CONCEPT_NAME);
const streamShare = new StreamShare(DOM_ELEMENT);
streamShare.addStreamAddedListener((client, stream) => {
    console.log('Got audioStream from ' + client);

    // Find or create their element
    let element = document.querySelector(QUERY_PREFIX + client);
    if (!element) {
        element = document.createElement('video');
        element.style.position = 'fixed';
        element.style.width = '0px';
        element.id = ID_PREFIX + client;
        element.muted = client == webstrate.clientId;
        document.body.appendChild(element);
    }
    element.srcObject = stream;
    doIfClicked(() => { element.play(); });
});

// Convenience functions for managing Varv spawning and despawning
window.stopSharingMyAudio = async () => {
    streamShare.stopSharing();
    const concept = VarvEngine.getConceptFromType(CONCEPT_NAME);
    const instances = await VarvEngine.lookupInstances(CONCEPT_NAME, new FilterProperty('client', FilterOps.equals, webstrate.clientId));
    instances.forEach(instance => concept.delete(instance));
};
window.shareMyAudio = async () => {
    const instances = await VarvEngine.lookupInstances(CONCEPT_NAME, new FilterProperty('client', FilterOps.equals, webstrate.clientId));
    if (instances.length > 0) {
        console.log('Already sharing audio');
        return;
    }
    const stream = await streamShare.shareStream('userMedia', {
        video: false,
        audio: true
    });
    if (stream) {
        stream.getAudioTracks()[0].addEventListener('ended', () => {
            window.stopSharingMyAudio();
        });
        return VarvEngine.getConceptFromType(CONCEPT_NAME).create(null, { client: webstrate.clientId });
    }
};



exports.QUERY_PREFIX = QUERY_PREFIX;
exports.streamShare = streamShare;
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Vis-Components and Vis-Snippets"><CODE-FRAGMENT data-type="text/javascript" name="Vis-Component Manager" id="vis-component-manager-module">const VEGA_LITE_SPEC_COMPONENT_TYPE = 'spec';
const DATASET_COMPONENT_TYPE = 'dataset';
const D3_SPEC_COMPONENT_TYPE = 'd3Spec';
const UNKNOWN_COMPONENT_TYPE = 'unknown';

const COMPONENT_CONTAINER_SELECTOR = '#vis-component-container';
const VEGA_LITE_SPEC_CONTAINER_SELECTOR = '#vega-lite-spec-container';
const DATASET_CONTAINER_SELECTOR = '#dataset-container';
const D3_SPEC_CONTAINER_SELECTOR = '#d3-spec-container';

const visComponentContainer = document.querySelector(COMPONENT_CONTAINER_SELECTOR);
const vegaLiteSpecContainer = document.querySelector(VEGA_LITE_SPEC_CONTAINER_SELECTOR);
const datasetContainer = document.querySelector(DATASET_CONTAINER_SELECTOR);
const d3SpecContainer = document.querySelector(D3_SPEC_CONTAINER_SELECTOR);



class VisComponent {
    constructor(fragmentElement) {
        if (!!fragmentElement.closest(VEGA_LITE_SPEC_CONTAINER_SELECTOR)) {
            this.type = VEGA_LITE_SPEC_COMPONENT_TYPE;
        } else if (!!fragmentElement.closest(DATASET_CONTAINER_SELECTOR)) {
            this.type = DATASET_COMPONENT_TYPE;
        } else if (!!fragmentElement.closest(D3_SPEC_CONTAINER_SELECTOR)) {
            this.type = D3_SPEC_COMPONENT_TYPE;
        } else {
            this.type = UNKNOWN_COMPONENT_TYPE;
        }
        this.fragmentElement = fragmentElement;
        this.fragment = Fragment.one(this.fragmentElement)
        this.id = this.fragmentElement.id;
        this.uuid = this.fragmentElement.getAttribute('transient-fragment-uuid');

        this.contentChangedListener = [];
        this.idChangedListener = [];

        this.fragmentChangedCallback = () => {
            this._contentChanged();
        };
        this.fragment.registerOnFragmentChangedHandler(this.fragmentChangedCallback);

        this.observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
                    this.id = this.fragmentElement.id;
                    this._idChanged();
                }
            }
        });

        this.observer.observe(this.fragmentElement, { attributes: true });
    }
    disconnect() {
        this.fragment.unRegisterOnFragmentChangedHandler(this.fragmentChangedCallback);
        this.observer.disconnect();
    }
    remove() {
        this.fragmentElement.remove();
    }

    getContentRaw() {
        return this.fragment.raw;
    }
    getContentAsJSON() {
        if (this.type === DATASET_COMPONENT_TYPE || this.type === VEGA_LITE_SPEC_COMPONENT_TYPE) {
            try {
                return JSON.parse(this.getContentRaw());
            } catch (e) {
                console.warn(`getContentAsJSON -> Failed to parse content as JSON: ${e.message}`);
                return this.type === DATASET_COMPONENT_TYPE ? [] : {};
            }
        } else {
            return null;
        }
    }

    _contentChanged() {
        this.contentChangedListener.forEach(listener => {
            listener(this);
        });
    }
    addContentChangedListener(listener) {
        this.contentChangedListener.push(listener);
    }
    removeContentChangedListener(listener) {
        const index = this.contentChangedListener.indexOf(listener);
        if (index > -1) {
            this.contentChangedListener.splice(index, 1);
        }
    }

    _idChanged() {
        this.idChangedListener.forEach(listener => {
            listener(this.id);
        });
    }
    addIdChangedListener(listener) {
        this.idChangedListener.push(listener);
    }
    removeIdChangedListener(listener) {
        const index = this.idChangedListener.indexOf(listener);
        if (index > -1) {
            this.idChangedListener.splice(index, 1);
        }
    }
}

class VisComponentManager {
    constructor() {
        this.visComponents = new Map();
        this.addedListeners = [];
        this.removedListeners = [];
    }

    addVisComponent(fragmentElement) {
        const visComponent = new VisComponent(fragmentElement);
        this.visComponents.set(visComponent.uuid, visComponent);
        this._visComponentAdded(visComponent);
        return visComponent;
    }
    removeVisComponent(fragmentElement) {
        const visComponent = this.visComponents.get(fragmentElement.getAttribute('transient-fragment-uuid'));
        visComponent.disconnect();
        this.visComponents.delete(visComponent.uuid);
        this._visComponentRemoved(visComponent);
    }

    getVisComponent(uuid) {
        return this.visComponents.get(uuid);
    }
    getVisComponentById(id) {
        for (const visComponent of this.visComponents.values()) {
            if (visComponent.id === id) {
                return visComponent;
            }
        }
        return null;
    }
    getVisComponents() {
        return Array.from(this.visComponents.values());
    }
    getVegaLiteSpecComponents() {
        return this.getVisComponents().filter(fragment => fragment.type === VEGA_LITE_SPEC_COMPONENT_TYPE);
    }
    getDatasetComponents() {
        return this.getVisComponents().filter(fragment => fragment.type === DATASET_COMPONENT_TYPE);
    }
    getD3SpecComponents() {
        return this.getVisComponents().filter(fragment => fragment.type === D3_SPEC_COMPONENT_TYPE);
    }

    _visComponentAdded(visComponent) {
        this.addedListeners.forEach(listener => {
            listener(visComponent);
        });
    }
    addVisComponentAddedListener(listener) {
        this.addedListeners.push(listener);
    }
    removeVisComponentAddedListener(listener) {
        const index = this.addedListeners.indexOf(listener);
        if (index > -1) {
            this.addedListeners.splice(index, 1);
        }
    }

    _visComponentRemoved(visComponent) {
        this.removedListeners.forEach(listener => {
            listener(visComponent);
        });
    }
    addVisComponentRemovedListener(listener) {
        this.removedListeners.push(listener);
    }
    removeVisComponentRemovedListener(listener) {
        const index = this.removedListeners.indexOf(listener);
        if (index > -1) {
            this.removedListeners.splice(index, 1);
        }
    }
}



const visComponentManager = new VisComponentManager();
cQuery(visComponentContainer).liveQuery('code-fragment', {
    'added': (fragmentElement) => {
        visComponentManager.addVisComponent(fragmentElement);
    },
    'removed': (fragmentElement) => {
        visComponentManager.removeVisComponent(fragmentElement);
    }
});

const createId = () => {
    const date = new Date();
    return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}`;
};
const createFragmentElement = (type, content = '', id = createId()) => {
    const dataType = type === D3_SPEC_COMPONENT_TYPE ? 'text/javascript' : 'application/json';
    const fragment = Fragment.create(dataType);
    fragment.raw = content;
    fragment.html[0].id = id;
    WPMv2.stripProtection(fragment.html[0]);

    return fragment.html[0];
};
const createVegaLiteSpecVisComponent = (content, id) => {
    const fragmentElement = createFragmentElement(VEGA_LITE_SPEC_COMPONENT_TYPE, content, id);
    vegaLiteSpecContainer.appendChild(fragmentElement);
    const visComponent = visComponentManager.addVisComponent(fragmentElement);
    return visComponent;
};
const createDatasetVisComponent = (content, id) => {
    const fragmentElement = createFragmentElement(DATASET_COMPONENT_TYPE, content, id);
    datasetContainer.appendChild(fragmentElement);
    const visComponent = visComponentManager.addVisComponent(fragmentElement);
    return visComponent;
};
const createD3SpecVisComponent = (content, id) => {
    const fragmentElement = createFragmentElement(D3_SPEC_COMPONENT_TYPE, content, id);
    d3SpecContainer.appendChild(fragmentElement);
    const visComponent = visComponentManager.addVisComponent(fragmentElement);
    return visComponent;
};



exports.VEGA_LITE_SPEC_COMPONENT_TYPE = VEGA_LITE_SPEC_COMPONENT_TYPE;
exports.DATASET_COMPONENT_TYPE = DATASET_COMPONENT_TYPE;
exports.D3_SPEC_COMPONENT_TYPE = D3_SPEC_COMPONENT_TYPE;

exports.COMPONENT_CONTAINER_SELECTOR = COMPONENT_CONTAINER_SELECTOR;
exports.VEGA_LITE_SPEC_CONTAINER_SELECTOR = VEGA_LITE_SPEC_CONTAINER_SELECTOR;
exports.DATASET_CONTAINER_SELECTOR = DATASET_CONTAINER_SELECTOR;
exports.D3_SPEC_CONTAINER_SELECTOR = D3_SPEC_CONTAINER_SELECTOR;

exports.VisComponent = VisComponent;

exports.createVegaLiteSpecVisComponent = createVegaLiteSpecVisComponent;
exports.createDatasetVisComponent = createDatasetVisComponent;
exports.createD3SpecVisComponent = createD3SpecVisComponent;

exports.getVisComponent = visComponentManager.getVisComponent.bind(visComponentManager);
exports.getVisComponentById = visComponentManager.getVisComponentById.bind(visComponentManager);

exports.getVisComponents = visComponentManager.getVisComponents.bind(visComponentManager);
exports.getVegaLiteSpecComponents = visComponentManager.getVegaLiteSpecComponents.bind(visComponentManager);
exports.getDatasetComponents = visComponentManager.getDatasetComponents.bind(visComponentManager);
exports.getD3SpecComponents = visComponentManager.getD3SpecComponents.bind(visComponentManager);

exports.addVisComponentAddedListener = visComponentManager.addVisComponentAddedListener.bind(visComponentManager);
exports.removeVisComponentAddedListener = visComponentManager.removeVisComponentAddedListener.bind(visComponentManager);
exports.addVisComponentRemovedListener = visComponentManager.addVisComponentRemovedListener.bind(visComponentManager);
exports.removeVisComponentRemovedListener = visComponentManager.removeVisComponentRemovedListener.bind(visComponentManager);

exports._manager = visComponentManager;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Decomposer and Merger" id="decomposer-merger-module">const {
    VEGA_LITE_SPEC_COMPONENT_TYPE,
    DATASET_COMPONENT_TYPE,
    D3_SPEC_COMPONENT_TYPE
} = modules.visComponentManager;



const decomposeComponent = (component) => {
    if (component.type === DATASET_COMPONENT_TYPE) {
        return decomposeDataset(component.getContentAsJSON());
    } else if (component.type === VEGA_LITE_SPEC_COMPONENT_TYPE) {
        return decomposeSpec(component.getContentAsJSON());
    } else {
        return [];
    }
};

const decomposeDataset = (dataset) => {
    const datasetDecomposition = [];

    const dataPoint = dataset[0];
    for (const field in dataPoint) {
        datasetDecomposition.push({
            type: 'encodingXField',
            content: JSON.stringify({ encoding: { x: { field: field } } })
        });
        datasetDecomposition.push({
            type: 'encodingYField',
            content: JSON.stringify({ encoding: { y: { field: field } } })
        });
        datasetDecomposition.push({
            type: 'encodingZField',
            content: JSON.stringify({ encoding: { z: { field: field } } })
        });
    }

    return datasetDecomposition;
};

const decomposeSpec = (spec) => {
    const specDecomposition = [];

    for (const key in spec) {
        switch (key) {
            case 'mark':
                // Only add non-primitive marks
                if (typeof spec.mark != 'string') {
                    specDecomposition.push({
                        type: 'mark',
                        content: JSON.stringify({ mark: spec.mark })
                    });
                }
                break;
            case 'encoding':
                for (const encodingKey in spec.encoding) {
                    specDecomposition.push({
                        type: `encoding${encodingKey.charAt(0).toUpperCase()}${encodingKey.slice(1)}Field`,
                        content: JSON.stringify({ encoding: { [encodingKey]: { field: spec.encoding[encodingKey].field } } })
                    });
                }
                break;
            case 'transform':
                for (let i = 0; i &lt; spec.transform.length; i++) {
                    const transform = spec.transform[i];
                    for (const transformKey in transform) {
                        switch (transformKey) {
                            case 'filter':
                                specDecomposition.push({
                                    type: 'transformFilter',
                                    content: JSON.stringify(transform)
                                });
                                break;
                            // Add more transform types in the future ...
                            default:
                                // Ignore everything else (calculate, bin, aggregate, ...)
                                break;
                        }
                    }
                }
                break;
            default:
                // Ignore everything else ($schema, width, height, description, data, background, ...)
                break;
        }
    }

    return specDecomposition;
};

const mergeSpec = (componentsAndSnippets) => {
    let spec = {};

    for (let i = 0; i &lt; componentsAndSnippets.length; i++) {
        const componentOrSnippet = componentsAndSnippets[i];
        if (componentOrSnippet.type === VEGA_LITE_SPEC_COMPONENT_TYPE) {
            Object.assign(spec, componentOrSnippet.getContentAsJSON());
        } else if (componentOrSnippet.type == DATASET_COMPONENT_TYPE) {
            spec.data = { values: componentOrSnippet.getContentAsJSON() };
        } else if (componentOrSnippet.type == D3_SPEC_COMPONENT_TYPE) {
            // Ignore
        } else {
            mergeSnippetIntoSpec(spec, { type: componentOrSnippet.type, content: componentOrSnippet.content });
        }
    }

    return spec;
};

const mergeSnippetIntoSpec = (spec, decomposite) => {
    const parsedContent = JSON.parse(decomposite.content);
    if (decomposite.type === 'mark') {
        spec.mark = parsedContent.mark;
    } else if (decomposite.type.startsWith('encoding')) {
        const encodingKey = Object.keys(parsedContent.encoding)[0];
        if (!spec.encoding) {
            spec.encoding = {};
        }
        if (!spec.encoding[encodingKey]) {
            spec.encoding[encodingKey] = {};
        }
        Object.assign(spec.encoding[encodingKey], parsedContent.encoding[encodingKey]);
    } else if (decomposite.type.startsWith('transform')) {
        if (!spec.transform) {
            spec.transform = [];
        }
        spec.transform.push(parsedContent);
    } else {
        console.warn(`mergeSnippetIntoSpec -> Unknown decomposite type: ${decomposite.type}`, spec, decomposite);
    }

    return spec;
};

const findD3Dataset = (componentsAndSnippets) => {
    let dataset = [];

    for (let i = 0; i &lt; componentsAndSnippets.length; i++) {
        const componentOrSnippet = componentsAndSnippets[i];
        if (componentOrSnippet.type === DATASET_COMPONENT_TYPE) {
            dataset = componentOrSnippet.getContentAsJSON();
        }
    }

    return dataset;
};

const findD3Spec = (componentsAndSnippets) => {
    for (let i = 0; i &lt; componentsAndSnippets.length; i++) {
        const componentOrSnippet = componentsAndSnippets[i];
        if (componentOrSnippet.type === D3_SPEC_COMPONENT_TYPE) {
            return componentOrSnippet;
        }
    }
    return null;
};



exports.decomposeComponent = decomposeComponent;
exports.decomposeDataset = decomposeDataset;
exports.decomposeSpec = decomposeSpec;

exports.mergeSpec = mergeSpec;
exports.findD3Dataset = findD3Dataset;
exports.findD3Spec = findD3Spec;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Vis-Snippet Manager" id="vis-snippet-module">const {
    VEGA_LITE_SPEC_COMPONENT_TYPE,
    DATASET_COMPONENT_TYPE,
    getVisComponents,
    getVisComponentById,
    addVisComponentAddedListener,
    addVisComponentRemovedListener,
    createVegaLiteSpecVisComponent
} = modules.visComponentManager;
const {
    decomposeComponent,
    mergeSpec
} = modules.decomposerMerger;



const DEFAULT_MARKS = 'default_marks';
const DEFAULT_ENCODING_TYPES = 'default_encoding_types';

const createStringHash = (string) => {
    return crypto.subtle.digest('SHA-1', new TextEncoder().encode(string)).then(hashBuffer => {
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    });
}



class VisSnippet {
    constructor(parent, type, content) {
        this.uuid = crypto.randomUUID();
        this.parent = parent;
        this.content = content;
        this.type = type;

        createStringHash(content).then(hash => { this.hash = hash; });
    }
}

class VisSnippetManager {
    constructor() {
        this.visComponents = new Map();
        this.visSnippets = new Map();
        this.addedListeners = [];
        this.removedListeners = [];

        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'bar' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'circle' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'square' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'tick' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'line' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'area' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'point' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'rule' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'geoshape' }) });
        this.addVisSnippet(DEFAULT_MARKS, { type: 'mark', content: JSON.stringify({ mark: 'text' }) });

        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingXType', content: JSON.stringify({ encoding: { x: { type: 'quantitative' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingXType', content: JSON.stringify({ encoding: { x: { type: 'ordinal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingXType', content: JSON.stringify({ encoding: { x: { type: 'nominal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingXType', content: JSON.stringify({ encoding: { x: { type: 'temporal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { y: { type: 'quantitative' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { y: { type: 'ordinal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { y: { type: 'nominal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { y: { type: 'temporal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { z: { type: 'quantitative' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { z: { type: 'ordinal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { z: { type: 'nominal' } } }) });
        this.addVisSnippet(DEFAULT_ENCODING_TYPES, { type: 'encodingYType', content: JSON.stringify({ encoding: { z: { type: 'temporal' } } }) });

        // Add more default snippets in the future ...
    }



    addVisSnippet(parent, componentComposite) {
        const visSnippet = new VisSnippet(parent, componentComposite.type, componentComposite.content);
        this.visSnippets.set(visSnippet.uuid, visSnippet);
        this._visSnippetAdded(visSnippet);
        return visSnippet;
    }

    addVisSnippetsFromComponent(visComponent) {
        if (visComponent.type != VEGA_LITE_SPEC_COMPONENT_TYPE && visComponent.type != DATASET_COMPONENT_TYPE) {
            return [];
        } else if (this.visComponents.has(visComponent.uuid)) {
            return this.updateVisSnippetsFromComponent(visComponent);
        } else {
            this.visComponents.set(visComponent.uuid, visComponent);
            visComponent.addContentChangedListener(() => { this.updateVisSnippetsFromComponent(visComponent); });
            return this.generateVisSnippetsFromComponent(visComponent);
        }
    }

    updateVisSnippetsFromComponent(visComponent) {
        this.removeVisSnippetsFromComponent(visComponent);
        return this.generateVisSnippetsFromComponent(visComponent);
    }

    generateVisSnippetsFromComponent(visComponent) {
        const visSnippets = [];
        const componentDecomposition = decomposeComponent(visComponent);
        for (const componentComposite of componentDecomposition) {
            const visSnippet = this.addVisSnippet(visComponent.uuid, componentComposite);
            visSnippets.push(visSnippet);
        }
        return visSnippets;
    }

    removeVisSnippetsFromComponent(visComponent) {
        this.visComponents.delete(visComponent.uuid);
        const visSnippets = this.getVisSnippetsFromComponent(visComponent);
        for (const visSnippet of visSnippets) {
            this.removeVisSnippet(visSnippet);
        }
    }
    removeVisSnippet(visSnippet) {
        this._visSnippetRemoved(visSnippet);
        this.visSnippets.delete(visSnippet.uuid);
    }



    getVisSnippet(uuid) {
        return this.visSnippets.get(uuid);
    }

    getVisSnippets() {
        return Array.from(this.visSnippets.values());
    }

    getUniqueVisSnippets() {
        const uniqueSnippets = new Map();
        for (const snippet of this.getVisSnippets()) {
            uniqueSnippets.set(snippet.hash, snippet);
        }
        return Array.from(uniqueSnippets.values());
    }

    getVisSnippetsFromComponent(visComponent) {
        return this.getVisSnippets().filter(snippet => snippet.parent === visComponent.uuid);
    }

    getVisSnippetsFromParent(parent) {
        return this.getVisSnippets().filter(snippet => snippet.parent === parent);
    }



    _visSnippetAdded(visSnippet) {
        this.addedListeners.forEach(listener => {
            listener(visSnippet);
        });
    }
    addVisSnippetAddedListener(listener) {
        this.addedListeners.push(listener);
    }
    removeVisSnippetAddedListener(listener) {
        const index = this.addedListeners.indexOf(listener);
        if (index > -1) {
            this.addedListeners.splice(index, 1);
        }
    }



    _visSnippetRemoved(visSnippet) {
        this.removedListeners.forEach(listener => {
            listener(visSnippet);
        });
    }

    addVisSnippetRemovedListener(listener) {
        this.removedListeners.push(listener);
    }

    removeVisSnippetRemovedListener(listener) {
        const index = this.removedListeners.indexOf(listener);
        if (index > -1) {
            this.removedListeners.splice(index, 1);
        }
    }
}



const visSnippetManager = new VisSnippetManager();
const visComponents = getVisComponents();
for (const visComponent of visComponents) {
    visSnippetManager.addVisSnippetsFromComponent(visComponent);
}
addVisComponentAddedListener(visComponent => { visSnippetManager.addVisSnippetsFromComponent(visComponent); });
addVisComponentRemovedListener(visComponent => { visSnippetManager.removeVisSnippetsFromComponent(visComponent); });



const generateSpecName = () => {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    return `merged_${year}-${month}-${day}_${hour}-${minute}`;
};

const mergeComponentsInScene = (contexts, actionArguments) => {
    const sortedContexts = contexts.sort((a, b) => a.variables.positionY - b.variables.positionY);
    const components = sortedContexts.map(context => {
        if (context.variables.type === 'spec') {
            return getVisComponentById(context.variables.fragmentId);
        } else if (context.variables.type === 'specSnippet') {
            return new VisSnippet('temp', context.variables.snippetType, context.variables.content);
        } else {
            return null;
        }
    });

    const newSpec = mergeSpec(components);
    const component = createVegaLiteSpecVisComponent(JSON.stringify(newSpec, null, 4), generateSpecName());
    const newContexts = [contexts[0]];
    newContexts[0].variables.newFragmentId = component.id;

    return newContexts;
};
window.mergeComponentsInScene = mergeComponentsInScene;



exports.VisSnippet = VisSnippet;
exports.defaultVisSnippetTypes = [DEFAULT_MARKS, DEFAULT_ENCODING_TYPES];

exports.getVisSnippet = visSnippetManager.getVisSnippet.bind(visSnippetManager);
exports.getVisSnippets = visSnippetManager.getVisSnippets.bind(visSnippetManager);
exports.getUniqueVisSnippets = visSnippetManager.getUniqueVisSnippets.bind(visSnippetManager);
exports.getVisSnippetsFromComponent = visSnippetManager.getVisSnippetsFromComponent.bind(visSnippetManager);
exports.getVisSnippetsFromParent = visSnippetManager.getVisSnippetsFromParent.bind(visSnippetManager);

exports.addVisSnippetAddedListener = visSnippetManager.addVisSnippetAddedListener.bind(visSnippetManager);
exports.removeVisSnippetAddedListener = visSnippetManager.removeVisSnippetAddedListener.bind(visSnippetManager);
exports.addVisSnippetRemovedListener = visSnippetManager.addVisSnippetRemovedListener.bind(visSnippetManager);
exports.removeVisSnippetRemovedListener = visSnippetManager.removeVisSnippetRemovedListener.bind(visSnippetManager);

exports._manager = visSnippetManager;
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript" name="Uploader" id="uploader-module">const {
    createVegaLiteSpecVisComponent,
    createDatasetVisComponent,
    createD3SpecVisComponent,
    VEGA_LITE_SPEC_COMPONENT_TYPE,
    DATASET_COMPONENT_TYPE,
    D3_SPEC_COMPONENT_TYPE
} = modules.visComponentManager;



const SPLIT_SPEC_AND_DATASET = true;



const hasEmbeddedDataset = (content) => {
    const spec = JSON.parse(content);
    return spec.data && spec.data.values && Array.isArray(spec.data.values);
};

const splitSpecAndDataset = (content) => {
    if (!hasEmbeddedDataset(content)) {
        return {
            spec: content,
            dataset: undefined
        };
    }

    const spec = JSON.parse(content);
    const dataset = spec.data;
    spec.data = undefined;

    return {
        spec: JSON.stringify(spec, null, 4),
        dataset: JSON.stringify(dataset, null, 4)
    };
};

const convertCSVtoJSON = (csv) => {
    const lines = csv.split('\n');
    const result = [];
    const headers = lines[0].split(',');
    for (let i = 1; i &lt; lines.length; i++) {
        const obj = {};
        const currentline = lines[i].split(',');
        for (let j = 0; j &lt; headers.length; j++) {
            const value = currentline[j];
            obj[headers[j]] = isNaN(value) ? value : parseFloat(value);
        }
        result.push(obj);
    }
    return JSON.stringify(result, null, 4);
};

const convertFileName = (fileName) => {
    return fileName.split('.').slice(0, -1).join('.').replace(/\s+/g, '_');
};

const handleUploadImage = (file) => {
    const formData = new FormData();
    formData.append('file', file, file.name);

    const request = new XMLHttpRequest();
    request.open('POST', window.location.pathname);
    request.send(formData);

    return new Promise((resolve, reject) => {
        request.addEventListener('load', () => {
            const asset = JSON.parse(request.responseText);
            CustomJSTrigger.trigger('imageUploaded', { fileName: asset.fileName });
            resolve(asset);
        });
        request.addEventListener('error', (e) => {
            reject(new Error('Failed to upload image'));
        });
    });
};



const handleUploadFile = (file, type) => {
    const reader = new FileReader();
    if (file.type === 'application/json') {
        reader.onload = (e) => {
            const content = e.target.result;
            const id = convertFileName(file.name);
            if (type === VEGA_LITE_SPEC_COMPONENT_TYPE) {
                if (SPLIT_SPEC_AND_DATASET && hasEmbeddedDataset(content)) {
                    const { spec, dataset } = splitSpecAndDataset(content);
                    createVegaLiteSpecVisComponent(spec, id + '_spec');
                    createDatasetVisComponent(dataset, id + '_dataset');
                } else {
                    createVegaLiteSpecVisComponent(content, id);
                }
            } else if (type === DATASET_COMPONENT_TYPE) {
                createDatasetVisComponent(content, id);
            } else if (type === D3_SPEC_COMPONENT_TYPE) {
                alert('D3 specs need to be of type text/javascript.')
            }
        };
        reader.readAsText(file);
    } else if (file.type === 'text/csv') {
        reader.onload = (e) => {
            const content = e.target.result;
            const id = convertFileName(file.name);
            const dataset = convertCSVtoJSON(content);
            createDatasetVisComponent(dataset, id);
        };
        reader.readAsText(file);
    } else if (file.type === 'text/javascript') {
        reader.onload = (e) => {
            const content = e.target.result;
            const id = convertFileName(file.name);
            if (type === VEGA_LITE_SPEC_COMPONENT_TYPE) {
                alert('Vega-Lite specs need to be of type application/json.')
            } else if (type === DATASET_COMPONENT_TYPE) {
                alert('Datasets need to be of type application/json or text/csv.')
            } else if (type === D3_SPEC_COMPONENT_TYPE) {
                createD3SpecVisComponent(content, id);
            }
        };
        reader.readAsText(file);
    } else if (file.type === 'image/jpeg' || file.type === 'image/png') {
        handleUploadImage(file);
    } else {
        alert('File type not supported.');
    }
};



const activateDropZone = (element, type) => {
    element.addEventListener('dragover', (e) => {
        e.preventDefault();
        element.classList.add('upload-drop-zone--over');
    });

    element.addEventListener('dragleave', () => {
        element.classList.remove('upload-drop-zone--over');
    });

    element.addEventListener('drop', (e) => {
        e.preventDefault();
        element.classList.remove('upload-drop-zone--over');
        const files = e.dataTransfer.files;
        for (let i = 0; i &lt; files.length; i++) {
            const file = files[i];
            handleUploadFile(file, type);
        }
    });

    element.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = 'multiple';
        input.accept = type === VEGA_LITE_SPEC_COMPONENT_TYPE ? 'application/json' : type === DATASET_COMPONENT_TYPE ? 'application/json, text/csv' : type === D3_SPEC_COMPONENT_TYPE ? 'text/javascript' : 'image/jpeg, image/png';
        input.onchange = (e) => {
            for (let i = 0; i &lt; e.target.files.length; i++) {
                handleUploadFile(e.target.files[i], type);
            }
        };
        input.click();
    });
};



cQuery(document.body).liveQuery('.upload-drop-zone', {
    'added': (element) => {
        if (element.id === 'vega-lite-spec-upload-drop-zone') {
            activateDropZone(element, VEGA_LITE_SPEC_COMPONENT_TYPE);
        } else if (element.id === 'dataset-upload-drop-zone') {
            activateDropZone(element, DATASET_COMPONENT_TYPE);
        } else if (element.id === 'd3-spec-upload-drop-zone') {
            activateDropZone(element, D3_SPEC_COMPONENT_TYPE);
        } else if (element.id === 'image-upload-drop-zone') {
            activateDropZone(element, 'image');
        }
    }
});
</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER><CODE-FOLDER id="components" name="React Components"><CODE-FRAGMENT data-type="text/javascript+babel" id name="App">import React from 'react';

import { Canvas, useFrame } from '@react-three/fiber';
import { XR, Controllers, Hands, useXR } from '@react-three/xr';
import { Stats, Environment, Stage } from '@react-three/drei';
import { BackSide } from 'three';

import { Varv } from '#VarvReact';
import { preloadMeshes } from '#components [name="MeshCache"]';
preloadMeshes();

import { Login } from '#components [name="Login"]';
import { GUIOverlay } from '#components [name="GUIOverlay"]';
import { CustomCamera } from '#components [name="Camera"]';
import { ControllerMenu } from '#components [name="ControllerMenu"]';
import { CalibrationPoint } from '#components [name="CalibrationPoint"]';

import { StickyNote } from '#elements [name="StickyNote"]';
import { CustomImage } from '#elements [name="Image"]';

import { VisComponent } from '#elements [name="VisComponent"]';
import { Visualization } from '#elements [name="Visualization"]';
import { VisShelf, Trashcan } from '#elements [name="VisShelf"]';

import { UserDevices } from '#elements [name="UserDevices"]';

import { ScreenStream } from '#elements [name="ScreenStream"]';
import { AudioStream } from '#elements [name="AudioStream"]';



const urlParams = new URLSearchParams(window.location.search);
const LOCAL_REFERENCE_SPACE = urlParams.get('lrs') === 'true';



function VarvScene() {
    return &lt;>
        &lt;Varv concept="MovableManager">
            &lt;Varv concept="StickyNote">&lt;StickyNote />&lt;/Varv>
            &lt;Varv concept="Image">&lt;CustomImage />&lt;/Varv>

            &lt;Varv concept="Visualization">&lt;Visualization />&lt;/Varv>
            &lt;Varv concept="VisComponent" if="!presentationMode">&lt;VisComponent />&lt;/Varv>
            &lt;Varv concept="VisShelf" if="!presentationMode">&lt;VisShelf />&lt;/Varv>
            &lt;Varv concept="Trashcan" if="!presentationMode">&lt;Trashcan />&lt;/Varv>

            &lt;Varv concept="ScreenStream">&lt;ScreenStream />&lt;/Varv>
            &lt;Varv concept="AudioStream">&lt;AudioStream />&lt;/Varv>
        &lt;/Varv>
        &lt;UserDevices />
    &lt;/>;
}

function View3D() {
    const {
        controllers,
        isPresenting,
        isHandTracking,
    } = useXR();

    // Positional hooks
    useFrame((state) => {
        VarvInteractionDeviceStates['camera'] = state.camera;
        controllers.forEach((controller) => {
            if (controller.inputSource && controller.inputSource.handedness) {
                if (controller.inputSource.handedness === 'left') {
                    VarvInteractionDeviceStates['controllerLeft'] = isHandTracking ? controller.hand.children[0] : controller.grip;
                } else {
                    VarvInteractionDeviceStates['controllerRight'] = isHandTracking ? controller.hand.children[0] : controller.grip;
                }
            }
        });
    });

    // Render the scene
    return &lt;>
        {isPresenting ? // Use a slightly different setup in VR as opposed to normal browser
            &lt;>{/** XR **/}
                &lt;CalibrationPoint />
                &lt;Controllers />
                &lt;Hands />
                &lt;Varv concept="MovableManager">
                    &lt;ControllerMenu />
                &lt;/Varv>
                &lt;Environment preset="city" />
                &lt;VarvScene />
            &lt;/>
            :
            &lt;>{/** Normal Browser **/}
                &lt;gridHelper />
                &lt;CustomCamera />
                &lt;Stats />
                &lt;color attach="background" args={[0xE5E4E2]} />
                &lt;mesh scale={200}>
                    &lt;sphereGeometry />
                    &lt;meshStandardMaterial color="#E5E4E2" side={BackSide} transparent={true} opacity={0.4} />
                &lt;/mesh>
                &lt;Stage preset="soft" adjustCamera={false} environment="city" intensity={0.5} center={{ disable: true }}>
                    &lt;VarvScene />
                &lt;/Stage>
            &lt;/>
        }
    &lt;/>;
}



export function App() {
    return &lt;>
        &lt;div className="crosshair">&lt;/div>
        &lt;Varv concept="UserManager" if="!loggedIn">&lt;Login />&lt;/Varv>
        &lt;GUIOverlay />
        &lt;Canvas dpr={2} gl={{ preserveDrawingBuffer: true }}>
            &lt;XR referenceSpace={LOCAL_REFERENCE_SPACE ? 'local' : 'local-floor'}>
                &lt;View3D />
            &lt;/XR>
        &lt;/Canvas>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="Login">import React from 'react';
import { Varv, useProperty, useAction } from '#VarvReact';



function UserRenamer() {
    let [name, setName] = useProperty('name');
    return &lt;label>
        Rename User
        &lt;input value={name ? name : ''} onChange={e => setName(e.target.value)} title='Rename User' />
    &lt;/label>;
}

function UserSelector() {
    let [name] = useProperty('name');
    let [local] = useProperty('local');
    let select = useAction('selectUser');
    return &lt;div className='user' local={local ? 'true' : null} onClick={select} title={'Select User ' + name}>{name}&lt;/div>
}

export function Login() {
    return &lt;div className="user-manager-modal" >
        &lt;div className="user-manager">
            &lt;div className="user-headline">User Selection&lt;/div>
            &lt;div className="user-menu">
                &lt;button view="addUserButton" title="Add User">Add User&lt;/button>
                &lt;button view="deleteUserButton" className="red" title="Delete User">Delete User&lt;/button>
                &lt;Varv property="localUser">
                    &lt;UserRenamer />
                &lt;/Varv>
            &lt;/div>
            &lt;div className="user-list">
                &lt;Varv concept="User">
                    &lt;UserSelector />
                &lt;/Varv>
            &lt;/div>
            &lt;button view="loginButton" className="login-button green" title="Enter">Enter DashSpace&lt;/button>
        &lt;/div>
    &lt;/div>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="GUIOverlay">import React from 'react';
import { toggleSession } from '@react-three/xr';
import { Varv, useProperty } from '#VarvReact';



function ComponentMenu() {
    const [multiSelect, setMultiSelect] = useProperty('multiSelect');
    const [presentationMode, setPresentationMode] = useProperty('presentationMode');

    return &lt;div className="floating-menu">
        &lt;div className="title">Menu&lt;/div>
        &lt;button onClick={() => CustomJSTrigger.trigger('createObject', { concept: 'VisShelf', device: 'camera'})}>New Bookshelf&lt;/button>
        &lt;button onClick={() => CustomJSTrigger.trigger('createObject', { concept: 'Trashcan', device: 'camera'})}>New Trashcan&lt;/button>
        &lt;button onClick={() => CustomJSTrigger.trigger('createObject', { concept: 'StickyNote', device: 'camera'})}>New Sticky Note&lt;/button>
        &lt;div className="spacer">&lt;/div>
        &lt;button onClick={() => CustomJSTrigger.trigger('mergeComponents', { device: 'camera' })}>Merge Components&lt;/button>
        &lt;button onClick={() => CustomJSTrigger.trigger('cloneMovable')}>Clone&lt;/button>
        &lt;button onClick={() => CustomJSTrigger.trigger('deleteMovable')} className="red">Delete&lt;/button>
        &lt;button onClick={() => {
            if (window.confirm('Are you sure you want to delete all objects?')) {
                CustomJSTrigger.trigger('deleteAllMovables');
            }
        }} className="red">Delete All Objects&lt;/button>
        &lt;div className="spacer">&lt;/div>
        &lt;button onClick={() => setPresentationMode(!presentationMode)} toggled={presentationMode ? 'true' : null}>Presentation Mode&lt;/button>
        &lt;button onClick={() => setMultiSelect(!multiSelect)} toggled={multiSelect ? 'true' : null}>Toggle Multi-Select&lt;/button>
        &lt;button onClick={() => CustomJSTrigger.trigger('unselectMovable')}>Deselect Objects&lt;/button>
        &lt;div className="spacer">&lt;/div>
        &lt;button onClick={window.captureScreenshot}>Capture Screenshot&lt;/button>
    &lt;/div>;
}

/**
 * A heads-up display with buttons
 */
export function GUIOverlay() {
    const toggleAR = async () => {
        if (!navigator?.xr) {
            alert('WebXR is not supported by your browser.');
            return;
        }

        const sessionMode = 'immersive-ar';
        if (!await navigator.xr.isSessionSupported(sessionMode)) {
            alert('AR sessions are not supported by your browser.');
            return;
        }

        const sessionInit = { sessionInit: {
            domOverlay: typeof document !== 'undefined' ? { root: document.body } : undefined,
            optionalFeatures: [
                'hit-test',
                'dom-overlay',
                'hand-tracking'
            ]
        }};

        toggleSession(sessionMode, sessionInit);
    };

    const toggleVR = async () => {
        if (!navigator?.xr) {
            alert('WebXR is not supported by your browser.');
            return;
        }

        const sessionMode = 'immersive-vr';
        if (!await navigator.xr.isSessionSupported(sessionMode)) {
            alert('VR sessions are not supported by your browser.');
            return;
        }

        const sessionInit = { sessionInit: {
            domOverlay: typeof document !== 'undefined' ? { root: document.body } : undefined,
            optionalFeatures: [
                'hit-test',
                'dom-overlay',
                'hand-tracking'
            ]
        }};

        toggleSession(sessionMode, sessionInit);
    };

    const shareLink = () => {
        let sendToQuestUrl = new URL('https://oculus.com/open_url/');
        sendToQuestUrl.searchParams.set('url', location.protocol + '//' + location.host + location.pathname + '?lrs=false&dud=true');
        window.open(sendToQuestUrl, '_blank');
    };

    return &lt;div className="floating-menus">
        &lt;Varv concept="MovableManager">
            &lt;ComponentMenu />
        &lt;/Varv>

        &lt;div className="floating-menu">
            &lt;div className="title">Upload Files&lt;/div>
            &lt;div className="upload-drop-zone" id="vega-lite-spec-upload-drop-zone">Upload Vega-Lite Spec&lt;/div>
            &lt;div className="upload-drop-zone" id="dataset-upload-drop-zone">Upload Dataset&lt;/div>
            &lt;div className="upload-drop-zone" id="d3-spec-upload-drop-zone">Upload D3 Spec&lt;/div>
            &lt;div className="spacer">&lt;/div>
            &lt;div className="upload-drop-zone" id="image-upload-drop-zone">Upload Image&lt;/div>
        &lt;/div>

        &lt;div className="floating-menu">
            &lt;div className="title">Media Sharing&lt;/div>
            &lt;button onClick={window.shareMyScreen}>Start Screenshare&lt;/button>
            &lt;button onClick={window.stopSharingMyScreen}>Stop Screenshare&lt;/button>
            &lt;div className="spacer">&lt;/div>
            &lt;button onClick={window.shareMyVideo}>Start Video&lt;/button>
            &lt;button onClick={window.stopSharingMyVideo}>Stop Video&lt;/button>
            &lt;div className="spacer">&lt;/div>
            &lt;button onClick={window.shareMyAudio}>Start Audio&lt;/button>
            &lt;button onClick={window.stopSharingMyAudio}>Stop Audio&lt;/button>
            &lt;div className="spacer">&lt;/div>
            &lt;button onClick={shareLink}>Send to Quest&lt;/button>
        &lt;/div>

        &lt;div className="floating-menu always-visible">
            &lt;button className="mouse-lock">Move Camera&lt;/button>
            &lt;div className="spacer">&lt;/div>
            &lt;button onClick={toggleAR}>Toggle AR&lt;/button>
            &lt;button onClick={toggleVR}>Toggle VR&lt;/button>
        &lt;/div>
    &lt;/div>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" id name="Camera">import React from 'react';
const { useRef, useEffect } = React;

import { useFrame } from '@react-three/fiber';
import { PointerLockControls } from '@react-three/drei';
import { Vector3 } from 'three';



const SPEED = 1.4;



export function CustomCamera() {
    const controls = useRef();
    const crosshair = useRef(document.querySelector('.crosshair'));
    const moveDirection = useRef(new Vector3());

    useEffect(() => {
        const handleKeyDown = (event) => {
            if (!controls.current.isLocked) return;
            switch (event.code) {
                case 'KeyW':
                    moveDirection.current.z = -1;
                    break;
                case 'KeyS':
                    moveDirection.current.z = 1;
                    break;
                case 'KeyA':
                    moveDirection.current.x = -1;
                    break;
                case 'KeyD':
                    moveDirection.current.x = 1;
                    break;
                case 'Space':
                    moveDirection.current.y = 1;
                    break;
                case 'ShiftLeft':
                    moveDirection.current.y = -1;
                    break;
                case 'KeyE':
                    CustomJSTrigger.trigger('unselectMovable');
                    break;
                default:
                    break;
            }
        };

        const handleKeyUp = (event) => {
            switch (event.code) {
                case 'KeyW':
                case 'KeyS':
                    moveDirection.current.z = 0;
                    break;
                case 'KeyA':
                case 'KeyD':
                    moveDirection.current.x = 0;
                    break;
                case 'Space':
                case 'ShiftLeft':
                    moveDirection.current.y = 0;
                    break;
                default:
                    break;
            }
        };

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        controls.current.camera.position.set(0, 1.5, 1);

        return () => {
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
        };
    }, []);

    useFrame((state, delta) => {
        if (moveDirection.current.x != 0 || moveDirection.current.y != 0 || moveDirection.current.z != 0) {
            const timeBasedSpeed = SPEED * delta;
            controls.current.getObject().translateX(moveDirection.current.x * timeBasedSpeed);
            controls.current.getObject().translateY(moveDirection.current.y * timeBasedSpeed * 0.5);
            controls.current.getObject().translateZ(moveDirection.current.z * timeBasedSpeed);
        }
        controls.current.getObject().updateMatrix();
        controls.current.getObject().updateMatrixWorld();
    });

    const handleOnLock = (e) => { crosshair.current.style.display = 'block'; };
    const handleOnUnlock = (e) => { crosshair.current.style.display = 'none'; };

    return &lt;PointerLockControls ref={controls} selector={'.mouse-lock'} onLock={handleOnLock} onUnlock={handleOnUnlock} />;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="ControllerMenu" id>import React from 'react';
let { useState, useEffect } = React;

import { createPortal } from '@react-three/fiber';
import { Interactive, useXR } from '@react-three/xr';
import { Text } from '@react-three/drei';

import { useProperty } from '#VarvReact';
import { Icon } from "#components [name='Icon']";



// Individual buttons in the menu
function ControllerMenuButton({ position, name, icon, theme = 'button', callback }) {
    const [hovered, setHovered] = useState();

    return &lt;group position={position} scale={hovered ? 1.1 : 1} autoUpdateMatrix={false}>
        &lt;Interactive onSelectEnd={callback} onHover={() => setHovered(true)} onBlur={() => setHovered(false)}>
            &lt;Icon theme={theme + (hovered ? ':hovered' : '')} model={icon} />
        &lt;/Interactive>
        &lt;Text
            position={[0, 0, 0.006]} autoUpdateMatrix={false}
            maxWidth={0.045}
            textAlign="center"
            anchorX="center"
            anchorY="middle"
            color="black"
            outlineWidth="5%"
            outlineColor="white"
            fontSize={0.007}>
            {name}
        &lt;/Text>
    &lt;/group>;
}

/**
 * A floating menu attached to your left controller or hand.
 */
export function ControllerMenu() {
    const [presentationMode, setPresentationMode] = useProperty('presentationMode');
    const [multiSelect, setMultiSelect] = useProperty('multiSelect');
    const [showMenu, setShowMenu] = useState(false);

    const {
        controllers,
        isHandTracking
    } = useXR()
    const [parent, setParent] = useState();

    useEffect(() => {
        const parentController = controllers.find((controller) => {
            if (!controller.inputSource) return false;
            return controller.inputSource.handedness === 'left';
        });
        if (isHandTracking) {
            setParent(parentController ? parentController.hand.children[0] : null);
        } else {
            setParent(parentController ? parentController.grip : null);
        }
    }, [controllers, isHandTracking]);

    const buttonIcon = dashSpaceMeshCache.load('button.glb');

    return &lt;>
        {parent ? createPortal(&lt;group position={isHandTracking ? [0, 0.02, -0.1] : [0, 0.05, -0.1]} rotation={isHandTracking ? [-Math.PI / 2, 0.2, 0.2] : [-Math.PI / 2, 0, 0]}>
            &lt;ControllerMenuButton icon={buttonIcon} position={[0, -0.06, 0]} name={'Show Menu'} callback={() => setShowMenu(!showMenu)} theme={showMenu ? 'button:toggled' : 'button'} />

            {showMenu ? &lt;>
                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.04, 0.12, 0]} name={'Merge Components'} callback={() => CustomJSTrigger.trigger('mergeComponents', { device: 'camera' })} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.04, 0.06, 0]} name={'Clone'} callback={() => CustomJSTrigger.trigger('cloneMovable')} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.04, 0, 0]} name={'Delete'} theme="deleteButton" callback={() => CustomJSTrigger.trigger('deleteMovable')} />

                &lt;ControllerMenuButton icon={buttonIcon} position={[0.12, 0.06, 0]} name={'Start Audio'} callback={window.shareMyAudio} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[0.12, 0, 0]} name={'Stop Audio'} callback={window.stopSharingMyAudio} />

                &lt;ControllerMenuButton icon={buttonIcon} position={[0.04, 0.12, 0]} name={'New Bookshelf'} callback={() => CustomJSTrigger.trigger('createObject', { concept: 'VisShelf', device: 'camera' })} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[0.04, 0.06, 0]} name={'New Trashcan'} callback={() => CustomJSTrigger.trigger('createObject', { concept: 'Trashcan', device: 'camera' })} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[0.04, 0, 0]} name={'New Sticky Note'} callback={() => CustomJSTrigger.trigger('createObject', { concept: 'StickyNote', device: 'camera' })} />

                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.12, 0.12, 0]} name={'Toggle Present Mode'} theme={presentationMode ? 'button:toggled' : null} callback={() => setPresentationMode(!presentationMode)} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.12, 0, 0]} name={'Deselect All'} callback={() => CustomJSTrigger.trigger('unselectMovable')} />
                &lt;ControllerMenuButton icon={buttonIcon} position={[-0.12, 0.06, 0]} name={'Toggle Multi-Select'} theme={multiSelect ? 'button:toggled' : null} callback={() => setMultiSelect(!multiSelect)} />
            &lt;/> : null}
        &lt;/group>, parent) : null}
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="Icon">import React from 'react';
import { Clone } from '@react-three/drei';

import { useProperty } from '#VarvReact';
import {
    SELECTED_COLOR_PRIMARY,
    SELECTED_COLOR_SECONDARY,
    HOVERED_SELECTED_COLOR_PRIMARY,
    HOVERED_SELECTED_COLOR_SECONDARY
} from '#elements [name="Movable"]';



export const themes = {
    '': { primary: 'rgb(255,0,255)', secondary: 'rgb(255,255,0)' },
    ':hovered': { primary: 'rgb(255,0,0)', secondary: 'rgb(255,0,0)' },
    ':selected': { primary: 'rgb(0,255,0)', secondary: 'rgb(255,0,0)' },
    ':selected:hovered': { primary: 'rgb(0,255,255)', secondary: 'rgb(255,0,0)' },

    'button': { primary: 'hsl(200, 18%, 50%)', secondary: 'hsl(198, 16%, 84%)' },
    'button:hovered': { primary: 'hsl(200, 18%, 60%)', secondary: 'hsl(198, 16%, 84%)' },
    'button:disabled': { primary: 'rgb(0,0,0)', secondary: 'rgb(0,0,0)' },
    'button:toggled': { primary: 'hsl(200, 18%, 50%)', secondary: 'hsl(47, 100%, 63%)' },
    'button:toggled:hovered': { primary: 'hsl(200, 18%, 60%)', secondary: 'hsl(47, 100%, 73%)' },

    'deleteButton': { primary: 'hsl(0, 73%, 40%)', secondary: 'hsl(4, 90%, 60%)' },
    'deleteButton:hovered': { primary: 'hsl(0, 73%, 50%)', secondary: 'hsl(4, 90%, 70%)' },

    'calibrationPoint': { primary: 'hsl(65, 100%, 40%)', secondary: 'hsl(200, 18%, 50%)' },
    'calibrationPoint:hovered': { primary: 'hsl(65, 100%, 60%)', secondary: 'hsl(200, 18%, 60%)' },

    'bookshelf': { primary: 'hsl(200, 18%, 50%)', secondary: 'hsl(198, 16%, 84%)' },
    'bookshelf:hovered': { primary: 'hsl(200, 18%, 80%)', secondary: 'hsl(198, 16%, 84%)' },
    'bookshelf:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'bookshelf:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },

    'trash': { primary: 'hsl(0, 0%, 20%)', secondary: 'hsl(0, 0%, 60%)' },
    'trash:hovered': { primary: 'hsl(0, 0%, 50%)', secondary: 'hsl(0, 0%, 70%)' },
    'trash:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'trash:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },

    'visualization': { primary: 'hsl(262, 52%, 50%)', secondary: 'hsl(291, 96%, 62%)' },
    'visualization:hovered': { primary: 'hsl(262, 52%, 80%)', secondary: 'hsl(291, 96%, 82%)' },
    'visualization:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'visualization:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },

    'vegaLite_2D': { primary: 'hsl(262, 52%, 50%)', secondary: 'hsl(291, 96%, 62%)' },
    'vegaLite_2D:hovered': { primary: 'hsl(262, 52%, 80%)', secondary: 'hsl(291, 96%, 82%)' },
    'vegaLite_25D': { primary: 'hsl(262, 52%, 50%)', secondary: 'hsl(291, 96%, 62%)' },
    'vegaLite_25D:hovered': { primary: 'hsl(262, 52%, 80%)', secondary: 'hsl(291, 96%, 82%)' },
    'optomancy': { primary: 'hsl(262, 52%, 50%)', secondary: 'hsl(291, 96%, 62%)' },
    'optomancy:hovered': { primary: 'hsl(262, 52%, 80%)', secondary: 'hsl(291, 96%, 82%)' },
    'd3': { primary: 'hsl(262, 52%, 50%)', secondary: 'hsl(291, 96%, 62%)' },
    'd3:hovered': { primary: 'hsl(262, 52%, 80%)', secondary: 'hsl(291, 96%, 82%)' },

    'spec': { primary: 'hsl(199, 100%, 50%)', secondary: 'hsl(198, 100%, 75%)', line: 'hsl(199, 100%, 50%)' },
    'spec:hovered': { primary: 'hsl(199, 100%, 80%)', secondary: 'hsl(198, 100%, 85%)' },
    'spec:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'spec:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },
    'd3Spec': { primary: 'hsl(174, 65%, 50%)', secondary: 'hsl(166, 100%, 70%)', line: 'hsl(174, 65%, 50%)' },
    'd3Spec:hovered': { primary: 'hsl(174, 65%, 80%)', secondary: 'hsl(166, 100%, 80%)' },
    'd3Spec:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'd3Spec:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },
    'dataset': { primary: 'hsl(88, 50%, 50%)', secondary: 'hsl(93, 100%, 50%)', line: 'hsl(88, 50%, 50%)' },
    'dataset:hovered': { primary: 'hsl(88, 50%, 80%)', secondary: 'hsl(93, 100%, 60%)' },
    'dataset:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'dataset:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY },
    'specSnippet': { primary: 'hsl(45, 100%, 50%)', secondary: 'hsl(60, 100%, 50%)', line: 'hsl(45, 100%, 50%)' },
    'specSnippet:hovered': { primary: 'hsl(45, 100%, 80%)', secondary: 'hsl(60, 100%, 60%)' },
    'specSnippet:selected': { primary: SELECTED_COLOR_PRIMARY, secondary: SELECTED_COLOR_SECONDARY },
    'specSnippet:selected:hovered': { primary: HOVERED_SELECTED_COLOR_PRIMARY, secondary: HOVERED_SELECTED_COLOR_SECONDARY }
};



/**
 * Sugar wrapper for icons used inside movables that are selectable and hoverable.
 */
export function HandleIcon({ model, theme = '' }) {
    const [selected] = useProperty('selected');
    const [hovered] = useProperty('hovered');
    return &lt;Icon theme={theme + (selected ? ':selected' : '') + (hovered ? ':hovered' : '')} model={model} />
}

export function Icon(props) {
    const { model, theme = '' } = props;
    if (model == null) return null;

    try {
        if (model.materials['Primary']) model.materials['Primary'].color.set(themes[theme].primary);
        if (model.materials['Secondary']) model.materials['Secondary'].color.set(themes[theme].secondary);
    } catch (ex) {
        console.log('Missing color for ' + theme);
    }

    return &lt;group {...props}>
        &lt;Clone object={model ? model.scene : null} deep={'materialsOnly'} />
    &lt;/group>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="CalibrationPoint" id>import React from 'react';
const { useRef } = React;

import { useFrame, useThree } from '@react-three/fiber';
import { Interactive, useXREvent } from '@react-three/xr';
import * as THREE from 'three';

import { Icon } from "#components [name='Icon']";



const urlParams = new URLSearchParams(window.location.search);
const LOCAL_REFERENCE_SPACE = urlParams.get('lrs') === 'true';



const questBrowser = window.navigator.userAgent.includes('OculusBrowser');

/**
 * Move the entire scene view based on a calibration marker or a cube that can be moved around.
 */
export function CalibrationPoint() {
    let offsetUpdate = false;
    const grabbingController = useRef();
    const previousTransform = React.useMemo(() => new THREE.Matrix4(), [])
    const dragRef = useRef();

    // If a new offset has been set, inform the XR manager
    useFrame((state) => {
        if (offsetUpdate) {
            const referenceSpace = state.gl.xr.getReferenceSpace()
            state.gl.xr.setReferenceSpace(referenceSpace.getOffsetReferenceSpace(offsetUpdate));
            offsetUpdate = false;
        }

        const controller = grabbingController.current;
        if (!controller) return;

        dragRef.current.applyMatrix4(previousTransform);
        dragRef.current.applyMatrix4(controller.matrixWorld);
        dragRef.current.rotation.reorder('YXZ');
        dragRef.current.rotation.x = 0;
        dragRef.current.rotation.z = 0;
        dragRef.current.updateMatrixWorld();
        previousTransform.copy(controller.matrixWorld).invert();
    });

    // When the reference has moved, store the offset and reset it back (but not in height)
    const calibrate = () => {
        if (!dragRef.current) return;
        dragRef.current.rotation.reorder('YXZ');
        dragRef.current.rotation.x = 0;
        dragRef.current.rotation.z = 0;
        offsetUpdate = new XRRigidTransform({
            x: dragRef.current.position.x,
            y: LOCAL_REFERENCE_SPACE ? dragRef.current.position.y : 0,
            z: dragRef.current.position.z
        }, dragRef.current.quaternion);
        dragRef.current.rotation.y = 0;
        dragRef.current.position.x = 0;
        if (LOCAL_REFERENCE_SPACE) dragRef.current.position.y = 0;
        dragRef.current.position.z = 0;
    };

    const calibrateIcon = dashSpaceMeshCache.load('calibration_point.glb');
    const { camera } = useThree();

    useXREvent('selectend', (e) => {
        if (e.target.controller === grabbingController.current) {
            grabbingController.current = undefined;
            calibrate();
        }
    });

    return &lt;>
        {questBrowser ?
            &lt;Interactive ref={dragRef} onSelectStart={(e) => {
                grabbingController.current = e.target.controller;
                previousTransform.copy(e.target.controller.matrixWorld).invert();
            }}>
                &lt;Icon theme="calibrationPoint" model={calibrateIcon} />
            &lt;/Interactive>
            :
            &lt;group ref={dragRef} onPointerDown={() => {
                grabbingController.current = camera;
                previousTransform.copy(camera.matrixWorld).invert();
            }}
                onPointerUp={() => {
                    if (camera === grabbingController.current) {
                        grabbingController.current = undefined;
                        calibrate();
                    }
                }}>
                &lt;Icon theme="calibrationPoint" model={calibrateIcon} />
            &lt;/group>
        }
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FOLDER name="Utils"><CODE-FRAGMENT data-type="text/javascript+babel" name="MeshCache">import { useGLTF } from '@react-three/drei';



const DEBUG = false;



// Cache all ressources on window since they take a lot of time to load
if (!window.dashSpaceMeshCache) {
    window.dashSpaceMeshCache = {
        preloaded: {},
        cache: {},
        load: function load(name) {
            if (this.cache[name]) return this.cache[name];
            let model = useGLTF(name);
            if (model) {
                this.cache[name] = model;
                return model;
            } else {
                console.log('Missing model ' + name);
            }
        }
    };
}

export function preloadMeshes() {
    webstrate.assets.filter((asset) => { return (!asset.deletedAt) && (asset.fileName.endsWith('.glb') || asset.fileName.endsWith('.gltf')) }).forEach((asset) => {
        let model = asset.fileName;
        if (!window.dashSpaceMeshCache.preloaded[model]) {
            if (DEBUG) console.log('Preloading model ' + model);
            useGLTF.preload(model);
            window.dashSpaceMeshCache.preloaded[model] = true;
            if (DEBUG) console.log('Done loading model ' + model);
        }
    });
}
</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER><CODE-FOLDER name="React Scene Elements" id="elements"><CODE-FRAGMENT data-type="text/javascript+babel" id name="Movable">import React from 'react';
const { useRef, useState, useEffect } = React;
import { useFrame } from '@react-three/fiber';
import { Interactive, useXREvent } from '@react-three/xr';
import * as THREE from 'three';
import { useProperty, useAction } from '#VarvReact';



const FAST_WRITEBACK_TIMEOUT = 33;
const SLOW_WRITEBACK_TIMEOUT = 500;

export const SELECTED_COLOR_PRIMARY = 'hsl(14, 100%, 50%)';
export const SELECTED_COLOR_SECONDARY = 'hsl(26, 100%, 60%)';
export const HOVERED_SELECTED_COLOR_PRIMARY = 'hsl(14, 100%, 65%)';
export const HOVERED_SELECTED_COLOR_SECONDARY = 'hsl(26, 100%, 75%)';



// Generic wrapper for Movable concept properties into ThreeJS transform properties
export function useTransform() {
    const [x, setX] = useProperty('positionX');
    const [y, setY] = useProperty('positionY');
    const [z, setZ] = useProperty('positionZ');

    const [rotX, setRotX] = useProperty('rotationX');
    const [rotY, setRotY] = useProperty('rotationY');
    const [rotZ, setRotZ] = useProperty('rotationZ');

    const [scale, setScale] = useProperty('scale');

    const transform = {
        get position() { return [x, y, z] },
        set position(pos) { setX(pos.x); setY(pos.y); setZ(pos.z) },
        get rotation() { return [rotX, rotY, rotZ] },
        set rotation(rot) { setRotX(rot.x); setRotY(rot.y); setRotZ(rot.z) },
        get scale() { return scale }
    }
    return transform;
}

/**
 * Make a group of children moveable with a handle that allows
 * selecting them and dragging them around.
 */
export function Movable({ children, transformRef, handle, upright = true }) {
    const transform = transformRef ? transformRef : useTransform(); // Optionally receive the transform from parent or create our own

    // Colour the handle based on selection/drag state
    const [beingDragged] = useProperty('beingDragged');
    const [hovered, setHovered] = useProperty('hovered');

    // Forward handle clicks and XR selection to Varv with the current uuid on it
    const [conceptUUID] = useProperty('concept::uuid');
    const selectMovable = (device, e) => {
        if (e) e.stopPropagation();
        if (conceptUUID) CustomJSTrigger.trigger('selectMovable', { uuid: conceptUUID });
        setTimeout(() => { CustomJSTrigger.trigger('dragStart', { device: device }); }, 0);
    };
    const deselectMovable = (e) => {
        if (e) e.stopPropagation();
        CustomJSTrigger.trigger('dragEnd');
    };
    const hoveredCallback = (e) => {
        if (e) e.stopPropagation();
        setHovered(true);
    };
    const blurCallback = () => {
        setHovered(false);
    };

    // Handle XR grabs
    const grabbingController = useRef();
    const dragRef = useRef();
    const dragIconRef = useRef();
    const previousTransform = React.useMemo(() => new THREE.Matrix4(), []);

    const [fastWritebackTimeout, setFastWritebackTimeout] = useState();
    const [slowWritebackTimeout, setSlowWritebackTimeout] = useState();
    const onMoved = useAction('onMoved');

    useFrame(() => {
        const controller = grabbingController.current;
        if (!controller) return;

        dragRef.current.applyMatrix4(previousTransform);
        dragRef.current.applyMatrix4(controller.matrixWorld);
        if (upright) {
            dragRef.current.rotation.reorder('YXZ');
            dragRef.current.rotation.x = 0;
            dragRef.current.rotation.z = 0;
        }
        dragRef.current.updateMatrixWorld();
        previousTransform.copy(controller.matrixWorld).invert();

        // Update the Varv state
        if (!fastWritebackTimeout) {
            transform.position = dragRef.current.position;
            setFastWritebackTimeout(setTimeout(() => {
                setFastWritebackTimeout(null);
            }, FAST_WRITEBACK_TIMEOUT));
        }
        if (!slowWritebackTimeout) {
            transform.rotation = dragRef.current.rotation;
            onMoved();
            setSlowWritebackTimeout(setTimeout(() => {
                setSlowWritebackTimeout(null);
            }, SLOW_WRITEBACK_TIMEOUT));
        }
    });

    // Update Three.js matrix manually when transform is done loading to save CPU
    useEffect(() => {
        if (dragIconRef.current) {
            dragIconRef.current.updateMatrix();
        }
        if (dragRef.current) {
            dragRef.current.updateMatrix();
            dragRef.current.updateMatrixWorld();
            dragRef.current.updateWorldMatrix(false, true);
        }
    }, [transform]);

    // Control dragged state from Varv
    const [draggingDevice] = useProperty('draggingDevice');
    useEffect(() => {
        if (dragRef && dragRef.current && beingDragged != undefined) {
            if (beingDragged) {
                grabbingController.current = VarvInteractionDeviceStates[draggingDevice];
                if (grabbingController.current) {
                    previousTransform.copy(grabbingController.current.matrixWorld).invert();
                }
            } else {
                grabbingController.current = undefined;
                transform.position = dragRef.current.position;
            }
        }
    }, [beingDragged]);

    // Always stop dragging when anything lets go
    function stopDrag() {
        if (grabbingController.current) deselectMovable();
    }
    useXREvent('selectend', stopDrag);
    useEffect(() => {
        document.body.addEventListener('pointerup', stopDrag);
        return () => {
            document.body.removeEventListener('pointerup', stopDrag);
        };
    }, []);

    return &lt;group ref={dragRef} {...transform} matrixAutoUpdate={false} matrixWorldAutoUpdate={false}>
        &lt;Interactive
            onSelectStart={() => selectMovable('controllerRight')}
            onHover={() => hoveredCallback()}
            onBlur={() => blurCallback()}>
            &lt;group
                onPointerDown={(e) => selectMovable('camera', e)}
                onPointerUp={(e) => deselectMovable(e)}
                onPointerOver={(e) => hoveredCallback(e)}
                onPointerOut={blurCallback}>
                {handle}
            &lt;/group>
        &lt;/Interactive>
        {children}
    &lt;/group>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="UserDevices" id>import React from 'react';
let { useState, useEffect } = React;
import { Varv, useProperty } from '#VarvReact';
import { Text, Cone, Gltf } from '@react-three/drei';
import { useXR, Interactive } from '@react-three/xr';
import { VideoStream } from '#elements [name="VideoStream"]';
import { useFrame, useThree } from '@react-three/fiber';



const urlParams = new URLSearchParams(window.location.search);
const DISABLED = urlParams.get('dud') === 'true';
// To disable the interval in the Varv concepts
window.checkUserDevicesDisabled = (contexts) => {
    if (DISABLED) {
        throw new StopError('User devices are disabled.');
    } else {
        return contexts;
    }
};



const cameraModel = &lt;Gltf src="model-camera.glb" scale={1} rotation={[0, Math.PI, 0]} />;
const phoneModel = &lt;Gltf src="model-phone.glb" scale={0.01} />;
const headsetModel = &lt;Gltf src="model-headset.glb" scale={0.9} rotation={[0, Math.PI, 0]} position={[0, 0.04, 0.11]} />;
const leftControllerModel = &lt;Gltf src="model-controller-left.glb" scale={1} rotation={[Math.PI / 4, 0, 0]} />;
const rightControllerModel = &lt;Gltf src="model-controller-right.glb" scale={1} rotation={[Math.PI / 4, 0, 0]} />;

const viewCone = &lt;Cone args={[0.1, 0.1, 32]} position={[0, 0, -0.05]} rotation={[Math.PI / 2, 0, 0]}>
    &lt;meshStandardMaterial color="skyblue" transparent={true} opacity={0.66} />
&lt;/Cone>;


// Remove other people's UserDevices when clients leave or join
const cleanup = async () => {
    if (webstrate.clients.length &lt; 1) return;
    const concept = VarvEngine.getConceptFromType('UserDevice');
    const devices = await (VarvEngine.lookupInstances('UserDevice'));
    for (let device of devices) {
        if (!webstrate.clients.includes(await (concept.getPropertyValue(device, 'client')))) {
            concept.delete(device);
        }
    }
};

/**
 * Ensure that our devices are available in Varv and marked as isMine so they broadcast
 * their location.
 */
const updateDevices = async () => {
    if (DISABLED) return;
    const concept = VarvEngine.getConceptFromType('UserDevice');

    for (let deviceName of ['camera', 'controllerLeft', 'controllerRight']) {
        if (!VarvInteractionDeviceStates[deviceName]) continue; // We don't have this device, skip

        // Check if one exists already because we are just reloading Varv locally
        const device = await (VarvEngine.lookupInstances(
            'UserDevice',
            new FilterAnd([
                new FilterProperty('client', FilterOps.equals, webstrate.clientId),
                new FilterProperty('type', FilterOps.equals, deviceName),
            ])
        ));

        if (device.length > 0) {
            // Found an existing one, re-use it
            concept.setPropertyValue(device[0], 'isMine', true);
        } else {
            // Need to create a new one
            concept.create(null, {
                type: deviceName,
                userAgent: window.navigator.userAgent,
                client: webstrate.clientId,
                isMine: true,
            });
        }
    }
};



/**
 * Render a single user headset, camera or controller device.
 */
function UserDevice() {
    const [type] = useProperty('type');
    const [userAgent] = useProperty('userAgent');
    const [position] = useProperty('position');
    const [rotation] = useProperty('rotation');
    const [user] = useProperty('user');

    const [systemType, setSystemType] = useState('');

    const isPresenting = useXR((state) => state.isPresenting);
    const [remoteControlled, setRemoteControlled] = useProperty('remoteControlled');
    const [remoteControllingClient, setRemoteControllingClient] = useProperty('remoteControllingClient');

    const [model, setModel] = useState(cameraModel);

    useEffect(() => {
        switch (type) {
            case 'camera':
                if (userAgent.includes('OculusBrowser')) {
                    setModel(&lt;> {headsetModel} {viewCone} &lt;/>);
                } else if (/(iPad|iPhone|iPod|Android)/i.test(userAgent)) {
                    setModel(&lt;> {phoneModel} {viewCone} &lt;/>);
                } else {
                    setModel(&lt;> {cameraModel} {viewCone} &lt;/>);
                }
                break;
            case 'controllerLeft':
                setModel(leftControllerModel);
                break;
            case 'controllerRight':
                setModel(rightControllerModel);
                break;
            default:
                setModel(cameraModel);
        }
    }, [type, userAgent]);

    useEffect(() => {
        if (!userAgent) return;

        if (userAgent.includes('OculusBrowser')) {
            setSystemType('oculus');
        } else if (/(iPad|iPhone|iPod|Android)/i.test(userAgent)) {
            setSystemType('mobile');
        } else {
            setSystemType('desktop');
        }
    }, [userAgent]);

    const remoteControlCallback = (newValue) => {
        setRemoteControlled(newValue);
        setRemoteControllingClient(newValue ? webstrate.clientId : '');
    };

    return &lt;group position={position} rotation={rotation}>
        {(isPresenting && (type == 'camera') && (systemType == 'desktop')) ? &lt;Interactive
            onSelectStart={() => remoteControlCallback(true)}
            onSelectMissed={() => remoteControlCallback(false)}>
            {model}
        &lt;/Interactive> : model}
        &lt;Varv property="clientVideoStream">
            &lt;VideoStream />
        &lt;/Varv>
        &lt;Text
            position={[0, 0.11, 0]}
            rotation={[0, Math.PI, 0]}
            textAlign="center"
            anchorX="center"
            anchorY="middle"
            color="black"
            outlineWidth="5%"
            outlineColor="white"
            fontSize={0.05}>
            {user}
        &lt;/Text>
    &lt;/group >;
}

function UserDeviceRemoteController() {
    const [remoteControlled] = useProperty('remoteControlled');
    const [position] = useProperty('position');
    const [rotation] = useProperty('rotation');

    const camera = useThree(state => state.camera);

    useFrame(() => {
        if (remoteControlled) {
            camera.position.set(position[0], position[1], position[2]);
            camera.rotation.set(rotation[0], rotation[1], rotation[2]);
        }
    });
}

/**
 * Show all currently connected userdevices as objects in the scene.
 */
export function UserDevices() {
    const isPresenting = useXR((state) => state.isPresenting);

    // Ensure that UserDevices are updated in the environement
    useEffect(() => {
        let reloadCallback = VarvEngine.registerEventCallback('engineReloaded', () => {
            setTimeout(() => { updateDevices(); }, 250)
        });
        webstrate.on('clientPart', cleanup);
        webstrate.on('clientJoin', cleanup);

        return () => {
            reloadCallback.delete()
            webstrate.off('clientPart', cleanup);
            webstrate.off('clientJoin', cleanup);
        };
    }, []);

    useEffect(() => {
        setTimeout(() => { updateDevices(); }, 3000);
    }, [isPresenting]);

    updateDevices();

    return &lt;>
        &lt;Varv concept="UserDevice" if="!isMine">
            &lt;UserDevice />
        &lt;/Varv>
        &lt;Varv concept="UserDevice" if="isMine">
            &lt;UserDeviceRemoteController />
        &lt;/Varv>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FOLDER name="Basic Elements"><CODE-FRAGMENT data-type="text/javascript+babel" name="StickyNote" id>import React from 'react';
const { useState, useMemo } = React;

import { useFrame } from '@react-three/fiber';
import { Interactive } from '@react-three/xr';
import { Text } from '@react-three/drei';
import { MeshStandardMaterial, Vector3 } from 'three';
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';

import { useProperty } from '#VarvReact';
import { transcribeAudio } from '#helpers';
import { Icon } from '#components [name="Icon"]';
import { Movable, SELECTED_COLOR_PRIMARY, HOVERED_SELECTED_COLOR_PRIMARY } from '#elements [name="Movable"]';



const frameGeometry = new RoundedBoxGeometry(0.15, 0.15, 0.005, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#FDD835', metalness: 0.2, roughness: 0.5 });
const frameMaterialHovered = new MeshStandardMaterial({ color: '#FFF176', metalness: 0.2, roughness: 0.5 });
const frameMaterialSelected = new MeshStandardMaterial({ color: SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });
const frameMaterialHoveredSelected = new MeshStandardMaterial({ color: HOVERED_SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });



/**
 * Render a movable post-it like note that updates its contents when clicked.
 */
export function StickyNote() {
    const [listening, setListening] = useState(false);
    const [micScale, setMicScale] = useState(new Vector3(0.5, 0.5, 0.5));
    const [text, setText] = useProperty('text');
    const [selected] = useProperty('selected');
    const [hovered] = useProperty('hovered');

    async function updateText() {
        if (listening) return;

        setListening(true);
        const newText = await transcribeAudio(5000, false, () => { setListening(false); });
        if (newText) setText(newText);
    }

    const handle = useMemo(() => &lt;mesh
        geometry={frameGeometry}
        material={selected ? (hovered ? frameMaterialHoveredSelected : frameMaterialSelected) : (hovered ? frameMaterialHovered : frameMaterial)}
        position={[0, 0.025, 0]}
        autoUpdateMatrix={false}
    />, [hovered, selected]);

    const micIcon = useMemo(() => dashSpaceMeshCache.load('microphone.glb'), []);

    useFrame((state, delta) => {
        const scaleSpeed = 3;
        const minScale = 0.4;
        const maxScale = 0.6;
        const targetScale = listening ? minScale + (maxScale - minScale) * (Math.sin(state.clock.elapsedTime * 5) * 0.5 + 0.5) : 0.5;
        const newScale = micScale.clone().lerp(new Vector3(targetScale, targetScale, targetScale), scaleSpeed * delta);
        setMicScale(newScale);
    });

    return &lt;Movable handle={handle} upright={false}>
        &lt;Text
            position={[0, 0.025, 0.003]} autoUpdateMatrix={false}
            maxWidth={0.13}
            textAlign='left'
            anchorX='center'
            anchorY='middle'
            color='black'
            outlineWidth='5%'
            outlineColor='white'
            fontSize={0.01}>
            {text}
        &lt;/Text>
        &lt;Interactive onSelectEnd={updateText}>
            &lt;Icon model={micIcon} rotation={[0, -Math.PI, 0]} scale={micScale} position={[0.1, 0.025, 0]} onClick={updateText} />
        &lt;/Interactive>
    &lt;/Movable>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" id name="Image">import React from 'react';
const { useRef, useState, useEffect, useMemo } = React;

import { Image } from '@react-three/drei';
import { MeshStandardMaterial } from 'three';
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';
import { ErrorBoundary } from 'react-error-boundary';

import { useProperty } from '#VarvReact';
import { Movable, SELECTED_COLOR_PRIMARY, HOVERED_SELECTED_COLOR_PRIMARY } from '#elements [name="Movable"]';



const MAX_SIZE = 0.4;

// Reuseable geometry for the image frame
const frameGeometry = new RoundedBoxGeometry(1, 1, 0.005, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#E0E0E0', metalness: 0.2, roughness: 0.5 });
const frameMaterialHovered = new MeshStandardMaterial({ color: '#FFFFFF', metalness: 0.2, roughness: 0.5 });
const frameMaterialSelected = new MeshStandardMaterial({ color: SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });
const frameMaterialHoveredSelected = new MeshStandardMaterial({ color: HOVERED_SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });



/**
 * Show a movable image with a nice border around it.
 */
export function CustomImage() {
    const boundaryRef = useRef();
    const imageRef = useRef();
    const [width, setWidth] = useState(1);
    const [height, setHeight] = useState(1);
    const [url] = useProperty('url');

    const [selected] = useProperty('selected');
    const [hovered] = useProperty('hovered');

    // Update the aspect ratio on changes
    useEffect(() => {
        if (boundaryRef.current) boundaryRef.current.resetErrorBoundary();
        if (imageRef.current) {
            const aspectRatio = imageRef.current.material.__r3f.memoizedProps.imageBounds[0] / imageRef.current.material.__r3f.memoizedProps.imageBounds[1] || 1;
            if (aspectRatio > 1) {
                setWidth(MAX_SIZE);
                setHeight(MAX_SIZE / aspectRatio);
            } else {
                setWidth(MAX_SIZE * aspectRatio);
                setHeight(MAX_SIZE);
            }
        }
    }, [url, imageRef]);

    const handle = useMemo(() => &lt;mesh
        geometry={frameGeometry}
        material={selected ? (hovered ? frameMaterialHoveredSelected : frameMaterialSelected) : (hovered ? frameMaterialHovered : frameMaterial)}
        scale={[width + 0.02, height + 0.02, 1]}
        position={[0, 0.125 - 0.025, -0.0026]}
        autoUpdateMatrix={false}>
    &lt;/mesh>, [width, height, selected, hovered]);

    return &lt;Movable handle={handle} upright={false}>
        &lt;ErrorBoundary ref={boundaryRef} fallback={null}>
            &lt;Image ref={imageRef} url={url} position={[0, 0.125 - 0.025, 0]} scale={[width, height, 1]} autoUpdateMatrix={false}>
                &lt;planeGeometry args={[1, 1]} />
            &lt;/Image>
        &lt;/ErrorBoundary>
    &lt;/Movable>;
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Visualizations"><CODE-FRAGMENT data-type="text/javascript+babel" id name="VisComponent">import React from 'react';
const { useState, useEffect, useMemo } = React;

import { useFrame } from '@react-three/fiber';
import { Interactive } from '@react-three/xr';
import { Text, RenderTexture, OrthographicCamera } from '@react-three/drei';
import { MeshStandardMaterial, Vector3 } from 'three';
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';

import { useProperty } from '#VarvReact';
import { transcribeAudio, sendGPTPrompt, getGPTContent } from '#helpers';
import { Movable } from '#elements [name="Movable"]';
import { HandleIcon, Icon } from "#components [name='Icon']";
const { getVisComponentById } = modules.visComponentManager;



const frameGeometry = new RoundedBoxGeometry(1, 1, 0.005, 1);
const frameMaterial = new MeshStandardMaterial({ color: 'hsl(200, 18%, 50%)', metalness: 0.5, roughness: 0.5 });



/**
 * A VisComponent corresponds to one of the building blocks used to feed
 * data into, or process data for, a Visualization.
 */
export function VisComponent() {
    const [type] = useProperty('type');
    const [fragmentId] = useProperty('fragmentId');
    const [content] = useProperty('content');

    const [title, setTitle] = useState();
    const [fullTitle, setFullTitle] = useState();
    const [contents, setContents] = useState();
    const [showContents, setShowContents] = useState(false);

    // Different icons based on type of fragment
    const icons = {
        'spec': dashSpaceMeshCache.load('components_specs.glb'),
        'dataset': dashSpaceMeshCache.load('components_dataset.glb'),
        'd3Spec': dashSpaceMeshCache.load('components_specs_d3.glb'),
        'specSnippet': dashSpaceMeshCache.load('components_snippets.glb')
    };
    const icon = icons[type] ? icons[type] : icons[0];

    const micIcon = useMemo(() => dashSpaceMeshCache.load('microphone.glb'), []);
    const [listening, setListening] = useState(false);
    const [micScale, setMicScale] = useState(new Vector3(0.5, 0.5, 0.5));

    useFrame((state, delta) => {
        const scaleSpeed = 3;
        const minScale = 0.4;
        const maxScale = 0.6;
        const targetScale = listening ? minScale + (maxScale - minScale) * (Math.sin(state.clock.elapsedTime * 5) * 0.5 + 0.5) : 0.5;
        const newScale = micScale.clone().lerp(new Vector3(targetScale, targetScale, targetScale), scaleSpeed * delta);
        setMicScale(newScale);
    });

    // Speech transcription
    const speechToSpec = async (e) => {
        if (e) e.stopPropagation();
        if (type != 'spec') return;

        setListening(true);
        const text = await transcribeAudio(5000, false, () => { setListening(false); });
        const visComponent = getVisComponentById(fragmentId);
        const spec = visComponent.getContentRaw();
        const gptData = await sendGPTPrompt({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: `You help users to change their Vega Lite specifications. You are always only responding with the final updated Vega Spec.` },
                { role: 'user', content: `My current Vega-Lite spec is this: ${spec}` },
                { role: 'user', content: text }
            ],
            temperature: 0.05,
            max_tokens: 1000,
            response_format: { 'type': 'json_object' }
        });
        visComponent.fragment.raw = getGPTContent(gptData);
    };

    useEffect(() => {
        let newTitle = type == 'specSnippet' ? content : fragmentId;
        setFullTitle(newTitle);
        if (newTitle) {
            newTitle = newTitle.length > 15 ? newTitle.slice(0, 15) + '...' : newTitle;
            setTitle(newTitle);
        } else {
            setTitle('');
        }
    }, [type, content, fragmentId]);

    const setTrimmedContents = (newContents) => {
        // trim to maximum of 18 lines and each line to a maximum of 40 characters
        const lines = newContents.split('\n');
        const trimmedLines = lines.slice(0, 21).map(line => line.slice(0, 40));
        setContents(trimmedLines.join('\n'));
    };

    const contentChangedCallback = (visComponent) => {
        setTrimmedContents(visComponent.getContentRaw());
    };

    useEffect(() => {
        if (type == 'spec' || type == 'dataset' || type == 'd3Spec') {
            const visComponent = getVisComponentById(fragmentId);
            if (visComponent) {
                setTrimmedContents(visComponent.getContentRaw());
                visComponent.addContentChangedListener(contentChangedCallback);
            } else {
                console.warn('Could not find visComponent with id ' + fragmentId);
                setContents(null);
            }
        }

        return () => {
            if (type == 'spec' || type == 'dataset' || type == 'd3Spec') {
                const visComponent = getVisComponentById(fragmentId);
                if (visComponent) {
                    visComponent.removeContentChangedListener(contentChangedCallback);
                }
            }
        };
    }, [fragmentId]);

    useEffect(() => {
        if (type == 'specSnippet') {
            setTrimmedContents(content);
        }
    }, [content]);
    const handle = &lt;HandleIcon theme={type} model={icon} />

    return &lt;Movable handle={handle}>
        &lt;Interactive onSelect={() => setShowContents(!showContents)}>
            &lt;Text position={[0, -0.08, 0]} autoUpdateMatrix={false}
                textAlign="center"
                anchorX="center"
                anchorY="middle"
                color="black"
                outlineWidth="5%"
                outlineColor="white"
                fontSize={0.03}
                onClick={() => setShowContents(!showContents)}>
                {showContents ? fullTitle : title}
            &lt;/Text>
        &lt;/Interactive>

        {type === 'spec' ? &lt;Interactive onSelectEnd={speechToSpec}>
            &lt;Icon model={micIcon} rotation={[0, -Math.PI, 0]} scale={micScale} position={[0.08, -0.00, 0]} onClick={speechToSpec} />
        &lt;/Interactive> : null}

        {showContents && type != 'specSnippet' ? &lt;>
            &lt;mesh geometry={frameGeometry}
                material={frameMaterial}
                scale={[0.3, 0.3, 1]}
                position={[0, 0.25, -0.0026]}
                autoUpdateMatrix={false}>
            &lt;/mesh>
            &lt;Text
                position={[-0.125, 0.135 + 0.25, 0]} autoUpdateMatrix={false}
                maxWidth={0.35}
                textAlign="left"
                anchorX="left"
                anchorY="top"
                color="white"
                font="font-mono.woff"
                fontSize={0.01}>
                {contents}
            &lt;/Text>
        &lt;/> : null}
    &lt;/Movable>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" id name="Visualization">import React from 'react';
const { useState, useEffect, useRef, useMemo } = React;

import { Line } from '@react-three/drei';

import { Varv, useProperty } from '#VarvReact';
import { Movable, useTransform } from '#elements [name="Movable"]';
import { VegaLite2DVisualization } from '#elements [name="VegaLite2DVisualization"]';
import { VegaLite25DVisualization } from '#elements [name="VegaLite25DVisualization"]';
import { OptomancyVisualization } from '#elements [name="OptomancyVisualization"]';
import { D3Visualization } from '#elements [name="D3Visualization"]';
import { HandleIcon, themes } from '#components [name="Icon"]';
const { getVisComponentById } = modules.visComponentManager;
const { VisSnippet } = modules.visSnippetManager;
const { mergeSpec, findD3Dataset, findD3Spec } = modules.decomposerMerger;



/**
 * Creates a line from the sourceTransform param to the transform of the currently selected Varv concept.
 */
function VisConnector({ sourceTransform }) {
    const [type] = useProperty('type');

    const color = useMemo(() => themes[type]?.line || 'black', [type]);

    const ourTransform = useTransform();
    const a = ourTransform.position;
    a[2] -= 0.01;
    const b = sourceTransform.position;
    b[1] -= 0.06;
    b[2] -= 0.01;

    return (a[0] != undefined && b[0] != undefined) ? &lt;Line points={[...a, ...b]} color={color} lineWidth={3} /> : null;
}

/**
 * Fetches data from the Varv properties and updates the VisComponent with the new data.
 */
function VisDataFetcher({ onChanged }) {
    const [type] = useProperty('type');
    const [uuid] = useProperty('concept::uuid');
    const [positionY] = useProperty('positionY');

    const [fragmentId] = useProperty('fragmentId');
    const [snippetType] = useProperty('snippetType');
    const [content] = useProperty('content');

    const storedVisComponent = useRef();

    const updateVisComponent = (visComponent) => {
        if (visComponent) {
            storedVisComponent.current = visComponent;
            onChanged(uuid, visComponent, positionY);
        } else {
            console.warn('Could not find visComponent with fragment id ' + fragmentId);
            onChanged(uuid, null);
        }
    };

    useEffect(() => {
        if (type == 'spec' || type == 'dataset' || type == 'd3Spec') {
            const visComponent = getVisComponentById(fragmentId);
            visComponent.addContentChangedListener(updateVisComponent);
            updateVisComponent(visComponent);
        }

        return () => {
            if (type == 'spec' || type == 'dataset' || type == 'd3Spec') {
                const visComponent = getVisComponentById(fragmentId);
                visComponent.removeContentChangedListener(updateVisComponent);
            }
        };
    }, [fragmentId]);

    useEffect(() => {
        if (type == 'specSnippet') {
            if (snippetType && content) {
                const visSnippet = new VisSnippet('temp', snippetType, content);
                storedVisComponent.current = visSnippet;
                onChanged(uuid, visSnippet, positionY);
            } else {
                console.warn('Snippet is missing a type or content', uuid);
                onChanged(uuid, null);
            }
        }
    }, [content]);

    useEffect(() => {
        if (storedVisComponent.current) {
            onChanged(uuid, storedVisComponent.current, positionY);
        }
    }, [positionY]);

    // Also send a notification if this component is removed
    useEffect(() => {
        return () => {
            onChanged(uuid, null);
        }
    }, []);
}



export function Visualization() {
    const [reloadTimer, setReloadTimer] = useState();
    const transform = useTransform();
    const [type] = useProperty('type');
    const [visComponentUUIDs] = useProperty('visComponents');

    const visComponentMap = useRef(new Map());

    const [mergedSpec, setMergedSpec] = useState();
    const [d3Spec, setD3Spec] = useState();
    const [d3Dataset, setD3Dataset] = useState();

    // Custom icons based on type
    const icons = {
        'default': dashSpaceMeshCache.load('visualizations_2d.glb'),
        'vegaLite_25D': dashSpaceMeshCache.load('visualizations_25d.glb'),
        'optomancy': dashSpaceMeshCache.load('visualizations_3d.glb'),
        'd3': dashSpaceMeshCache.load('visualizations_d3.glb')
    };
    const icon = icons[type] ? icons[type] : icons.default;

    const updateData = () => {
        clearTimeout(reloadTimer);

        setReloadTimer(setTimeout(() => {
            if (!Array.isArray(visComponentUUIDs)) {
                console.warn('visComponents is not an array', visComponentUUIDs);
                return;
            }

            const visComponentsArrayWithHeightInfo = [];

            for (let i = 0; i &lt; visComponentUUIDs.length; i++) {
                const mapEntry = visComponentMap.current.get(visComponentUUIDs[i]);
                if (mapEntry?.visComponent) {
                    visComponentsArrayWithHeightInfo.push(mapEntry);
                } else {
                    console.warn('Could not find visComponent with id ' + visComponentUUIDs[i]);
                }
            }

            visComponentsArrayWithHeightInfo.sort((a, b) => a.positionY - b.positionY);
            const visComponentsArray = visComponentsArrayWithHeightInfo.map((entry) => entry.visComponent);

            if (type == 'vegaLite_2D' || type == 'vegaLite_25D' || type == 'optomancy') {
                setMergedSpec(mergeSpec(visComponentsArray));
            } else if (type == 'd3') {
                setD3Spec(findD3Spec(visComponentsArray));
                setD3Dataset(findD3Dataset(visComponentsArray));
            } else {
                console.warn('Unknown visualization type', type);
            }
        }, 100));
    };

    const onChanged = (uuid, visComponent, positionY) => {
        if (visComponent) {
            visComponentMap.current.set(uuid, { visComponent: visComponent, positionY: positionY });
        } else {
            visComponentMap.current.delete(uuid);
        }
        updateData();
    };

    useEffect(() => {
        updateData();
    }, [type, visComponentUUIDs]);

    const [presentationMode] = useProperty('presentationMode');

    const handle = presentationMode ? null : &lt;HandleIcon theme="visualization" model={icon} />;
    const graph = useMemo(() => {
        return &lt;group name="visualization" position={[-0.25, 0.1, 0]} scale={0.5}>
            {type == 'vegaLite_2D' ? &lt;VegaLite2DVisualization mergedSpec={mergedSpec} /> : null}
            {type == 'vegaLite_25D' ? &lt;VegaLite25DVisualization mergedSpec={mergedSpec} /> : null}
            {type == 'optomancy' ? &lt;OptomancyVisualization mergedSpec={mergedSpec} /> : null}
            {type == 'd3' ? &lt;D3Visualization d3Spec={d3Spec} d3Dataset={d3Dataset} /> : null}
        &lt;/group>
    }, [mergedSpec, d3Dataset, type]);

    return &lt;>
        &lt;Varv property="visComponents">
            &lt;VisDataFetcher onChanged={onChanged} />
            {presentationMode ? null : &lt;VisConnector sourceTransform={transform} />}
        &lt;/Varv>
        &lt;Movable transformRef={transform} handle={handle}>
            {graph}
        &lt;/Movable>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="VegaLite2DVisualization">import React from 'react';
const { useState, useEffect, useRef, useCallback, useMemo } = React;

import { Plane } from '@react-three/drei';
import * as THREE from 'three';
const { MeshStandardMaterial } = THREE;
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';
import embed from 'vega-embed';



const VIS_SIZE = 200;

const frameGeometry = new RoundedBoxGeometry(1, 1, 0.01, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#E0E0E0', metalness: 0.2, roughness: 0.5 });



const createStringHash = (string) => {
    return crypto.subtle.digest('SHA-1', new TextEncoder().encode(string)).then(hashBuffer => {
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    });
}

export function VegaLite2DVisualization({ mergedSpec }) {
    const canvas = useRef(document.createElement('canvas'));
    const context = useRef(canvas.current.getContext('2d'));

    const [aspectRatio, setAspectRatio] = useState(1);
    const [textureHash, setTextureHash] = useState();

    const [specHash, setSpecHash] = useState('');

    const updateVisualization = useCallback((tempDiv) => {
        const tempCanvas = tempDiv.querySelector('canvas');

        canvas.current.width = tempCanvas.width;
        canvas.current.height = tempCanvas.height;

        context.current.fillStyle = 'white';
        context.current.fillRect(0, 0, canvas.current.width, canvas.current.height);
        context.current.drawImage(tempCanvas, 0, 0);

        setAspectRatio(canvas.current.width / canvas.current.height);
        setTextureHash(crypto.randomUUID());
    }, [canvas, context]);

    useEffect(() => {
        if (mergedSpec) {
            const newHash = createStringHash(JSON.stringify(mergedSpec));
            if (newHash !== specHash) {
                setSpecHash(newHash);

                mergedSpec.width = VIS_SIZE;
                mergedSpec.height = VIS_SIZE;

                const tempDiv = document.createElement('div');
                embed(tempDiv, mergedSpec, { renderer: 'canvas' }).then((result) => {
                    updateVisualization(tempDiv);
                    result.finalize();
                });
            }
        } else {
            context.current.fillStyle = 'white';
            context.current.fillRect(0, 0, canvas.current.width, canvas.current.height);
            setAspectRatio(1);
            setTextureHash(crypto.randomUUID());
        }
    }, [mergedSpec]);

    const texture = useMemo(() => &lt;canvasTexture attach="map" image={canvas.current} key={textureHash} />, [textureHash]);

    return &lt;>
        &lt;mesh geometry={frameGeometry} material={frameMaterial}
            scale={[0.5 + 0.02, (0.5 / aspectRatio) + 0.02, 1]} position={[0.5, (0.25 / aspectRatio), -0.0051]} autoUpdateMatrix={false} />
        &lt;Plane args={[0.5, 0.5 / aspectRatio]} position={[0.5, 0.25 / aspectRatio, 0]}>
            &lt;meshBasicMaterial toneMapped={false} color="white">
                {texture}
            &lt;/meshBasicMaterial>
        &lt;/Plane>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="VegaLite25DVisualization">import React from 'react';
const { useState, useEffect, useRef } = React;

import { useFrame } from '@react-three/fiber';
import { Sphere, Text } from '@react-three/drei';
import * as THREE from 'three';
const { MeshStandardMaterial, BoxGeometry } = THREE;
import { ConvexGeometry } from 'three/addons/geometries/ConvexGeometry.js';
import embed from 'vega-embed';



const DEBUG = false;

const VIS_SIZE = 200;
const SCALE = 1 / VIS_SIZE;
const DEPTH = 0.02
const VIS_OFFSET = 0.001;

const metalnessValue = 0.4;
const roughnessValue = 0.5;
const defaultGraphMaterial = new MeshStandardMaterial({ metalness: metalnessValue, roughness: roughnessValue });
const defaultGraphBoxGeometry = new BoxGeometry();



// Helpers to get the sizes right
const getItemX = (item) => {
    return item.hasOwnProperty('x2') ? Math.min(item.x, item.x2) * SCALE : item.x * SCALE;
};
const getItemY = (item) => {
    return item.hasOwnProperty('y2') ? Math.min(item.y, item.y2) * SCALE : item.y * SCALE;
};

const getItemSize = (item) => {
    return item.hasOwnProperty('size') ? (item.size / 18) * SCALE : 0.0025;
};
const getItemWidth = (item) => {
    return item.hasOwnProperty('width') ? item.width * SCALE : getItemWidthBounds(item);
};
const getItemHeight = (item) => {
    return item.hasOwnProperty('height') ? item.height * SCALE : getItemHeightBounds(item);
};

const getItemWidthBounds = (item) => {
    return item.hasOwnProperty('x2') ? Math.abs(item.x2 - item.x) * SCALE : 0.0025;
};
const getItemHeightBounds = (item) => {
    return item.hasOwnProperty('y2') ? Math.abs(item.y2 - item.y) * SCALE : 0.0025;
};

const getLineLength = (item, nextItem) => {
    if (!nextItem) nextItem = item;
    return (Math.sqrt(Math.pow(nextItem.x - item.x, 2) + Math.pow(nextItem.y - item.y, 2)) * SCALE);
};
const getLineHeight = (item, nextItem) => {
    if (!nextItem) nextItem = item;
    const lineLength = getLineLength(item, nextItem);
    const rotationAngle = Math.atan2(nextItem.y - item.y, nextItem.x - item.x);
    return lineLength * Math.sin(rotationAngle);
};
const getLineWidth = (item, nextItem) => {
    if (!nextItem) nextItem = item;
    const lineLength = getLineLength(item, nextItem);
    const rotationAngle = Math.atan2(nextItem.y - item.y, nextItem.x - item.x);
    return lineLength * Math.cos(rotationAngle);
};
const getLineRotation = (item, nextItem) => {
    if (!nextItem) nextItem = item;
    return [0, 0, -Math.atan2(nextItem.y - item.y, nextItem.x - item.x)];
};



// Used for area drawings in Vega Lite
function Trapezoid({ points, depth, color }) {
    const [geometry, setGeometry] = useState();

    useEffect(() => {
        const allPoints = [
            ...points,
            [points[0][0], points[0][1], points[0][2] - depth],
            [points[1][0], points[1][1], points[1][2] - depth],
            [points[2][0], points[2][1], points[2][2] - depth],
            [points[3][0], points[3][1], points[3][2] - depth]
        ].map(point => new THREE.Vector3(...point));

        try {
            const newGeometry = new ConvexGeometry(allPoints);
            setGeometry(newGeometry);
        } catch (e) {
            console.error('Error creating trapezoid geometry', e);
        }
    }, [points, depth]);

    return &lt;mesh geometry={geometry}>
        &lt;meshStandardMaterial metalness={metalnessValue} roughness={roughnessValue} color={color} />
    &lt;/mesh>;
}

const collectBoxes = (items, state) => {
    let boxes = [];

    if (!items) return boxes;

    items.forEach((item) => {
        switch (item.marktype) {
            case 'rect':
                item.items.forEach((innerItem) => {
                    boxes.push({
                        color: innerItem.fill ? innerItem.fill : 'black',
                        scale: [getItemWidth(innerItem), getItemHeight(innerItem), DEPTH + VIS_OFFSET],
                        position: [state.position[0] + getItemX(innerItem) + (getItemWidth(innerItem) * 0.5), 1 - (state.position[1] + getItemY(innerItem) + (getItemHeight(innerItem) * 0.5)), -VIS_OFFSET]
                    })
                });
                break;
            case 'line':
                item.items.forEach((innerItem, index) => {
                    boxes.push({
                        color: innerItem.stroke ? innerItem.stroke : 'black',
                        scale: [getLineLength(innerItem, item.items[index + 1]), innerItem.strokeWidth * SCALE, DEPTH + VIS_OFFSET],
                        position: [state.position[0] + getItemX(innerItem) + (getLineWidth(innerItem, item.items[index + 1]) * 0.5), 1 - (state.position[1] + getItemY(innerItem) + getLineHeight(innerItem, item.items[index + 1]) * 0.5), -VIS_OFFSET],
                        rotation: getLineRotation(innerItem, item.items[index + 1])
                    })
                });
                break;
            case 'rule':
                item.items.forEach((innerItem) => {
                    boxes.push({
                        color: innerItem.stroke ? innerItem.stroke : 'black',
                        scale: [getItemWidth(innerItem), getItemHeight(innerItem), DEPTH],
                        position: [state.position[0] + getItemX(innerItem) + (getItemWidthBounds(innerItem) * 0.5), 1 - (state.position[1] + getItemY(innerItem) + (getItemHeightBounds(innerItem) * 0.5)), -VIS_OFFSET]
                    });
                });
                break;
            default:
                let newState = structuredClone(state);
                if (item.x) newState.position[0] += getItemX(item);
                if (item.y) newState.position[1] += getItemY(item);
                let childBoxes = collectBoxes(item.items, newState);
                boxes = [...boxes, ...childBoxes];
        }
    });

    return boxes;
};

const generateNonInstanced = (items, key) => {
    const itemComponents = [];

    for (let i = 0; i &lt; items.length; i++) {
        const item = items[i];
        const itemKey = key + '.' + i;
        const marktype = item.marktype ? item.marktype : '';

        switch (marktype) {
            case '':
                let childComponents = [];
                let itemComponent;
                if (item.items) {
                    childComponents = generateNonInstanced(item.items, itemKey)
                }
                if (item.x && item.y) {
                    itemComponent = &lt;group key={itemKey} position={[getItemX(item), 0 - getItemY(item), 0]}>{childComponents}&lt;/group>
                } else if (item.x) {
                    itemComponent = &lt;group key={itemKey} position={[getItemX(item), 0, 0]}>{childComponents}&lt;/group>
                } else if (item.y) {
                    itemComponent = &lt;group key={itemKey} position={[0, 0 - getItemY(item), 0]}>{childComponents}&lt;/group>
                } else {
                    itemComponent = &lt;group key={itemKey}>{childComponents}&lt;/group>
                }
                if (childComponents.length > 0) {
                    itemComponents.push(itemComponent);
                }
                break;
            case 'arc':
                console.warn('Missing marktype:', marktype, item);
                break;
            case 'group':
                itemComponents.push(&lt;group key={itemKey}>{generateNonInstanced(item.items, itemKey)}&lt;/group>);
                break;
            case 'image':
                console.warn('Missing marktype:', marktype, item);
                break;
            case 'path':
                console.warn('Missing marktype:', marktype, item);
                break;
            case 'area':
                const areas = item.items.map((innerItem, index) =>
                    &lt;Trapezoid key={itemKey + '-' + index}
                        points={[
                            [
                                getItemX(innerItem),
                                1 - getItemY(innerItem) - getItemHeightBounds(innerItem),
                                VIS_OFFSET + (DEPTH / 2)
                            ],
                            [
                                getItemX(innerItem),
                                1 - getItemY(innerItem) + getItemHeight(innerItem) - getItemHeightBounds(innerItem),
                                VIS_OFFSET + (DEPTH / 2)
                            ],
                            [
                                getItemX(item.items[index + 1] || innerItem),
                                1 - getItemY(item.items[index + 1] || innerItem) + getItemHeight(item.items[index + 1] || innerItem) - getItemHeightBounds(item.items[index + 1] || innerItem),
                                VIS_OFFSET + (DEPTH / 2)
                            ],
                            [
                                getItemX(item.items[index + 1] || innerItem),
                                1 - getItemY(item.items[index + 1] || innerItem) - getItemHeightBounds(item.items[index + 1] || innerItem),
                                VIS_OFFSET + (DEPTH / 2)
                            ]
                        ]}
                        depth={DEPTH + VIS_OFFSET}
                        color={innerItem.fill ? innerItem.fill : 'black'} />
                );
                itemComponents.push(areas);
                break;
            case 'symbol':
                // This only does do spheres so far
                const symbols = item.items.map((innerItem, index) =>
                    &lt;Sphere key={itemKey + '-' + index}
                        args={[getItemSize(innerItem)]}
                        position={[getItemX(innerItem) + (getItemSize(innerItem) * 0.5), 1 - (getItemY(innerItem) + (getItemSize(innerItem) * 0)), -VIS_OFFSET]}>
                        &lt;meshStandardMaterial metalness={metalnessValue} roughness={roughnessValue} color={innerItem.stroke ? innerItem.stroke : innerItem.fill ? innerItem.fill : 'black'} />
                    &lt;/Sphere>
                );
                itemComponents.push(symbols);
                break;
            case 'trail':
                console.warn('Missing marktype:', marktype, item);
                break;
        }
    }

    return itemComponents;
};

const generateText = (items, key) => {
    const itemComponents = [];

    for (let i = 0; i &lt; items.length; i++) {
        const item = items[i];
        const itemKey = key + '.' + i;
        const marktype = item.marktype ? item.marktype : '';

        switch (marktype) {
            case '':
                let childComponents = [];
                let itemComponent;
                if (item.items) {
                    childComponents = generateText(item.items, itemKey)
                }
                if (item.x && item.y) {
                    itemComponent = &lt;group key={itemKey} position={[getItemX(item), 0 - getItemY(item), 0]}>{childComponents}&lt;/group>
                } else if (item.x) {
                    itemComponent = &lt;group key={itemKey} position={[getItemX(item), 0, 0]}>{childComponents}&lt;/group>
                } else if (item.y) {
                    itemComponent = &lt;group key={itemKey} position={[0, 0 - getItemY(item), 0]}>{childComponents}&lt;/group>
                } else {
                    itemComponent = &lt;group key={itemKey}>{childComponents}&lt;/group>
                }
                if (childComponents.length > 0) {
                    itemComponents.push(itemComponent);
                }
                break;
            case 'group':
                itemComponents.push(&lt;group key={itemKey}>{generateText(item.items, itemKey)}&lt;/group>);
                break;
            case 'text':
                const texts = item.items.map((innerItem, index) =>
                    &lt;Text key={itemKey + '-' + index}
                        position={[getItemX(innerItem), 1 - getItemY(innerItem), -VIS_OFFSET]}
                        textAlign={innerItem.align ? innerItem.align : 'center'}
                        anchorX={innerItem.align ? innerItem.align : 'center'}
                        anchorY={innerItem.baseline ? innerItem.baseline : 'middle'}
                        color={innerItem.fill ? innerItem.fill : 'black'}
                        outlineWidth="2%"
                        outlineColor="white"
                        fontSize={innerItem.fontSize * SCALE}
                        rotation={[0, 0, innerItem.angle ? -(innerItem.angle / 180) * Math.PI : 0]}>
                        {innerItem.text ? innerItem.text : null}
                    &lt;/Text>);
                itemComponents.push(texts);
                break;
        }
    }

    return itemComponents;
};

/**
 * Turn Vega-based specs into 3D visualizations.
 */
const matrixProvider = new THREE.Object3D();
export function VegaLite25DVisualization({ mergedSpec }) {
    const [instancedMeshes, setInstancedMeshes] = useState([]);
    const [nonInstancedMeshes, setNonInstancedMeshes] = useState([]);
    const [textMeshes, setTextMeshes] = useState([]);
    const boxRefs = useRef();

    // When the mergedSpec changes, have Vega render it and convert to fiber when it is done
    useEffect(() => {
        if (mergedSpec) {
            if (DEBUG) console.log('Updating vega scene', mergedSpec);
            mergedSpec.width = VIS_SIZE;
            mergedSpec.height = VIS_SIZE;

            const temp = document.createElement('div');
            embed(temp, mergedSpec).then((result) => {
                setInstancedMeshes(collectBoxes(result.view._scenegraph.root.items, { position: [0, 0, 0], scale: [1, 1, 1], color: 'black' }));
                setNonInstancedMeshes(generateNonInstanced(result.view._scenegraph.root.items));
                setTextMeshes(generateText(result.view._scenegraph.root.items));
                result.finalize();
            });
        }
    }, [mergedSpec]);

    // A bug in the Instancing component means we have to manually recompute the bounding box
    let needsBoundingUpdates = false;
    useFrame(() => {
        if (instancedMeshes && needsBoundingUpdates) {
            boxRefs.current.computeBoundingSphere();
            needsBoundingUpdates = false;
        }
    });
    useEffect(() => {
        if (instancedMeshes) {
            for (let i = 0; i &lt; instancedMeshes.length; i++) {
                let box = instancedMeshes[i];
                if (box.position) matrixProvider.position.set(box.position[0], box.position[1], box.position[2]);
                if (box.rotation) matrixProvider.rotation.set(box.rotation[0], box.rotation[1], box.rotation[2]);
                if (box.scale) matrixProvider.scale.set(box.scale[0], box.scale[1], box.scale[2]);
                matrixProvider.updateMatrix();
                boxRefs.current.setMatrixAt(i, matrixProvider.matrix)
                boxRefs.current.setColorAt(i, new THREE.Color(box.color));
            };
        }
        boxRefs.current.instanceMatrix.needsUpdate = true;
        if (boxRefs.current.instanceColor) boxRefs.current.instanceColor.needsUpdate = true;
        needsBoundingUpdates = true;
    }, [instancedMeshes]);

    return &lt;group scale={0.5} position={[0.25, 0.1, 0]}>
        &lt;instancedMesh ref={boxRefs} geometry={defaultGraphBoxGeometry} material={defaultGraphMaterial} args={[null, null, instancedMeshes ? instancedMeshes.length : 0]} />
        {nonInstancedMeshes}
        {textMeshes}
    &lt;/group>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="OptomancyVisualization">import React from 'react';
let { useState, useEffect, useRef, useMemo } = React;

import { ErrorBoundary } from 'react-error-boundary';

import { OptomancyR3F } from '#optomancy-r3f-lib';



const DEBUG = false;
const VIS_SIZE = 0.5;



export function OptomancyVisualization({ mergedSpec }) {
    const boundaryRef = useRef();
    const [config, setConfig] = useState({
        datasets: [],
        workspaces: []
    });

    useEffect(() => {
        if (DEBUG) console.log('OptomancyVisualization -> mergedSpec', mergedSpec);
        if (mergedSpec && mergedSpec.data) {
            const copiedSpec = Object.assign({}, mergedSpec);
            copiedSpec.data = null;
            copiedSpec.width = VIS_SIZE;
            copiedSpec.height = VIS_SIZE;
            copiedSpec.depth = VIS_SIZE;

            const config = {
                datasets: [
                    {
                        name: 'default_dataset',
                        values: mergedSpec.data.values,
                    }
                ],
                workspaces: [
                    {
                        data: 'default_dataset',
                        views: [copiedSpec]
                    }
                ]
            };
            if (DEBUG) console.log('OptomancyVisualization -> config', config);
            setConfig(config);
            if (boundaryRef.current) boundaryRef.current.resetErrorBoundary();
        } else {
            setConfig({
                datasets: [],
                workspaces: []
            });
        }
    }, [mergedSpec]);

    const visualization = useMemo(() => &lt;OptomancyR3F config={config} options={{ theme: 'light', renderText: true }} />, [config]);

    return &lt;ErrorBoundary ref={boundaryRef} fallback={null}>
        &lt;group position={[0.5, -0.3, 0.75]}>
            {visualization}
        &lt;/group>
    &lt;/ErrorBoundary>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="D3Visualization">import React from 'react';
const { useState, useEffect, useRef, useCallback, useMemo } = React;

import { Plane } from '@react-three/drei';
import * as THREE from 'three';
const { MeshStandardMaterial } = THREE;
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';
import * as d3 from 'd3';



// Reuseable geometry for the image frame
const frameGeometry = new RoundedBoxGeometry(1, 1, 0.01, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#E0E0E0', metalness: 0.2, roughness: 0.5 });



export function D3Visualization({ d3Spec, d3Dataset }) {
    const canvas = useRef(document.createElement('canvas'));
    const context = useRef(canvas.current.getContext('2d'));

    const [aspectRatio, setAspectRatio] = useState(1);
    const [textureHash, setTextureHash] = useState();

    useEffect(() => {
        if (d3Spec && d3Dataset) {
            context.current.fillStyle = 'white';
            context.current.fillRect(0, 0, canvas.current.width, canvas.current.height);
            try {
                d3Spec.fragment.require().then((result) => {
                    result.renderVisualization(d3, d3Dataset, canvas.current);
                    setAspectRatio(canvas.current.width / canvas.current.height);
                    setTextureHash(crypto.randomUUID());
                });
            } catch (e) {
                console.warn('Could not render D3 visualization', e);
                setAspectRatio(1);
                setTextureHash(crypto.randomUUID());
            }
        } else {
            context.current.fillStyle = 'white';
            context.current.fillRect(0, 0, canvas.current.width, canvas.current.height);
            setAspectRatio(1);
            setTextureHash(crypto.randomUUID());
        }
    }, [d3Spec, d3Dataset]);

    const texture = useMemo(() => &lt;canvasTexture attach="map" image={canvas.current} key={textureHash} />, [textureHash]);

    return &lt;>
        &lt;mesh geometry={frameGeometry} material={frameMaterial}
            scale={[0.5 + 0.02, (0.5 / aspectRatio) + 0.02, 1]} position={[0.5, (0.25 / aspectRatio), -0.0051]} autoUpdateMatrix={false} />
        &lt;Plane args={[0.5, 0.5 / aspectRatio]} position={[0.5, 0.25 / aspectRatio, 0]}>
            &lt;meshBasicMaterial toneMapped={false} color="white">
                {texture}
            &lt;/meshBasicMaterial>
        &lt;/Plane>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="VisShelf">import React from 'react';
const { useState, useEffect, useRef, useMemo } = React;

import { useFrame } from '@react-three/fiber';
import { Text } from '@react-three/drei';
import * as THREE from 'three';
const { MeshStandardMaterial, InstancedMesh } = THREE;
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';

import { useProperty } from '#VarvReact';
import { Movable } from '#elements [name="Movable"]';
import { Interactive } from '@react-three/xr';
import { HandleIcon, Icon, themes } from '#components [name="Icon"]';
const {
    getVisComponentById,
    getVegaLiteSpecComponents,
    getDatasetComponents,
    getD3SpecComponents,
    addVisComponentAddedListener,
    removeVisComponentAddedListener,
    addVisComponentRemovedListener,
    removeVisComponentRemovedListener
} = modules.visComponentManager;
const { defaultVisSnippetTypes, getVisSnippetsFromComponent, getVisSnippetsFromParent, } = modules.visSnippetManager;



const DEBUG = false;

const metalnessValue = 0.5;
const roughnessValue = 0.5;
const indicatorMaterials = {
    'visualizations': new MeshStandardMaterial({ color: themes['visualization'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'visualizations:hovered': new MeshStandardMaterial({ color: themes['visualization:hovered'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'spec': new MeshStandardMaterial({ color: themes['spec'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'spec:hovered': new MeshStandardMaterial({ color: themes['spec:hovered'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'dataset': new MeshStandardMaterial({ color: themes['dataset'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'dataset:hovered': new MeshStandardMaterial({ color: themes['dataset:hovered'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'd3Spec': new MeshStandardMaterial({ color: themes['d3Spec'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'd3Spec:hovered': new MeshStandardMaterial({ color: themes['d3Spec:hovered'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'specSnippet': new MeshStandardMaterial({ color: themes['specSnippet'].primary, metalness: metalnessValue, roughness: roughnessValue }),
    'specSnippet:hovered': new MeshStandardMaterial({ color: themes['specSnippet:hovered'].primary, metalness: metalnessValue, roughness: roughnessValue })
};

const icons = {
    'vegaLite_2D' : dashSpaceMeshCache.load('visualizations_2d.glb'),
    'vegaLite_25D' : dashSpaceMeshCache.load('visualizations_25d.glb'),
    'optomancy' : dashSpaceMeshCache.load('visualizations_3d.glb'),
    'd3' : dashSpaceMeshCache.load('visualizations_d3.glb'),
    'spec': dashSpaceMeshCache.load('components_specs.glb'),
    'dataset': dashSpaceMeshCache.load('components_dataset.glb'),
    'd3Spec': dashSpaceMeshCache.load('components_specs_d3.glb'),
    'specSnippet': dashSpaceMeshCache.load('components_snippets.glb')
};

const defaultShelfMaterial = new MeshStandardMaterial({metalness: 0.7, roughness: 0.3});
const defaultGraphBoxGeometry = new RoundedBoxGeometry();
const defaultShelfBoxGeometry = new RoundedBoxGeometry(1, 1, 1, 10);
const defaultShelfColor = themes['bookshelf'].primary;

const SHELF_WIDTH = 0.5;
const SHELF_HEIGHT = 0.5;
const SHELF_BOARD_THICKNESS = 0.01;
const SHELF_DEPTH = 0.1;



const generateDummies = (columns, rows, shelfComponents, setTempTitle) => {
    const dummies = [];

    for (let i = 0; i &lt; shelfComponents.length; i++) {
        const component = shelfComponents[i];
        const x = i % columns;
        const y = Math.floor(i / columns);
        const scale = Math.min(1.2 / columns, 0.8);
        dummies.push(&lt;VisComponentDummy
            component={component}
            key={i}
            position={[(x + 0.5) * SHELF_WIDTH / columns, ((rows - y - 0.5) * SHELF_HEIGHT / rows) - 0.05 * scale, 0]}
            scale={[scale, scale, scale]}
            setTempTitle={setTempTitle}
        />);
    }

    return dummies;
};

function VisComponentDummy({ component, position, scale, setTempTitle }) {
    const [type, setType] = useState('');
    const [title, setTitle] = useState('');
    const meshRef = useRef();
    const iconModel = icons[type] ? icons[type] : icons[0];

    useEffect(() => {
        if (component.constructor.name === 'VisComponent') {
            setType(component.type);
            setTitle(component.id);
            component.addIdChangedListener(setTitle);
        } else if (component.constructor.name === 'VisSnippet') {
            setType('specSnippet');
            setTitle(component.content);
        } else {
            setType(component.type);
            setTitle(component.title);
        }
        return () => {
            if (component.constructor.name === 'VisComponent') {
                component.removeIdChangedListener(setTitle);
            }
        }
    }, [component]);

    const selectStartHandler = (device, e) => {
        if (e) e.stopPropagation();
        const positionX = meshRef.current.matrixWorld.elements[12];
        const positionY = meshRef.current.matrixWorld.elements[13];
        const positionZ = meshRef.current.matrixWorld.elements[14];
        if (component.constructor.name === 'VisComponent' || component.constructor.name === 'VisSnippet') {
            CustomJSTrigger.trigger('instantiateVisComponent', {
                componentType: type,
                fragmentId: type === 'specSnippet' ? '' : title,
                content: type === 'specSnippet' ? title : '',
                snippetType: component.type || '',
                device: device,
                positionX: positionX,
                positionY: positionY,
                positionZ: positionZ
            });
        } else {
            CustomJSTrigger.trigger('instantiateVisualization', {
                visualizationType: type,
                device: device,
                positionX: positionX,
                positionY: positionY,
                positionZ: positionZ
            });
        }
    };

    const [hovered, setHovered] = useState(false);
    const hoverCallback = () => {
        setTempTitle(title);
        setHovered(true);
    };
    const blurCallback = () => {
        setTempTitle('');
        setHovered(false);
    };

    const icon = useMemo(() => &lt;Icon theme={type + (hovered ? ':hovered' : '')} model={iconModel} />, [type, hovered]);

    return &lt;group position={position} scale={scale}>
        &lt;Interactive
            onHover={hoverCallback}
            onBlur={blurCallback}
            onSelectStart={() => selectStartHandler('controllerRight')}>
            &lt;group ref={meshRef}
                onPointerOver={hoverCallback}
                onPointerOut={blurCallback}
                onPointerDown={(e) => selectStartHandler('camera', e)}>
                {icon}
            &lt;/group>
        &lt;/Interactive>
        &lt;Text position={[0, 0.1, 0]} autoUpdateMatrix={false}
            textAlign="center"
            anchorX="center"
            anchorY="middle"
            color="black"
            outlineWidth="5%"
            outlineColor="white"
            fontSize={0.03}>
            {title.length > 15 ? title.slice(0, 15) + '...' : title}
        &lt;/Text>
    &lt;/group>;
}

function ShelfTypeSelector({ shelfType, position }) {
    const [type, setType] = useProperty('type');

    const [hovered, setHovered] = useState(false);
    const hoverCallback = () => {
        setHovered(true);
    };
    const blurCallback = () => {
        setHovered(false);
    };

    return &lt;Interactive
        onHover={hoverCallback}
        onBlur={blurCallback}
        onSelect={() => setType(shelfType)}>
        &lt;mesh geometry={defaultGraphBoxGeometry}
            material={hovered ? indicatorMaterials[shelfType + ':hovered'] : indicatorMaterials[shelfType]}
            scale={type == shelfType ? [0.06, 0.06, 0.06] : [0.05, 0.05, 0.05]}
            position={position}
            onPointerOver={hoverCallback}
            onPointerOut={blurCallback}
            onClick={() => setType(shelfType)}>
        &lt;/mesh>
    &lt;/Interactive>;
}

function SnippetParentSelector({ snippetParent, type, position, setTempSnippetTitle }) {
    const [hovered, setHovered] = useState(false);
    const [selectedParent, setSelectedParent] = useProperty('selectedParent');
    const indicatorMaterial = useMemo(() => hovered ? indicatorMaterials[type + ':hovered'] : indicatorMaterials[type], [type, hovered]);

    const hoverCallback = () => {
        setTempSnippetTitle(snippetParent);
        setHovered(true);
    };
    const blurCallback = () => {
        setTempSnippetTitle('');
        setHovered(false);
    };

    return &lt;Interactive
        onHover={hoverCallback}
        onBlur={blurCallback}
        onSelect={() => setSelectedParent(snippetParent)}>
        &lt;mesh geometry={defaultGraphBoxGeometry}
            material={indicatorMaterial}
            scale={selectedParent == snippetParent ? [0.06, 0.06, 0.06] : [0.05, 0.05, 0.05]}
            position={position}
            onPointerOver={hoverCallback}
            onPointerOut={blurCallback}
            onClick={() => setSelectedParent(snippetParent)}>
        &lt;/mesh>
    &lt;/Interactive>;
}

const matrixProvider = new THREE.Object3D();
export function VisShelf() {
    const [type] = useProperty('type');
    const [selectedParent] = useProperty('selectedParent');

    const [shelf] = useState([]);
    const [dummies, setDummies] = useState([]);
    const [snippetSelectors, setSnippetSelectors] = useState([]);

    const [tempTitle, setTempTitle] = useState('');
    const [tempSnippetTitle, setTempSnippetTitle] = useState('');

    const maxMeshes = 50;
    const boxRefs = useMemo(()=>{
        const instancer = new InstancedMesh(defaultShelfBoxGeometry, defaultShelfMaterial, maxMeshes);

        // Clean up matrices to avoid flicker on initial grow
        const m = new THREE.Matrix4();
        m.set( 0, 0, 0, 0,
            0, 0, 0, 0,
            0, 0, 0, 0,
            0, 0, 0, 0 );
        for (let i = 0; i &lt; maxMeshes; i++){
            instancer.setMatrixAt(i, m);
        }
        return instancer;
    },[]);

    const updateShelves = (columns, rows)=>{
        if (!boxRefs) return;
        let count = 0;
        for (let i = 1; i &lt; columns; i++) {
            matrixProvider.position.set(i * SHELF_WIDTH / columns, 0.5 * SHELF_HEIGHT-0.5*SHELF_BOARD_THICKNESS, 0);
            matrixProvider.scale.set(SHELF_BOARD_THICKNESS, SHELF_HEIGHT + SHELF_BOARD_THICKNESS, SHELF_DEPTH*0.95);
            matrixProvider.updateMatrix();
            boxRefs.setMatrixAt(count, matrixProvider.matrix)
            boxRefs.setColorAt(count, new THREE.Color(defaultShelfColor));
            count++;
        };
        for (let i = 1; i &lt; rows; i++) {
            matrixProvider.position.set(0.5 * SHELF_WIDTH,  i * SHELF_HEIGHT / rows, 0);
            matrixProvider.scale.set(SHELF_WIDTH + SHELF_BOARD_THICKNESS, SHELF_BOARD_THICKNESS, SHELF_DEPTH*0.9);
            matrixProvider.updateMatrix();
            boxRefs.setMatrixAt(count, matrixProvider.matrix)
            boxRefs.setColorAt(count, new THREE.Color(defaultShelfColor));
            count++;
        };

        boxRefs.instanceMatrix.needsUpdate = true;
        if (boxRefs.instanceColor) boxRefs.instanceColor.needsUpdate = true;
        needsBoundingUpdates = true;
        boxRefs.count = count;
    };

    const updateShelfComponents = () => {
        let shelfComponents = [];
        switch (type) {
            case 'visualizations':
                shelfComponents = [
                    { type: 'vegaLite_2D', title: 'Vega-Lite 2D' },
                    { type: 'vegaLite_25D', title: 'Vega-Lite 2.5D' },
                    { type: 'optomancy', title: 'Optomancy' },
                    { type: 'd3', title: 'D3' }
                ];
                break;
            case 'spec':
                shelfComponents = getVegaLiteSpecComponents();
                break;
            case 'dataset':
                shelfComponents = getDatasetComponents();
                break;
            case 'd3Spec':
                shelfComponents = getD3SpecComponents();
                break;
            case 'specSnippet':
                const component = getVisComponentById(selectedParent);
                if (component) {
                    shelfComponents = getVisSnippetsFromComponent(component);
                } else {
                    shelfComponents = getVisSnippetsFromParent(selectedParent);
                }
                break;
            default:
                if (DEBUG) console.log('Unknown VisShelf type: ' + type);
        }

        const rows = Math.max(Math.ceil(Math.sqrt(shelfComponents.length)), 2);
        const columns = Math.max(Math.ceil(shelfComponents.length / rows), 2);
        updateShelves(columns, rows);
        setDummies(generateDummies(columns, rows, shelfComponents, setTempTitle));
    };

    const updateSnippetSelectors = () => {
        const newSnippetSelectors = [];

        let visComponents = getDatasetComponents();
        visComponents = visComponents.concat(getVegaLiteSpecComponents());

        const rows = 6;

        for (let i = 0; i &lt; defaultVisSnippetTypes.length; i++) {
            const x = Math.floor(i / rows);
            const y = i % rows;
            newSnippetSelectors.push(&lt;SnippetParentSelector
                setTempSnippetTitle={setTempSnippetTitle}
                snippetParent={defaultVisSnippetTypes[i]}
                type={'specSnippet'}
                key={i}
                position={[(x * 0.08) + SHELF_WIDTH + 0.05, (-y * 0.08) + SHELF_HEIGHT - 0.05, 0]}
            />);
        }

        for (let i = 0; i &lt; visComponents.length; i++) {
            const component = visComponents[i];
            const index = i + defaultVisSnippetTypes.length;
            const x = Math.floor(index / rows);
            const y = index % rows;
            newSnippetSelectors.push(&lt;SnippetParentSelector
                setTempSnippetTitle={setTempSnippetTitle}
                snippetParent={component.id}
                type={component.type}
                key={index}
                position={[(x * 0.08) + SHELF_WIDTH + 0.05, (-y * 0.08) + SHELF_HEIGHT - 0.05, 0]}
            />);

        }

        setSnippetSelectors(newSnippetSelectors);
    };

    useEffect(() => {
        updateShelfComponents();

        addVisComponentAddedListener(updateShelfComponents);
        addVisComponentRemovedListener(updateShelfComponents);
        if (type === 'specSnippet') {
            updateSnippetSelectors();
            addVisComponentAddedListener(updateSnippetSelectors);
            addVisComponentRemovedListener(updateSnippetSelectors);
        }
        return () => {
            removeVisComponentAddedListener(updateShelfComponents);
            removeVisComponentRemovedListener(updateShelfComponents);
            if (type === 'specSnippet') {
                removeVisComponentAddedListener(updateSnippetSelectors);
                removeVisComponentRemovedListener(updateSnippetSelectors);
            }
        };
    }, [type]);

    useEffect(() => {
        if (type === 'specSnippet') updateShelfComponents();

        const selectedParentComponent = getVisComponentById(selectedParent);
        if (selectedParentComponent) {
            selectedParentComponent.addContentChangedListener(updateShelfComponents);
        }
        return () => {
            if (selectedParentComponent) {
                selectedParentComponent.removeContentChangedListener(updateShelfComponents);
            }
        };
    }, [selectedParent]);

    // A bug in the Instancing component means we have to manually recompute the bounding box
    let needsBoundingUpdates = false;
    useFrame(() => {
        if (shelf && needsBoundingUpdates && boxRefs) {
            boxRefs.computeBoundingSphere();
            needsBoundingUpdates = false;
        }
    });

    const frame = dashSpaceMeshCache.load('bookshelf.glb');
    const handle = &lt;HandleIcon theme="bookshelf" model={frame} />;

    const title = useMemo(() => {
        switch (type) {
            case 'visualizations': return 'Visualizations';
            case 'spec': return 'Vega-Lite Specs';
            case 'dataset': return 'Datasets';
            case 'd3Spec': return 'D3 Specs';
            case 'specSnippet': return 'Spec Snippet' + (selectedParent ? ' (' + selectedParent + ')' : '');
            default: return 'Unknown';
        }
    }, [type, selectedParent]);

    return &lt;Movable handle={handle}>
        &lt;group position={[-0.5 * SHELF_WIDTH, SHELF_BOARD_THICKNESS * 1.5, 0]}>
        &lt;Text position={[0.5 * SHELF_WIDTH, SHELF_HEIGHT + 0.1, 0]}
                font={tempTitle ? "font-mono.woff" : null}
                autoUpdateMatrix={false}
                maxWidth={SHELF_WIDTH}
                textAlign="center"
                anchorX="center"
                anchorY="bottom"
                color="black"
                outlineWidth="5%"
                outlineColor="white"
                fontSize={0.03}>
                {tempTitle ? tempTitle : title}
            &lt;/Text>
            {type === 'specSnippet' ? &lt;Text position={[SHELF_WIDTH + 0.025, SHELF_HEIGHT, 0]}
                font={tempSnippetTitle ? "font-mono.woff" : null}
                autoUpdateMatrix={false}
                textAlign="left"
                anchorX="left"
                anchorY="bottom"
                color="black"
                outlineWidth="5%"
                outlineColor="white"
                fontSize={0.03}>
                {tempSnippetTitle ? tempSnippetTitle : 'Snippet Categories'}
            &lt;/Text> : null}

            &lt;ShelfTypeSelector shelfType='visualizations' position={[0.16 * SHELF_WIDTH, SHELF_HEIGHT + 0.05, 0]} />
            &lt;ShelfTypeSelector shelfType='dataset' position={[0.33 * SHELF_WIDTH, SHELF_HEIGHT + 0.05, 0]} />
            &lt;ShelfTypeSelector shelfType='spec' position={[0.5 * SHELF_WIDTH, SHELF_HEIGHT + 0.05, 0]} />
            &lt;ShelfTypeSelector shelfType='d3Spec' position={[0.66 * SHELF_WIDTH, SHELF_HEIGHT + 0.05, 0]} />
            &lt;ShelfTypeSelector shelfType='specSnippet' position={[0.83 * SHELF_WIDTH, SHELF_HEIGHT + 0.05, 0]} />

            {type === 'specSnippet' ? snippetSelectors : null}

            &lt;primitive object={boxRefs} />
            {dummies}
        &lt;/group>
    &lt;/Movable>;
}

export function Trashcan() {
    const icon = dashSpaceMeshCache.load('trash.glb');
    const handle = &lt;HandleIcon theme="trash" model={icon} />
    return &lt;Movable handle={handle} />;
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Streams"><CODE-FRAGMENT data-type="text/javascript+babel" name="ScreenStream">import React from 'react';
const { useState, useEffect, useMemo } = React;

import * as THREE from 'three';
import { MeshStandardMaterial } from 'three';
import { Plane } from '@react-three/drei';
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';

import { useProperty } from '#VarvReact';
import { Movable, SELECTED_COLOR_PRIMARY, HOVERED_SELECTED_COLOR_PRIMARY } from '#elements [name="Movable"]';
const { doIfClicked } = modules.streamManager;
const { QUERY_PREFIX, streamShare } = modules.screenStreams;



const MAX_SIZE = 0.75;

const frameGeometry = new RoundedBoxGeometry(1, 1, 0.005, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#E0E0E0', metalness: 0.2, roughness: 0.5 });
const frameMaterialHovered = new MeshStandardMaterial({ color: '#FFFFFF', metalness: 0.2, roughness: 0.5 });
const frameMaterialSelected = new MeshStandardMaterial({ color: SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });
const frameMaterialHoveredSelected = new MeshStandardMaterial({ color: HOVERED_SELECTED_COLOR_PRIMARY, metalness: 0.2, roughness: 0.5 });



export function ScreenStream() {
    const [client] = useProperty('client');

    const [screen, setScreen] = useState(document.querySelector(QUERY_PREFIX + client));
    const [width, setWidth] = useState(MAX_SIZE);
    const [height, setHeight] = useState(MAX_SIZE);

    const [selected] = useProperty('selected');
    const [hovered] = useProperty('hovered');

    const updateSize = (aspectRatio) => {
        if (aspectRatio > 1) {
            setWidth(MAX_SIZE);
            setHeight(MAX_SIZE / aspectRatio);
        } else {
            setWidth(MAX_SIZE * aspectRatio);
            setHeight(MAX_SIZE);
        }
    };

    useEffect(() => {
        if (screen) {
            // Playing immediately may fail, wait for interaction in that case
            doIfClicked(() => {
                updateSize(screen.videoWidth / screen.videoHeight || 1);
                screen.addEventListener('resize', () => {
                    updateSize(screen.videoWidth / screen.videoHeight || 1);
                })
            });
        }

        // Make sure to catch stream updates
        let listener = function (newStreamId) {
            if (newStreamId == client) setScreen(document.querySelector(QUERY_PREFIX + client));
        };
        streamShare.addStreamAddedListener(listener);

        return () => {
            streamShare.removeStreamAddedListener(listener);
        }
    }, [screen, client]);

    const texture = useMemo(() => screen ? &lt;videoTexture attach='map' args={[screen]} anisoptry={16} generateMipmaps={true} minFilter={THREE.LinearMipmapLinearFilter} colorSpace={THREE.SRGBColorSpace} /> : null, [screen]);

    const handle = useMemo(() => &lt;mesh
        geometry={frameGeometry}
        material={selected ? (hovered ? frameMaterialHoveredSelected : frameMaterialSelected) : (hovered ? frameMaterialHovered : frameMaterial)}
        scale={[width + 0.02, height + 0.02, 1]}
        position={[0, 0.125 - 0.0125, -0.0051]}
        autoUpdateMatrix={false}>
    &lt;/mesh>, [width, height, selected, hovered]);

    return &lt;Movable handle={handle} upright={false}>
        &lt;Plane args={[width, height]} position={[0, 0.125 - 0.0125, 0]}>
            &lt;meshBasicMaterial toneMapped={false} color={screen ? 'white' : 'darkgrey'}>
                {texture}
            &lt;/meshBasicMaterial>
        &lt;/Plane>
    &lt;/Movable>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="VideoStream">import React from 'react';
const { useState, useEffect, useMemo } = React;

import * as THREE from 'three';
import { MeshStandardMaterial } from 'three';
import { Plane } from '@react-three/drei';
import { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';

import { useProperty } from '#VarvReact';
const { doIfClicked } = modules.streamManager;
const { QUERY_PREFIX, streamShare } = modules.videoStreams;



const frameGeometry = new RoundedBoxGeometry(1, 1, 0.005, 1);
const frameMaterial = new MeshStandardMaterial({ color: '#E0E0E0', metalness: 0.2, roughness: 0.5 });



export function VideoStream() {
    const [client] = useProperty('client');

    const [video, setVideo] = useState(document.querySelector(QUERY_PREFIX + client));
    const [aspectRatio, setAspectRatio] = useState(1);

    useEffect(() => {
        if (video) {
            // Playing immediately may fail, wait for interaction in that case
            doIfClicked(() => {
                setAspectRatio(video.videoWidth / video.videoHeight);
                video.addEventListener('resize', () => {
                    setAspectRatio(video.videoWidth / video.videoHeight);
                });
            });
        }

        // Make sure to catch stream updates
        let listener = function (newStreamId) {
            if (newStreamId == client) setVideo(document.querySelector(QUERY_PREFIX + client));
        };
        streamShare.addStreamAddedListener(listener);

        return () => {
            streamShare.removeStreamAddedListener(listener);
        }
    }, [video, client]);

    const texture = useMemo(() => video ? &lt;videoTexture attach='map' args={[video]} colorSpace={THREE.SRGBColorSpace} /> : null, [video]);

    return &lt;>
        &lt;mesh geometry={frameGeometry} material={frameMaterial}
            scale={[0.25 + 0.02, (0.25 / aspectRatio) + 0.02, 1]} position={[0, (0.125 / aspectRatio) + 0.2, 0.0051]} autoUpdateMatrix={false} />
        &lt;Plane args={[0.25, 0.25 / aspectRatio]} position={[0, (0.125 / aspectRatio) + 0.2, 0]} rotation={[0, Math.PI, 0]}>
            &lt;meshBasicMaterial toneMapped={false} color={video ? 'white' : 'darkgrey'}>
                {texture}
            &lt;/meshBasicMaterial>
        &lt;/Plane>
    &lt;/>;
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="text/javascript+babel" name="AudioStream">import React from 'react';
const { useState, useEffect } = React;

import { useProperty } from '#VarvReact';
const { QUERY_PREFIX, streamShare } = modules.audioStreams;



export function AudioStream() {
    const [client] = useProperty('client');
    const [muted] = useProperty('muted');

    const [audio, setAudio] = useState(document.querySelector(QUERY_PREFIX + client));

    useEffect(() => {
        // Make sure to catch stream updates
        let listener = function (newStreamId) {
            if (newStreamId == client) setAudio(document.querySelector(QUERY_PREFIX + client));
        };
        streamShare.addStreamAddedListener(listener);

        return () => {
            streamShare.removeStreamAddedListener(listener);
        };
    }, [audio, client]);

    useEffect(() => {
        if (audio && (client != webstrate.clientId)) {
            audio.muted = muted;
        }
    }, [muted, client]);
}
</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER><CODE-FOLDER name="Datasets and Specs" id="vis-component-container">
<CODE-FOLDER name="Vega-Lite Specs" id="vega-lite-spec-container"><CODE-FOLDER name="Vega-Lite Examples"><CODE-FRAGMENT data-type="application/json" id="simple-spec" name>{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "mark": "bar",
    "encoding": {
        "x": {
            "field": "a",
            "type": "nominal"
        },
        "y": {
            "field": "b",
            "type": "quantitative"
        }
    }
}</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="cars-spec">{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "A scatterplot showing horsepower and miles per gallons for various cars.",
    "mark": "point",
    "encoding": {
        "x": {
            "field": "Miles_per_Gallon",
            "type": "quantitative"
        },
        "y": {
            "field": "Horsepower",
            "type": "quantitative"
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="population-spec">{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "transform": [
        {
            "filter": "datum.year == 2000"
        },
        {
            "calculate": "datum.sex == 2 ? 'Female' : 'Male'",
            "as": "gender"
        }
    ],
    "mark": "bar",
    "width": {
        "step": 17
    },
    "encoding": {
        "x": {
            "aggregate": "sum",
            "field": "people",
            "title": "population",
            "stack": "normalize"
        },
        "y": {
            "field": "age"
        },
        "color": {
            "field": "gender",
            "scale": {
                "range": [
                    "red",
                    "green"
                ]
            }
        }
    }
}</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="stocks-spec">{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Google's stock price over time.",
    "mark": {
        "type": "line",
        "point": true
    },
    "encoding": {
        "x": {
            "timeUnit": "year",
            "field": "date"
        },
        "y": {
            "aggregate": "mean",
            "field": "price",
            "type": "quantitative"
        },
        "color": {
            "field": "symbol",
            "type": "nominal"
        }
    }
}
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="unemployment-spec">{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "mark": "area",
    "encoding": {
        "x": {
            "timeUnit": "yearmonth",
            "field": "date",
            "axis": {
                "format": "%Y"
            }
        },
        "y": {
            "aggregate": "sum",
            "field": "count",
            "title": "count"
        }
    }
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Optomancy Examples"><CODE-FRAGMENT data-type="application/json" name id="optomancy-spec">{
    "mark": {
        "type": "point",
        "shape": "sphere"
    },
    "encoding": {
        "x": {
            "field": "x",
            "type": "quantitative"
        },
        "y": {
            "field": "y",
            "type": "quantitative"
        },
        "z": {
            "field": "z",
            "type": "quantitative"
        },
        "color": {
            "scale": {
                "scheme": "schemeCategory10"
            },
            "field": "randomOrdinal",
            "type": "ordinal"
        }
    }
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="D3 Examples"><CODE-FRAGMENT data-type="application/json" name id="d3-vega-spec">{
    "mark": "bar",
    "encoding": {
        "x": {
            "field": "label",
            "type": "nominal"
        },
        "y": {
            "field": "value",
            "type": "quantitative"
        }
    }
}
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Event Examples"><CODE-FRAGMENT data-type="application/json" id="events-optomancy-spec">{
    "encoding": {
        "y": {
            "field": "Operating Revenue",
            "type": "quantitative"
        },
        "z": {
            "field": "Event"
        },
        "x": {
            "field": "Year"
        }
    },
    "mark": "bar"
}</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER><CODE-FOLDER name="Datasets" id="dataset-container"><CODE-FOLDER name="Vega-Lite Examples"><CODE-FRAGMENT data-type="application/json" id="simple-dataset">[
    {
        "a": "A",
        "b": 28
    },
    {
        "a": "B",
        "b": 55
    },
    {
        "a": "C",
        "b": 43
    },
    {
        "a": "D",
        "b": 91
    },
    {
        "a": "E",
        "b": 81
    },
    {
        "a": "F",
        "b": 53
    },
    {
        "a": "G",
        "b": 19
    },
    {
        "a": "H",
        "b": 87
    },
    {
        "a": "I",
        "b": 52
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="cars-dataset">[
    {
        "Name": "chevrolet chevelle malibu",
        "Miles_per_Gallon": 18,
        "Cylinders": 8,
        "Displacement": 307,
        "Horsepower": 130,
        "Weight_in_lbs": 3504,
        "Acceleration": 12,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick skylark 320",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 165,
        "Weight_in_lbs": 3693,
        "Acceleration": 11.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth satellite",
        "Miles_per_Gallon": 18,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 3436,
        "Acceleration": 11,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc rebel sst",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 150,
        "Weight_in_lbs": 3433,
        "Acceleration": 12,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford torino",
        "Miles_per_Gallon": 17,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 140,
        "Weight_in_lbs": 3449,
        "Acceleration": 10.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford galaxie 500",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 429,
        "Horsepower": 198,
        "Weight_in_lbs": 4341,
        "Acceleration": 10,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet impala",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 454,
        "Horsepower": 220,
        "Weight_in_lbs": 4354,
        "Acceleration": 9,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth fury iii",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 440,
        "Horsepower": 215,
        "Weight_in_lbs": 4312,
        "Acceleration": 8.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac catalina",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 455,
        "Horsepower": 225,
        "Weight_in_lbs": 4425,
        "Acceleration": 10,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc ambassador dpl",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 390,
        "Horsepower": 190,
        "Weight_in_lbs": 3850,
        "Acceleration": 8.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "citroen ds-21 pallas",
        "Miles_per_Gallon": null,
        "Cylinders": 4,
        "Displacement": 133,
        "Horsepower": 115,
        "Weight_in_lbs": 3090,
        "Acceleration": 17.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "chevrolet chevelle concours (sw)",
        "Miles_per_Gallon": null,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 165,
        "Weight_in_lbs": 4142,
        "Acceleration": 11.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford torino (sw)",
        "Miles_per_Gallon": null,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 153,
        "Weight_in_lbs": 4034,
        "Acceleration": 11,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth satellite (sw)",
        "Miles_per_Gallon": null,
        "Cylinders": 8,
        "Displacement": 383,
        "Horsepower": 175,
        "Weight_in_lbs": 4166,
        "Acceleration": 10.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc rebel sst (sw)",
        "Miles_per_Gallon": null,
        "Cylinders": 8,
        "Displacement": 360,
        "Horsepower": 175,
        "Weight_in_lbs": 3850,
        "Acceleration": 11,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge challenger se",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 383,
        "Horsepower": 170,
        "Weight_in_lbs": 3563,
        "Acceleration": 10,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth 'cuda 340",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 340,
        "Horsepower": 160,
        "Weight_in_lbs": 3609,
        "Acceleration": 8,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford mustang boss 302",
        "Miles_per_Gallon": null,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 140,
        "Weight_in_lbs": 3353,
        "Acceleration": 8,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet monte carlo",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 150,
        "Weight_in_lbs": 3761,
        "Acceleration": 9.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick estate wagon (sw)",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 455,
        "Horsepower": 225,
        "Weight_in_lbs": 3086,
        "Acceleration": 10,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corona mark ii",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 113,
        "Horsepower": 95,
        "Weight_in_lbs": 2372,
        "Acceleration": 15,
        "Year": "1970-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth duster",
        "Miles_per_Gallon": 22,
        "Cylinders": 6,
        "Displacement": 198,
        "Horsepower": 95,
        "Weight_in_lbs": 2833,
        "Acceleration": 15.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc hornet",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 199,
        "Horsepower": 97,
        "Weight_in_lbs": 2774,
        "Acceleration": 15.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford maverick",
        "Miles_per_Gallon": 21,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 85,
        "Weight_in_lbs": 2587,
        "Acceleration": 16,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun pl510",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 88,
        "Weight_in_lbs": 2130,
        "Acceleration": 14.5,
        "Year": "1970-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "volkswagen 1131 deluxe sedan",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 46,
        "Weight_in_lbs": 1835,
        "Acceleration": 20.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "peugeot 504",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 110,
        "Horsepower": 87,
        "Weight_in_lbs": 2672,
        "Acceleration": 17.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "audi 100 ls",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 107,
        "Horsepower": 90,
        "Weight_in_lbs": 2430,
        "Acceleration": 14.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "saab 99e",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 104,
        "Horsepower": 95,
        "Weight_in_lbs": 2375,
        "Acceleration": 17.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "bmw 2002",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 113,
        "Weight_in_lbs": 2234,
        "Acceleration": 12.5,
        "Year": "1970-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "amc gremlin",
        "Miles_per_Gallon": 21,
        "Cylinders": 6,
        "Displacement": 199,
        "Horsepower": 90,
        "Weight_in_lbs": 2648,
        "Acceleration": 15,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford f250",
        "Miles_per_Gallon": 10,
        "Cylinders": 8,
        "Displacement": 360,
        "Horsepower": 215,
        "Weight_in_lbs": 4615,
        "Acceleration": 14,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevy c20",
        "Miles_per_Gallon": 10,
        "Cylinders": 8,
        "Displacement": 307,
        "Horsepower": 200,
        "Weight_in_lbs": 4376,
        "Acceleration": 15,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge d200",
        "Miles_per_Gallon": 11,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 210,
        "Weight_in_lbs": 4382,
        "Acceleration": 13.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "hi 1200d",
        "Miles_per_Gallon": 9,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 193,
        "Weight_in_lbs": 4732,
        "Acceleration": 18.5,
        "Year": "1970-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun pl510",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 88,
        "Weight_in_lbs": 2130,
        "Acceleration": 14.5,
        "Year": "1971-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet vega 2300",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 90,
        "Weight_in_lbs": 2264,
        "Acceleration": 15.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corona",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 113,
        "Horsepower": 95,
        "Weight_in_lbs": 2228,
        "Acceleration": 14,
        "Year": "1971-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": null,
        "Weight_in_lbs": 2046,
        "Acceleration": 19,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen super beetle 117",
        "Miles_per_Gallon": null,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 48,
        "Weight_in_lbs": 1978,
        "Acceleration": 20,
        "Year": "1971-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "amc gremlin",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 2634,
        "Acceleration": 13,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth satellite custom",
        "Miles_per_Gallon": 16,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 105,
        "Weight_in_lbs": 3439,
        "Acceleration": 15.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevelle malibu",
        "Miles_per_Gallon": 17,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 100,
        "Weight_in_lbs": 3329,
        "Acceleration": 15.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford torino 500",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 88,
        "Weight_in_lbs": 3302,
        "Acceleration": 15.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 3288,
        "Acceleration": 15.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet impala",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 165,
        "Weight_in_lbs": 4209,
        "Acceleration": 12,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac catalina brougham",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 175,
        "Weight_in_lbs": 4464,
        "Acceleration": 11.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford galaxie 500",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 153,
        "Weight_in_lbs": 4154,
        "Acceleration": 13.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth fury iii",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4096,
        "Acceleration": 13,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge monaco (sw)",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 383,
        "Horsepower": 180,
        "Weight_in_lbs": 4955,
        "Acceleration": 11.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford country squire (sw)",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 170,
        "Weight_in_lbs": 4746,
        "Acceleration": 12,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac safari (sw)",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 175,
        "Weight_in_lbs": 5140,
        "Acceleration": 12,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc hornet sportabout (sw)",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 258,
        "Horsepower": 110,
        "Weight_in_lbs": 2962,
        "Acceleration": 13.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet vega (sw)",
        "Miles_per_Gallon": 22,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 72,
        "Weight_in_lbs": 2408,
        "Acceleration": 19,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac firebird",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 100,
        "Weight_in_lbs": 3282,
        "Acceleration": 15,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford mustang",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 88,
        "Weight_in_lbs": 3139,
        "Acceleration": 14.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury capri 2000",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 86,
        "Weight_in_lbs": 2220,
        "Acceleration": 14,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "opel 1900",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 116,
        "Horsepower": 90,
        "Weight_in_lbs": 2123,
        "Acceleration": 14,
        "Year": "1971-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "peugeot 304",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 70,
        "Weight_in_lbs": 2074,
        "Acceleration": 19.5,
        "Year": "1971-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "fiat 124b",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 88,
        "Horsepower": 76,
        "Weight_in_lbs": 2065,
        "Acceleration": 14.5,
        "Year": "1971-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota corolla 1200",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 71,
        "Horsepower": 65,
        "Weight_in_lbs": 1773,
        "Acceleration": 19,
        "Year": "1971-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 1200",
        "Miles_per_Gallon": 35,
        "Cylinders": 4,
        "Displacement": 72,
        "Horsepower": 69,
        "Weight_in_lbs": 1613,
        "Acceleration": 18,
        "Year": "1971-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "volkswagen model 111",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 60,
        "Weight_in_lbs": 1834,
        "Acceleration": 19,
        "Year": "1971-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "plymouth cricket",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 70,
        "Weight_in_lbs": 1955,
        "Acceleration": 20.5,
        "Year": "1971-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corona hardtop",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 113,
        "Horsepower": 95,
        "Weight_in_lbs": 2278,
        "Acceleration": 15.5,
        "Year": "1972-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge colt hardtop",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 97.5,
        "Horsepower": 80,
        "Weight_in_lbs": 2126,
        "Acceleration": 17,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen type 3",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 54,
        "Weight_in_lbs": 2254,
        "Acceleration": 23.5,
        "Year": "1972-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "chevrolet vega",
        "Miles_per_Gallon": 20,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 90,
        "Weight_in_lbs": 2408,
        "Acceleration": 19.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford pinto runabout",
        "Miles_per_Gallon": 21,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 86,
        "Weight_in_lbs": 2226,
        "Acceleration": 16.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet impala",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 165,
        "Weight_in_lbs": 4274,
        "Acceleration": 12,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac catalina",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 175,
        "Weight_in_lbs": 4385,
        "Acceleration": 12,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth fury iii",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4135,
        "Acceleration": 13.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford galaxie 500",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 153,
        "Weight_in_lbs": 4129,
        "Acceleration": 13,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc ambassador sst",
        "Miles_per_Gallon": 17,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 150,
        "Weight_in_lbs": 3672,
        "Acceleration": 11.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury marquis",
        "Miles_per_Gallon": 11,
        "Cylinders": 8,
        "Displacement": 429,
        "Horsepower": 208,
        "Weight_in_lbs": 4633,
        "Acceleration": 11,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick lesabre custom",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 155,
        "Weight_in_lbs": 4502,
        "Acceleration": 13.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile delta 88 royale",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 160,
        "Weight_in_lbs": 4456,
        "Acceleration": 13.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler newport royal",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 190,
        "Weight_in_lbs": 4422,
        "Acceleration": 12.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mazda rx2 coupe",
        "Miles_per_Gallon": 19,
        "Cylinders": 3,
        "Displacement": 70,
        "Horsepower": 97,
        "Weight_in_lbs": 2330,
        "Acceleration": 13.5,
        "Year": "1972-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "amc matador (sw)",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 150,
        "Weight_in_lbs": 3892,
        "Acceleration": 12.5,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevelle concours (sw)",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 307,
        "Horsepower": 130,
        "Weight_in_lbs": 4098,
        "Acceleration": 14,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford gran torino (sw)",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 140,
        "Weight_in_lbs": 4294,
        "Acceleration": 16,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth satellite custom (sw)",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4077,
        "Acceleration": 14,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volvo 145e (sw)",
        "Miles_per_Gallon": 18,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 112,
        "Weight_in_lbs": 2933,
        "Acceleration": 14.5,
        "Year": "1972-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volkswagen 411 (sw)",
        "Miles_per_Gallon": 22,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 76,
        "Weight_in_lbs": 2511,
        "Acceleration": 18,
        "Year": "1972-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "peugeot 504 (sw)",
        "Miles_per_Gallon": 21,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 87,
        "Weight_in_lbs": 2979,
        "Acceleration": 19.5,
        "Year": "1972-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "renault 12 (sw)",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 96,
        "Horsepower": 69,
        "Weight_in_lbs": 2189,
        "Acceleration": 18,
        "Year": "1972-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "ford pinto (sw)",
        "Miles_per_Gallon": 22,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 86,
        "Weight_in_lbs": 2395,
        "Acceleration": 16,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 510 (sw)",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 92,
        "Weight_in_lbs": 2288,
        "Acceleration": 17,
        "Year": "1972-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyouta corona mark ii (sw)",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 97,
        "Weight_in_lbs": 2506,
        "Acceleration": 14.5,
        "Year": "1972-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge colt (sw)",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 80,
        "Weight_in_lbs": 2164,
        "Acceleration": 15,
        "Year": "1972-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corolla 1600 (sw)",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 88,
        "Weight_in_lbs": 2100,
        "Acceleration": 16.5,
        "Year": "1972-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "buick century 350",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 175,
        "Weight_in_lbs": 4100,
        "Acceleration": 13,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 150,
        "Weight_in_lbs": 3672,
        "Acceleration": 11.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet malibu",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 145,
        "Weight_in_lbs": 3988,
        "Acceleration": 13,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford gran torino",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 137,
        "Weight_in_lbs": 4042,
        "Acceleration": 14.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge coronet custom",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 3777,
        "Acceleration": 12.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury marquis brougham",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 429,
        "Horsepower": 198,
        "Weight_in_lbs": 4952,
        "Acceleration": 11.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet caprice classic",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 150,
        "Weight_in_lbs": 4464,
        "Acceleration": 12,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford ltd",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 158,
        "Weight_in_lbs": 4363,
        "Acceleration": 13,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth fury gran sedan",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4237,
        "Acceleration": 14.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler new yorker brougham",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 440,
        "Horsepower": 215,
        "Weight_in_lbs": 4735,
        "Acceleration": 11,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick electra 225 custom",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 455,
        "Horsepower": 225,
        "Weight_in_lbs": 4951,
        "Acceleration": 11,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc ambassador brougham",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 360,
        "Horsepower": 175,
        "Weight_in_lbs": 3821,
        "Acceleration": 11,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth valiant",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 105,
        "Weight_in_lbs": 3121,
        "Acceleration": 16.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet nova custom",
        "Miles_per_Gallon": 16,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 100,
        "Weight_in_lbs": 3278,
        "Acceleration": 18,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc hornet",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 2945,
        "Acceleration": 16,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford maverick",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 88,
        "Weight_in_lbs": 3021,
        "Acceleration": 16.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth duster",
        "Miles_per_Gallon": 23,
        "Cylinders": 6,
        "Displacement": 198,
        "Horsepower": 95,
        "Weight_in_lbs": 2904,
        "Acceleration": 16,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen super beetle",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 46,
        "Weight_in_lbs": 1950,
        "Acceleration": 21,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "chevrolet impala",
        "Miles_per_Gallon": 11,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 150,
        "Weight_in_lbs": 4997,
        "Acceleration": 14,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford country",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 167,
        "Weight_in_lbs": 4906,
        "Acceleration": 12.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth custom suburb",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 360,
        "Horsepower": 170,
        "Weight_in_lbs": 4654,
        "Acceleration": 13,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile vista cruiser",
        "Miles_per_Gallon": 12,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 180,
        "Weight_in_lbs": 4499,
        "Acceleration": 12.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc gremlin",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 2789,
        "Acceleration": 15,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota carina",
        "Miles_per_Gallon": 20,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 88,
        "Weight_in_lbs": 2279,
        "Acceleration": 19,
        "Year": "1973-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet vega",
        "Miles_per_Gallon": 21,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 72,
        "Weight_in_lbs": 2401,
        "Acceleration": 19.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 610",
        "Miles_per_Gallon": 22,
        "Cylinders": 4,
        "Displacement": 108,
        "Horsepower": 94,
        "Weight_in_lbs": 2379,
        "Acceleration": 16.5,
        "Year": "1973-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "maxda rx3",
        "Miles_per_Gallon": 18,
        "Cylinders": 3,
        "Displacement": 70,
        "Horsepower": 90,
        "Weight_in_lbs": 2124,
        "Acceleration": 13.5,
        "Year": "1973-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 19,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 85,
        "Weight_in_lbs": 2310,
        "Acceleration": 18.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury capri v6",
        "Miles_per_Gallon": 21,
        "Cylinders": 6,
        "Displacement": 155,
        "Horsepower": 107,
        "Weight_in_lbs": 2472,
        "Acceleration": 14,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "fiat 124 sport coupe",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 90,
        "Weight_in_lbs": 2265,
        "Acceleration": 15.5,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "chevrolet monte carlo s",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 145,
        "Weight_in_lbs": 4082,
        "Acceleration": 13,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac grand prix",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 230,
        "Weight_in_lbs": 4278,
        "Acceleration": 9.5,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "fiat 128",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 68,
        "Horsepower": 49,
        "Weight_in_lbs": 1867,
        "Acceleration": 19.5,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "opel manta",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 116,
        "Horsepower": 75,
        "Weight_in_lbs": 2158,
        "Acceleration": 15.5,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "audi 100ls",
        "Miles_per_Gallon": 20,
        "Cylinders": 4,
        "Displacement": 114,
        "Horsepower": 91,
        "Weight_in_lbs": 2582,
        "Acceleration": 14,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volvo 144ea",
        "Miles_per_Gallon": 19,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 112,
        "Weight_in_lbs": 2868,
        "Acceleration": 15.5,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "dodge dart custom",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 3399,
        "Acceleration": 11,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "saab 99le",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 110,
        "Weight_in_lbs": 2660,
        "Acceleration": 14,
        "Year": "1973-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota mark ii",
        "Miles_per_Gallon": 20,
        "Cylinders": 6,
        "Displacement": 156,
        "Horsepower": 122,
        "Weight_in_lbs": 2807,
        "Acceleration": 13.5,
        "Year": "1973-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "oldsmobile omega",
        "Miles_per_Gallon": 11,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 180,
        "Weight_in_lbs": 3664,
        "Acceleration": 11,
        "Year": "1973-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth duster",
        "Miles_per_Gallon": 20,
        "Cylinders": 6,
        "Displacement": 198,
        "Horsepower": 95,
        "Weight_in_lbs": 3102,
        "Acceleration": 16.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford maverick",
        "Miles_per_Gallon": 21,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": null,
        "Weight_in_lbs": 2875,
        "Acceleration": 17,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc hornet",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 2901,
        "Acceleration": 16,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet nova",
        "Miles_per_Gallon": 15,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 100,
        "Weight_in_lbs": 3336,
        "Acceleration": 17,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun b210",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 67,
        "Weight_in_lbs": 1950,
        "Acceleration": 19,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 80,
        "Weight_in_lbs": 2451,
        "Acceleration": 16.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corolla 1200",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 71,
        "Horsepower": 65,
        "Weight_in_lbs": 1836,
        "Acceleration": 21,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet vega",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 75,
        "Weight_in_lbs": 2542,
        "Acceleration": 17,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevelle malibu classic",
        "Miles_per_Gallon": 16,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 100,
        "Weight_in_lbs": 3781,
        "Acceleration": 17,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador",
        "Miles_per_Gallon": 16,
        "Cylinders": 6,
        "Displacement": 258,
        "Horsepower": 110,
        "Weight_in_lbs": 3632,
        "Acceleration": 18,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth satellite sebring",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 105,
        "Weight_in_lbs": 3613,
        "Acceleration": 16.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford gran torino",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 140,
        "Weight_in_lbs": 4141,
        "Acceleration": 14,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick century luxus (sw)",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 150,
        "Weight_in_lbs": 4699,
        "Acceleration": 14.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge coronet custom (sw)",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4457,
        "Acceleration": 13.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford gran torino (sw)",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 140,
        "Weight_in_lbs": 4638,
        "Acceleration": 16,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador (sw)",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 150,
        "Weight_in_lbs": 4257,
        "Acceleration": 15.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "audi fox",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 83,
        "Weight_in_lbs": 2219,
        "Acceleration": 16.5,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volkswagen dasher",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 67,
        "Weight_in_lbs": 1963,
        "Acceleration": 15.5,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "opel manta",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 78,
        "Weight_in_lbs": 2300,
        "Acceleration": 14.5,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota corona",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 76,
        "Horsepower": 52,
        "Weight_in_lbs": 1649,
        "Acceleration": 16.5,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 710",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 83,
        "Horsepower": 61,
        "Weight_in_lbs": 2003,
        "Acceleration": 19,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge colt",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 75,
        "Weight_in_lbs": 2125,
        "Acceleration": 14.5,
        "Year": "1974-01-01",
        "Origin": "USA"
    },
    {
        "Name": "fiat 128",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 75,
        "Weight_in_lbs": 2108,
        "Acceleration": 15.5,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "fiat 124 tc",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 116,
        "Horsepower": 75,
        "Weight_in_lbs": 2246,
        "Acceleration": 14,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda civic",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 97,
        "Weight_in_lbs": 2489,
        "Acceleration": 15,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "subaru",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 108,
        "Horsepower": 93,
        "Weight_in_lbs": 2391,
        "Acceleration": 15.5,
        "Year": "1974-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "fiat x1.9",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 67,
        "Weight_in_lbs": 2000,
        "Acceleration": 16,
        "Year": "1974-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "plymouth valiant custom",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 95,
        "Weight_in_lbs": 3264,
        "Acceleration": 16,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet nova",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 105,
        "Weight_in_lbs": 3459,
        "Acceleration": 16,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury monarch",
        "Miles_per_Gallon": 15,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 72,
        "Weight_in_lbs": 3432,
        "Acceleration": 21,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford maverick",
        "Miles_per_Gallon": 15,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 72,
        "Weight_in_lbs": 3158,
        "Acceleration": 19.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac catalina",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 170,
        "Weight_in_lbs": 4668,
        "Acceleration": 11.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet bel air",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 145,
        "Weight_in_lbs": 4440,
        "Acceleration": 14,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth grand fury",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4498,
        "Acceleration": 14.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford ltd",
        "Miles_per_Gallon": 14,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 148,
        "Weight_in_lbs": 4657,
        "Acceleration": 13.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick century",
        "Miles_per_Gallon": 17,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 110,
        "Weight_in_lbs": 3907,
        "Acceleration": 21,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevroelt chevelle malibu",
        "Miles_per_Gallon": 16,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 105,
        "Weight_in_lbs": 3897,
        "Acceleration": 18.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador",
        "Miles_per_Gallon": 15,
        "Cylinders": 6,
        "Displacement": 258,
        "Horsepower": 110,
        "Weight_in_lbs": 3730,
        "Acceleration": 19,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth fury",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 95,
        "Weight_in_lbs": 3785,
        "Acceleration": 19,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick skyhawk",
        "Miles_per_Gallon": 21,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 110,
        "Weight_in_lbs": 3039,
        "Acceleration": 15,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet monza 2+2",
        "Miles_per_Gallon": 20,
        "Cylinders": 8,
        "Displacement": 262,
        "Horsepower": 110,
        "Weight_in_lbs": 3221,
        "Acceleration": 13.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford mustang ii",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 129,
        "Weight_in_lbs": 3169,
        "Acceleration": 12,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corolla",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 75,
        "Weight_in_lbs": 2171,
        "Acceleration": 16,
        "Year": "1975-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 83,
        "Weight_in_lbs": 2639,
        "Acceleration": 17,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc gremlin",
        "Miles_per_Gallon": 20,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 100,
        "Weight_in_lbs": 2914,
        "Acceleration": 16,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac astro",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 78,
        "Weight_in_lbs": 2592,
        "Acceleration": 18.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corona",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 134,
        "Horsepower": 96,
        "Weight_in_lbs": 2702,
        "Acceleration": 13.5,
        "Year": "1975-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "volkswagen dasher",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 71,
        "Weight_in_lbs": 2223,
        "Acceleration": 16.5,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "datsun 710",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 97,
        "Weight_in_lbs": 2545,
        "Acceleration": 17,
        "Year": "1975-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 171,
        "Horsepower": 97,
        "Weight_in_lbs": 2984,
        "Acceleration": 14.5,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen rabbit",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 70,
        "Weight_in_lbs": 1937,
        "Acceleration": 14,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "amc pacer",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 90,
        "Weight_in_lbs": 3211,
        "Acceleration": 17,
        "Year": "1975-01-01",
        "Origin": "USA"
    },
    {
        "Name": "audi 100ls",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 115,
        "Horsepower": 95,
        "Weight_in_lbs": 2694,
        "Acceleration": 15,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "peugeot 504",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 88,
        "Weight_in_lbs": 2957,
        "Acceleration": 17,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volvo 244dl",
        "Miles_per_Gallon": 22,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 98,
        "Weight_in_lbs": 2945,
        "Acceleration": 14.5,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "saab 99le",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 115,
        "Weight_in_lbs": 2671,
        "Acceleration": 13.5,
        "Year": "1975-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda civic cvcc",
        "Miles_per_Gallon": 33,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 53,
        "Weight_in_lbs": 1795,
        "Acceleration": 17.5,
        "Year": "1975-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "fiat 131",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 107,
        "Horsepower": 86,
        "Weight_in_lbs": 2464,
        "Acceleration": 15.5,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "opel 1900",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 116,
        "Horsepower": 81,
        "Weight_in_lbs": 2220,
        "Acceleration": 16.9,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "capri ii",
        "Miles_per_Gallon": 25,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 92,
        "Weight_in_lbs": 2572,
        "Acceleration": 14.9,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge colt",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 79,
        "Weight_in_lbs": 2255,
        "Acceleration": 17.7,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "renault 12tl",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 101,
        "Horsepower": 83,
        "Weight_in_lbs": 2202,
        "Acceleration": 15.3,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "chevrolet chevelle malibu classic",
        "Miles_per_Gallon": 17.5,
        "Cylinders": 8,
        "Displacement": 305,
        "Horsepower": 140,
        "Weight_in_lbs": 4215,
        "Acceleration": 13,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge coronet brougham",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 4190,
        "Acceleration": 13,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc matador",
        "Miles_per_Gallon": 15.5,
        "Cylinders": 8,
        "Displacement": 304,
        "Horsepower": 120,
        "Weight_in_lbs": 3962,
        "Acceleration": 13.9,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford gran torino",
        "Miles_per_Gallon": 14.5,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 152,
        "Weight_in_lbs": 4215,
        "Acceleration": 12.8,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth valiant",
        "Miles_per_Gallon": 22,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 100,
        "Weight_in_lbs": 3233,
        "Acceleration": 15.4,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet nova",
        "Miles_per_Gallon": 22,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 105,
        "Weight_in_lbs": 3353,
        "Acceleration": 14.5,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford maverick",
        "Miles_per_Gallon": 24,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 81,
        "Weight_in_lbs": 3012,
        "Acceleration": 17.6,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc hornet",
        "Miles_per_Gallon": 22.5,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 90,
        "Weight_in_lbs": 3085,
        "Acceleration": 17.6,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevette",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 52,
        "Weight_in_lbs": 2035,
        "Acceleration": 22.2,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet woody",
        "Miles_per_Gallon": 24.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 60,
        "Weight_in_lbs": 2164,
        "Acceleration": 22.1,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "vw rabbit",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 70,
        "Weight_in_lbs": 1937,
        "Acceleration": 14.2,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda civic",
        "Miles_per_Gallon": 33,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 53,
        "Weight_in_lbs": 1795,
        "Acceleration": 17.4,
        "Year": "1976-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge aspen se",
        "Miles_per_Gallon": 20,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 100,
        "Weight_in_lbs": 3651,
        "Acceleration": 17.7,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford granada ghia",
        "Miles_per_Gallon": 18,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 78,
        "Weight_in_lbs": 3574,
        "Acceleration": 21,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac ventura sj",
        "Miles_per_Gallon": 18.5,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 110,
        "Weight_in_lbs": 3645,
        "Acceleration": 16.2,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc pacer d/l",
        "Miles_per_Gallon": 17.5,
        "Cylinders": 6,
        "Displacement": 258,
        "Horsepower": 95,
        "Weight_in_lbs": 3193,
        "Acceleration": 17.8,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen rabbit",
        "Miles_per_Gallon": 29.5,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 71,
        "Weight_in_lbs": 1825,
        "Acceleration": 12.2,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "datsun b-210",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 70,
        "Weight_in_lbs": 1990,
        "Acceleration": 17,
        "Year": "1976-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyota corolla",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 75,
        "Weight_in_lbs": 2155,
        "Acceleration": 16.4,
        "Year": "1976-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford pinto",
        "Miles_per_Gallon": 26.5,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 72,
        "Weight_in_lbs": 2565,
        "Acceleration": 13.6,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volvo 245",
        "Miles_per_Gallon": 20,
        "Cylinders": 4,
        "Displacement": 130,
        "Horsepower": 102,
        "Weight_in_lbs": 3150,
        "Acceleration": 15.7,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "plymouth volare premier v8",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 3940,
        "Acceleration": 13.2,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "peugeot 504",
        "Miles_per_Gallon": 19,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 88,
        "Weight_in_lbs": 3270,
        "Acceleration": 21.9,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota mark ii",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 156,
        "Horsepower": 108,
        "Weight_in_lbs": 2930,
        "Acceleration": 15.5,
        "Year": "1976-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mercedes-benz 280s",
        "Miles_per_Gallon": 16.5,
        "Cylinders": 6,
        "Displacement": 168,
        "Horsepower": 120,
        "Weight_in_lbs": 3820,
        "Acceleration": 16.7,
        "Year": "1976-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "cadillac seville",
        "Miles_per_Gallon": 16.5,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 180,
        "Weight_in_lbs": 4380,
        "Acceleration": 12.1,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevy c10",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 145,
        "Weight_in_lbs": 4055,
        "Acceleration": 12,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford f108",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 130,
        "Weight_in_lbs": 3870,
        "Acceleration": 15,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge d100",
        "Miles_per_Gallon": 13,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 150,
        "Weight_in_lbs": 3755,
        "Acceleration": 14,
        "Year": "1976-01-01",
        "Origin": "USA"
    },
    {
        "Name": "honda Accelerationord cvcc",
        "Miles_per_Gallon": 31.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 68,
        "Weight_in_lbs": 2045,
        "Acceleration": 18.5,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "buick opel isuzu deluxe",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 111,
        "Horsepower": 80,
        "Weight_in_lbs": 2155,
        "Acceleration": 14.8,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "renault 5 gtl",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 58,
        "Weight_in_lbs": 1825,
        "Acceleration": 18.6,
        "Year": "1977-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "plymouth arrow gs",
        "Miles_per_Gallon": 25.5,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 96,
        "Weight_in_lbs": 2300,
        "Acceleration": 15.5,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun f-10 hatchback",
        "Miles_per_Gallon": 33.5,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 70,
        "Weight_in_lbs": 1945,
        "Acceleration": 16.8,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet caprice classic",
        "Miles_per_Gallon": 17.5,
        "Cylinders": 8,
        "Displacement": 305,
        "Horsepower": 145,
        "Weight_in_lbs": 3880,
        "Acceleration": 12.5,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile cutlass supreme",
        "Miles_per_Gallon": 17,
        "Cylinders": 8,
        "Displacement": 260,
        "Horsepower": 110,
        "Weight_in_lbs": 4060,
        "Acceleration": 19,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge monaco brougham",
        "Miles_per_Gallon": 15.5,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 145,
        "Weight_in_lbs": 4140,
        "Acceleration": 13.7,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury cougar brougham",
        "Miles_per_Gallon": 15,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 130,
        "Weight_in_lbs": 4295,
        "Acceleration": 14.9,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet concours",
        "Miles_per_Gallon": 17.5,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 110,
        "Weight_in_lbs": 3520,
        "Acceleration": 16.4,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick skylark",
        "Miles_per_Gallon": 20.5,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 105,
        "Weight_in_lbs": 3425,
        "Acceleration": 16.9,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth volare custom",
        "Miles_per_Gallon": 19,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 100,
        "Weight_in_lbs": 3630,
        "Acceleration": 17.7,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford granada",
        "Miles_per_Gallon": 18.5,
        "Cylinders": 6,
        "Displacement": 250,
        "Horsepower": 98,
        "Weight_in_lbs": 3525,
        "Acceleration": 19,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac grand prix lj",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 180,
        "Weight_in_lbs": 4220,
        "Acceleration": 11.1,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet monte carlo landau",
        "Miles_per_Gallon": 15.5,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 170,
        "Weight_in_lbs": 4165,
        "Acceleration": 11.4,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler cordoba",
        "Miles_per_Gallon": 15.5,
        "Cylinders": 8,
        "Displacement": 400,
        "Horsepower": 190,
        "Weight_in_lbs": 4325,
        "Acceleration": 12.2,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford thunderbird",
        "Miles_per_Gallon": 16,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 149,
        "Weight_in_lbs": 4335,
        "Acceleration": 14.5,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen rabbit custom",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 78,
        "Weight_in_lbs": 1940,
        "Acceleration": 14.5,
        "Year": "1977-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "pontiac sunbird coupe",
        "Miles_per_Gallon": 24.5,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 88,
        "Weight_in_lbs": 2740,
        "Acceleration": 16,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corolla liftback",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 75,
        "Weight_in_lbs": 2265,
        "Acceleration": 18.2,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "ford mustang ii 2+2",
        "Miles_per_Gallon": 25.5,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 89,
        "Weight_in_lbs": 2755,
        "Acceleration": 15.8,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevette",
        "Miles_per_Gallon": 30.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 63,
        "Weight_in_lbs": 2051,
        "Acceleration": 17,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge colt m/m",
        "Miles_per_Gallon": 33.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 83,
        "Weight_in_lbs": 2075,
        "Acceleration": 15.9,
        "Year": "1977-01-01",
        "Origin": "USA"
    },
    {
        "Name": "subaru dl",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 67,
        "Weight_in_lbs": 1985,
        "Acceleration": 16.4,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "volkswagen dasher",
        "Miles_per_Gallon": 30.5,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 78,
        "Weight_in_lbs": 2190,
        "Acceleration": 14.1,
        "Year": "1977-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "datsun 810",
        "Miles_per_Gallon": 22,
        "Cylinders": 6,
        "Displacement": 146,
        "Horsepower": 97,
        "Weight_in_lbs": 2815,
        "Acceleration": 14.5,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "bmw 320i",
        "Miles_per_Gallon": 21.5,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 110,
        "Weight_in_lbs": 2600,
        "Acceleration": 12.8,
        "Year": "1977-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "mazda rx-4",
        "Miles_per_Gallon": 21.5,
        "Cylinders": 3,
        "Displacement": 80,
        "Horsepower": 110,
        "Weight_in_lbs": 2720,
        "Acceleration": 13.5,
        "Year": "1977-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "volkswagen rabbit custom diesel",
        "Miles_per_Gallon": 43.1,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 48,
        "Weight_in_lbs": 1985,
        "Acceleration": 21.5,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "ford fiesta",
        "Miles_per_Gallon": 36.1,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 66,
        "Weight_in_lbs": 1800,
        "Acceleration": 14.4,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mazda glc deluxe",
        "Miles_per_Gallon": 32.8,
        "Cylinders": 4,
        "Displacement": 78,
        "Horsepower": 52,
        "Weight_in_lbs": 1985,
        "Acceleration": 19.4,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun b210 gx",
        "Miles_per_Gallon": 39.4,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 70,
        "Weight_in_lbs": 2070,
        "Acceleration": 18.6,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "honda civic cvcc",
        "Miles_per_Gallon": 36.1,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 60,
        "Weight_in_lbs": 1800,
        "Acceleration": 16.4,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "oldsmobile cutlass salon brougham",
        "Miles_per_Gallon": 19.9,
        "Cylinders": 8,
        "Displacement": 260,
        "Horsepower": 110,
        "Weight_in_lbs": 3365,
        "Acceleration": 15.5,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge diplomat",
        "Miles_per_Gallon": 19.4,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 140,
        "Weight_in_lbs": 3735,
        "Acceleration": 13.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury monarch ghia",
        "Miles_per_Gallon": 20.2,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 139,
        "Weight_in_lbs": 3570,
        "Acceleration": 12.8,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac phoenix lj",
        "Miles_per_Gallon": 19.2,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 105,
        "Weight_in_lbs": 3535,
        "Acceleration": 19.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet malibu",
        "Miles_per_Gallon": 20.5,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 95,
        "Weight_in_lbs": 3155,
        "Acceleration": 18.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford fairmont (auto)",
        "Miles_per_Gallon": 20.2,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 85,
        "Weight_in_lbs": 2965,
        "Acceleration": 15.8,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford fairmont (man)",
        "Miles_per_Gallon": 25.1,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 88,
        "Weight_in_lbs": 2720,
        "Acceleration": 15.4,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth volare",
        "Miles_per_Gallon": 20.5,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 100,
        "Weight_in_lbs": 3430,
        "Acceleration": 17.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc concord",
        "Miles_per_Gallon": 19.4,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 90,
        "Weight_in_lbs": 3210,
        "Acceleration": 17.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick century special",
        "Miles_per_Gallon": 20.6,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 105,
        "Weight_in_lbs": 3380,
        "Acceleration": 15.8,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury zephyr",
        "Miles_per_Gallon": 20.8,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 85,
        "Weight_in_lbs": 3070,
        "Acceleration": 16.7,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge aspen",
        "Miles_per_Gallon": 18.6,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 110,
        "Weight_in_lbs": 3620,
        "Acceleration": 18.7,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc concord d/l",
        "Miles_per_Gallon": 18.1,
        "Cylinders": 6,
        "Displacement": 258,
        "Horsepower": 120,
        "Weight_in_lbs": 3410,
        "Acceleration": 15.1,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet monte carlo landau",
        "Miles_per_Gallon": 19.2,
        "Cylinders": 8,
        "Displacement": 305,
        "Horsepower": 145,
        "Weight_in_lbs": 3425,
        "Acceleration": 13.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick regal sport coupe (turbo)",
        "Miles_per_Gallon": 17.7,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 165,
        "Weight_in_lbs": 3445,
        "Acceleration": 13.4,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford futura",
        "Miles_per_Gallon": 18.1,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 139,
        "Weight_in_lbs": 3205,
        "Acceleration": 11.2,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge magnum xe",
        "Miles_per_Gallon": 17.5,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 140,
        "Weight_in_lbs": 4080,
        "Acceleration": 13.7,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet chevette",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 68,
        "Weight_in_lbs": 2155,
        "Acceleration": 16.5,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota corona",
        "Miles_per_Gallon": 27.5,
        "Cylinders": 4,
        "Displacement": 134,
        "Horsepower": 95,
        "Weight_in_lbs": 2560,
        "Acceleration": 14.2,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 510",
        "Miles_per_Gallon": 27.2,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 97,
        "Weight_in_lbs": 2300,
        "Acceleration": 14.7,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge omni",
        "Miles_per_Gallon": 30.9,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 75,
        "Weight_in_lbs": 2230,
        "Acceleration": 14.5,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota celica gt liftback",
        "Miles_per_Gallon": 21.1,
        "Cylinders": 4,
        "Displacement": 134,
        "Horsepower": 95,
        "Weight_in_lbs": 2515,
        "Acceleration": 14.8,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth sapporo",
        "Miles_per_Gallon": 23.2,
        "Cylinders": 4,
        "Displacement": 156,
        "Horsepower": 105,
        "Weight_in_lbs": 2745,
        "Acceleration": 16.7,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile starfire sx",
        "Miles_per_Gallon": 23.8,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 85,
        "Weight_in_lbs": 2855,
        "Acceleration": 17.6,
        "Year": "1978-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 200-sx",
        "Miles_per_Gallon": 23.9,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 97,
        "Weight_in_lbs": 2405,
        "Acceleration": 14.9,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "audi 5000",
        "Miles_per_Gallon": 20.3,
        "Cylinders": 5,
        "Displacement": 131,
        "Horsepower": 103,
        "Weight_in_lbs": 2830,
        "Acceleration": 15.9,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volvo 264gl",
        "Miles_per_Gallon": 17,
        "Cylinders": 6,
        "Displacement": 163,
        "Horsepower": 125,
        "Weight_in_lbs": 3140,
        "Acceleration": 13.6,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "saab 99gle",
        "Miles_per_Gallon": 21.6,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 115,
        "Weight_in_lbs": 2795,
        "Acceleration": 15.7,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "peugeot 604sl",
        "Miles_per_Gallon": 16.2,
        "Cylinders": 6,
        "Displacement": 163,
        "Horsepower": 133,
        "Weight_in_lbs": 3410,
        "Acceleration": 15.8,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volkswagen scirocco",
        "Miles_per_Gallon": 31.5,
        "Cylinders": 4,
        "Displacement": 89,
        "Horsepower": 71,
        "Weight_in_lbs": 1990,
        "Acceleration": 14.9,
        "Year": "1978-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda Accelerationord lx",
        "Miles_per_Gallon": 29.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 68,
        "Weight_in_lbs": 2135,
        "Acceleration": 16.6,
        "Year": "1978-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "pontiac lemans v6",
        "Miles_per_Gallon": 21.5,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 115,
        "Weight_in_lbs": 3245,
        "Acceleration": 15.4,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury zephyr 6",
        "Miles_per_Gallon": 19.8,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 85,
        "Weight_in_lbs": 2990,
        "Acceleration": 18.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford fairmont 4",
        "Miles_per_Gallon": 22.3,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 88,
        "Weight_in_lbs": 2890,
        "Acceleration": 17.3,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc concord dl 6",
        "Miles_per_Gallon": 20.2,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 90,
        "Weight_in_lbs": 3265,
        "Acceleration": 18.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge aspen 6",
        "Miles_per_Gallon": 20.6,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 110,
        "Weight_in_lbs": 3360,
        "Acceleration": 16.6,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet caprice classic",
        "Miles_per_Gallon": 17,
        "Cylinders": 8,
        "Displacement": 305,
        "Horsepower": 130,
        "Weight_in_lbs": 3840,
        "Acceleration": 15.4,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford ltd landau",
        "Miles_per_Gallon": 17.6,
        "Cylinders": 8,
        "Displacement": 302,
        "Horsepower": 129,
        "Weight_in_lbs": 3725,
        "Acceleration": 13.4,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury grand marquis",
        "Miles_per_Gallon": 16.5,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 138,
        "Weight_in_lbs": 3955,
        "Acceleration": 13.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge st. regis",
        "Miles_per_Gallon": 18.2,
        "Cylinders": 8,
        "Displacement": 318,
        "Horsepower": 135,
        "Weight_in_lbs": 3830,
        "Acceleration": 15.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick estate wagon (sw)",
        "Miles_per_Gallon": 16.9,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 155,
        "Weight_in_lbs": 4360,
        "Acceleration": 14.9,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford country squire (sw)",
        "Miles_per_Gallon": 15.5,
        "Cylinders": 8,
        "Displacement": 351,
        "Horsepower": 142,
        "Weight_in_lbs": 4054,
        "Acceleration": 14.3,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet malibu classic (sw)",
        "Miles_per_Gallon": 19.2,
        "Cylinders": 8,
        "Displacement": 267,
        "Horsepower": 125,
        "Weight_in_lbs": 3605,
        "Acceleration": 15,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler lebaron town @ country (sw)",
        "Miles_per_Gallon": 18.5,
        "Cylinders": 8,
        "Displacement": 360,
        "Horsepower": 150,
        "Weight_in_lbs": 3940,
        "Acceleration": 13,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "vw rabbit custom",
        "Miles_per_Gallon": 31.9,
        "Cylinders": 4,
        "Displacement": 89,
        "Horsepower": 71,
        "Weight_in_lbs": 1925,
        "Acceleration": 14,
        "Year": "1979-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "maxda glc deluxe",
        "Miles_per_Gallon": 34.1,
        "Cylinders": 4,
        "Displacement": 86,
        "Horsepower": 65,
        "Weight_in_lbs": 1975,
        "Acceleration": 15.2,
        "Year": "1979-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge colt hatchback custom",
        "Miles_per_Gallon": 35.7,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 80,
        "Weight_in_lbs": 1915,
        "Acceleration": 14.4,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc spirit dl",
        "Miles_per_Gallon": 27.4,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 80,
        "Weight_in_lbs": 2670,
        "Acceleration": 15,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercedes benz 300d",
        "Miles_per_Gallon": 25.4,
        "Cylinders": 5,
        "Displacement": 183,
        "Horsepower": 77,
        "Weight_in_lbs": 3530,
        "Acceleration": 20.1,
        "Year": "1979-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "cadillac eldorado",
        "Miles_per_Gallon": 23,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 125,
        "Weight_in_lbs": 3900,
        "Acceleration": 17.4,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "peugeot 504",
        "Miles_per_Gallon": 27.2,
        "Cylinders": 4,
        "Displacement": 141,
        "Horsepower": 71,
        "Weight_in_lbs": 3190,
        "Acceleration": 24.8,
        "Year": "1979-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "oldsmobile cutlass salon brougham",
        "Miles_per_Gallon": 23.9,
        "Cylinders": 8,
        "Displacement": 260,
        "Horsepower": 90,
        "Weight_in_lbs": 3420,
        "Acceleration": 22.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth horizon",
        "Miles_per_Gallon": 34.2,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 70,
        "Weight_in_lbs": 2200,
        "Acceleration": 13.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth horizon tc3",
        "Miles_per_Gallon": 34.5,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 70,
        "Weight_in_lbs": 2150,
        "Acceleration": 14.9,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 210",
        "Miles_per_Gallon": 31.8,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 65,
        "Weight_in_lbs": 2020,
        "Acceleration": 19.2,
        "Year": "1979-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "fiat strada custom",
        "Miles_per_Gallon": 37.3,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 69,
        "Weight_in_lbs": 2130,
        "Acceleration": 14.7,
        "Year": "1979-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "buick skylark limited",
        "Miles_per_Gallon": 28.4,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 2670,
        "Acceleration": 16,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet citation",
        "Miles_per_Gallon": 28.8,
        "Cylinders": 6,
        "Displacement": 173,
        "Horsepower": 115,
        "Weight_in_lbs": 2595,
        "Acceleration": 11.3,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile omega brougham",
        "Miles_per_Gallon": 26.8,
        "Cylinders": 6,
        "Displacement": 173,
        "Horsepower": 115,
        "Weight_in_lbs": 2700,
        "Acceleration": 12.9,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac phoenix",
        "Miles_per_Gallon": 33.5,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 2556,
        "Acceleration": 13.2,
        "Year": "1979-01-01",
        "Origin": "USA"
    },
    {
        "Name": "vw rabbit",
        "Miles_per_Gallon": 41.5,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 76,
        "Weight_in_lbs": 2144,
        "Acceleration": 14.7,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota corolla tercel",
        "Miles_per_Gallon": 38.1,
        "Cylinders": 4,
        "Displacement": 89,
        "Horsepower": 60,
        "Weight_in_lbs": 1968,
        "Acceleration": 18.8,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet chevette",
        "Miles_per_Gallon": 32.1,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 70,
        "Weight_in_lbs": 2120,
        "Acceleration": 15.5,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 310",
        "Miles_per_Gallon": 37.2,
        "Cylinders": 4,
        "Displacement": 86,
        "Horsepower": 65,
        "Weight_in_lbs": 2019,
        "Acceleration": 16.4,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "chevrolet citation",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 2678,
        "Acceleration": 16.5,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford fairmont",
        "Miles_per_Gallon": 26.4,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 88,
        "Weight_in_lbs": 2870,
        "Acceleration": 18.1,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc concord",
        "Miles_per_Gallon": 24.3,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 3003,
        "Acceleration": 20.1,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge aspen",
        "Miles_per_Gallon": 19.1,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 90,
        "Weight_in_lbs": 3381,
        "Acceleration": 18.7,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "audi 4000",
        "Miles_per_Gallon": 34.3,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 78,
        "Weight_in_lbs": 2188,
        "Acceleration": 15.8,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota corona liftback",
        "Miles_per_Gallon": 29.8,
        "Cylinders": 4,
        "Displacement": 134,
        "Horsepower": 90,
        "Weight_in_lbs": 2711,
        "Acceleration": 15.5,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda 626",
        "Miles_per_Gallon": 31.3,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 75,
        "Weight_in_lbs": 2542,
        "Acceleration": 17.5,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 510 hatchback",
        "Miles_per_Gallon": 37,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 92,
        "Weight_in_lbs": 2434,
        "Acceleration": 15,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyota corolla",
        "Miles_per_Gallon": 32.2,
        "Cylinders": 4,
        "Displacement": 108,
        "Horsepower": 75,
        "Weight_in_lbs": 2265,
        "Acceleration": 15.2,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda glc",
        "Miles_per_Gallon": 46.6,
        "Cylinders": 4,
        "Displacement": 86,
        "Horsepower": 65,
        "Weight_in_lbs": 2110,
        "Acceleration": 17.9,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge colt",
        "Miles_per_Gallon": 27.9,
        "Cylinders": 4,
        "Displacement": 156,
        "Horsepower": 105,
        "Weight_in_lbs": 2800,
        "Acceleration": 14.4,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "datsun 210",
        "Miles_per_Gallon": 40.8,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 65,
        "Weight_in_lbs": 2110,
        "Acceleration": 19.2,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "vw rabbit c (diesel)",
        "Miles_per_Gallon": 44.3,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 48,
        "Weight_in_lbs": 2085,
        "Acceleration": 21.7,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "vw dasher (diesel)",
        "Miles_per_Gallon": 43.4,
        "Cylinders": 4,
        "Displacement": 90,
        "Horsepower": 48,
        "Weight_in_lbs": 2335,
        "Acceleration": 23.7,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "audi 5000s (diesel)",
        "Miles_per_Gallon": 36.4,
        "Cylinders": 5,
        "Displacement": 121,
        "Horsepower": 67,
        "Weight_in_lbs": 2950,
        "Acceleration": 19.9,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "mercedes-benz 240d",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 146,
        "Horsepower": 67,
        "Weight_in_lbs": 3250,
        "Acceleration": 21.8,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda civic 1500 gl",
        "Miles_per_Gallon": 44.6,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 67,
        "Weight_in_lbs": 1850,
        "Acceleration": 13.8,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "renault lecar deluxe",
        "Miles_per_Gallon": 40.9,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": null,
        "Weight_in_lbs": 1835,
        "Acceleration": 17.3,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "subaru dl",
        "Miles_per_Gallon": 33.8,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 67,
        "Weight_in_lbs": 2145,
        "Acceleration": 18,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "vokswagen rabbit",
        "Miles_per_Gallon": 29.8,
        "Cylinders": 4,
        "Displacement": 89,
        "Horsepower": 62,
        "Weight_in_lbs": 1845,
        "Acceleration": 15.3,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "datsun 280-zx",
        "Miles_per_Gallon": 32.7,
        "Cylinders": 6,
        "Displacement": 168,
        "Horsepower": 132,
        "Weight_in_lbs": 2910,
        "Acceleration": 11.4,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda rx-7 gs",
        "Miles_per_Gallon": 23.7,
        "Cylinders": 3,
        "Displacement": 70,
        "Horsepower": 100,
        "Weight_in_lbs": 2420,
        "Acceleration": 12.5,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "triumph tr7 coupe",
        "Miles_per_Gallon": 35,
        "Cylinders": 4,
        "Displacement": 122,
        "Horsepower": 88,
        "Weight_in_lbs": 2500,
        "Acceleration": 15.1,
        "Year": "1980-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "ford mustang cobra",
        "Miles_per_Gallon": 23.6,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": null,
        "Weight_in_lbs": 2905,
        "Acceleration": 14.3,
        "Year": "1980-01-01",
        "Origin": "USA"
    },
    {
        "Name": "honda Accelerationord",
        "Miles_per_Gallon": 32.4,
        "Cylinders": 4,
        "Displacement": 107,
        "Horsepower": 72,
        "Weight_in_lbs": 2290,
        "Acceleration": 17,
        "Year": "1980-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth reliant",
        "Miles_per_Gallon": 27.2,
        "Cylinders": 4,
        "Displacement": 135,
        "Horsepower": 84,
        "Weight_in_lbs": 2490,
        "Acceleration": 15.7,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "buick skylark",
        "Miles_per_Gallon": 26.6,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 84,
        "Weight_in_lbs": 2635,
        "Acceleration": 16.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge aries wagon (sw)",
        "Miles_per_Gallon": 25.8,
        "Cylinders": 4,
        "Displacement": 156,
        "Horsepower": 92,
        "Weight_in_lbs": 2620,
        "Acceleration": 14.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet citation",
        "Miles_per_Gallon": 23.5,
        "Cylinders": 6,
        "Displacement": 173,
        "Horsepower": 110,
        "Weight_in_lbs": 2725,
        "Acceleration": 12.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "plymouth reliant",
        "Miles_per_Gallon": 30,
        "Cylinders": 4,
        "Displacement": 135,
        "Horsepower": 84,
        "Weight_in_lbs": 2385,
        "Acceleration": 12.9,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota starlet",
        "Miles_per_Gallon": 39.1,
        "Cylinders": 4,
        "Displacement": 79,
        "Horsepower": 58,
        "Weight_in_lbs": 1755,
        "Acceleration": 16.9,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth champ",
        "Miles_per_Gallon": 39,
        "Cylinders": 4,
        "Displacement": 86,
        "Horsepower": 64,
        "Weight_in_lbs": 1875,
        "Acceleration": 16.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "honda civic 1300",
        "Miles_per_Gallon": 35.1,
        "Cylinders": 4,
        "Displacement": 81,
        "Horsepower": 60,
        "Weight_in_lbs": 1760,
        "Acceleration": 16.1,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "subaru",
        "Miles_per_Gallon": 32.3,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 67,
        "Weight_in_lbs": 2065,
        "Acceleration": 17.8,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 210",
        "Miles_per_Gallon": 37,
        "Cylinders": 4,
        "Displacement": 85,
        "Horsepower": 65,
        "Weight_in_lbs": 1975,
        "Acceleration": 19.4,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyota tercel",
        "Miles_per_Gallon": 37.7,
        "Cylinders": 4,
        "Displacement": 89,
        "Horsepower": 62,
        "Weight_in_lbs": 2050,
        "Acceleration": 17.3,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda glc 4",
        "Miles_per_Gallon": 34.1,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 68,
        "Weight_in_lbs": 1985,
        "Acceleration": 16,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth horizon 4",
        "Miles_per_Gallon": 34.7,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 63,
        "Weight_in_lbs": 2215,
        "Acceleration": 14.9,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford escort 4w",
        "Miles_per_Gallon": 34.4,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 65,
        "Weight_in_lbs": 2045,
        "Acceleration": 16.2,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford escort 2h",
        "Miles_per_Gallon": 29.9,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 65,
        "Weight_in_lbs": 2380,
        "Acceleration": 20.7,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen jetta",
        "Miles_per_Gallon": 33,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 74,
        "Weight_in_lbs": 2190,
        "Acceleration": 14.2,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "renault 18i",
        "Miles_per_Gallon": 34.5,
        "Cylinders": 4,
        "Displacement": 100,
        "Horsepower": null,
        "Weight_in_lbs": 2320,
        "Acceleration": 15.8,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "honda prelude",
        "Miles_per_Gallon": 33.7,
        "Cylinders": 4,
        "Displacement": 107,
        "Horsepower": 75,
        "Weight_in_lbs": 2210,
        "Acceleration": 14.4,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyota corolla",
        "Miles_per_Gallon": 32.4,
        "Cylinders": 4,
        "Displacement": 108,
        "Horsepower": 75,
        "Weight_in_lbs": 2350,
        "Acceleration": 16.8,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 200sx",
        "Miles_per_Gallon": 32.9,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 100,
        "Weight_in_lbs": 2615,
        "Acceleration": 14.8,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda 626",
        "Miles_per_Gallon": 31.6,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 74,
        "Weight_in_lbs": 2635,
        "Acceleration": 18.3,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "peugeot 505s turbo diesel",
        "Miles_per_Gallon": 28.1,
        "Cylinders": 4,
        "Displacement": 141,
        "Horsepower": 80,
        "Weight_in_lbs": 3230,
        "Acceleration": 20.4,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "saab 900s",
        "Miles_per_Gallon": null,
        "Cylinders": 4,
        "Displacement": 121,
        "Horsepower": 110,
        "Weight_in_lbs": 2800,
        "Acceleration": 15.4,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "volvo diesel",
        "Miles_per_Gallon": 30.7,
        "Cylinders": 6,
        "Displacement": 145,
        "Horsepower": 76,
        "Weight_in_lbs": 3160,
        "Acceleration": 19.6,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "toyota cressida",
        "Miles_per_Gallon": 25.4,
        "Cylinders": 6,
        "Displacement": 168,
        "Horsepower": 116,
        "Weight_in_lbs": 2900,
        "Acceleration": 12.6,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 810 maxima",
        "Miles_per_Gallon": 24.2,
        "Cylinders": 6,
        "Displacement": 146,
        "Horsepower": 120,
        "Weight_in_lbs": 2930,
        "Acceleration": 13.8,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "buick century",
        "Miles_per_Gallon": 22.4,
        "Cylinders": 6,
        "Displacement": 231,
        "Horsepower": 110,
        "Weight_in_lbs": 3415,
        "Acceleration": 15.8,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile cutlass ls",
        "Miles_per_Gallon": 26.6,
        "Cylinders": 8,
        "Displacement": 350,
        "Horsepower": 105,
        "Weight_in_lbs": 3725,
        "Acceleration": 19,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford granada gl",
        "Miles_per_Gallon": 20.2,
        "Cylinders": 6,
        "Displacement": 200,
        "Horsepower": 88,
        "Weight_in_lbs": 3060,
        "Acceleration": 17.1,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler lebaron salon",
        "Miles_per_Gallon": 17.6,
        "Cylinders": 6,
        "Displacement": 225,
        "Horsepower": 85,
        "Weight_in_lbs": 3465,
        "Acceleration": 16.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet cavalier",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 112,
        "Horsepower": 88,
        "Weight_in_lbs": 2605,
        "Acceleration": 19.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet cavalier wagon",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 112,
        "Horsepower": 88,
        "Weight_in_lbs": 2640,
        "Acceleration": 18.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet cavalier 2-door",
        "Miles_per_Gallon": 34,
        "Cylinders": 4,
        "Displacement": 112,
        "Horsepower": 88,
        "Weight_in_lbs": 2395,
        "Acceleration": 18,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac j2000 se hatchback",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 112,
        "Horsepower": 85,
        "Weight_in_lbs": 2575,
        "Acceleration": 16.2,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "dodge aries se",
        "Miles_per_Gallon": 29,
        "Cylinders": 4,
        "Displacement": 135,
        "Horsepower": 84,
        "Weight_in_lbs": 2525,
        "Acceleration": 16,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "pontiac phoenix",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 2735,
        "Acceleration": 18,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford fairmont futura",
        "Miles_per_Gallon": 24,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 92,
        "Weight_in_lbs": 2865,
        "Acceleration": 16.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "amc concord dl",
        "Miles_per_Gallon": 23,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": null,
        "Weight_in_lbs": 3035,
        "Acceleration": 20.5,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "volkswagen rabbit l",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 74,
        "Weight_in_lbs": 1980,
        "Acceleration": 15.3,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "mazda glc custom l",
        "Miles_per_Gallon": 37,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 68,
        "Weight_in_lbs": 2025,
        "Acceleration": 18.2,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "mazda glc custom",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 68,
        "Weight_in_lbs": 1970,
        "Acceleration": 17.6,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "plymouth horizon miser",
        "Miles_per_Gallon": 38,
        "Cylinders": 4,
        "Displacement": 105,
        "Horsepower": 63,
        "Weight_in_lbs": 2125,
        "Acceleration": 14.7,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "mercury lynx l",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 98,
        "Horsepower": 70,
        "Weight_in_lbs": 2125,
        "Acceleration": 17.3,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "nissan stanza xe",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 88,
        "Weight_in_lbs": 2160,
        "Acceleration": 14.5,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "honda Accelerationord",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 107,
        "Horsepower": 75,
        "Weight_in_lbs": 2205,
        "Acceleration": 14.5,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "toyota corolla",
        "Miles_per_Gallon": 34,
        "Cylinders": 4,
        "Displacement": 108,
        "Horsepower": 70,
        "Weight_in_lbs": 2245,
        "Acceleration": 16.9,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "honda civic",
        "Miles_per_Gallon": 38,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 67,
        "Weight_in_lbs": 1965,
        "Acceleration": 15,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "honda civic (auto)",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 67,
        "Weight_in_lbs": 1965,
        "Acceleration": 15.7,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "datsun 310 gx",
        "Miles_per_Gallon": 38,
        "Cylinders": 4,
        "Displacement": 91,
        "Horsepower": 67,
        "Weight_in_lbs": 1995,
        "Acceleration": 16.2,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "buick century limited",
        "Miles_per_Gallon": 25,
        "Cylinders": 6,
        "Displacement": 181,
        "Horsepower": 110,
        "Weight_in_lbs": 2945,
        "Acceleration": 16.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "oldsmobile cutlass ciera (diesel)",
        "Miles_per_Gallon": 38,
        "Cylinders": 6,
        "Displacement": 262,
        "Horsepower": 85,
        "Weight_in_lbs": 3015,
        "Acceleration": 17,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chrysler lebaron medallion",
        "Miles_per_Gallon": 26,
        "Cylinders": 4,
        "Displacement": 156,
        "Horsepower": 92,
        "Weight_in_lbs": 2585,
        "Acceleration": 14.5,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford granada l",
        "Miles_per_Gallon": 22,
        "Cylinders": 6,
        "Displacement": 232,
        "Horsepower": 112,
        "Weight_in_lbs": 2835,
        "Acceleration": 14.7,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "toyota celica gt",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 144,
        "Horsepower": 96,
        "Weight_in_lbs": 2665,
        "Acceleration": 13.9,
        "Year": "1982-01-01",
        "Origin": "Japan"
    },
    {
        "Name": "dodge charger 2.2",
        "Miles_per_Gallon": 36,
        "Cylinders": 4,
        "Displacement": 135,
        "Horsepower": 84,
        "Weight_in_lbs": 2370,
        "Acceleration": 13,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevrolet camaro",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 151,
        "Horsepower": 90,
        "Weight_in_lbs": 2950,
        "Acceleration": 17.3,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford mustang gl",
        "Miles_per_Gallon": 27,
        "Cylinders": 4,
        "Displacement": 140,
        "Horsepower": 86,
        "Weight_in_lbs": 2790,
        "Acceleration": 15.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "vw pickup",
        "Miles_per_Gallon": 44,
        "Cylinders": 4,
        "Displacement": 97,
        "Horsepower": 52,
        "Weight_in_lbs": 2130,
        "Acceleration": 24.6,
        "Year": "1982-01-01",
        "Origin": "Europe"
    },
    {
        "Name": "dodge rampage",
        "Miles_per_Gallon": 32,
        "Cylinders": 4,
        "Displacement": 135,
        "Horsepower": 84,
        "Weight_in_lbs": 2295,
        "Acceleration": 11.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "ford ranger",
        "Miles_per_Gallon": 28,
        "Cylinders": 4,
        "Displacement": 120,
        "Horsepower": 79,
        "Weight_in_lbs": 2625,
        "Acceleration": 18.6,
        "Year": "1982-01-01",
        "Origin": "USA"
    },
    {
        "Name": "chevy s-10",
        "Miles_per_Gallon": 31,
        "Cylinders": 4,
        "Displacement": 119,
        "Horsepower": 82,
        "Weight_in_lbs": 2720,
        "Acceleration": 19.4,
        "Year": "1982-01-01",
        "Origin": "USA"
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="population-dataset">[
    {
        "year": 1850,
        "age": 0,
        "sex": 1,
        "people": 1483789
    },
    {
        "year": 1850,
        "age": 0,
        "sex": 2,
        "people": 1450376
    },
    {
        "year": 1850,
        "age": 5,
        "sex": 1,
        "people": 1411067
    },
    {
        "year": 1850,
        "age": 5,
        "sex": 2,
        "people": 1359668
    },
    {
        "year": 1850,
        "age": 10,
        "sex": 1,
        "people": 1260099
    },
    {
        "year": 1850,
        "age": 10,
        "sex": 2,
        "people": 1216114
    },
    {
        "year": 1850,
        "age": 15,
        "sex": 1,
        "people": 1077133
    },
    {
        "year": 1850,
        "age": 15,
        "sex": 2,
        "people": 1110619
    },
    {
        "year": 1850,
        "age": 20,
        "sex": 1,
        "people": 1017281
    },
    {
        "year": 1850,
        "age": 20,
        "sex": 2,
        "people": 1003841
    },
    {
        "year": 1850,
        "age": 25,
        "sex": 1,
        "people": 862547
    },
    {
        "year": 1850,
        "age": 25,
        "sex": 2,
        "people": 799482
    },
    {
        "year": 1850,
        "age": 30,
        "sex": 1,
        "people": 730638
    },
    {
        "year": 1850,
        "age": 30,
        "sex": 2,
        "people": 639636
    },
    {
        "year": 1850,
        "age": 35,
        "sex": 1,
        "people": 588487
    },
    {
        "year": 1850,
        "age": 35,
        "sex": 2,
        "people": 505012
    },
    {
        "year": 1850,
        "age": 40,
        "sex": 1,
        "people": 475911
    },
    {
        "year": 1850,
        "age": 40,
        "sex": 2,
        "people": 428185
    },
    {
        "year": 1850,
        "age": 45,
        "sex": 1,
        "people": 384211
    },
    {
        "year": 1850,
        "age": 45,
        "sex": 2,
        "people": 341254
    },
    {
        "year": 1850,
        "age": 50,
        "sex": 1,
        "people": 321343
    },
    {
        "year": 1850,
        "age": 50,
        "sex": 2,
        "people": 286580
    },
    {
        "year": 1850,
        "age": 55,
        "sex": 1,
        "people": 194080
    },
    {
        "year": 1850,
        "age": 55,
        "sex": 2,
        "people": 187208
    },
    {
        "year": 1850,
        "age": 60,
        "sex": 1,
        "people": 174976
    },
    {
        "year": 1850,
        "age": 60,
        "sex": 2,
        "people": 162236
    },
    {
        "year": 1850,
        "age": 65,
        "sex": 1,
        "people": 106827
    },
    {
        "year": 1850,
        "age": 65,
        "sex": 2,
        "people": 105534
    },
    {
        "year": 1850,
        "age": 70,
        "sex": 1,
        "people": 73677
    },
    {
        "year": 1850,
        "age": 70,
        "sex": 2,
        "people": 71762
    },
    {
        "year": 1850,
        "age": 75,
        "sex": 1,
        "people": 40834
    },
    {
        "year": 1850,
        "age": 75,
        "sex": 2,
        "people": 40229
    },
    {
        "year": 1850,
        "age": 80,
        "sex": 1,
        "people": 23449
    },
    {
        "year": 1850,
        "age": 80,
        "sex": 2,
        "people": 22949
    },
    {
        "year": 1850,
        "age": 85,
        "sex": 1,
        "people": 8186
    },
    {
        "year": 1850,
        "age": 85,
        "sex": 2,
        "people": 10511
    },
    {
        "year": 1850,
        "age": 90,
        "sex": 1,
        "people": 5259
    },
    {
        "year": 1850,
        "age": 90,
        "sex": 2,
        "people": 6569
    },
    {
        "year": 1860,
        "age": 0,
        "sex": 1,
        "people": 2120846
    },
    {
        "year": 1860,
        "age": 0,
        "sex": 2,
        "people": 2092162
    },
    {
        "year": 1860,
        "age": 5,
        "sex": 1,
        "people": 1804467
    },
    {
        "year": 1860,
        "age": 5,
        "sex": 2,
        "people": 1778772
    },
    {
        "year": 1860,
        "age": 10,
        "sex": 1,
        "people": 1612640
    },
    {
        "year": 1860,
        "age": 10,
        "sex": 2,
        "people": 1540350
    },
    {
        "year": 1860,
        "age": 15,
        "sex": 1,
        "people": 1438094
    },
    {
        "year": 1860,
        "age": 15,
        "sex": 2,
        "people": 1495999
    },
    {
        "year": 1860,
        "age": 20,
        "sex": 1,
        "people": 1351121
    },
    {
        "year": 1860,
        "age": 20,
        "sex": 2,
        "people": 1370462
    },
    {
        "year": 1860,
        "age": 25,
        "sex": 1,
        "people": 1217615
    },
    {
        "year": 1860,
        "age": 25,
        "sex": 2,
        "people": 1116373
    },
    {
        "year": 1860,
        "age": 30,
        "sex": 1,
        "people": 1043174
    },
    {
        "year": 1860,
        "age": 30,
        "sex": 2,
        "people": 936055
    },
    {
        "year": 1860,
        "age": 35,
        "sex": 1,
        "people": 866910
    },
    {
        "year": 1860,
        "age": 35,
        "sex": 2,
        "people": 737136
    },
    {
        "year": 1860,
        "age": 40,
        "sex": 1,
        "people": 699434
    },
    {
        "year": 1860,
        "age": 40,
        "sex": 2,
        "people": 616826
    },
    {
        "year": 1860,
        "age": 45,
        "sex": 1,
        "people": 552404
    },
    {
        "year": 1860,
        "age": 45,
        "sex": 2,
        "people": 461739
    },
    {
        "year": 1860,
        "age": 50,
        "sex": 1,
        "people": 456176
    },
    {
        "year": 1860,
        "age": 50,
        "sex": 2,
        "people": 407305
    },
    {
        "year": 1860,
        "age": 55,
        "sex": 1,
        "people": 292417
    },
    {
        "year": 1860,
        "age": 55,
        "sex": 2,
        "people": 267224
    },
    {
        "year": 1860,
        "age": 60,
        "sex": 1,
        "people": 260887
    },
    {
        "year": 1860,
        "age": 60,
        "sex": 2,
        "people": 249735
    },
    {
        "year": 1860,
        "age": 65,
        "sex": 1,
        "people": 149331
    },
    {
        "year": 1860,
        "age": 65,
        "sex": 2,
        "people": 141405
    },
    {
        "year": 1860,
        "age": 70,
        "sex": 1,
        "people": 98465
    },
    {
        "year": 1860,
        "age": 70,
        "sex": 2,
        "people": 101778
    },
    {
        "year": 1860,
        "age": 75,
        "sex": 1,
        "people": 56699
    },
    {
        "year": 1860,
        "age": 75,
        "sex": 2,
        "people": 57597
    },
    {
        "year": 1860,
        "age": 80,
        "sex": 1,
        "people": 29007
    },
    {
        "year": 1860,
        "age": 80,
        "sex": 2,
        "people": 29506
    },
    {
        "year": 1860,
        "age": 85,
        "sex": 1,
        "people": 10434
    },
    {
        "year": 1860,
        "age": 85,
        "sex": 2,
        "people": 14053
    },
    {
        "year": 1860,
        "age": 90,
        "sex": 1,
        "people": 7232
    },
    {
        "year": 1860,
        "age": 90,
        "sex": 2,
        "people": 6622
    },
    {
        "year": 1870,
        "age": 0,
        "sex": 1,
        "people": 2800083
    },
    {
        "year": 1870,
        "age": 0,
        "sex": 2,
        "people": 2717102
    },
    {
        "year": 1870,
        "age": 5,
        "sex": 1,
        "people": 2428469
    },
    {
        "year": 1870,
        "age": 5,
        "sex": 2,
        "people": 2393680
    },
    {
        "year": 1870,
        "age": 10,
        "sex": 1,
        "people": 2427341
    },
    {
        "year": 1870,
        "age": 10,
        "sex": 2,
        "people": 2342670
    },
    {
        "year": 1870,
        "age": 15,
        "sex": 1,
        "people": 1958390
    },
    {
        "year": 1870,
        "age": 15,
        "sex": 2,
        "people": 2077248
    },
    {
        "year": 1870,
        "age": 20,
        "sex": 1,
        "people": 1805303
    },
    {
        "year": 1870,
        "age": 20,
        "sex": 2,
        "people": 1909382
    },
    {
        "year": 1870,
        "age": 25,
        "sex": 1,
        "people": 1509059
    },
    {
        "year": 1870,
        "age": 25,
        "sex": 2,
        "people": 1574285
    },
    {
        "year": 1870,
        "age": 30,
        "sex": 1,
        "people": 1251534
    },
    {
        "year": 1870,
        "age": 30,
        "sex": 2,
        "people": 1275629
    },
    {
        "year": 1870,
        "age": 35,
        "sex": 1,
        "people": 1185336
    },
    {
        "year": 1870,
        "age": 35,
        "sex": 2,
        "people": 1137490
    },
    {
        "year": 1870,
        "age": 40,
        "sex": 1,
        "people": 968861
    },
    {
        "year": 1870,
        "age": 40,
        "sex": 2,
        "people": 944401
    },
    {
        "year": 1870,
        "age": 45,
        "sex": 1,
        "people": 852672
    },
    {
        "year": 1870,
        "age": 45,
        "sex": 2,
        "people": 747916
    },
    {
        "year": 1870,
        "age": 50,
        "sex": 1,
        "people": 736387
    },
    {
        "year": 1870,
        "age": 50,
        "sex": 2,
        "people": 637801
    },
    {
        "year": 1870,
        "age": 55,
        "sex": 1,
        "people": 486036
    },
    {
        "year": 1870,
        "age": 55,
        "sex": 2,
        "people": 407819
    },
    {
        "year": 1870,
        "age": 60,
        "sex": 1,
        "people": 399264
    },
    {
        "year": 1870,
        "age": 60,
        "sex": 2,
        "people": 374801
    },
    {
        "year": 1870,
        "age": 65,
        "sex": 1,
        "people": 260829
    },
    {
        "year": 1870,
        "age": 65,
        "sex": 2,
        "people": 239080
    },
    {
        "year": 1870,
        "age": 70,
        "sex": 1,
        "people": 173364
    },
    {
        "year": 1870,
        "age": 70,
        "sex": 2,
        "people": 165501
    },
    {
        "year": 1870,
        "age": 75,
        "sex": 1,
        "people": 86929
    },
    {
        "year": 1870,
        "age": 75,
        "sex": 2,
        "people": 89540
    },
    {
        "year": 1870,
        "age": 80,
        "sex": 1,
        "people": 47427
    },
    {
        "year": 1870,
        "age": 80,
        "sex": 2,
        "people": 54190
    },
    {
        "year": 1870,
        "age": 85,
        "sex": 1,
        "people": 15891
    },
    {
        "year": 1870,
        "age": 85,
        "sex": 2,
        "people": 19302
    },
    {
        "year": 1870,
        "age": 90,
        "sex": 1,
        "people": 8649
    },
    {
        "year": 1870,
        "age": 90,
        "sex": 2,
        "people": 13068
    },
    {
        "year": 1880,
        "age": 0,
        "sex": 1,
        "people": 3533662
    },
    {
        "year": 1880,
        "age": 0,
        "sex": 2,
        "people": 3421597
    },
    {
        "year": 1880,
        "age": 5,
        "sex": 1,
        "people": 3297503
    },
    {
        "year": 1880,
        "age": 5,
        "sex": 2,
        "people": 3179142
    },
    {
        "year": 1880,
        "age": 10,
        "sex": 1,
        "people": 2911924
    },
    {
        "year": 1880,
        "age": 10,
        "sex": 2,
        "people": 2813550
    },
    {
        "year": 1880,
        "age": 15,
        "sex": 1,
        "people": 2457734
    },
    {
        "year": 1880,
        "age": 15,
        "sex": 2,
        "people": 2527818
    },
    {
        "year": 1880,
        "age": 20,
        "sex": 1,
        "people": 2547780
    },
    {
        "year": 1880,
        "age": 20,
        "sex": 2,
        "people": 2512803
    },
    {
        "year": 1880,
        "age": 25,
        "sex": 1,
        "people": 2119393
    },
    {
        "year": 1880,
        "age": 25,
        "sex": 2,
        "people": 1974241
    },
    {
        "year": 1880,
        "age": 30,
        "sex": 1,
        "people": 1749107
    },
    {
        "year": 1880,
        "age": 30,
        "sex": 2,
        "people": 1596772
    },
    {
        "year": 1880,
        "age": 35,
        "sex": 1,
        "people": 1540772
    },
    {
        "year": 1880,
        "age": 35,
        "sex": 2,
        "people": 1483717
    },
    {
        "year": 1880,
        "age": 40,
        "sex": 1,
        "people": 1237347
    },
    {
        "year": 1880,
        "age": 40,
        "sex": 2,
        "people": 1239435
    },
    {
        "year": 1880,
        "age": 45,
        "sex": 1,
        "people": 1065973
    },
    {
        "year": 1880,
        "age": 45,
        "sex": 2,
        "people": 1003711
    },
    {
        "year": 1880,
        "age": 50,
        "sex": 1,
        "people": 964484
    },
    {
        "year": 1880,
        "age": 50,
        "sex": 2,
        "people": 863012
    },
    {
        "year": 1880,
        "age": 55,
        "sex": 1,
        "people": 679147
    },
    {
        "year": 1880,
        "age": 55,
        "sex": 2,
        "people": 594843
    },
    {
        "year": 1880,
        "age": 60,
        "sex": 1,
        "people": 580298
    },
    {
        "year": 1880,
        "age": 60,
        "sex": 2,
        "people": 526956
    },
    {
        "year": 1880,
        "age": 65,
        "sex": 1,
        "people": 369398
    },
    {
        "year": 1880,
        "age": 65,
        "sex": 2,
        "people": 346303
    },
    {
        "year": 1880,
        "age": 70,
        "sex": 1,
        "people": 255422
    },
    {
        "year": 1880,
        "age": 70,
        "sex": 2,
        "people": 251860
    },
    {
        "year": 1880,
        "age": 75,
        "sex": 1,
        "people": 141628
    },
    {
        "year": 1880,
        "age": 75,
        "sex": 2,
        "people": 143513
    },
    {
        "year": 1880,
        "age": 80,
        "sex": 1,
        "people": 67526
    },
    {
        "year": 1880,
        "age": 80,
        "sex": 2,
        "people": 77290
    },
    {
        "year": 1880,
        "age": 85,
        "sex": 1,
        "people": 22437
    },
    {
        "year": 1880,
        "age": 85,
        "sex": 2,
        "people": 31227
    },
    {
        "year": 1880,
        "age": 90,
        "sex": 1,
        "people": 10272
    },
    {
        "year": 1880,
        "age": 90,
        "sex": 2,
        "people": 15451
    },
    {
        "year": 1900,
        "age": 0,
        "sex": 1,
        "people": 4619544
    },
    {
        "year": 1900,
        "age": 0,
        "sex": 2,
        "people": 4589196
    },
    {
        "year": 1900,
        "age": 5,
        "sex": 1,
        "people": 4465783
    },
    {
        "year": 1900,
        "age": 5,
        "sex": 2,
        "people": 4390483
    },
    {
        "year": 1900,
        "age": 10,
        "sex": 1,
        "people": 4057669
    },
    {
        "year": 1900,
        "age": 10,
        "sex": 2,
        "people": 4001749
    },
    {
        "year": 1900,
        "age": 15,
        "sex": 1,
        "people": 3774846
    },
    {
        "year": 1900,
        "age": 15,
        "sex": 2,
        "people": 3801743
    },
    {
        "year": 1900,
        "age": 20,
        "sex": 1,
        "people": 3694038
    },
    {
        "year": 1900,
        "age": 20,
        "sex": 2,
        "people": 3751061
    },
    {
        "year": 1900,
        "age": 25,
        "sex": 1,
        "people": 3389280
    },
    {
        "year": 1900,
        "age": 25,
        "sex": 2,
        "people": 3236056
    },
    {
        "year": 1900,
        "age": 30,
        "sex": 1,
        "people": 2918964
    },
    {
        "year": 1900,
        "age": 30,
        "sex": 2,
        "people": 2665174
    },
    {
        "year": 1900,
        "age": 35,
        "sex": 1,
        "people": 2633883
    },
    {
        "year": 1900,
        "age": 35,
        "sex": 2,
        "people": 2347737
    },
    {
        "year": 1900,
        "age": 40,
        "sex": 1,
        "people": 2261070
    },
    {
        "year": 1900,
        "age": 40,
        "sex": 2,
        "people": 2004987
    },
    {
        "year": 1900,
        "age": 45,
        "sex": 1,
        "people": 1868413
    },
    {
        "year": 1900,
        "age": 45,
        "sex": 2,
        "people": 1648025
    },
    {
        "year": 1900,
        "age": 50,
        "sex": 1,
        "people": 1571038
    },
    {
        "year": 1900,
        "age": 50,
        "sex": 2,
        "people": 1411981
    },
    {
        "year": 1900,
        "age": 55,
        "sex": 1,
        "people": 1161908
    },
    {
        "year": 1900,
        "age": 55,
        "sex": 2,
        "people": 1064632
    },
    {
        "year": 1900,
        "age": 60,
        "sex": 1,
        "people": 916571
    },
    {
        "year": 1900,
        "age": 60,
        "sex": 2,
        "people": 887508
    },
    {
        "year": 1900,
        "age": 65,
        "sex": 1,
        "people": 672663
    },
    {
        "year": 1900,
        "age": 65,
        "sex": 2,
        "people": 640212
    },
    {
        "year": 1900,
        "age": 70,
        "sex": 1,
        "people": 454747
    },
    {
        "year": 1900,
        "age": 70,
        "sex": 2,
        "people": 440007
    },
    {
        "year": 1900,
        "age": 75,
        "sex": 1,
        "people": 268211
    },
    {
        "year": 1900,
        "age": 75,
        "sex": 2,
        "people": 265879
    },
    {
        "year": 1900,
        "age": 80,
        "sex": 1,
        "people": 127435
    },
    {
        "year": 1900,
        "age": 80,
        "sex": 2,
        "people": 132449
    },
    {
        "year": 1900,
        "age": 85,
        "sex": 1,
        "people": 44008
    },
    {
        "year": 1900,
        "age": 85,
        "sex": 2,
        "people": 48614
    },
    {
        "year": 1900,
        "age": 90,
        "sex": 1,
        "people": 15164
    },
    {
        "year": 1900,
        "age": 90,
        "sex": 2,
        "people": 20093
    },
    {
        "year": 1910,
        "age": 0,
        "sex": 1,
        "people": 5296823
    },
    {
        "year": 1910,
        "age": 0,
        "sex": 2,
        "people": 5287477
    },
    {
        "year": 1910,
        "age": 5,
        "sex": 1,
        "people": 4991803
    },
    {
        "year": 1910,
        "age": 5,
        "sex": 2,
        "people": 4866139
    },
    {
        "year": 1910,
        "age": 10,
        "sex": 1,
        "people": 4650747
    },
    {
        "year": 1910,
        "age": 10,
        "sex": 2,
        "people": 4471887
    },
    {
        "year": 1910,
        "age": 15,
        "sex": 1,
        "people": 4566154
    },
    {
        "year": 1910,
        "age": 15,
        "sex": 2,
        "people": 4592269
    },
    {
        "year": 1910,
        "age": 20,
        "sex": 1,
        "people": 4637632
    },
    {
        "year": 1910,
        "age": 20,
        "sex": 2,
        "people": 4447683
    },
    {
        "year": 1910,
        "age": 25,
        "sex": 1,
        "people": 4257755
    },
    {
        "year": 1910,
        "age": 25,
        "sex": 2,
        "people": 3946153
    },
    {
        "year": 1910,
        "age": 30,
        "sex": 1,
        "people": 3658125
    },
    {
        "year": 1910,
        "age": 30,
        "sex": 2,
        "people": 3295220
    },
    {
        "year": 1910,
        "age": 35,
        "sex": 1,
        "people": 3427518
    },
    {
        "year": 1910,
        "age": 35,
        "sex": 2,
        "people": 3088990
    },
    {
        "year": 1910,
        "age": 40,
        "sex": 1,
        "people": 2860229
    },
    {
        "year": 1910,
        "age": 40,
        "sex": 2,
        "people": 2471267
    },
    {
        "year": 1910,
        "age": 45,
        "sex": 1,
        "people": 2363801
    },
    {
        "year": 1910,
        "age": 45,
        "sex": 2,
        "people": 2114930
    },
    {
        "year": 1910,
        "age": 50,
        "sex": 1,
        "people": 2126516
    },
    {
        "year": 1910,
        "age": 50,
        "sex": 2,
        "people": 1773592
    },
    {
        "year": 1910,
        "age": 55,
        "sex": 1,
        "people": 1508358
    },
    {
        "year": 1910,
        "age": 55,
        "sex": 2,
        "people": 1317651
    },
    {
        "year": 1910,
        "age": 60,
        "sex": 1,
        "people": 1189421
    },
    {
        "year": 1910,
        "age": 60,
        "sex": 2,
        "people": 1090697
    },
    {
        "year": 1910,
        "age": 65,
        "sex": 1,
        "people": 850159
    },
    {
        "year": 1910,
        "age": 65,
        "sex": 2,
        "people": 813868
    },
    {
        "year": 1910,
        "age": 70,
        "sex": 1,
        "people": 557936
    },
    {
        "year": 1910,
        "age": 70,
        "sex": 2,
        "people": 547623
    },
    {
        "year": 1910,
        "age": 75,
        "sex": 1,
        "people": 322679
    },
    {
        "year": 1910,
        "age": 75,
        "sex": 2,
        "people": 350900
    },
    {
        "year": 1910,
        "age": 80,
        "sex": 1,
        "people": 161715
    },
    {
        "year": 1910,
        "age": 80,
        "sex": 2,
        "people": 174315
    },
    {
        "year": 1910,
        "age": 85,
        "sex": 1,
        "people": 59699
    },
    {
        "year": 1910,
        "age": 85,
        "sex": 2,
        "people": 62725
    },
    {
        "year": 1910,
        "age": 90,
        "sex": 1,
        "people": 23929
    },
    {
        "year": 1910,
        "age": 90,
        "sex": 2,
        "people": 28965
    },
    {
        "year": 1920,
        "age": 0,
        "sex": 1,
        "people": 5934792
    },
    {
        "year": 1920,
        "age": 0,
        "sex": 2,
        "people": 5694244
    },
    {
        "year": 1920,
        "age": 5,
        "sex": 1,
        "people": 5789008
    },
    {
        "year": 1920,
        "age": 5,
        "sex": 2,
        "people": 5693960
    },
    {
        "year": 1920,
        "age": 10,
        "sex": 1,
        "people": 5401156
    },
    {
        "year": 1920,
        "age": 10,
        "sex": 2,
        "people": 5293057
    },
    {
        "year": 1920,
        "age": 15,
        "sex": 1,
        "people": 4724365
    },
    {
        "year": 1920,
        "age": 15,
        "sex": 2,
        "people": 4779936
    },
    {
        "year": 1920,
        "age": 20,
        "sex": 1,
        "people": 4549411
    },
    {
        "year": 1920,
        "age": 20,
        "sex": 2,
        "people": 4742632
    },
    {
        "year": 1920,
        "age": 25,
        "sex": 1,
        "people": 4565066
    },
    {
        "year": 1920,
        "age": 25,
        "sex": 2,
        "people": 4529382
    },
    {
        "year": 1920,
        "age": 30,
        "sex": 1,
        "people": 4110771
    },
    {
        "year": 1920,
        "age": 30,
        "sex": 2,
        "people": 3982426
    },
    {
        "year": 1920,
        "age": 35,
        "sex": 1,
        "people": 4081543
    },
    {
        "year": 1920,
        "age": 35,
        "sex": 2,
        "people": 3713810
    },
    {
        "year": 1920,
        "age": 40,
        "sex": 1,
        "people": 3321923
    },
    {
        "year": 1920,
        "age": 40,
        "sex": 2,
        "people": 3059757
    },
    {
        "year": 1920,
        "age": 45,
        "sex": 1,
        "people": 3143891
    },
    {
        "year": 1920,
        "age": 45,
        "sex": 2,
        "people": 2669089
    },
    {
        "year": 1920,
        "age": 50,
        "sex": 1,
        "people": 2546035
    },
    {
        "year": 1920,
        "age": 50,
        "sex": 2,
        "people": 2200491
    },
    {
        "year": 1920,
        "age": 55,
        "sex": 1,
        "people": 1880975
    },
    {
        "year": 1920,
        "age": 55,
        "sex": 2,
        "people": 1674672
    },
    {
        "year": 1920,
        "age": 60,
        "sex": 1,
        "people": 1587549
    },
    {
        "year": 1920,
        "age": 60,
        "sex": 2,
        "people": 1382877
    },
    {
        "year": 1920,
        "age": 65,
        "sex": 1,
        "people": 1095956
    },
    {
        "year": 1920,
        "age": 65,
        "sex": 2,
        "people": 989901
    },
    {
        "year": 1920,
        "age": 70,
        "sex": 1,
        "people": 714618
    },
    {
        "year": 1920,
        "age": 70,
        "sex": 2,
        "people": 690097
    },
    {
        "year": 1920,
        "age": 75,
        "sex": 1,
        "people": 417292
    },
    {
        "year": 1920,
        "age": 75,
        "sex": 2,
        "people": 439465
    },
    {
        "year": 1920,
        "age": 80,
        "sex": 1,
        "people": 187000
    },
    {
        "year": 1920,
        "age": 80,
        "sex": 2,
        "people": 211110
    },
    {
        "year": 1920,
        "age": 85,
        "sex": 1,
        "people": 75991
    },
    {
        "year": 1920,
        "age": 85,
        "sex": 2,
        "people": 92829
    },
    {
        "year": 1920,
        "age": 90,
        "sex": 1,
        "people": 22398
    },
    {
        "year": 1920,
        "age": 90,
        "sex": 2,
        "people": 32085
    },
    {
        "year": 1930,
        "age": 0,
        "sex": 1,
        "people": 5875250
    },
    {
        "year": 1930,
        "age": 0,
        "sex": 2,
        "people": 5662530
    },
    {
        "year": 1930,
        "age": 5,
        "sex": 1,
        "people": 6542592
    },
    {
        "year": 1930,
        "age": 5,
        "sex": 2,
        "people": 6129561
    },
    {
        "year": 1930,
        "age": 10,
        "sex": 1,
        "people": 6064820
    },
    {
        "year": 1930,
        "age": 10,
        "sex": 2,
        "people": 5986529
    },
    {
        "year": 1930,
        "age": 15,
        "sex": 1,
        "people": 5709452
    },
    {
        "year": 1930,
        "age": 15,
        "sex": 2,
        "people": 5769587
    },
    {
        "year": 1930,
        "age": 20,
        "sex": 1,
        "people": 5305992
    },
    {
        "year": 1930,
        "age": 20,
        "sex": 2,
        "people": 5565382
    },
    {
        "year": 1930,
        "age": 25,
        "sex": 1,
        "people": 4929853
    },
    {
        "year": 1930,
        "age": 25,
        "sex": 2,
        "people": 5050229
    },
    {
        "year": 1930,
        "age": 30,
        "sex": 1,
        "people": 4424408
    },
    {
        "year": 1930,
        "age": 30,
        "sex": 2,
        "people": 4455213
    },
    {
        "year": 1930,
        "age": 35,
        "sex": 1,
        "people": 4576531
    },
    {
        "year": 1930,
        "age": 35,
        "sex": 2,
        "people": 4593776
    },
    {
        "year": 1930,
        "age": 40,
        "sex": 1,
        "people": 4075139
    },
    {
        "year": 1930,
        "age": 40,
        "sex": 2,
        "people": 3754022
    },
    {
        "year": 1930,
        "age": 45,
        "sex": 1,
        "people": 3633152
    },
    {
        "year": 1930,
        "age": 45,
        "sex": 2,
        "people": 3396558
    },
    {
        "year": 1930,
        "age": 50,
        "sex": 1,
        "people": 3128108
    },
    {
        "year": 1930,
        "age": 50,
        "sex": 2,
        "people": 2809191
    },
    {
        "year": 1930,
        "age": 55,
        "sex": 1,
        "people": 2434077
    },
    {
        "year": 1930,
        "age": 55,
        "sex": 2,
        "people": 2298614
    },
    {
        "year": 1930,
        "age": 60,
        "sex": 1,
        "people": 1927564
    },
    {
        "year": 1930,
        "age": 60,
        "sex": 2,
        "people": 1783515
    },
    {
        "year": 1930,
        "age": 65,
        "sex": 1,
        "people": 1397275
    },
    {
        "year": 1930,
        "age": 65,
        "sex": 2,
        "people": 1307312
    },
    {
        "year": 1930,
        "age": 70,
        "sex": 1,
        "people": 919045
    },
    {
        "year": 1930,
        "age": 70,
        "sex": 2,
        "people": 918509
    },
    {
        "year": 1930,
        "age": 75,
        "sex": 1,
        "people": 536375
    },
    {
        "year": 1930,
        "age": 75,
        "sex": 2,
        "people": 522716
    },
    {
        "year": 1930,
        "age": 80,
        "sex": 1,
        "people": 246708
    },
    {
        "year": 1930,
        "age": 80,
        "sex": 2,
        "people": 283579
    },
    {
        "year": 1930,
        "age": 85,
        "sex": 1,
        "people": 88978
    },
    {
        "year": 1930,
        "age": 85,
        "sex": 2,
        "people": 109210
    },
    {
        "year": 1930,
        "age": 90,
        "sex": 1,
        "people": 30338
    },
    {
        "year": 1930,
        "age": 90,
        "sex": 2,
        "people": 43483
    },
    {
        "year": 1940,
        "age": 0,
        "sex": 1,
        "people": 5294628
    },
    {
        "year": 1940,
        "age": 0,
        "sex": 2,
        "people": 5124653
    },
    {
        "year": 1940,
        "age": 5,
        "sex": 1,
        "people": 5468378
    },
    {
        "year": 1940,
        "age": 5,
        "sex": 2,
        "people": 5359099
    },
    {
        "year": 1940,
        "age": 10,
        "sex": 1,
        "people": 5960416
    },
    {
        "year": 1940,
        "age": 10,
        "sex": 2,
        "people": 5868532
    },
    {
        "year": 1940,
        "age": 15,
        "sex": 1,
        "people": 6165109
    },
    {
        "year": 1940,
        "age": 15,
        "sex": 2,
        "people": 6193701
    },
    {
        "year": 1940,
        "age": 20,
        "sex": 1,
        "people": 5682414
    },
    {
        "year": 1940,
        "age": 20,
        "sex": 2,
        "people": 5896002
    },
    {
        "year": 1940,
        "age": 25,
        "sex": 1,
        "people": 5438166
    },
    {
        "year": 1940,
        "age": 25,
        "sex": 2,
        "people": 5664244
    },
    {
        "year": 1940,
        "age": 30,
        "sex": 1,
        "people": 5040048
    },
    {
        "year": 1940,
        "age": 30,
        "sex": 2,
        "people": 5171522
    },
    {
        "year": 1940,
        "age": 35,
        "sex": 1,
        "people": 4724804
    },
    {
        "year": 1940,
        "age": 35,
        "sex": 2,
        "people": 4791809
    },
    {
        "year": 1940,
        "age": 40,
        "sex": 1,
        "people": 4437392
    },
    {
        "year": 1940,
        "age": 40,
        "sex": 2,
        "people": 4394061
    },
    {
        "year": 1940,
        "age": 45,
        "sex": 1,
        "people": 4190187
    },
    {
        "year": 1940,
        "age": 45,
        "sex": 2,
        "people": 4050290
    },
    {
        "year": 1940,
        "age": 50,
        "sex": 1,
        "people": 3785735
    },
    {
        "year": 1940,
        "age": 50,
        "sex": 2,
        "people": 3488396
    },
    {
        "year": 1940,
        "age": 55,
        "sex": 1,
        "people": 2972069
    },
    {
        "year": 1940,
        "age": 55,
        "sex": 2,
        "people": 2810000
    },
    {
        "year": 1940,
        "age": 60,
        "sex": 1,
        "people": 2370232
    },
    {
        "year": 1940,
        "age": 60,
        "sex": 2,
        "people": 2317790
    },
    {
        "year": 1940,
        "age": 65,
        "sex": 1,
        "people": 1897678
    },
    {
        "year": 1940,
        "age": 65,
        "sex": 2,
        "people": 1911117
    },
    {
        "year": 1940,
        "age": 70,
        "sex": 1,
        "people": 1280023
    },
    {
        "year": 1940,
        "age": 70,
        "sex": 2,
        "people": 1287711
    },
    {
        "year": 1940,
        "age": 75,
        "sex": 1,
        "people": 713875
    },
    {
        "year": 1940,
        "age": 75,
        "sex": 2,
        "people": 764915
    },
    {
        "year": 1940,
        "age": 80,
        "sex": 1,
        "people": 359418
    },
    {
        "year": 1940,
        "age": 80,
        "sex": 2,
        "people": 414761
    },
    {
        "year": 1940,
        "age": 85,
        "sex": 1,
        "people": 127303
    },
    {
        "year": 1940,
        "age": 85,
        "sex": 2,
        "people": 152131
    },
    {
        "year": 1940,
        "age": 90,
        "sex": 1,
        "people": 42263
    },
    {
        "year": 1940,
        "age": 90,
        "sex": 2,
        "people": 58119
    },
    {
        "year": 1950,
        "age": 0,
        "sex": 1,
        "people": 8211806
    },
    {
        "year": 1950,
        "age": 0,
        "sex": 2,
        "people": 7862267
    },
    {
        "year": 1950,
        "age": 5,
        "sex": 1,
        "people": 6706601
    },
    {
        "year": 1950,
        "age": 5,
        "sex": 2,
        "people": 6450863
    },
    {
        "year": 1950,
        "age": 10,
        "sex": 1,
        "people": 5629744
    },
    {
        "year": 1950,
        "age": 10,
        "sex": 2,
        "people": 5430835
    },
    {
        "year": 1950,
        "age": 15,
        "sex": 1,
        "people": 5264129
    },
    {
        "year": 1950,
        "age": 15,
        "sex": 2,
        "people": 5288742
    },
    {
        "year": 1950,
        "age": 20,
        "sex": 1,
        "people": 5573308
    },
    {
        "year": 1950,
        "age": 20,
        "sex": 2,
        "people": 5854227
    },
    {
        "year": 1950,
        "age": 25,
        "sex": 1,
        "people": 6007254
    },
    {
        "year": 1950,
        "age": 25,
        "sex": 2,
        "people": 6317332
    },
    {
        "year": 1950,
        "age": 30,
        "sex": 1,
        "people": 5676022
    },
    {
        "year": 1950,
        "age": 30,
        "sex": 2,
        "people": 5895178
    },
    {
        "year": 1950,
        "age": 35,
        "sex": 1,
        "people": 5511364
    },
    {
        "year": 1950,
        "age": 35,
        "sex": 2,
        "people": 5696261
    },
    {
        "year": 1950,
        "age": 40,
        "sex": 1,
        "people": 5076985
    },
    {
        "year": 1950,
        "age": 40,
        "sex": 2,
        "people": 5199224
    },
    {
        "year": 1950,
        "age": 45,
        "sex": 1,
        "people": 4533177
    },
    {
        "year": 1950,
        "age": 45,
        "sex": 2,
        "people": 4595842
    },
    {
        "year": 1950,
        "age": 50,
        "sex": 1,
        "people": 4199164
    },
    {
        "year": 1950,
        "age": 50,
        "sex": 2,
        "people": 4147295
    },
    {
        "year": 1950,
        "age": 55,
        "sex": 1,
        "people": 3667351
    },
    {
        "year": 1950,
        "age": 55,
        "sex": 2,
        "people": 3595158
    },
    {
        "year": 1950,
        "age": 60,
        "sex": 1,
        "people": 3035038
    },
    {
        "year": 1950,
        "age": 60,
        "sex": 2,
        "people": 3009768
    },
    {
        "year": 1950,
        "age": 65,
        "sex": 1,
        "people": 2421234
    },
    {
        "year": 1950,
        "age": 65,
        "sex": 2,
        "people": 2548250
    },
    {
        "year": 1950,
        "age": 70,
        "sex": 1,
        "people": 1627920
    },
    {
        "year": 1950,
        "age": 70,
        "sex": 2,
        "people": 1786831
    },
    {
        "year": 1950,
        "age": 75,
        "sex": 1,
        "people": 1006530
    },
    {
        "year": 1950,
        "age": 75,
        "sex": 2,
        "people": 1148469
    },
    {
        "year": 1950,
        "age": 80,
        "sex": 1,
        "people": 511727
    },
    {
        "year": 1950,
        "age": 80,
        "sex": 2,
        "people": 637717
    },
    {
        "year": 1950,
        "age": 85,
        "sex": 1,
        "people": 182821
    },
    {
        "year": 1950,
        "age": 85,
        "sex": 2,
        "people": 242798
    },
    {
        "year": 1950,
        "age": 90,
        "sex": 1,
        "people": 54836
    },
    {
        "year": 1950,
        "age": 90,
        "sex": 2,
        "people": 90766
    },
    {
        "year": 1960,
        "age": 0,
        "sex": 1,
        "people": 10374975
    },
    {
        "year": 1960,
        "age": 0,
        "sex": 2,
        "people": 10146999
    },
    {
        "year": 1960,
        "age": 5,
        "sex": 1,
        "people": 9495503
    },
    {
        "year": 1960,
        "age": 5,
        "sex": 2,
        "people": 9250741
    },
    {
        "year": 1960,
        "age": 10,
        "sex": 1,
        "people": 8563700
    },
    {
        "year": 1960,
        "age": 10,
        "sex": 2,
        "people": 8310764
    },
    {
        "year": 1960,
        "age": 15,
        "sex": 1,
        "people": 6620902
    },
    {
        "year": 1960,
        "age": 15,
        "sex": 2,
        "people": 6617493
    },
    {
        "year": 1960,
        "age": 20,
        "sex": 1,
        "people": 5268384
    },
    {
        "year": 1960,
        "age": 20,
        "sex": 2,
        "people": 5513495
    },
    {
        "year": 1960,
        "age": 25,
        "sex": 1,
        "people": 5311805
    },
    {
        "year": 1960,
        "age": 25,
        "sex": 2,
        "people": 5548259
    },
    {
        "year": 1960,
        "age": 30,
        "sex": 1,
        "people": 5801342
    },
    {
        "year": 1960,
        "age": 30,
        "sex": 2,
        "people": 6090862
    },
    {
        "year": 1960,
        "age": 35,
        "sex": 1,
        "people": 6063063
    },
    {
        "year": 1960,
        "age": 35,
        "sex": 2,
        "people": 6431337
    },
    {
        "year": 1960,
        "age": 40,
        "sex": 1,
        "people": 5657943
    },
    {
        "year": 1960,
        "age": 40,
        "sex": 2,
        "people": 5940520
    },
    {
        "year": 1960,
        "age": 45,
        "sex": 1,
        "people": 5345658
    },
    {
        "year": 1960,
        "age": 45,
        "sex": 2,
        "people": 5516028
    },
    {
        "year": 1960,
        "age": 50,
        "sex": 1,
        "people": 4763364
    },
    {
        "year": 1960,
        "age": 50,
        "sex": 2,
        "people": 4928844
    },
    {
        "year": 1960,
        "age": 55,
        "sex": 1,
        "people": 4170581
    },
    {
        "year": 1960,
        "age": 55,
        "sex": 2,
        "people": 4402878
    },
    {
        "year": 1960,
        "age": 60,
        "sex": 1,
        "people": 3405293
    },
    {
        "year": 1960,
        "age": 60,
        "sex": 2,
        "people": 3723839
    },
    {
        "year": 1960,
        "age": 65,
        "sex": 1,
        "people": 2859371
    },
    {
        "year": 1960,
        "age": 65,
        "sex": 2,
        "people": 3268699
    },
    {
        "year": 1960,
        "age": 70,
        "sex": 1,
        "people": 2115763
    },
    {
        "year": 1960,
        "age": 70,
        "sex": 2,
        "people": 2516479
    },
    {
        "year": 1960,
        "age": 75,
        "sex": 1,
        "people": 1308913
    },
    {
        "year": 1960,
        "age": 75,
        "sex": 2,
        "people": 1641371
    },
    {
        "year": 1960,
        "age": 80,
        "sex": 1,
        "people": 619923
    },
    {
        "year": 1960,
        "age": 80,
        "sex": 2,
        "people": 856952
    },
    {
        "year": 1960,
        "age": 85,
        "sex": 1,
        "people": 253245
    },
    {
        "year": 1960,
        "age": 85,
        "sex": 2,
        "people": 384572
    },
    {
        "year": 1960,
        "age": 90,
        "sex": 1,
        "people": 75908
    },
    {
        "year": 1960,
        "age": 90,
        "sex": 2,
        "people": 135774
    },
    {
        "year": 1970,
        "age": 0,
        "sex": 1,
        "people": 8685121
    },
    {
        "year": 1970,
        "age": 0,
        "sex": 2,
        "people": 8326887
    },
    {
        "year": 1970,
        "age": 5,
        "sex": 1,
        "people": 10411131
    },
    {
        "year": 1970,
        "age": 5,
        "sex": 2,
        "people": 10003293
    },
    {
        "year": 1970,
        "age": 10,
        "sex": 1,
        "people": 10756403
    },
    {
        "year": 1970,
        "age": 10,
        "sex": 2,
        "people": 10343538
    },
    {
        "year": 1970,
        "age": 15,
        "sex": 1,
        "people": 9605399
    },
    {
        "year": 1970,
        "age": 15,
        "sex": 2,
        "people": 9414284
    },
    {
        "year": 1970,
        "age": 20,
        "sex": 1,
        "people": 7729202
    },
    {
        "year": 1970,
        "age": 20,
        "sex": 2,
        "people": 8341830
    },
    {
        "year": 1970,
        "age": 25,
        "sex": 1,
        "people": 6539301
    },
    {
        "year": 1970,
        "age": 25,
        "sex": 2,
        "people": 6903041
    },
    {
        "year": 1970,
        "age": 30,
        "sex": 1,
        "people": 5519879
    },
    {
        "year": 1970,
        "age": 30,
        "sex": 2,
        "people": 5851441
    },
    {
        "year": 1970,
        "age": 35,
        "sex": 1,
        "people": 5396732
    },
    {
        "year": 1970,
        "age": 35,
        "sex": 2,
        "people": 5708021
    },
    {
        "year": 1970,
        "age": 40,
        "sex": 1,
        "people": 5718538
    },
    {
        "year": 1970,
        "age": 40,
        "sex": 2,
        "people": 6129319
    },
    {
        "year": 1970,
        "age": 45,
        "sex": 1,
        "people": 5794120
    },
    {
        "year": 1970,
        "age": 45,
        "sex": 2,
        "people": 6198742
    },
    {
        "year": 1970,
        "age": 50,
        "sex": 1,
        "people": 5298312
    },
    {
        "year": 1970,
        "age": 50,
        "sex": 2,
        "people": 5783817
    },
    {
        "year": 1970,
        "age": 55,
        "sex": 1,
        "people": 4762911
    },
    {
        "year": 1970,
        "age": 55,
        "sex": 2,
        "people": 5222164
    },
    {
        "year": 1970,
        "age": 60,
        "sex": 1,
        "people": 4037643
    },
    {
        "year": 1970,
        "age": 60,
        "sex": 2,
        "people": 4577251
    },
    {
        "year": 1970,
        "age": 65,
        "sex": 1,
        "people": 3142606
    },
    {
        "year": 1970,
        "age": 65,
        "sex": 2,
        "people": 3894827
    },
    {
        "year": 1970,
        "age": 70,
        "sex": 1,
        "people": 2340826
    },
    {
        "year": 1970,
        "age": 70,
        "sex": 2,
        "people": 3138009
    },
    {
        "year": 1970,
        "age": 75,
        "sex": 1,
        "people": 1599269
    },
    {
        "year": 1970,
        "age": 75,
        "sex": 2,
        "people": 2293376
    },
    {
        "year": 1970,
        "age": 80,
        "sex": 1,
        "people": 886155
    },
    {
        "year": 1970,
        "age": 80,
        "sex": 2,
        "people": 1417553
    },
    {
        "year": 1970,
        "age": 85,
        "sex": 1,
        "people": 371123
    },
    {
        "year": 1970,
        "age": 85,
        "sex": 2,
        "people": 658511
    },
    {
        "year": 1970,
        "age": 90,
        "sex": 1,
        "people": 186502
    },
    {
        "year": 1970,
        "age": 90,
        "sex": 2,
        "people": 314929
    },
    {
        "year": 1980,
        "age": 0,
        "sex": 1,
        "people": 8439366
    },
    {
        "year": 1980,
        "age": 0,
        "sex": 2,
        "people": 8081854
    },
    {
        "year": 1980,
        "age": 5,
        "sex": 1,
        "people": 8680730
    },
    {
        "year": 1980,
        "age": 5,
        "sex": 2,
        "people": 8275881
    },
    {
        "year": 1980,
        "age": 10,
        "sex": 1,
        "people": 9452338
    },
    {
        "year": 1980,
        "age": 10,
        "sex": 2,
        "people": 9048483
    },
    {
        "year": 1980,
        "age": 15,
        "sex": 1,
        "people": 10698856
    },
    {
        "year": 1980,
        "age": 15,
        "sex": 2,
        "people": 10410271
    },
    {
        "year": 1980,
        "age": 20,
        "sex": 1,
        "people": 10486776
    },
    {
        "year": 1980,
        "age": 20,
        "sex": 2,
        "people": 10614947
    },
    {
        "year": 1980,
        "age": 25,
        "sex": 1,
        "people": 9624053
    },
    {
        "year": 1980,
        "age": 25,
        "sex": 2,
        "people": 9827903
    },
    {
        "year": 1980,
        "age": 30,
        "sex": 1,
        "people": 8705835
    },
    {
        "year": 1980,
        "age": 30,
        "sex": 2,
        "people": 8955225
    },
    {
        "year": 1980,
        "age": 35,
        "sex": 1,
        "people": 6852069
    },
    {
        "year": 1980,
        "age": 35,
        "sex": 2,
        "people": 7134239
    },
    {
        "year": 1980,
        "age": 40,
        "sex": 1,
        "people": 5692148
    },
    {
        "year": 1980,
        "age": 40,
        "sex": 2,
        "people": 5953910
    },
    {
        "year": 1980,
        "age": 45,
        "sex": 1,
        "people": 5342469
    },
    {
        "year": 1980,
        "age": 45,
        "sex": 2,
        "people": 5697543
    },
    {
        "year": 1980,
        "age": 50,
        "sex": 1,
        "people": 5603709
    },
    {
        "year": 1980,
        "age": 50,
        "sex": 2,
        "people": 6110117
    },
    {
        "year": 1980,
        "age": 55,
        "sex": 1,
        "people": 5485098
    },
    {
        "year": 1980,
        "age": 55,
        "sex": 2,
        "people": 6160229
    },
    {
        "year": 1980,
        "age": 60,
        "sex": 1,
        "people": 4696140
    },
    {
        "year": 1980,
        "age": 60,
        "sex": 2,
        "people": 5456885
    },
    {
        "year": 1980,
        "age": 65,
        "sex": 1,
        "people": 3893510
    },
    {
        "year": 1980,
        "age": 65,
        "sex": 2,
        "people": 4896947
    },
    {
        "year": 1980,
        "age": 70,
        "sex": 1,
        "people": 2857774
    },
    {
        "year": 1980,
        "age": 70,
        "sex": 2,
        "people": 3963441
    },
    {
        "year": 1980,
        "age": 75,
        "sex": 1,
        "people": 1840438
    },
    {
        "year": 1980,
        "age": 75,
        "sex": 2,
        "people": 2951759
    },
    {
        "year": 1980,
        "age": 80,
        "sex": 1,
        "people": 1012886
    },
    {
        "year": 1980,
        "age": 80,
        "sex": 2,
        "people": 1919292
    },
    {
        "year": 1980,
        "age": 85,
        "sex": 1,
        "people": 472338
    },
    {
        "year": 1980,
        "age": 85,
        "sex": 2,
        "people": 1023115
    },
    {
        "year": 1980,
        "age": 90,
        "sex": 1,
        "people": 204148
    },
    {
        "year": 1980,
        "age": 90,
        "sex": 2,
        "people": 499046
    },
    {
        "year": 1990,
        "age": 0,
        "sex": 1,
        "people": 9307465
    },
    {
        "year": 1990,
        "age": 0,
        "sex": 2,
        "people": 8894007
    },
    {
        "year": 1990,
        "age": 5,
        "sex": 1,
        "people": 9274732
    },
    {
        "year": 1990,
        "age": 5,
        "sex": 2,
        "people": 8799955
    },
    {
        "year": 1990,
        "age": 10,
        "sex": 1,
        "people": 8782542
    },
    {
        "year": 1990,
        "age": 10,
        "sex": 2,
        "people": 8337284
    },
    {
        "year": 1990,
        "age": 15,
        "sex": 1,
        "people": 9020572
    },
    {
        "year": 1990,
        "age": 15,
        "sex": 2,
        "people": 8590991
    },
    {
        "year": 1990,
        "age": 20,
        "sex": 1,
        "people": 9436188
    },
    {
        "year": 1990,
        "age": 20,
        "sex": 2,
        "people": 9152644
    },
    {
        "year": 1990,
        "age": 25,
        "sex": 1,
        "people": 10658027
    },
    {
        "year": 1990,
        "age": 25,
        "sex": 2,
        "people": 10587292
    },
    {
        "year": 1990,
        "age": 30,
        "sex": 1,
        "people": 11028712
    },
    {
        "year": 1990,
        "age": 30,
        "sex": 2,
        "people": 11105750
    },
    {
        "year": 1990,
        "age": 35,
        "sex": 1,
        "people": 9853933
    },
    {
        "year": 1990,
        "age": 35,
        "sex": 2,
        "people": 10038644
    },
    {
        "year": 1990,
        "age": 40,
        "sex": 1,
        "people": 8712632
    },
    {
        "year": 1990,
        "age": 40,
        "sex": 2,
        "people": 8928252
    },
    {
        "year": 1990,
        "age": 45,
        "sex": 1,
        "people": 6848082
    },
    {
        "year": 1990,
        "age": 45,
        "sex": 2,
        "people": 7115129
    },
    {
        "year": 1990,
        "age": 50,
        "sex": 1,
        "people": 5553992
    },
    {
        "year": 1990,
        "age": 50,
        "sex": 2,
        "people": 5899925
    },
    {
        "year": 1990,
        "age": 55,
        "sex": 1,
        "people": 4981670
    },
    {
        "year": 1990,
        "age": 55,
        "sex": 2,
        "people": 5460506
    },
    {
        "year": 1990,
        "age": 60,
        "sex": 1,
        "people": 4953822
    },
    {
        "year": 1990,
        "age": 60,
        "sex": 2,
        "people": 5663205
    },
    {
        "year": 1990,
        "age": 65,
        "sex": 1,
        "people": 4538398
    },
    {
        "year": 1990,
        "age": 65,
        "sex": 2,
        "people": 5594108
    },
    {
        "year": 1990,
        "age": 70,
        "sex": 1,
        "people": 3429420
    },
    {
        "year": 1990,
        "age": 70,
        "sex": 2,
        "people": 4610222
    },
    {
        "year": 1990,
        "age": 75,
        "sex": 1,
        "people": 2344932
    },
    {
        "year": 1990,
        "age": 75,
        "sex": 2,
        "people": 3723980
    },
    {
        "year": 1990,
        "age": 80,
        "sex": 1,
        "people": 1342996
    },
    {
        "year": 1990,
        "age": 80,
        "sex": 2,
        "people": 2545730
    },
    {
        "year": 1990,
        "age": 85,
        "sex": 1,
        "people": 588790
    },
    {
        "year": 1990,
        "age": 85,
        "sex": 2,
        "people": 1419494
    },
    {
        "year": 1990,
        "age": 90,
        "sex": 1,
        "people": 238459
    },
    {
        "year": 1990,
        "age": 90,
        "sex": 2,
        "people": 745146
    },
    {
        "year": 2000,
        "age": 0,
        "sex": 1,
        "people": 9735380
    },
    {
        "year": 2000,
        "age": 0,
        "sex": 2,
        "people": 9310714
    },
    {
        "year": 2000,
        "age": 5,
        "sex": 1,
        "people": 10552146
    },
    {
        "year": 2000,
        "age": 5,
        "sex": 2,
        "people": 10069564
    },
    {
        "year": 2000,
        "age": 10,
        "sex": 1,
        "people": 10563233
    },
    {
        "year": 2000,
        "age": 10,
        "sex": 2,
        "people": 10022524
    },
    {
        "year": 2000,
        "age": 15,
        "sex": 1,
        "people": 10237419
    },
    {
        "year": 2000,
        "age": 15,
        "sex": 2,
        "people": 9692669
    },
    {
        "year": 2000,
        "age": 20,
        "sex": 1,
        "people": 9731315
    },
    {
        "year": 2000,
        "age": 20,
        "sex": 2,
        "people": 9324244
    },
    {
        "year": 2000,
        "age": 25,
        "sex": 1,
        "people": 9659493
    },
    {
        "year": 2000,
        "age": 25,
        "sex": 2,
        "people": 9518507
    },
    {
        "year": 2000,
        "age": 30,
        "sex": 1,
        "people": 10205879
    },
    {
        "year": 2000,
        "age": 30,
        "sex": 2,
        "people": 10119296
    },
    {
        "year": 2000,
        "age": 35,
        "sex": 1,
        "people": 11475182
    },
    {
        "year": 2000,
        "age": 35,
        "sex": 2,
        "people": 11635647
    },
    {
        "year": 2000,
        "age": 40,
        "sex": 1,
        "people": 11320252
    },
    {
        "year": 2000,
        "age": 40,
        "sex": 2,
        "people": 11488578
    },
    {
        "year": 2000,
        "age": 45,
        "sex": 1,
        "people": 9925006
    },
    {
        "year": 2000,
        "age": 45,
        "sex": 2,
        "people": 10261253
    },
    {
        "year": 2000,
        "age": 50,
        "sex": 1,
        "people": 8507934
    },
    {
        "year": 2000,
        "age": 50,
        "sex": 2,
        "people": 8911133
    },
    {
        "year": 2000,
        "age": 55,
        "sex": 1,
        "people": 6459082
    },
    {
        "year": 2000,
        "age": 55,
        "sex": 2,
        "people": 6921268
    },
    {
        "year": 2000,
        "age": 60,
        "sex": 1,
        "people": 5123399
    },
    {
        "year": 2000,
        "age": 60,
        "sex": 2,
        "people": 5668961
    },
    {
        "year": 2000,
        "age": 65,
        "sex": 1,
        "people": 4453623
    },
    {
        "year": 2000,
        "age": 65,
        "sex": 2,
        "people": 4804784
    },
    {
        "year": 2000,
        "age": 70,
        "sex": 1,
        "people": 3792145
    },
    {
        "year": 2000,
        "age": 70,
        "sex": 2,
        "people": 5184855
    },
    {
        "year": 2000,
        "age": 75,
        "sex": 1,
        "people": 2912655
    },
    {
        "year": 2000,
        "age": 75,
        "sex": 2,
        "people": 4355644
    },
    {
        "year": 2000,
        "age": 80,
        "sex": 1,
        "people": 1902638
    },
    {
        "year": 2000,
        "age": 80,
        "sex": 2,
        "people": 3221898
    },
    {
        "year": 2000,
        "age": 85,
        "sex": 1,
        "people": 970357
    },
    {
        "year": 2000,
        "age": 85,
        "sex": 2,
        "people": 1981156
    },
    {
        "year": 2000,
        "age": 90,
        "sex": 1,
        "people": 336303
    },
    {
        "year": 2000,
        "age": 90,
        "sex": 2,
        "people": 1064581
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="stocks-dataset">[
    {
        "symbol": "MSFT",
        "date": "Jan 1 2000",
        "price": 39.81
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2000",
        "price": 36.35
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2000",
        "price": 43.22
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2000",
        "price": 28.37
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2000",
        "price": 25.45
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2000",
        "price": 32.54
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2000",
        "price": 28.4
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2000",
        "price": 28.4
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2000",
        "price": 24.53
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2000",
        "price": 28.02
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2000",
        "price": 23.34
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2000",
        "price": 17.65
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2001",
        "price": 24.84
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2001",
        "price": 24
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2001",
        "price": 22.25
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2001",
        "price": 27.56
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2001",
        "price": 28.14
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2001",
        "price": 29.7
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2001",
        "price": 26.93
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2001",
        "price": 23.21
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2001",
        "price": 20.82
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2001",
        "price": 23.65
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2001",
        "price": 26.12
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2001",
        "price": 26.95
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2002",
        "price": 25.92
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2002",
        "price": 23.73
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2002",
        "price": 24.53
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2002",
        "price": 21.26
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2002",
        "price": 20.71
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2002",
        "price": 22.25
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2002",
        "price": 19.52
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2002",
        "price": 19.97
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2002",
        "price": 17.79
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2002",
        "price": 21.75
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2002",
        "price": 23.46
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2002",
        "price": 21.03
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2003",
        "price": 19.31
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2003",
        "price": 19.34
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2003",
        "price": 19.76
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2003",
        "price": 20.87
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2003",
        "price": 20.09
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2003",
        "price": 20.93
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2003",
        "price": 21.56
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2003",
        "price": 21.65
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2003",
        "price": 22.69
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2003",
        "price": 21.45
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2003",
        "price": 21.1
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2003",
        "price": 22.46
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2004",
        "price": 22.69
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2004",
        "price": 21.77
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2004",
        "price": 20.46
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2004",
        "price": 21.45
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2004",
        "price": 21.53
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2004",
        "price": 23.44
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2004",
        "price": 23.38
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2004",
        "price": 22.47
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2004",
        "price": 22.76
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2004",
        "price": 23.02
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2004",
        "price": 24.6
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2004",
        "price": 24.52
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2005",
        "price": 24.11
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2005",
        "price": 23.15
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2005",
        "price": 22.24
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2005",
        "price": 23.28
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2005",
        "price": 23.82
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2005",
        "price": 22.93
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2005",
        "price": 23.64
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2005",
        "price": 25.35
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2005",
        "price": 23.83
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2005",
        "price": 23.8
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2005",
        "price": 25.71
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2005",
        "price": 24.29
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2006",
        "price": 26.14
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2006",
        "price": 25.04
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2006",
        "price": 25.36
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2006",
        "price": 22.5
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2006",
        "price": 21.19
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2006",
        "price": 21.8
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2006",
        "price": 22.51
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2006",
        "price": 24.13
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2006",
        "price": 25.68
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2006",
        "price": 26.96
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2006",
        "price": 27.66
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2006",
        "price": 28.13
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2007",
        "price": 29.07
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2007",
        "price": 26.63
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2007",
        "price": 26.35
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2007",
        "price": 28.3
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2007",
        "price": 29.11
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2007",
        "price": 27.95
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2007",
        "price": 27.5
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2007",
        "price": 27.34
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2007",
        "price": 28.04
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2007",
        "price": 35.03
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2007",
        "price": 32.09
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2007",
        "price": 34
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2008",
        "price": 31.13
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2008",
        "price": 26.07
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2008",
        "price": 27.21
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2008",
        "price": 27.34
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2008",
        "price": 27.25
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2008",
        "price": 26.47
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2008",
        "price": 24.75
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2008",
        "price": 26.36
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2008",
        "price": 25.78
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2008",
        "price": 21.57
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2008",
        "price": 19.66
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2008",
        "price": 18.91
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2009",
        "price": 16.63
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2009",
        "price": 15.81
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2009",
        "price": 17.99
    },
    {
        "symbol": "MSFT",
        "date": "Apr 1 2009",
        "price": 19.84
    },
    {
        "symbol": "MSFT",
        "date": "May 1 2009",
        "price": 20.59
    },
    {
        "symbol": "MSFT",
        "date": "Jun 1 2009",
        "price": 23.42
    },
    {
        "symbol": "MSFT",
        "date": "Jul 1 2009",
        "price": 23.18
    },
    {
        "symbol": "MSFT",
        "date": "Aug 1 2009",
        "price": 24.43
    },
    {
        "symbol": "MSFT",
        "date": "Sep 1 2009",
        "price": 25.49
    },
    {
        "symbol": "MSFT",
        "date": "Oct 1 2009",
        "price": 27.48
    },
    {
        "symbol": "MSFT",
        "date": "Nov 1 2009",
        "price": 29.27
    },
    {
        "symbol": "MSFT",
        "date": "Dec 1 2009",
        "price": 30.34
    },
    {
        "symbol": "MSFT",
        "date": "Jan 1 2010",
        "price": 28.05
    },
    {
        "symbol": "MSFT",
        "date": "Feb 1 2010",
        "price": 28.67
    },
    {
        "symbol": "MSFT",
        "date": "Mar 1 2010",
        "price": 28.8
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2000",
        "price": 64.56
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2000",
        "price": 68.87
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2000",
        "price": 67
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2000",
        "price": 55.19
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2000",
        "price": 48.31
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2000",
        "price": 36.31
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2000",
        "price": 30.12
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2000",
        "price": 41.5
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2000",
        "price": 38.44
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2000",
        "price": 36.62
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2000",
        "price": 24.69
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2000",
        "price": 15.56
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2001",
        "price": 17.31
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2001",
        "price": 10.19
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2001",
        "price": 10.23
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2001",
        "price": 15.78
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2001",
        "price": 16.69
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2001",
        "price": 14.15
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2001",
        "price": 12.49
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2001",
        "price": 8.94
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2001",
        "price": 5.97
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2001",
        "price": 6.98
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2001",
        "price": 11.32
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2001",
        "price": 10.82
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2002",
        "price": 14.19
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2002",
        "price": 14.1
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2002",
        "price": 14.3
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2002",
        "price": 16.69
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2002",
        "price": 18.23
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2002",
        "price": 16.25
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2002",
        "price": 14.45
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2002",
        "price": 14.94
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2002",
        "price": 15.93
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2002",
        "price": 19.36
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2002",
        "price": 23.35
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2002",
        "price": 18.89
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2003",
        "price": 21.85
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2003",
        "price": 22.01
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2003",
        "price": 26.03
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2003",
        "price": 28.69
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2003",
        "price": 35.89
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2003",
        "price": 36.32
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2003",
        "price": 41.64
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2003",
        "price": 46.32
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2003",
        "price": 48.43
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2003",
        "price": 54.43
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2003",
        "price": 53.97
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2003",
        "price": 52.62
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2004",
        "price": 50.4
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2004",
        "price": 43.01
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2004",
        "price": 43.28
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2004",
        "price": 43.6
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2004",
        "price": 48.5
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2004",
        "price": 54.4
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2004",
        "price": 38.92
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2004",
        "price": 38.14
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2004",
        "price": 40.86
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2004",
        "price": 34.13
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2004",
        "price": 39.68
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2004",
        "price": 44.29
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2005",
        "price": 43.22
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2005",
        "price": 35.18
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2005",
        "price": 34.27
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2005",
        "price": 32.36
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2005",
        "price": 35.51
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2005",
        "price": 33.09
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2005",
        "price": 45.15
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2005",
        "price": 42.7
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2005",
        "price": 45.3
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2005",
        "price": 39.86
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2005",
        "price": 48.46
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2005",
        "price": 47.15
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2006",
        "price": 44.82
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2006",
        "price": 37.44
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2006",
        "price": 36.53
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2006",
        "price": 35.21
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2006",
        "price": 34.61
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2006",
        "price": 38.68
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2006",
        "price": 26.89
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2006",
        "price": 30.83
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2006",
        "price": 32.12
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2006",
        "price": 38.09
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2006",
        "price": 40.34
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2006",
        "price": 39.46
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2007",
        "price": 37.67
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2007",
        "price": 39.14
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2007",
        "price": 39.79
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2007",
        "price": 61.33
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2007",
        "price": 69.14
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2007",
        "price": 68.41
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2007",
        "price": 78.54
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2007",
        "price": 79.91
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2007",
        "price": 93.15
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2007",
        "price": 89.15
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2007",
        "price": 90.56
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2007",
        "price": 92.64
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2008",
        "price": 77.7
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2008",
        "price": 64.47
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2008",
        "price": 71.3
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2008",
        "price": 78.63
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2008",
        "price": 81.62
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2008",
        "price": 73.33
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2008",
        "price": 76.34
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2008",
        "price": 80.81
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2008",
        "price": 72.76
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2008",
        "price": 57.24
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2008",
        "price": 42.7
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2008",
        "price": 51.28
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2009",
        "price": 58.82
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2009",
        "price": 64.79
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2009",
        "price": 73.44
    },
    {
        "symbol": "AMZN",
        "date": "Apr 1 2009",
        "price": 80.52
    },
    {
        "symbol": "AMZN",
        "date": "May 1 2009",
        "price": 77.99
    },
    {
        "symbol": "AMZN",
        "date": "Jun 1 2009",
        "price": 83.66
    },
    {
        "symbol": "AMZN",
        "date": "Jul 1 2009",
        "price": 85.76
    },
    {
        "symbol": "AMZN",
        "date": "Aug 1 2009",
        "price": 81.19
    },
    {
        "symbol": "AMZN",
        "date": "Sep 1 2009",
        "price": 93.36
    },
    {
        "symbol": "AMZN",
        "date": "Oct 1 2009",
        "price": 118.81
    },
    {
        "symbol": "AMZN",
        "date": "Nov 1 2009",
        "price": 135.91
    },
    {
        "symbol": "AMZN",
        "date": "Dec 1 2009",
        "price": 134.52
    },
    {
        "symbol": "AMZN",
        "date": "Jan 1 2010",
        "price": 125.41
    },
    {
        "symbol": "AMZN",
        "date": "Feb 1 2010",
        "price": 118.4
    },
    {
        "symbol": "AMZN",
        "date": "Mar 1 2010",
        "price": 128.82
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2000",
        "price": 100.52
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2000",
        "price": 92.11
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2000",
        "price": 106.11
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2000",
        "price": 99.95
    },
    {
        "symbol": "IBM",
        "date": "May 1 2000",
        "price": 96.31
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2000",
        "price": 98.33
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2000",
        "price": 100.74
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2000",
        "price": 118.62
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2000",
        "price": 101.19
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2000",
        "price": 88.5
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2000",
        "price": 84.12
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2000",
        "price": 76.47
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2001",
        "price": 100.76
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2001",
        "price": 89.98
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2001",
        "price": 86.63
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2001",
        "price": 103.7
    },
    {
        "symbol": "IBM",
        "date": "May 1 2001",
        "price": 100.82
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2001",
        "price": 102.35
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2001",
        "price": 94.87
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2001",
        "price": 90.25
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2001",
        "price": 82.82
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2001",
        "price": 97.58
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2001",
        "price": 104.5
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2001",
        "price": 109.36
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2002",
        "price": 97.54
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2002",
        "price": 88.82
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2002",
        "price": 94.15
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2002",
        "price": 75.82
    },
    {
        "symbol": "IBM",
        "date": "May 1 2002",
        "price": 72.97
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2002",
        "price": 65.31
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2002",
        "price": 63.86
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2002",
        "price": 68.52
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2002",
        "price": 53.01
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2002",
        "price": 71.76
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2002",
        "price": 79.16
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2002",
        "price": 70.58
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2003",
        "price": 71.22
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2003",
        "price": 71.13
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2003",
        "price": 71.57
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2003",
        "price": 77.47
    },
    {
        "symbol": "IBM",
        "date": "May 1 2003",
        "price": 80.48
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2003",
        "price": 75.42
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2003",
        "price": 74.28
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2003",
        "price": 75.12
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2003",
        "price": 80.91
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2003",
        "price": 81.96
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2003",
        "price": 83.08
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2003",
        "price": 85.05
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2004",
        "price": 91.06
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2004",
        "price": 88.7
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2004",
        "price": 84.41
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2004",
        "price": 81.04
    },
    {
        "symbol": "IBM",
        "date": "May 1 2004",
        "price": 81.59
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2004",
        "price": 81.19
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2004",
        "price": 80.19
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2004",
        "price": 78.17
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2004",
        "price": 79.13
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2004",
        "price": 82.84
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2004",
        "price": 87.15
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2004",
        "price": 91.16
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2005",
        "price": 86.39
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2005",
        "price": 85.78
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2005",
        "price": 84.66
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2005",
        "price": 70.77
    },
    {
        "symbol": "IBM",
        "date": "May 1 2005",
        "price": 70.18
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2005",
        "price": 68.93
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2005",
        "price": 77.53
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2005",
        "price": 75.07
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2005",
        "price": 74.7
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2005",
        "price": 76.25
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2005",
        "price": 82.98
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2005",
        "price": 76.73
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2006",
        "price": 75.89
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2006",
        "price": 75.09
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2006",
        "price": 77.17
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2006",
        "price": 77.05
    },
    {
        "symbol": "IBM",
        "date": "May 1 2006",
        "price": 75.04
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2006",
        "price": 72.15
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2006",
        "price": 72.7
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2006",
        "price": 76.35
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2006",
        "price": 77.26
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2006",
        "price": 87.06
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2006",
        "price": 86.95
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2006",
        "price": 91.9
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2007",
        "price": 93.79
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2007",
        "price": 88.18
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2007",
        "price": 89.44
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2007",
        "price": 96.98
    },
    {
        "symbol": "IBM",
        "date": "May 1 2007",
        "price": 101.54
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2007",
        "price": 100.25
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2007",
        "price": 105.4
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2007",
        "price": 111.54
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2007",
        "price": 112.6
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2007",
        "price": 111
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2007",
        "price": 100.9
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2007",
        "price": 103.7
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2008",
        "price": 102.75
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2008",
        "price": 109.64
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2008",
        "price": 110.87
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2008",
        "price": 116.23
    },
    {
        "symbol": "IBM",
        "date": "May 1 2008",
        "price": 125.14
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2008",
        "price": 114.6
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2008",
        "price": 123.74
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2008",
        "price": 118.16
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2008",
        "price": 113.53
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2008",
        "price": 90.24
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2008",
        "price": 79.65
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2008",
        "price": 82.15
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2009",
        "price": 89.46
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2009",
        "price": 90.32
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2009",
        "price": 95.09
    },
    {
        "symbol": "IBM",
        "date": "Apr 1 2009",
        "price": 101.29
    },
    {
        "symbol": "IBM",
        "date": "May 1 2009",
        "price": 104.85
    },
    {
        "symbol": "IBM",
        "date": "Jun 1 2009",
        "price": 103.01
    },
    {
        "symbol": "IBM",
        "date": "Jul 1 2009",
        "price": 116.34
    },
    {
        "symbol": "IBM",
        "date": "Aug 1 2009",
        "price": 117
    },
    {
        "symbol": "IBM",
        "date": "Sep 1 2009",
        "price": 118.55
    },
    {
        "symbol": "IBM",
        "date": "Oct 1 2009",
        "price": 119.54
    },
    {
        "symbol": "IBM",
        "date": "Nov 1 2009",
        "price": 125.79
    },
    {
        "symbol": "IBM",
        "date": "Dec 1 2009",
        "price": 130.32
    },
    {
        "symbol": "IBM",
        "date": "Jan 1 2010",
        "price": 121.85
    },
    {
        "symbol": "IBM",
        "date": "Feb 1 2010",
        "price": 127.16
    },
    {
        "symbol": "IBM",
        "date": "Mar 1 2010",
        "price": 125.55
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2004",
        "price": 102.37
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2004",
        "price": 129.6
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2004",
        "price": 190.64
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2004",
        "price": 181.98
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2004",
        "price": 192.79
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2005",
        "price": 195.62
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2005",
        "price": 187.99
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2005",
        "price": 180.51
    },
    {
        "symbol": "GOOG",
        "date": "Apr 1 2005",
        "price": 220
    },
    {
        "symbol": "GOOG",
        "date": "May 1 2005",
        "price": 277.27
    },
    {
        "symbol": "GOOG",
        "date": "Jun 1 2005",
        "price": 294.15
    },
    {
        "symbol": "GOOG",
        "date": "Jul 1 2005",
        "price": 287.76
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2005",
        "price": 286
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2005",
        "price": 316.46
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2005",
        "price": 372.14
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2005",
        "price": 404.91
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2005",
        "price": 414.86
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2006",
        "price": 432.66
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2006",
        "price": 362.62
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2006",
        "price": 390
    },
    {
        "symbol": "GOOG",
        "date": "Apr 1 2006",
        "price": 417.94
    },
    {
        "symbol": "GOOG",
        "date": "May 1 2006",
        "price": 371.82
    },
    {
        "symbol": "GOOG",
        "date": "Jun 1 2006",
        "price": 419.33
    },
    {
        "symbol": "GOOG",
        "date": "Jul 1 2006",
        "price": 386.6
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2006",
        "price": 378.53
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2006",
        "price": 401.9
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2006",
        "price": 476.39
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2006",
        "price": 484.81
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2006",
        "price": 460.48
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2007",
        "price": 501.5
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2007",
        "price": 449.45
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2007",
        "price": 458.16
    },
    {
        "symbol": "GOOG",
        "date": "Apr 1 2007",
        "price": 471.38
    },
    {
        "symbol": "GOOG",
        "date": "May 1 2007",
        "price": 497.91
    },
    {
        "symbol": "GOOG",
        "date": "Jun 1 2007",
        "price": 522.7
    },
    {
        "symbol": "GOOG",
        "date": "Jul 1 2007",
        "price": 510
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2007",
        "price": 515.25
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2007",
        "price": 567.27
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2007",
        "price": 707
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2007",
        "price": 693
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2007",
        "price": 691.48
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2008",
        "price": 564.3
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2008",
        "price": 471.18
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2008",
        "price": 440.47
    },
    {
        "symbol": "GOOG",
        "date": "Apr 1 2008",
        "price": 574.29
    },
    {
        "symbol": "GOOG",
        "date": "May 1 2008",
        "price": 585.8
    },
    {
        "symbol": "GOOG",
        "date": "Jun 1 2008",
        "price": 526.42
    },
    {
        "symbol": "GOOG",
        "date": "Jul 1 2008",
        "price": 473.75
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2008",
        "price": 463.29
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2008",
        "price": 400.52
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2008",
        "price": 359.36
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2008",
        "price": 292.96
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2008",
        "price": 307.65
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2009",
        "price": 338.53
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2009",
        "price": 337.99
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2009",
        "price": 348.06
    },
    {
        "symbol": "GOOG",
        "date": "Apr 1 2009",
        "price": 395.97
    },
    {
        "symbol": "GOOG",
        "date": "May 1 2009",
        "price": 417.23
    },
    {
        "symbol": "GOOG",
        "date": "Jun 1 2009",
        "price": 421.59
    },
    {
        "symbol": "GOOG",
        "date": "Jul 1 2009",
        "price": 443.05
    },
    {
        "symbol": "GOOG",
        "date": "Aug 1 2009",
        "price": 461.67
    },
    {
        "symbol": "GOOG",
        "date": "Sep 1 2009",
        "price": 495.85
    },
    {
        "symbol": "GOOG",
        "date": "Oct 1 2009",
        "price": 536.12
    },
    {
        "symbol": "GOOG",
        "date": "Nov 1 2009",
        "price": 583
    },
    {
        "symbol": "GOOG",
        "date": "Dec 1 2009",
        "price": 619.98
    },
    {
        "symbol": "GOOG",
        "date": "Jan 1 2010",
        "price": 529.94
    },
    {
        "symbol": "GOOG",
        "date": "Feb 1 2010",
        "price": 526.8
    },
    {
        "symbol": "GOOG",
        "date": "Mar 1 2010",
        "price": 560.19
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2000",
        "price": 25.94
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2000",
        "price": 28.66
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2000",
        "price": 33.95
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2000",
        "price": 31.01
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2000",
        "price": 21
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2000",
        "price": 26.19
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2000",
        "price": 25.41
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2000",
        "price": 30.47
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2000",
        "price": 12.88
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2000",
        "price": 9.78
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2000",
        "price": 8.25
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2000",
        "price": 7.44
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2001",
        "price": 10.81
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2001",
        "price": 9.12
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2001",
        "price": 11.03
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2001",
        "price": 12.74
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2001",
        "price": 9.98
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2001",
        "price": 11.62
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2001",
        "price": 9.4
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2001",
        "price": 9.27
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2001",
        "price": 7.76
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2001",
        "price": 8.78
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2001",
        "price": 10.65
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2001",
        "price": 10.95
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2002",
        "price": 12.36
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2002",
        "price": 10.85
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2002",
        "price": 11.84
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2002",
        "price": 12.14
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2002",
        "price": 11.65
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2002",
        "price": 8.86
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2002",
        "price": 7.63
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2002",
        "price": 7.38
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2002",
        "price": 7.25
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2002",
        "price": 8.03
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2002",
        "price": 7.75
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2002",
        "price": 7.16
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2003",
        "price": 7.18
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2003",
        "price": 7.51
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2003",
        "price": 7.07
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2003",
        "price": 7.11
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2003",
        "price": 8.98
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2003",
        "price": 9.53
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2003",
        "price": 10.54
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2003",
        "price": 11.31
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2003",
        "price": 10.36
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2003",
        "price": 11.44
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2003",
        "price": 10.45
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2003",
        "price": 10.69
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2004",
        "price": 11.28
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2004",
        "price": 11.96
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2004",
        "price": 13.52
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2004",
        "price": 12.89
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2004",
        "price": 14.03
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2004",
        "price": 16.27
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2004",
        "price": 16.17
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2004",
        "price": 17.25
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2004",
        "price": 19.38
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2004",
        "price": 26.2
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2004",
        "price": 33.53
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2004",
        "price": 32.2
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2005",
        "price": 38.45
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2005",
        "price": 44.86
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2005",
        "price": 41.67
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2005",
        "price": 36.06
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2005",
        "price": 39.76
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2005",
        "price": 36.81
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2005",
        "price": 42.65
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2005",
        "price": 46.89
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2005",
        "price": 53.61
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2005",
        "price": 57.59
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2005",
        "price": 67.82
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2005",
        "price": 71.89
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2006",
        "price": 75.51
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2006",
        "price": 68.49
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2006",
        "price": 62.72
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2006",
        "price": 70.39
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2006",
        "price": 59.77
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2006",
        "price": 57.27
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2006",
        "price": 67.96
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2006",
        "price": 67.85
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2006",
        "price": 76.98
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2006",
        "price": 81.08
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2006",
        "price": 91.66
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2006",
        "price": 84.84
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2007",
        "price": 85.73
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2007",
        "price": 84.61
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2007",
        "price": 92.91
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2007",
        "price": 99.8
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2007",
        "price": 121.19
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2007",
        "price": 122.04
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2007",
        "price": 131.76
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2007",
        "price": 138.48
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2007",
        "price": 153.47
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2007",
        "price": 189.95
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2007",
        "price": 182.22
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2007",
        "price": 198.08
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2008",
        "price": 135.36
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2008",
        "price": 125.02
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2008",
        "price": 143.5
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2008",
        "price": 173.95
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2008",
        "price": 188.75
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2008",
        "price": 167.44
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2008",
        "price": 158.95
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2008",
        "price": 169.53
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2008",
        "price": 113.66
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2008",
        "price": 107.59
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2008",
        "price": 92.67
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2008",
        "price": 85.35
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2009",
        "price": 90.13
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2009",
        "price": 89.31
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2009",
        "price": 105.12
    },
    {
        "symbol": "AAPL",
        "date": "Apr 1 2009",
        "price": 125.83
    },
    {
        "symbol": "AAPL",
        "date": "May 1 2009",
        "price": 135.81
    },
    {
        "symbol": "AAPL",
        "date": "Jun 1 2009",
        "price": 142.43
    },
    {
        "symbol": "AAPL",
        "date": "Jul 1 2009",
        "price": 163.39
    },
    {
        "symbol": "AAPL",
        "date": "Aug 1 2009",
        "price": 168.21
    },
    {
        "symbol": "AAPL",
        "date": "Sep 1 2009",
        "price": 185.35
    },
    {
        "symbol": "AAPL",
        "date": "Oct 1 2009",
        "price": 188.5
    },
    {
        "symbol": "AAPL",
        "date": "Nov 1 2009",
        "price": 199.91
    },
    {
        "symbol": "AAPL",
        "date": "Dec 1 2009",
        "price": 210.73
    },
    {
        "symbol": "AAPL",
        "date": "Jan 1 2010",
        "price": 192.06
    },
    {
        "symbol": "AAPL",
        "date": "Feb 1 2010",
        "price": 204.62
    },
    {
        "symbol": "AAPL",
        "date": "Mar 1 2010",
        "price": 223.02
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="unemployment-dataset">[
    {
        "series": "Government",
        "year": 2000,
        "month": 1,
        "count": 430,
        "rate": 2.1,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 2,
        "count": 409,
        "rate": 2,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 3,
        "count": 311,
        "rate": 1.5,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 4,
        "count": 269,
        "rate": 1.3,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 5,
        "count": 370,
        "rate": 1.9,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 6,
        "count": 603,
        "rate": 3.1,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 7,
        "count": 545,
        "rate": 2.9,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 8,
        "count": 583,
        "rate": 3.1,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 9,
        "count": 408,
        "rate": 2.1,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 10,
        "count": 391,
        "rate": 2,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 11,
        "count": 384,
        "rate": 1.9,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2000,
        "month": 12,
        "count": 365,
        "rate": 1.8,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 1,
        "count": 463,
        "rate": 2.3,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 2,
        "count": 298,
        "rate": 1.5,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 3,
        "count": 355,
        "rate": 1.8,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 4,
        "count": 369,
        "rate": 1.9,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 5,
        "count": 361,
        "rate": 1.8,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 6,
        "count": 525,
        "rate": 2.7,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 7,
        "count": 548,
        "rate": 2.8,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 8,
        "count": 540,
        "rate": 2.8,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 9,
        "count": 438,
        "rate": 2.2,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 10,
        "count": 429,
        "rate": 2.2,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 11,
        "count": 420,
        "rate": 2.1,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2001,
        "month": 12,
        "count": 419,
        "rate": 2.1,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 1,
        "count": 486,
        "rate": 2.4,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 2,
        "count": 508,
        "rate": 2.5,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 3,
        "count": 477,
        "rate": 2.4,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 4,
        "count": 447,
        "rate": 2.2,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 5,
        "count": 484,
        "rate": 2.3,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 6,
        "count": 561,
        "rate": 2.8,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 7,
        "count": 645,
        "rate": 3.2,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 8,
        "count": 596,
        "rate": 3,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 9,
        "count": 530,
        "rate": 2.6,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 10,
        "count": 499,
        "rate": 2.5,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 11,
        "count": 468,
        "rate": 2.3,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2002,
        "month": 12,
        "count": 446,
        "rate": 2.2,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 1,
        "count": 571,
        "rate": 2.8,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 2,
        "count": 483,
        "rate": 2.4,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 3,
        "count": 526,
        "rate": 2.6,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 4,
        "count": 440,
        "rate": 2.2,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 5,
        "count": 478,
        "rate": 2.4,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 6,
        "count": 704,
        "rate": 3.5,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 7,
        "count": 749,
        "rate": 3.8,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 8,
        "count": 745,
        "rate": 3.7,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 9,
        "count": 556,
        "rate": 2.7,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 10,
        "count": 500,
        "rate": 2.4,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 11,
        "count": 542,
        "rate": 2.7,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2003,
        "month": 12,
        "count": 516,
        "rate": 2.5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 1,
        "count": 511,
        "rate": 2.5,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 2,
        "count": 490,
        "rate": 2.4,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 3,
        "count": 530,
        "rate": 2.6,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 4,
        "count": 433,
        "rate": 2.1,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 5,
        "count": 468,
        "rate": 2.3,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 6,
        "count": 580,
        "rate": 2.8,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 7,
        "count": 741,
        "rate": 3.7,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 8,
        "count": 676,
        "rate": 3.3,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 9,
        "count": 568,
        "rate": 2.7,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 10,
        "count": 561,
        "rate": 2.7,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 11,
        "count": 514,
        "rate": 2.4,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2004,
        "month": 12,
        "count": 499,
        "rate": 2.4,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 1,
        "count": 555,
        "rate": 2.6,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 2,
        "count": 472,
        "rate": 2.3,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 3,
        "count": 468,
        "rate": 2.2,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 4,
        "count": 478,
        "rate": 2.3,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 5,
        "count": 453,
        "rate": 2.1,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 6,
        "count": 681,
        "rate": 3.2,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 7,
        "count": 683,
        "rate": 3.3,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 8,
        "count": 664,
        "rate": 3.2,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 9,
        "count": 568,
        "rate": 2.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 10,
        "count": 502,
        "rate": 2.4,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 11,
        "count": 494,
        "rate": 2.4,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2005,
        "month": 12,
        "count": 393,
        "rate": 1.9,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 1,
        "count": 457,
        "rate": 2.2,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 2,
        "count": 472,
        "rate": 2.3,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 3,
        "count": 461,
        "rate": 2.2,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 4,
        "count": 414,
        "rate": 2,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 5,
        "count": 429,
        "rate": 2.1,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 6,
        "count": 578,
        "rate": 2.8,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 7,
        "count": 659,
        "rate": 3.2,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 8,
        "count": 595,
        "rate": 2.9,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 9,
        "count": 396,
        "rate": 1.9,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 10,
        "count": 424,
        "rate": 2,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 11,
        "count": 400,
        "rate": 1.9,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2006,
        "month": 12,
        "count": 395,
        "rate": 1.9,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 1,
        "count": 476,
        "rate": 2.2,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 2,
        "count": 405,
        "rate": 1.9,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 3,
        "count": 419,
        "rate": 1.9,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 4,
        "count": 408,
        "rate": 1.9,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 5,
        "count": 428,
        "rate": 1.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 6,
        "count": 572,
        "rate": 2.7,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 7,
        "count": 704,
        "rate": 3.3,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 8,
        "count": 695,
        "rate": 3.2,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 9,
        "count": 525,
        "rate": 2.4,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 10,
        "count": 492,
        "rate": 2.3,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 11,
        "count": 482,
        "rate": 2.2,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2007,
        "month": 12,
        "count": 451,
        "rate": 2.1,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 1,
        "count": 471,
        "rate": 2.2,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 2,
        "count": 372,
        "rate": 1.7,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 3,
        "count": 425,
        "rate": 1.9,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 4,
        "count": 373,
        "rate": 1.7,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 5,
        "count": 461,
        "rate": 2.1,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 6,
        "count": 654,
        "rate": 3,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 7,
        "count": 770,
        "rate": 3.6,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 8,
        "count": 721,
        "rate": 3.3,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 9,
        "count": 573,
        "rate": 2.6,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 10,
        "count": 552,
        "rate": 2.5,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 11,
        "count": 527,
        "rate": 2.4,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2008,
        "month": 12,
        "count": 511,
        "rate": 2.3,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 1,
        "count": 652,
        "rate": 3,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 2,
        "count": 563,
        "rate": 2.6,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 3,
        "count": 598,
        "rate": 2.8,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 4,
        "count": 575,
        "rate": 2.6,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 5,
        "count": 702,
        "rate": 3.1,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 6,
        "count": 991,
        "rate": 4.4,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 7,
        "count": 1129,
        "rate": 5.1,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 8,
        "count": 1118,
        "rate": 5.1,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 9,
        "count": 928,
        "rate": 4.2,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 10,
        "count": 785,
        "rate": 3.5,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 11,
        "count": 748,
        "rate": 3.4,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2009,
        "month": 12,
        "count": 797,
        "rate": 3.6,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2010,
        "month": 1,
        "count": 948,
        "rate": 4.3,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Government",
        "year": 2010,
        "month": 2,
        "count": 880,
        "rate": 4,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 1,
        "count": 19,
        "rate": 3.9,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 2,
        "count": 25,
        "rate": 5.5,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 3,
        "count": 17,
        "rate": 3.7,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 4,
        "count": 20,
        "rate": 4.1,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 5,
        "count": 27,
        "rate": 5.3,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 6,
        "count": 13,
        "rate": 2.6,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 7,
        "count": 16,
        "rate": 3.6,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 8,
        "count": 23,
        "rate": 5.1,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 9,
        "count": 25,
        "rate": 5.8,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 10,
        "count": 39,
        "rate": 7.8,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 11,
        "count": 11,
        "rate": 2,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2000,
        "month": 12,
        "count": 20,
        "rate": 3.8,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 1,
        "count": 11,
        "rate": 2.3,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 2,
        "count": 27,
        "rate": 5.3,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 3,
        "count": 14,
        "rate": 3,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 4,
        "count": 24,
        "rate": 4.7,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 5,
        "count": 34,
        "rate": 5.9,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 6,
        "count": 26,
        "rate": 4.7,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 7,
        "count": 17,
        "rate": 3.1,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 8,
        "count": 18,
        "rate": 3.3,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 9,
        "count": 23,
        "rate": 4.2,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 10,
        "count": 32,
        "rate": 5.4,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 11,
        "count": 20,
        "rate": 3.6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2001,
        "month": 12,
        "count": 27,
        "rate": 5.3,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 1,
        "count": 33,
        "rate": 7,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 2,
        "count": 35,
        "rate": 7.5,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 3,
        "count": 28,
        "rate": 5.3,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 4,
        "count": 33,
        "rate": 6.1,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 5,
        "count": 25,
        "rate": 4.9,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 6,
        "count": 35,
        "rate": 7.1,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 7,
        "count": 19,
        "rate": 3.9,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 8,
        "count": 32,
        "rate": 6.3,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 9,
        "count": 42,
        "rate": 7.9,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 10,
        "count": 36,
        "rate": 6.4,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 11,
        "count": 32,
        "rate": 5.4,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2002,
        "month": 12,
        "count": 45,
        "rate": 7.8,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 1,
        "count": 54,
        "rate": 9,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 2,
        "count": 41,
        "rate": 7.1,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 3,
        "count": 46,
        "rate": 8.2,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 4,
        "count": 41,
        "rate": 7.7,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 5,
        "count": 40,
        "rate": 7.5,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 6,
        "count": 36,
        "rate": 6.8,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 7,
        "count": 43,
        "rate": 7.9,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 8,
        "count": 20,
        "rate": 3.8,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 9,
        "count": 25,
        "rate": 4.6,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 10,
        "count": 31,
        "rate": 5.6,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 11,
        "count": 34,
        "rate": 5.9,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2003,
        "month": 12,
        "count": 32,
        "rate": 5.6,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 1,
        "count": 31,
        "rate": 5.8,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 2,
        "count": 24,
        "rate": 5,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 3,
        "count": 22,
        "rate": 4.4,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 4,
        "count": 34,
        "rate": 6.4,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 5,
        "count": 22,
        "rate": 4.3,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 6,
        "count": 27,
        "rate": 5,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 7,
        "count": 28,
        "rate": 5.4,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 8,
        "count": 10,
        "rate": 1.9,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 9,
        "count": 8,
        "rate": 1.5,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 10,
        "count": 15,
        "rate": 2.6,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 11,
        "count": 20,
        "rate": 3.3,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2004,
        "month": 12,
        "count": 16,
        "rate": 2.5,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 1,
        "count": 29,
        "rate": 4.9,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 2,
        "count": 25,
        "rate": 4,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 3,
        "count": 32,
        "rate": 5.2,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 4,
        "count": 19,
        "rate": 2.9,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 5,
        "count": 16,
        "rate": 2.4,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 6,
        "count": 25,
        "rate": 4,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 7,
        "count": 22,
        "rate": 3.7,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 8,
        "count": 12,
        "rate": 2,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 9,
        "count": 12,
        "rate": 2,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 10,
        "count": 2,
        "rate": 0.3,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 11,
        "count": 18,
        "rate": 2.9,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2005,
        "month": 12,
        "count": 23,
        "rate": 3.5,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 1,
        "count": 26,
        "rate": 3.9,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 2,
        "count": 25,
        "rate": 3.8,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 3,
        "count": 14,
        "rate": 2.1,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 4,
        "count": 17,
        "rate": 2.5,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 5,
        "count": 20,
        "rate": 2.8,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 6,
        "count": 31,
        "rate": 4.3,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 7,
        "count": 25,
        "rate": 3.5,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 8,
        "count": 32,
        "rate": 4.3,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 9,
        "count": 14,
        "rate": 2.1,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 10,
        "count": 15,
        "rate": 2.2,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 11,
        "count": 22,
        "rate": 2.9,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2006,
        "month": 12,
        "count": 25,
        "rate": 3.4,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 1,
        "count": 35,
        "rate": 4.7,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 2,
        "count": 33,
        "rate": 4.5,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 3,
        "count": 24,
        "rate": 3.2,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 4,
        "count": 17,
        "rate": 2.3,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 5,
        "count": 22,
        "rate": 3,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 6,
        "count": 33,
        "rate": 4.3,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 7,
        "count": 33,
        "rate": 4.3,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 8,
        "count": 33,
        "rate": 4.6,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 9,
        "count": 25,
        "rate": 3.2,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 10,
        "count": 9,
        "rate": 1.3,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 11,
        "count": 16,
        "rate": 2.3,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2007,
        "month": 12,
        "count": 24,
        "rate": 3.4,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 1,
        "count": 28,
        "rate": 4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 2,
        "count": 16,
        "rate": 2.2,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 3,
        "count": 28,
        "rate": 3.7,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 4,
        "count": 28,
        "rate": 3.6,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 5,
        "count": 28,
        "rate": 3.4,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 6,
        "count": 28,
        "rate": 3.3,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 7,
        "count": 13,
        "rate": 1.5,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 8,
        "count": 17,
        "rate": 1.9,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 9,
        "count": 25,
        "rate": 2.8,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 10,
        "count": 15,
        "rate": 1.7,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 11,
        "count": 32,
        "rate": 3.7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2008,
        "month": 12,
        "count": 46,
        "rate": 5.2,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 1,
        "count": 59,
        "rate": 7,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 2,
        "count": 63,
        "rate": 7.6,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 3,
        "count": 105,
        "rate": 12.6,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 4,
        "count": 125,
        "rate": 16.1,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 5,
        "count": 98,
        "rate": 13.3,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 6,
        "count": 100,
        "rate": 13.6,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 7,
        "count": 95,
        "rate": 12.6,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 8,
        "count": 93,
        "rate": 11.8,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 9,
        "count": 76,
        "rate": 10.7,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 10,
        "count": 84,
        "rate": 10.8,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 11,
        "count": 96,
        "rate": 12,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2009,
        "month": 12,
        "count": 89,
        "rate": 11.8,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2010,
        "month": 1,
        "count": 68,
        "rate": 9.1,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Mining and Extraction",
        "year": 2010,
        "month": 2,
        "count": 79,
        "rate": 10.7,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 1,
        "count": 745,
        "rate": 9.7,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 2,
        "count": 812,
        "rate": 10.6,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 3,
        "count": 669,
        "rate": 8.7,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 4,
        "count": 447,
        "rate": 5.8,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 5,
        "count": 397,
        "rate": 5,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 6,
        "count": 389,
        "rate": 4.6,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 7,
        "count": 384,
        "rate": 4.4,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 8,
        "count": 446,
        "rate": 5.1,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 9,
        "count": 386,
        "rate": 4.6,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 10,
        "count": 417,
        "rate": 4.9,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 11,
        "count": 482,
        "rate": 5.7,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2000,
        "month": 12,
        "count": 580,
        "rate": 6.8,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 1,
        "count": 836,
        "rate": 9.8,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 2,
        "count": 826,
        "rate": 9.9,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 3,
        "count": 683,
        "rate": 8.4,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 4,
        "count": 596,
        "rate": 7.1,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 5,
        "count": 478,
        "rate": 5.6,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 6,
        "count": 443,
        "rate": 5.1,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 7,
        "count": 447,
        "rate": 4.9,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 8,
        "count": 522,
        "rate": 5.8,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 9,
        "count": 489,
        "rate": 5.5,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 10,
        "count": 535,
        "rate": 6.1,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 11,
        "count": 670,
        "rate": 7.6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2001,
        "month": 12,
        "count": 785,
        "rate": 9,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 1,
        "count": 1211,
        "rate": 13.6,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 2,
        "count": 1060,
        "rate": 12.2,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 3,
        "count": 1009,
        "rate": 11.8,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 4,
        "count": 855,
        "rate": 10.1,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 5,
        "count": 626,
        "rate": 7.4,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 6,
        "count": 593,
        "rate": 6.9,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 7,
        "count": 594,
        "rate": 6.9,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 8,
        "count": 654,
        "rate": 7.4,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 9,
        "count": 615,
        "rate": 7,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 10,
        "count": 680,
        "rate": 7.7,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 11,
        "count": 758,
        "rate": 8.5,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2002,
        "month": 12,
        "count": 941,
        "rate": 10.9,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 1,
        "count": 1196,
        "rate": 14,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 2,
        "count": 1173,
        "rate": 14,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 3,
        "count": 987,
        "rate": 11.8,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 4,
        "count": 772,
        "rate": 9.3,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 5,
        "count": 715,
        "rate": 8.4,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 6,
        "count": 710,
        "rate": 7.9,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 7,
        "count": 677,
        "rate": 7.5,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 8,
        "count": 650,
        "rate": 7.1,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 9,
        "count": 681,
        "rate": 7.6,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 10,
        "count": 651,
        "rate": 7.4,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 11,
        "count": 690,
        "rate": 7.8,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2003,
        "month": 12,
        "count": 813,
        "rate": 9.3,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 1,
        "count": 994,
        "rate": 11.3,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 2,
        "count": 1039,
        "rate": 11.6,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 3,
        "count": 1011,
        "rate": 11.3,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 4,
        "count": 849,
        "rate": 9.5,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 5,
        "count": 665,
        "rate": 7.4,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 6,
        "count": 668,
        "rate": 7,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 7,
        "count": 610,
        "rate": 6.4,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 8,
        "count": 563,
        "rate": 6,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 9,
        "count": 629,
        "rate": 6.8,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 10,
        "count": 635,
        "rate": 6.9,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 11,
        "count": 695,
        "rate": 7.4,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2004,
        "month": 12,
        "count": 870,
        "rate": 9.5,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 1,
        "count": 1079,
        "rate": 11.8,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 2,
        "count": 1150,
        "rate": 12.3,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 3,
        "count": 961,
        "rate": 10.3,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 4,
        "count": 693,
        "rate": 7.4,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 5,
        "count": 567,
        "rate": 6.1,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 6,
        "count": 559,
        "rate": 5.7,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 7,
        "count": 509,
        "rate": 5.2,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 8,
        "count": 561,
        "rate": 5.7,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 9,
        "count": 572,
        "rate": 5.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 10,
        "count": 519,
        "rate": 5.3,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 11,
        "count": 564,
        "rate": 5.7,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2005,
        "month": 12,
        "count": 813,
        "rate": 8.2,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 1,
        "count": 868,
        "rate": 9,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 2,
        "count": 836,
        "rate": 8.6,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 3,
        "count": 820,
        "rate": 8.5,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 4,
        "count": 674,
        "rate": 6.9,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 5,
        "count": 647,
        "rate": 6.6,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 6,
        "count": 569,
        "rate": 5.6,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 7,
        "count": 633,
        "rate": 6.1,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 8,
        "count": 618,
        "rate": 5.9,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 9,
        "count": 586,
        "rate": 5.6,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 10,
        "count": 456,
        "rate": 4.5,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 11,
        "count": 618,
        "rate": 6,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2006,
        "month": 12,
        "count": 725,
        "rate": 6.9,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 1,
        "count": 922,
        "rate": 8.9,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 2,
        "count": 1086,
        "rate": 10.5,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 3,
        "count": 924,
        "rate": 9,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 4,
        "count": 853,
        "rate": 8.6,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 5,
        "count": 676,
        "rate": 6.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 6,
        "count": 600,
        "rate": 5.9,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 7,
        "count": 617,
        "rate": 5.9,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 8,
        "count": 558,
        "rate": 5.3,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 9,
        "count": 596,
        "rate": 5.8,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 10,
        "count": 641,
        "rate": 6.1,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 11,
        "count": 645,
        "rate": 6.2,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2007,
        "month": 12,
        "count": 968,
        "rate": 9.4,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 1,
        "count": 1099,
        "rate": 11,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 2,
        "count": 1118,
        "rate": 11.4,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 3,
        "count": 1170,
        "rate": 12,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 4,
        "count": 1057,
        "rate": 11.1,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 5,
        "count": 809,
        "rate": 8.6,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 6,
        "count": 785,
        "rate": 8.2,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 7,
        "count": 783,
        "rate": 8,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 8,
        "count": 814,
        "rate": 8.2,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 9,
        "count": 970,
        "rate": 9.9,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 10,
        "count": 1078,
        "rate": 10.8,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 11,
        "count": 1237,
        "rate": 12.7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2008,
        "month": 12,
        "count": 1438,
        "rate": 15.3,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 1,
        "count": 1744,
        "rate": 18.2,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 2,
        "count": 2025,
        "rate": 21.4,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 3,
        "count": 1979,
        "rate": 21.1,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 4,
        "count": 1737,
        "rate": 18.7,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 5,
        "count": 1768,
        "rate": 19.2,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 6,
        "count": 1601,
        "rate": 17.4,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 7,
        "count": 1687,
        "rate": 18.2,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 8,
        "count": 1542,
        "rate": 16.5,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 9,
        "count": 1594,
        "rate": 17.1,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 10,
        "count": 1744,
        "rate": 18.7,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 11,
        "count": 1780,
        "rate": 19.4,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2009,
        "month": 12,
        "count": 2044,
        "rate": 22.7,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2010,
        "month": 1,
        "count": 2194,
        "rate": 24.7,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Construction",
        "year": 2010,
        "month": 2,
        "count": 2440,
        "rate": 27.1,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 1,
        "count": 734,
        "rate": 3.6,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 2,
        "count": 694,
        "rate": 3.4,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 3,
        "count": 739,
        "rate": 3.6,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 4,
        "count": 736,
        "rate": 3.7,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 5,
        "count": 685,
        "rate": 3.4,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 6,
        "count": 621,
        "rate": 3.1,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 7,
        "count": 708,
        "rate": 3.6,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 8,
        "count": 685,
        "rate": 3.4,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 9,
        "count": 667,
        "rate": 3.4,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 10,
        "count": 693,
        "rate": 3.6,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 11,
        "count": 672,
        "rate": 3.4,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2000,
        "month": 12,
        "count": 653,
        "rate": 3.3,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 1,
        "count": 911,
        "rate": 4.6,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 2,
        "count": 902,
        "rate": 4.6,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 3,
        "count": 954,
        "rate": 4.9,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 4,
        "count": 855,
        "rate": 4.4,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 5,
        "count": 903,
        "rate": 4.7,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 6,
        "count": 956,
        "rate": 5,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 7,
        "count": 1054,
        "rate": 5.6,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 8,
        "count": 1023,
        "rate": 5.5,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 9,
        "count": 996,
        "rate": 5.4,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 10,
        "count": 1065,
        "rate": 5.8,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 11,
        "count": 1108,
        "rate": 6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2001,
        "month": 12,
        "count": 1172,
        "rate": 6.3,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 1,
        "count": 1377,
        "rate": 7.4,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 2,
        "count": 1296,
        "rate": 7,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 3,
        "count": 1367,
        "rate": 7.3,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 4,
        "count": 1322,
        "rate": 7.2,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 5,
        "count": 1194,
        "rate": 6.6,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 6,
        "count": 1187,
        "rate": 6.6,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 7,
        "count": 1185,
        "rate": 6.6,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 8,
        "count": 1108,
        "rate": 6.2,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 9,
        "count": 1076,
        "rate": 6.1,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 10,
        "count": 1046,
        "rate": 5.9,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 11,
        "count": 1115,
        "rate": 6.3,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2002,
        "month": 12,
        "count": 1188,
        "rate": 6.6,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 1,
        "count": 1302,
        "rate": 7.2,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 2,
        "count": 1229,
        "rate": 6.7,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 3,
        "count": 1222,
        "rate": 6.8,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 4,
        "count": 1199,
        "rate": 6.7,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 5,
        "count": 1150,
        "rate": 6.5,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 6,
        "count": 1232,
        "rate": 7,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 7,
        "count": 1193,
        "rate": 6.9,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 8,
        "count": 1186,
        "rate": 6.7,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 9,
        "count": 1175,
        "rate": 6.8,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 10,
        "count": 1041,
        "rate": 6,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 11,
        "count": 1034,
        "rate": 5.9,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2003,
        "month": 12,
        "count": 1025,
        "rate": 5.9,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 1,
        "count": 1110,
        "rate": 6.4,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 2,
        "count": 1094,
        "rate": 6.3,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 3,
        "count": 1083,
        "rate": 6.3,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 4,
        "count": 1004,
        "rate": 5.8,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 5,
        "count": 966,
        "rate": 5.6,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 6,
        "count": 957,
        "rate": 5.6,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 7,
        "count": 1019,
        "rate": 6,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 8,
        "count": 840,
        "rate": 4.9,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 9,
        "count": 852,
        "rate": 5,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 10,
        "count": 884,
        "rate": 5.3,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 11,
        "count": 905,
        "rate": 5.4,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2004,
        "month": 12,
        "count": 872,
        "rate": 5.1,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 1,
        "count": 889,
        "rate": 5.3,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 2,
        "count": 889,
        "rate": 5.3,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 3,
        "count": 879,
        "rate": 5.3,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 4,
        "count": 793,
        "rate": 4.8,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 5,
        "count": 743,
        "rate": 4.5,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 6,
        "count": 743,
        "rate": 4.4,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 7,
        "count": 883,
        "rate": 5.3,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 8,
        "count": 767,
        "rate": 4.7,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 9,
        "count": 775,
        "rate": 4.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 10,
        "count": 800,
        "rate": 4.8,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 11,
        "count": 823,
        "rate": 4.9,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2005,
        "month": 12,
        "count": 757,
        "rate": 4.5,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 1,
        "count": 778,
        "rate": 4.6,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 2,
        "count": 821,
        "rate": 4.9,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 3,
        "count": 701,
        "rate": 4.1,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 4,
        "count": 745,
        "rate": 4.5,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 5,
        "count": 680,
        "rate": 4.1,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 6,
        "count": 635,
        "rate": 3.8,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 7,
        "count": 736,
        "rate": 4.4,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 8,
        "count": 680,
        "rate": 4.1,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 9,
        "count": 632,
        "rate": 3.8,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 10,
        "count": 618,
        "rate": 3.7,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 11,
        "count": 702,
        "rate": 4.3,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2006,
        "month": 12,
        "count": 660,
        "rate": 4,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 1,
        "count": 752,
        "rate": 4.6,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 2,
        "count": 774,
        "rate": 4.7,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 3,
        "count": 742,
        "rate": 4.5,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 4,
        "count": 749,
        "rate": 4.6,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 5,
        "count": 651,
        "rate": 3.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 6,
        "count": 653,
        "rate": 4,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 7,
        "count": 621,
        "rate": 3.7,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 8,
        "count": 596,
        "rate": 3.6,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 9,
        "count": 673,
        "rate": 4.1,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 10,
        "count": 729,
        "rate": 4.3,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 11,
        "count": 762,
        "rate": 4.5,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2007,
        "month": 12,
        "count": 772,
        "rate": 4.6,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 1,
        "count": 837,
        "rate": 5.1,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 2,
        "count": 820,
        "rate": 5,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 3,
        "count": 831,
        "rate": 5,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 4,
        "count": 796,
        "rate": 4.8,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 5,
        "count": 879,
        "rate": 5.3,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 6,
        "count": 862,
        "rate": 5.2,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 7,
        "count": 908,
        "rate": 5.5,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 8,
        "count": 960,
        "rate": 5.7,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 9,
        "count": 984,
        "rate": 6,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 10,
        "count": 1007,
        "rate": 6.2,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 11,
        "count": 1144,
        "rate": 7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2008,
        "month": 12,
        "count": 1315,
        "rate": 8.3,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 1,
        "count": 1711,
        "rate": 10.9,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 2,
        "count": 1822,
        "rate": 11.5,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 3,
        "count": 1912,
        "rate": 12.2,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 4,
        "count": 1968,
        "rate": 12.4,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 5,
        "count": 2010,
        "rate": 12.6,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 6,
        "count": 2010,
        "rate": 12.6,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 7,
        "count": 1988,
        "rate": 12.4,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 8,
        "count": 1866,
        "rate": 11.8,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 9,
        "count": 1876,
        "rate": 11.9,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 10,
        "count": 1884,
        "rate": 12.2,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 11,
        "count": 1882,
        "rate": 12.5,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2009,
        "month": 12,
        "count": 1747,
        "rate": 11.9,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2010,
        "month": 1,
        "count": 1918,
        "rate": 13,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Manufacturing",
        "year": 2010,
        "month": 2,
        "count": 1814,
        "rate": 12.1,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 1,
        "count": 1000,
        "rate": 5,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 2,
        "count": 1023,
        "rate": 5.2,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 3,
        "count": 983,
        "rate": 5.1,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 4,
        "count": 793,
        "rate": 4.1,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 5,
        "count": 821,
        "rate": 4.3,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 6,
        "count": 837,
        "rate": 4.4,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 7,
        "count": 792,
        "rate": 4.1,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 8,
        "count": 853,
        "rate": 4.3,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 9,
        "count": 791,
        "rate": 4.1,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 10,
        "count": 739,
        "rate": 3.7,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 11,
        "count": 701,
        "rate": 3.6,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2000,
        "month": 12,
        "count": 715,
        "rate": 3.7,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 1,
        "count": 908,
        "rate": 4.7,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 2,
        "count": 990,
        "rate": 5.2,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 3,
        "count": 1037,
        "rate": 5.4,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 4,
        "count": 820,
        "rate": 4.3,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 5,
        "count": 875,
        "rate": 4.5,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 6,
        "count": 955,
        "rate": 4.9,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 7,
        "count": 833,
        "rate": 4.3,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 8,
        "count": 928,
        "rate": 4.8,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 9,
        "count": 936,
        "rate": 4.8,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 10,
        "count": 941,
        "rate": 4.8,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 11,
        "count": 1046,
        "rate": 5.3,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2001,
        "month": 12,
        "count": 1074,
        "rate": 5.4,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 1,
        "count": 1212,
        "rate": 6.3,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 2,
        "count": 1264,
        "rate": 6.6,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 3,
        "count": 1269,
        "rate": 6.6,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 4,
        "count": 1222,
        "rate": 6.4,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 5,
        "count": 1138,
        "rate": 5.8,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 6,
        "count": 1240,
        "rate": 6.2,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 7,
        "count": 1132,
        "rate": 5.6,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 8,
        "count": 1170,
        "rate": 5.8,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 9,
        "count": 1171,
        "rate": 5.9,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 10,
        "count": 1212,
        "rate": 6.1,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 11,
        "count": 1242,
        "rate": 6.2,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2002,
        "month": 12,
        "count": 1150,
        "rate": 5.7,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 1,
        "count": 1342,
        "rate": 6.7,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 2,
        "count": 1238,
        "rate": 6.1,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 3,
        "count": 1179,
        "rate": 5.9,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 4,
        "count": 1201,
        "rate": 6,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 5,
        "count": 1247,
        "rate": 6.2,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 6,
        "count": 1434,
        "rate": 6.9,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 7,
        "count": 1387,
        "rate": 6.6,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 8,
        "count": 1161,
        "rate": 5.6,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 9,
        "count": 1229,
        "rate": 5.9,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 10,
        "count": 1189,
        "rate": 5.7,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 11,
        "count": 1156,
        "rate": 5.4,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2003,
        "month": 12,
        "count": 1081,
        "rate": 5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 1,
        "count": 1389,
        "rate": 6.5,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 2,
        "count": 1369,
        "rate": 6.5,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 3,
        "count": 1386,
        "rate": 6.8,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 4,
        "count": 1248,
        "rate": 6.1,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 5,
        "count": 1183,
        "rate": 5.8,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 6,
        "count": 1182,
        "rate": 5.8,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 7,
        "count": 1163,
        "rate": 5.5,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 8,
        "count": 1079,
        "rate": 5.1,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 9,
        "count": 1127,
        "rate": 5.5,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 10,
        "count": 1138,
        "rate": 5.4,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 11,
        "count": 1045,
        "rate": 5,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2004,
        "month": 12,
        "count": 1058,
        "rate": 5,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 1,
        "count": 1302,
        "rate": 6.3,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 2,
        "count": 1301,
        "rate": 6.2,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 3,
        "count": 1173,
        "rate": 5.6,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 4,
        "count": 1131,
        "rate": 5.4,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 5,
        "count": 1145,
        "rate": 5.4,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 6,
        "count": 1197,
        "rate": 5.7,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 7,
        "count": 1194,
        "rate": 5.6,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 8,
        "count": 1130,
        "rate": 5.3,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 9,
        "count": 1038,
        "rate": 4.9,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 10,
        "count": 1050,
        "rate": 4.9,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 11,
        "count": 1013,
        "rate": 4.7,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2005,
        "month": 12,
        "count": 968,
        "rate": 4.5,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 1,
        "count": 1203,
        "rate": 5.7,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 2,
        "count": 1141,
        "rate": 5.4,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 3,
        "count": 1022,
        "rate": 4.9,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 4,
        "count": 972,
        "rate": 4.6,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 5,
        "count": 1025,
        "rate": 4.8,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 6,
        "count": 1085,
        "rate": 5.1,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 7,
        "count": 1083,
        "rate": 5.1,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 8,
        "count": 977,
        "rate": 4.7,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 9,
        "count": 1008,
        "rate": 4.9,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 10,
        "count": 972,
        "rate": 4.7,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 11,
        "count": 1018,
        "rate": 4.8,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2006,
        "month": 12,
        "count": 965,
        "rate": 4.5,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 1,
        "count": 1166,
        "rate": 5.5,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 2,
        "count": 1045,
        "rate": 5.1,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 3,
        "count": 896,
        "rate": 4.4,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 4,
        "count": 872,
        "rate": 4.2,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 5,
        "count": 795,
        "rate": 3.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 6,
        "count": 979,
        "rate": 4.6,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 7,
        "count": 1089,
        "rate": 5.2,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 8,
        "count": 1028,
        "rate": 5.1,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 9,
        "count": 1027,
        "rate": 5.1,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 10,
        "count": 907,
        "rate": 4.4,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 11,
        "count": 893,
        "rate": 4.3,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2007,
        "month": 12,
        "count": 1009,
        "rate": 4.8,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 1,
        "count": 1120,
        "rate": 5.4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 2,
        "count": 1007,
        "rate": 4.9,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 3,
        "count": 992,
        "rate": 4.9,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 4,
        "count": 919,
        "rate": 4.5,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 5,
        "count": 1049,
        "rate": 5.2,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 6,
        "count": 1160,
        "rate": 5.7,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 7,
        "count": 1329,
        "rate": 6.5,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 8,
        "count": 1366,
        "rate": 6.6,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 9,
        "count": 1277,
        "rate": 6.2,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 10,
        "count": 1313,
        "rate": 6.3,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 11,
        "count": 1397,
        "rate": 6.7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2008,
        "month": 12,
        "count": 1535,
        "rate": 7.2,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 1,
        "count": 1794,
        "rate": 8.7,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 2,
        "count": 1847,
        "rate": 8.9,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 3,
        "count": 1852,
        "rate": 9,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 4,
        "count": 1833,
        "rate": 9,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 5,
        "count": 1835,
        "rate": 9,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 6,
        "count": 1863,
        "rate": 9.1,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 7,
        "count": 1854,
        "rate": 9,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 8,
        "count": 1794,
        "rate": 8.8,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 9,
        "count": 1809,
        "rate": 9,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 10,
        "count": 1919,
        "rate": 9.6,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 11,
        "count": 1879,
        "rate": 9.2,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2009,
        "month": 12,
        "count": 1851,
        "rate": 9.1,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2010,
        "month": 1,
        "count": 2154,
        "rate": 10.5,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Wholesale and Retail Trade",
        "year": 2010,
        "month": 2,
        "count": 2071,
        "rate": 10,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 1,
        "count": 236,
        "rate": 4.3,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 2,
        "count": 223,
        "rate": 4,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 3,
        "count": 192,
        "rate": 3.5,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 4,
        "count": 191,
        "rate": 3.4,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 5,
        "count": 190,
        "rate": 3.4,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 6,
        "count": 183,
        "rate": 3.2,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 7,
        "count": 228,
        "rate": 3.9,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 8,
        "count": 198,
        "rate": 3.4,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 9,
        "count": 231,
        "rate": 4,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 10,
        "count": 153,
        "rate": 2.8,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 11,
        "count": 129,
        "rate": 2.3,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2000,
        "month": 12,
        "count": 168,
        "rate": 3.1,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 1,
        "count": 194,
        "rate": 3.6,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 2,
        "count": 189,
        "rate": 3.4,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 3,
        "count": 193,
        "rate": 3.5,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 4,
        "count": 232,
        "rate": 4.2,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 5,
        "count": 178,
        "rate": 3.1,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 6,
        "count": 242,
        "rate": 4.3,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 7,
        "count": 236,
        "rate": 4.2,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 8,
        "count": 226,
        "rate": 3.9,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 9,
        "count": 214,
        "rate": 3.9,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 10,
        "count": 321,
        "rate": 5.8,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 11,
        "count": 302,
        "rate": 5.4,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2001,
        "month": 12,
        "count": 310,
        "rate": 5.6,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 1,
        "count": 368,
        "rate": 6.6,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 2,
        "count": 331,
        "rate": 5.7,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 3,
        "count": 313,
        "rate": 5.6,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 4,
        "count": 280,
        "rate": 5,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 5,
        "count": 257,
        "rate": 4.5,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 6,
        "count": 274,
        "rate": 4.9,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 7,
        "count": 270,
        "rate": 4.9,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 8,
        "count": 221,
        "rate": 3.9,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 9,
        "count": 235,
        "rate": 4.2,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 10,
        "count": 262,
        "rate": 4.7,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 11,
        "count": 233,
        "rate": 4.2,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2002,
        "month": 12,
        "count": 243,
        "rate": 4.6,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 1,
        "count": 331,
        "rate": 6.3,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 2,
        "count": 316,
        "rate": 5.8,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 3,
        "count": 319,
        "rate": 5.9,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 4,
        "count": 274,
        "rate": 5,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 5,
        "count": 260,
        "rate": 4.9,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 6,
        "count": 300,
        "rate": 5.5,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 7,
        "count": 289,
        "rate": 5.4,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 8,
        "count": 255,
        "rate": 4.8,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 9,
        "count": 255,
        "rate": 4.7,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 10,
        "count": 260,
        "rate": 4.8,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 11,
        "count": 275,
        "rate": 5.1,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2003,
        "month": 12,
        "count": 267,
        "rate": 5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 1,
        "count": 243,
        "rate": 4.6,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 2,
        "count": 291,
        "rate": 5.5,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 3,
        "count": 284,
        "rate": 5.4,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 4,
        "count": 239,
        "rate": 4.5,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 5,
        "count": 230,
        "rate": 4.4,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 6,
        "count": 227,
        "rate": 4.3,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 7,
        "count": 231,
        "rate": 4.3,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 8,
        "count": 236,
        "rate": 4.4,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 9,
        "count": 208,
        "rate": 3.9,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 10,
        "count": 219,
        "rate": 4,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 11,
        "count": 217,
        "rate": 4,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2004,
        "month": 12,
        "count": 204,
        "rate": 3.8,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 1,
        "count": 276,
        "rate": 5,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 2,
        "count": 245,
        "rate": 4.4,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 3,
        "count": 267,
        "rate": 4.8,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 4,
        "count": 257,
        "rate": 4.7,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 5,
        "count": 223,
        "rate": 4.1,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 6,
        "count": 247,
        "rate": 4.5,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 7,
        "count": 222,
        "rate": 3.9,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 8,
        "count": 187,
        "rate": 3.3,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 9,
        "count": 211,
        "rate": 3.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 10,
        "count": 251,
        "rate": 4.4,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 11,
        "count": 199,
        "rate": 3.5,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2005,
        "month": 12,
        "count": 202,
        "rate": 3.6,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 1,
        "count": 287,
        "rate": 5,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 2,
        "count": 260,
        "rate": 4.6,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 3,
        "count": 263,
        "rate": 4.7,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 4,
        "count": 272,
        "rate": 4.8,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 5,
        "count": 226,
        "rate": 4,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 6,
        "count": 225,
        "rate": 3.9,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 7,
        "count": 237,
        "rate": 4.2,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 8,
        "count": 217,
        "rate": 3.7,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 9,
        "count": 183,
        "rate": 3.1,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 10,
        "count": 206,
        "rate": 3.6,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 11,
        "count": 183,
        "rate": 3.1,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2006,
        "month": 12,
        "count": 190,
        "rate": 3.2,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 1,
        "count": 248,
        "rate": 4.2,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 2,
        "count": 251,
        "rate": 4.2,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 3,
        "count": 249,
        "rate": 4.3,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 4,
        "count": 188,
        "rate": 3.3,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 5,
        "count": 216,
        "rate": 3.8,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 6,
        "count": 242,
        "rate": 4.1,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 7,
        "count": 309,
        "rate": 5.1,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 8,
        "count": 205,
        "rate": 3.4,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 9,
        "count": 224,
        "rate": 3.7,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 10,
        "count": 218,
        "rate": 3.6,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 11,
        "count": 242,
        "rate": 3.9,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2007,
        "month": 12,
        "count": 210,
        "rate": 3.4,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 1,
        "count": 271,
        "rate": 4.4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 2,
        "count": 289,
        "rate": 4.6,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 3,
        "count": 267,
        "rate": 4.3,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 4,
        "count": 245,
        "rate": 4,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 5,
        "count": 269,
        "rate": 4.3,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 6,
        "count": 329,
        "rate": 5.1,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 7,
        "count": 359,
        "rate": 5.7,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 8,
        "count": 309,
        "rate": 5.2,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 9,
        "count": 337,
        "rate": 5.8,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 10,
        "count": 316,
        "rate": 5.7,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 11,
        "count": 331,
        "rate": 5.8,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2008,
        "month": 12,
        "count": 421,
        "rate": 6.7,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 1,
        "count": 522,
        "rate": 8.4,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 2,
        "count": 563,
        "rate": 9.1,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 3,
        "count": 558,
        "rate": 9,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 4,
        "count": 541,
        "rate": 9,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 5,
        "count": 506,
        "rate": 8.5,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 6,
        "count": 499,
        "rate": 8.4,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 7,
        "count": 511,
        "rate": 8.8,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 8,
        "count": 547,
        "rate": 9.8,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 9,
        "count": 538,
        "rate": 9.5,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 10,
        "count": 480,
        "rate": 8.6,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 11,
        "count": 493,
        "rate": 8.5,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2009,
        "month": 12,
        "count": 539,
        "rate": 9,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2010,
        "month": 1,
        "count": 657,
        "rate": 11.3,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Transportation and Utilities",
        "year": 2010,
        "month": 2,
        "count": 591,
        "rate": 10.5,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 1,
        "count": 125,
        "rate": 3.4,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 2,
        "count": 112,
        "rate": 2.9,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 3,
        "count": 140,
        "rate": 3.6,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 4,
        "count": 95,
        "rate": 2.4,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 5,
        "count": 131,
        "rate": 3.5,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 6,
        "count": 102,
        "rate": 2.6,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 7,
        "count": 144,
        "rate": 3.6,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 8,
        "count": 143,
        "rate": 3.7,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 9,
        "count": 130,
        "rate": 3.3,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 10,
        "count": 96,
        "rate": 2.4,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 11,
        "count": 117,
        "rate": 3,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2000,
        "month": 12,
        "count": 151,
        "rate": 4,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 1,
        "count": 161,
        "rate": 4.1,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 2,
        "count": 109,
        "rate": 2.9,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 3,
        "count": 148,
        "rate": 3.8,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 4,
        "count": 148,
        "rate": 3.7,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 5,
        "count": 164,
        "rate": 4.2,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 6,
        "count": 163,
        "rate": 4.1,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 7,
        "count": 206,
        "rate": 5.2,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 8,
        "count": 210,
        "rate": 5.4,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 9,
        "count": 219,
        "rate": 5.6,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 10,
        "count": 233,
        "rate": 6,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 11,
        "count": 241,
        "rate": 6.2,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2001,
        "month": 12,
        "count": 275,
        "rate": 7.4,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 1,
        "count": 263,
        "rate": 7.1,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 2,
        "count": 279,
        "rate": 7.6,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 3,
        "count": 266,
        "rate": 7.2,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 4,
        "count": 257,
        "rate": 6.9,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 5,
        "count": 260,
        "rate": 7.2,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 6,
        "count": 255,
        "rate": 6.9,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 7,
        "count": 264,
        "rate": 7.1,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 8,
        "count": 270,
        "rate": 7.1,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 9,
        "count": 231,
        "rate": 6.3,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 10,
        "count": 211,
        "rate": 6,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 11,
        "count": 220,
        "rate": 6.5,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2002,
        "month": 12,
        "count": 255,
        "rate": 7.2,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 1,
        "count": 243,
        "rate": 6.7,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 2,
        "count": 321,
        "rate": 8.6,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 3,
        "count": 267,
        "rate": 7.4,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 4,
        "count": 268,
        "rate": 7.3,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 5,
        "count": 251,
        "rate": 6.9,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 6,
        "count": 239,
        "rate": 6.4,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 7,
        "count": 224,
        "rate": 5.9,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 8,
        "count": 224,
        "rate": 6.1,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 9,
        "count": 248,
        "rate": 7,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 10,
        "count": 182,
        "rate": 5.4,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 11,
        "count": 257,
        "rate": 7.6,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2003,
        "month": 12,
        "count": 224,
        "rate": 6.5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 1,
        "count": 236,
        "rate": 7,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 2,
        "count": 194,
        "rate": 5.8,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 3,
        "count": 216,
        "rate": 6.3,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 4,
        "count": 168,
        "rate": 5,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 5,
        "count": 190,
        "rate": 5.7,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 6,
        "count": 172,
        "rate": 5,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 7,
        "count": 174,
        "rate": 5.2,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 8,
        "count": 191,
        "rate": 5.7,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 9,
        "count": 178,
        "rate": 5.4,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 10,
        "count": 185,
        "rate": 5.6,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 11,
        "count": 187,
        "rate": 5.6,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2004,
        "month": 12,
        "count": 173,
        "rate": 5.7,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 1,
        "count": 168,
        "rate": 5.4,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 2,
        "count": 204,
        "rate": 6.5,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 3,
        "count": 177,
        "rate": 6,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 4,
        "count": 178,
        "rate": 5.9,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 5,
        "count": 145,
        "rate": 4.7,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 6,
        "count": 160,
        "rate": 5,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 7,
        "count": 142,
        "rate": 4.2,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 8,
        "count": 156,
        "rate": 4.6,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 9,
        "count": 168,
        "rate": 4.9,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 10,
        "count": 162,
        "rate": 4.8,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 11,
        "count": 172,
        "rate": 5.1,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2005,
        "month": 12,
        "count": 128,
        "rate": 3.7,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 1,
        "count": 105,
        "rate": 3.3,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 2,
        "count": 119,
        "rate": 3.7,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 3,
        "count": 116,
        "rate": 3.5,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 4,
        "count": 132,
        "rate": 4.2,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 5,
        "count": 158,
        "rate": 4.8,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 6,
        "count": 114,
        "rate": 3.4,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 7,
        "count": 103,
        "rate": 3,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 8,
        "count": 132,
        "rate": 3.9,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 9,
        "count": 170,
        "rate": 4.9,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 10,
        "count": 116,
        "rate": 3.4,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 11,
        "count": 137,
        "rate": 3.9,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2006,
        "month": 12,
        "count": 108,
        "rate": 2.9,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 1,
        "count": 143,
        "rate": 4,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 2,
        "count": 139,
        "rate": 4,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 3,
        "count": 109,
        "rate": 3.2,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 4,
        "count": 77,
        "rate": 2.4,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 5,
        "count": 110,
        "rate": 3.3,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 6,
        "count": 114,
        "rate": 3.4,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 7,
        "count": 112,
        "rate": 3.4,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 8,
        "count": 140,
        "rate": 4.1,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 9,
        "count": 124,
        "rate": 3.7,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 10,
        "count": 120,
        "rate": 3.7,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 11,
        "count": 132,
        "rate": 4,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2007,
        "month": 12,
        "count": 125,
        "rate": 3.7,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 1,
        "count": 169,
        "rate": 5.1,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 2,
        "count": 193,
        "rate": 5.8,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 3,
        "count": 155,
        "rate": 4.8,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 4,
        "count": 143,
        "rate": 4.4,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 5,
        "count": 170,
        "rate": 5,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 6,
        "count": 157,
        "rate": 4.7,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 7,
        "count": 141,
        "rate": 4.1,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 8,
        "count": 144,
        "rate": 4.2,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 9,
        "count": 166,
        "rate": 5,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 10,
        "count": 168,
        "rate": 5,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 11,
        "count": 173,
        "rate": 5.2,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2008,
        "month": 12,
        "count": 219,
        "rate": 6.9,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 1,
        "count": 232,
        "rate": 7.4,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 2,
        "count": 224,
        "rate": 7.1,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 3,
        "count": 252,
        "rate": 7.8,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 4,
        "count": 320,
        "rate": 10.1,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 5,
        "count": 303,
        "rate": 9.5,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 6,
        "count": 347,
        "rate": 11.1,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 7,
        "count": 373,
        "rate": 11.5,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 8,
        "count": 358,
        "rate": 10.7,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 9,
        "count": 362,
        "rate": 11.2,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 10,
        "count": 261,
        "rate": 8.2,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 11,
        "count": 243,
        "rate": 7.6,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2009,
        "month": 12,
        "count": 256,
        "rate": 8.5,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2010,
        "month": 1,
        "count": 313,
        "rate": 10,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Information",
        "year": 2010,
        "month": 2,
        "count": 300,
        "rate": 10,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 1,
        "count": 228,
        "rate": 2.7,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 2,
        "count": 240,
        "rate": 2.8,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 3,
        "count": 226,
        "rate": 2.6,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 4,
        "count": 197,
        "rate": 2.3,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 5,
        "count": 195,
        "rate": 2.2,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 6,
        "count": 216,
        "rate": 2.5,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 7,
        "count": 190,
        "rate": 2.2,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 8,
        "count": 213,
        "rate": 2.5,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 9,
        "count": 187,
        "rate": 2.2,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 10,
        "count": 224,
        "rate": 2.6,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 11,
        "count": 184,
        "rate": 2.1,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2000,
        "month": 12,
        "count": 200,
        "rate": 2.3,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 1,
        "count": 232,
        "rate": 2.6,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 2,
        "count": 235,
        "rate": 2.6,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 3,
        "count": 211,
        "rate": 2.4,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 4,
        "count": 232,
        "rate": 2.6,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 5,
        "count": 191,
        "rate": 2.2,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 6,
        "count": 249,
        "rate": 2.8,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 7,
        "count": 289,
        "rate": 3.3,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 8,
        "count": 256,
        "rate": 2.9,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 9,
        "count": 268,
        "rate": 3.1,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 10,
        "count": 281,
        "rate": 3.3,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 11,
        "count": 320,
        "rate": 3.6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2001,
        "month": 12,
        "count": 258,
        "rate": 3,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 1,
        "count": 267,
        "rate": 3,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 2,
        "count": 318,
        "rate": 3.5,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 3,
        "count": 287,
        "rate": 3.2,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 4,
        "count": 292,
        "rate": 3.3,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 5,
        "count": 340,
        "rate": 3.8,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 6,
        "count": 373,
        "rate": 4.1,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 7,
        "count": 345,
        "rate": 3.8,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 8,
        "count": 343,
        "rate": 3.8,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 9,
        "count": 299,
        "rate": 3.3,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 10,
        "count": 312,
        "rate": 3.5,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 11,
        "count": 337,
        "rate": 3.7,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2002,
        "month": 12,
        "count": 322,
        "rate": 3.6,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 1,
        "count": 327,
        "rate": 3.6,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 2,
        "count": 310,
        "rate": 3.4,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 3,
        "count": 357,
        "rate": 4,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 4,
        "count": 323,
        "rate": 3.6,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 5,
        "count": 320,
        "rate": 3.6,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 6,
        "count": 358,
        "rate": 4,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 7,
        "count": 284,
        "rate": 3.1,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 8,
        "count": 342,
        "rate": 3.7,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 9,
        "count": 305,
        "rate": 3.3,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 10,
        "count": 303,
        "rate": 3.3,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 11,
        "count": 311,
        "rate": 3.3,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2003,
        "month": 12,
        "count": 283,
        "rate": 3,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 1,
        "count": 403,
        "rate": 4.3,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 2,
        "count": 363,
        "rate": 3.8,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 3,
        "count": 343,
        "rate": 3.7,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 4,
        "count": 312,
        "rate": 3.4,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 5,
        "count": 302,
        "rate": 3.3,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 6,
        "count": 335,
        "rate": 3.6,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 7,
        "count": 307,
        "rate": 3.3,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 8,
        "count": 312,
        "rate": 3.4,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 9,
        "count": 374,
        "rate": 4,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 10,
        "count": 358,
        "rate": 3.8,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 11,
        "count": 290,
        "rate": 3.1,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2004,
        "month": 12,
        "count": 290,
        "rate": 3.1,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 1,
        "count": 252,
        "rate": 2.7,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 2,
        "count": 301,
        "rate": 3.2,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 3,
        "count": 261,
        "rate": 2.7,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 4,
        "count": 255,
        "rate": 2.7,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 5,
        "count": 288,
        "rate": 3.1,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 6,
        "count": 307,
        "rate": 3.3,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 7,
        "count": 309,
        "rate": 3.3,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 8,
        "count": 300,
        "rate": 3.2,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 9,
        "count": 260,
        "rate": 2.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 10,
        "count": 255,
        "rate": 2.7,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 11,
        "count": 268,
        "rate": 2.8,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2005,
        "month": 12,
        "count": 204,
        "rate": 2.1,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 1,
        "count": 233,
        "rate": 2.4,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 2,
        "count": 268,
        "rate": 2.8,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 3,
        "count": 298,
        "rate": 3.1,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 4,
        "count": 293,
        "rate": 3.1,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 5,
        "count": 289,
        "rate": 3,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 6,
        "count": 299,
        "rate": 3.1,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 7,
        "count": 329,
        "rate": 3.4,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 8,
        "count": 263,
        "rate": 2.7,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 9,
        "count": 235,
        "rate": 2.4,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 10,
        "count": 211,
        "rate": 2.1,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 11,
        "count": 229,
        "rate": 2.3,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2006,
        "month": 12,
        "count": 227,
        "rate": 2.3,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 1,
        "count": 233,
        "rate": 2.4,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 2,
        "count": 295,
        "rate": 3.1,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 3,
        "count": 252,
        "rate": 2.6,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 4,
        "count": 231,
        "rate": 2.4,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 5,
        "count": 281,
        "rate": 2.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 6,
        "count": 303,
        "rate": 3.1,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 7,
        "count": 307,
        "rate": 3.1,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 8,
        "count": 371,
        "rate": 3.7,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 9,
        "count": 316,
        "rate": 3.3,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 10,
        "count": 307,
        "rate": 3.2,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 11,
        "count": 261,
        "rate": 2.7,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2007,
        "month": 12,
        "count": 315,
        "rate": 3.2,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 1,
        "count": 285,
        "rate": 3,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 2,
        "count": 323,
        "rate": 3.4,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 3,
        "count": 323,
        "rate": 3.4,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 4,
        "count": 324,
        "rate": 3.4,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 5,
        "count": 361,
        "rate": 3.7,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 6,
        "count": 337,
        "rate": 3.4,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 7,
        "count": 350,
        "rate": 3.6,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 8,
        "count": 409,
        "rate": 4.2,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 9,
        "count": 380,
        "rate": 4,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 10,
        "count": 434,
        "rate": 4.5,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 11,
        "count": 494,
        "rate": 5.2,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2008,
        "month": 12,
        "count": 540,
        "rate": 5.6,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 1,
        "count": 571,
        "rate": 6,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 2,
        "count": 637,
        "rate": 6.7,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 3,
        "count": 639,
        "rate": 6.8,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 4,
        "count": 561,
        "rate": 6,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 5,
        "count": 536,
        "rate": 5.7,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 6,
        "count": 513,
        "rate": 5.5,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 7,
        "count": 570,
        "rate": 6.1,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 8,
        "count": 566,
        "rate": 6,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 9,
        "count": 657,
        "rate": 7.1,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 10,
        "count": 646,
        "rate": 7,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 11,
        "count": 619,
        "rate": 6.7,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2009,
        "month": 12,
        "count": 665,
        "rate": 7.2,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2010,
        "month": 1,
        "count": 623,
        "rate": 6.6,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Finance",
        "year": 2010,
        "month": 2,
        "count": 708,
        "rate": 7.5,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 1,
        "count": 655,
        "rate": 5.7,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 2,
        "count": 587,
        "rate": 5.2,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 3,
        "count": 623,
        "rate": 5.4,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 4,
        "count": 517,
        "rate": 4.5,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 5,
        "count": 561,
        "rate": 4.7,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 6,
        "count": 545,
        "rate": 4.4,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 7,
        "count": 636,
        "rate": 5.1,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 8,
        "count": 584,
        "rate": 4.8,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 9,
        "count": 559,
        "rate": 4.6,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 10,
        "count": 504,
        "rate": 4.1,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 11,
        "count": 547,
        "rate": 4.4,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2000,
        "month": 12,
        "count": 564,
        "rate": 4.5,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 1,
        "count": 734,
        "rate": 5.8,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 2,
        "count": 724,
        "rate": 5.9,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 3,
        "count": 652,
        "rate": 5.3,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 4,
        "count": 655,
        "rate": 5.3,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 5,
        "count": 652,
        "rate": 5.3,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 6,
        "count": 694,
        "rate": 5.4,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 7,
        "count": 731,
        "rate": 5.7,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 8,
        "count": 790,
        "rate": 6.2,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 9,
        "count": 810,
        "rate": 6.4,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 10,
        "count": 910,
        "rate": 7.2,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 11,
        "count": 946,
        "rate": 7.6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2001,
        "month": 12,
        "count": 921,
        "rate": 7.4,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 1,
        "count": 1120,
        "rate": 8.9,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 2,
        "count": 973,
        "rate": 7.7,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 3,
        "count": 964,
        "rate": 7.5,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 4,
        "count": 951,
        "rate": 7.3,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 5,
        "count": 983,
        "rate": 7.7,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 6,
        "count": 1079,
        "rate": 8.2,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 7,
        "count": 1075,
        "rate": 8.2,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 8,
        "count": 926,
        "rate": 7.2,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 9,
        "count": 1007,
        "rate": 7.8,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 10,
        "count": 962,
        "rate": 7.5,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 11,
        "count": 1029,
        "rate": 8.2,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2002,
        "month": 12,
        "count": 1038,
        "rate": 8.3,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 1,
        "count": 1112,
        "rate": 8.9,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 2,
        "count": 1140,
        "rate": 8.9,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 3,
        "count": 1190,
        "rate": 9.1,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 4,
        "count": 1076,
        "rate": 8.3,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 5,
        "count": 1105,
        "rate": 8.4,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 6,
        "count": 1092,
        "rate": 8.5,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 7,
        "count": 1021,
        "rate": 8.2,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 8,
        "count": 881,
        "rate": 7.2,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 9,
        "count": 975,
        "rate": 8,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 10,
        "count": 1014,
        "rate": 8.1,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 11,
        "count": 948,
        "rate": 7.7,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2003,
        "month": 12,
        "count": 948,
        "rate": 7.6,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 1,
        "count": 1070,
        "rate": 8.7,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 2,
        "count": 964,
        "rate": 7.7,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 3,
        "count": 999,
        "rate": 7.9,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 4,
        "count": 752,
        "rate": 6,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 5,
        "count": 819,
        "rate": 6.5,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 6,
        "count": 814,
        "rate": 6.5,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 7,
        "count": 790,
        "rate": 6.2,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 8,
        "count": 845,
        "rate": 6.7,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 9,
        "count": 750,
        "rate": 5.9,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 10,
        "count": 781,
        "rate": 6.2,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 11,
        "count": 872,
        "rate": 6.8,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2004,
        "month": 12,
        "count": 875,
        "rate": 6.9,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 1,
        "count": 958,
        "rate": 7.6,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 2,
        "count": 916,
        "rate": 7.2,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 3,
        "count": 807,
        "rate": 6.5,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 4,
        "count": 714,
        "rate": 5.7,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 5,
        "count": 730,
        "rate": 5.9,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 6,
        "count": 743,
        "rate": 5.8,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 7,
        "count": 804,
        "rate": 6.3,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 8,
        "count": 728,
        "rate": 5.7,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 9,
        "count": 862,
        "rate": 6.7,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 10,
        "count": 748,
        "rate": 5.8,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 11,
        "count": 711,
        "rate": 5.5,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2005,
        "month": 12,
        "count": 788,
        "rate": 6.1,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 1,
        "count": 825,
        "rate": 6.5,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 2,
        "count": 841,
        "rate": 6.5,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 3,
        "count": 824,
        "rate": 6.3,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 4,
        "count": 644,
        "rate": 4.9,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 5,
        "count": 695,
        "rate": 5.3,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 6,
        "count": 753,
        "rate": 5.7,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 7,
        "count": 735,
        "rate": 5.5,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 8,
        "count": 681,
        "rate": 5.1,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 9,
        "count": 736,
        "rate": 5.6,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 10,
        "count": 768,
        "rate": 5.6,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 11,
        "count": 658,
        "rate": 4.9,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2006,
        "month": 12,
        "count": 791,
        "rate": 5.9,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 1,
        "count": 885,
        "rate": 6.5,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 2,
        "count": 825,
        "rate": 6,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 3,
        "count": 775,
        "rate": 5.7,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 4,
        "count": 689,
        "rate": 5,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 5,
        "count": 743,
        "rate": 5.4,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 6,
        "count": 722,
        "rate": 5.2,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 7,
        "count": 743,
        "rate": 5.2,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 8,
        "count": 683,
        "rate": 4.9,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 9,
        "count": 655,
        "rate": 4.7,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 10,
        "count": 675,
        "rate": 4.8,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 11,
        "count": 679,
        "rate": 4.8,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2007,
        "month": 12,
        "count": 803,
        "rate": 5.7,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 1,
        "count": 893,
        "rate": 6.4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 2,
        "count": 866,
        "rate": 6.2,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 3,
        "count": 876,
        "rate": 6.2,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 4,
        "count": 736,
        "rate": 5.3,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 5,
        "count": 829,
        "rate": 5.9,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 6,
        "count": 890,
        "rate": 6.2,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 7,
        "count": 866,
        "rate": 6.1,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 8,
        "count": 961,
        "rate": 6.9,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 9,
        "count": 951,
        "rate": 6.9,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 10,
        "count": 1052,
        "rate": 7.5,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 11,
        "count": 992,
        "rate": 7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2008,
        "month": 12,
        "count": 1147,
        "rate": 8.1,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 1,
        "count": 1445,
        "rate": 10.4,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 2,
        "count": 1512,
        "rate": 10.8,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 3,
        "count": 1597,
        "rate": 11.4,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 4,
        "count": 1448,
        "rate": 10.4,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 5,
        "count": 1514,
        "rate": 10.9,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 6,
        "count": 1580,
        "rate": 11.3,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 7,
        "count": 1531,
        "rate": 10.9,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 8,
        "count": 1560,
        "rate": 11,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 9,
        "count": 1596,
        "rate": 11.3,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 10,
        "count": 1488,
        "rate": 10.3,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 11,
        "count": 1514,
        "rate": 10.6,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2009,
        "month": 12,
        "count": 1486,
        "rate": 10.3,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2010,
        "month": 1,
        "count": 1614,
        "rate": 11.1,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Business services",
        "year": 2010,
        "month": 2,
        "count": 1740,
        "rate": 12,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 1,
        "count": 353,
        "rate": 2.3,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 2,
        "count": 349,
        "rate": 2.2,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 3,
        "count": 381,
        "rate": 2.5,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 4,
        "count": 329,
        "rate": 2.1,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 5,
        "count": 423,
        "rate": 2.7,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 6,
        "count": 452,
        "rate": 2.9,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 7,
        "count": 478,
        "rate": 3.1,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 8,
        "count": 450,
        "rate": 2.9,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 9,
        "count": 398,
        "rate": 2.6,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 10,
        "count": 339,
        "rate": 2.1,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 11,
        "count": 351,
        "rate": 2.2,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2000,
        "month": 12,
        "count": 293,
        "rate": 1.8,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 1,
        "count": 428,
        "rate": 2.6,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 2,
        "count": 423,
        "rate": 2.6,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 3,
        "count": 456,
        "rate": 2.8,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 4,
        "count": 341,
        "rate": 2.1,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 5,
        "count": 390,
        "rate": 2.4,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 6,
        "count": 476,
        "rate": 3,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 7,
        "count": 513,
        "rate": 3.1,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 8,
        "count": 595,
        "rate": 3.7,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 9,
        "count": 455,
        "rate": 2.8,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 10,
        "count": 486,
        "rate": 2.9,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 11,
        "count": 516,
        "rate": 3.1,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2001,
        "month": 12,
        "count": 483,
        "rate": 2.9,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 1,
        "count": 586,
        "rate": 3.5,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 2,
        "count": 590,
        "rate": 3.5,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 3,
        "count": 540,
        "rate": 3.2,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 4,
        "count": 493,
        "rate": 2.9,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 5,
        "count": 533,
        "rate": 3.2,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 6,
        "count": 638,
        "rate": 3.9,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 7,
        "count": 671,
        "rate": 4,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 8,
        "count": 660,
        "rate": 3.9,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 9,
        "count": 562,
        "rate": 3.2,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 10,
        "count": 517,
        "rate": 3,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 11,
        "count": 493,
        "rate": 2.8,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2002,
        "month": 12,
        "count": 558,
        "rate": 3.2,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 1,
        "count": 559,
        "rate": 3.2,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 2,
        "count": 576,
        "rate": 3.2,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 3,
        "count": 518,
        "rate": 2.9,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 4,
        "count": 611,
        "rate": 3.4,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 5,
        "count": 618,
        "rate": 3.5,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 6,
        "count": 769,
        "rate": 4.4,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 7,
        "count": 697,
        "rate": 4,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 8,
        "count": 760,
        "rate": 4.3,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 9,
        "count": 649,
        "rate": 3.7,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 10,
        "count": 639,
        "rate": 3.6,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 11,
        "count": 662,
        "rate": 3.8,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2003,
        "month": 12,
        "count": 620,
        "rate": 3.5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 1,
        "count": 662,
        "rate": 3.7,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 2,
        "count": 608,
        "rate": 3.4,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 3,
        "count": 584,
        "rate": 3.2,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 4,
        "count": 589,
        "rate": 3.3,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 5,
        "count": 570,
        "rate": 3.2,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 6,
        "count": 769,
        "rate": 4.2,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 7,
        "count": 725,
        "rate": 4,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 8,
        "count": 647,
        "rate": 3.7,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 9,
        "count": 593,
        "rate": 3.3,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 10,
        "count": 526,
        "rate": 2.9,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 11,
        "count": 570,
        "rate": 3.2,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2004,
        "month": 12,
        "count": 562,
        "rate": 3.1,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 1,
        "count": 613,
        "rate": 3.4,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 2,
        "count": 619,
        "rate": 3.4,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 3,
        "count": 614,
        "rate": 3.4,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 4,
        "count": 591,
        "rate": 3.3,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 5,
        "count": 648,
        "rate": 3.6,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 6,
        "count": 667,
        "rate": 3.6,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 7,
        "count": 635,
        "rate": 3.5,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 8,
        "count": 644,
        "rate": 3.5,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 9,
        "count": 658,
        "rate": 3.5,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 10,
        "count": 628,
        "rate": 3.4,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 11,
        "count": 677,
        "rate": 3.6,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2005,
        "month": 12,
        "count": 529,
        "rate": 2.8,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 1,
        "count": 593,
        "rate": 3.2,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 2,
        "count": 528,
        "rate": 2.8,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 3,
        "count": 563,
        "rate": 3,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 4,
        "count": 558,
        "rate": 3,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 5,
        "count": 543,
        "rate": 2.9,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 6,
        "count": 617,
        "rate": 3.3,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 7,
        "count": 659,
        "rate": 3.5,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 8,
        "count": 611,
        "rate": 3.2,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 9,
        "count": 576,
        "rate": 3,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 10,
        "count": 531,
        "rate": 2.8,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 11,
        "count": 536,
        "rate": 2.8,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2006,
        "month": 12,
        "count": 502,
        "rate": 2.6,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 1,
        "count": 563,
        "rate": 2.9,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 2,
        "count": 489,
        "rate": 2.5,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 3,
        "count": 495,
        "rate": 2.5,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 4,
        "count": 555,
        "rate": 2.9,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 5,
        "count": 622,
        "rate": 3.3,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 6,
        "count": 653,
        "rate": 3.4,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 7,
        "count": 665,
        "rate": 3.5,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 8,
        "count": 648,
        "rate": 3.4,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 9,
        "count": 630,
        "rate": 3.2,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 10,
        "count": 534,
        "rate": 2.7,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 11,
        "count": 526,
        "rate": 2.7,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2007,
        "month": 12,
        "count": 521,
        "rate": 2.6,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 1,
        "count": 576,
        "rate": 2.9,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 2,
        "count": 562,
        "rate": 2.9,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 3,
        "count": 609,
        "rate": 3.1,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 4,
        "count": 551,
        "rate": 2.8,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 5,
        "count": 619,
        "rate": 3.2,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 6,
        "count": 669,
        "rate": 3.4,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 7,
        "count": 776,
        "rate": 3.9,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 8,
        "count": 844,
        "rate": 4.3,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 9,
        "count": 835,
        "rate": 4.1,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 10,
        "count": 797,
        "rate": 3.9,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 11,
        "count": 748,
        "rate": 3.6,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2008,
        "month": 12,
        "count": 791,
        "rate": 3.8,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 1,
        "count": 792,
        "rate": 3.8,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 2,
        "count": 847,
        "rate": 4.1,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 3,
        "count": 931,
        "rate": 4.5,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 4,
        "count": 964,
        "rate": 4.6,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 5,
        "count": 1005,
        "rate": 4.9,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 6,
        "count": 1267,
        "rate": 6.1,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 7,
        "count": 1269,
        "rate": 6.1,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 8,
        "count": 1239,
        "rate": 6,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 9,
        "count": 1257,
        "rate": 6,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 10,
        "count": 1280,
        "rate": 6,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 11,
        "count": 1168,
        "rate": 5.5,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2009,
        "month": 12,
        "count": 1183,
        "rate": 5.6,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2010,
        "month": 1,
        "count": 1175,
        "rate": 5.5,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Education and Health",
        "year": 2010,
        "month": 2,
        "count": 1200,
        "rate": 5.6,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 1,
        "count": 782,
        "rate": 7.5,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 2,
        "count": 779,
        "rate": 7.5,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 3,
        "count": 789,
        "rate": 7.4,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 4,
        "count": 658,
        "rate": 6.1,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 5,
        "count": 675,
        "rate": 6.2,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 6,
        "count": 833,
        "rate": 7.3,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 7,
        "count": 786,
        "rate": 6.8,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 8,
        "count": 675,
        "rate": 6,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 9,
        "count": 636,
        "rate": 5.9,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 10,
        "count": 691,
        "rate": 6.5,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 11,
        "count": 694,
        "rate": 6.5,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2000,
        "month": 12,
        "count": 639,
        "rate": 5.9,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 1,
        "count": 806,
        "rate": 7.7,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 2,
        "count": 821,
        "rate": 7.5,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 3,
        "count": 817,
        "rate": 7.4,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 4,
        "count": 744,
        "rate": 6.8,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 5,
        "count": 731,
        "rate": 6.7,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 6,
        "count": 821,
        "rate": 7,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 7,
        "count": 813,
        "rate": 6.8,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 8,
        "count": 767,
        "rate": 6.8,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 9,
        "count": 900,
        "rate": 8,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 10,
        "count": 903,
        "rate": 8.3,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 11,
        "count": 935,
        "rate": 8.5,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2001,
        "month": 12,
        "count": 938,
        "rate": 8.5,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 1,
        "count": 947,
        "rate": 8.6,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 2,
        "count": 973,
        "rate": 8.7,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 3,
        "count": 976,
        "rate": 8.5,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 4,
        "count": 953,
        "rate": 8.4,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 5,
        "count": 1022,
        "rate": 8.6,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 6,
        "count": 1034,
        "rate": 8.5,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 7,
        "count": 999,
        "rate": 8.2,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 8,
        "count": 884,
        "rate": 7.5,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 9,
        "count": 885,
        "rate": 7.9,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 10,
        "count": 956,
        "rate": 8.5,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 11,
        "count": 978,
        "rate": 8.9,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2002,
        "month": 12,
        "count": 922,
        "rate": 8.2,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 1,
        "count": 1049,
        "rate": 9.3,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 2,
        "count": 1145,
        "rate": 10,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 3,
        "count": 1035,
        "rate": 8.9,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 4,
        "count": 986,
        "rate": 8.5,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 5,
        "count": 955,
        "rate": 7.9,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 6,
        "count": 1048,
        "rate": 8.6,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 7,
        "count": 1020,
        "rate": 8.4,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 8,
        "count": 1050,
        "rate": 9,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 9,
        "count": 978,
        "rate": 8.8,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 10,
        "count": 933,
        "rate": 8.3,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 11,
        "count": 990,
        "rate": 9,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2003,
        "month": 12,
        "count": 885,
        "rate": 8.2,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 1,
        "count": 1097,
        "rate": 10,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 2,
        "count": 987,
        "rate": 8.9,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 3,
        "count": 1039,
        "rate": 9,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 4,
        "count": 925,
        "rate": 7.9,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 5,
        "count": 977,
        "rate": 8.1,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 6,
        "count": 1189,
        "rate": 9.6,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 7,
        "count": 965,
        "rate": 7.8,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 8,
        "count": 1010,
        "rate": 8.4,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 9,
        "count": 854,
        "rate": 7.5,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 10,
        "count": 853,
        "rate": 7.3,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 11,
        "count": 916,
        "rate": 7.9,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2004,
        "month": 12,
        "count": 850,
        "rate": 7.4,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 1,
        "count": 993,
        "rate": 8.7,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 2,
        "count": 1008,
        "rate": 8.8,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 3,
        "count": 967,
        "rate": 8.3,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 4,
        "count": 882,
        "rate": 7.7,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 5,
        "count": 944,
        "rate": 7.7,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 6,
        "count": 950,
        "rate": 7.6,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 7,
        "count": 929,
        "rate": 7.4,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 8,
        "count": 844,
        "rate": 6.8,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 9,
        "count": 842,
        "rate": 7.3,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 10,
        "count": 796,
        "rate": 6.8,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 11,
        "count": 966,
        "rate": 8.1,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2005,
        "month": 12,
        "count": 930,
        "rate": 7.9,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 1,
        "count": 910,
        "rate": 8.1,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 2,
        "count": 1040,
        "rate": 9.1,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 3,
        "count": 917,
        "rate": 8,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 4,
        "count": 882,
        "rate": 7.6,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 5,
        "count": 830,
        "rate": 7,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 6,
        "count": 942,
        "rate": 7.4,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 7,
        "count": 867,
        "rate": 6.8,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 8,
        "count": 855,
        "rate": 6.9,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 9,
        "count": 810,
        "rate": 6.9,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 10,
        "count": 795,
        "rate": 6.6,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 11,
        "count": 836,
        "rate": 7.1,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2006,
        "month": 12,
        "count": 701,
        "rate": 5.9,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 1,
        "count": 911,
        "rate": 7.8,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 2,
        "count": 879,
        "rate": 7.4,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 3,
        "count": 845,
        "rate": 7,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 4,
        "count": 822,
        "rate": 6.9,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 5,
        "count": 831,
        "rate": 6.8,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 6,
        "count": 917,
        "rate": 7.2,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 7,
        "count": 920,
        "rate": 7.3,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 8,
        "count": 877,
        "rate": 7.1,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 9,
        "count": 892,
        "rate": 7.4,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 10,
        "count": 911,
        "rate": 7.5,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 11,
        "count": 986,
        "rate": 8.1,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2007,
        "month": 12,
        "count": 961,
        "rate": 7.9,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 1,
        "count": 1176,
        "rate": 9.4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 2,
        "count": 1056,
        "rate": 8.5,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 3,
        "count": 944,
        "rate": 7.6,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 4,
        "count": 874,
        "rate": 6.9,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 5,
        "count": 1074,
        "rate": 8.4,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 6,
        "count": 1154,
        "rate": 8.9,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 7,
        "count": 1172,
        "rate": 8.8,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 8,
        "count": 1122,
        "rate": 8.7,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 9,
        "count": 1029,
        "rate": 8.2,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 10,
        "count": 1126,
        "rate": 8.9,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 11,
        "count": 1283,
        "rate": 9.9,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2008,
        "month": 12,
        "count": 1210,
        "rate": 9.5,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 1,
        "count": 1487,
        "rate": 11.5,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 2,
        "count": 1477,
        "rate": 11.4,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 3,
        "count": 1484,
        "rate": 11.6,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 4,
        "count": 1322,
        "rate": 10.2,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 5,
        "count": 1599,
        "rate": 11.9,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 6,
        "count": 1688,
        "rate": 12.1,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 7,
        "count": 1600,
        "rate": 11.2,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 8,
        "count": 1636,
        "rate": 12,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 9,
        "count": 1469,
        "rate": 11.4,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 10,
        "count": 1604,
        "rate": 12.4,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 11,
        "count": 1524,
        "rate": 11.9,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2009,
        "month": 12,
        "count": 1624,
        "rate": 12.6,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2010,
        "month": 1,
        "count": 1804,
        "rate": 14.2,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Leisure and hospitality",
        "year": 2010,
        "month": 2,
        "count": 1597,
        "rate": 12.7,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 1,
        "count": 274,
        "rate": 4.9,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 2,
        "count": 232,
        "rate": 4.1,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 3,
        "count": 247,
        "rate": 4.3,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 4,
        "count": 240,
        "rate": 4.2,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 5,
        "count": 254,
        "rate": 4.5,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 6,
        "count": 225,
        "rate": 3.9,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 7,
        "count": 202,
        "rate": 3.7,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 8,
        "count": 187,
        "rate": 3.5,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 9,
        "count": 220,
        "rate": 4,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 10,
        "count": 161,
        "rate": 2.9,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 11,
        "count": 217,
        "rate": 3.8,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2000,
        "month": 12,
        "count": 167,
        "rate": 2.9,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 1,
        "count": 197,
        "rate": 3.4,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 2,
        "count": 243,
        "rate": 4.2,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 3,
        "count": 200,
        "rate": 3.4,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 4,
        "count": 220,
        "rate": 3.8,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 5,
        "count": 172,
        "rate": 3.2,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 6,
        "count": 246,
        "rate": 4.6,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 7,
        "count": 228,
        "rate": 4.1,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 8,
        "count": 241,
        "rate": 4.5,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 9,
        "count": 225,
        "rate": 4,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 10,
        "count": 239,
        "rate": 4.1,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 11,
        "count": 256,
        "rate": 4.2,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2001,
        "month": 12,
        "count": 277,
        "rate": 4.5,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 1,
        "count": 304,
        "rate": 5.1,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 2,
        "count": 339,
        "rate": 5.6,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 3,
        "count": 314,
        "rate": 5.5,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 4,
        "count": 268,
        "rate": 4.6,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 5,
        "count": 264,
        "rate": 4.6,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 6,
        "count": 335,
        "rate": 5.5,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 7,
        "count": 356,
        "rate": 5.8,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 8,
        "count": 353,
        "rate": 6,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 9,
        "count": 281,
        "rate": 4.8,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 10,
        "count": 272,
        "rate": 4.6,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 11,
        "count": 284,
        "rate": 4.9,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2002,
        "month": 12,
        "count": 241,
        "rate": 4.2,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 1,
        "count": 304,
        "rate": 5.3,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 2,
        "count": 331,
        "rate": 5.7,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 3,
        "count": 370,
        "rate": 6.1,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 4,
        "count": 331,
        "rate": 5.5,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 5,
        "count": 339,
        "rate": 5.7,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 6,
        "count": 359,
        "rate": 5.9,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 7,
        "count": 405,
        "rate": 6.6,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 8,
        "count": 373,
        "rate": 6.1,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 9,
        "count": 338,
        "rate": 5.5,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 10,
        "count": 378,
        "rate": 6.1,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 11,
        "count": 357,
        "rate": 5.8,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2003,
        "month": 12,
        "count": 278,
        "rate": 4.5,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 1,
        "count": 322,
        "rate": 5.3,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 2,
        "count": 366,
        "rate": 5.9,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 3,
        "count": 366,
        "rate": 5.9,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 4,
        "count": 347,
        "rate": 5.6,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 5,
        "count": 310,
        "rate": 5.1,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 6,
        "count": 326,
        "rate": 5.4,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 7,
        "count": 346,
        "rate": 5.6,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 8,
        "count": 341,
        "rate": 5.6,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 9,
        "count": 301,
        "rate": 4.9,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 10,
        "count": 300,
        "rate": 4.8,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 11,
        "count": 294,
        "rate": 4.8,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2004,
        "month": 12,
        "count": 276,
        "rate": 4.3,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 1,
        "count": 290,
        "rate": 4.7,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 2,
        "count": 325,
        "rate": 5.3,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 3,
        "count": 308,
        "rate": 5,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 4,
        "count": 306,
        "rate": 4.9,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 5,
        "count": 314,
        "rate": 5,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 6,
        "count": 291,
        "rate": 4.6,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 7,
        "count": 274,
        "rate": 4.2,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 8,
        "count": 306,
        "rate": 4.8,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 9,
        "count": 307,
        "rate": 4.9,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 10,
        "count": 319,
        "rate": 5,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 11,
        "count": 300,
        "rate": 4.9,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2005,
        "month": 12,
        "count": 269,
        "rate": 4.3,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 1,
        "count": 308,
        "rate": 4.9,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 2,
        "count": 281,
        "rate": 4.4,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 3,
        "count": 292,
        "rate": 4.6,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 4,
        "count": 266,
        "rate": 4.1,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 5,
        "count": 265,
        "rate": 4.2,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 6,
        "count": 265,
        "rate": 4.3,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 7,
        "count": 305,
        "rate": 4.7,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 8,
        "count": 341,
        "rate": 5.3,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 9,
        "count": 310,
        "rate": 5,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 10,
        "count": 268,
        "rate": 4.4,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 11,
        "count": 306,
        "rate": 5,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2006,
        "month": 12,
        "count": 306,
        "rate": 5.2,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 1,
        "count": 275,
        "rate": 4.7,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 2,
        "count": 257,
        "rate": 4.3,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 3,
        "count": 222,
        "rate": 3.7,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 4,
        "count": 224,
        "rate": 3.6,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 5,
        "count": 242,
        "rate": 3.9,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 6,
        "count": 256,
        "rate": 4,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 7,
        "count": 243,
        "rate": 3.8,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 8,
        "count": 239,
        "rate": 3.8,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 9,
        "count": 257,
        "rate": 4.2,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 10,
        "count": 182,
        "rate": 3,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 11,
        "count": 255,
        "rate": 4.1,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2007,
        "month": 12,
        "count": 235,
        "rate": 3.9,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 1,
        "count": 264,
        "rate": 4.4,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 2,
        "count": 313,
        "rate": 5.1,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 3,
        "count": 283,
        "rate": 4.6,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 4,
        "count": 251,
        "rate": 4,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 5,
        "count": 275,
        "rate": 4.4,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 6,
        "count": 322,
        "rate": 5,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 7,
        "count": 352,
        "rate": 5.2,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 8,
        "count": 412,
        "rate": 6.3,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 9,
        "count": 374,
        "rate": 5.8,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 10,
        "count": 334,
        "rate": 5.3,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 11,
        "count": 434,
        "rate": 7,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2008,
        "month": 12,
        "count": 367,
        "rate": 6.1,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 1,
        "count": 431,
        "rate": 7.1,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 2,
        "count": 453,
        "rate": 7.3,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 3,
        "count": 377,
        "rate": 6,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 4,
        "count": 403,
        "rate": 6.4,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 5,
        "count": 476,
        "rate": 7.5,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 6,
        "count": 557,
        "rate": 8.4,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 7,
        "count": 490,
        "rate": 7.4,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 8,
        "count": 528,
        "rate": 8.2,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 9,
        "count": 462,
        "rate": 7.1,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 10,
        "count": 541,
        "rate": 8.5,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 11,
        "count": 491,
        "rate": 8,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2009,
        "month": 12,
        "count": 513,
        "rate": 8.2,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2010,
        "month": 1,
        "count": 609,
        "rate": 10,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Other",
        "year": 2010,
        "month": 2,
        "count": 603,
        "rate": 9.9,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 1,
        "count": 154,
        "rate": 10.3,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 2,
        "count": 173,
        "rate": 11.5,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 3,
        "count": 152,
        "rate": 10.4,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 4,
        "count": 135,
        "rate": 8.9,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 5,
        "count": 73,
        "rate": 5.1,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 6,
        "count": 109,
        "rate": 6.7,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 7,
        "count": 77,
        "rate": 5,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 8,
        "count": 110,
        "rate": 7,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 9,
        "count": 124,
        "rate": 8.2,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 10,
        "count": 113,
        "rate": 8,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 11,
        "count": 192,
        "rate": 13.3,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2000,
        "month": 12,
        "count": 196,
        "rate": 13.9,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 1,
        "count": 188,
        "rate": 13.8,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 2,
        "count": 193,
        "rate": 15.1,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 3,
        "count": 267,
        "rate": 19.2,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 4,
        "count": 140,
        "rate": 10.4,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 5,
        "count": 109,
        "rate": 7.7,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 6,
        "count": 130,
        "rate": 9.7,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 7,
        "count": 113,
        "rate": 7.6,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 8,
        "count": 141,
        "rate": 9.3,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 9,
        "count": 101,
        "rate": 7.2,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 10,
        "count": 118,
        "rate": 8.7,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 11,
        "count": 145,
        "rate": 11.6,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2001,
        "month": 12,
        "count": 192,
        "rate": 15.1,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 1,
        "count": 195,
        "rate": 14.8,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 2,
        "count": 187,
        "rate": 14.8,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 3,
        "count": 269,
        "rate": 19.6,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 4,
        "count": 151,
        "rate": 10.8,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 5,
        "count": 89,
        "rate": 6.8,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 6,
        "count": 89,
        "rate": 6.3,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 7,
        "count": 114,
        "rate": 7.3,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 8,
        "count": 125,
        "rate": 9,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 9,
        "count": 92,
        "rate": 6.3,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 10,
        "count": 97,
        "rate": 6.6,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 11,
        "count": 137,
        "rate": 11.1,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2002,
        "month": 12,
        "count": 120,
        "rate": 9.8,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 1,
        "count": 159,
        "rate": 13.2,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 2,
        "count": 172,
        "rate": 14.7,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 3,
        "count": 161,
        "rate": 12.9,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 4,
        "count": 154,
        "rate": 12,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 5,
        "count": 133,
        "rate": 10.2,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 6,
        "count": 94,
        "rate": 6.9,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 7,
        "count": 113,
        "rate": 8.2,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 8,
        "count": 173,
        "rate": 10.7,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 9,
        "count": 98,
        "rate": 6.2,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 10,
        "count": 136,
        "rate": 8.5,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 11,
        "count": 148,
        "rate": 10.3,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2003,
        "month": 12,
        "count": 137,
        "rate": 10.9,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 1,
        "count": 184,
        "rate": 15.1,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 2,
        "count": 168,
        "rate": 14.2,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 3,
        "count": 153,
        "rate": 12.7,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 4,
        "count": 107,
        "rate": 8.3,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 5,
        "count": 99,
        "rate": 7.4,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 6,
        "count": 106,
        "rate": 7.6,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 7,
        "count": 140,
        "rate": 10,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 8,
        "count": 103,
        "rate": 7,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 9,
        "count": 88,
        "rate": 6.4,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 10,
        "count": 102,
        "rate": 7.7,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 11,
        "count": 131,
        "rate": 10.5,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2004,
        "month": 12,
        "count": 165,
        "rate": 14,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 1,
        "count": 153,
        "rate": 13.2,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 2,
        "count": 107,
        "rate": 9.9,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 3,
        "count": 139,
        "rate": 11.8,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 4,
        "count": 84,
        "rate": 6.9,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 5,
        "count": 66,
        "rate": 5.3,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 6,
        "count": 76,
        "rate": 5.2,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 7,
        "count": 69,
        "rate": 4.7,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 8,
        "count": 100,
        "rate": 7.1,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 9,
        "count": 127,
        "rate": 9.5,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 10,
        "count": 85,
        "rate": 6.7,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 11,
        "count": 118,
        "rate": 9.6,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2005,
        "month": 12,
        "count": 127,
        "rate": 11.1,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 1,
        "count": 140,
        "rate": 11.5,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 2,
        "count": 139,
        "rate": 11.8,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 3,
        "count": 117,
        "rate": 9.8,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 4,
        "count": 81,
        "rate": 6.2,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 5,
        "count": 79,
        "rate": 6,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 6,
        "count": 35,
        "rate": 2.4,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 7,
        "count": 55,
        "rate": 3.6,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 8,
        "count": 76,
        "rate": 5.3,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 9,
        "count": 78,
        "rate": 5.9,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 10,
        "count": 77,
        "rate": 5.8,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 11,
        "count": 125,
        "rate": 9.6,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2006,
        "month": 12,
        "count": 139,
        "rate": 10.4,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 1,
        "count": 128,
        "rate": 10,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 2,
        "count": 127,
        "rate": 9.6,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 3,
        "count": 123,
        "rate": 9.7,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 4,
        "count": 67,
        "rate": 5.7,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 5,
        "count": 64,
        "rate": 5.1,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 6,
        "count": 59,
        "rate": 4.5,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 7,
        "count": 40,
        "rate": 3.1,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 8,
        "count": 54,
        "rate": 4.7,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 9,
        "count": 53,
        "rate": 4.3,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 10,
        "count": 47,
        "rate": 4,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 11,
        "count": 80,
        "rate": 6.6,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2007,
        "month": 12,
        "count": 96,
        "rate": 7.5,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 1,
        "count": 113,
        "rate": 9.5,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 2,
        "count": 135,
        "rate": 10.9,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 3,
        "count": 175,
        "rate": 13.2,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 4,
        "count": 108,
        "rate": 8.6,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 5,
        "count": 94,
        "rate": 7.4,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 6,
        "count": 86,
        "rate": 6.1,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 7,
        "count": 125,
        "rate": 8.5,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 8,
        "count": 111,
        "rate": 7.6,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 9,
        "count": 84,
        "rate": 5.8,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 10,
        "count": 97,
        "rate": 7.1,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 11,
        "count": 119,
        "rate": 9.5,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2008,
        "month": 12,
        "count": 229,
        "rate": 17,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 1,
        "count": 245,
        "rate": 18.7,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 2,
        "count": 251,
        "rate": 18.8,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 3,
        "count": 241,
        "rate": 19,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 4,
        "count": 176,
        "rate": 13.5,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 5,
        "count": 136,
        "rate": 10,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 6,
        "count": 182,
        "rate": 12.3,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 7,
        "count": 180,
        "rate": 12.1,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 8,
        "count": 195,
        "rate": 13.1,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 9,
        "count": 150,
        "rate": 11.1,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 10,
        "count": 166,
        "rate": 11.8,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 11,
        "count": 180,
        "rate": 12.6,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2009,
        "month": 12,
        "count": 292,
        "rate": 19.7,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2010,
        "month": 1,
        "count": 318,
        "rate": 21.3,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Agriculture",
        "year": 2010,
        "month": 2,
        "count": 285,
        "rate": 18.8,
        "date": "2010-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 1,
        "count": 239,
        "rate": 2.3,
        "date": "2000-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 2,
        "count": 262,
        "rate": 2.5,
        "date": "2000-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 3,
        "count": 213,
        "rate": 2,
        "date": "2000-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 4,
        "count": 218,
        "rate": 2,
        "date": "2000-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 5,
        "count": 206,
        "rate": 1.9,
        "date": "2000-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 6,
        "count": 188,
        "rate": 1.8,
        "date": "2000-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 7,
        "count": 222,
        "rate": 2.1,
        "date": "2000-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 8,
        "count": 186,
        "rate": 1.7,
        "date": "2000-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 9,
        "count": 213,
        "rate": 2,
        "date": "2000-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 10,
        "count": 226,
        "rate": 2.2,
        "date": "2000-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 11,
        "count": 273,
        "rate": 2.7,
        "date": "2000-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2000,
        "month": 12,
        "count": 178,
        "rate": 1.8,
        "date": "2000-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 1,
        "count": 194,
        "rate": 1.9,
        "date": "2001-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 2,
        "count": 209,
        "rate": 2,
        "date": "2001-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 3,
        "count": 181,
        "rate": 1.7,
        "date": "2001-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 4,
        "count": 216,
        "rate": 2.1,
        "date": "2001-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 5,
        "count": 206,
        "rate": 2,
        "date": "2001-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 6,
        "count": 187,
        "rate": 1.7,
        "date": "2001-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 7,
        "count": 191,
        "rate": 1.8,
        "date": "2001-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 8,
        "count": 243,
        "rate": 2.3,
        "date": "2001-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 9,
        "count": 256,
        "rate": 2.4,
        "date": "2001-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 10,
        "count": 247,
        "rate": 2.3,
        "date": "2001-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 11,
        "count": 234,
        "rate": 2.3,
        "date": "2001-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2001,
        "month": 12,
        "count": 249,
        "rate": 2.5,
        "date": "2001-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 1,
        "count": 263,
        "rate": 2.7,
        "date": "2002-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 2,
        "count": 250,
        "rate": 2.6,
        "date": "2002-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 3,
        "count": 217,
        "rate": 2.2,
        "date": "2002-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 4,
        "count": 255,
        "rate": 2.5,
        "date": "2002-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 5,
        "count": 264,
        "rate": 2.6,
        "date": "2002-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 6,
        "count": 246,
        "rate": 2.4,
        "date": "2002-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 7,
        "count": 249,
        "rate": 2.4,
        "date": "2002-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 8,
        "count": 271,
        "rate": 2.6,
        "date": "2002-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 9,
        "count": 266,
        "rate": 2.5,
        "date": "2002-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 10,
        "count": 275,
        "rate": 2.6,
        "date": "2002-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 11,
        "count": 297,
        "rate": 2.8,
        "date": "2002-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2002,
        "month": 12,
        "count": 327,
        "rate": 3.1,
        "date": "2002-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 1,
        "count": 324,
        "rate": 3,
        "date": "2003-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 2,
        "count": 304,
        "rate": 3,
        "date": "2003-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 3,
        "count": 279,
        "rate": 2.7,
        "date": "2003-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 4,
        "count": 248,
        "rate": 2.4,
        "date": "2003-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 5,
        "count": 271,
        "rate": 2.6,
        "date": "2003-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 6,
        "count": 295,
        "rate": 2.7,
        "date": "2003-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 7,
        "count": 270,
        "rate": 2.5,
        "date": "2003-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 8,
        "count": 302,
        "rate": 2.7,
        "date": "2003-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 9,
        "count": 287,
        "rate": 2.6,
        "date": "2003-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 10,
        "count": 338,
        "rate": 3.1,
        "date": "2003-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 11,
        "count": 308,
        "rate": 2.8,
        "date": "2003-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2003,
        "month": 12,
        "count": 299,
        "rate": 2.8,
        "date": "2003-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 1,
        "count": 302,
        "rate": 2.8,
        "date": "2004-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 2,
        "count": 260,
        "rate": 2.5,
        "date": "2004-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 3,
        "count": 260,
        "rate": 2.5,
        "date": "2004-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 4,
        "count": 242,
        "rate": 2.3,
        "date": "2004-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 5,
        "count": 287,
        "rate": 2.7,
        "date": "2004-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 6,
        "count": 306,
        "rate": 2.8,
        "date": "2004-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 7,
        "count": 291,
        "rate": 2.6,
        "date": "2004-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 8,
        "count": 324,
        "rate": 2.9,
        "date": "2004-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 9,
        "count": 362,
        "rate": 3.3,
        "date": "2004-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 10,
        "count": 301,
        "rate": 2.7,
        "date": "2004-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 11,
        "count": 353,
        "rate": 3.2,
        "date": "2004-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2004,
        "month": 12,
        "count": 341,
        "rate": 3.2,
        "date": "2004-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 1,
        "count": 346,
        "rate": 3.2,
        "date": "2005-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 2,
        "count": 363,
        "rate": 3.4,
        "date": "2005-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 3,
        "count": 312,
        "rate": 2.9,
        "date": "2005-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 4,
        "count": 273,
        "rate": 2.4,
        "date": "2005-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 5,
        "count": 299,
        "rate": 2.7,
        "date": "2005-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 6,
        "count": 268,
        "rate": 2.4,
        "date": "2005-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 7,
        "count": 282,
        "rate": 2.5,
        "date": "2005-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 8,
        "count": 249,
        "rate": 2.3,
        "date": "2005-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 9,
        "count": 282,
        "rate": 2.6,
        "date": "2005-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 10,
        "count": 255,
        "rate": 2.3,
        "date": "2005-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 11,
        "count": 319,
        "rate": 3,
        "date": "2005-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2005,
        "month": 12,
        "count": 327,
        "rate": 3.1,
        "date": "2005-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 1,
        "count": 341,
        "rate": 3.2,
        "date": "2006-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 2,
        "count": 332,
        "rate": 3.1,
        "date": "2006-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 3,
        "count": 300,
        "rate": 2.8,
        "date": "2006-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 4,
        "count": 334,
        "rate": 3.1,
        "date": "2006-04-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 5,
        "count": 251,
        "rate": 2.3,
        "date": "2006-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 6,
        "count": 245,
        "rate": 2.2,
        "date": "2006-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 7,
        "count": 291,
        "rate": 2.6,
        "date": "2006-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 8,
        "count": 306,
        "rate": 2.7,
        "date": "2006-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 9,
        "count": 299,
        "rate": 2.7,
        "date": "2006-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 10,
        "count": 275,
        "rate": 2.5,
        "date": "2006-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 11,
        "count": 257,
        "rate": 2.3,
        "date": "2006-11-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2006,
        "month": 12,
        "count": 287,
        "rate": 2.6,
        "date": "2006-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 1,
        "count": 376,
        "rate": 3.5,
        "date": "2007-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 2,
        "count": 300,
        "rate": 2.8,
        "date": "2007-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 3,
        "count": 311,
        "rate": 2.8,
        "date": "2007-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 4,
        "count": 240,
        "rate": 2.2,
        "date": "2007-04-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 5,
        "count": 276,
        "rate": 2.5,
        "date": "2007-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 6,
        "count": 258,
        "rate": 2.3,
        "date": "2007-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 7,
        "count": 324,
        "rate": 2.9,
        "date": "2007-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 8,
        "count": 315,
        "rate": 2.9,
        "date": "2007-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 9,
        "count": 304,
        "rate": 2.8,
        "date": "2007-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 10,
        "count": 338,
        "rate": 3.1,
        "date": "2007-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 11,
        "count": 336,
        "rate": 3.2,
        "date": "2007-11-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2007,
        "month": 12,
        "count": 326,
        "rate": 3.2,
        "date": "2007-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 1,
        "count": 338,
        "rate": 3.3,
        "date": "2008-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 2,
        "count": 340,
        "rate": 3.2,
        "date": "2008-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 3,
        "count": 346,
        "rate": 3.3,
        "date": "2008-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 4,
        "count": 338,
        "rate": 3.2,
        "date": "2008-04-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 5,
        "count": 366,
        "rate": 3.4,
        "date": "2008-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 6,
        "count": 364,
        "rate": 3.3,
        "date": "2008-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 7,
        "count": 345,
        "rate": 3.1,
        "date": "2008-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 8,
        "count": 378,
        "rate": 3.5,
        "date": "2008-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 9,
        "count": 414,
        "rate": 3.9,
        "date": "2008-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 10,
        "count": 396,
        "rate": 3.9,
        "date": "2008-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 11,
        "count": 411,
        "rate": 4.1,
        "date": "2008-11-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2008,
        "month": 12,
        "count": 559,
        "rate": 5.5,
        "date": "2008-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 1,
        "count": 659,
        "rate": 6.5,
        "date": "2009-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 2,
        "count": 586,
        "rate": 5.7,
        "date": "2009-02-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 3,
        "count": 625,
        "rate": 5.9,
        "date": "2009-03-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 4,
        "count": 488,
        "rate": 4.6,
        "date": "2009-04-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 5,
        "count": 530,
        "rate": 5,
        "date": "2009-05-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 6,
        "count": 472,
        "rate": 4.4,
        "date": "2009-06-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 7,
        "count": 552,
        "rate": 5.2,
        "date": "2009-07-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 8,
        "count": 569,
        "rate": 5.3,
        "date": "2009-08-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 9,
        "count": 636,
        "rate": 5.9,
        "date": "2009-09-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 10,
        "count": 610,
        "rate": 5.9,
        "date": "2009-10-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 11,
        "count": 592,
        "rate": 5.7,
        "date": "2009-11-01T07:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2009,
        "month": 12,
        "count": 609,
        "rate": 5.9,
        "date": "2009-12-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2010,
        "month": 1,
        "count": 730,
        "rate": 7.2,
        "date": "2010-01-01T08:00:00.000Z"
    },
    {
        "series": "Self-employed",
        "year": 2010,
        "month": 2,
        "count": 680,
        "rate": 6.5,
        "date": "2010-02-01T08:00:00.000Z"
    }
]
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Optomancy Examples"><CODE-FRAGMENT data-type="application/json" id="optomancy-dataset">[
    {
        "id": 0,
        "x": 11.386799386127404,
        "y": 11.922852245304673,
        "z": 11.155659158067035,
        "xrot": 0.7457874368169899,
        "yrot": 0.26687429723682987,
        "zrot": 0.32798858420074795,
        "randomOrdinal": 4
    },
    {
        "id": 1,
        "x": 11.56430681972551,
        "y": 11.140706511277173,
        "z": 10.84618001287916,
        "xrot": 0.23914966063330678,
        "yrot": 0.18348333769080272,
        "zrot": 0.2645814793572707,
        "randomOrdinal": 1
    },
    {
        "id": 2,
        "x": 11.066625410248305,
        "y": 11.558178155835515,
        "z": 9.276076179591186,
        "xrot": 0.29370588225724226,
        "yrot": 0.8284196674647706,
        "zrot": 0.837647233775467,
        "randomOrdinal": 2
    },
    {
        "id": 3,
        "x": 11.857386861005715,
        "y": 11.79293970230175,
        "z": 8.989922037770405,
        "xrot": 0.9664263431663116,
        "yrot": 0.7130705996096232,
        "zrot": 0.01564219870031036,
        "randomOrdinal": 4
    },
    {
        "id": 4,
        "x": 11.127769744674731,
        "y": 11.150461964251841,
        "z": 7.90688263536207,
        "xrot": 0.6274815118215336,
        "yrot": 0.320262801584813,
        "zrot": 0.47338420545897897,
        "randomOrdinal": 4
    },
    {
        "id": 5,
        "x": 11.141691950316662,
        "y": 11.707322116197494,
        "z": 6.004994936320047,
        "xrot": 0.7781342805387936,
        "yrot": 0.9802979512609986,
        "zrot": 0.9941739753215995,
        "randomOrdinal": 8
    },
    {
        "id": 6,
        "x": 11.611405335742157,
        "y": 11.4059865668583,
        "z": 5.794492505505467,
        "xrot": 0.1093641181696452,
        "yrot": 0.7516884882685799,
        "zrot": 0.8706721092854843,
        "randomOrdinal": 5
    },
    {
        "id": 7,
        "x": 11.973104432801948,
        "y": 11.295819545345863,
        "z": 4.461079331432486,
        "xrot": 0.7256078144763347,
        "yrot": 0.001919485493152795,
        "zrot": 0.39771209490673654,
        "randomOrdinal": 8
    },
    {
        "id": 8,
        "x": 11.577901146764377,
        "y": 11.510295246562187,
        "z": 3.532880139175606,
        "xrot": 0.9814379149900532,
        "yrot": 0.420838606037218,
        "zrot": 0.5345898980035437,
        "randomOrdinal": 4
    },
    {
        "id": 9,
        "x": 11.061953296422889,
        "y": 11.081796739658415,
        "z": 2.441175905398282,
        "xrot": 0.5467240735714478,
        "yrot": 0.7848576549057455,
        "zrot": 0.3990340406258801,
        "randomOrdinal": 1
    },
    {
        "id": 10,
        "x": 11.756583155681504,
        "y": 11.122609851142807,
        "z": 1.8999712731035734,
        "xrot": 0.5001230803603944,
        "yrot": 0.09321480323032061,
        "zrot": 0.12977489406394627,
        "randomOrdinal": 9
    },
    {
        "id": 11,
        "x": 11.668348966955872,
        "y": 11.743911848861321,
        "z": 0.7017708601463319,
        "xrot": 0.839919311377727,
        "yrot": 0.12496834777707311,
        "zrot": 0.3460322098924997,
        "randomOrdinal": 8
    },
    {
        "id": 12,
        "x": 11.570899732891316,
        "y": 11.132166791838706,
        "z": -0.10698862772562978,
        "xrot": 0.8111525824899313,
        "yrot": 0.5481799428494465,
        "zrot": 0.13513343102030895,
        "randomOrdinal": 2
    },
    {
        "id": 13,
        "x": 11.740928967314039,
        "y": 11.698946026074918,
        "z": -1.5827412132296503,
        "xrot": 0.3609957119133731,
        "yrot": 0.7991434308641876,
        "zrot": 0.1431132202811216,
        "randomOrdinal": 1
    },
    {
        "id": 14,
        "x": 11.386372495467961,
        "y": 11.415094632156036,
        "z": -2.5935673263719106,
        "xrot": 0.6535932594447258,
        "yrot": 0.4790141237805825,
        "zrot": 0.22447847040584912,
        "randomOrdinal": 5
    },
    {
        "id": 15,
        "x": 11.271890878573364,
        "y": 11.652487442699439,
        "z": -3.6484071348927136,
        "xrot": 0.7609705029865335,
        "yrot": 0.3653996909371444,
        "zrot": 0.1708361753253993,
        "randomOrdinal": 9
    },
    {
        "id": 16,
        "x": 11.283094587581669,
        "y": 11.588102247851987,
        "z": -4.066549040369933,
        "xrot": 0.32575001340430454,
        "yrot": 0.09768267188902957,
        "zrot": 0.42825307313656236,
        "randomOrdinal": 4
    },
    {
        "id": 17,
        "x": 11.19304134979012,
        "y": 11.036908784351775,
        "z": -5.6379462011566375,
        "xrot": 0.7968048593722419,
        "yrot": 0.6875331585007283,
        "zrot": 0.37682415338163766,
        "randomOrdinal": 0
    },
    {
        "id": 18,
        "x": 11.229677717225579,
        "y": 11.207195164374454,
        "z": -6.598272009319719,
        "xrot": 0.9247493352693656,
        "yrot": 0.050362649634152934,
        "zrot": 0.6447788799569378,
        "randomOrdinal": 2
    },
    {
        "id": 19,
        "x": 11.461987805379746,
        "y": 11.639970615225263,
        "z": -7.195717561777493,
        "xrot": 0.22097007493926335,
        "yrot": 0.09069274471372002,
        "zrot": 0.07594886275120949,
        "randomOrdinal": 1
    },
    {
        "id": 20,
        "x": 11.086120030248788,
        "y": 11.632455303392907,
        "z": -8.017754519083084,
        "xrot": 0.9931177667462918,
        "yrot": 0.4876288741902195,
        "zrot": 0.1498659424034201,
        "randomOrdinal": 0
    },
    {
        "id": 21,
        "x": 11.051567345342265,
        "y": 11.585242694904661,
        "z": -9.15718825946671,
        "xrot": 0.07492486445438895,
        "yrot": 0.5240069938771852,
        "zrot": 0.9279586637966051,
        "randomOrdinal": 5
    },
    {
        "id": 22,
        "x": 11.779246299328157,
        "y": 10.97793896974838,
        "z": 11.010485678696035,
        "xrot": 0.9240064716410179,
        "yrot": 0.27747555504234467,
        "zrot": 0.2246344769426083,
        "randomOrdinal": 9
    },
    {
        "id": 23,
        "x": 11.463976111719749,
        "y": 10.61778415709987,
        "z": 10.593474447286539,
        "xrot": 0.5553761161423767,
        "yrot": 0.6349987663845287,
        "zrot": 0.90392384481309,
        "randomOrdinal": 9
    },
    {
        "id": 24,
        "x": 11.033871782857455,
        "y": 10.901811492822668,
        "z": 9.512313655257968,
        "xrot": 0.6654932273778773,
        "yrot": 0.623748029973006,
        "zrot": 0.24987149705656164,
        "randomOrdinal": 4
    },
    {
        "id": 25,
        "x": 11.521709068432218,
        "y": 10.78415729580221,
        "z": 8.370217690227047,
        "xrot": 0.407743810722768,
        "yrot": 0.5533677018518821,
        "zrot": 0.8665187620139976,
        "randomOrdinal": 0
    },
    {
        "id": 26,
        "x": 11.7776941157588,
        "y": 10.972327136206648,
        "z": 7.986090155108968,
        "xrot": 0.2817639469788349,
        "yrot": 0.8565699379427796,
        "zrot": 0.034662557631981894,
        "randomOrdinal": 0
    },
    {
        "id": 27,
        "x": 11.76161346474226,
        "y": 10.01044664151062,
        "z": 6.870058193297112,
        "xrot": 0.4457647489928307,
        "yrot": 0.6769558906123061,
        "zrot": 0.7839985005068106,
        "randomOrdinal": 2
    },
    {
        "id": 28,
        "x": 11.983487136355711,
        "y": 10.890089290331625,
        "z": 5.803857902910023,
        "xrot": 0.40847066348369987,
        "yrot": 0.23826105597043057,
        "zrot": 0.8821291577700727,
        "randomOrdinal": 1
    },
    {
        "id": 29,
        "x": 11.4362915376939,
        "y": 10.953225580569297,
        "z": 4.131413546424076,
        "xrot": 0.7062479711276388,
        "yrot": 0.05045599933167533,
        "zrot": 0.5027568603745007,
        "randomOrdinal": 5
    },
    {
        "id": 30,
        "x": 11.055287838327523,
        "y": 10.475855705256649,
        "z": 3.1786380234661253,
        "xrot": 0.9136761117480461,
        "yrot": 0.8085584689984542,
        "zrot": 0.6417823449316402,
        "randomOrdinal": 9
    },
    {
        "id": 31,
        "x": 11.189640451706254,
        "y": 10.562816424919134,
        "z": 2.503178730739764,
        "xrot": 0.6953283114233952,
        "yrot": 0.49893788128092953,
        "zrot": 0.24736463413912424,
        "randomOrdinal": 7
    },
    {
        "id": 32,
        "x": 11.171448686742188,
        "y": 10.323530882011852,
        "z": 1.0155711745803773,
        "xrot": 0.11195377145437746,
        "yrot": 0.017944110445653916,
        "zrot": 0.877698179592949,
        "randomOrdinal": 8
    },
    {
        "id": 33,
        "x": 11.868596544269241,
        "y": 10.809506030775193,
        "z": 0.511216947678889,
        "xrot": 0.13065402795922854,
        "yrot": 0.6735904290647612,
        "zrot": 0.6720717107205314,
        "randomOrdinal": 4
    },
    {
        "id": 34,
        "x": 11.846316456966766,
        "y": 10.088165608584472,
        "z": -0.254309601674773,
        "xrot": 0.926034602058927,
        "yrot": 0.725589861259113,
        "zrot": 0.4157527977335418,
        "randomOrdinal": 5
    },
    {
        "id": 35,
        "x": 11.559292726940935,
        "y": 10.079112417826874,
        "z": -1.230038479696248,
        "xrot": 0.373644656959649,
        "yrot": 0.23931570722306805,
        "zrot": 0.8939970164650086,
        "randomOrdinal": 2
    },
    {
        "id": 36,
        "x": 11.225090733733444,
        "y": 10.774718856695792,
        "z": -2.1027910586500296,
        "xrot": 0.13120627515701533,
        "yrot": 0.710898508266316,
        "zrot": 0.02468777204599726,
        "randomOrdinal": 5
    },
    {
        "id": 37,
        "x": 11.675319818658123,
        "y": 10.478665385114045,
        "z": -3.2935484188156248,
        "xrot": 0.086097698822037,
        "yrot": 0.6615192943890522,
        "zrot": 0.11695702496866556,
        "randomOrdinal": 9
    },
    {
        "id": 38,
        "x": 11.195489378311926,
        "y": 10.96500279460959,
        "z": -4.229628562828045,
        "xrot": 0.7362687058075492,
        "yrot": 0.291555786462268,
        "zrot": 0.5792391759278157,
        "randomOrdinal": 6
    },
    {
        "id": 39,
        "x": 11.606909469089151,
        "y": 10.420268818475614,
        "z": -5.8569007122814005,
        "xrot": 0.4366282378075734,
        "yrot": 0.9232595745677445,
        "zrot": 0.6131062653888275,
        "randomOrdinal": 5
    },
    {
        "id": 40,
        "x": 11.13607039797638,
        "y": 10.59214129381113,
        "z": -6.779274397642073,
        "xrot": 0.33268809050189696,
        "yrot": 0.4682451609781857,
        "zrot": 0.6599710630365343,
        "randomOrdinal": 1
    },
    {
        "id": 41,
        "x": 11.245284742061761,
        "y": 10.449882190424574,
        "z": -7.592068535480244,
        "xrot": 0.744851428047355,
        "yrot": 0.7745900231152831,
        "zrot": 0.4149407236194451,
        "randomOrdinal": 0
    },
    {
        "id": 42,
        "x": 11.83663614919618,
        "y": 10.319775526579923,
        "z": -8.63190235486604,
        "xrot": 0.8883744387638657,
        "yrot": 0.7264533064728975,
        "zrot": 0.2061317480719851,
        "randomOrdinal": 9
    },
    {
        "id": 43,
        "x": 11.636537370017358,
        "y": 10.909715610240465,
        "z": -9.467597990128802,
        "xrot": 0.503396377183474,
        "yrot": 0.670576767644927,
        "zrot": 0.8347733015104446,
        "randomOrdinal": 0
    },
    {
        "id": 44,
        "x": 11.064244241137146,
        "y": 9.548169326370003,
        "z": 11.54757560046568,
        "xrot": 0.6903270113989237,
        "yrot": 0.38698701538150426,
        "zrot": 0.15932988905376444,
        "randomOrdinal": 6
    },
    {
        "id": 45,
        "x": 11.039491716158958,
        "y": 9.242368765373461,
        "z": 10.766163580215233,
        "xrot": 0.5375440659493833,
        "yrot": 0.2766205125654715,
        "zrot": 0.7907543603756724,
        "randomOrdinal": 8
    },
    {
        "id": 46,
        "x": 11.796200135758646,
        "y": 9.695679744889814,
        "z": 9.851220443907533,
        "xrot": 0.2869301003046414,
        "yrot": 0.46401690241386406,
        "zrot": 0.2424330719177894,
        "randomOrdinal": 8
    },
    {
        "id": 47,
        "x": 11.248900398952808,
        "y": 9.220735895522722,
        "z": 8.244801905760369,
        "xrot": 0.29524282260621404,
        "yrot": 0.5897710191882171,
        "zrot": 0.5191334902987383,
        "randomOrdinal": 8
    },
    {
        "id": 48,
        "x": 11.263600485957937,
        "y": 9.878833085847289,
        "z": 7.60751941428739,
        "xrot": 0.5001414993096815,
        "yrot": 0.703936062625951,
        "zrot": 0.5322853012469428,
        "randomOrdinal": 0
    },
    {
        "id": 49,
        "x": 11.171942310218196,
        "y": 9.108454488261364,
        "z": 6.296268282516182,
        "xrot": 0.495743892596997,
        "yrot": 0.18245066493570095,
        "zrot": 0.6010602458904504,
        "randomOrdinal": 9
    },
    {
        "id": 50,
        "x": 11.630284638656786,
        "y": 9.164682560102781,
        "z": 5.857688464638688,
        "xrot": 0.043431994810769536,
        "yrot": 0.30927605910253075,
        "zrot": 0.9842899738735278,
        "randomOrdinal": 0
    }
]
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="D3 Examples"><CODE-FRAGMENT data-type="application/json" id="simple-d3-dataset">[
    {
        "label": "A",
        "value": 12
    },
    {
        "label": "B",
        "value": 30
    },
    {
        "label": "C",
        "value": 15
    },
    {
        "label": "D",
        "value": 25
    },
    {
        "label": "E",
        "value": 30
    }
]
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Event Examples"><CODE-FRAGMENT data-type="application/json" id="events-dataset">[
    {
        "Event": "1",
        "Year": 2023,
        "Location": "Louisiana",
        "Dates": "Apr-22",
        "Attendance": 4001,
        "Operating Revenue": 1841438.97,
        "Operating Expenses": 2124497.92,
        "Operating Net": -283058.95,
        "Allocation/Overhead": 201827.3,
        "Conference Net": -484886.25
    },
    {
        "Event": "1",
        "Year": 2022,
        "Location": "Virtual",
        "Dates": "May 8-13, 2021",
        "Attendance": 5145,
        "Operating Revenue": 1540770.13,
        "Operating Expenses": 847257.21,
        "Operating Net": 693512.92,
        "Allocation/Overhead": 80489.43,
        "Conference Net": 613023.49
    },
    {
        "Event": "1",
        "Year": 2021,
        "Location": "Hawaii",
        "Dates": "25-Apr-20",
        "Attendance": "N/A",
        "Operating Revenue": 107555,
        "Operating Expenses": 495406,
        "Operating Net": -387851,
        "Allocation/Overhead": 47403,
        "Conference Net": -435254
    },
    {
        "Event": "1",
        "Year": 2020,
        "Location": "Scotland",
        "Dates": "4-May-19",
        "Attendance": 3759,
        "Operating Revenue": 2533364,
        "Operating Expenses": 2346562,
        "Operating Net": 186802,
        "Allocation/Overhead": 234656,
        "Conference Net": -47854
    },
    {
        "Event": "1",
        "Year": 2019,
        "Location": "Montreal",
        "Dates": "April 21 - 26, 2018",
        "Attendance": 3182,
        "Operating Revenue": 2429993,
        "Operating Expenses": 2044935,
        "Operating Net": 385058,
        "Allocation/Overhead": 194269,
        "Conference Net": 190789
    },
    {
        "Event": "1",
        "Year": 2018,
        "Location": "Denver, CO",
        "Dates": "May 6 - 11, 2017",
        "Attendance": 3050,
        "Operating Revenue": 2086623.21,
        "Operating Expenses": 1717609,
        "Operating Net": 369014.21,
        "Allocation/Overhead": 145997,
        "Conference Net": 223017.21
    },
    {
        "Event": "1",
        "Year": 2017,
        "Location": "San Jose, CA",
        "Dates": "May 7-12, 2016",
        "Attendance": 3168,
        "Operating Revenue": 2748170.3,
        "Operating Expenses": 2262899.82,
        "Operating Net": 485270.48,
        "Allocation/Overhead": 191635.99,
        "Conference Net": 293634.49
    },
    {
        "Event": "1",
        "Year": 2016,
        "Location": "Seoul, South Korea",
        "Dates": "Apr 18 - Apr 23, 2015",
        "Attendance": 2505,
        "Operating Revenue": 2214236.64,
        "Operating Expenses": 1887804.55,
        "Operating Net": 326432.09,
        "Allocation/Overhead": 160463.39,
        "Conference Net": 165968.7
    },
    {
        "Event": "1",
        "Year": 2015,
        "Location": "Toronto, Canada",
        "Dates": "Apr. 26 - May 1, 2014",
        "Attendance": 2997,
        "Operating Revenue": 2185271.09,
        "Operating Expenses": 1814885.94,
        "Operating Net": 370385.15,
        "Allocation/Overhead": 154265.3,
        "Conference Net": 216119.85
    },
    {
        "Event": "1",
        "Year": 2014,
        "Location": "Paris, France",
        "Dates": "Apr. 27 - May 2, 2013",
        "Attendance": 3062,
        "Operating Revenue": 2568971.98,
        "Operating Expenses": 2146807.51,
        "Operating Net": 422164.47,
        "Allocation/Overhead": 179663,
        "Conference Net": 242501.47
    },
    {
        "Event": "1",
        "Year": 2013,
        "Location": "Austin, TX",
        "Dates": "May 5-10, 2012",
        "Attendance": 2616,
        "Operating Revenue": 1836230.66,
        "Operating Expenses": 1375702.27,
        "Operating Net": 460528.39,
        "Allocation/Overhead": 115891.7,
        "Conference Net": 344636.69
    },
    {
        "Event": "1",
        "Year": 2012,
        "Location": "Vancouver, BC Canada",
        "Dates": "May 7-12, 2011",
        "Attendance": 2861,
        "Operating Revenue": 1919030.25,
        "Operating Expenses": 1611865.25,
        "Operating Net": 307165,
        "Allocation/Overhead": 137008.55,
        "Conference Net": 170156.45
    },
    {
        "Event": "1",
        "Year": 2011,
        "Location": "Atlanta",
        "Dates": "April 10-15, 2010",
        "Attendance": 2341,
        "Operating Revenue": 1548220,
        "Operating Expenses": 1280657.97,
        "Operating Net": 267562.03,
        "Allocation/Overhead": 102964,
        "Conference Net": 164598.03
    },
    {
        "Event": "1",
        "Year": 2010,
        "Location": "Boston",
        "Dates": "April 4-9, 2009",
        "Attendance": 2376,
        "Operating Revenue": 1577843,
        "Operating Expenses": 1115606.44,
        "Operating Net": 462236.56,
        "Allocation/Overhead": 94472.25,
        "Conference Net": 367764.31
    },
    {
        "Event": "1",
        "Year": 2009,
        "Location": "Italy",
        "Dates": "April 5-10, 2008",
        "Attendance": 2361,
        "Operating Revenue": 1922026.24,
        "Operating Expenses": 1803767.85,
        "Operating Net": 118258.39,
        "Allocation/Overhead": 148899.3,
        "Conference Net": -30640.91
    },
    {
        "Event": "1",
        "Year": 2008,
        "Location": "San Jose",
        "Dates": "April 30-May 3, 2007",
        "Attendance": 2172,
        "Operating Revenue": 2109930.07,
        "Operating Expenses": 1413761.4,
        "Operating Net": 696168.67,
        "Allocation/Overhead": 127209,
        "Conference Net": 568959.67
    },
    {
        "Event": "1",
        "Year": 2007,
        "Location": "Montreal",
        "Dates": "April 22-27, 2006",
        "Attendance": 2250,
        "Operating Revenue": 1828733,
        "Operating Expenses": 1467075,
        "Operating Net": 361658,
        "Allocation/Overhead": 167980,
        "Conference Net": 193678
    },
    {
        "Event": "1",
        "Year": 2006,
        "Location": "Portland",
        "Dates": "April 2-7, 2005",
        "Attendance": 1947,
        "Operating Revenue": 1404968,
        "Operating Expenses": 842919,
        "Operating Net": 562049,
        "Allocation/Overhead": 105189,
        "Conference Net": 456860
    },
    {
        "Event": "2",
        "Year": 2023,
        "Location": "Virtual",
        "Dates": "March 7-10, 2022",
        "Attendance": 410,
        "Operating Revenue": 60525.5,
        "Operating Expenses": 31487.5,
        "Operating Net": 29038,
        "Allocation/Overhead": 3148.8,
        "Conference Net": 25889.2
    },
    {
        "Event": "2",
        "Year": 2020,
        "Location": "Korea",
        "Dates": "March 11 -14, 2019",
        "Attendance": 423,
        "Operating Revenue": 131619,
        "Operating Expenses": 90445,
        "Operating Net": 41174,
        "Allocation/Overhead": 10049,
        "Conference Net": 31125
    },
    {
        "Event": "2",
        "Year": 2019,
        "Location": "Chicago",
        "Dates": "March 5-8, 2018",
        "Attendance": 648,
        "Operating Revenue": 176000,
        "Operating Expenses": 139642,
        "Operating Net": 36358,
        "Allocation/Overhead": 13964,
        "Conference Net": 22394
    },
    {
        "Event": "2",
        "Year": 2018,
        "Location": "Austria",
        "Dates": "March 6-9, 2017",
        "Attendance": 482,
        "Operating Revenue": 112136,
        "Operating Expenses": 100582,
        "Operating Net": 11554,
        "Allocation/Overhead": 10058,
        "Conference Net": 1496
    },
    {
        "Event": "2",
        "Year": 2017,
        "Location": "New Zealand",
        "Dates": "March 7-10, 2016",
        "Attendance": 357,
        "Operating Revenue": 58122,
        "Operating Expenses": 44834.39,
        "Operating Net": 13287.61,
        "Allocation/Overhead": 4483.39,
        "Conference Net": 8804.22
    },
    {
        "Event": "2",
        "Year": 2016,
        "Location": "Portland, OR",
        "Dates": "March 2-5, 2015",
        "Attendance": 364,
        "Operating Revenue": 92819.37,
        "Operating Expenses": 73968.06,
        "Operating Net": 18851.31,
        "Allocation/Overhead": 7395.87,
        "Conference Net": 11455.44
    },
    {
        "Event": "2",
        "Year": 2015,
        "Location": "Bielefeld, Germany",
        "Dates": "March 3-6, 2014",
        "Attendance": 250,
        "Operating Revenue": 90781.75,
        "Operating Expenses": 71403.73,
        "Operating Net": 19378.02,
        "Allocation/Overhead": 11424.6,
        "Conference Net": 7953.42
    },
    {
        "Event": "2",
        "Year": 2014,
        "Location": "Tokyo, Japan",
        "Dates": "March 3-6, 2013",
        "Attendance": 321,
        "Operating Revenue": 71606,
        "Operating Expenses": 47944.43,
        "Operating Net": 23661.57,
        "Allocation/Overhead": 4794.32,
        "Conference Net": 18867.25
    },
    {
        "Event": "2",
        "Year": 2013,
        "Location": "Boston, MA",
        "Dates": "March 5-8, 2012",
        "Attendance": 387,
        "Operating Revenue": 98041.98,
        "Operating Expenses": 86507.88,
        "Operating Net": 11534.1,
        "Allocation/Overhead": 13841.26,
        "Conference Net": -2307.16
    },
    {
        "Event": "2",
        "Year": 2012,
        "Location": "Lausanne, Switzerland",
        "Dates": "March 6-9, 2011",
        "Attendance": 290,
        "Operating Revenue": 76791,
        "Operating Expenses": 49032,
        "Operating Net": 27759,
        "Allocation/Overhead": 4903,
        "Conference Net": 22856
    },
    {
        "Event": "2",
        "Year": 2011,
        "Location": "Nara, Japan",
        "Dates": "March 2 -5, 2010",
        "Attendance": "N/A",
        "Operating Revenue": 71223,
        "Operating Expenses": 38820.3,
        "Operating Net": 32402.71,
        "Allocation/Overhead": 6211.25,
        "Conference Net": 26191.46
    },
    {
        "Event": "2",
        "Year": 2010,
        "Location": "California",
        "Dates": "March 9-13, 2009",
        "Attendance": 166,
        "Operating Revenue": 46217,
        "Operating Expenses": 31604,
        "Operating Net": 14613,
        "Allocation/Overhead": 2686,
        "Conference Net": 11927
    },
    {
        "Event": "2",
        "Year": 2009,
        "Location": "Amsterdam",
        "Dates": "March 12-15, 2008",
        "Attendance": 130,
        "Operating Revenue": 71580,
        "Operating Expenses": 61711,
        "Operating Net": 9869,
        "Allocation/Overhead": 0,
        "Conference Net": 9869
    },
    {
        "Event": "2",
        "Year": 2008,
        "Location": "Virginia",
        "Dates": "March 10-12, 2007",
        "Attendance": 150,
        "Operating Revenue": 50827.42,
        "Operating Expenses": 38701.27,
        "Operating Net": 12126.15,
        "Allocation/Overhead": 6746.3,
        "Conference Net": 5379.85
    },
    {
        "Event": "2",
        "Year": 2007,
        "Location": "Utah",
        "Dates": "March 2-3, 2006",
        "Attendance": 147,
        "Operating Revenue": 59584,
        "Operating Expenses": 27580,
        "Operating Net": 32004,
        "Allocation/Overhead": 4220,
        "Conference Net": 27784
    },
    {
        "Event": "3",
        "Year": 2023,
        "Location": "Italy",
        "Dates": "June 20-24, 2022",
        "Attendance": 201,
        "Operating Revenue": 110521.41,
        "Operating Expenses": 95269.37,
        "Operating Net": 15252.04,
        "Allocation/Overhead": 14063.88,
        "Conference Net": 1188.16
    },
    {
        "Event": "3",
        "Year": 2022,
        "Location": "Virtual",
        "Dates": "June 22-23, 2021",
        "Attendance": 100,
        "Operating Revenue": 10987,
        "Operating Expenses": 1560,
        "Operating Net": 9427,
        "Allocation/Overhead": 4840,
        "Conference Net": 4587
    },
    {
        "Event": "3",
        "Year": 2020,
        "Location": "California",
        "Dates": "June 23 - 27, 2019",
        "Attendance": 469,
        "Operating Revenue": 283440,
        "Operating Expenses": 253348.69,
        "Operating Net": 30091.31,
        "Allocation/Overhead": 23981.31,
        "Conference Net": 6110
    },
    {
        "Event": "3",
        "Year": 2018,
        "Location": "Singapore",
        "Dates": "June 27-30, 2017",
        "Attendance": 145,
        "Operating Revenue": 57812,
        "Operating Expenses": 56388.22,
        "Operating Net": 1423.78,
        "Allocation/Overhead": 5638.78,
        "Conference Net": -4215
    },
    {
        "Event": "3",
        "Year": 2016,
        "Location": "Glashow, United Kingdom",
        "Dates": "Jun 22-25, 2015",
        "Attendance": 113,
        "Operating Revenue": 53990.05,
        "Operating Expenses": 48412.21,
        "Operating Net": 5577.84,
        "Allocation/Overhead": 4701.2,
        "Conference Net": 876.64
    },
    {
        "Event": "3",
        "Year": 2014,
        "Location": "Australia",
        "Dates": "June 17-20, 2013",
        "Attendance": 106,
        "Operating Revenue": 39085,
        "Operating Expenses": 32331.92,
        "Operating Net": 6753.08,
        "Allocation/Overhead": 5173.11,
        "Conference Net": 1579.97
    },
    {
        "Event": "3",
        "Year": 2012,
        "Location": "Atlanta, GA",
        "Dates": "November 3-6, 2011",
        "Attendance": 177,
        "Operating Revenue": 81932,
        "Operating Expenses": 65985,
        "Operating Net": 15947,
        "Allocation/Overhead": 10553,
        "Conference Net": 5394
    },
    {
        "Event": "3",
        "Year": 2010,
        "Location": "California",
        "Dates": "October 26-30, 2009",
        "Attendance": "N/A",
        "Operating Revenue": 107816,
        "Operating Expenses": 87192,
        "Operating Net": 20624,
        "Allocation/Overhead": 13950,
        "Conference Net": 6674
    },
    {
        "Event": "3",
        "Year": 2008,
        "Location": "Washington, D.C.",
        "Dates": "June 13-15, 2007",
        "Attendance": 225,
        "Operating Revenue": 133695,
        "Operating Expenses": 99092.31,
        "Operating Net": 34602.69,
        "Allocation/Overhead": 16177.28,
        "Conference Net": 18425.41
    },
    {
        "Event": "3",
        "Year": 2006,
        "Location": "United Kingdom",
        "Dates": "April 12-15, 2005",
        "Attendance": 69,
        "Operating Revenue": 57895,
        "Operating Expenses": 50408,
        "Operating Net": 7487,
        "Allocation/Overhead": 9074,
        "Conference Net": -1587
    },
    {
        "Event": "4",
        "Year": 2023,
        "Location": "India",
        "Dates": "November 7-11, 2022",
        "Attendance": 175,
        "Operating Revenue": 86730,
        "Operating Expenses": 83953.01,
        "Operating Net": 2776.99,
        "Allocation/Overhead": 13432.48,
        "Conference Net": -10655.49
    },
    {
        "Event": "4",
        "Year": 2022,
        "Location": "Canada",
        "Dates": "October 18-22,2021",
        "Attendance": 317,
        "Operating Revenue": 79552.73,
        "Operating Expenses": 78289.35,
        "Operating Net": 1263.38,
        "Allocation/Overhead": 12859,
        "Conference Net": -11595.62
    },
    {
        "Event": "4",
        "Year": 2021,
        "Location": "Netherlands",
        "Dates": "October 25 - 29, 2020",
        "Attendance": 414,
        "Operating Revenue": 56882,
        "Operating Expenses": 12497,
        "Operating Net": 44385,
        "Allocation/Overhead": 12859,
        "Conference Net": 31526
    },
    {
        "Event": "4",
        "Year": 2020,
        "Location": "China",
        "Dates": "October 14 - 18, 2019",
        "Attendance": 169,
        "Operating Revenue": 107950,
        "Operating Expenses": 98399.12,
        "Operating Net": 9550.88,
        "Allocation/Overhead": 9839.88,
        "Conference Net": -289
    },
    {
        "Event": "4",
        "Year": 2019,
        "Location": "Colorado",
        "Dates": "October 16-20, 2018",
        "Attendance": 232,
        "Operating Revenue": 130255,
        "Operating Expenses": 107535.39,
        "Operating Net": 22719.61,
        "Allocation/Overhead": 10754,
        "Conference Net": 11965.61
    },
    {
        "Event": "4",
        "Year": 2018,
        "Location": "United Kingdom",
        "Dates": "November 13-17, 2017",
        "Attendance": 223,
        "Operating Revenue": 98652,
        "Operating Expenses": 67792,
        "Operating Net": 30860,
        "Allocation/Overhead": 6779,
        "Conference Net": 24081
    },
    {
        "Event": "4",
        "Year": 2017,
        "Location": "Tokyo, Japan",
        "Dates": "November 12-16, 2016",
        "Attendance": 242,
        "Operating Revenue": 123404.59,
        "Operating Expenses": 100942.39,
        "Operating Net": 22462.2,
        "Allocation/Overhead": 10094.24,
        "Conference Net": 12367.96
    },
    {
        "Event": "4",
        "Year": 2016,
        "Location": "Seattle, WA",
        "Dates": "November 9-13, 2015",
        "Attendance": 174,
        "Operating Revenue": 132646.5,
        "Operating Expenses": 117923.25,
        "Operating Net": 14723.25,
        "Allocation/Overhead": 11792.33,
        "Conference Net": 2930.92
    },
    {
        "Event": "4",
        "Year": 2015,
        "Location": "Istanbul, Turkey",
        "Dates": "November 12-16, 2014",
        "Attendance": 242,
        "Operating Revenue": 110031.42,
        "Operating Expenses": 89436.43,
        "Operating Net": 20594.99,
        "Allocation/Overhead": 14309.83,
        "Conference Net": 6285.16
    },
    {
        "Event": "4",
        "Year": 2014,
        "Location": "Australia",
        "Dates": "December 2-6, 2013",
        "Attendance": 171,
        "Operating Revenue": 101327.18,
        "Operating Expenses": 91578.69,
        "Operating Net": 9748.49,
        "Allocation/Overhead": 14652.59,
        "Conference Net": -4904.1
    },
    {
        "Event": "4",
        "Year": 2013,
        "Location": "Santa Monica, CA",
        "Dates": "October 23-26, 2012",
        "Attendance": 214,
        "Operating Revenue": 116271.5,
        "Operating Expenses": 75995.33,
        "Operating Net": 40276.17,
        "Allocation/Overhead": 12157,
        "Conference Net": 28119.17
    },
    {
        "Event": "4",
        "Year": 2012,
        "Location": "Alicante, Spain",
        "Dates": "November 7-11, 2011",
        "Attendance": "N/A",
        "Operating Revenue": 83453,
        "Operating Expenses": 71254.14,
        "Operating Net": 12198.86,
        "Allocation/Overhead": 11216.8,
        "Conference Net": 982.06
    },
    {
        "Event": "4",
        "Year": 2011,
        "Location": "Beijing, China",
        "Dates": "Nov. 8-12, 2010",
        "Attendance": 66,
        "Operating Revenue": 49580.11,
        "Operating Expenses": 23564.53,
        "Operating Net": 26015.58,
        "Allocation/Overhead": 3770.32,
        "Conference Net": 22245.26
    },
    {
        "Event": "4",
        "Year": 2010,
        "Location": "Massachusetts",
        "Dates": "November 2-4, 2009",
        "Attendance": "N/A",
        "Operating Revenue": 93265,
        "Operating Expenses": 75170,
        "Operating Net": 18095,
        "Allocation/Overhead": 12027,
        "Conference Net": 6068
    },
    {
        "Event": "4",
        "Year": 2009,
        "Location": "Japan",
        "Dates": "October 20-22, 2008",
        "Attendance": "N/A",
        "Operating Revenue": 66310,
        "Operating Expenses": 41868.94,
        "Operating Net": 24441.06,
        "Allocation/Overhead": 6697.6,
        "Conference Net": 17743.46
    },
    {
        "Event": "4",
        "Year": 2008,
        "Location": "Japan",
        "Dates": "September 25-28, 2007",
        "Attendance": 150,
        "Operating Revenue": 106219,
        "Operating Expenses": 82881.18,
        "Operating Net": 23337.82,
        "Allocation/Overhead": 14420,
        "Conference Net": 8917.82
    },
    {
        "Event": "4",
        "Year": 2007,
        "Location": "Alberta",
        "Dates": "November 1-3, 2006",
        "Attendance": 120,
        "Operating Revenue": 49250,
        "Operating Expenses": 34324,
        "Operating Net": 14926,
        "Allocation/Overhead": 4668,
        "Conference Net": 10258
    },
    {
        "Event": "4",
        "Year": 2006,
        "Location": "Italy",
        "Dates": "October 4-6, 2005",
        "Attendance": 102,
        "Operating Revenue": 80096,
        "Operating Expenses": 63038,
        "Operating Net": 17058,
        "Allocation/Overhead": 10717,
        "Conference Net": 6341
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="event-1-dataset">[
    {
        "Year": 2023,
        "Location": "Louisiana",
        "Dates": "Apr-22",
        "Attendance": 4001,
        "Operating Revenue": 1841438.97,
        "Operating Expenses": 2124497.92,
        "Operating Net": -283058.95,
        "Allocation/Overhead": 201827.3,
        "Conference Net": -484886.25
    },
    {
        "Year": 2022,
        "Location": "Virtual",
        "Dates": "May 8-13, 2021",
        "Attendance": 5145,
        "Operating Revenue": 1540770.13,
        "Operating Expenses": 847257.21,
        "Operating Net": 693512.92,
        "Allocation/Overhead": 80489.43,
        "Conference Net": 613023.49
    },
    {
        "Year": 2021,
        "Location": "Hawaii",
        "Dates": "25-Apr-20",
        "Attendance": "N/A",
        "Operating Revenue": 107555,
        "Operating Expenses": 495406,
        "Operating Net": -387851,
        "Allocation/Overhead": 47403,
        "Conference Net": -435254
    },
    {
        "Year": 2020,
        "Location": "Scotland",
        "Dates": "4-May-19",
        "Attendance": 3759,
        "Operating Revenue": 2533364,
        "Operating Expenses": 2346562,
        "Operating Net": 186802,
        "Allocation/Overhead": 234656,
        "Conference Net": -47854
    },
    {
        "Year": 2019,
        "Location": "Montreal",
        "Dates": "April 21 - 26, 2018",
        "Attendance": 3182,
        "Operating Revenue": 2429993,
        "Operating Expenses": 2044935,
        "Operating Net": 385058,
        "Allocation/Overhead": 194269,
        "Conference Net": 190789
    },
    {
        "Year": 2018,
        "Location": "Denver, CO",
        "Dates": "May 6 - 11, 2017",
        "Attendance": 3050,
        "Operating Revenue": 2086623.21,
        "Operating Expenses": 1717609,
        "Operating Net": 369014.21,
        "Allocation/Overhead": 145997,
        "Conference Net": 223017.21
    },
    {
        "Year": 2017,
        "Location": "San Jose, CA",
        "Dates": "May 7-12, 2016",
        "Attendance": 3168,
        "Operating Revenue": 2748170.3,
        "Operating Expenses": 2262899.82,
        "Operating Net": 485270.48,
        "Allocation/Overhead": 191635.99,
        "Conference Net": 293634.49
    },
    {
        "Year": 2016,
        "Location": "Seoul, South Korea",
        "Dates": "Apr 18 - Apr 23, 2015",
        "Attendance": 2505,
        "Operating Revenue": 2214236.64,
        "Operating Expenses": 1887804.55,
        "Operating Net": 326432.09,
        "Allocation/Overhead": 160463.39,
        "Conference Net": 165968.7
    },
    {
        "Year": 2015,
        "Location": "Toronto, Canada",
        "Dates": "Apr. 26 - May 1, 2014",
        "Attendance": 2997,
        "Operating Revenue": 2185271.09,
        "Operating Expenses": 1814885.94,
        "Operating Net": 370385.15,
        "Allocation/Overhead": 154265.3,
        "Conference Net": 216119.85
    },
    {
        "Year": 2014,
        "Location": "Paris, France",
        "Dates": "Apr. 27 - May 2, 2013",
        "Attendance": 3062,
        "Operating Revenue": 2568971.98,
        "Operating Expenses": 2146807.51,
        "Operating Net": 422164.47,
        "Allocation/Overhead": 179663,
        "Conference Net": 242501.47
    },
    {
        "Year": 2013,
        "Location": "Austin, TX",
        "Dates": "May 5-10, 2012",
        "Attendance": 2616,
        "Operating Revenue": 1836230.66,
        "Operating Expenses": 1375702.27,
        "Operating Net": 460528.39,
        "Allocation/Overhead": 115891.7,
        "Conference Net": 344636.69
    },
    {
        "Year": 2012,
        "Location": "Vancouver, BC Canada",
        "Dates": "May 7-12, 2011",
        "Attendance": 2861,
        "Operating Revenue": 1919030.25,
        "Operating Expenses": 1611865.25,
        "Operating Net": 307165,
        "Allocation/Overhead": 137008.55,
        "Conference Net": 170156.45
    },
    {
        "Year": 2011,
        "Location": "Atlanta",
        "Dates": "April 10-15, 2010",
        "Attendance": 2341,
        "Operating Revenue": 1548220,
        "Operating Expenses": 1280657.97,
        "Operating Net": 267562.03,
        "Allocation/Overhead": 102964,
        "Conference Net": 164598.03
    },
    {
        "Year": 2010,
        "Location": "Boston",
        "Dates": "April 4-9, 2009",
        "Attendance": 2376,
        "Operating Revenue": 1577843,
        "Operating Expenses": 1115606.44,
        "Operating Net": 462236.56,
        "Allocation/Overhead": 94472.25,
        "Conference Net": 367764.31
    },
    {
        "Year": 2009,
        "Location": "Italy",
        "Dates": "April 5-10, 2008",
        "Attendance": 2361,
        "Operating Revenue": 1922026.24,
        "Operating Expenses": 1803767.85,
        "Operating Net": 118258.39,
        "Allocation/Overhead": 148899.3,
        "Conference Net": -30640.91
    },
    {
        "Year": 2008,
        "Location": "San Jose",
        "Dates": "April 30-May 3, 2007",
        "Attendance": 2172,
        "Operating Revenue": 2109930.07,
        "Operating Expenses": 1413761.4,
        "Operating Net": 696168.67,
        "Allocation/Overhead": 127209,
        "Conference Net": 568959.67
    },
    {
        "Year": 2007,
        "Location": "Montreal",
        "Dates": "April 22-27, 2006",
        "Attendance": 2250,
        "Operating Revenue": 1828733,
        "Operating Expenses": 1467075,
        "Operating Net": 361658,
        "Allocation/Overhead": 167980,
        "Conference Net": 193678
    },
    {
        "Year": 2006,
        "Location": "Portland",
        "Dates": "April 2-7, 2005",
        "Attendance": 1947,
        "Operating Revenue": 1404968,
        "Operating Expenses": 842919,
        "Operating Net": 562049,
        "Allocation/Overhead": 105189,
        "Conference Net": 456860
    }
]
</CODE-FRAGMENT><CODE-FRAGMENT data-type="application/json" id="event-2-dataset">[
    {
        "Year": 2023,
        "Location": "India",
        "Dates": "November 7-11, 2022",
        "Attendance": 175,
        "Operating Revenue": 86730,
        "Operating Expenses": 83953.01,
        "Operating Net": 2776.99,
        "Allocation/Overhead": 13432.48,
        "Conference Net": -10655.49
    },
    {
        "Year": 2022,
        "Location": "Canada",
        "Dates": "October 18-22,2021",
        "Attendance": 317,
        "Operating Revenue": 79552.73,
        "Operating Expenses": 78289.35,
        "Operating Net": 1263.38,
        "Allocation/Overhead": 12859,
        "Conference Net": -11595.62
    },
    {
        "Year": 2021,
        "Location": "Netherlands",
        "Dates": "October 25 - 29, 2020",
        "Attendance": 414,
        "Operating Revenue": 56882,
        "Operating Expenses": 12497,
        "Operating Net": 44385,
        "Allocation/Overhead": 12859,
        "Conference Net": 31526
    },
    {
        "Year": 2020,
        "Location": "China",
        "Dates": "October 14 - 18, 2019",
        "Attendance": 169,
        "Operating Revenue": 107950,
        "Operating Expenses": 98399.12,
        "Operating Net": 9550.88,
        "Allocation/Overhead": 9839.88,
        "Conference Net": -289
    },
    {
        "Year": 2019,
        "Location": "Colorado",
        "Dates": "October 16-20, 2018",
        "Attendance": 232,
        "Operating Revenue": 130255,
        "Operating Expenses": 107535.39,
        "Operating Net": 22719.61,
        "Allocation/Overhead": 10754,
        "Conference Net": 11965.61
    },
    {
        "Year": 2018,
        "Location": "United Kingdom",
        "Dates": "November 13-17, 2017",
        "Attendance": 223,
        "Operating Revenue": 98652,
        "Operating Expenses": 67792,
        "Operating Net": 30860,
        "Allocation/Overhead": 6779,
        "Conference Net": 24081
    },
    {
        "Year": 2017,
        "Location": "Tokyo, Japan",
        "Dates": "November 12-16, 2016",
        "Attendance": 242,
        "Operating Revenue": 123404.59,
        "Operating Expenses": 100942.39,
        "Operating Net": 22462.2,
        "Allocation/Overhead": 10094.24,
        "Conference Net": 12367.96
    },
    {
        "Year": 2016,
        "Location": "Seattle, WA",
        "Dates": "November 9-13, 2015",
        "Attendance": 174,
        "Operating Revenue": 132646.5,
        "Operating Expenses": 117923.25,
        "Operating Net": 14723.25,
        "Allocation/Overhead": 11792.33,
        "Conference Net": 2930.92
    },
    {
        "Year": 2015,
        "Location": "Istanbul, Turkey",
        "Dates": "November 12-16, 2014",
        "Attendance": 242,
        "Operating Revenue": 110031.42,
        "Operating Expenses": 89436.43,
        "Operating Net": 20594.99,
        "Allocation/Overhead": 14309.83,
        "Conference Net": 6285.16
    },
    {
        "Year": 2014,
        "Location": "Australia",
        "Dates": "December 2-6, 2013",
        "Attendance": 171,
        "Operating Revenue": 101327.18,
        "Operating Expenses": 91578.69,
        "Operating Net": 9748.49,
        "Allocation/Overhead": 14652.59,
        "Conference Net": -4904.1
    },
    {
        "Year": 2013,
        "Location": "Santa Monica, CA",
        "Dates": "October 23-26, 2012",
        "Attendance": 214,
        "Operating Revenue": 116271.5,
        "Operating Expenses": 75995.33,
        "Operating Net": 40276.17,
        "Allocation/Overhead": 12157,
        "Conference Net": 28119.17
    },
    {
        "Year": 2012,
        "Location": "Alicante, Spain",
        "Dates": "November 7-11, 2011",
        "Attendance": "N/A",
        "Operating Revenue": 83453,
        "Operating Expenses": 71254.14,
        "Operating Net": 12198.86,
        "Allocation/Overhead": 11216.8,
        "Conference Net": 982.06
    },
    {
        "Year": 2011,
        "Location": "Beijing, China",
        "Dates": "Nov. 8-12, 2010",
        "Attendance": 66,
        "Operating Revenue": 49580.11,
        "Operating Expenses": 23564.53,
        "Operating Net": 26015.58,
        "Allocation/Overhead": 3770.32,
        "Conference Net": 22245.26
    },
    {
        "Year": 2010,
        "Location": "Massachusetts",
        "Dates": "November 2-4, 2009",
        "Attendance": "N/A",
        "Operating Revenue": 93265,
        "Operating Expenses": 75170,
        "Operating Net": 18095,
        "Allocation/Overhead": 12027,
        "Conference Net": 6068
    },
    {
        "Year": 2009,
        "Location": "Japan",
        "Dates": "October 20-22, 2008",
        "Attendance": "N/A",
        "Operating Revenue": 66310,
        "Operating Expenses": 41868.94,
        "Operating Net": 24441.06,
        "Allocation/Overhead": 6697.6,
        "Conference Net": 17743.46
    },
    {
        "Year": 2008,
        "Location": "Japan",
        "Dates": "September 25-28, 2007",
        "Attendance": 150,
        "Operating Revenue": 106219,
        "Operating Expenses": 82881.18,
        "Operating Net": 23337.82,
        "Allocation/Overhead": 14420,
        "Conference Net": 8917.82
    },
    {
        "Year": 2007,
        "Location": "Alberta",
        "Dates": "November 1-3, 2006",
        "Attendance": 120,
        "Operating Revenue": 49250,
        "Operating Expenses": 34324,
        "Operating Net": 14926,
        "Allocation/Overhead": 4668,
        "Conference Net": 10258
    },
    {
        "Year": 2006,
        "Location": "Italy",
        "Dates": "October 4-6, 2005",
        "Attendance": 102,
        "Operating Revenue": 80096,
        "Operating Expenses": 63038,
        "Operating Net": 17058,
        "Allocation/Overhead": 10717,
        "Conference Net": 6341
    }
]
</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER><CODE-FOLDER name="D3 Specs" id="d3-spec-container"><CODE-FOLDER name="Simple Example"><CODE-FRAGMENT data-type="text/javascript" id="simple-d3-spec" name>const renderVisualization = (d3, data, canvas) => {
    const context = canvas.getContext('2d');

    canvas.width = 200;
    canvas.height = 200;
    context.fillStyle = 'white';
    context.fillRect(0, 0, canvas.width, canvas.height);

    // Set up D3 scales
    const xScale = d3.scaleBand()
        .domain(data.map(d => d.label))
        .range([0, canvas.width])
        .padding(0.1);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.value)])
        .range([canvas.height, 0]);

    // Draw bars
    context.fillStyle = 'steelblue';
    data.forEach(d => {
        const x = xScale(d.label);
        const y = yScale(d.value);
        const barHeight = canvas.height - y;
        context.fillRect(x, y, xScale.bandwidth(), barHeight);
    });

    // Draw x-axis ticks and labels
    context.beginPath();
    xScale.domain().forEach(label => {
        const x = xScale(label) + xScale.bandwidth() / 2;
        context.moveTo(x, canvas.height);
        context.lineTo(x, canvas.height + 6);
        context.textAlign = 'center';
        context.fillText(label, x, canvas.height + 18);
    });
    context.strokeStyle = '#000';
    context.stroke();

    // Draw y-axis ticks and labels
    context.beginPath();
    yScale.ticks().forEach(tick => {
        const y = yScale(tick);
        context.moveTo(0, y);
        context.lineTo(-6, y);
        context.textAlign = 'right';
        context.fillText(tick, -9, y + 3);
    });
    context.strokeStyle = '#000';
    context.stroke();
};

exports.renderVisualization = renderVisualization;
</CODE-FRAGMENT></CODE-FOLDER><CODE-FOLDER name="Event Examples"><CODE-FRAGMENT data-type="text/javascript" id="event-d3-spec">const renderVisualization = (d3, data, canvas) => {
    const context = canvas.getContext('2d');

    canvas.width = 480;
    canvas.height = 320;
    context.fillStyle = 'white';
    context.fillRect(0, 0, canvas.width, canvas.height);

    var margin = { top: 20, right: 20, bottom: 30, left: 80 },
        width = canvas.width - margin.left - margin.right,
        height = canvas.height - margin.top - margin.bottom;

    var x = d3.scaleLinear().range([0, width]);

    var y = d3.scaleLinear().range([height, 0]);

    var line = d3
        .line()
        .x(function (d) {
            return x(d['Year']);
        })
        .y(function (d) {
            return y(d['Operating Revenue']);
        })
        .curve(d3.curveCatmullRom.alpha(0.5))
        .context(context);

    context.translate(margin.left, margin.top);

    data = data.map((el) => {
        return {
            Year: el['Year'],
            'Operating Revenue': el['Operating Revenue'],
        };
    });

    x.domain(
        d3.extent(data, function (d) {
            return d['Year'];
        })
    );
    y.domain(
        d3.extent(data, function (d) {
            return d['Operating Revenue'];
        })
    );

    xAxis();
    yAxis();

    context.beginPath();
    line(data);
    context.lineWidth = 1.5;
    context.strokeStyle = 'steelblue';
    context.stroke();

    function xAxis() {
        var tickCount = 10,
            tickSize = 6,
            ticks = x.ticks(tickCount),
            tickFormat = x.tickFormat(tickCount);

        context.beginPath();
        ticks.forEach(function (d) {
            context.moveTo(x(d), height);
            context.lineTo(x(d), height + tickSize);
        });
        context.strokeStyle = 'black';
        context.stroke();

        context.font = '10px sans-serif';
        context.fillStyle = 'black';
        context.textAlign = 'center';
        context.textBaseline = 'top';
        ticks.forEach(function (d) {
            context.fillText(tickFormat(d), x(d), height + tickSize);
        });
    }

    function yAxis() {
        var tickCount = 10,
            tickSize = 6,
            tickPadding = 3,
            ticks = y.ticks(tickCount),
            tickFormat = y.tickFormat(tickCount);

        context.beginPath();
        ticks.forEach(function (d) {
            context.moveTo(0, y(d));
            context.lineTo(-6, y(d));
        });
        context.strokeStyle = 'black';
        context.stroke();

        context.beginPath();
        context.moveTo(0, -tickSize);
        context.lineTo(0, height - 0.5);
        context.lineTo(width, height - 0.5);
        context.lineTo(-tickSize, height);
        context.strokeStyle = 'black';
        context.stroke();

        context.textAlign = 'right';
        context.textBaseline = 'middle';
        ticks.forEach(function (d) {
            context.fillText(tickFormat(d), -tickSize - tickPadding, y(d));
        });

        context.save();
        context.rotate(-Math.PI / 2);
        context.textAlign = 'right';
        context.textBaseline = 'top';
        context.font = 'bold 10px sans-serif';
        context.fillText('Operating Revenue (USD)', -70, -70);
        context.restore();
    }
};

exports.renderVisualization = renderVisualization;
</CODE-FRAGMENT></CODE-FOLDER></CODE-FOLDER></CODE-FOLDER></body></html>
